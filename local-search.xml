<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥</title>
    <link href="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/"/>
    <url>/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥"><a href="#æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥" class="headerlink" title="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥"></a>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥</h1><blockquote><p>å£°æ˜ï¼šæœ¬æ–‡ä¸ºå­¦ä¹ è®¡ç®—æœºç³»ç»Ÿçš„ç¬”è®°ï¼Œä¾›è‡ªå·±å¤ä¹ ä½¿ç”¨ï¼›æŒ‰ç…§<strong>yaaangmin</strong>çš„githubå£°æ˜ï¼Œè¯·å‹¿è¿›è¡Œå•†ç”¨</p><p>æ‰€æœ‰å†…å®¹å‡æ•´ç†è‡ªï¼š<strong>yaaangmin</strong></p><p>å…¶githubåœ°å€ä¸ºï¼š<a href="https://github.com/yangminz/bcst_csapp">https://github.com/yangminz/bcst_csapp</a></p></blockquote><h2 id="1-å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼"><a href="#1-å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼" class="headerlink" title="1.å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼"></a>1.å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬è€ƒè™‘ä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿï¼ˆFile System)ä¸Šçš„æ–‡ä»¶ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ–‡ä»¶éƒ½æ˜¯æŒä¹…åœ°å‚¨å­˜åœ¨ç£ç›˜ç­‰è®¾å¤‡ä¸Šçš„ï¼Œä½†å®ƒçš„å®è´¨ä»ç„¶æ˜¯äºŒè¿›åˆ¶åºåˆ—ã€‚åªè¦æˆ‘ä»¬å¯¹åºåˆ—è¿›è¡Œæ°å½“çš„æè¿°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—æƒ³è¦çš„å…¨éƒ¨ä¿¡æ¯ã€‚ä¸ºäº†å°†æŸä¸€æ–‡ä»¶çš„äºŒè¿›åˆ¶ä¸²ä¸å…¶ä»–æ–‡ä»¶çš„äºŒè¿›åˆ¶ä¸²åŒºåˆ«å¼€ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šè¿™ä¸€æ–‡ä»¶çš„ç±»å‹ä¸å¤§å°ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨æ–‡ä»¶äºŒè¿›åˆ¶ä¸²çš„èµ·å§‹åœ°å€ï¼Œä¹Ÿå³é¦–éƒ¨ï¼ˆHeader)ã€‚</p><h3 id="1-1-ELF-Header"><a href="#1-1-ELF-Header" class="headerlink" title="1.1 ELF Header"></a>1.1 ELF Header</h3><p>å¯¹äºELFï¼Œé¦–éƒ¨çš„ä¿¡æ¯åŒ…æ‹¬æ–‡ä»¶ç±»å‹ã€æœºå™¨ç±»å‹ç­‰ä¿¡æ¯ã€‚åœ¨Linuxè¯»å–ELFæ–‡ä»¶æ—¶ï¼ŒLinuxå°†ELF Headerä»Byteç¿»è¯‘ä¸ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405210514169.png" alt="image-20230405210514169" style="zoom:80%;"><p>æ•°æ®ç»“æ„<strong>Elf64_Ehdr</strong>åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼Œä½†å¯¹æˆ‘ä»¬è€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“Header æ˜¯å¦‚ä½•å®šä½åˆ°èŠ‚å¤´è¡¨( Section Header Table,SHT)çš„ã€‚Headerä¸­çš„ Elf64_Ehdr.e_shoff æ˜¯SHTå¯¹ELFèµ·å§‹åœ°å€çš„Byteåç½®ï¼ŒElf64_Ehdr.e_shentsizeæè¿°SHTæ¯ä¸€é¡¹çš„Byteå¤§å°ï¼ŒElf64_Ehdr.e_shentnum æè¿° SHTæè¿°è¡¨é¡¹çš„æ•°é‡ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åä¸¤é¡¹è®¡ç®—å‡ºSHTçš„å¤§å°ã€‚Headerä¸­çš„Elf64_Ehdr.e_shstrndxåˆ™æ˜¯SHTä¸­ä¸€ä¸ªç‰¹æ®ŠèŠ‚<strong>å­—ç¬¦ä¸²</strong>è¡¨çš„æ®µç´¢å¼•ï¼ŒHeaderå¯ä»¥å€Ÿæ­¤è®¡ç®—ELFä¸­æ¯ä¸€é¡¹çš„å­—ç¬¦ä¸²ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405210554302.png" alt="image-20230405210554302" style="zoom: 80%;"><p>æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä½¿æˆ‘ä»¬æ´è§ELFæ–‡ä»¶çš„æ•°æ®ç»“æ„ï¼Œè€ƒè™‘å¦‚ä¸‹çš„elf.cæºæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-type">long</span> data1 = <span class="hljs-number">0xdddddddd11111111</span>;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> data2 = <span class="hljs-number">0xdddddddd22222222</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> &#123;&#125;;<br><span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> &#123;&#125;;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨gccç¼–è¯‘å¾—åˆ°å®ƒçš„ELFæ–‡ä»¶ï¼š<code>gcc -c elf.c -o elf.o</code>ï¼Œå…¶ä¸­-cçš„å«ä¹‰æ˜¯ä»…ç¼–è¯‘æºæ–‡ä»¶ç”ŸæˆELFæ–‡ä»¶ï¼Œä½†ä¸å¯¹ELFæ–‡ä»¶è¿›è¡Œé“¾æ¥ã€‚ç”ŸæˆELFæ–‡ä»¶ä»¥åï¼Œåˆ©ç”¨hexdumpæŸ¥çœ‹ELFæ–‡ä»¶<code>elf.o</code>çš„å†…å®¹ã€‚</p><p>hexdumpè·å¾—elf.oçš„äºŒè¿›åˆ¶å†…å®¹åï¼ŒæŒ‰ç…§Elf64_Ehdrçš„ç»“æ„æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥è§£è¯»ELFçš„Headerã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—åˆ°sizeof(Elf64_Ehdr) &#x3D; 64Byteï¼Œå› æ­¤Headerå æ®ELFæ–‡ä»¶çš„ä½64Byteã€‚è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†elf.oçš„Headerï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405211548347.png" alt="image-20230405211548347" style="zoom:80%;"><p>èµ·å§‹ä½ç½®çš„16Bytesä¸º Magic Number,åœ¨è¿™ä¹‹ååç§»2+2+4+8+8&#x3D;24Bytes,å¤§å°ä¸º8Bytesçš„æ•°æ®ä¸ºElf64_Ehdr.e_shoffï¼Œä¹Ÿå³SHTèµ·å§‹åœ°å€å¯¹ELFæ–‡ä»¶çš„åç§»ï¼Œæ•°å€¼ä¸º 0x00000000000002b0ã€‚åœ¨è¿™ä¹‹åï¼Œå¯¹Elf64_Ehdr.e_shoffåç§»ä¸º4Bytes çš„ä½ç½®å‚¨å­˜äº†ELFæ–‡ä»¶Headerçš„å¤§å°ï¼šElf64_Ehdr.e_ehsize &#x3D;0x0040ã€‚å†ä¹‹å2+2&#x3D;4 Byteså³ Elf64_Ehdr.e_shentsizeï¼Œä¹Ÿå³ä¸ºSHTæ¯ä¸€é¡¹çš„å¤§å°ï¼Œæ•°å€¼ä¸º0x0040ã€‚æœ€åä¸¤ä¸ª2Bytesçš„æ•°åˆ†åˆ«æ˜¯ Elf64_Ehdr.e_shnum &#x3D; 0x000bä»¥åŠElf64_Ehdr.e_shstrndx &#x3D; 0x000aã€‚</p><h3 id="1-2-èŠ‚å¤´è¡¨SHT"><a href="#1-2-èŠ‚å¤´è¡¨SHT" class="headerlink" title="1.2 èŠ‚å¤´è¡¨SHT"></a>1.2 èŠ‚å¤´è¡¨SHT</h3><p>SHTæè¿°äº†ELFä¸­ä¸åŒçš„<strong>èŠ‚(Section)<strong>ï¼ŒåŒ…æ‹¬</strong>æ•°æ®èŠ‚(.data)<strong>ã€</strong>ä»£ç èŠ‚(.textï¼‰</strong>ç­‰ã€‚è¿™äº›Sectionä¸­çš„æ•°æ®æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ï¼ŒæŒ‰ç…§Section çš„ç»„ç»‡å†™å…¥åˆ°ç£ç›˜ä¸Šçš„ELFæ–‡ä»¶ä¸­ã€‚SHTçš„æ¯ä¸€é¡¹å¯ä»¥è¢«æ•°æ®ç»“æ„Elf64_Shdræ‰€æï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212130069.png" alt="image-20230405212130069" style="zoom: 80%;"><p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡SHTæ‰¾åˆ°ELFå†…çš„ä»»ä¸€Sectionï¼Œå¸¸è§çš„Sectionæœ‰.textï¼Œ.dataï¼Œ.rodataï¼Œ.bssï¼Œ.symtabï¼Œ.rel.txtï¼Œ.rel.dataï¼Œ.strtabï¼Œå®ƒä»¬å¯ä»¥è¢«Elf64_Shdr.sh_nameç¡®å®šï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212311898.png" alt="image-20230405212311898" style="zoom:80%;"><p>åœ¨elf.oçš„Headerä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°SHTè·ç¦»ELFæ–‡ä»¶çš„èµ·å§‹ä½ç½®åç§»ä¸º688Byteï¼Œå¹¶ä¸”æ¯ä¸€é¡¹çš„å¤§å°ä¸º64Byteï¼Œå…±11é¡¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°SHTå¯¹åº”çš„äºŒè¿›åˆ¶æ®µã€‚ä½†ç”±äºè¿™æ®µä»£ç å¤ªé•¿äº†ï¼Œå› æ­¤åªæˆªå–äº†.textå’Œ.dataè¿™ä¸¤èŠ‚ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212446493.png" alt="image-20230405212446493"><p>å’Œè§£æHeaderä¸€æ ·ï¼Œå¯¹äºSHTçš„æ¯ä¸€ä¸ªè¡¨é¡¹ï¼ŒæŒ‰ç…§ç»“æ„Elf64_Shdr é€ä¸ª Byteè§£æï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†.textå¯¹ ELFæ–‡ä»¶çš„åç§»: .sh_offset &#x3D; 0x0000000000000040ã€.dataå¯¹ELFæ–‡ä»¶çš„åç§»ä¸º0x0000000000000050ã€‘ã€‚å›å¿†èµ·æˆ‘ä»¬å…ˆå‰å¾—çŸ¥Header çš„å¤§å°å°±æ˜¯0x40ï¼Œä¹Ÿå³64 Bytesï¼Œå› æ­¤.textæ‰€å¤„çš„ä½ç½®æ­£æ˜¯Headerä¹‹åã€‚å¹¶ä¸”ï¼Œå®ƒçš„å¤§å°ä¸º.sh_size &#x3D;0x000000000000000eã€å®é™…ä¸Šä¸ºäº†å¯¹é½ï¼Œä¼šè¿›è¡Œè¡¥é›¶ã€‘ï¼Œå°±è¯´æ˜func1()ä¸ func2()ä¸¤ä¸ªå‡½æ•°å æ®äº†14 Bytes(ä½†ç›®å‰æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ¯ä¸€ä¸ªå‡½æ•°çš„çœŸæ­£ä½ç½®)ã€‚å¯¹äº.dataï¼Œæˆ‘ä»¬å¯ä»¥åŒæ ·è¿›è¡Œè§£æã€‚readelf -s elf.o ä¼šç»™æˆ‘ä»¬ç›¸åŒçš„ç»“è®ºï¼ˆæˆ‘ä»¬çœç•¥äº†å…¶ä»–è¡¨é¡¹)ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒSHTä¸­æ€»å­˜åœ¨[o]é¡¹ï¼Œå®ƒè¢«è§†ä¸ºæœªå®šä¹‰çš„ç¬¦å·æ‰€åœ¨Sectionï¼ŒSHN_UNDEFï¼Œä¹Ÿå°±æ˜¯0ã€‚åŒæ—¶ï¼Œè¿™ä¸€SHTè¡¨é¡¹çš„å€¼æ€»æ˜¯64 Bytesçš„0:</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212718033.png" alt="image-20230405212718033" style="zoom:80%;"><h3 id="1-3-ç¬¦å·è¡¨"><a href="#1-3-ç¬¦å·è¡¨" class="headerlink" title="1.3 ç¬¦å·è¡¨"></a>1.3 ç¬¦å·è¡¨</h3><p>æœ€åï¼Œæˆ‘ä»¬è¦å®šä½åˆ°æ¯ä¸€ä¸ªç¬¦å·åœ¨ELFä¸­æ‰€å¤„çš„ä½ç½®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç‰¹åˆ«çš„Sectionï¼Œ<code>symtab</code>ï¼Œä¹Ÿå°±æ˜¯<strong>ç¬¦å·è¡¨</strong>(Symbol Table)ã€‚ç¬¦å·è¡¨è¢«ç”¨æ¥æè¿°.cæºæ–‡ä»¶ä¸­å¯ä»¥<strong>è¢«å…¶ä»–ELFä½¿ç”¨çš„ç¬¦å·</strong>ã€‚å¯¹äºä»€ä¹ˆæ˜¯ç¬¦å·Symbolï¼Œå…¶å®æœ‰å¿…è¦å…ˆä»ç¼–è¯‘å™¨çš„è§’åº¦å»è§‚å¯Ÿ.cæºæ–‡ä»¶ã€‚è¿™éƒ¨åˆ†å·¥ä½œä¸»è¦æ˜¯ç¼–è¯‘ä¸­è¯­ä¹‰åˆ†æ(Semantic Analysis)çš„è¿‡ç¨‹ï¼Œé€šè¿‡è¯­æ³•ä¸­çš„ç¯å¢ƒ(Environment)å’ŒèŒƒå›´(Scope)æ¥è¿›è¡Œç®¡ç†ã€‚å…¶ä¸­Environmentæ˜ å°„åœ¨ç¼–è¯‘å™¨ä¸­ä¹Ÿè¢«ç§°ä¸ºç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¾ˆå¿«ä¾¿èƒ½å‘ç°<strong>ç¼–è¯‘å’Œé“¾æ¥è¯­å¢ƒä¸‹çš„ç¬¦å·è¡¨å…¶å®æ˜¯å«ä¹‰ç›¸åŒçš„</strong>ã€‚</p><p>è€ƒè™‘èµ‹å€¼è¯­å¥<code>int a = 0xaaaaaaaa</code>ï¼Œåœ¨è¿™é‡Œï¼Œç»ˆç»“ç¬¦aå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„å·¦å€¼ï¼Œå…¶å®å®ƒä¼šè¢«å¤„ç†ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼›ç»ˆç»“ç¬¦0xaaaaaaaaæ˜¯æˆ‘ä»¬æ‰€è¯´çš„å³å€¼ï¼Œè¢«å¤„ç†ä¸ºæ•°å€¼ã€‚å½“æˆ‘ä»¬åœ¨åœ¨.cæºæ–‡ä»¶ä¸­å¼•ç”¨ç»ˆç»“ç¬¦aæ—¶ï¼Œå…¶å®åšäº†ä¸¤éƒ¨æ˜ å°„(Two-Stage Mapping)ï¼›</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405192412069.png" alt="image-20230405192412069" style="zoom:67%;"><p>åœ¨Cè¯­è¨€ä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå‡½æ•°ã€å˜é‡ï¼‰æœ‰å®ƒå¯è§çš„Scopeï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨Scopeå†…ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å¯ä»¥è¢«å¼•ç”¨çš„ã€‚è€Œåœ¨ä¸åŒçš„Scopeå†…ï¼ŒEnvironmentæœªå¿…ç›¸åŒã€‚æˆ‘ä»¬ä»”ç»†è€ƒè™‘Cè¯­è¨€çš„è¯­æ³•ï¼Œå¾ˆå®¹æ˜“å‘ç°æºæ–‡ä»¶å¯ä»¥è¢«åŒºåˆ†ä¸ºä¸åŒçš„**å—(Block)**ï¼Œå®ƒä»¬é€šå¸¸è¢«ä¸€ç»„èŠ±æ‹¬å·<code>&#123;&#125;</code>æ‰€åŒ…å›´ï¼Œå¤©ç„¶åœ°å¯¹åº”ä¸€é¢—æœ‰å…³Blockçš„æ ‘ï¼ˆè€ƒè™‘æœ€å¤–å±‚ä¸ºæ ¹èŠ‚ç‚¹ï¼‰ã€‚</p><p>å‡è®¾å½“å‰æœ‰ä¸€ä¸ª<code>.c</code>æ–‡ä»¶ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> g_var_init = <span class="hljs-number">0xffffffff</span>;<br><span class="hljs-type">int</span> g_var_uninit;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func_undef</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">func_def</span><span class="hljs-params">(<span class="hljs-type">int</span> func_param)</span><br>&#123;<br>    <span class="hljs-type">int</span> func_var = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span> <br>    &#123;<br>        <span class="hljs-type">int</span> loop_var = <span class="hljs-number">1</span>;<br>        func_var += <span class="hljs-number">1</span>;<br>        g_var_init += <span class="hljs-number">1</span>;<br>        <br>        func_undef();<br>    &#125; <span class="hljs-keyword">while</span> (func_var &lt; func_param)<br>&#125;<br><br>voud <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    func_def();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸åº”çš„ï¼Œè€ƒè™‘å®ƒçš„Blockæ ‘ï¼Œä»¥åŠæ¯ä¸€ä¸ªBlockå†…å¯è§çš„å¯¹è±¡ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405193201163.png" alt="image-20230405193201163" style="zoom: 80%;"><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯å½“è¿›å…¥ä¸€ä¸ªsub-blockä»¥å‰ï¼Œsub-blockä¼šå¤åˆ¶å½“å‰blockçš„environmentï¼ŒåŒæ—¶ï¼Œåœ¨sub-blockä»¥å†…ï¼Œæ–°å®šä¹‰çš„å˜é‡ã€ä¼ å…¥å‡½æ•°çš„å‚æ•°ï¼Œä¹Ÿéƒ½ä¼šè¢«è§†ä¸ºåœ¨sub-blockå†…æ–°çš„æ˜ å°„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿›å…¥æ–°çš„sub-blockæ—¶ï¼Œå¯ä»¥æ›´æ–°Environmentï¼Œä»è€Œå®ç°äº†å¯¹Environmentçš„ç»´æŠ¤ã€‚</p><p>æˆ‘ä»¬å·²çŸ¥<strong>Cè¯­è¨€ä¸å…è®¸åœ¨å‡½æ•°å†…å®šä¹‰å‡½æ•°</strong>ï¼Œè¿™ä¸ªç®€å•çš„äº‹å®å°†æ•´ä¸ª.cæºæ–‡ä»¶åˆ†ä¸ºæ‰å¹³çš„ä¸¤å±‚ï¼š<strong>å‡½æ•°å†…éƒ¨ï¼ˆInternalï¼‰ã€å‡½æ•°å¤–éƒ¨ï¼ˆExternalï¼‰</strong>ï¼Œå¦‚ä¸‹å›¾ã€‚æˆ‘ä»¬å·²çŸ¥å‡½æ•°Scopeå†…çš„æ•°æ®å®åœ¨Run-Time Stackä¸Šåˆ†é…çš„ï¼Œå› æ­¤å‡½æ•°å†…Scopeçš„Enviromentæ˜ å°„åˆ°æ ˆã€‚è€Œå‡½æ•°å¤–éƒ¨ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æœ¬èº«ä»¥åŠå…¨å±€å˜é‡ï¼Œä»–ä»¬çš„Environmentéœ€è¦æˆ‘ä»¬é¢å¤–ç»´æŠ¤ï¼Œè¿™ä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨åœ¨ELFæ–‡ä»¶ä¸­ç”Ÿæˆçš„ç¬¦å·è¡¨ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405193923601.png" alt="image-20230405193923601" style="zoom:80%;"><p>å› æ­¤,<strong>å¤–éƒ¨</strong>çš„å‡½æ•°ä¸å˜é‡æ˜¯<strong>å¯¹é“¾æ¥å¯è§çš„</strong>ï¼Œä¹Ÿå› æ­¤å®ƒä»¬èƒ½å¤Ÿè¢«å…¶ä»–ELFæ–‡ä»¶æ‰€å¼•ç”¨ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨é“¾æ¥æ—¶æ‰€è¯´çš„ç¬¦å·â€”â€”ä¸€ä¸ªå‡½æ•°(Function)ï¼Œä¸€ä¸ªå…¨å±€å˜é‡(Global Variable)ï¼Œæˆ–ä¸€ä¸ªé™æ€å˜é‡(Static Variable)ã€‚</p><p>æ ¹æ®æˆ‘ä»¬å¯¹ç¬¦å·çš„ç†è§£ï¼ŒæŒ‰ç…§å®šä¹‰å’Œå¼•ç”¨ï¼Œå¯ä»¥å°†ç¬¦å·åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ã€‚å‡å®šsource1.cæ˜¯æˆ‘ä»¬å½“å‰å¯è§çš„æºæ–‡ä»¶ï¼Œsource2.cæ˜¯è¢«é“¾æ¥çš„ELFçš„æºæ–‡ä»¶ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195017042.png" alt="image-20230405195017042" style="zoom:80%;"><p>å…¶ä¸­è¢«staticä¿®é¥°çš„ï¼Œè¢«ç§°ä¸ºå±€éƒ¨ç¬¦å·(Local Symbolã€‰æˆ–é™æ€ç¬¦å·(Static Symbol)ï¼Œåªå¯¹åŒä¸€æºæ–‡ä»¶ä¸­çš„å‡½æ•°å¯è§ã€‚åœ¨æœ¬åœ°æœ‰å®šä¹‰ï¼Œä½†æ²¡æœ‰è¢«staticä¿®é¥°çš„ï¼Œæ˜¯æ™®é€šçš„å…¨å±€ç¬¦å·(Global Symbol)ï¼Œå¯¹é“¾æ¥ä¸­æ‰€æœ‰çš„æºæ–‡ä»¶å¯è§ã€‚è¢«<strong>extern</strong>ä¿®é¥°çš„ï¼Œè¯´æ˜åœ¨å½“å‰çš„æºæ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰ï¼Œè€Œåªåœ¨ extern å¤„æœ‰å£°æ˜ï¼Œæ–¹ä¾¿å½“å‰æºæ–‡ä»¶ä¸­çš„å‡½æ•°å¯¹å®ƒè¿›è¡Œå¼•ç”¨ã€‚</p><p>å…¨å±€ç¬¦å·  æˆ‘ä»¬è€ƒå¯Ÿelf.oä¸­çš„ä¾‹å­ï¼Œdata1ä¸data2æ˜¯ä½œä¸ºå˜é‡çš„ç¬¦å·ï¼Œfunc1ä¸func2æ˜¯ä½œä¸ºå‡½æ•°çš„ç¬¦å·ï¼Œå®ƒä»¬æ˜¯å…¸å‹çš„å…¨å±€ç¬¦å·ã€‚æˆ‘ä»¬æ¥è§‚å¯Ÿå…¨å±€ç¬¦å·æ˜¯æ€æ ·åœ¨ELFè¢«æ‰¾åˆ°çš„ã€‚ä»ELF Headerè®¡ç®—åç§»é‡åˆ°Section Header Tableï¼Œå½“æˆ‘ä»¬è¯»å–åˆ°è¡¨é¡¹ä¸º<code>.symtab</code>æ—¶ï¼Œå°±å¼€å§‹å¤„ç†ç¬¦å·è¡¨ï¼Œç¬¦å·è¡¨è¡¨é¡¹çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\uapi\linux\elf.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">elf64_sym</span> &#123;</span><br>  Elf64_Word st_name;<span class="hljs-comment">/* Symbol name, index in string tbl */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Type and binding attributes */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_other;<span class="hljs-comment">/* No defined meaning, 0 */</span><br>  Elf64_Half st_shndx;<span class="hljs-comment">/* Associated section index */</span><br>  Elf64_Addr st_value;<span class="hljs-comment">/* Value of the symbol */</span><br>  Elf64_Xword st_size;<span class="hljs-comment">/* Associated symbol size */</span><br>&#125; Elf64_Sym;<br></code></pre></td></tr></table></figure><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195558160.png" alt="image-20230405195558160" style="zoom: 80%;"><p>æŸ¥çœ‹SHT</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195628645.png" alt="image-20230405195628645" style="zoom:60%;"><p><code>.symtab</code>æ—¶elf.o SHTä¸­çš„ [8] è¡¨é¡¹ï¼Œå®ƒå¯¹äºELFæ–‡ä»¶çš„åç§»ä¸º 0x000000e0ï¼Œå æ®0x120Byteï¼Œå¹¶ä¸”.symtabä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æœ‰å›ºå®šçš„å¤§å°ï¼ŒElf64_Shdr.sh_entrsize &#x3D; 0x0000000000000018ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195923966.png" alt="image-20230405195923966" style="zoom: 67%;"><p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—åˆ°.symtabä¸€å…±æœ‰12é¡¹ã€‚å¹¶ä¸”å››é¡¹å…³äºdata1ï¼Œdata2ï¼Œfunc1ï¼Œfunc2ï¼š</p><p>é€šè¿‡<code>hexdump -C elf.o</code>åï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs shell">00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|<br>00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|<br>00000020  00 00 00 00 00 00 00 00  a8 02 00 00 00 00 00 00  |................|<br>00000030  00 00 00 00 40 00 00 00  00 00 40 00 0b 00 0a 00  |....@.....@.....|<br>00000040  55 48 89 e5 90 5d c3 55  48 89 e5 90 5d c3 00 00  |UH...].UH...]...|<br>00000050  11 11 11 11 dd dd dd dd  22 22 22 22 dd dd dd dd  |........&quot;&quot;&quot;&quot;....|<br>00000060  00 47 43 43 3a 20 28 55  6f 73 20 38 2e 33 2e 30  |.GCC: (Uos 8.3.0|<br>00000070  2e 33 2d 33 2b 72 65 62  75 69 6c 64 29 20 38 2e  |.3-3+rebuild) 8.|<br>00000080  33 2e 30 00 00 00 00 00  14 00 00 00 00 00 00 00  |3.0.............|<br>00000090  01 7a 52 00 01 78 10 01  1b 0c 07 08 90 01 00 00  |.zR..x..........|<br>000000a0  1c 00 00 00 1c 00 00 00  00 00 00 00 07 00 00 00  |................|<br>000000b0  00 41 0e 10 86 02 43 0d  06 42 0c 07 08 00 00 00  |.A....C..B......|<br>000000c0  1c 00 00 00 3c 00 00 00  00 00 00 00 07 00 00 00  |....&lt;...........|<br>000000d0  00 41 0e 10 86 02 43 0d  06 42 0c 07 08 00 00 00  |.A....C..B......|<br>000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000000f0  00 00 00 00 00 00 00 00  01 00 00 00 04 00 f1 ff  |................|<br>00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000110  00 00 00 00 03 00 01 00  00 00 00 00 00 00 00 00  |................|<br>00000120  00 00 00 00 00 00 00 00  00 00 00 00 03 00 02 00  |................|<br>00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000140  00 00 00 00 03 00 03 00  00 00 00 00 00 00 00 00  |................|<br>00000150  00 00 00 00 00 00 00 00  00 00 00 00 03 00 05 00  |................|<br>00000160  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000170  00 00 00 00 03 00 06 00  00 00 00 00 00 00 00 00  |................|<br>00000180  00 00 00 00 00 00 00 00  00 00 00 00 03 00 04 00  |................|<br>00000190  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000001a0  07 00 00 00 11 00 02 00  00 00 00 00 00 00 00 00  |................|<br>000001b0  08 00 00 00 00 00 00 00  0d 00 00 00 11 00 02 00  |................|<br>000001c0  08 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000001d0  13 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  |................|<br>000001e0  07 00 00 00 00 00 00 00  19 00 00 00 12 00 01 00  |................|<br>000001f0  07 00 00 00 00 00 00 00  07 00 00 00 00 00 00 00  |................|<br>00000200  00 65 6c 66 2e 63 00 64  61 74 61 31 00 64 61 74  |.elf.c.data1.dat|<br>00000210  61 32 00 66 75 6e 63 31  00 66 75 6e 63 32 00 00  |a2.func1.func2..|<br>00000220  20 00 00 00 00 00 00 00  02 00 00 00 02 00 00 00  | ...............|<br>00000230  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|<br>00000240  02 00 00 00 02 00 00 00  07 00 00 00 00 00 00 00  |................|<br>00000250  00 2e 73 79 6d 74 61 62  00 2e 73 74 72 74 61 62  |..symtab..strtab|<br>00000260  00 2e 73 68 73 74 72 74  61 62 00 2e 74 65 78 74  |..shstrtab..text|<br>00000270  00 2e 64 61 74 61 00 2e  62 73 73 00 2e 63 6f 6d  |..data..bss..com|<br>00000280  6d 65 6e 74 00 2e 6e 6f  74 65 2e 47 4e 55 2d 73  |ment..note.GNU-s|<br>00000290  74 61 63 6b 00 2e 72 65  6c 61 2e 65 68 5f 66 72  |tack..rela.eh_fr|<br>000002a0  61 6d 65 00 00 00 00 00  00 00 00 00 00 00 00 00  |ame.............|<br>000002b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>000002e0  00 00 00 00 00 00 00 00  1b 00 00 00 01 00 00 00  |................|<br>000002f0  06 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000300  40 00 00 00 00 00 00 00  0e 00 00 00 00 00 00 00  |@...............|<br>00000310  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000320  00 00 00 00 00 00 00 00  21 00 00 00 01 00 00 00  |........!.......|<br>00000330  03 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000340  50 00 00 00 00 00 00 00  10 00 00 00 00 00 00 00  |P...............|<br>00000350  00 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>00000360  00 00 00 00 00 00 00 00  27 00 00 00 08 00 00 00  |........&#x27;.......|<br>00000370  03 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000380  60 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |`...............|<br>00000390  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>000003a0  00 00 00 00 00 00 00 00  2c 00 00 00 01 00 00 00  |........,.......|<br>000003b0  30 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |0...............|<br>000003c0  60 00 00 00 00 00 00 00  24 00 00 00 00 00 00 00  |`.......$.......|<br>000003d0  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>000003e0  01 00 00 00 00 00 00 00  35 00 00 00 01 00 00 00  |........5.......|<br>000003f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000400  84 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000410  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000420  00 00 00 00 00 00 00 00  4a 00 00 00 01 00 00 00  |........J.......|<br>00000430  02 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000440  88 00 00 00 00 00 00 00  58 00 00 00 00 00 00 00  |........X.......|<br>00000450  00 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>00000460  00 00 00 00 00 00 00 00  45 00 00 00 04 00 00 00  |........E.......|<br>00000470  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |@...............|<br>00000480  20 02 00 00 00 00 00 00  30 00 00 00 00 00 00 00  | .......0.......|<br>00000490  08 00 00 00 06 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000004a0  18 00 00 00 00 00 00 00  01 00 00 00 02 00 00 00  |................|<br>000004b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000004c0  e0 00 00 00 00 00 00 00  20 01 00 00 00 00 00 00  |........ .......|<br>000004d0  09 00 00 00 08 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000004e0  18 00 00 00 00 00 00 00  09 00 00 00 03 00 00 00  |................|<br>000004f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000500  00 02 00 00 00 00 00 00  1f 00 00 00 00 00 00 00  |................|<br>00000510  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000520  00 00 00 00 00 00 00 00  11 00 00 00 03 00 00 00  |................|<br>00000530  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000540  50 02 00 00 00 00 00 00  54 00 00 00 00 00 00 00  |P.......T.......|<br>00000550  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>*<br>00000568<br></code></pre></td></tr></table></figure><p><strong>ä»¥data1ä¸ºä¾‹ï¼Œä»‹ç»å…¶åœ¨ç¬¦å·è¡¨ä¸­çš„å„ç§å«ä¹‰ï¼š</strong></p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405200137407.png" alt="image-20230405200137407" style="zoom:80%;"><ul><li>æ ¹æ®Elf64_Sym.st_nameå¯ä»¥æŸ¥åˆ°ç¬¦å·åœ¨å­—ç¬¦è¡¨ä¸­çš„åå­—ï¼Œst_name&#x3D;0x7ï¼Œä»å­—ç¬¦ä¸²è¡¨åç§»0x7Byteï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç»ˆç»“ç¬¦00(<code>\0</code>)ï¼Œæ‰€å¾—åˆ°çš„å­—ç¬¦ä¸²ä¸ºï¼š<u>64 61 74 61 31 00</u>ï¼Œè½¬è¯‘ä¸ºASCIIç çš„å­—ç¬¦ä¸ºâ€™dâ€™,â€™aâ€™,â€™tâ€™,â€™aâ€™,â€™1â€™,â€™\0â€™ã€‚</li></ul><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405200642983.png" alt="image-20230405200642983" style="zoom:80%;"><ul><li>ç¬¦å·data1çš„Sectionç´¢å¼•ä¸ºElf64_Sym.st_index &#x3D; 0x2ï¼Œé‚£ä¹ˆåœ¨SHTä¸­ï¼Œç¼–å·ä¸º[2] çš„è¡¨é¡¹æ˜¯ <code>.data</code>èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬ç¡®å®šäº†data1æ‰€åœ¨çš„Sectionã€‚å†æ ¹æ®Elf64_Sym.st_value&#x3D;0x0ï¼Œæˆ‘ä»¬çŸ¥é“data1å¯¹<code>.data</code>èŠ‚çš„åç§»ä¸º0ï¼Œåˆ°æ­¤ä¸ºæ­¢æ˜¯Environmentæ˜ å°„ã€‚ç”±ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¾—åˆ°data1å æ®Elf64_Sym.st_size &#x3D; 0x8 Byteã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå®Œæˆäº†Typeçš„æ˜ å°„ï¼Œå¯ä»¥è·å¾—data1çš„æ•°å€¼äº†ï¼šã€.dataèŠ‚çš„åç§»é‡ä¸º0x50ï¼Œä¸”data1å¯¹.dataåç§»ä¸º0ï¼Œdata1æ•°å€¼å æ®8å­—èŠ‚ã€‘</li></ul><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405201014924.png" alt="image-20230405201014924" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ,ç¼–è¯‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶</title>
    <link href="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶"><a href="#Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶" class="headerlink" title="Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶"></a>Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶</h1><blockquote><p>å‚è€ƒï¼š<a href="https://www.jb51.cc/python/3860648.html">https://www.jb51.cc/python/3860648.html</a></p></blockquote><p>Linux çš„è¿…é€Ÿå‘å±•è‡´ä½¿ç›¸é‚»ç‰ˆæœ¬çš„å†…æ ¸ä¹‹é—´äº¦å­˜åœ¨è¾ƒå¤§çš„å·®å¼‚ï¼Œå³åœ¨ç‰ˆæœ¬è¡¥ä¸å·ï¼ˆPatch Levelï¼Œå³å†…æ ¸ç‰ˆæœ¬å·çš„ç¬¬å››ä½æ•°ï¼‰ç›¸é‚»çš„å†…æ ¸ä¹‹é—´ã€‚ä¸ºæ­¤ Linux çš„å¼€å‘è€…ä¸ºäº†ä¿è¯å†…æ ¸çš„ç¨³å®šï¼ŒLinux åœ¨åŠ è½½æ¨¡å—åˆ°å†…æ ¸æ—¶å¯¹æ¨¡å—é‡‡ç”¨äº†ç‰ˆæœ¬æ ¡éªŒæœºåˆ¶ã€‚å½“è¢«æœŸæœ›åŠ è½½æ¨¡å—çš„ç³»ç»Ÿç¯å¢ƒä¸æ¨¡å—çš„æ„å»ºç¯å¢ƒç›¸å·¦æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°å¦‚æ¸…å• 1 æ‰€ç¤ºçš„è£…è½½æ¨¡å—å¤±è´¥ã€‚</p><h2 id="1-æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥"><a href="#1-æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥" class="headerlink" title="1.æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥"></a>1.æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å½“æ¨¡å—åŠ è½½æ—¶å€™çš„æŠ¥é”™ä¿¡æ¯ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402204428316.png" alt="image-20230402204428316" style="zoom:100%;"><p>æ¨¡å— hello.ko æ„å»ºæ—¶çš„ç¯å¢ƒä¸å½“å‰ç³»ç»Ÿä¸ä¸€è‡´ï¼Œå¯¼è‡´å·¥å…· insmod åœ¨å°è¯•è£…è½½æ¨¡å— hello.ko åˆ°å†…æ ¸æ—¶å¤±è´¥ã€‚hello.ko æ˜¯ä¸€ä¸ªä»…ä½¿ç”¨äº†å‡½æ•° printk çš„æ™®é€šæ¨¡å—ï¼ˆã€‚æˆ‘ä»¬é€šè¿‡å‘½ä»¤ dmesgè·å–æ¨¡å—è£…è½½å¤±è´¥çš„å…·ä½“åŸå› ã€‚ä»æ—¥å¿—æ‰“å°çš„<code>disagree about version of sysmbol module layout</code>å¯ä»¥çœ‹å‡ºï¼Œæ¨¡å— hello.ko è£…è½½å¤±è´¥æ˜¯ç”±äº<strong>æ¨¡å—ä¸­ module_layout çš„å¯¼å‡ºç¬¦å·çš„ç‰ˆæœ¬ä¿¡æ¯ä¸å½“å‰å†…æ ¸ä¸­çš„ä¸ç¬¦</strong>ã€‚</p><p>å‡½æ•° module_layout è¢«å®šä¹‰åœ¨å†…æ ¸æ¨¡å—ç‰ˆæœ¬é€‰é¡¹ MODVERSIONSï¼ˆå³å†…æ ¸å¯è£…è½½æ¨¡å—çš„ç‰ˆæœ¬æ ¡éªŒé€‰é¡¹ï¼‰ä¹‹åã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># kernel\module.c</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MODVERSIONS</span><br><span class="hljs-comment">/* Generate the signature for all relevant module structures here.</span><br><span class="hljs-comment"> * If these change, we don&#x27;t want to try to parse the module. */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">module_layout</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> module *mod,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> modversion_info *ver,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> kernel_param *kp,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> kernel_symbol *ks,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> tracepoint * <span class="hljs-type">const</span> *tp)</span><br>&#123;<br>&#125;<br>EXPORT_SYMBOL(module_layout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ¯”å¯¹å†…æ ¸çš„module_layout å’Œ å¤–éƒ¨æ¨¡å—çš„module_layoutå€¼å‘¢ï¼Ÿ</p><h3 id="1-1-æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module-layoutçš„CRC"><a href="#1-1-æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module-layoutçš„CRC" class="headerlink" title="1.1 æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module_layoutçš„CRC"></a>1.1 æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module_layoutçš„CRC</h3><p>å†…æ ¸çš„<code>module_layout</code>çš„CRCå€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å†…æ ¸ç¼–è¯‘çš„<code>Module.symvers</code>æ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat Module.symvers | grep module_layout<br></code></pre></td></tr></table></figure><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402194808674.png" alt="image-20230402194808674" style="zoom:100%;"><p>å¤–éƒ¨æ¨¡å—<code>module_layout</code>çš„CRCå€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡modprodeæŸ¥çœ‹ç¼–è¯‘å‡ºçš„koæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">modprobe --dump-versions xxx.ko | grep module_layout<br></code></pre></td></tr></table></figure><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402194909699.png" alt="image-20230402194909699" style="zoom:100%;"><blockquote><p>å¯ä»¥çœ‹åˆ°å†…æ ¸ä¸å¤–éƒ¨æ¨¡å—çš„module_layoutå€¼æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>insmodæˆ–è€…modprobeåŠ è½½chrdevbase.ko</strong></p></blockquote><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/8d71df88-4caa-436c-b5eb-72d2a53f2b31.png"><h3 id="1-2-Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ"><a href="#1-2-Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ" class="headerlink" title="1.2 Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ"></a>1.2 Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ</h3><p>inux å¯¹å¯è£…è½½æ¨¡å—é‡‡å–äº†ä¸¤å±‚éªŒè¯ï¼š<strong>æ¨¡å—çš„ CRC å€¼æ ¡éªŒ</strong>å’Œ <strong>vermagic çš„æ£€æŸ¥</strong>ã€‚</p><p>å…¶ä¸­æ¨¡å— CRC å€¼æ ¡éªŒé’ˆå¯¹æ¨¡å—ï¼ˆå†…æ ¸ï¼‰å¯¼å‡ºç¬¦å·ï¼Œæ˜¯ä¸€ç§ç®€å•çš„ ABIï¼ˆå³ Application Binary Interfaceï¼‰ä¸€è‡´æ€§æ£€æŸ¥ï¼Œç¬¬ä¸€èŠ‚å¼€å¤´çš„ hello.ko åŠ è½½å¤±è´¥çš„æ ¹æœ¬åŸå› å°±æ˜¯æ²¡æœ‰é€šè¿‡ CRC å€¼æ ¡éªŒï¼ˆå³ module_layout çš„ CRC å€¼ä¸å½“å‰å†…æ ¸ä¸­çš„ä¸ç¬¦ï¼‰ã€‚</p><p>è€Œæ¨¡å— vermagicï¼ˆå³ Version Magic Stringï¼‰åˆ™ä¿å­˜äº†æ¨¡å—ç¼–è¯‘æ—¶çš„å†…æ ¸ç‰ˆæœ¬ä»¥åŠ SMP ç­‰é…ç½®ä¿¡æ¯ï¼Œå½“æ¨¡å— vermagic ä¸ä¸»æœºä¿¡æ¯ä¸ç›¸ç¬¦æ—¶äº¦å°†ç»ˆæ­¢æ¨¡å—çš„åŠ è½½ã€‚</p><h2 id="2-æ¨¡å—çš„CRCå€¼æ ¡éªŒ"><a href="#2-æ¨¡å—çš„CRCå€¼æ ¡éªŒ" class="headerlink" title="2.æ¨¡å—çš„CRCå€¼æ ¡éªŒ"></a>2.æ¨¡å—çš„CRCå€¼æ ¡éªŒ</h2><p>é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸€ä¸‹CTCå€¼æ ¡éªŒåœ¨å“ªé‡Œæ·»åŠ ï¼Œåˆæ˜¯å¦‚ä½•è¿›è¡Œæ ¡éªŒçš„</p><h3 id="2-1-æ·»åŠ æ¨¡å—çš„CRCå€¼"><a href="#2-1-æ·»åŠ æ¨¡å—çš„CRCå€¼" class="headerlink" title="2.1 æ·»åŠ æ¨¡å—çš„CRCå€¼"></a>2.1 æ·»åŠ æ¨¡å—çš„CRCå€¼</h3><p>å½“æˆ‘ä»¬åœ¨ç¼–è¯‘å†…æ ¸æ¨¡å—æ—¶ï¼Œä¼šç”Ÿæˆè®¸å¤šçš„ä¸­é—´æ–‡ä»¶ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402205606535.png" alt="image-20230402205606535" style="zoom:80%;"><p>å…¶ä¸­<strong>chrdevbase.mod.c</strong>æ˜¯åœ¨æ¨¡å—æºæ–‡ä»¶chrdevbase.cåŸºç¡€ä¸Šè¿›è¡Œçš„æ‰©å±•ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402205711705.png" alt="image-20230402205711705" style="zoom:67%;"><blockquote><p>ğŸ¤º <strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçº¢è‰²åœˆå‡ºæ¥çš„å°±æ˜¯å„ä¸ªç¬¦å·ï¼Œå‰é¢çš„16è¿›åˆ¶æ•°å­—å°±æ˜¯æ¯ä¸ªç¬¦å·å¯¹åº”çš„CRCå€¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œmodule_layoutå¯¹åº”çš„CRCå€¼å°±æ˜¯0xfa985410ï¼Œä¸1.1èŠ‚çœ‹åˆ°çš„æ˜¯ä¸€æ ·çš„ï¼</p></blockquote><p>é‚£ä¹ˆchrdevbase.mod.cåœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­ï¼Œ ä¼šè°ƒç”¨modpostæ·»åŠ å„ç§ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€æ­¥å°±æ˜¯æ·»åŠ ç‰ˆæœ¬å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// scripts\mod\modpost.h</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-keyword">for</span> (mod = modules; mod; mod = mod-&gt;next) &#123;<br>err |= add_versions(&amp;buf, mod);<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_versions</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buffer *b, <span class="hljs-keyword">struct</span> module *mod)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> *<span class="hljs-title">s</span>, *<span class="hljs-title">exp</span>;</span><br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">for</span> (s = mod-&gt;unres; s; s = s-&gt;next) &#123;<br><span class="hljs-built_in">exp</span> = find_symbol(s-&gt;name);<br>s-&gt;module = <span class="hljs-built_in">exp</span>-&gt;module;<br>s-&gt;crc_valid = <span class="hljs-built_in">exp</span>-&gt;crc_valid;<br>s-&gt;crc = <span class="hljs-built_in">exp</span>-&gt;crc;<br>&#125;<br><br>buf_printf(b, <span class="hljs-string">&quot;\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;static const struct modversion_info ____versions[]\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;__used\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;__attribute__((section(\&quot;__versions\&quot;))) = &#123;\n&quot;</span>);<br><br><span class="hljs-keyword">for</span> (s = mod-&gt;unres; s; s = s-&gt;next) &#123;<br><span class="hljs-keyword">if</span> (!s-&gt;module)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!s-&gt;crc_valid) &#123;<br>warn(<span class="hljs-string">&quot;\&quot;%s\&quot; [%s.ko] has no CRC!\n&quot;</span>,<br>s-&gt;name, mod-&gt;name);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>        <span class="hljs-comment">// æ·»åŠ å„ä¸ªç¬¦å·SYSBOLå¯¹åº”çš„CRCå€¼</span><br>buf_printf(b, <span class="hljs-string">&quot;\t&#123; %#8x, __VMLINUX_SYMBOL_STR(%s) &#125;,\n&quot;</span>, s-&gt;crc, s-&gt;name);<br>&#125;<br><br>buf_printf(b, <span class="hljs-string">&quot;&#125;;\n&quot;</span>);<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>å“‡å“¦ï¼Œä»è¿™é‡Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œæœ€ç»ˆç”Ÿæˆçš„chrdevbase.mod.cã€æˆ–chrdevbase.koã€‘æ˜¯é€šè¿‡add_versionæ·»åŠ çš„ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402210324480.png" alt="image-20230402210324480" style="zoom:80%;"><h3 id="2-2-é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼"><a href="#2-2-é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼" class="headerlink" title="2.2 é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼"></a>2.2 é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼</h3><p>æˆ‘ä»¬åœ¨ä¸Šè¿°<code>cat chrdevbase.mod.c</code>ä¸­å¯ä»¥çœ‹åˆ°å‡ ä¸ªsectionï¼Œå¦‚ .modinfoã€.gnu.linkonce.this_module å’Œ __versionsã€‚<u>Linux ä½¿ç”¨ GCC ä¸­çš„å£°æ˜å‡½æ•°å±æ€§ <code>__attribute__ </code>å®Œæˆå¯¹æ¨¡å—çš„ç‰ˆæœ¬ä¿¡æ¯é™„åŠ </u>ã€‚</p><p>é€šè¿‡<code>objdump --section=__versions -s chrdevbase.ko</code>çš„å€¼æŸ¥çœ‹å½“å‰æ¨¡å—çš„ç‰ˆæœ¬versionå€¼</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402211313240.png" alt="image-20230402211313240" style="zoom:50%;"><p>å¯ä»¥çœ‹åˆ°å½“å‰æ¨¡å—çš„module_layoutä¹ŸåŒ¹é…ä¸Šäº†ï¼Œå¦å¤–çš„å‡ ä¸ªå€¼ï¼Œå¦‚<code>__unregister_chrdev</code>ä¹Ÿå¯¹åº”äº†ä¸Šè¿°çš„CRCå€¼</p><h3 id="2-3-åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC"><a href="#2-3-åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC" class="headerlink" title="2.3 åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC"></a>2.3 åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC</h3><p>ğŸ¥‡ğŸ¥ˆğŸ¥‰ <strong>æ¨¡å— CRC å€¼æ ¡éªŒæŸ¥çœ‹çš„æ˜¯å°±æ˜¯æ¨¡å— __versions å°èŠ‚çš„å†…å®¹ï¼Œæ¨¡å—çš„ CRC æ ¡éªŒè¿‡ç¨‹åœ¨å‡½æ•° setup_load_info ä¸­å®Œæˆ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel\module.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> module *<span class="hljs-title function_">setup_load_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> load_info *info, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">/* Check module struct version now, before we try to use module. */</span><br><span class="hljs-keyword">if</span> (!check_modstruct_version(info-&gt;sechdrs, info-&gt;index.vers, mod))<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOEXEC);<br><br><span class="hljs-keyword">return</span> mod;<br>&#125;<br><br><span class="hljs-comment">//--------------------------------------------------------</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_modstruct_version</span><span class="hljs-params">(Elf_Shdr *sechdrs, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> versindex, <span class="hljs-keyword">struct</span> module *mod)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *crc;<br><br><span class="hljs-keyword">if</span> (!find_symbol(VMLINUX_SYMBOL_STR(module_layout), <span class="hljs-literal">NULL</span>,&amp;crc, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>))<br>        BUG();<br><span class="hljs-keyword">return</span> check_version(sechdrs, versindex, VMLINUX_SYMBOL_STR(module_layout), mod, crc, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-comment">//--------------------------------------------------------</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_version</span><span class="hljs-params">(Elf_Shdr *sechdrs, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> versindex, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symname, <span class="hljs-keyword">struct</span> module *mod, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *crc, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> module *crc_owner)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, num_versions;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">modversion_info</span> *<span class="hljs-title">versions</span>;</span><br><br><br>versions = (<span class="hljs-type">void</span> *) sechdrs[versindex].sh_addr;<br>num_versions = sechdrs[versindex].sh_size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> modversion_info);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num_versions; i++) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(versions[i].name, symname) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (versions[i].crc == maybe_relocated(*crc, crc_owner))<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>pr_debug(<span class="hljs-string">&quot;Found checksum %lX vs module %lX\n&quot;</span>,<br>       maybe_relocated(*crc, crc_owner), versions[i].crc);<br><span class="hljs-keyword">goto</span> bad_version;<br>&#125;<br><br>pr_warn(<span class="hljs-string">&quot;%s: no symbol version for %s\n&quot;</span>, mod-&gt;name, symname);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>bad_version:<br>pr_warn(<span class="hljs-string">&quot;%s: disagrees about version of symbol %s\n&quot;</span>,<br>       mod-&gt;name, symname);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æˆ‘çš„å¤©ï¼Œç»ˆäºçœ‹åˆ°äº†ç¬¬1èŠ‚æŠ¥é”™çš„æŠ¥é”™çš„æ¥æºå•¦ï¼</strong></p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402213008474.png" alt="image-20230402213008474" style="zoom:80%;"><h3 id="2-4-ä¸ºä»€ä¹ˆmodule-layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–"><a href="#2-4-ä¸ºä»€ä¹ˆmodule-layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–" class="headerlink" title="2.4 ä¸ºä»€ä¹ˆmodule_layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–"></a>2.4 ä¸ºä»€ä¹ˆmodule_layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–</h3><p>æ ¹æ®é™„å½•2ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¯¼å‡ºçš„ç¬¦å·å¦‚æœæ˜¯å‡½æ•°æ—¶ï¼Œå¦‚æœCRCå€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œå¯èƒ½æ˜¯<strong>å‚æ•°å˜åŒ–</strong>æˆ–è€…<strong>è¿”å›å€¼å˜åŒ–</strong>ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å°†<strong>module_layout</strong>çš„å‚æ•°è¿›è¡Œå˜åŒ–ï¼Œç¼–è¯‘åæŸ¥çœ‹å…¶CRCå€¼</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405235046404.png" alt="image-20230405235046404" style="zoom: 50%;"><blockquote><p>æˆ‘ä»¬åœ¨å‚æ•°ä¸­æ·»åŠ äº†<code>int num</code>ï¼Œå‘ç°å€¼å˜åŒ–æˆäº†<code>0x5d01a2ac</code></p></blockquote><p>å°†<strong>module_layout</strong>çš„å‚æ•°æ¢å¤æˆåŸæ ·ï¼Œé‡æ–°ç¼–è¯‘</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405235204648.png" alt="image-20230405235204648" style="zoom:50%;"><blockquote><p>å¯ä»¥çœ‹åˆ°åˆæ¢å¤æˆäº†åŸæ¥çš„1.1èŠ‚ä¸­çš„å€¼</p></blockquote><h3 id="2-5-module-layout-å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ"><a href="#2-5-module-layout-å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ" class="headerlink" title="2.5 module_layout å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ"></a>2.5 module_layout å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ</h3><p>å½“æˆ‘ä»¬åœ¨module.cä¸­<code>EXPORT_SYMBOL(module_layout)</code>ä¹‹åï¼Œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå®ä¼šè¢«æ›¿æ¢æˆä¸‹é¢çš„å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\export.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __CRC_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">extern __visible void *__crc_##sym __attribute__((weak));\</span><br><span class="hljs-meta">static const unsigned long __kcrctab_##sym\</span><br><span class="hljs-meta">__used\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;___kcrctab&quot;</span> sec <span class="hljs-string">&quot;+&quot;</span> #sym), unused))\</span><br><span class="hljs-meta">= (unsigned long) &amp;__crc_##sym;</span><br><br><span class="hljs-comment">/* For every exported symbol, place a struct in the __ksymtab section */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __EXPORT_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">extern typeof(sym) sym;\</span><br><span class="hljs-meta">__CRC_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">static const char __kstrtab_##sym[]\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;__ksymtab_strings&quot;</span>), aligned(1))) \</span><br><span class="hljs-meta">= VMLINUX_SYMBOL_STR(sym);\</span><br><span class="hljs-meta">extern const struct kernel_symbol __ksymtab_##sym;\</span><br><span class="hljs-meta">__visible const struct kernel_symbol __ksymtab_##sym\</span><br><span class="hljs-meta">__used\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;___ksymtab&quot;</span> sec <span class="hljs-string">&quot;+&quot;</span> #sym), unused))\</span><br><span class="hljs-meta">= &#123; (unsigned long)&amp;sym, __kstrtab_##sym &#125;</span><br></code></pre></td></tr></table></figure><p>EXPORT_SYMBOL(sym)çš„è¿™ä¸€æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯é’ˆå¯¹æ¨¡å—ç‰ˆæœ¬æ ¡éªŒæœºåˆ¶ï¼Œç”Ÿæˆäº†æŸä¸ªç¬¦å·ç›¸åº”çš„3ä¸ªæ®µçš„å€¼ã€‚æ®µ<code>__ksymtab</code>ä¿å­˜äº†ç¬¦å·çš„åœ°å€å’Œåå­—ï¼Œæ®µ<code>__ksymtab_strings</code>æ˜¯æ®µåå­—çš„å®é™…å­˜å‚¨ä½ç½®ï¼Œæ®µ<code>__kcrctab</code>ä¿å­˜äº†ç¬¦å·crcå€¼çš„åœ°å€ã€‚</p><p>å¯è§EXPORT_SYMBOL(sym)å®å£°æ˜ä»¥åï¼Œç¬¦å·çš„åœ°å€åå­—å’ŒCRCå€¼éƒ½æœ‰äº†ï¼Œå·²ç»ç¬¦åˆç‰ˆæœ¬æ ¡éªŒçš„éœ€è¦äº†ã€‚å¯è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œç¬¦å·å®é™…çš„crcå€¼æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿå®ä¸­å¼•ç”¨äº†ä¸€ä¸ªå¤–éƒ¨å˜é‡<code>extern void *__crc_##sym attribute((weak));</code>ï¼Œ<code>__crc##sym</code>æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p><p>__crc##symæ˜¯åœ¨ç¼–è¯‘.oæ—¶å€™åšçš„ï¼ŒæŸ¥çœ‹å†…æ ¸çš„makefileï¼Œmakefile.buildæ–‡ä»¶å®šä¹‰äº†.oçš„ç”Ÿæˆè§„åˆ™ï¼š<br><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406225635425.png" alt="image-20230405235204648" style="zoom: 67%;"></p><p>è€Œå½“CONFIG_MODVERSIONS&#x3D;y æ—¶ï¼Œ cmd_cc_o_c ä¼šå°†file.c ç¼–è¯‘æˆ.tmp_file.oè€Œä¸æ˜¯file.o ã€‚cmd_modversions ä¼šæ£€æŸ¥.tmp_file.o æ˜¯å¦åŒ…å«<code>__ksymtab</code> ï¼Œä¹Ÿå°±æ˜¯è¯´file.c æ˜¯å¦åŒ…å«EXPORT_SYMBOL(xxx)ï¼›å¦‚æœæ²¡æœ‰__ksymtab ï¼Œ cmd_modversions ä¼šå°†.tmp_file.o ç›´æ¥æ›´åä¸ºfile.o ã€‚å¦‚æœç¡®å®åŒ…å«__ksymtab ï¼Œ cmd_modversions ä¼šé€šè¿‡genksyms äº§ç”Ÿxxxx ( export symbol )çš„ç¬¦å·ç­¾å( checksum )ï¼Œç„¶åè°ƒç”¨linker é‡æ–°æŠŠè¿™äº›ç¬¦å·ä»¥åŠè¿™äº›ç¬¦å·çš„checksumé“¾æ¥è¿›file.oã€‚</p><p>å¯è§ç¬¦å·çš„CRCå€¼_crc##symï¼Œæ˜¯åœ¨ç¼–è¯‘.oæ—¶ï¼Œç”±genksymsè„šæœ¬ç”Ÿæˆçš„ã€‚</p><p>é€šè¿‡readelfå‘½ä»¤å¯ä»¥ï¼ŒæŸ¥çœ‹å†…æ ¸ä¸­å…³äºç‰ˆæœ¬æ£€æŸ¥çš„ä¸‰ä¸ªæ®µ<code>__ksymtab</code>ã€<code>__ksymtab_strings</code>ã€<code>__kcrctab</code>ï¼š</p><p><img src="/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406231443917.png" alt="image-20230406231443917"></p><p>å¦‚æœmodule_layoutåœ¨ç¬¦å·è¡¨ä¸­åœ°å€ä¸åŒï¼Œåˆ™ç¼–è¯‘ç”ŸæˆåæœŸå¯¹åº”çš„CRCå€¼æ˜¯ä¸åŒçš„ï¼ï¼</p><p>ğŸ¤– <strong>å¦‚æœä¸¤ä»½å®Œå…¨ä¸€æ ·çš„module_layoutä»£ç ï¼Œä½†æ˜¯ç”Ÿæˆçš„CRCå€¼ä¸åŒ</strong>  -&gt; é‚£ä¹ˆï¼Œå¿…å®šæ˜¯module_layoutåœ¨ç¬¦å·è¡¨ä¸­çš„ä½ç½®ä¸åŒï¼Œä¹Ÿå°±æ˜¯åœ¨module_layoutä¹‹å‰è‚¯å®šEXPORT_SYMBOLäº†å…¶ä»–çš„ç¬¦å·ï¼Œå¯¼è‡´module_layoutåœ¨å¯¹åº”çš„ç¬¦å·è¡¨ä¸­ä½ç½®ä¸åŒ</p><h2 id="3-æ¨¡å—çš„vermagicæ£€éªŒ"><a href="#3-æ¨¡å—çš„vermagicæ£€éªŒ" class="headerlink" title="3.æ¨¡å—çš„vermagicæ£€éªŒ"></a>3.æ¨¡å—çš„vermagicæ£€éªŒ</h2><h3 id="3-1-å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„"><a href="#3-1-å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„" class="headerlink" title="3.1 å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„"></a>3.1 å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„</h3><p>inuxç‰ˆæœ¬ï¼šåœ¨<code>include/generated/utsrelease.h</code>ä¸­å®šä¹‰ï¼Œæ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š**#define UTS_RELEASE â€œ4.1.15â€**ï¼Œutsrelease.hæ˜¯kernelç¼–è¯‘åè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”¨æˆ·æ›´æ”¹é‡Œé¢çš„å†…å®¹ä¸ä¼šæœ‰æ•ˆæœã€‚</p><h3 id="3-2-æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„"><a href="#3-2-æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„" class="headerlink" title="3.2 æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„"></a>3.2 æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„</h3><p>åœ¨<code>include/linux/vermagic.h</code>ä¸­å®šä¹‰æœ‰VERMAGIC_STRINGï¼ŒVERMAGIC_STRINGä¸ä»…åŒ…å«å†…æ ¸ç‰ˆæœ¬å·ï¼Œè¿˜åŒ…å«æœ‰ å†…æ ¸ä½¿ç”¨çš„gccç‰ˆæœ¬ï¼ŒSMPä¸PREEMPTç­‰é…ç½®ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> VERMAGIC_STRING \</span><br><span class="hljs-meta">UTS_RELEASE <span class="hljs-string">&quot; &quot;</span>\</span><br><span class="hljs-meta">MODULE_VERMAGIC_SMP MODULE_VERMAGIC_PREEMPT \</span><br><span class="hljs-meta">MODULE_VERMAGIC_MODULE_UNLOAD MODULE_VERMAGIC_MODVERSIONS\</span><br><span class="hljs-meta">MODULE_ARCH_VERMAGIC</span><br></code></pre></td></tr></table></figure><p>æ¨¡å—åœ¨ç¼–è¯‘æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å±å¹•ä¸Šä¼šæ˜¾ç¤ºâ€MODPOSTâ€ã€‚åœ¨æ­¤é˜¶æ®µï¼ŒVERMAGIC_STRINGä¼šæ·»åŠ åˆ°æ¨¡å—çš„modinfoæ®µã€‚åœ¨å†…æ ¸æºç ç›®å½•ä¸‹scripts\mod\modpost.cæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°æ¨¡å—åç»­å¤„ç†éƒ¨åˆ†çš„ä»£ç ã€‚</p><p>æ¨¡å—ç¼–è¯‘ç”Ÿæˆåï¼Œé€šè¿‡<code>modinfo xxx.ko</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ­¤æ¨¡å—çš„vermagicç­‰ä¿¡æ¯ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406233259580.png" alt="image-20230406233259580" style="zoom: 80%;"><h3 id="3-3-å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic"><a href="#3-3-å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic" class="headerlink" title="3.3 å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic"></a>3.3 å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* kernel/module.c */</span> <br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_modinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> module *mod,<span class="hljs-keyword">struct</span> load_info *info)</span> <br>&#123; <br> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *modmagic = get_modinfo(info,<span class="hljs-string">&quot;vermagic&quot;</span>); <br> ... <br> &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!same_magic(modmagic,vermagic,info-&gt;index.vers)) &#123; <br>   ... <br> &#125; <br> ... <br> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é™„å½•1ï¼šmodule-symvers-æ–‡ä»¶çš„å†…å®¹"><a href="#é™„å½•1ï¼šmodule-symvers-æ–‡ä»¶çš„å†…å®¹" class="headerlink" title="é™„å½•1ï¼šmodule.symvers æ–‡ä»¶çš„å†…å®¹"></a>é™„å½•1ï¼šmodule.symvers æ–‡ä»¶çš„å†…å®¹</h2><p>å¦‚æœæ‰“å¼€è¯¥æ–‡ä»¶åçœ‹åˆ°çš„ç¬¦å·CRCå€¼éƒ½æ˜¯0x00000000ï¼Œé‚£æ˜¯å› ä¸ºä½ åœ¨é…ç½®çš„æ—¶å¹¶æ²¡æœ‰è®¾ç½® <code>CONFIG_MODVERSIONS</code>ã€‚ä¸€æ—¦è®¾ç½®è¿‡è¿™ä¸ªé…ç½®é€‰é¡¹ï¼Œå°±æ„å‘³ç€æ‰“å¼€äº†å†…æ ¸çš„ <strong>Module versioning</strong>åŠŸèƒ½ã€‚Module versioning åŠŸèƒ½åº”ç”¨åœ¨æˆ‘ä»¬ä½¿ç”¨æ¨¡å—çš„åœºåˆã€‚</p><p>å¦‚æœModule versioningåŠŸèƒ½è¢«æ‰“å¼€çš„è¯ï¼Œå®ƒä¼šä»¥æ¯ä¸ªå¯¼å‡ºç¬¦å·çš„CåŸå‹å£°æ˜ä½œä¸ºè¾“å…¥ï¼Œè®¡ç®—å‡ºå¯¹åº”çš„CRCæ ¡éªŒå€¼ï¼Œä¿å­˜åœ¨æ–‡ä»¶ Module.symvers ä¸­ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå†…æ ¸åœ¨åé¢è¦åŠ è½½ä½¿ç”¨æ¨¡å—çš„æ—¶å€™ï¼Œä¼šä¸¤ç›¸æ¯”è¾ƒæ¨¡å—ä¸­çš„CRCå€¼å’Œä¿å­˜ä¸‹æ¥çš„CRCå€¼ï¼Œå¦‚æœå‘ç°ä¸ç›¸ç­‰ï¼Œå†…æ ¸å°±æ‹’ç»åŠ è½½è¿™ä¸ªæ¨¡å—ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230403230704333.png" alt="image-20230403230704333" style="zoom:100%;"><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230403231013373.png" alt="image-20230403231013373" style="zoom:100%;"><h2 id="é™„å½•2ï¼šCRCæœºåˆ¶"><a href="#é™„å½•2ï¼šCRCæœºåˆ¶" class="headerlink" title="é™„å½•2ï¼šCRCæœºåˆ¶"></a>é™„å½•2ï¼šCRCæœºåˆ¶</h2><blockquote><p><a href="https://zhuanlan.zhihu.com/p/414290127?utm_id=0">https://zhuanlan.zhihu.com/p/414290127?utm_id=0</a></p></blockquote><p>å†…æ ¸æ¨¡å—ç¬¦å·CRCç”Ÿæˆç›¸å…³ä»£ç åœ¨scripts&#x2F;genksyms&#x2F;ç›®å½•ä¸‹é¢ï¼Œæ³¨æ„å…¶ä¸­é™¤äº†cä»£ç ä¼šè¿›è¡Œè§£æä¹‹å¤–ï¼Œlex.lå’Œparse.yä¹Ÿä¼šè¿›è¡Œåˆæ­¥çš„è§£æã€‚CRCå³cyclic redundancy checkï¼Œç”¨äºé”™è¯¯æ£€æŸ¥ã€‚åªæœ‰å½“å†…å®¹ä¿æŒä¸å˜çš„æ—¶å€™ï¼ŒCRCæ‰ä¼šä¿æŒä¸å˜ã€‚å†…æ ¸æ¨¡å—ä¸»è¦å¯¹å¯¼å‡ºçš„ç¬¦å·ï¼ˆEXPORT_SYMBOLï¼‰åšæ£€æŸ¥ï¼Œè¦æ±‚ä¿æŒä¸¤ä¸ªä¸€è‡´æ€§ï¼š</p><ol><li>æ¥å£ä¸€è‡´ï¼šå˜é‡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›å€¼ç±»å‹åæ²¡æœ‰å˜åŒ–ï¼Œè‹¥æ˜¯ç»“æ„ä½“ï¼Œå…¶å†…éƒ¨æ‰€æœ‰æˆå‘˜ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼›</li><li>è¯­ä¹‰ä¸€è‡´ï¼šç»“æ„ä½“æˆå‘˜å˜é‡åä¸èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå‡½æ•°å‚æ•°åæ— éœ€ä¿æŒä¸€è‡´ã€‚</li></ol><h3 id="CRCåŸºæœ¬å‡½æ•°"><a href="#CRCåŸºæœ¬å‡½æ•°" class="headerlink" title="CRCåŸºæœ¬å‡½æ•°"></a>CRCåŸºæœ¬å‡½æ•°</h3><p>linuxé¢„å…ˆå®šä¹‰äº†256ä¸ªï¼ˆ0xffï¼‰crctabï¼Œå³ç”¨äºå¼‚æˆ–æ“ä½œçš„åŸºï¼Œå¹¶ä»¥32ä½ä¸ºå•ä½æ¥åšCRCæ“ä½œï¼Œç›¸å…³å†…æ ¸æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">partial_crc32_one</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> crc)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> crctab32[(crc ^ c) &amp; <span class="hljs-number">0xff</span>] ^ (crc &gt;&gt; <span class="hljs-number">8</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">partial_crc32</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> crc)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (*s)<br>        crc = partial_crc32_one(*s++, crc);<br>    <span class="hljs-keyword">return</span> crc;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">crc32</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> partial_crc32(s, <span class="hljs-number">0xffffffff</span>) ^ <span class="hljs-number">0xffffffff</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹æ˜¯ä»åˆå§‹å­—ç¬¦å¼€å§‹åˆ°æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²éƒ½ç”¨ç›¸åŒçš„æ“ä½œè®¡ç®—crcå€¼ï¼Œç›´åˆ°å­—ç¬¦ä¸²ç»“æŸï¼Œå¾—åˆ°æœ€ç»ˆçš„CRCå€¼ã€‚</p><p>å¯¹EXPORT_SYMBOLçš„ç¬¦å·è¿›è¡Œcrcè°ƒç”¨å¹¶ä¸ç”±scripts&#x2F;genksyms&#x2F;ä¸­çš„cä»£ç ç›´æ¥å‘èµ·ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æœŸçš„è¯­æ³•ç”Ÿæˆæ—¶ç”±bisonçš„semantic actionså‘èµ·ï¼Œç›¸å…³ç”Ÿæˆè§„åˆ™å¦‚ä¸‹ï¼ˆåœ¨scripts&#x2F;genksyms&#x2F;parse.yï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">export_definition:<br>    EXPORT_SYMBOL_KEYW <span class="hljs-string">&#x27;(&#x27;</span> IDENT <span class="hljs-string">&#x27;)&#x27;</span> <span class="hljs-string">&#x27;;&#x27;</span><br>        &#123; export_symbol((*$<span class="hljs-number">3</span>)-&gt;<span class="hljs-built_in">string</span>); $$ = $<span class="hljs-number">5</span>; &#125;<br>    ;<br></code></pre></td></tr></table></figure><p>å³ç¢°åˆ°EXPROT_SYMBOLå…³é”®è¯æ—¶ï¼Œè°ƒç”¨genksyms.cé‡Œçš„export_symbolï¼Œç”Ÿæˆcrcå€¼ã€‚</p><h3 id="CRCè®¡ç®—ä¸¾ä¾‹"><a href="#CRCè®¡ç®—ä¸¾ä¾‹" class="headerlink" title="CRCè®¡ç®—ä¸¾ä¾‹"></a>CRCè®¡ç®—ä¸¾ä¾‹</h3><p><strong>åŸºæœ¬ç±»å‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> abcde;<br>EXPORT_SYMBOL(abcde);<br></code></pre></td></tr></table></figure><p>å¯¹äºç¬¦å·abcdeï¼Œè®¡ç®—è¿‡ç¨‹æ˜¯ï¼š</p><ol><li>partial_crc32(â€œunsignedâ€, 0xffffffff) â‡’ 0xa9df1ba</li><li>partial_crc32_one(â€œ â€œ, 0xa9df1ba) â‡’ 0x10d0e7ab</li><li>partial_crc32(â€œintâ€, 0x10d0e7ab) â‡’ 0xa9d106cd</li><li>partial_crc32_one(â€œ â€œ, 0xa9d106cd) â‡’ 0xde124fc3</li><li>partial_crc32(â€œabcdeâ€, 0xde124fc3) â‡’ 0x2e7e6a97</li><li>partial_crc32_one(â€œ â€œ, 0x2e7e6a97) â‡’ 0x552b5845</li><li>0x552b5845 ^ 0xffffffff â‡’ 0xaad4a7ba</li></ol><p>æœ€ç»ˆï¼Œabcdeçš„crcå€¼å³ä¸º0xaad4a7baï¼Œå¯ä»¥é€šè¿‡Module.symversæŸ¥çœ‹å¾—åˆ°ã€‚</p><p>å¯ä»¥å‘ç°ï¼Œä»¥ä¸Šæ¯æ­¥ç›¸å½“äºæŠŠå˜é‡å£°æ˜çš„æ¯ä¸ªç¬¦å·ä¾æ¬¡è®¡ç®—äº†ä¸€écrc32å€¼ï¼Œä¸”æ¯ä¸ªç¬¦å·è®¡ç®—åï¼Œéƒ½ä¼šä¸ç©ºæ ¼çš„crcå“ˆå¸Œå€¼åšå¼‚æˆ–ï¼Œæœ€åå°†ç»“æœçš„å€¼å–0xffffffffçš„å¼‚æˆ–ï¼Œå³æ˜¯æœ€ç»ˆç¬¦å·çš„crcå€¼ï¼Œå³å¦‚ä¸‹è¿‡ç¨‹ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405234653884.png" alt="image-20230405234653884" style="zoom:80%;"><p>å¦‚æœå˜é‡æ˜¯ä¸ªæ•°ç»„æˆ–è€…æŒ‡é’ˆï¼Œåˆ™å¯¹äºåˆ†å·å‰çš„æ‰€æœ‰ç¬¦å·è¿›è¡Œå¦‚ä¸Šè®¡ç®—ï¼ŒåŒ…æ‹¬æ•°ç»„å¤§å°ç­‰ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„åŸºæœ¬ç±»å‹ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>å˜é‡çš„ç±»å‹å‘ç”Ÿæ”¹å˜</li><li>æ•°ç»„å˜é‡çš„å¤§å°å‘ç”Ÿæ”¹å˜</li></ul><p><strong>å‡½æ•°</strong></p><p>è‹¥å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">test_fun</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">char</span> b)</span>;<br>EXPORT_SYMBOL(test_fun);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆCRCè®¡ç®—å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> -&gt; test_fun -&gt; ( -&gt;<br>    <span class="hljs-type">int</span> -&gt; , -&gt;<br>    <span class="hljs-type">char</span> -&gt; , -&gt;<br>)<br></code></pre></td></tr></table></figure><p>æ­¤å¤„å˜é‡ç±»å‹ä½¿ç”¨åŸºç¡€å˜é‡ä»¥ä¾¿ç†è§£ï¼Œå¦‚æœæ˜¯ç¬¦åˆå˜é‡ï¼Œåˆ™éœ€è¦æŒ‰ç…§éœ€æ±‚å±•å¼€ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„å‡½æ•°ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>å‡½æ•°çš„è¿”å›å€¼ç±»å‹å‘ç”Ÿå˜åŒ–ï¼›</li><li>å‚æ•°çš„ç±»å‹å‘ç”Ÿå˜åŒ–ï¼›</li><li>å‚æ•°åå­—å‘ç”Ÿå˜åŒ–ä¸å½±å“CRCå€¼ã€‚</li></ul><p><strong>ç»“æ„ä½“</strong></p><p>è‹¥å®šä¹‰å¦‚ä¸‹å¤åˆç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_struct</span> &#123;</span><br>        <span class="hljs-type">int</span> a;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> my_int;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">test_struct</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_struct</span> <span class="hljs-title">bb</span>;</span><br>        my_int cc;<br>&#125;;<br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">test_struct</span> *<span class="hljs-title">abcde</span>;</span><br></code></pre></td></tr></table></figure><p>å¯¹äºabcdeï¼Œå…¶ç±»å‹struct test_structåŒ…å«å¦ä¸€ä¸ªç»“æ„ä½“struct my_structå’Œtypedefåçš„å˜é‡ï¼Œåˆ™è®¡ç®—çš„æ—¶å€™ï¼Œéœ€è¦ä¾æ¬¡å¯¹å¦‚ä¸‹å˜é‡è¿›è¡Œè®¡ç®—ï¼š\</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> â†’ <span class="hljs-title">test_struct</span> â†’ &#123;</span> â†’ <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> â†’ <span class="hljs-title">my_struct</span> â†’ &#123;</span> â†’ <br>        <span class="hljs-type">int</span> â†’ a â†’ ; â†’ <br>    &#125; â†’ bb â†’ ; â†’ <br>        <span class="hljs-keyword">typedef</span> â†’ <span class="hljs-type">int</span> â†’ my_int â†’ cc â†’ ; â†’ <br>&#125; â†’ * â†’ abcde<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯å…³äºstructæˆ–è€…typedefåçš„ç±»å‹ï¼Œå…¶ä¸ç›´æ¥åˆ©ç”¨ç±»å‹åæ¥è¿›è¡Œè®¡ç®—ï¼Œè€Œæ˜¯é€’å½’å±•å¼€è¯¥ç±»å‹çš„å®šä¹‰ï¼Œå¯¹å®šä¹‰ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œå†æ¬¡è®¡ç®—ï¼Œæœ€åå¾—å‡ºè®¡ç®—çš„ç»“æœã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtypedefè®¡ç®—ä¸åŸºæœ¬ç±»å‹ç±»ä¼¼ï¼Œä½†æ˜¯structè®¡ç®—æ—¶ï¼Œå…¶ä¸­çš„æ¯ä¸ªå˜é‡åçš„åˆ†å·éƒ½çº³å…¥è®¡ç®—èŒƒå›´ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„ç»“æ„ä½“ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>ç»“æ„ä½“å†…å˜é‡å‘ç”Ÿå˜åŒ–ï¼ŒåŒ…æ‹¬å˜é‡ç±»å‹ã€å˜é‡åå­—ï¼›</li><li>ç»“æ„ä½“å†…æˆå‘˜çš„é¡ºåºå‘ç”Ÿæ”¹å˜</li><li>è‹¥æœ‰typedefï¼Œå…¶å¯¹åº”çš„åå­—æˆ–è€…ç±»å‹å‘ç”Ÿå˜åŒ–ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileä¸­çš„includeå…³é”®å­—</title>
    <link href="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/"/>
    <url>/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileä¸­çš„includeå…³é”®å­—"><a href="#Makefileä¸­çš„includeå…³é”®å­—" class="headerlink" title="Makefileä¸­çš„includeå…³é”®å­—"></a>Makefileä¸­çš„includeå…³é”®å­—</h1><blockquote><p>ğŸª¶ <strong>æ‘˜å½•è‡ª</strong>ï¼š<a href="https://juejin.cn/post/7150700142817968158#heading-2">https://juejin.cn/post/7150700142817968158#heading-2</a></p></blockquote><h2 id="include-çš„æ¦‚å¿µ"><a href="#include-çš„æ¦‚å¿µ" class="headerlink" title="include çš„æ¦‚å¿µ"></a>include çš„æ¦‚å¿µ</h2><p>makefile ä¸­å¯ä»¥ä½¿ç”¨ <code>include</code> æŒ‡ä»¤æ¥åŒ…å«å¦ä¸€ä¸ªæ–‡ä»¶ã€‚ å½“ <code>make</code> è¯†åˆ«åˆ° <code>include</code> æŒ‡ä»¤æ—¶ï¼Œ<u>ä¼šæš‚åœè¯»å…¥å½“å‰çš„ makefile æ–‡ä»¶</u>ï¼Œå¹¶è½¬è€Œè¯»å…¥ <code>include</code> æŒ‡å®šçš„æ–‡ä»¶ï¼Œä¹‹åå†ç»§ç»­è¯»å–æœ¬æ–‡ä»¶çš„å‰©ä½™å†…å®¹ã€‚</p><h2 id="includeçš„ä½¿ç”¨"><a href="#includeçš„ä½¿ç”¨" class="headerlink" title="includeçš„ä½¿ç”¨"></a>includeçš„ä½¿ç”¨</h2><p>æœ¬å°èŠ‚å®éªŒæ¶‰åŠåˆ°çš„æ–‡ä»¶åŒ…æ‹¬ï¼š</p><ul><li>inc_a</li><li>inc_b</li><li>makefile</li></ul><p><code>inc_a</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for makefile</span><br><br>vari_c=<span class="hljs-string">&quot;vari_c from inc_a&quot;</span><br></code></pre></td></tr></table></figure><p><code>makefile</code> æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Make"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_a<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>åœ¨ Terminal ä¸­æ‰§è¡Œ <code>make</code> å‘½ä»¤å¹¶è§‚å¯Ÿè¾“å‡ºç»“æœã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330234842191.png" alt="image-20230330234842191" style="zoom:80%;"><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºæ¥ makefile å·²ç»æˆåŠŸåŒ…å«äº† <code>inc_a</code> æ–‡ä»¶ï¼Œå¹¶ä¸”æ­£ç¡®è·å–åˆ°äº† <code>vari_c</code> å˜é‡ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ <code>include</code> æŒ‡ç¤ºç¬¦æ‰€æŒ‡ç¤ºçš„æ–‡ä»¶åå¯ä»¥æ˜¯ä»»ä½• shell èƒ½å¤Ÿè¯†åˆ«çš„æ–‡ä»¶åï¼Œè¿™è¡¨æ˜ <code>include</code> è¿˜å¯ä»¥æ”¯æŒåŒ…å«é€šé…ç¬¦çš„æ–‡ä»¶åã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„å®éªŒä¸­è¿›è¡ŒéªŒè¯ã€‚</p><p><code>inc_b</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for makefile</span><br><br>vari_d=<span class="hljs-string">&quot;vari_d from inc_b&quot;</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ makefileï¼Œä½¿ç”¨é€šé…ç¬¦åŒæ—¶åŒ…å« <code>inc_a</code> å’Œ <code>inc_b</code> æ–‡ä»¶ã€‚ ä¿®æ”¹åçš„ makefile å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_*<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br>    @echo <span class="hljs-variable">$(vari_d)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼šmakefile ä¸­ä¿®æ”¹äº†ä¸¤å¤„ï¼Œç¬¬ä¸€å¤„æ˜¯ <code>inc_a</code> ä¿®æ”¹ä¸ºäº† <code>inc_*</code>ï¼Œç¬¬äºŒå¤„æ˜¯åœ¨ <code>all</code> ä¸­æ–°å¢äº† <code>@echo $(vari_d)</code> ã€‚å› ä¸ºåœ¨ <code>inc_b</code> ä¸­æˆ‘ä»¬å®šä¹‰äº†å˜é‡ <code>vari_d</code>ï¼Œåœ¨ makefile ä¸­æˆ‘ä»¬éœ€è¦å¯¹å…¶å€¼è¿›è¡Œè¾“å‡ºã€‚</p></blockquote><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤,è¾“å‡ºç»“æœå¦‚å›¾ï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235057222.png" alt="image-20230330235057222" style="zoom:80%;"><p>ç”±æ­¤è¯´æ˜ <code>inc_a</code> ä¸ <code>inc_b</code> éƒ½è¢«åŒ…å«è¿›äº† makefile æ–‡ä»¶ä¸­ã€‚</p><h2 id="include-æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„"><a href="#include-æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„" class="headerlink" title="include æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„"></a>include æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„</h2><p>å½“ include æŒ‡ç¤ºç¬¦åŒ…å«çš„æ–‡ä»¶ä¸åŒ…å«ç»å¯¹è·¯å¾„ï¼Œä¸”åœ¨å½“å‰è·¯å¾„ä¸‹ä¹Ÿæ— æ³•å¯»æ‰¾åˆ°æ—¶ï¼Œmake ä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§å¯»æ‰¾æ–‡ä»¶ï¼š</p><ol><li><code>-I</code> æŒ‡å®šçš„ç›®å½•</li><li><code>/usr/gnu/include</code></li><li><code>/usr/local/include</code></li><li><code>/usr/include</code></li><li>æŒ‡å®š makefile çš„ include è·¯å¾„</li></ol><p>ä¿®æ”¹ <code>makefile</code>ï¼Œä¸å†æŒ‡å®š <code>inc_a</code> å’Œ <code>inc_b</code> çš„ç›¸å¯¹è·¯å¾„ï¼Œæ­¤æ—¶ makefile æ–‡ä»¶çš„å†…å®¹æ˜¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_*<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br>    @echo <span class="hljs-variable">$(vari_d)</span><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>å½“å‰ç›®å½•ç»“æ„ä¸ºï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235800533.png" alt="image-20230330235800533" style="zoom:80%;"><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤ï¼Œè§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¦‚æœå‘ç°æœ‰é”™è¯¯äº§ç”Ÿã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235517959.png" alt="image-20230330235517959" style="zoom:80%;"><p>å¯ä»¥çœ‹åˆ° makefile æ— æ³•æ‰¾åˆ° <code>inc_a</code> å’Œ <code>inc_b</code> æ–‡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>make -I</code> å‘½ä»¤æ¥æŒ‡å®šæœå¯»è·¯å¾„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make -I ./include_demo/<br></code></pre></td></tr></table></figure><p>Terminal è¾“å‡ºç»“æœå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235727451.png" alt="image-20230330235727451" style="zoom:80%;"><p>å‘ç°è¾“å‡ºç»“æœä¾ç„¶æ˜¯é”™è¯¯çš„ã€‚å› ä¸ºä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡º <code>make</code> æ˜¯åœ¨æŸ¥æ‰¾åä¸º <code>inc_*</code> çš„æ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ makefile æ–‡ä»¶ä¸­çš„ <code>include</code> è¡Œã€‚</p><figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs M">include inc_a inc_b<br></code></pre></td></tr></table></figure><p>Terminal çš„è¾“å‡ºç»“æœå¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235905294.png" alt="image-20230330235905294" style="zoom:80%;"><p>è¯´æ˜ç¨‹åºå¾—åˆ°äº†æ­£ç¡®çš„æ‰§è¡Œã€‚</p><blockquote><p>å¯è§ä¸ä½¿ç”¨é€šé…ç¬¦çš„æƒ…å†µä¸‹<code>include</code>é…åˆ<code>-I</code>é€‰é¡¹æ‰èƒ½å¾—åˆ°é¢„æœŸæ•ˆæœã€‚</p></blockquote><h2 id="includeçš„å¤„ç†ç»†èŠ‚"><a href="#includeçš„å¤„ç†ç»†èŠ‚" class="headerlink" title="includeçš„å¤„ç†ç»†èŠ‚"></a>includeçš„å¤„ç†ç»†èŠ‚</h2><p>å‰é¢æåˆ° <code>make</code> è¯»å…¥ makefile æ—¶é‡è§ <code>include</code> æŒ‡ç¤ºç¬¦ä¼šæš‚åœè¯»å…¥å½“å‰æ–‡ä»¶ï¼Œè½¬è€Œè¯»å…¥ <code>include</code> æŒ‡å®šçš„æ–‡ä»¶ï¼Œä¹‹åæ‰ç»§ç»­è¯»å…¥å½“å‰æ–‡ä»¶ã€‚</p><p>makefile æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this makefile is test for include process</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;vari_a @ 1st&quot;</span><br><br><span class="hljs-keyword">include</span> ./include_demo/c_inc<br><br>vari_a += <span class="hljs-string">&quot; @2nd ...&quot;</span><br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>ä» makefile å†…å®¹ä¸Šå¯ä»¥çœ‹å‡º makefile è§„åˆ™çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆå®šä¹‰å˜é‡ <code>vari_a</code>ï¼Œç„¶åå†å¼•å…¥æ–‡ä»¶ <code>c_inc</code>ï¼Œæœ€åä¿®æ”¹å˜é‡ <code>vari_a</code>ã€‚</p><p><code>c_inc</code> æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for include process</span><br><br>vari_a=<span class="hljs-string">&quot;vari_a from c_inc&quot;</span><br></code></pre></td></tr></table></figure><p>ä»ä¸­å¯ä»¥çœ‹å‡ºåœ¨ <code>c_inc</code> æ–‡ä»¶ä¸­ä¹Ÿå¯¹ <code>vari_a</code> å˜é‡è¿›è¡Œäº†å®šä¹‰ã€‚</p><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤è§‚å¯Ÿè¾“å‡ºç»“æœã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230331000240966.png" alt="image-20230331000240966" style="zoom:80%;"><p>è¿™è¯´æ˜ <code>vari_a</code> åœ¨ <code>include</code> è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹äº†ï¼Œå¹¶ä¸”åœ¨å…¶åæ·»åŠ äº†å­—ç¬¦ä¸² <code>@2nd ...</code>ï¼Œç»“æœä¸é¢„æœŸä¸­ <code>make</code> å¤„ç† <code>include</code> æŒ‡ç¤ºç¬¦çš„è¡Œä¸ºä¸€è‡´</p>]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileçš„æ‰§è¡Œé¡ºåº</title>
    <link href="/2023/03/30/Makefile%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/"/>
    <url>/2023/03/30/Makefile%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileçš„æ‰§è¡Œé¡ºåº"><a href="#Makefileçš„æ‰§è¡Œé¡ºåº" class="headerlink" title="Makefileçš„æ‰§è¡Œé¡ºåº"></a>Makefileçš„æ‰§è¡Œé¡ºåº</h1><blockquote><p>ğŸª¶ æ‘˜å½•è‡ªï¼š<a href="https://blog.csdn.net/qq_35524916/article/details/77131555?spm=1001.2014.3001.5506">https://blog.csdn.net/qq_35524916/article/details/77131555?spm=1001.2014.3001.5506</a></p></blockquote><p><strong>åœ¨linuxä¸‹ï¼Œmakefileçš„æ‰§è¡Œå®é™…ä¸Šåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µè¿›è¡Œ</strong></p><ul><li>ç¬¬ä¸€é˜¶æ®µï¼šè¯»å–æ‰€æœ‰çš„makefileæ–‡ä»¶ï¼ˆåŒ…æ‹¬â€œMAKEFILESâ€å˜é‡æŒ‡å®šçš„ã€æŒ‡ç¤ºç¬¦â€œincludeâ€æŒ‡å®šçš„ã€ä»¥åŠå‘½ä»¤è¡Œé€‰é¡¹â€œ-fï¼ˆâ€“fileï¼‰â€æŒ‡å®šçš„makefileæ–‡ä»¶ï¼‰ï¼Œå†…å»ºçš„å˜é‡ã€æ˜ç¡®è§„åˆ™å’Œéšå«è§„åˆ™ï¼Œå¹¶å»ºç«‹æ‰€æœ‰ç›®æ ‡å’Œä¾èµ–ä¹‹é—´çš„ä¾èµ–å…³ç³»ç»“æ„é“¾è¡¨ã€‚</li><li>ç¬¬äºŒé˜¶æ®µï¼šæ ¹æ®ç¬¬ä¸€é˜¶æ®µå·²ç»å»ºç«‹çš„ä¾èµ–å…³ç³»ç»“æ„é“¾è¡¨å†³å®šå“ªäº›ç›®æ ‡éœ€è¦æ›´æ–°ï¼Œå¹¶ä½¿ç”¨å¯¹åº”çš„è§„åˆ™æ¥é‡å»ºè¿™äº›ç›®æ ‡ã€‚</li></ul><p><strong>makeçš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</strong></p><ol><li>ä¾æ¬¡è¯»å–å˜é‡â€œMAKEFILESâ€å®šä¹‰çš„makefileæ–‡ä»¶åˆ—è¡¨</li><li>è¯»å–å·¥ä½œç›®å½•ä¸‹çš„makefileæ–‡ä»¶ï¼ˆç¼ºçœçš„æ˜¯æ ¹æ®å‘½åçš„æŸ¥æ‰¾é¡ºåºâ€œGNUmakefileâ€ï¼Œâ€œmakefileâ€ï¼Œâ€œMakefileâ€ï¼Œé¦–å…ˆæ‰¾åˆ°é‚£ä¸ªå°±è¯»å–é‚£ä¸ªï¼‰</li><li>ä¾æ¬¡è¯»å–å·¥ä½œç›®å½•makefileæ–‡ä»¶ä¸­ä½¿ç”¨æŒ‡ç¤ºç¬¦â€œincludeâ€åŒ…å«çš„æ–‡ä»¶</li><li>æŸ¥æ‰¾é‡å»ºæ‰€æœ‰å·²è¯»å–çš„makefileæ–‡ä»¶çš„è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ä¸€ä¸ªç›®æ ‡æ˜¯å½“å‰è¯»å–çš„æŸä¸€ä¸ªmakefileæ–‡ä»¶ï¼Œåˆ™æ‰§è¡Œæ­¤è§„åˆ™é‡å»ºæ­¤makefileæ–‡ä»¶ï¼Œå®Œæˆä»¥åä»ç¬¬ä¸€æ­¥å¼€å§‹é‡æ–°æ‰§è¡Œï¼‰</li><li>åˆå§‹åŒ–å˜é‡å€¼å¹¶å±•å¼€é‚£äº›éœ€è¦ç«‹å³å±•å¼€çš„å˜é‡å’Œå‡½æ•°å¹¶æ ¹æ®é¢„è®¾æ¡ä»¶ç¡®å®šæ‰§è¡Œåˆ†æ”¯</li><li>æ ¹æ®â€œç»ˆæç›®æ ‡â€ä»¥åŠå…¶ä»–ç›®æ ‡çš„ä¾èµ–å…³ç³»å»ºç«‹ä¾èµ–å…³ç³»é“¾è¡¨</li><li>æ‰§è¡Œé™¤â€œç»ˆæç›®æ ‡â€ä»¥å¤–çš„æ‰€æœ‰çš„ç›®æ ‡çš„è§„åˆ™ï¼ˆè§„åˆ™ä¸­å¦‚æœä¾èµ–æ–‡ä»¶ä¸­ä»»ä¸€ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³æ¯”ç›®æ ‡æ–‡ä»¶æ–°ï¼Œåˆ™ä½¿ç”¨è§„åˆ™æ‰€å®šä¹‰çš„å‘½ä»¤é‡å»ºç›®æ ‡æ–‡ä»¶ï¼‰</li><li>æ‰§è¡Œâ€œç»ˆæç›®æ ‡â€æ‰€åœ¨çš„è§„åˆ™</li></ol>]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileä¸­çš„shellå‡½æ•°</title>
    <link href="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/"/>
    <url>/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileä¸­çš„shellå‡½æ•°"><a href="#Makefileä¸­çš„shellå‡½æ•°" class="headerlink" title="Makefileä¸­çš„shellå‡½æ•°"></a>Makefileä¸­çš„shellå‡½æ•°</h1><p>shellå‡½æ•°ä¸åŒäºé™¤â€œwildcardâ€å‡½æ•°ä¹‹å¤–çš„å…¶å®ƒå‡½æ•°ã€‚makeå¯ä»¥ä½¿ç”¨å®ƒæ¥å’Œå¤–éƒ¨é€šä¿¡ã€‚</p><p>å‡½æ•°åŠŸèƒ½ï¼šå‡½æ•°â€œshellâ€æ‰€å®ç°çš„åŠŸèƒ½å’Œshellä¸­çš„å¼•ç”¨ï¼ˆ&#96;&#96;ï¼‰ç›¸åŒï¼Œå®ç°å¯¹å‘½ä»¤çš„æ‰©å±•ã€‚è¿™å°±æ„å‘³ç€éœ€è¦ä¸€ä¸ªshell å‘½ä»¤ä½œä¸ºæ­¤å‡½æ•°çš„å‚æ•°ï¼Œå‡½æ•°çš„è¿”å›ç»“æœæ˜¯æ­¤å‘½ä»¤åœ¨shellä¸­çš„æ‰§è¡Œç»“æœã€‚makeä»…ä»…å¯¹å®ƒçš„è¿”å›ç»“æœè¿›è¡Œå¤„ç†ï¼›makeå°†å‡½æ•°è¿”å›ç»“æœä¸­çš„æ‰€æœ‰æ¢è¡Œç¬¦ï¼ˆâ€œ\nâ€ï¼‰æˆ–è€…ä¸€å¯¹â€œ\n\râ€æ›¿æ¢ä¸ºå•ç©ºæ ¼ï¼›å¹¶å»æ‰æœ«å°¾çš„å›è½¦ç¬¦å·ï¼ˆâ€œ\nâ€ï¼‰æˆ–è€…â€œ\n\râ€ã€‚è¿›è¡Œå‡½æ•°å±•å¼€å¼æ—¶ï¼Œå®ƒæ‰€è°ƒç”¨çš„å‘½ä»¤ï¼ˆå®ƒçš„å‚æ•°ï¼‰å¾—åˆ°æ‰§è¡Œã€‚é™¤å¯¹å®ƒçš„å¼•ç”¨å‡ºç°åœ¨è§„åˆ™çš„å‘½ä»¤è¡Œå’Œé€’å½’å˜é‡çš„å®šä¹‰ä¸­ä»¥å¤–ï¼Œå…¶å®ƒå†³å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œmakeæ˜¯åœ¨è¯»å–è§£æMakefileæ—¶å®Œæˆå¯¹å‡½æ•°shellçš„å±•å¼€ã€‚</p><p>ğŸ¤º <strong>è¿”å›å€¼</strong>ï¼šå‡½æ•°â€œshellâ€çš„å‚æ•°ï¼ˆä¸€ä¸ªshellå‘½ä»¤ï¼‰åœ¨<strong>shellç¯å¢ƒä¸­çš„æ‰§è¡Œç»“æœ</strong>ã€‚</p><p>å‡½æ•°è¯´æ˜ï¼šæ³¨æ„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ–°ç”Ÿæˆä¸€ä¸ª Shell ç¨‹åºæ¥æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥ä½ è¦æ³¨æ„å…¶è¿è¡Œæ€§èƒ½ï¼Œå¦‚æœä½ çš„ Makefile ä¸­æœ‰ä¸€äº›æ¯”è¾ƒå¤æ‚çš„è§„åˆ™ï¼Œå¹¶å¤§é‡ä½¿ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå¯¹äºä½ çš„ç³»ç»Ÿæ€§èƒ½æ˜¯æœ‰å®³çš„ã€‚ç‰¹åˆ«æ˜¯ Makefile çš„éšæ™¦çš„è§„åˆ™å¯èƒ½ä¼šè®©ä½ çš„ shell å‡½æ•°æ‰§è¡Œçš„æ¬¡æ•°æ¯”ä½ æƒ³åƒçš„å¤šå¾—å¤šã€‚</p><p>ğŸ¼ <strong>ç¤ºä¾‹1ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> cat foo.txt)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">foo.txt</span><br>hello amx!<br>I love codiing.<br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222716788.png" alt="image-20230329222716788" style="zoom:80%;"><blockquote><p>å°†æ¢è¡Œç¬¦å½“åšç©ºæ ¼è¿›è¡Œè¿æ¥</p></blockquote><p>ğŸ¼ <strong>ç¤ºä¾‹2ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> echo *.c)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222846872.png" alt="image-20230329222846872" style="zoom:90%;"><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222921766.png" alt="image-20230329222921766" style="zoom:80%;"><p>ğŸ¼ <strong>ç¤ºä¾‹3ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> sh test.sh hello)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>test.sh</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>name=&quot;amx&quot;<br>echo $&#123;name&#125;<br>echo $0<br>echo $1<br>echo &quot;ChatGpt4.0&quot;<br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329224038930.png" alt="image-20230329224038930" style="zoom:90%;">]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kernelä¸­__attribute__å±æ€§</title>
    <link href="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/"/>
    <url>/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="kernelä¸­-attribute-å±æ€§"><a href="#kernelä¸­-attribute-å±æ€§" class="headerlink" title="kernelä¸­__attribute__å±æ€§"></a>kernelä¸­__attribute__å±æ€§</h1><blockquote><p>ğŸ§ <strong>å‚è€ƒ</strong>ï¼š<a href="https://www.eet-china.com/mp/a192020.html">https://www.eet-china.com/mp/a192020.html</a></p></blockquote><h2 id="1-å®éªŒç¨‹åº"><a href="#1-å®éªŒç¨‹åº" class="headerlink" title="1.å®éªŒç¨‹åº"></a>1.å®éªŒç¨‹åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((constructor)) beforeMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Before main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Main!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œï¼š<code>gcc test.c -o test</code></p><p>è¾“å‡ºç»“æœï¼š</p><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328225545088.png" alt="image-20230328225545088" style="zoom:80%;"><blockquote><p>ä¸ºä»€ä¹ˆæœ€å¼€å§‹æ‰§è¡Œçš„ä¸æ˜¯mainå‡½æ•°ï¼Ÿæ€ä¹ˆå’Œæˆ‘ä»¬åˆšå¼€å§‹å­¦ä¹ Cç¨‹åºæ—¶è¯´çš„ä¸ä¸€æ ·å‘¢ï¼Ÿä»è¿è¡Œç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥beforeMainæ˜¯åœ¨è¿›å…¥mainå‡½æ•°ä¹‹å‰è¢«è°ƒç”¨çš„ï¼Œè¿™å¯¹äºCè¯­è¨€çš„åˆå­¦è€…æ¥è¯´ä¼¼ä¹æœ‰ç‚¹éš¾ä»¥ç†è§£ã€‚ç©¶ç«Ÿæ˜¯è°è°ƒç”¨çš„beforeMainå‘¢ï¼Ÿæ€ä¹ˆè¿˜æ²¡æœ‰è¿›å…¥mainå°±å¯ä»¥æœ‰ä»£ç è¢«æ‰§è¡Œå‘¢ï¼Ÿ</p></blockquote><p>å¸¦ç€ä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç”¨-vå‚æ•°æ¥æ˜¾ç¤ºç¼–è¯‘è¿‡ç¨‹è¾“å‡ºç»“æœ<code>gcc test.c -o test -v</code>ï¼šï¼Œå…¶ä¸­è¾“å‡ºéƒ¨åˆ†å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/<br>LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../:/lib/:/usr/lib/<br>COLLECT_GCC_OPTIONS=&#x27;-o&#x27; &#x27;test&#x27; &#x27;-v&#x27; &#x27;-mtune=generic&#x27; &#x27;-march=x86-64&#x27;<br> /usr/lib/gcc/x86_64-linux-gnu/8/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/8/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper -plugin-opt=-fresolution=/tmp/ccxW7QBR.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crt1.o /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/8/crtbegin.o -L/usr/lib/gcc/x86_64-linux-gnu/8 -L/usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/8/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/8/../../.. /tmp/ccboZUZT.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/8/crtend.o /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crtn.o<br>COLLECT_GCC_OPTIONS=&#x27;-o&#x27; &#x27;test&#x27; &#x27;-v&#x27; &#x27;-mtune=generic&#x27; &#x27;-march=x86-64&#x27;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328225732402.png" alt="image-20230328225732402" style="zoom:100%;"><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œåœ¨é“¾æ¥ç”Ÿæˆæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œæœ‰å¾ˆå¤šçš„Cåº“äºŒè¿›åˆ¶æ–‡ä»¶å‚ä¸è¿›æ¥ã€‚è€Œæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶é™¤äº†æˆ‘ä»¬ç¼–å†™çš„è¿™ä¸ªç®€å•çš„Cä»£ç ä»¥å¤–ï¼Œè¿˜æœ‰å¤§é‡çš„Cåº“æ–‡ä»¶å‚ä¸äº†é“¾æ¥ï¼Œå¹¶åŒ…å«åœ¨äº†æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚è¿™ä¸ªé“¾æ¥çš„è¿‡ç¨‹ï¼Œæ˜¯ç”±é“¾æ¥å™¨ldçš„é“¾æ¥è„šæœ¬æ¥å†³å®šçš„ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šé“¾æ¥è„šæœ¬ï¼Œä¼šé»˜è®¤ä½¿ç”¨ldçš„é»˜è®¤è„šæœ¬ã€‚</p><p>é€šè¿‡<strong>ld -verbose</strong>å‘½ä»¤æ¥æŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">using internal linker script:<br>==================================================<br>/* Script for -z combreloc -z separate-code: combine and sort reloc sections with separate code segment */<br>/* Copyright (C) 2014-2018 Free Software Foundation, Inc.<br>   Copying and distribution of this script, with or without modification,<br>   are permitted in any medium without royalty provided the copyright<br>   notice and this notice are preserved.  */<br>OUTPUT_FORMAT(&quot;elf64-x86-64&quot;, &quot;elf64-x86-64&quot;,<br>              &quot;elf64-x86-64&quot;)<br>OUTPUT_ARCH(i386:x86-64)<br>ENTRY(_start)<br>SEARCH_DIR(&quot;=/usr/local/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu64&quot;); SEARCH_DIR(&quot;=/usr/local/lib64&quot;); SEARCH_DIR(&quot;=/lib64&quot;); SEARCH_DIR(&quot;=/usr/lib64&quot;); SEARCH_DIR(&quot;=/usr/local/lib&quot;); SEARCH_DIR(&quot;=/lib&quot;); SEARCH_DIR(&quot;=/usr/lib&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib64&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib&quot;);<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢è¾“å‡ºå¯ä»¥çœ‹å‡ºè¿™é‡Œå®šä¹‰äº†è¾“å‡ºçš„æ–‡ä»¶æ ¼å¼ã€ç›®æ ‡æœºå™¨çš„ç±»å‹ï¼Œä»¥åŠé‡è¦çš„ä¿¡æ¯å’Œç¨‹åºçš„å…¥å£ENTRYï¼ˆ_startï¼‰ã€‚</p><blockquote><p>æˆ‘ä»¬çš„ä¾‹å­ä¸­beforeMainå‡½æ•°ä½¿ç”¨çš„gccæ‰©å±•å±æ€§<code>__attribute__ï¼ˆï¼ˆconstructorï¼‰ï¼‰</code>å°±æ˜¯å°†å‡½æ•°å¯¹åº”çš„æŒ‡ä»¤å½’å±äº.ctors sectionéƒ¨åˆ†ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">.ctors          :<br>&#123;<br>  /* gcc uses crtbegin.o to find the start of<br>     the constructors, so we make sure it is<br>     first.  Because this is a wildcard, it<br>     doesn&#x27;t matter if the user does not<br>     actually link against crtbegin.o; the<br>     linker won&#x27;t look for a file to match a<br>     wildcard.  The wildcard also means that it<br>     doesn&#x27;t matter which directory crtbegin.o<br>     is in.  */<br>  KEEP (*crtbegin.o(.ctors))<br>  KEEP (*crtbegin?.o(.ctors))<br>  /* We don&#x27;t want to include the .ctor section from<br>     the crtend.o file until after the sorted ctors.<br>     The .ctor section from the crtend file contains the<br>     end of ctors marker and it must be last */<br>  KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .ctors))<br>  KEEP (*(SORT(.ctors.*)))<br>  KEEP (*(.ctors))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-attribute-constructor-å±æ€§"><a href="#2-attribute-constructor-å±æ€§" class="headerlink" title="2._attribute_((constructor))å±æ€§"></a>2._<em>attribute</em>_((constructor))å±æ€§</h2><blockquote><p>The constructor attribute causes the function to be called automatically before execution enters main (). æ„é€ å‡½æ•°å±æ€§ä½¿å‡½æ•°åœ¨æ‰§è¡Œè¿›å…¥mainï¼ˆï¼‰ä¹‹å‰è‡ªåŠ¨è¢«è°ƒç”¨</p></blockquote><p>GNU Cçš„ä¸€å¤§ç‰¹è‰²å°±æ˜¯<code>__attribute__</code>æœºåˆ¶ã€‚<code>__attribute__</code>å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§ï¼ˆFunction Attribute ï¼‰ã€å˜é‡å±æ€§ï¼ˆVariable Attribute ï¼‰å’Œç±»å‹å±æ€§ï¼ˆType Attribute ï¼‰ã€‚<code>__attribute__</code>å†™æ³•æ˜¯<code>__attribute__</code>å‰åéƒ½æœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”åé¢ä¼šç´§è·Ÿä¸€å¯¹åŸæ‹¬å¼§ï¼Œæ‹¬å¼§é‡Œé¢æ˜¯ç›¸åº”çš„<code>__attribute__</code>å‚æ•°ã€‚<code>__attribute__</code>æ ¼å¼ä¸º<code>__attribute__((attribute-list))</code></p><p>å°±æ˜¯æŒ‡åœ¨å‡½æ•°ä¸Šæ–¹åŠ ä¸Š<code>__attribute__((constructor))</code>å¯ä»¥è®©è¿™ä¸ªå‡½æ•°åœ¨mainå‡½æ•°æ‰§è¡Œå‰è¿è¡Œ</p><p><strong>ä½œç”¨ï¼š<code>__attribute__((constructor))</code>å¯ä»¥æå‰åˆå§‹åŒ–ä¸€äº›åœ¨mainå‡½æ•°ä¸­ç”¨åˆ°çš„ä¸œè¥¿ï¼Œä¾¿äºæˆ‘ä»¬åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚</strong></p><p><strong>å¸¦æœ‰ä¼˜å…ˆçº§çš„å‚æ•°</strong></p><p>æˆ‘ä»¬è¿˜å¯ä»¥ç»™å±æ€§è®¾ç½®ä¼˜å…ˆçº§ï¼Œçœ‹ä¸‹é¢ç¤ºä¾‹ä»£ç :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span><br><br>static void __attribute__ ((constructor(101))) beforeMain1(void)<br>&#123;<br>    printf(&quot;Before main...1\n&quot;);<br>&#125;<br>static void __attribute__ ((constructor(102))) beforeMain2(void)<br>&#123;<br>    printf(&quot;Before main...2\n&quot;);<br>&#125;<br>static void __attribute__ ((constructor(103))) beforeMain3(void)<br>&#123;<br>    printf(&quot;Before main...3\n&quot;);<br>&#125;<br><br>int main(void)<br>&#123;<br>    printf(&quot;Main!\n&quot;);<br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328230224517.png" alt="image-20230328230224517" style="zoom:100%;"><h2 id="3-attribute-destructor-å±æ€§"><a href="#3-attribute-destructor-å±æ€§" class="headerlink" title="3._attribute_((destructor))å±æ€§"></a>3._<em>attribute</em>_((destructor))å±æ€§</h2><p>æŸ¥é˜…äº†GNUçš„æ–‡æ¡£ä½ è¿˜ä¼šå‘ç°æœ‰æåŠè¿™ä¹ˆä¸€ä¸ªå†™æ³•<code>__attribute__((destructor))</code>ï¼Œæ–‡æ¡£ä¸­å…³äºè¿™ä¸¤ä¸ªç”¨æ³•çš„è¯´æ˜å¦‚ä¸‹:</p><blockquote><p>The constructor attribute causes the function to be called automatically before execution enters main (). Similarly, the destructor attribute causes the function to be called automatically after main () completes or exit () is called. Functions with these attributes are useful for initializing data that is used implicitly during the execution of the program.</p></blockquote><blockquote><p>åŒç†, destructorè®©ç³»ç»Ÿåœ¨main()å‡½æ•°é€€å‡ºæˆ–è€…è°ƒç”¨äº†exit()ä¹‹å,è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((constructor)) beforeMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Before main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((destructor)) afterMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Main!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328230504826.png" alt="image-20230328230504826" style="zoom:100%;"><h2 id="4-å°ç»“"><a href="#4-å°ç»“" class="headerlink" title="4.å°ç»“"></a>4.å°ç»“</h2><p>Cç¨‹åºä¸­<code>__attribute__ ((constructor))</code>å’Œ<code>__attribute__ ((destructor))</code>ç±»ä¼¼äºC++ç±»ä¸­æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚åœ¨mainå‡½æ•°ä¹‹å‰ï¼Œæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œä¾¿äºæˆ‘ä»¬åšä¸€äº›å‡†å¤‡å·¥ä½œï¼›åœ¨main()å‡½æ•°é€€å‡ºæˆ–è€…è°ƒç”¨äº†exit()ä¹‹åè°ƒç”¨ã€‚å¤šä¸ªå‡½æ•°æ—¶ï¼ŒGCCä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‚æ•°å«ä¼˜å…ˆçº§ï¼ŒconstructoræŒ‰ä»å°åˆ°å¤§ï¼Œdestructorå‡½æ•°ç›¸å<code> void __attribute__((constructor(5)) initFunction1(void); void __attribute__((constructor(10)) initFunction2(void);</code></p><h2 id="5-attributeç”¨äºåŠ è½½åŠ¨æ€åº“"><a href="#5-attributeç”¨äºåŠ è½½åŠ¨æ€åº“" class="headerlink" title="5.attributeç”¨äºåŠ è½½åŠ¨æ€åº“"></a>5.attributeç”¨äºåŠ è½½åŠ¨æ€åº“</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">Shared objects may <span class="hljs-keyword">export</span> functions using the<br><br>__attribute__((constructor)) and __attribute__((destructor))<br>function attributes.  Constructor functions are executed before<br>dlopen() returns, and destructor functions are executed before<br>dlclose() returns.  A shared object may <span class="hljs-keyword">export</span> multiple<br>constructors and destructors, and priorities can be associated<br>with each function to determine the order in which they are<br>executed.  See the gcc info pages (under <span class="hljs-string">&quot;Function attributes&quot;</span>)<br>for further information.<br></code></pre></td></tr></table></figure><p>å‡½æ•°è®¾ç½®__attribute__((constructor))å±æ€§ï¼Œåœ¨dlopenæ—¶ï¼Œä¼šå…ˆè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p>è®¾ç½®__attribute__((destructor))å±æ€§ï¼Œåœ¨dlcloseæ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p>å®éªŒç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>__attribute__((constructor)) <span class="hljs-type">void</span> <span class="hljs-title function_">test_init</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world\n&quot;</span>);<br>&#125;<br><br>__attribute__((destructor)) <span class="hljs-type">void</span> <span class="hljs-title function_">test_fini</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bye world\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;test\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc -fPIC -shared test.c -o  libtest.so<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// main.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span><span class="hljs-params">(*testFunc)</span><span class="hljs-params">()</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">void</span> *handle = dlopen(<span class="hljs-string">&quot;./libtest.so&quot;</span>, RTLD_LAZY);<br>    <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;handle is null, %s\n&quot;</span>, dlerror());<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------\n&quot;</span>);<br>    testFunc f = (testFunc)dlsym(handle, <span class="hljs-string">&quot;test&quot;</span>);<br>    <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;f is null\n&quot;</span>);<br>    &#125;<br><br>    f();<br>    dlclose(handle);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc main.c -ldl -O0 -g -o main<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328234128499.png" alt="image-20230328234128499" style="zoom:100%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start</title>
    <link href="/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/"/>
    <url>/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“initè¿›ç¨‹ç³»åˆ—-1-ctl-interface-start"><a href="#å®‰å“initè¿›ç¨‹ç³»åˆ—-1-ctl-interface-start" class="headerlink" title="å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start"></a>å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start</h1><blockquote><p>ğŸ¤– <strong>èƒŒæ™¯</strong>ï¼šä¸ºä»€ä¹ˆä¼šæœ‰ctl.interface_startè¿™ä¸ªå±æ€§ï¼Œå› ä¸ºå®‰å“æœ‰äº†åŠ¨æ€HALçš„æ¦‚å¿µï¼Œå…·ä½“å¯ä»¥å‚è§æˆ‘çš„å¦å¤–ä¸€ç¯‡<a href="https://anmuxixixi.github.io/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/">åšå®¢</a></p></blockquote><h2 id="1-å“ªé‡Œä¼šå»è°ƒç”¨ctl-interface-start"><a href="#1-å“ªé‡Œä¼šå»è°ƒç”¨ctl-interface-start" class="headerlink" title="1.å“ªé‡Œä¼šå»è°ƒç”¨ctl.interface_start"></a>1.å“ªé‡Œä¼šå»è°ƒç”¨ctl.interface_start</h2><p>ä¸ºä»€ä¹ˆä¸€ç›´å¼ºè°ƒèƒŒæ™¯çš„é‡è¦æ€§ï¼Œå¦‚æœè„±ç¦»çš„èƒŒæ™¯ï¼Œçœ‹ä»£ç çš„å®ç°æ˜¯ç—›è‹¦çš„ï¼Œæ˜¯æ¢¦æ¸¸çš„ï¼Œæ˜¯æ— ç”¨åŠŸğŸ–</p><p>å°±å¥½æ¯”è¿™é‡Œï¼Œå¦‚æœä¸çŸ¥é“ctl.interface_startå‡ºç°çš„èƒŒæ™¯ï¼Œå°±ä¸çŸ¥é“å“ªé‡Œè°ƒç”¨äº†<code>ctl.interface_start</code>ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåœ¨æŸä¸€ä¸ªAndroidç‰ˆæœ¬é‡Œé¢çªç„¶å‡ºç°äº†å®ƒã€‚</p><p>å¥½äº†ï¼Œä»èƒŒæ™¯æ¥çœ‹æ˜¯ä¸ºäº†å®ç°HALçš„åŠ¨æ€å¯åŠ¨ï¼Œæ¯”å¦‚WIFIæˆ‘ä»¬ä¸ç”¨çš„æ—¶å€™ï¼ŒWIFIç›¸åº”çš„HALéœ€è¦è‡ªåŠ¨å…³é—­ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªHALçš„åŠ¨æ€å¯åŠ¨ï¼Œç”¨çš„æ—¶å€™å¼€ï¼Œæœ€å¤§ç¨‹åº¦çš„èŠ‚çœç³»ç»Ÿèµ„æºã€‚</p><blockquote><p>ğŸ¨ <strong>å£°æ˜</strong>ï¼šé‚£æˆ‘ä»¬ä»¥CameraHALä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æï¼ã€æœ¬äººä¸æ˜¯ä¸“ä¸šæCameraçš„ï¼Œæ•…å‚è€ƒ<a href="https://blog.csdn.net/liujun3512159/article/details/124702217%E3%80%91">https://blog.csdn.net/liujun3512159/article/details/124702217ã€‘</a></p><p>å¦å¤–ï¼Œå…³äºHALçš„å¯åŠ¨æµç¨‹ï¼Œæˆ‘ä¹Ÿä¼šå†™ä¸€ç¯‡è¯¦å°½çš„åšå®¢ä¾›è‡ªå·±å¤ä¹ å’Œå¤§å®¶å‚è€ƒï¼</p></blockquote><p>clientéœ€è¦è·å–halæœåŠ¡ï¼Œä¸€èˆ¬éƒ½ä¼šè°ƒç”¨servicemanagerå»getservice</p><img src="/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/image-20230324225335198-1679669618537-1-1679669619970-3.png" alt="image-20230324225335198" style="zoom:80%;"><p>å½“clientå‘hwservicemanagerè·å–æœåŠ¡çš„æ—¶å€™ï¼Œå‘ç°æ‰¾ä¸åˆ°è¯¥æœåŠ¡ï¼Œé‚£ä¹ˆä¼šå»è°ƒç”¨<strong>tryStartService</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\hwservicemanager\ServiceManager.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">tryStartService</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; fqName, <span class="hljs-type">const</span> std::string&amp; name)</span> </span>&#123;<br>    <span class="hljs-keyword">using</span> ::android::base::SetProperty;<br><br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Since &quot;</span> &lt;&lt; fqName &lt;&lt; <span class="hljs-string">&quot;/&quot;</span> &lt;&lt; name<br>              &lt;&lt; <span class="hljs-string">&quot; is not registered, trying to start it as a lazy HAL.&quot;</span>;<br><br>    std::<span class="hljs-built_in">thread</span>([=] &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">&quot;ctl.interface_start&quot;</span>, fqName + <span class="hljs-string">&quot;/&quot;</span> + name)) &#123;<br>            <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Tried to start &quot;</span> &lt;&lt; fqName &lt;&lt; <span class="hljs-string">&quot;/&quot;</span> &lt;&lt; name<br>                      &lt;&lt; <span class="hljs-string">&quot; as a lazy service, but was unable to. Usually this happens when a &quot;</span><br>                         <span class="hljs-string">&quot;service is not installed, but if the service is intended to be used as a &quot;</span><br>                         <span class="hljs-string">&quot;lazy service, then it may be configured incorrectly.&quot;</span>;<br>        &#125;<br>    &#125;).<span class="hljs-built_in">detach</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è®¾ç½®å±æ€§å€¼ï¼Œkeyä¸º<code>ctl.interface_start</code>ï¼Œvalueä¸º<code>fqName + &quot;/&quot; + name</code>ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“initè¿›è¡Œæ•è·åˆ°ç³»ç»Ÿå±æ€§å€¼å˜åŒ–ä»¥åä¼šè°ƒç”¨<strong>HandlePropertySet</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">HandlePropertySet</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; value,</span></span><br><span class="hljs-params"><span class="hljs-function">                           <span class="hljs-type">const</span> std::string&amp; source_context, <span class="hljs-type">const</span> ucred&amp; cr,</span></span><br><span class="hljs-params"><span class="hljs-function">                           SocketConnection* socket, std::string* error)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">&quot;ctl.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">SendControlMessage</span>(name.<span class="hljs-built_in">c_str</span>() + <span class="hljs-number">4</span>, value, cr.pid, socket, error);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“å±æ€§å€¼ä»¥ctl.å¼€å¤´ï¼Œè°ƒç”¨SendControlMessage</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\property_service.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> <span class="hljs-title">SendControlMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">pid_t</span> pid,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   SocketConnection* socket, std::string* error)</span> </span>&#123;<br>    <span class="hljs-comment">// è°ƒç”¨QueueControlMessage</span><br>    <span class="hljs-type">bool</span> queue_success = <span class="hljs-built_in">QueueControlMessage</span>(msg, name, pid, fd);<br><br>    <span class="hljs-keyword">return</span> PROP_SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">QueueControlMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message, <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">pid_t</span> pid, <span class="hljs-type">int</span> fd)</span> </span>&#123;<br>    pending_control_messages.<span class="hljs-built_in">push</span>(&#123;message, name, pid, fd&#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¾€<code>pending_control_messages</code>æ”¾äº†<code>message, name, pid, fd</code>è¿™äº›é‡è¦çš„ä¿¡æ¯ï¼ï¼ï¼</p><p>æŒ‰ç…§initçš„è®¾è®¡æ€æƒ³ï¼Œç±»ä¼¼äºrcæ–‡ä»¶ä¸­serviceçš„å¤„ç†æ–¹å¼ï¼æ—¢ç„¶å‘pending_control_messagesæ”¾äº†ä¸€æ¡ä¿¡æ¯å¾…å¤„ç†ï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰ä¸€ä¸ªåœ°æ–¹ä¸“é—¨æ¶ˆè´¹pending_control_messagesä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ç†è§£è¿™é‡Œè¿ç”¨äº†<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</strong>è®¾è®¡æ¨¡å¼ï¼ŒğŸ§ç­”æ¡ˆåœ¨ç¬¬3èŠ‚ï¼</p><h2 id="2-initè¿›ç¨‹å¯åŠ¨åç»­"><a href="#2-initè¿›ç¨‹å¯åŠ¨åç»­" class="headerlink" title="2.initè¿›ç¨‹å¯åŠ¨åç»­"></a>2.initè¿›ç¨‹å¯åŠ¨åç»­</h2><p>Android Sä»å®è§‚æ¥çœ‹ï¼Œinitè¿›ç¨‹æ€»å…±åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œæœ€åä¸€ä¸ªé˜¶æ®µä¹Ÿå°±æ˜¯<strong>SecondStageMain</strong>ï¼Œå½“SecondStageMainæ‰€æœ‰ä»£ç æ‰§è¡Œç»“æŸï¼Œinitè¿›ç¨‹åŸºæœ¬å°±ç»“æŸäº†ï¼Œä½†ä¸ä»£è¡¨initè¿›ç¨‹å•¥ä¹Ÿä¸å¹²äº†ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå…³é”®çš„<u><strong>whileå¾ªç¯</strong></u>ï¼Œä¼šä¸€ç›´ç›‘å¬æ˜¯å¦æ”¶åˆ°ctlMsgä¿¡æ¯ï¼ï¼ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsShuttingDown</span>()) &#123;<br>            <span class="hljs-built_in">HandleControlMessages</span>();<br>            <span class="hljs-built_in">SetUsbController</span>();<br>        &#125;<br>    &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆå¤„ç†CtlMsgä¿¡æ¯çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ç”¨ç†ä¼šä¸ctl.interface_startçš„è”ç³».</p><h2 id="3-HandleControlMessages-æ€ä¹ˆå¤„ç†CtlMsg"><a href="#3-HandleControlMessages-æ€ä¹ˆå¤„ç†CtlMsg" class="headerlink" title="3.HandleControlMessages:æ€ä¹ˆå¤„ç†CtlMsg"></a>3.HandleControlMessages:æ€ä¹ˆå¤„ç†CtlMsg</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">HandleControlMessages</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// å½“pending_control_messagesä¸ä¸ºç©ºçš„æ—¶å€™</span><br>    <span class="hljs-keyword">if</span> (!pending_control_messages.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">auto</span> control_message = pending_control_messages.<span class="hljs-built_in">front</span>();<br>        pending_control_messages.<span class="hljs-built_in">pop</span>();<br>        <span class="hljs-comment">// å…³é”®çœ‹è¿™é‡Œï¼Œè¿™é‡Œå›å»è°ƒç”¨HandleControlMessageå¤„ç†ç›¸å…³çš„ä¿¡æ¯</span><br>        <span class="hljs-type">bool</span> success = <span class="hljs-built_in">HandleControlMessage</span>(control_message.message, control_message.name,<br>                                            control_message.pid);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ä¸ºå…³é”®çš„æ˜¯HandleControlMessageï¼Œå®ƒè´Ÿè´£å¤„ç†æ¯ä¸€æ¡å…·ä½“çš„CtlMsg</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">HandleControlMessage</span><span class="hljs-params">(std::string_view message, <span class="hljs-type">const</span> std::string&amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">pid_t</span> from_pid)</span> </span>&#123;<br>    <span class="hljs-comment">// è·å–è¿›ç¨‹çš„çš„cmdline_pathï¼Œè¿™é‡Œcamerahalä¼ è¿›æ¥çš„åº”è¯¥æ˜¯hwservicemanagerå¯¹åº”çš„pid</span><br>    <span class="hljs-comment">// åŒæ—¶è·å–çš„cmdline_pathå°±æ˜¯hwservicemangerè¿™ä¸ªå­—ç¬¦ä¸²</span><br>    std::string cmdline_path = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;proc/%d/cmdline&quot;</span>, from_pid);<br>    std::string process_cmdline;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadFileToString</span>(cmdline_path, &amp;process_cmdline)) &#123;<br>        std::<span class="hljs-built_in">replace</span>(process_cmdline.<span class="hljs-built_in">begin</span>(), process_cmdline.<span class="hljs-built_in">end</span>(), <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>);<br>        process_cmdline = <span class="hljs-built_in">Trim</span>(process_cmdline);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        process_cmdline = <span class="hljs-string">&quot;unknown process&quot;</span>;<br>    &#125;<br><br>    Service* service = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">auto</span> action = message;<br>    <span class="hljs-comment">// å¦‚æœactionä»¥interface_å¼€å¤´ï¼Œå°±å»ServiceListä¸­å¯»æ‰¾</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ConsumePrefix</span>(&amp;action, <span class="hljs-string">&quot;interface_&quot;</span>)) &#123;<br>        service = ServiceList::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">FindInterface</span>(name);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        service = ServiceList::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">FindService</span>(name);<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–æˆ‘ä»¬è¦æ‰§è¡Œsigstop_on,oneshot_on,....,start,stop,...ä¸­çš„ä¸€ç§</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; map = <span class="hljs-built_in">GetControlMessageMap</span>();<br>    <span class="hljs-comment">// æ˜¾ç„¶è¿™é‡Œæ‰¾åˆ°çš„æ˜¯start</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> it = map.<span class="hljs-built_in">find</span>(action);<br><span class="hljs-comment">// startå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºDoControlStart</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; function = it-&gt;second;<br><br>    <span class="hljs-comment">// è°ƒç”¨DoControlStartæ‰§è¡Œè¿™ä¸ªæœåŠ¡</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">function</span>(service); !result.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Control message: Could not ctl.&quot;</span> &lt;&lt; message &lt;&lt; <span class="hljs-string">&quot; for &#x27;&quot;</span> &lt;&lt; name<br>                   &lt;&lt; <span class="hljs-string">&quot;&#x27; from pid: &quot;</span> &lt;&lt; from_pid &lt;&lt; <span class="hljs-string">&quot; (&quot;</span> &lt;&lt; process_cmdline<br>                   &lt;&lt; <span class="hljs-string">&quot;): &quot;</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Control message: Processed ctl.&quot;</span> &lt;&lt; message &lt;&lt; <span class="hljs-string">&quot; for &#x27;&quot;</span> &lt;&lt; name<br>              &lt;&lt; <span class="hljs-string">&quot;&#x27; from pid: &quot;</span> &lt;&lt; from_pid &lt;&lt; <span class="hljs-string">&quot; (&quot;</span> &lt;&lt; process_cmdline &lt;&lt; <span class="hljs-string">&quot;)&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">const</span> std::map&lt;std::string, ControlMessageFunction, std::less&lt;&gt;&gt;&amp; <span class="hljs-built_in">GetControlMessageMap</span>() &#123;<br>    <span class="hljs-comment">// clang-format off</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> std::map&lt;std::string, ControlMessageFunction, std::less&lt;&gt;&gt; control_message_functions = &#123;<br>        &#123;<span class="hljs-string">&quot;sigstop_on&quot;</span>,        [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_sigstop</span>(<span class="hljs-literal">true</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;sigstop_off&quot;</span>,       [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_sigstop</span>(<span class="hljs-literal">false</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;oneshot_on&quot;</span>,        [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_oneshot</span>(<span class="hljs-literal">true</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;oneshot_off&quot;</span>,       [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_oneshot</span>(<span class="hljs-literal">false</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;start&quot;</span>,             DoControlStart&#125;,<br>        &#123;<span class="hljs-string">&quot;stop&quot;</span>,              DoControlStop&#125;,<br>        &#123;<span class="hljs-string">&quot;restart&quot;</span>,           DoControlRestart&#125;,<br>    &#125;;<br>    <span class="hljs-comment">// clang-format on</span><br><br>    <span class="hljs-keyword">return</span> control_message_functions;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€å¯ç”¨çš„ HAL</title>
    <link href="/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/"/>
    <url>/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/</url>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æ€å¯ç”¨çš„-HAL"><a href="#åŠ¨æ€å¯ç”¨çš„-HAL" class="headerlink" title="åŠ¨æ€å¯ç”¨çš„ HAL"></a>åŠ¨æ€å¯ç”¨çš„ HAL</h1><blockquote><p>ğŸ¤– å…¨éƒ¨æ¥è‡ª<a href="https://source.android.com/docs/core/architecture/hal/dynamic-lifecycle?hl=zh-cn">å®‰å“å®˜ç½‘</a></p></blockquote><p>Android 9 æ”¯æŒåœ¨ä¸ä½¿ç”¨æˆ–ä¸éœ€è¦ Android ç¡¬ä»¶å­ç³»ç»Ÿæ—¶åŠ¨æ€å…³åœè¿™äº›å­ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·æœªä½¿ç”¨ Wi-Fiï¼ŒWi-Fi å­ç³»ç»Ÿå°±ä¸åº”å ç”¨å†…å­˜ã€è€—ç”¨ç”µé‡æˆ–ä½¿ç”¨å…¶ä»–ç³»ç»Ÿèµ„æºã€‚æ—©æœŸç‰ˆæœ¬çš„ Android ä¸­ï¼Œåœ¨ Android æ‰‹æœºå¯åŠ¨çš„æ•´ä¸ªæœŸé—´ï¼ŒAndroid è®¾å¤‡ä¸Šçš„ HAL&#x2F;é©±åŠ¨ç¨‹åºéƒ½ä¼šä¿æŒå¼€å¯çŠ¶æ€ã€‚</p><p>å®ç°åŠ¨æ€å…³åœæ¶‰åŠè¿æ¥æ•°æ®æµä»¥åŠæ‰§è¡ŒåŠ¨æ€è¿›ç¨‹ï¼Œä¸‹æ–‡å¯¹æ­¤è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ã€‚</p><h2 id="å¯¹-HAL-å®šä¹‰æ‰€åšçš„æ›´æ”¹"><a href="#å¯¹-HAL-å®šä¹‰æ‰€åšçš„æ›´æ”¹" class="headerlink" title="å¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹"></a>å¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹</h2><p>è¦å®ç°åŠ¨æ€å…³åœï¼Œä¸ä»…éœ€è¦æœ‰å…³äºå“ªäº›è¿›ç¨‹ä¸ºå“ªäº› HAL æ¥å£æä¾›æœåŠ¡çš„ä¿¡æ¯ï¼ˆæ­¤ç±»ä¿¡æ¯ä¹‹ååœ¨å…¶ä»–æƒ…å†µä¸­ä¹Ÿå¯èƒ½å¾ˆæœ‰ç”¨ï¼‰ï¼Œè¿˜éœ€è¦ç¡®ä¿è®¾å¤‡å¯åŠ¨æ—¶ä¸å¯åŠ¨è¿›ç¨‹ï¼Œè€Œä¸”åœ¨è¿›ç¨‹é€€å‡ºåï¼Œç›´åˆ°ç³»ç»Ÿå†æ¬¡è¯·æ±‚å¯åŠ¨å®ƒä»¬ä¹‹å‰ï¼Œéƒ½ä¸é‡æ–°å¯åŠ¨å®ƒä»¬ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># some init.rc script associated with the HAL</span><br>service vendor.some-service-name /vendor/bin/hw/some-binary-service<br>    <span class="hljs-comment"># init language extension, provides information of what service is served</span><br>    <span class="hljs-comment"># if multiple interfaces are served, they can be specified one on each line</span><br>    interface android.hardware.light@2.0::ILight default<br>    <span class="hljs-comment"># restarted if hwservicemanager dies</span><br>    <span class="hljs-comment"># would also cause the hal to start early during boot if disabled wasn&#x27;t set</span><br>    class hal<br>    <span class="hljs-comment"># will not be restarted if it exits until it is requested to be restarted</span><br>    oneshot<br>    <span class="hljs-comment"># will only be started when requested</span><br>    disabled<br>    <span class="hljs-comment"># ... other properties</span><br></code></pre></td></tr></table></figure><h2 id="å¯¹-init-å’Œ-hwservicemanager-æ‰€åšçš„æ›´æ”¹"><a href="#å¯¹-init-å’Œ-hwservicemanager-æ‰€åšçš„æ›´æ”¹" class="headerlink" title="å¯¹ init å’Œ hwservicemanager æ‰€åšçš„æ›´æ”¹"></a>å¯¹ init å’Œ hwservicemanager æ‰€åšçš„æ›´æ”¹</h2><p>ä¸ºäº†å®ç°åŠ¨æ€å…³åœï¼Œè¿˜éœ€è¦è®© <code>hwservicemanager</code> å‘ŠçŸ¥ <code>init</code> å¯åŠ¨æ‰€è¯·æ±‚çš„æœåŠ¡ã€‚åœ¨ Android 9 ä¸­ï¼Œ<code>init</code> åŒ…å«ä¸‰ä¸ªé¢å¤–çš„æ§åˆ¶æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼Œ<code>ctl.start</code>ï¼‰ï¼š<code>ctl.interface_start</code>ã€<code>ctl.interface_stop</code> å’Œ <code>ctl.interface_restart</code>ã€‚è¿™äº›æ¶ˆæ¯å¯ç”¨äºæŒ‡ç¤º <code>init</code> æ‰“å¼€æˆ–å…³é—­ç‰¹å®šç¡¬ä»¶æ¥å£ã€‚å¦‚æœç³»ç»Ÿè¯·æ±‚ä½¿ç”¨æŸä¸ªæœåŠ¡ä½†è¯¥æœåŠ¡æœªæ³¨å†Œï¼Œ<code>hwservicemanager</code> ä¼šè¯·æ±‚å¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸è¿‡ï¼ŒåŠ¨æ€ HAL ä¸éœ€è¦ä½¿ç”¨ä»¥ä¸Šä»»ä½•æ¶ˆæ¯ã€‚</p><h2 id="ç¡®å®š-HAL-é€€å‡º"><a href="#ç¡®å®š-HAL-é€€å‡º" class="headerlink" title="ç¡®å®š HAL é€€å‡º"></a>ç¡®å®š HAL é€€å‡º</h2><p>åœ¨ Android 9 ä¸­ï¼Œå¿…é¡»æ‰‹åŠ¨ç¡®å®š HAL é€€å‡ºã€‚å¯¹äº Android 10 åŠæ›´é«˜ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç¡®å®š HAL é€€å‡ºã€‚</p><p>ä¸ºäº†å®ç°åŠ¨æ€å…³åœï¼Œéœ€è¦å¤šä¸ªç­–ç•¥æ¥å†³å®šä½•æ—¶å¯åŠ¨å’Œå…³åœ HALã€‚å¦‚æœ HAL å‡ºäºä»»ä½•åŸå› å†³å®šé€€å‡ºï¼Œå½“ç³»ç»Ÿå†æ¬¡éœ€è¦ç”¨åˆ°å®ƒæ—¶ï¼Œå®ƒå°†ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯å’ŒåŸºç¡€æ¶æ„è‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼šHAL å®šä¹‰ä¸­æä¾›çš„ä¿¡æ¯ï¼Œä»¥åŠæ›´æ”¹åçš„ <code>init</code> å’Œ <code>hwservicemanager</code> æä¾›çš„åŸºç¡€æ¶æ„ã€‚è¿™å¯èƒ½ä¼šæ¶‰åŠå¤šä¸ªä¸åŒçš„ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¦‚æœæœ‰äººå¯¹ HAL è°ƒç”¨å…³é—­å‘½ä»¤æˆ–ç±»ä¼¼çš„ APIï¼Œåˆ™ HAL å¯èƒ½ä¼šé€‰æ‹©è‡ªè¡Œè°ƒç”¨é€€å‡ºå‘½ä»¤ã€‚æ­¤è¡Œä¸ºå¿…é¡»åœ¨ç›¸åº”çš„ HAL æ¥å£ä¸­æŒ‡å®šã€‚</li><li>HAL å¯åœ¨ä»»åŠ¡å®Œæˆåå…³åœï¼ˆè®°å½•åœ¨ HAL æ–‡ä»¶ä¸­ï¼‰ã€‚</li></ul><h2 id="è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ"><a href="#è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ"></a>è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ</h2><p>Android 10 ä¸ºå†…æ ¸å’Œ hwservicemanager æ·»åŠ äº†æ›´å¤šæ”¯æŒï¼Œå¯è®© HAL åœ¨æ²¡æœ‰ä»»ä½•å®¢æˆ·ç«¯æ—¶è‡ªåŠ¨å…³åœã€‚å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·æ ¹æ®â€œå¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹â€è¿™ä¸€éƒ¨åˆ†å®Œæˆå…¶ä¸­æ‰€æœ‰æ­¥éª¤ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ <code>LazyServiceRegistrar</code> è€Œä¸æ˜¯æˆå‘˜å‡½æ•° <code>registerAsService</code> é€šè¿‡ C++ æ³¨å†ŒæœåŠ¡ï¼Œä¾‹å¦‚ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// only one instance of LazyServiceRegistrar per process</span><br>LazyServiceRegistrar registrar;<br>registrar.<span class="hljs-built_in">registerAsService</span>(myHidlService <span class="hljs-comment">/* , &quot;default&quot; */</span>);<br></code></pre></td></tr></table></figure><ul><li>éªŒè¯ HAL å®¢æˆ·ç«¯æ˜¯å¦ä»…åœ¨ä½¿ç”¨æ—¶ä¿ç•™å¯¹é¡¶çº§ HALï¼ˆé€šè¿‡ <code>hwservicemanager</code> æ³¨å†Œçš„æ¥å£ï¼‰çš„å¼•ç”¨ã€‚ä¸ºäº†é¿å…å‡ºç°å»¶è¿Ÿï¼Œå¦‚æœè¯¥å¼•ç”¨åœ¨ç»§ç»­æ‰§è¡Œçš„ hwbinder çº¿ç¨‹ä¸Šè¢«ä¸¢å¼ƒï¼Œå®¢æˆ·ç«¯è¿˜åº”è¯¥åœ¨ä¸¢å¼ƒå¼•ç”¨åè°ƒç”¨ <code>IPCThreadState::self()-&gt;flushCommands()</code>ï¼Œä»¥ç¡®ä¿ binder é©±åŠ¨ç¨‹åºåœ¨ç›¸å…³å¼•ç”¨è®¡æ•°å‘ç”Ÿå˜åŒ–æ—¶æ”¶åˆ°é€šçŸ¥ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gitå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="gitå­¦ä¹ ç¬”è®°"><a href="#gitå­¦ä¹ ç¬”è®°" class="headerlink" title="gitå­¦ä¹ ç¬”è®°"></a>gitå­¦ä¹ ç¬”è®°</h1><h2 id="gitä¸‹è½½å®‰è£…"><a href="#gitä¸‹è½½å®‰è£…" class="headerlink" title="gitä¸‹è½½å®‰è£…"></a>gitä¸‹è½½å®‰è£…</h2><p>ä¸‹è½½åœ°å€ï¼š<a href="https://git-scm.com/download">Git - Downloads</a></p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1679585116661-4.png" alt="img"><p>ä»¥å¾—åˆ°å¦‚ä¸‹å®‰è£…æ–‡ä»¶ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1679585140689-7.png" alt="img"><p>åŒå‡»ä¸‹è½½çš„å®‰è£…æ–‡ä»¶æ¥å®‰è£…Gitã€‚å®‰è£…å®Œæˆååœ¨ç”µè„‘æ¡Œé¢ï¼ˆä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç›®å½•ï¼‰ç‚¹å‡»å³é”®ï¼Œå¦‚æœèƒ½å¤Ÿçœ‹</p><p>åˆ°å¦‚ä¸‹ä¸¤ä¸ªèœå•åˆ™è¯´æ˜Gitå®‰è£…æˆåŠŸ</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230323232638131.png" alt="image-20230323232638131" style="zoom: 70%;"><p>å¤‡æ³¨ï¼š</p><ul><li>Git GUIï¼šGitæä¾›çš„å›¾å½¢ç•Œé¢å·¥å…·</li><li>Git Bashï¼šGitæä¾›çš„å‘½ä»¤è¡Œå·¥å…·</li></ul><p>å½“å®‰è£…Gitåé¦–å…ˆè¦åšçš„äº‹æƒ…æ˜¯è®¾ç½®ç”¨æˆ·åç§°å’Œemailåœ°å€ã€‚è¿™æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºæ¯æ¬¡Gitæäº¤éƒ½ä¼šä½¿ç”¨è¯¥ç”¨æˆ·ä¿¡æ¯</p><h2 id="gitä¸‰ä¸ªåŒº"><a href="#gitä¸‰ä¸ªåŒº" class="headerlink" title="gitä¸‰ä¸ªåŒº"></a>gitä¸‰ä¸ªåŒº</h2><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/e38fd405-7e6a-4cc7-b576-a991af1d9cd5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><ul><li><code>Workspace</code>ï¼šå·¥ä½œåŒºï¼Œå°±æ˜¯ä½ å¹³æ—¶å­˜æ”¾é¡¹ç›®ä»£ç çš„åœ°æ–¹</li><li><code>Index / Stage</code>ï¼šæš‚å­˜åŒºï¼Œç”¨äºä¸´æ—¶å­˜æ”¾ä½ çš„æ”¹åŠ¨ï¼Œäº‹å®ä¸Šå®ƒåªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜å³å°†æäº¤åˆ°æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯,ä¸€èˆ¬å­˜æ”¾åœ¨ .git ç›®å½•ä¸‹çš„ index æ–‡ä»¶ï¼ˆ.git&#x2F;indexï¼‰ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæš‚å­˜åŒºæœ‰æ—¶ä¹Ÿå«ä½œç´¢å¼•ï¼ˆindexï¼‰</li><li><code>Repository</code>ï¼šä»“åº“åŒºï¼ˆæˆ–æœ¬åœ°ä»“åº“ï¼‰ï¼Œå°±æ˜¯å®‰å…¨å­˜æ”¾æ•°æ®çš„ä½ç½®ï¼Œè¿™é‡Œé¢æœ‰ä½ æäº¤åˆ°æ‰€æœ‰ç‰ˆæœ¬çš„æ•°æ®ã€‚å…¶ä¸­HEADæŒ‡å‘æœ€æ–°æ”¾å…¥ä»“åº“çš„ç‰ˆæœ¬</li><li><code>Remote</code>ï¼šè¿œç¨‹ä»“åº“ï¼Œæ‰˜ç®¡ä»£ç çš„æœåŠ¡å™¨ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºæ˜¯ä½ é¡¹ç›®ç»„ä¸­çš„ä¸€å°ç”µè„‘ç”¨äºè¿œç¨‹æ•°æ®äº¤æ¢</li></ul><hr><p><strong>å‘½ä»¤å¦‚ä¸‹ï¼š</strong></p><ol><li>cloneï¼ˆå…‹éš†ï¼‰: ä»è¿œç¨‹ä»“åº“ä¸­å…‹éš†ä»£ç åˆ°æœ¬åœ°ä»“åº“</li><li>checkout ï¼ˆæ£€å‡ºï¼‰:ä»æœ¬åœ°ä»“åº“ä¸­æ£€å‡ºä¸€ä¸ªä»“åº“åˆ†æ”¯ç„¶åè¿›è¡Œä¿®è®¢</li><li>addï¼ˆæ·»åŠ ï¼‰: åœ¨æäº¤å‰å…ˆå°†ä»£ç æäº¤åˆ°æš‚å­˜åŒº</li><li>commitï¼ˆæäº¤ï¼‰: æäº¤åˆ°æœ¬åœ°ä»“åº“ã€‚æœ¬åœ°ä»“åº“ä¸­ä¿å­˜ä¿®æ”¹çš„å„ä¸ªå†å²ç‰ˆæœ¬</li><li>fetch (æŠ“å–) ï¼š ä»è¿œç¨‹åº“ï¼ŒæŠ“å–åˆ°æœ¬åœ°ä»“åº“ï¼Œä¸è¿›è¡Œä»»ä½•çš„åˆå¹¶åŠ¨ä½œï¼Œä¸€èˆ¬æ“ä½œæ¯”è¾ƒå°‘ã€‚</li><li>pull (æ‹‰å–) ï¼š ä»è¿œç¨‹åº“æ‹‰åˆ°æœ¬åœ°åº“ï¼Œè‡ªåŠ¨è¿›è¡Œåˆå¹¶(merge)ï¼Œç„¶åæ”¾åˆ°åˆ°å·¥ä½œåŒºï¼Œç›¸å½“äºfetch+merge</li><li>pushï¼ˆæ¨é€ï¼‰ : ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦å’Œå›¢é˜Ÿæˆå‘˜å…±äº«ä»£ç æ—¶ï¼Œå°†ä»£ç æ¨é€åˆ°è¿œç¨‹ä»“åº“</li></ol><h2 id="git-configé…ç½®ä½œè€…ä¿¡æ¯"><a href="#git-configé…ç½®ä½œè€…ä¿¡æ¯" class="headerlink" title="git configé…ç½®ä½œè€…ä¿¡æ¯"></a>git configé…ç½®ä½œè€…ä¿¡æ¯</h2><blockquote><p>åç›¾äººï¼š<a href="https://www.bilibili.com/video/BV1WW4y1b78T">https://www.bilibili.com/video/BV1WW4y1b78T</a></p></blockquote><p>é…ç½®æ–‡ä»¶ä¸º<code>~/.gitconfig</code>ï¼Œæ‰§è¡Œä»»ä½•Gité…ç½®å‘½ä»¤åæ–‡ä»¶å°†è‡ªåŠ¨åˆ›å»ºã€‚</p><p>ç¬¬ä¸€ä¸ªè¦é…ç½®çš„æ˜¯ä½ ä¸ªäººçš„ç”¨æˆ·åç§°å’Œç”µå­é‚®ä»¶åœ°å€ï¼Œè¿™ä¸¤æ¡é…ç½®å¾ˆé‡è¦ï¼Œæ¯æ¬¡Gitæäº¤æ—¶éƒ½ä¼šå¼•ç”¨è¿™ä¸¤æ¡ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯è°æäº¤äº†æ›´æ–°ï¼Œæ‰€ä»¥ä¼šéšæ›´æ–°å†…å®¹ä¸€èµ·è¢«æ°¸ä¹…çº³å…¥å†å²è®°å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">git config --global user.name â€œOneAmxixixiâ€<br>git config --global user.email â€œ842629356@qq.com&quot;<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœæˆ‘ä»¬è¦åœ¨ç‰¹å®šçš„é¡¹ç›®ä»“ä¸­ä¿®æ”¹æäº¤äººä¿¡æ¯ï¼š</li></ul><p>å½“æˆ‘ä»¬git initåˆå§‹åŒ–æœ¬åœ°ä»“åº“åï¼Œä¼šå‡ºç°.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬è¿›å…¥é‡Œé¢çš„é…ç½®æ–‡ä»¶<code>config</code>ã€‚</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325224813424.png" alt="image-20230325224813424" style="zoom:70%;"><p>æ­¤æ—¶configæ–‡ä»¶å¦‚ä¸‹ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325224941049.png" alt="image-20230325224941049" style="zoom: 67%;"><p>ä¿®æ”¹å½“å‰ä»“åº“æäº¤äººä¿¡æ¯ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Administrator@WBX-20220621BRZ MINGW64 /g/gitå¼ºåŒ–å­¦ä¹ /android12 (master)<br>$ git config user.name <span class="hljs-string">&quot;baitaowulong&quot;</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å½“å‰ä»“åº“çš„<code>.git/config</code>å°±å‡ºç°äº†æ–°çš„æäº¤äºº</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325225038843.png" alt="image-20230325225038843" style="zoom:67%;"><h2 id="gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨"><a href="#gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨" class="headerlink" title=".gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨"></a>.gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨</h2><p>ä¸€èˆ¬æˆ‘ä»¬æ€»ä¼šæœ‰äº›æ–‡ä»¶æ— éœ€çº³å…¥Git çš„ç®¡ç†ï¼Œä¹Ÿä¸å¸Œæœ›å®ƒä»¬æ€»å‡ºç°åœ¨æœªè·Ÿè¸ªæ–‡ä»¶åˆ—è¡¨ã€‚ é€šå¸¸éƒ½æ˜¯äº›è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…ç¼–è¯‘è¿‡ç¨‹ä¸­åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶ç­‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>.gitignore</code> çš„æ–‡ä»¶ï¼ˆæ–‡ä»¶åç§°å›ºå®šï¼‰ï¼Œåˆ—å‡ºè¦å¿½ç•¥çš„æ–‡ä»¶æ¨¡å¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥æ‰€æœ‰ä»¥.aç»“å°¾çš„æ–‡ä»¶</span><br>*.a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥æ‰€æœ‰ä»¥.aç»“å°¾çš„æ–‡ä»¶ï¼Œé™¤äº†lib.a</span><br>!lib.a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä»…ä»…å¿½ç•¥å½“å‰ç›®å½•ä¸‹çš„TODOæ–‡ä»¶å¤¹ï¼Œä½†ä¸å¿½ç•¥å½“å‰è·¯å¾„å­æ–‡ä»¶çš„TODOæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚./subdir/TODO</span><br>/TODO<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥build/ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶</span><br>build/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥docç›®å½•ä¸‹ä»¥.txtç»“å°¾çš„æ–‡ä»¶ï¼Œä½†ä¸å¿½ç•¥docå­ç›®å½•ä¸‹ä»¥txtæ–‡ä»¶çš„æ–‡ä»¶ï¼Œæ¯”å¦‚doc/server/arch.txtä¸ä¼šå¿½ç•¥</span><br>doc/*.txt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥docæ–‡ä»¶ä¸‹æ‰€æœ‰ä»¥pdfç»“å°¾çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­ç›®å½•</span><br>doc/**/*.pdf<br></code></pre></td></tr></table></figure><ol><li>æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªä»¥<code>.java</code>ç»“å°¾ï¼Œä¸€ä¸ªä»¥<code>.c</code>ç»“å°¾</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231753957.png" alt="image-20230325231753957" style="zoom:80%;"><ol start="2"><li>åœ¨<code>.gitignore</code>ä¸­è®¾ç½®è¢«å¿½ç•¥çš„è§„åˆ™</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231903931.png" alt="image-20230325231903931" style="zoom:80%;"><ol start="3"><li>æ­¤æ—¶æœ¬åœ°ä»“åº“å°±ä¸ä¼šè·Ÿè¸ª<code>.gitignore</code>ä¸­çš„å†…å®¹</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231922326.png" alt="image-20230325231922326" style="zoom: 80%;"><h2 id="git-rmåˆ é™¤æ–‡ä»¶"><a href="#git-rmåˆ é™¤æ–‡ä»¶" class="headerlink" title="git rmåˆ é™¤æ–‡ä»¶"></a>git rmåˆ é™¤æ–‡ä»¶</h2><h3 id="git-rmåŸºæœ¬ç”¨æ³•"><a href="#git-rmåŸºæœ¬ç”¨æ³•" class="headerlink" title="git rmåŸºæœ¬ç”¨æ³•"></a>git rmåŸºæœ¬ç”¨æ³•</h3><p><strong>ä½œç”¨ï¼š</strong>  <strong>åŒæ—¶ä»å·¥ä½œåŒºå’Œç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶</strong>ã€‚å³æœ¬åœ°çš„æ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†ã€‚</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326104602205.png" alt="image-20230326104602205" style="zoom:80%;"><h3 id="git-rm-â€“cacheåæ‚”è¯"><a href="#git-rm-â€“cacheåæ‚”è¯" class="headerlink" title="git rm â€“cacheåæ‚”è¯"></a>git rm â€“cacheåæ‚”è¯</h3><blockquote><p>åœºæ™¯ï¼šå‡è®¾æˆ‘ä»¬æ‰‹å¿«äº†ï¼Œå°†ä¸€äº›æ–‡ä»¶æ·»åŠ åˆ°äº†æœ¬åœ°ç‰ˆæœ¬åº“é‡Œé¢ï¼Œç°åœ¨æƒ³åˆ é™¤å®ƒï¼Œä½†æ˜¯åˆä¸å¸Œæœ›æœ¬åœ°çš„æ–‡ä»¶ä¸¢å¤±ã€‚</p></blockquote><p><strong>ä½œç”¨ï¼š</strong> <strong>ä»ç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶ã€‚ä½†æ˜¯æœ¬åœ°æ–‡ä»¶è¿˜å­˜åœ¨</strong>ï¼Œ åªæ˜¯ä¸å¸Œæœ›è¿™ä¸ªæ–‡ä»¶è¢«ç‰ˆæœ¬æ§åˆ¶</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326105155871.png" alt="image-20230326105155871" style="zoom:80%;"><h2 id="git-mvä¿®æ”¹æ–‡ä»¶å"><a href="#git-mvä¿®æ”¹æ–‡ä»¶å" class="headerlink" title="git mvä¿®æ”¹æ–‡ä»¶å"></a>git mvä¿®æ”¹æ–‡ä»¶å</h2><blockquote><p>åœºæ™¯ï¼šå‘ç°ç‰ˆæœ¬åº“é‡Œé¢çš„æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦å°†ç‰ˆæœ¬åº“é‡Œé¢çš„binder.cæ”¹æˆbind.c</p></blockquote><p><strong>ä½œç”¨ï¼š</strong></p><ul><li><p>git mv å‘½ä»¤ç”¨äºç§»åŠ¨æˆ–é‡å‘½åä¸€ä¸ªæ–‡ä»¶ã€ç›®å½•æˆ–è½¯è¿æ¥ã€‚</p></li><li><p>å®ƒä¼šå°†å†…å®¹ä»å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­é‡å‘½åï¼Œæ‰‹åŠ¨é‡å‘½åéœ€è¦æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œgit mv ä¸€æ­¥å³å¯</p></li></ul><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326110457377.png" alt="image-20230326110457377" style="zoom:80%;"><p>å¦‚æœä¸é‡‡å–git mvï¼Œéœ€è¦ä¸¤æ­¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv led_t286.c led_q385.c<br>git add led_t286.c led_t286<br></code></pre></td></tr></table></figure><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326111013402.png" alt="image-20230326111013402" style="zoom:80%;"><h2 id="git-logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯"><a href="#git-logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯" class="headerlink" title="git logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯"></a>git logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯</h2><p><strong>ä½œç”¨ï¼š</strong>æŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112521485.png" alt="image-20230326112521485" style="zoom:80%;"><p>å¦‚æœæƒ³çœ‹æŸ¥çœ‹æ›´åŠ è¯¦ç»†ä¸€ç‚¹çš„ä¿¡æ¯å¯ä»¥ä½¿ç”¨<code>git log -p</code></p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112631990.png" alt="image-20230326112631990" style="zoom:80%;"><p>å¦‚æœæƒ³è¦æ—¥å¿—ä»¥æŸç§æ ¼å¼è¾“å‡ºå¯ä»¥ä½¿ç”¨<code>git log --pretty=format</code></p><blockquote><p>è¯¦ç»†å¯å‚è€ƒï¼š<a href="https://blog.csdn.net/u011106915/article/details/105836289/">https://blog.csdn.net/u011106915/article/details/105836289/</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git log --pretty=format:&quot;SHA-1:%h - åˆ›å»ºäºº:%an æ—¶é—´:%ad æäº¤ä¿¡æ¯:%s&quot; --date=format:&quot;%y-%m-%d %H:%M:%S&quot; --shortstat --since=2.weeks &gt; log.txt<br></code></pre></td></tr></table></figure><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112833997.png" alt="image-20230326112833997" style="zoom:67%;"><h2 id="git-amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤"><a href="#git-amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤" class="headerlink" title="git amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤"></a>git amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤</h2><blockquote><p>åœºæ™¯ï¼šå‡å¦‚åˆšåˆšæœ‰ä¸€ç¬”æäº¤ï¼Œéœ€è¦é‡æ–°ä¿®æ”¹åæäº¤ï¼Œä½†æ˜¯æˆ‘ä»¬åˆä¸æƒ³ç”Ÿæˆæ–°çš„commitIdé‡æ–°æäº¤</p></blockquote><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326113641189.png" alt="image-20230326113641189" style="zoom:80%;"><h2 id="gitå‘½ä»¤åˆ›å»ºåˆ«å"><a href="#gitå‘½ä»¤åˆ›å»ºåˆ«å" class="headerlink" title="gitå‘½ä»¤åˆ›å»ºåˆ«å"></a>gitå‘½ä»¤åˆ›å»ºåˆ«å</h2><p>Linuxï¼šåœ¨homeç›®å½•ä¸‹ï¼Œç¼–è¾‘<code>.gitconfig</code>æ–‡ä»¶</p><p>WIndowï¼šåœ¨ <code>$HOME</code> ç›®å½•ä¸‹ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ <code>C:\Users\$USER</code> ï¼‰çš„ <code>.gitconfig</code> æ–‡ä»¶</p><p>æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326210601688.png" alt="image-20230326210601688" style="zoom:80%;"><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç®€çŸ­çš„å‘½ä»¤è¡¨ç¤ºä»¥å‰ç¹ççš„å‘½ä»¤</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326210430079.png" alt="image-20230326210430079" style="zoom: 80%;"><p>å¦‚æœæˆ‘ä»¬æƒ³æ›´ç®€çŸ­ä¸€ç‚¹ï¼Œåœ¨Linuxä¸‹ï¼Œç¼–è¾‘<code>~/.bashrc</code>ã€Windowç¼–è¾‘<code>C:\Users\$USER\.bash_profile</code>ã€‘ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">alias gs=&#x27;git status&#x27;<br>alias gss=&#x27;git status |grep modified&#x27;<br>alias gd=&#x27;git diff &#x27;<br>alias gds=&#x27;git diff --staged&#x27;<br>alias gsh=&#x27;git show &#x27;<br>alias ga=&#x27;git add .&#x27;<br>alias gcm=&#x27;git commit .&#x27;<br>alias gc=&#x27;git checkout -- &#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">alias</span> gl=<span class="hljs-string">&#x27;git log --pretty=oneline  --abbrev-commit&#x27;</span></span><br>alias gl=&#x27;git lg&#x27;<br>alias glh=&#x27;git lg --graph&#x27;<br>alias gls=&#x27;git lg --author=panfei&#x27;<br>alias gb=&#x27;git branch -v&#x27;<br></code></pre></td></tr></table></figure><p>å°±å¯ä»¥ä½¿ç”¨<code>gs</code>è¡¨ç¤º<code>git status</code>â€¦</p><h2 id="git-cherry-pick"><a href="#git-cherry-pick" class="headerlink" title="git cherry-pick"></a>git cherry-pick</h2><blockquote><p>ğŸŒ <strong>å‚è€ƒ</strong>ï¼š<a href="https://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html">é˜®ä¸€å³°åšå®¢</a></p></blockquote><p>å¯¹äºå¤šåˆ†æ”¯çš„ä»£ç åº“ï¼Œå°†ä»£ç ä»ä¸€ä¸ªåˆ†æ”¯è½¬ç§»åˆ°å¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å¸¸è§éœ€æ±‚ã€‚</p><p>è¿™æ—¶åˆ†ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ éœ€è¦å¦ä¸€ä¸ªåˆ†æ”¯çš„æ‰€æœ‰ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨åˆå¹¶ï¼ˆ<code>git merge</code>ï¼‰ã€‚å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ åªéœ€è¦éƒ¨åˆ†ä»£ç å˜åŠ¨ï¼ˆæŸå‡ ä¸ªæäº¤ï¼‰ï¼Œè¿™æ—¶å¯ä»¥é‡‡ç”¨ Cherry pickã€‚</p><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p><code>git cherry-pick</code>å‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°†æŒ‡å®šçš„æäº¤ï¼ˆcommitï¼‰åº”ç”¨äºå…¶ä»–åˆ†æ”¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤å°±ä¼šå°†æŒ‡å®šçš„æäº¤<code>commitHash</code>ï¼Œåº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æäº¤ï¼Œå½“ç„¶å®ƒä»¬çš„å“ˆå¸Œå€¼ä¼šä¸ä¸€æ ·ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œä»£ç ä»“åº“æœ‰<code>master</code>å’Œ<code>feature</code>ä¸¤ä¸ªåˆ†æ”¯ã€‚</p><blockquote><p>a - b - c - d   Master<br>     <br>       e - f - g Feature</p></blockquote><p>ç°åœ¨å°†æäº¤<code>f</code>åº”ç”¨åˆ°<code>master</code>åˆ†æ”¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ‡æ¢åˆ° master åˆ†æ”¯</span><br>$ git checkout master<br><br><span class="hljs-comment"># Cherry pick æ“ä½œ</span><br>$ git cherry-pick f<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ“ä½œå®Œæˆä»¥åï¼Œä»£ç åº“å°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">a - b - c - d - f   Master<br>     \<br>       e - f - g Feature<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œ<code>master</code>åˆ†æ”¯çš„æœ«å°¾å¢åŠ äº†ä¸€ä¸ªæäº¤<code>f</code>ã€‚</p><p><code>git cherry-pick</code>å‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">$ git cherry-pick feature<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¡¨ç¤ºå°†<code>feature</code>åˆ†æ”¯çš„æœ€è¿‘ä¸€æ¬¡æäº¤ï¼Œè½¬ç§»åˆ°å½“å‰åˆ†æ”¯ã€‚</p><h3 id="è½¬ç§»å¤šä¸ªæäº¤"><a href="#è½¬ç§»å¤šä¸ªæäº¤" class="headerlink" title="è½¬ç§»å¤šä¸ªæäº¤"></a>è½¬ç§»å¤šä¸ªæäº¤</h3><p>Cherry pick æ”¯æŒä¸€æ¬¡è½¬ç§»å¤šä¸ªæäº¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;HashA&gt; &lt;HashB&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤å°† A å’Œ B ä¸¤ä¸ªæäº¤åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯ç”Ÿæˆä¸¤ä¸ªå¯¹åº”çš„æ–°æäº¤ã€‚</p><p>å¦‚æœæƒ³è¦è½¬ç§»ä¸€ç³»åˆ—çš„è¿ç»­æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç®€ä¾¿è¯­æ³•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick A..B <br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤å¯ä»¥è½¬ç§»ä» A åˆ° B çš„æ‰€æœ‰æäº¤ã€‚å®ƒä»¬å¿…é¡»æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ”¾ç½®ï¼šæäº¤ A å¿…é¡»æ—©äºæäº¤ Bï¼Œå¦åˆ™å‘½ä»¤å°†å¤±è´¥ï¼Œä½†ä¸ä¼šæŠ¥é”™ã€‚</p><p>æ³¨æ„ï¼Œä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæäº¤ A å°†ä¸ä¼šåŒ…å«åœ¨ Cherry pick ä¸­ã€‚å¦‚æœè¦åŒ…å«æäº¤ Aï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick A^..B <br></code></pre></td></tr></table></figure><h3 id="é…ç½®é¡¹"><a href="#é…ç½®é¡¹" class="headerlink" title="é…ç½®é¡¹"></a>é…ç½®é¡¹</h3><p><code>git cherry-pick</code>å‘½ä»¤çš„å¸¸ç”¨é…ç½®é¡¹å¦‚ä¸‹ã€‚</p><p><strong>ï¼ˆ1ï¼‰<code>-e</code>ï¼Œ<code>--edit</code></strong></p><p>æ‰“å¼€å¤–éƒ¨ç¼–è¾‘å™¨ï¼Œç¼–è¾‘æäº¤ä¿¡æ¯ã€‚</p><p><strong>ï¼ˆ2ï¼‰<code>-n</code>ï¼Œ<code>--no-commit</code></strong></p><p>åªæ›´æ–°å·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼Œä¸äº§ç”Ÿæ–°çš„æäº¤ã€‚</p><p><strong>ï¼ˆ3ï¼‰<code>-x</code></strong></p><p>åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œ<code>(cherry picked from commit ...)</code>ï¼Œæ–¹ä¾¿ä»¥åæŸ¥åˆ°è¿™ä¸ªæäº¤æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p><p><strong>ï¼ˆ4ï¼‰<code>-s</code>ï¼Œ<code>--signoff</code></strong></p><p>åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œæ“ä½œè€…çš„ç­¾åï¼Œè¡¨ç¤ºæ˜¯è°è¿›è¡Œäº†è¿™ä¸ªæ“ä½œã€‚</p><p><strong>ï¼ˆ5ï¼‰<code>-m parent-number</code>ï¼Œ<code>--mainline parent-number</code></strong></p><p>å¦‚æœåŸå§‹æäº¤æ˜¯ä¸€ä¸ªåˆå¹¶èŠ‚ç‚¹ï¼Œæ¥è‡ªäºä¸¤ä¸ªåˆ†æ”¯çš„åˆå¹¶ï¼Œé‚£ä¹ˆ Cherry pick é»˜è®¤å°†å¤±è´¥ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“åº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„ä»£ç å˜åŠ¨ã€‚</p><p><code>-m</code>é…ç½®é¡¹å‘Šè¯‰ Gitï¼Œåº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„å˜åŠ¨ã€‚å®ƒçš„å‚æ•°<code>parent-number</code>æ˜¯ä¸€ä¸ªä»<code>1</code>å¼€å§‹çš„æ•´æ•°ï¼Œä»£è¡¨åŸå§‹æäº¤çš„çˆ¶åˆ†æ”¯ç¼–å·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick -m 1 &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤è¡¨ç¤ºï¼ŒCherry pick é‡‡ç”¨æäº¤<code>commitHash</code>æ¥è‡ªç¼–å·1çš„çˆ¶åˆ†æ”¯çš„å˜åŠ¨ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œ1å·çˆ¶åˆ†æ”¯æ˜¯æ¥å—å˜åŠ¨çš„åˆ†æ”¯ï¼ˆthe branch being merged intoï¼‰ï¼Œ2å·çˆ¶åˆ†æ”¯æ˜¯ä½œä¸ºå˜åŠ¨æ¥æºçš„åˆ†æ”¯ï¼ˆthe branch being merged fromï¼‰ã€‚</p><h3 id="ä»£ç å†²çª"><a href="#ä»£ç å†²çª" class="headerlink" title="ä»£ç å†²çª"></a>ä»£ç å†²çª</h3><p>å¦‚æœæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿä»£ç å†²çªï¼ŒCherry pick ä¼šåœä¸‹æ¥ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•ç»§ç»­æ“ä½œã€‚</p><p><strong>ï¼ˆ1ï¼‰<code>--continue</code></strong></p><p>ç”¨æˆ·è§£å†³ä»£ç å†²çªåï¼Œç¬¬ä¸€æ­¥å°†ä¿®æ”¹çš„æ–‡ä»¶é‡æ–°åŠ å…¥æš‚å­˜åŒºï¼ˆ<code>git add .</code>ï¼‰ï¼Œç¬¬äºŒæ­¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œè®© Cherry pick è¿‡ç¨‹ç»§ç»­æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick --<span class="hljs-built_in">continue</span><br></code></pre></td></tr></table></figure><p><strong>ï¼ˆ2ï¼‰<code>--abort</code></strong></p><p>å‘ç”Ÿä»£ç å†²çªåï¼Œæ”¾å¼ƒåˆå¹¶ï¼Œå›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚</p><p><strong>ï¼ˆ3ï¼‰<code>--quit</code></strong></p><p>å‘ç”Ÿä»£ç å†²çªåï¼Œé€€å‡º Cherry pickï¼Œä½†æ˜¯ä¸å›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚</p><h3 id="è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“"><a href="#è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“" class="headerlink" title="è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“"></a>è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“</h3><p>Cherry pick ä¹Ÿæ”¯æŒè½¬ç§»å¦ä¸€ä¸ªä»£ç åº“çš„æäº¤ï¼Œæ–¹æ³•æ˜¯å…ˆå°†è¯¥åº“åŠ ä¸ºè¿œç¨‹ä»“åº“ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git remote add target git://gitUrl<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤æ·»åŠ äº†ä¸€ä¸ªè¿œç¨‹ä»“åº“<code>target</code>ã€‚</p><p>ç„¶åï¼Œå°†è¿œç¨‹ä»£ç æŠ“å–åˆ°æœ¬åœ°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">$ git fetch target<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤å°†è¿œç¨‹ä»£ç ä»“åº“æŠ“å–åˆ°æœ¬åœ°ã€‚</p><p>æ¥ç€ï¼Œæ£€æŸ¥ä¸€ä¸‹è¦ä»è¿œç¨‹ä»“åº“è½¬ç§»çš„æäº¤ï¼Œè·å–å®ƒçš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">log</span> target/master<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨<code>git cherry-pick</code>å‘½ä»¤è½¬ç§»æäº¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><h2 id="Git-ä¸­-HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«"><a href="#Git-ä¸­-HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="Git ä¸­ HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«"></a>Git ä¸­ HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«</h2><blockquote><p>å‚è€ƒï¼š<a href="http://fanyouf.gitee.io/interview/git/02.html#%E7%AE%80%E7%89%88">http://fanyouf.gitee.io/interview/git/02.html#%E7%AE%80%E7%89%88</a></p></blockquote><h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h3><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2de056a0-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>åœ¨<code>git</code>ä¸­ï¼Œå¯ä»¥å­˜åœ¨å¾ˆå¤šåˆ†æ”¯ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘<code>commit</code>å¯¹è±¡çš„å¯å˜æŒ‡é’ˆï¼Œè€Œ<code>Head</code>æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘ä½ æ­£åœ¨å·¥ä½œä¸­çš„æœ¬åœ°åˆ†æ”¯çš„æŒ‡é’ˆ</p><p>ç®€å•æ¥è®²ï¼Œå°±æ˜¯ä½ ç°åœ¨åœ¨å“ªå„¿ï¼ŒHEAD å°±æŒ‡å‘å“ªå„¿</p><p>ä¾‹å¦‚å½“å‰æˆ‘ä»¬å¤„äº<code>master</code>åˆ†æ”¯ï¼Œæ‰€ä»¥<code>HEAD</code>è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘äº†<code>master</code>åˆ†æ”¯æŒ‡é’ˆ</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/36cb0da0-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>ç„¶åé€šè¿‡è°ƒç”¨<code>git checkout test</code>åˆ‡æ¢åˆ°<code>test</code>åˆ†æ”¯ï¼Œé‚£ä¹ˆ<code>HEAD</code>åˆ™æŒ‡å‘<code>test</code>åˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3e86ba80-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>ä½†æˆ‘ä»¬åœ¨<code>test</code>åˆ†æ”¯å†ä¸€æ¬¡<code>commit</code>ä¿¡æ¯çš„æ—¶å€™ï¼Œ<code>HEAD</code>æŒ‡é’ˆä»ç„¶æŒ‡å‘äº†<code>test</code>åˆ†æ”¯æŒ‡é’ˆï¼Œè€Œ<code>test</code>åˆ†æ”¯æŒ‡é’ˆå·²ç»æŒ‡å‘äº†æœ€æ–°åˆ›å»ºçš„æäº¤ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/439839b0-fa66-11eb-991d-334fd31f0201.png" alt="img" style="zoom: 50%;"><p>è¿™ä¸ª<code>HEAD</code>å­˜å‚¨çš„ä½ç½®å°±åœ¨<code>.git/HEAD</code>ç›®å½•ä¸­ï¼ŒæŸ¥çœ‹ä¿¡æ¯å¯ä»¥çœ‹åˆ°<code>HEAD</code>æŒ‡å‘äº†å¦ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> .git/HEAD</span><br>ref: refs/heads/master<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> .git/refs/heads/master</span><br>7406a10efcc169bbab17827aeda189aa20376f7f<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹æ˜¯ä¸€ä¸²å“ˆå¸Œç ï¼Œè€Œè¿™ä¸ªå“ˆå¸Œç æ­£æ˜¯<code>master</code>åˆ†æ”¯ä¸Šæœ€æ–°çš„æäº¤æ‰€å¯¹åº”çš„å“ˆå¸Œç </p><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åˆ‡æ¢åˆ†æ”¯çš„æ—¶å€™ï¼Œ<code>HEAD</code>æŒ‡é’ˆé€šå¸¸æŒ‡å‘æˆ‘ä»¬æ‰€åœ¨çš„åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸ªåˆ†æ”¯ä¸Šåˆ›å»ºæ–°çš„æäº¤æ—¶ï¼Œåˆ†æ”¯æŒ‡é’ˆæ€»æ˜¯ä¼šæŒ‡å‘å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤</p><p>æ‰€ä»¥ï¼ŒHEAD æŒ‡é’ˆ â€”â€”â€“&gt; åˆ†æ”¯æŒ‡é’ˆ â€”â€”â€“&gt; æœ€æ–°æäº¤</p><h3 id="å·¥ä½œæ ‘å’Œç´¢å¼•"><a href="#å·¥ä½œæ ‘å’Œç´¢å¼•" class="headerlink" title="å·¥ä½œæ ‘å’Œç´¢å¼•"></a>å·¥ä½œæ ‘å’Œç´¢å¼•</h3><p>åœ¨<code>Git</code>ç®¡ç†ä¸‹ï¼Œå¤§å®¶å®é™…æ“ä½œçš„ç›®å½•è¢«ç§°ä¸º<strong>å·¥ä½œæ ‘</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å·¥ä½œåŒºåŸŸ</strong></p><p>åœ¨æ•°æ®åº“å’Œå·¥ä½œæ ‘ä¹‹é—´æœ‰ç´¢å¼•ï¼Œç´¢å¼•æ˜¯ä¸ºäº†å‘æ•°æ®åº“æäº¤ä½œå‡†å¤‡çš„åŒºåŸŸï¼Œä¹Ÿè¢«ç§°ä¸ºæš‚å­˜åŒºåŸŸ</p><p><code>Git</code>åœ¨æ‰§è¡Œæäº¤çš„æ—¶å€™ï¼Œä¸æ˜¯ç›´æ¥å°†å·¥ä½œæ ‘çš„çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè€Œæ˜¯å°†è®¾ç½®åœ¨ä¸­é—´ç´¢å¼•åŒºåŸŸçš„çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“</p><p>å› æ­¤ï¼Œè¦æäº¤æ–‡ä»¶ï¼Œé¦–å…ˆéœ€è¦æŠŠæ–‡ä»¶åŠ å…¥åˆ°ç´¢å¼•åŒºåŸŸä¸­ã€‚</p><p>æ‰€ä»¥ï¼Œå‡­å€Ÿä¸­é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é¿å…å·¥ä½œæ ‘ä¸­ä¸å¿…è¦çš„æ–‡ä»¶æäº¤ï¼Œè¿˜å¯ä»¥å°†æ–‡ä»¶ä¿®æ”¹å†…å®¹çš„ä¸€éƒ¨åˆ†åŠ å…¥ç´¢å¼•åŒºåŸŸå¹¶æäº¤</p><blockquote><p>å·¥ä½œæ ‘å°±æ˜¯å·¥ä½œåŒºï¼Œç´¢å¼•å°±æ˜¯æš‚å­˜åŒºï¼Œæ•°æ®åº“å°±æ˜¯æœ¬åœ°ä»“åº“</p></blockquote><h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p>ä»æ‰€åœ¨çš„ä½ç½®æ¥çœ‹ï¼š</p><ul><li>HEAD æŒ‡é’ˆé€šå¸¸æŒ‡å‘æˆ‘ä»¬æ‰€åœ¨çš„åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸ªåˆ†æ”¯ä¸Šåˆ›å»ºæ–°çš„æäº¤æ—¶ï¼Œåˆ†æ”¯æŒ‡é’ˆæ€»æ˜¯ä¼šæŒ‡å‘å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤</li><li>å·¥ä½œæ ‘æ˜¯æŸ¥çœ‹å’Œç¼–è¾‘çš„ï¼ˆæºï¼‰æ–‡ä»¶çš„å®é™…å†…å®¹</li><li>ç´¢å¼•æ˜¯æ”¾ç½®ä½ æƒ³è¦æäº¤ç»™ git ä»“åº“æ–‡ä»¶çš„åœ°æ–¹ï¼Œå¦‚å·¥ä½œæ ‘çš„ä»£ç é€šè¿‡ git add åˆ™æ·»åŠ åˆ° git ç´¢å¼•ä¸­ï¼Œé€šè¿‡ git commit åˆ™å°†ç´¢å¼•åŒºåŸŸçš„æ–‡ä»¶æäº¤åˆ° git ä»“åº“ä¸­</li></ul><h2 id="å¦‚ä½•ç†è§£git-checkout-â€“-fileå’Œgit-reset-HEAD-â€“-file"><a href="#å¦‚ä½•ç†è§£git-checkout-â€“-fileå’Œgit-reset-HEAD-â€“-file" class="headerlink" title="å¦‚ä½•ç†è§£git checkout â€“ fileå’Œgit reset HEAD â€“ file"></a>å¦‚ä½•ç†è§£git checkout â€“ fileå’Œgit reset HEAD â€“ file</h2><blockquote><p>å‚è€ƒï¼š<a href="https://www.liaoxuefeng.com/wiki/896043488029600/897889638509536">https://www.liaoxuefeng.com/wiki/896043488029600/897889638509536</a></p></blockquote><p>git checkout â€“ fileï¼šæ’¤é”€å¯¹å·¥ä½œåŒºä¿®æ”¹ï¼›è¿™ä¸ªå‘½ä»¤æ˜¯ä»¥æœ€æ–°çš„å­˜å‚¨æ—¶é—´èŠ‚ç‚¹ï¼ˆaddå’Œcommitï¼‰ä¸ºå‚ç…§ï¼Œè¦†ç›–å·¥ä½œåŒºå¯¹åº”æ–‡ä»¶fileï¼›è¿™ä¸ªå‘½ä»¤æ”¹å˜çš„æ˜¯<strong>å·¥ä½œåŒº</strong>ã€ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦æ’¤å›å·¥ä½œåŒºçš„å†…å®¹åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œ<strong>ä½†æ˜¯è¿˜æ²¡æœ‰</strong>git addæ·»åŠ åˆ°æš‚å­˜åŒºã€‘</p><p>git reset HEAD â€“ fileï¼šæ¸…ç©ºaddå‘½ä»¤å‘æš‚å­˜åŒºæäº¤çš„å…³äºfileæ–‡ä»¶çš„ä¿®æ”¹ï¼ˆUstageï¼‰ï¼›è¿™ä¸ªå‘½ä»¤ä»…æ”¹å˜<strong>æš‚å­˜åŒº</strong>ï¼Œå¹¶ä¸æ”¹å˜å·¥ä½œåŒºï¼Œè¿™æ„å‘³ç€åœ¨æ— ä»»ä½•å…¶ä»–æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå·¥ä½œåŒºä¸­çš„å®é™…æ–‡ä»¶åŒè¯¥å‘½ä»¤è¿è¡Œä¹‹å‰æ— ä»»ä½•æ”¹å˜ã€ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦æ’¤å›å·¥ä½œåŒºçš„å†…å®¹åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œ<strong>ä½†æ˜¯å·²ç»</strong>git addæ·»åŠ åˆ°æš‚å­˜åŒºã€‘</p><p>ğŸ­ <strong>æ€»ç»“ï¼š</strong></p><blockquote><p>åœºæ™¯1ï¼šå½“ä½ æ”¹ä¹±äº†å·¥ä½œåŒºæŸä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæƒ³ç›´æ¥ä¸¢å¼ƒå·¥ä½œåŒºçš„ä¿®æ”¹æ—¶ï¼Œç”¨å‘½ä»¤<code>git checkout -- file</code>ã€‚</p><p>åœºæ™¯2ï¼šå½“ä½ ä¸ä½†æ”¹ä¹±äº†å·¥ä½œåŒºæŸä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œè¿˜æ·»åŠ åˆ°äº†æš‚å­˜åŒºæ—¶ï¼Œæƒ³ä¸¢å¼ƒä¿®æ”¹ï¼Œåˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ç”¨å‘½ä»¤<code>git reset HEAD &lt;file&gt;</code>ï¼Œå°±å›åˆ°äº†åœºæ™¯1ï¼Œç¬¬äºŒæ­¥æŒ‰åœºæ™¯1æ“ä½œã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Gitå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå†…æ ¸ç¼–è¯‘</title>
    <link href="/2023/03/22/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/"/>
    <url>/2023/03/22/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸ç¼–è¯‘"><a href="#Linuxå†…æ ¸ç¼–è¯‘" class="headerlink" title="Linuxå†…æ ¸ç¼–è¯‘"></a>Linuxå†…æ ¸ç¼–è¯‘</h1><h2 id="1-linuxå†…æ ¸ä¸­Makefileã€Kconfigã€-configçš„å…³ç³»"><a href="#1-linuxå†…æ ¸ä¸­Makefileã€Kconfigã€-configçš„å…³ç³»" class="headerlink" title="1.linuxå†…æ ¸ä¸­Makefileã€Kconfigã€.configçš„å…³ç³»"></a>1.linuxå†…æ ¸ä¸­Makefileã€Kconfigã€.configçš„å…³ç³»</h2><p><strong>ä¸‰è€…çš„ä½œç”¨ï¼š</strong></p><ul><li>Makefileï¼šä¸€ä¸ªæ–‡æœ¬å½¢å¼çš„æ–‡ä»¶ï¼Œç¼–è¯‘æºæ–‡ä»¶çš„æ–¹æ³•ã€‚</li><li>Kconfigï¼šä¸€ä¸ªæ–‡æœ¬å½¢å¼çš„æ–‡ä»¶ï¼Œå†…æ ¸çš„é…ç½®èœå•ã€‚</li><li>.configï¼šç¼–è¯‘æ‰€ä¾æ®çš„é…ç½®</li></ul><p><strong>ä¸‰è€…çš„å…³ç³»ï¼š</strong></p><p>ç®€å•æ¥è¯´å°±æ˜¯å»é¥­åº—ç‚¹èœï¼šKconfigæ˜¯èœå•ï¼ŒMakefileæ˜¯åšæ³•ï¼Œ.configå°±æ˜¯ä½ ç‚¹çš„èœã€‚åœ¨è¿è¡Œmake menuconfigååœ¨é…ç½®ç•Œé¢ä¸­å‡ºç°çš„å°±æ˜¯Kconfigä¸­çš„é€‰é¡¹ï¼Œåœ¨ç•Œé¢ä¸­çœ‹åˆ°çš„å·²ç»é…ç½®å¥½çš„é€‰é¡¹å°±æ˜¯ä».configä¸­è¯»å–å‡ºæ¥çš„ï¼Œå½“é…ç½®å®Œæˆåå°±ä¼šå°†é…ç½®é‡æ–°ä¿å­˜åˆ°.configä¸­ï¼Œç¼–è¯‘æ—¶makefileä¼šè¯»å–.configä¸­é…ç½®æ¥å¯¹å†…æ ¸è¿›è¡Œç¼–è¯‘ã€‚</p><blockquote><ol><li>å¦‚æœ.configä¸å­˜åœ¨ï¼Œè¿è¡Œmake config&#x2F;menuconfigæ—¶çš„ç¼ºçœè®¾ç½®ç”±å›ºåŒ–åœ¨å„ä¸ªKconfigæ–‡ä»¶ä¸­å„é¡¹ç›®çš„ç¼ºçœå€¼å†³å®šã€‚</li><li>å¦‚æœ.configå­˜åœ¨ï¼Œè¿è¡Œmake config&#x2F;menuconfigæ—¶çš„ç¼ºçœè®¾ç½®å³æ˜¯å½“å‰.configçš„è®¾ç½®ï¼Œè‹¥å¯¹è®¾ç½®è¿›è¡Œäº†ä¿®æ”¹ï¼Œ<code>.config</code>å°†è¢«æ›´æ–°ã€‚</li><li>arch&#x2F;arm&#x2F;defconfigæ˜¯ä¸€ä¸ªç¼ºçœçš„é…ç½®æ–‡ä»¶ï¼Œmake defconfigæ—¶ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶ç”Ÿæˆå½“å‰çš„.configã€‚</li><li>arch&#x2F;arm&#x2F;configsæ–‡ä»¶å¤¹ä¸­æœ‰è®¸å¤šå‘½åä¸ºxxx_defconfigçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœè¿è¡Œmake xxx_defconfigï¼Œå½“å‰.configæ–‡ä»¶ä¼šç”±xxx_defconfigæ–‡ä»¶ç”Ÿæˆã€‚</li></ol></blockquote><p>ğŸ¼ <strong>æ€»ç»“ä¸€ä¸‹</strong></p><p>æ‰§è¡Œ<code>make xxx_defconfig</code>ç”Ÿæˆ.configæ–‡ä»¶</p><p>æ‰§è¡Œ<code>make menuconfig</code>å¯ä»¥ä¿®æ”¹.configæ–‡ä»¶ã€‚</p><h2 id="2-æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«"><a href="#2-æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«" class="headerlink" title="2.æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«"></a>2.æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«</h2><p>åœ¨è¿›è¡Œæ¨¡å—ç¼–è¯‘æ—¶ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œobj-må’Œobj-yï¼Œè€Œä¸å†…æ ¸å¯†åˆ‡ç›¸å…³çš„æ˜¯obj-yé€‰é¡¹ï¼Œä¸‹é¢å¯¹ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚</p><p>ä»¥test.cæ–‡ä»¶ä¸ºä¾‹ï¼š</p><p>obj-m +&#x3D; test.o</p><p>obj-y  +&#x3D; test.o</p><p>å…¶ä¸­:</p><ul><li><p>obj-mè¡¨ç¤ºæŠŠæ–‡ä»¶test.oä½œä¸ºâ€æ¨¡å—â€è¿›è¡Œç¼–è¯‘ï¼Œä¸ä¼šç¼–è¯‘åˆ°å†…æ ¸ï¼Œä½†æ˜¯ä¼šç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ â€œtest.koâ€ æ–‡ä»¶ã€‚</p></li><li><p>obj-yè¡¨ç¤ºæŠŠtest.oæ–‡ä»¶ç¼–è¯‘è¿›å†…æ ¸</p></li></ul><h2 id="3-Kernelä¸­Makefileçš„è¯­æ³•"><a href="#3-Kernelä¸­Makefileçš„è¯­æ³•" class="headerlink" title="3.Kernelä¸­Makefileçš„è¯­æ³•"></a>3.Kernelä¸­Makefileçš„è¯­æ³•</h2><p>1ï¼‰ç›´æ¥ç¼–è¯‘</p><p>obj-y &#x3D; led.o</p><p>2ï¼‰æ¡ä»¶ç¼–è¯‘</p><p>obj-$(CONFIG_RAPIDIO) +&#x3D; rapidio.o</p><p>3ï¼‰ç¼–è¯‘ç›®å½•ï¼š</p><p>obj-$(CONFIG_ISCSI_TARGET)  +&#x3D; iscsi&#x2F;</p><h2 id="4-Kernelä¸­Kconfigçš„è¯­æ³•"><a href="#4-Kernelä¸­Kconfigçš„è¯­æ³•" class="headerlink" title="4.Kernelä¸­Kconfigçš„è¯­æ³•"></a>4.Kernelä¸­Kconfigçš„è¯­æ³•</h2><blockquote><p> å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/crXt-6EvKtWg9QX7SM90Sw">https://mp.weixin.qq.com/s/crXt-6EvKtWg9QX7SM90Sw</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android Såˆ›å»ºé€»è¾‘åˆ†åŒº</title>
    <link href="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/"/>
    <url>/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-Såˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#Android-Såˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="Android Såˆ›å»ºé€»è¾‘åˆ†åŒº"></a>Android Såˆ›å»ºé€»è¾‘åˆ†åŒº</h1><p>ä»å®‰å“æ¨¡æ‹Ÿå™¨çœ‹æ¥ï¼Œsuperè®¾å¤‡å¯¹åº”çš„çœŸå®å—è®¾å¤‡ä¸º<code>/dev/block/vda2</code></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230318233940020.png" alt="image-20230318233940020" style="zoom:80%;"><p>ä»çœŸå®æ¨¡æ‹Ÿå™¨è¿è¡Œç¯å¢ƒæ¥çœ‹ï¼Œsuperæ€»å…±åˆ†ä¸ºäº†å››ä¸ªåˆ†åŒºsystemã€vendorã€productã€system_extã€å…¶ä¸­<strong>system</strong>åˆ†åŒºç”±äº<strong>system as root</strong>æœºåˆ¶ä½œä¸ºäº†rootfsè¿›è¡ŒæŒ‚è½½ã€‘</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230318234134317.png" alt="image-20230318234134317" style="zoom: 80%;"><p>å¦å¤–ä»ç½‘ä¸Šæ‰¾åˆ°ä¸€ä»½çœŸå®Android Så¯åŠ¨æ—¥å¿—ï¼š</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230322203850415.png" alt="image-20230322203850415" style="zoom:80%;"><p>ğŸ¤–ä»çœŸå®å¯åŠ¨æ—¥å¿—æ¥çœ‹ï¼Œé‚£ä¹ˆ<strong>ä¸ºä»€ä¹ˆè¿™ä¸ªdmè®¾å¤‡æ€ä¹ˆæ¥çš„ï¼Ÿä¸ºä»€ä¹ˆdm-0æ˜¯system_aè€Œä¸æ˜¯vendor_aå‘¢ï¼Ÿ</strong></p><p>æˆ‘ä»¬è¦å¸¦ç€è¿™äº›é—®é¢˜å»æ€è€ƒï¼Œä¸€æ­¥æ­¥é˜…è¯»æºç ï¼Œè§£å†³è‡ªå·±çš„ç–‘æƒ‘â€¦â€¦</p><h2 id="1-æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata"><a href="#1-æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata" class="headerlink" title="1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata"></a>1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata</h2><blockquote><p>è¿™é‡Œå¼•ç”¨<strong>æ´›å¥‡çœ‹ä¸–ç•Œ</strong>å¤§å“¥ç”»çš„ç²¾ç¾ç¤ºæ„å›¾ï¼š<a href="https://blog.csdn.net/guyongqiangx/article/details/123899602">https://blog.csdn.net/guyongqiangx/article/details/123899602</a></p></blockquote><ul><li>superæ•´ä½“åˆ†åŒºå¸ƒå±€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</li></ul><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/086bef9593e0494a90d27eef2e071bae.png" alt="image-20230318234134317" style="zoom: 80%;"><ul><li>superåˆ†åŒºä¸­çš„metadataå¦‚ä¸‹ï¼š</li></ul><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/4ff675e237df41ed9c7d4809bed4d758.png" alt="image-20230318234134317" style="zoom: 67%;"><p>metadataå¯¹åº”çš„æ•°æ®ç»“æ„ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\liblp.h</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadata</span> &#123;<br>    LpMetadataGeometry geometry;<br>    LpMetadataHeader header;<br>    std::vector&lt;LpMetadataPartition&gt; partitions;<br>    std::vector&lt;LpMetadataExtent&gt; extents;<br>    std::vector&lt;LpMetadataPartitionGroup&gt; groups;<br>    std::vector&lt;LpMetadataBlockDevice&gt; block_devices;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢é…åˆå…·ä½“ä»superåˆ†åŒºä¸­æŠ“å–çš„æ•°æ®è§£æã€‚</p><p>å‘½ä»¤ï¼š<code>dd if=/dev/block/platform/soc/7824900.sdhci/by-name/super bs=4096 count=1048576 of=/data/super.data</code></p><blockquote><p>ä¸‹é¢å¼•ç”¨ï¼š<a href="https://blog.csdn.net/weixin_43899302/article/details/119343835?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_43899302/article/details/119343835?spm=1001.2014.3001.5506</a></p></blockquote><h3 id="1-1-LpMetadataGeometry"><a href="#1-1-LpMetadataGeometry" class="headerlink" title="1.1 LpMetadataGeometry"></a>1.1 LpMetadataGeometry</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataGeometry</span> &#123;<br>    <span class="hljs-type">uint32_t</span> magic;<br>    <span class="hljs-type">uint32_t</span> struct_size;<br>    <span class="hljs-type">uint8_t</span> checksum[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">uint32_t</span> metadata_max_size;<br>    <span class="hljs-type">uint32_t</span> metadata_slot_count;<br>    <span class="hljs-type">uint32_t</span> logical_block_size;<br>&#125; __attribute__((packed)) LpMetadataGeometry;<br></code></pre></td></tr></table></figure><p>å› ä¸ºmetadata.imgå‰é¢é¢„ç•™äº†4KBï¼ˆ4096Byteï¼‰ï¼Œæ‰€ä»¥åç§»ä½ç½®ä¸º<strong>0x1000h</strong></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/28872ef9b62844a5b49c0caa07658ff6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><blockquote><p>å‰32ä½ï¼ˆ4å­—èŠ‚ï¼‰ä¸ºMetadataGeometryçš„Magicï¼Œåœ¨ä»£ç ä¸­ä¼šè¿›è¡Œæ ¡éªŒé­”æœ¯å­—LP_METADATA_GEOMETRY_MAGIC</p><p>â˜ƒï¸<strong>ä¸€å®šæ³¨æ„ï¼šçœ‹é•œåƒçš„16è¿›åˆ¶éƒ½æ˜¯å°ç«¯æ¨¡å¼</strong></p><p>ä¾æ¬¡ç±»æ¨ï¼Œåé¢0x0000034è¡¨ç¤º32ä½çš„å˜é‡struct_size</p><p>æ‰€ä»¥æœ€ç»ˆè¿™äº›<strong>metadata.img</strong>ä¸­çš„æ•°æ®éƒ½ä¼šä¸€ä¸€æŒ‰ä½è¯»å–åˆ°ç»“æ„ä½“LpMetadataGeometry</p></blockquote><p>åœ¨åˆ›å»ºsuperåˆ†åŒºçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<strong>ParseGeometry</strong>å»è¿›è¡Œè§£æ<strong>LpMetadataGeometry</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LP_METADATA_GEOMETRY_MAGIC 0x616c4467</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ParseGeometry</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* buffer, LpMetadataGeometry* geometry)</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(*geometry) &lt;= LP_METADATA_GEOMETRY_SIZE);<br>    <span class="hljs-built_in">memcpy</span>(geometry, buffer, <span class="hljs-built_in">sizeof</span>(*geometry));<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;magic != LP_METADATA_GEOMETRY_MAGIC) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid geometry magic signature.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;struct_size &gt; <span class="hljs-built_in">sizeof</span>(LpMetadataGeometry)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has unrecognized fields.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    &#123;<br>        LpMetadataGeometry temp = *geometry;<br>        <span class="hljs-built_in">memset</span>(&amp;temp.checksum, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(temp.checksum));<br>        <span class="hljs-built_in">SHA256</span>(&amp;temp, temp.struct_size, temp.checksum);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(temp.checksum, geometry-&gt;checksum, <span class="hljs-built_in">sizeof</span>(temp.checksum)) != <span class="hljs-number">0</span>) &#123;<br>            LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid geometry checksum.&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;struct_size != <span class="hljs-built_in">sizeof</span>(LpMetadataGeometry)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid struct size.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (geometry-&gt;metadata_slot_count == <span class="hljs-number">0</span>) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid slot count.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (geometry-&gt;metadata_max_size % LP_SECTOR_SIZE != <span class="hljs-number">0</span>) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Metadata max size is not sector-aligned.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-LpMetadataHeader"><a href="#1-2-LpMetadataHeader" class="headerlink" title="1.2 LpMetadataHeader"></a>1.2 LpMetadataHeader</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataHeader</span> &#123;<br>    <span class="hljs-type">uint32_t</span> magic;<br>    <span class="hljs-type">uint16_t</span> major_version;<br>    <span class="hljs-type">uint16_t</span> minor_version;<br>    <span class="hljs-type">uint32_t</span> header_size;<br>    <span class="hljs-type">uint8_t</span> header_checksum[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">uint32_t</span> tables_size;<br>    <span class="hljs-type">uint8_t</span> tables_checksum[<span class="hljs-number">32</span>];<br>    LpMetadataTableDescriptor partitions;<br>    LpMetadataTableDescriptor extents;<br>    LpMetadataTableDescriptor groups;<br>    LpMetadataTableDescriptor block_devices;<br>&#125; __attribute__((packed)) LpMetadataHeader;<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataTableDescriptor</span> &#123;<br>    <span class="hljs-type">uint32_t</span> offset;<br>    <span class="hljs-type">uint32_t</span> num_entries;<br>    <span class="hljs-type">uint32_t</span> entry_size;<br>&#125; __attribute__((packed)) LpMetadataTableDescriptor;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/fc1dd4f8828e4e279906e52bd4417f7a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h3 id="1-3-LpMetadataPartition"><a href="#1-3-LpMetadataPartition" class="headerlink" title="1.3 LpMetadataPartition"></a>1.3 LpMetadataPartition</h3><p>è¿™ä¸ªå°±æ˜¯è¡¨ç¤ºsuperä¸­çš„ä¸€ä¸ªä¸ªé€»è¾‘åˆ†åŒºæ‰€æœ‰çš„å­—æ®µï¼Œæ¯”å¦‚è¯´nameè¡¨ç¤ºé€»è¾‘åˆ†åŒºåï¼Œattributesè¡¨ç¤ºé€»è¾‘åˆ†åŒºå±æ€§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataPartition</span> &#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">36</span>];<br>    <span class="hljs-type">uint32_t</span> attributes;<br>    <span class="hljs-type">uint32_t</span> first_extent_index;<br>    <span class="hljs-type">uint32_t</span> num_extents;<br>    <span class="hljs-type">uint32_t</span> group_index;<br>&#125; __attribute__((packed)) LpMetadataPartition;<br><br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/e3b51aa1d6f94b66a78618b135853e75.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‰é¢çš„36å­—èŠ‚è¡¨ç¤ºçš„é€»è¾‘åˆ†åŒºåï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè¡¨ç¤ºçš„æ˜¯<strong>system</strong></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230320234029590.png" alt="image-20230320234029590" style="zoom:80%;"><h3 id="1-4-LpMetadataExtent"><a href="#1-4-LpMetadataExtent" class="headerlink" title="1.4 LpMetadataExtent"></a>1.4 LpMetadataExtent</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataExtent</span> &#123;<br>    <span class="hljs-type">uint64_t</span> num_sectors;<br>    <span class="hljs-type">uint32_t</span> target_type;<br>    <span class="hljs-type">uint64_t</span> target_data;<br>    <span class="hljs-type">uint32_t</span> target_source;<br>&#125; __attribute__((packed)) LpMetadataExtent;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/02bdee1d427e444ab4e2d8b2416591fe.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h3 id="1-5-LpMetadataPartitionGroup"><a href="#1-5-LpMetadataPartitionGroup" class="headerlink" title="1.5 LpMetadataPartitionGroup"></a>1.5 LpMetadataPartitionGroup</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataPartitionGroup</span> &#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">36</span>];<br>    <span class="hljs-type">uint32_t</span> flags;<br>    <span class="hljs-type">uint64_t</span> maximum_size;<br>&#125; __attribute__((packed)) LpMetadataPartitionGroup;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/0ea2cc17e450475396458ff4843f7a78.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h3 id="1-6-LpMetadataBlockDevice"><a href="#1-6-LpMetadataBlockDevice" class="headerlink" title="1.6 LpMetadataBlockDevice"></a>1.6 LpMetadataBlockDevice</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataBlockDevice</span> &#123;<br>    <span class="hljs-type">uint64_t</span> first_logical_sector;<br>    <span class="hljs-type">uint32_t</span> alignment;<br>    <span class="hljs-type">uint32_t</span> alignment_offset;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">char</span> partition_name[<span class="hljs-number">36</span>];<br>    <span class="hljs-type">uint32_t</span> flags;<br>&#125; __attribute__((packed)) LpMetadataBlockDevice;<br><br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/9d54d69d1fe943458fe819d4edfa5bb8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom100%;"><h2 id="2-Device-Mapperæœºåˆ¶ç®€ä»‹"><a href="#2-Device-Mapperæœºåˆ¶ç®€ä»‹" class="headerlink" title="2.Device Mapperæœºåˆ¶ç®€ä»‹"></a>2.Device Mapperæœºåˆ¶ç®€ä»‹</h2><blockquote><p>å‚è€ƒ<strong>å†…æ ¸å·¥åŒ </strong>çš„<a href="https://blog.csdn.net/feelabclihu/article/details/106581248?spm=1001.2014.3001.5506">DeviceMapperæ¶æ„åŠåœ¨androidä¸Šçš„åº”ç”¨</a></p></blockquote><p>Device Mapperæ˜¯Linux2.6 å†…æ ¸ä¸­æ”¯æŒé€»è¾‘å·ç®¡ç†çš„é€šç”¨è®¾å¤‡æ˜ å°„æœºåˆ¶ï¼Œå®ƒä¸ºå®ç°ç”¨äºå­˜å‚¨èµ„æºç®¡ç†çš„å—è®¾å¤‡é©±åŠ¨æä¾›äº†ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–çš„å†…æ ¸æ¶æ„ã€‚</p><p>Device Mapperå°†æ‰€æœ‰ä¸ç­–ç•¥ç›¸å…³çš„å·¥ä½œæ”¾åˆ°ç”¨æˆ·ç©ºé—´å®Œæˆï¼Œå†…æ ¸ä¸­ä¸»è¦æä¾›å®Œæˆè¿™äº›ç­–ç•¥æ‰€éœ€è¦çš„æœºåˆ¶ã€‚ç”¨æˆ·ç©ºé—´éƒ¨åˆ†è´£é…ç½®å…·ä½“çš„ç­–ç•¥å’Œæ§åˆ¶é€»è¾‘ï¼Œæ¯”å¦‚é€»è¾‘è®¾å¤‡å’Œå“ªäº›ç‰©ç†è®¾å¤‡å»ºç«‹æ˜ å°„ï¼Œæ€ä¹ˆå»ºç«‹è¿™äº›æ˜ å°„å…³ç³»ç­‰ï¼Œè€Œå…·ä½“é‡å®šå‘ IO è¯·æ±‚çš„å·¥ä½œç”±å†…æ ¸ä¸­ç›¸å…³ä»£ç å®Œæˆã€‚</p><p>å†…æ ¸ä¸­ç›¸å…³ä»£ç åœ¨å†…æ ¸æºç çš„ kernel&#x2F;driver&#x2F;md&#x2F; ç›®å½•ä¸­ï¼Œå…¶ä»£ç æ–‡ä»¶å¯ä»¥åˆ’åˆ†ä¸ºå®ç°device mapper å†…æ ¸ä¸­åŸºæœ¬æ¶æ„çš„æ–‡ä»¶(ä¾‹å¦‚ï¼šdm.c dm_table.cç­‰)å’Œå®ç°å…·ä½“æ˜ å°„å·¥ä½œçš„ target driver æ’ä»¶æ–‡ä»¶(ä¾‹å¦‚ï¼šdm-bow.c dm-crypt.c dm-linear.cç­‰)ä¸¤éƒ¨åˆ†ã€‚</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/format.png" style="zoom:80%;"><p>å®ƒåŒ…å«ä¸‰ä¸ªé‡è¦çš„å¯¹è±¡æ¦‚å¿µï¼ŒMapped Deviceã€Mapping Tableã€Target deviceã€‚</p><ul><li><strong>Mapped Device</strong>ï¼šæ˜¯ä¸€ä¸ªæŠ½è±¡çš„é€»è¾‘è®¾å¤‡ï¼Œé€šè¿‡MappingTableæè¿°çš„æ˜ å°„å…³ç³»ï¼ˆMapped Device é€»è¾‘çš„èµ·å§‹åœ°å€ã€èŒƒå›´ã€å’Œè¡¨ç¤ºåœ¨ Target Device æ‰€åœ¨ç‰©ç†è®¾å¤‡çš„åœ°å€åç§»é‡ä»¥åŠTarget ç±»å‹ç­‰ä¿¡æ¯ï¼‰å’ŒTarget Deviceå»ºç«‹æ˜ å°„å…³ç³»ã€‚</li><li><strong>Target Device</strong>ï¼šæ˜¯Mapped Deviceæ‰€æ˜ å°„çš„ç‰©ç†ç©ºé—´æ®µã€‚</li><li><strong>Mapping Table</strong>ï¼šDeviceMapperåœ¨å†…æ ¸ä¸­é€šè¿‡ä¸€ä¸ªä¸€ä¸ªæ¨¡å—åŒ–çš„ Target Driver æ’ä»¶å®ç°å¯¹ IO è¯·æ±‚çš„è¿‡æ»¤æˆ–è€…é‡æ–°å®šå‘ç­‰å·¥ä½œï¼Œå½“å‰å·²ç»å®ç°çš„æ’ä»¶åŒ…æ‹¬ï¼šdm-cryptã€dm-linearã€dm-verityã€dm-bowã€dm-raidç­‰ã€‚</li></ul><p>Device mapper ä¸­è¿™ä¸‰ä¸ªå¯¹è±¡å’Œ target driver æ’ä»¶ä¸€èµ·æ„æˆäº†ä¸€ä¸ªå¯è¿­ä»£çš„è®¾å¤‡æ ‘ã€‚è¯¥å±‚æ¬¡åœ¨ç†è®ºä¸Šå¯ä»¥åœ¨ device mapper æ¶æ„ä¸‹æ— é™è¿­ä»£ä¸‹å»ã€‚</p><h3 id="2-1-æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#2-1-æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="2.1 æ ¸å¿ƒæ•°æ®ç»“æ„"></a>2.1 æ ¸å¿ƒæ•°æ®ç»“æ„</h3><ul><li><strong>mapped_device</strong> ï¼šåœ¨dm.c æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥ç»“æ„ç”¨äºè¡¨ç¤º mapped deviceï¼Œå®ƒä¸»è¦åŒ…æ‹¬è¯¥ mapped device ç›¸å…³çš„é”ï¼Œæ³¨å†Œçš„è¯·æ±‚é˜Ÿåˆ—å’Œä¸€äº›å†…å­˜æ± ä»¥åŠæŒ‡å‘å®ƒæ‰€å¯¹åº”æ˜ å°„è¡¨çš„æŒ‡é’ˆç­‰åŸŸã€‚</li><li><strong>dm_table</strong>ï¼šåœ¨æ–‡ä»¶dm_table.c æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥ç»“æ„ä¸­åŒ…å«ä¸€ä¸ª dm_targetç»“æ„æ•°ç»„ï¼Œdm_target ç»“æ„å…·ä½“æè¿°äº† mapped_device åˆ°å®ƒæŸä¸ª target device çš„æ˜ å°„å…³ç³»ã€‚è€Œåœ¨ dm_table ç»“æ„ä¸­å°†è¿™äº› dm_target æŒ‰ç…§ B æ ‘çš„æ–¹å¼ç»„ç»‡èµ·æ¥æ–¹ä¾¿ IO è¯·æ±‚æ˜ å°„æ—¶çš„æŸ¥æ‰¾æ“ä½œã€‚dm_target ç»“æ„å…·ä½“è®°å½•è¯¥ç»“æ„å¯¹åº” target device æ‰€æ˜ å°„çš„ mapped device é€»è¾‘åŒºåŸŸçš„å¼€å§‹åœ°å€å’ŒèŒƒå›´ï¼ŒåŒæ—¶è¿˜åŒ…å«æŒ‡å‘å…·ä½“ target device ç›¸å…³æ“ä½œçš„ target_type ç»“æ„çš„æŒ‡é’ˆã€‚</li><li><strong>target_type</strong>ï¼šè¯¥ç»“æ„ä¸»è¦åŒ…å«äº† target device å¯¹åº”çš„ target driver æ’ä»¶çš„åå­—ã€å®šä¹‰çš„æ„å»ºå’Œåˆ é™¤è¯¥ç±»å‹target deviceçš„æ–¹æ³•ã€è¯¥ç±»target deviceå¯¹åº”çš„IOè¯·æ±‚é‡æ˜ å°„å’Œç»“æŸIOçš„æ–¹æ³•ç­‰ã€‚è€Œè¡¨ç¤ºå…·ä½“çš„target deviceçš„åŸŸæ˜¯dm_targetä¸­çš„privateåŸŸï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘mapped deviceæ‰€æ˜ å°„çš„å…·ä½“target deviceå¯¹åº”çš„ç»“æ„ã€‚è¡¨ç¤ºtarget deviceçš„å…·ä½“ç»“æ„ç”±äºä¸åŒçš„target ç±»å‹è€Œä¸åŒã€‚</li></ul><p>å¼€å‘è€…å¯ä»¥å®šåˆ¶device targetéƒ¨åˆ†ï¼Œä»¥å®ç°è‡ªå·±æ‰€éœ€è¦çš„éœ€æ±‚åŠŸèƒ½ã€‚</p><h3 id="2-2-ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹"><a href="#2-2-ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹" class="headerlink" title="2.2 ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹"></a>2.2 <strong>ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹</strong></h3><p>é€šè¿‡ä¸‹è¿°çš„ä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼Œdevice mapperåœ¨å†…æ ¸ä¸­å°±å»ºç«‹ä¸€ä¸ªå¯ä»¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„mapped deviceé€»è¾‘å—è®¾å¤‡ã€‚</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/device-mapper.png"><h2 id="3-æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#3-æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="3.æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº"></a>3.æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº</h2><h3 id="3-1-å¼€å§‹æŒ‚è½½"><a href="#3-1-å¼€å§‹æŒ‚è½½" class="headerlink" title="3.1 å¼€å§‹æŒ‚è½½"></a>3.1 å¼€å§‹æŒ‚è½½</h3><p>ğŸ¼ å…³äºç¬¬ä¸€é˜¶æ®µæŒ‚è½½çš„æµç¨‹å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„<a href="https://blog.csdn.net/stephen_curry300/article/details/126110983?spm=1001.2014.3001.5501">CSDNåšå®¢</a></p><p>æŒ‚è½½çš„å…¥å£å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// è·¯å¾„: /system/core/init/first_stage_mount.cpp</span><br><span class="hljs-comment">// åœ¨è®¾å¤‡æ ‘ä¸­æŒ‚è½½ç”±fstabæ–‡ä»¶æŒ‡å®šçš„åˆ†åŒº</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DoFirstStageMount</span><span class="hljs-params">(<span class="hljs-type">bool</span> create_devices)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> fsm = FirstStageMount::<span class="hljs-built_in">Create</span>();<br>    <span class="hljs-keyword">return</span> (*fsm)-&gt;<span class="hljs-built_in">DoFirstStageMount</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FirstStageMount::DoFirstStageMount</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">MountPartitions</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨MountPartitionså»æŒ‚è½½åˆ†åŒº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\first_stage_mount.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FirstStageMount::CreateLogicalPartitions</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// éå†è¯»å–åˆ°çš„fstabä¸­flagä¸­æ˜¯å¦å«æœ‰logical</span><br>    <span class="hljs-comment">// å¦‚æœæœ‰ï¼Œåˆ™æ”¯æŒDmLinear</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsDmLinearEnabled</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å¯¹åº”3.2 è¯»å–å…ƒæ•°æ®</span><br>    <span class="hljs-keyword">auto</span> metadata = android::fs_mgr::<span class="hljs-built_in">ReadCurrentMetadata</span>(super_path_);<br><br>    <span class="hljs-comment">// TODO...</span><br>    <span class="hljs-keyword">return</span> android::fs_mgr::<span class="hljs-built_in">CreateLogicalPartitions</span>(*metadata.<span class="hljs-built_in">get</span>(), super_path_);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-è¯»å–å…ƒæ•°æ®"><a href="#3-2-è¯»å–å…ƒæ•°æ®" class="headerlink" title="3.2 è¯»å–å…ƒæ•°æ®"></a>3.2 è¯»å–å…ƒæ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\fs_mgr_dm_linear.cpp</span><br><span class="hljs-comment">// ä¼ è¿›æ¥çš„block_deviceæ˜¯superåˆ†åŒºå¯¹åº”çš„çœŸå®çš„å—è®¾å¤‡ï¼ˆå‡è®¾ä¸º/dev/block/mmcblk0p5ï¼‰</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadCurrentMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; block_device)</span> </span>&#123;<br>    <span class="hljs-comment">// fs_mgr_get_slot_suffixè·å–ç¯å¢ƒå˜é‡ro.boot.slot_suffix</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰å¯åŠ¨åˆ†åŒºä¸º_aï¼Œåˆ™slot=0</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰å¯åŠ¨åˆ†åŒºä¸º_bï¼Œåˆ™slot=1</span><br>    <span class="hljs-type">uint32_t</span> slot = <span class="hljs-built_in">SlotNumberForSlotSuffix</span>(<span class="hljs-built_in">fs_mgr_get_slot_suffix</span>());<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReadMetadata</span>(block_device.<span class="hljs-built_in">c_str</span>(), slot);<br>&#125;<br><br><span class="hljs-comment">// ä¼ è¿›æ¥çš„super_partitionæ˜¯/dev/block/mmcblk0p5</span><br><span class="hljs-comment">// å‡è®¾å¯åŠ¨åˆ†åŒºä¸º_aï¼Œslot_numberä¸º0</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; super_partition, <span class="hljs-type">uint32_t</span> slot_number)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReadMetadata</span>(<span class="hljs-built_in">PartitionOpener</span>(), super_partition, slot_number);<br>&#125;<br><br><span class="hljs-comment">// --------------------------------------------------------------</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> IPartitionOpener&amp; opener,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         <span class="hljs-type">const</span> std::string&amp; super_partition, <span class="hljs-type">uint32_t</span> slot_number)</span> </span>&#123;<br>    android::base::unique_fd fd = opener.<span class="hljs-built_in">Open</span>(super_partition, O_RDONLY);<br><br>    LpMetadataGeometry geometry;<br>    <span class="hljs-comment">// è¯»å–/dev/block/mmcblk0p5ä¸­çš„å…ƒæ•°æ®</span><br>    <span class="hljs-comment">// è¯»çš„æ˜¯1.1èŠ‚ä¸­çš„LpMetadataGeometryæ•°æ®ç»“æ„ï¼Œå°†å…¶ä¿å­˜åˆ°geometry</span><br>    <span class="hljs-comment">// ç›®çš„æ˜¯ç›´æ¥èµ‹å€¼ç»™ä¸‹é¢å³å°†åˆ›å»ºçš„å˜é‡metaçš„æˆå‘˜å˜é‡geometry</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadLogicalPartitionGeometry</span>(fd, &amp;geometry)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    std::unique_ptr&lt;LpMetadata&gt; metadata;<br><br>    <span class="hljs-comment">// è¯»å–/dev/block/mmcblk0p5ä¸­çš„æ‰€æœ‰çš„å…ƒæ•°æ®</span><br>    <span class="hljs-comment">// å°†å…¶ä¿å­˜åˆ°metadataå˜é‡ä¸­ï¼Œæœ€åè¿”å›3.1ä¸­æœ€åˆè°ƒç”¨ReadCurrentMetadataçš„åœ°æ–¹</span><br>    <span class="hljs-comment">// æ‰€æœ‰çš„metadataç»“æ„éƒ½æ˜¯æŒ‰ç…§1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadataåˆ†å¸ƒçš„</span><br>    metadata = <span class="hljs-built_in">ParseMetadata</span>(geometry, fd)<br>    <br>    <span class="hljs-keyword">return</span> metadata;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="3-3-åˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#3-3-åˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="3.3 åˆ›å»ºé€»è¾‘åˆ†åŒº"></a>3.3 åˆ›å»ºé€»è¾‘åˆ†åŒº</h3><p><strong>3.2èŠ‚å’Œ3.3èŠ‚æ˜¯ç‹¬ç«‹çš„ï¼Œä¸¤èŠ‚éƒ½æ˜¯3.1çš„å­ç¯‡ï¼Œä¸è¦çº¿æ€§é˜…è¯»</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartitions</span><span class="hljs-params">(<span class="hljs-type">const</span> LpMetadata&amp; metadata, <span class="hljs-type">const</span> std::string&amp; super_device)</span> </span>&#123;<br>    CreateLogicalPartitionParams params = &#123;<br>            .block_device = super_device,<br>            .metadata = &amp;metadata,<br>    &#125;;<br>    <span class="hljs-comment">// è¿™é‡Œçš„metadata.partitionsæ˜¯1.3èŠ‚çš„LpMetadataPartition</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; partition : metadata.partitions) &#123;<br>        params.partition = &amp;partition;<br><br>        std::string ignore_path;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateLogicalPartition</span>(params, &amp;ignore_path)) &#123;<br>            LERROR &lt;&lt; <span class="hljs-string">&quot;Could not create logical partition: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetPartitionName</span>(partition);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šéå†metadataä¸­å­˜å‚¨çš„partitionsæˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯metadata.imgä¸­å­˜æ”¾çš„ä¸€ä¸ªä¸ªé€»è¾‘åˆ†åŒºä¿¡æ¯ï¼Œä¾‹å¦‚å¦‚æœæˆ‘ä»¬ç¬¬ä¸€ä¸ªå­˜å‚¨çš„LpMetadataPartitionæ˜¯systemçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆé¦–å…ˆè°ƒç”¨CreateLogicalPartitionå»åˆ›å»ºé€»è¾‘åˆ†åŒºï¼Œç¬¬äºŒä¸ªå­˜å‚¨çš„LpMetadataPartitionæ˜¯vendorçš„ä¿¡æ¯ï¼Œç›¸åº”çš„è°ƒç”¨CreateLogicalPartitionå»åˆ›å»ºé€»è¾‘åˆ†ã€‚</p><p>ğŸˆ<strong>åˆ°è¿™é‡Œè§£é‡Šäº†å¼€å¤´æˆ‘ä»¬æåˆ°çš„ä¸ºä»€ä¹ˆdm-1ã€dm-2åˆ›å»ºçš„å…ˆåé¡ºåºï¼Œå…¶ä¸metadata.imgä¸­çš„åˆ†åŒºé¡ºåºæœ‰å…³ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯ä¸ç”Ÿæˆsuper.imgæ—¶æŒ‡æ˜çš„é¡ºåºæœ‰å…³ã€‚</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartition</span><span class="hljs-params">(CreateLogicalPartitionParams params, std::string* path)</span> </span>&#123;<br>    CreateLogicalPartitionParams::OwnedData owned_data;<br>    <span class="hljs-keyword">if</span> (!params.<span class="hljs-built_in">InitDefaults</span>(&amp;owned_data)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    DmTable table;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateDmTableInternal</span>(params, &amp;table)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    DeviceMapper&amp; dm = DeviceMapper::<span class="hljs-built_in">Instance</span>();<br>    <span class="hljs-keyword">if</span> (!dm.<span class="hljs-built_in">CreateDevice</span>(params.device_name, table, path, params.timeout_ms)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// æ–‡ç« å¼€å¤´çš„å¯åŠ¨æ—¥å¿—æ‰“å°å°±æ˜¯åœ¨è¿™é‡Œ</span><br>    LINFO &lt;&lt; <span class="hljs-string">&quot;Created logical partition &quot;</span> &lt;&lt; params.device_name &lt;&lt; <span class="hljs-string">&quot; on device &quot;</span> &lt;&lt; *path;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-1-InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams"><a href="#3-3-1-InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams" class="headerlink" title="3.3.1 InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams"></a>3.3.1 InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartitionParams::InitDefaults</span><span class="hljs-params">(CreateLogicalPartitionParams::OwnedData* owned)</span> </span>&#123;<br>    <span class="hljs-comment">// 3.3èŠ‚å¼€å¤´çš„CreateLogicalPartitionParams paramsçš„å‚æ•°ä¸­è¿˜æ²¡æœ‰åˆå§‹åŒ–partition_name</span><br>    <span class="hljs-keyword">if</span> (partition_name.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-comment">// partition_nameä¸ºsystem</span><br>        partition_name = android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (partition_name != android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Inconsistent partition_name &quot;</span> &lt;&lt; partition_name &lt;&lt; <span class="hljs-string">&quot; with partition &quot;</span><br>               &lt;&lt; android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (device_name.<span class="hljs-built_in">empty</span>()) &#123;<br>        device_name = partition_name;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// --------------------------------------------------------------</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function">std::string <span class="hljs-title">GetPartitionName</span><span class="hljs-params">(<span class="hljs-type">const</span> LpMetadataPartition&amp; partition)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">NameFromFixedArray</span>(partition.name, <span class="hljs-built_in">sizeof</span>(partition.name));<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h4 id="3-3-2-CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table"><a href="#3-3-2-CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table" class="headerlink" title="3.3.2 CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table"></a>3.3.2 CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateDmTableInternal</span><span class="hljs-params">(<span class="hljs-type">const</span> CreateLogicalPartitionParams&amp; params, DmTable* table)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; super_device = params.block_device;<br><br>    <span class="hljs-type">uint64_t</span> sector = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; params.partition-&gt;num_extents; i++) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; extent = params.metadata-&gt;extents[params.partition-&gt;first_extent_index + i];<br>        std::unique_ptr&lt;DmTarget&gt; target;<br>        <span class="hljs-keyword">switch</span> (extent.target_type) &#123;<br>            <span class="hljs-keyword">case</span> LP_TARGET_TYPE_ZERO:<br>                target = std::<span class="hljs-built_in">make_unique</span>&lt;DmTargetZero&gt;(sector, extent.num_sectors);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> LP_TARGET_TYPE_LINEAR: &#123;<br>                <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; block_device = params.metadata-&gt;block_devices[extent.target_source];<br>                std::string dev_string;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">GetPhysicalPartitionDevicePath</span>(params, block_device, super_device,<br>                                                    &amp;dev_string)) &#123;<br>                    <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Unable to complete device-mapper table, unknown block device&quot;</span>;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                target = std::<span class="hljs-built_in">make_unique</span>&lt;DmTargetLinear&gt;(sector, extent.num_sectors, dev_string,<br>                                                          extent.target_data);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Unknown target type in metadata: &quot;</span> &lt;&lt; extent.target_type;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!table-&gt;<span class="hljs-built_in">AddTarget</span>(std::<span class="hljs-built_in">move</span>(target))) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        sector += extent.num_sectors;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (params.partition-&gt;attributes &amp; LP_PARTITION_ATTR_READONLY) &#123;<br>        table-&gt;<span class="hljs-built_in">set_readonly</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (params.force_writable) &#123;<br>        table-&gt;<span class="hljs-built_in">set_readonly</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-3-CreateDevice"><a href="#2-3-3-CreateDevice" class="headerlink" title="2.3.3 CreateDevice"></a>2.3.3 CreateDevice</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\libdm\dm.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DeviceMapper::CreateDevice</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> DmTable&amp; table, std::string* path,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">const</span> std::chrono::milliseconds&amp; timeout_ms)</span> </span>&#123;<br>    std::string uuid = <span class="hljs-built_in">GenerateUuid</span>();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateDevice</span>(name, uuid)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    std::string unique_path;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">LoadTableAndActivate</span>(name, table) || !<span class="hljs-built_in">GetDeviceUniquePath</span>(name, &amp;unique_path) ||<br>        !<span class="hljs-built_in">GetDmDevicePathByName</span>(name, path)) &#123;<br>        <span class="hljs-built_in">DeleteDevice</span>(name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">WaitForFile</span>(unique_path, timeout_ms)) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Failed waiting for device path: &quot;</span> &lt;&lt; unique_path;<br>        <span class="hljs-built_in">DeleteDevice</span>(name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DeviceMapper::CreateDevice</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; uuid)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dm_ioctl</span> io;<br>    <span class="hljs-built_in">InitIo</span>(&amp;io, name);<br>    <span class="hljs-keyword">if</span> (!uuid.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-built_in">snprintf</span>(io.uuid, <span class="hljs-built_in">sizeof</span>(io.uuid), <span class="hljs-string">&quot;%s&quot;</span>, uuid.<span class="hljs-built_in">c_str</span>());<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(fd_, DM_DEV_CREATE, &amp;io)) &#123;<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;DM_DEV_CREATE failed for [&quot;</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">&quot;]&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜</title>
    <link href="/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/"/>
    <url>/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="å±•è®¯Android-P-System-as-rootè§„èŒƒè¯´æ˜"><a href="#å±•è®¯Android-P-System-as-rootè§„èŒƒè¯´æ˜" class="headerlink" title="å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜"></a>å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜</h1><blockquote><p>ä½œä¸ºä¸ªäººå­¦ä¹ ç¬”è®°ä½¿ç”¨ï¼Œ<a href="https://bbs.16rd.com/thread-584995-1-1.html">https://bbs.16rd.com/thread-584995-1-1.html</a></p></blockquote><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h2><p>Android ä» 8.0 å¼€å§‹å¼•å…¥äº† Treble æ¶æ„ï¼Œç›®çš„æ˜¯è®© Android è®¾å¤‡åˆ¶é€ å•†èƒ½å¤Ÿæ›´å¿«ï¼Œæ›´å®¹æ˜“ï¼Œæ›´ä½æˆæœ¬çš„å»å‡çº§ Android ç‰ˆæœ¬ã€‚ä¸ºå®ç°è¿™ä¸€ç›®çš„ï¼ŒGoogle è®¾å®šäº†å¾ˆå¤šè§„åˆ™ï¼Œè®¾å¤‡å•†åªæœ‰å®ç°äº†è¿™äº›è§„ åˆ™ï¼Œæ‰èƒ½æ»¡è¶³ Treble æ¶æ„çš„è¦æ±‚ã€‚æœ¬æ–‡ä»‹ç»çš„ system as root å°±æ˜¯ Google åœ¨ AndroidP ä¸Šæå‡ºçš„ä¸€ é¡¹æ”¹åŠ¨è§„åˆ™ã€‚</p><p>æ‰€è°“ system as rootï¼ŒæŒ‡çš„æ˜¯ system åˆ†åŒºè¢«æŒ‚è½½ä¸º rootfsï¼Œandroid å¯ä»¥é€šè¿‡ OTA ç›´æ¥å‡çº§ rootfsï¼Œé¿å…å‡ºç° system å‡çº§ä¹‹åï¼Œå­˜å‚¨åœ¨ ramdiskï¼ˆrootfsï¼‰ä¸­çš„ init&#x2F;init.rc ä¸æ–°çš„ android ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´ç³»ç»Ÿå‡ºé—®é¢˜ã€‚ åœ¨ A&#x2F;B ç³»ç»Ÿçš„ device ä¸Šï¼Œramdisk å·²ç»æ‰“åŒ…åˆ° system.img äº†ï¼Œæ‰€ä»¥æ— éœ€åšä»€ä¹ˆé€‚é…ã€‚æ­è½½Android 9.x çš„æ‰€æœ‰æ–°è®¾å¤‡éƒ½å¿…é¡»ä½¿ç”¨ system-as-rootï¼ˆBOARD_BUILD_SYSTEM_ROOT_IMAGEå¿…é¡»ä¸º trueï¼‰ï¼Œå®ƒå¯ä»¥å°† ramdisk.img åˆå¹¶åˆ° system.imgï¼Œè€Œåè€…ä¼šåè¿‡æ¥å†ä½œä¸º rootfs è¿›è¡Œè£…è½½ã€‚å¯¹äºè¦å‡çº§åˆ° Android 9 çš„è®¾å¤‡ï¼Œä½¿ç”¨ system-as-root å¹¶éå¼ºåˆ¶è¦æ±‚ã€‚</p><p>System as root çš„æ”¹åŠ¨éƒ¨åˆ†å¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/173632rimzt33h8mi4ntif.jpg" alt="173632rimzt33h8mi4ntif" style="zoom:80%;"><h2 id="2-System-as-root-è§„èŒƒ"><a href="#2-System-as-root-è§„èŒƒ" class="headerlink" title="2.System as root è§„èŒƒ"></a>2.System as root è§„èŒƒ</h2><p>System as root çš„æ ¸å¿ƒåœ¨äº ramdisk ä¼šè¢«æ‰“åŒ…åˆ° system.imgï¼ŒåŸºäºè¿™ç§çŠ¶å†µï¼Œè®¾å¤‡å‚å•†è‡ªè¡Œæ·»åŠ åˆ° ramdisk ä¸­çš„æ”¹åŠ¨ï¼Œå¿…é¡»è½¬ç§»åˆ°å…¶å®ƒä½ç½®ï¼Œå¦åˆ™ system.img ä¸€æ›´æ¢ï¼ˆä¾‹å¦‚ GSI ç‰ˆæœ¬ï¼‰ï¼Œramdiskä¸­æ·»åŠ çš„å†…å®¹å°±ä¸¢å¤±äº†ï¼Œå¯¼è‡´ç³»ç»Ÿå¯åŠ¨å¯èƒ½å‡ºç°é—®é¢˜ã€‚æ ¹æ® Google å‘å¸ƒçš„ system as root æ–‡æ¡£çš„è¦æ±‚ï¼Œæ€»ç»“äº†ä¸‹é¢è¿™äº›éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼š</p><table><thead><tr><th>ID</th><th>ä¿®æ”¹å†…å®¹</th><th>è§„èŒƒ</th></tr></thead><tbody><tr><td>1</td><td>rcæ–‡ä»¶çš„è°ƒæ•´</td><td>åŸæ¥æ”¾ç½®åœ¨device&#x2F;{board}&#x2F;è·¯å¾„ä¸­çš„rcæ–‡ä»¶ï¼Œéœ€è¦ç¼–è¯‘ åˆ°vendor&#x2F;etc&#x2F;init;å¦ä¸€æ–¹é¢å¦‚æœä¿®æ”¹äº† &#x2F;system&#x2F;core&#x2F;rootdir&#x2F;T init.*.rc ,æœ€å¥½å°†ä¿®æ”¹ç§»åŠ¨åˆ°è®¾å¤‡å‚ å•†è‡ªè¡Œæ·»åŠ çš„rcæ–‡ä»¶ä¸­ï¼›rcæ–‡ä»¶ä¸­importçš„è·¯å¾„éœ€è¦ä¿®æ”¹ï¼Œ é¿å…importè·¯å¾„é”™è¯¯å¯¼è‡´rcæ–‡ä»¶æ²¡æœ‰è¢«è§£æã€‚</td></tr><tr><td>2</td><td>å†…æ ¸æ¨¡å—ç§»å²€ramdisk</td><td>å†…æ ¸æ¨¡å—é©±åŠ¨å·²ç»ç§»åˆ°vendoråˆ†åŒºã€‚</td></tr><tr><td>3</td><td>fstabæ–‡ä»¶è·¯å¾„è°ƒæ•´</td><td>fstabæ–‡ä»¶éœ€è¦ä»ramdiskç§»åŠ¨åˆ°vendor&#x2F;etc</td></tr><tr><td>4</td><td>ramdiskæ‰“åŒ…è°ƒæ•´</td><td>ramdisk.img éœ€è¦æ‰“åŒ…åˆ° system.img ä¸­</td></tr><tr><td>5</td><td>dm-verifyå®ç°æ–¹æ¡ˆè°ƒæ•´</td><td>AndroidP Â± dm-verifyå¿…é¡»å¼€å¯,UNISOCç‰ˆæœ¬å·²é»˜è®¤ å¼€å¯ dm-verify</td></tr></tbody></table><h3 id="2-1-rcæ–‡ä»¶çš„è°ƒæ•´"><a href="#2-1-rcæ–‡ä»¶çš„è°ƒæ•´" class="headerlink" title="2.1 rcæ–‡ä»¶çš„è°ƒæ•´"></a>2.1 rcæ–‡ä»¶çš„è°ƒæ•´</h3><p>åœ¨ device&#x2F;{board}ä»“åº“ä¸­å­˜åœ¨å¾ˆå¤šè®¾å¤‡ç›¸å…³çš„ rc æ–‡ä»¶ï¼Œåœ¨ AndroidP ä¹‹å‰ï¼Œè¿™äº› rc æ–‡ä»¶æ˜¯è¢«ç¼–è¯‘åˆ° ramdisk çš„æ ¹è·¯å¾„çš„ï¼Œä½†æ˜¯æŒ‰ç…§ system as root çš„è¦æ±‚ï¼Œè¿™äº›æ–‡ä»¶å¿…é¡»è°ƒæ•´åˆ°å…¶å®ƒè·¯å¾„ï¼Œä¸”æ–‡ä»¶ ä¸­ import rc ç­‰è¯­å¥æ‰€å¯¹åº”çš„è·¯å¾„éœ€è¦åšè°ƒæ•´ã€‚å…·ä½“æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ul><li>device&#x2F;{board} è·¯å¾„çš„ rc æ–‡ä»¶ copy åˆ° vendor åˆ†åŒºï¼Œä¾‹å¦‚ï¼š device&#x2F;{board}&#x2F;common&#x2F;DeviceCommon.mk</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">product_COPY_FILES += \<br><span class="hljs-variable">$(LOCAL_PATH)</span>/rootdir/root/init.common.rc:<span class="hljs-variable">$(TARGET_COPY_OUT_VENDOR)</span>/etc/init/hw/init.common .rc \<br><span class="hljs-variable">$(LOCAL_PATH)</span>/rootdir/root/init.ram.rc:<span class="hljs-variable">$(TARGET_COPY_OUT_VENDOR)</span>/etc/init/hw/init.ram.rc \<br></code></pre></td></tr></table></figure><ul><li>device&#x2F;{board} è·¯å¾„çš„ rc æ–‡ä»¶ import è·¯å¾„éœ€è¦åšç›¸åº”è°ƒæ•´ï¼šä¾‹å¦‚ device&#x2F;{board}&#x2F;common&#x2F;rootdir&#x2F;root&#x2F;init.common.rc æ–‡ä»¶åŸæœ¬ import çš„éƒ½æ˜¯æ ¹è·¯å¾„çš„ rc æ–‡ä»¶ï¼Œç°åœ¨éœ€è¦æ ¹æ®å®é™…å½’æ¡£è·¯å¾„æ¥è°ƒæ•´ã€‚</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">import /vendor/etc/init/hw/init.$&#123;ro.hardware&#125;.usb.rc<br>import /vendor/etc/init/hw/init.ram.rc<br>import /vendor/etc/init/hw/init.storage.rc<br></code></pre></td></tr></table></figure><h3 id="2-2-å†…æ ¸æ¨¡å—ç§»å‡ºramdisk"><a href="#2-2-å†…æ ¸æ¨¡å—ç§»å‡ºramdisk" class="headerlink" title="2.2  å†…æ ¸æ¨¡å—ç§»å‡ºramdisk"></a>2.2  å†…æ ¸æ¨¡å—ç§»å‡ºramdisk</h3><p>åœ¨ UNISOC å¹³å°ï¼Œéƒ¨åˆ† kernel modules æ”¾åˆ° ramdisk çš„ lib è·¯å¾„ä¸‹ï¼Œåœ¨å¼€å¯äº† <strong>system as root</strong>ä¹‹åï¼Œéµå¾ª Google çš„å»ºè®®ï¼Œéœ€è¦ç»Ÿä¸€è°ƒæ•´åˆ°&#x2F;vendor&#x2F;lib&#x2F;modules ä¸­ï¼š</p><ul><li>åœ¨æ¨¡å—çš„ Android.mk(bp)ä¸­ï¼Œå°†æ¨¡å— bin æ–‡ä»¶å½’æ¡£è·¯å¾„è®¾å®šä¸º&#x2F;vendor&#x2F;lib&#x2F;modulesï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs make\">vendor/sprd/modules/wcn/fm/driver/Android.mk<br>1. LOCAL_MODULE := sprd_fm.ko<br>2. LOCAL_MODULE_CLASS := SHARED_LIBRARIES<br>3. LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/etc/modules<br></code></pre></td></tr></table></figure><h3 id="2-3-fstab-æ–‡ä»¶è·¯å¾„è°ƒæ•´"><a href="#2-3-fstab-æ–‡ä»¶è·¯å¾„è°ƒæ•´" class="headerlink" title="2.3 fstab æ–‡ä»¶è·¯å¾„è°ƒæ•´"></a>2.3 fstab æ–‡ä»¶è·¯å¾„è°ƒæ•´</h3><p>fstab æ˜¯ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿ mount ä¿¡æ¯çš„ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸è®¾å¤‡çš„å­˜å‚¨å¼ºç›¸å…³ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ä» ramdiskç§»å‡ºï¼Œå°† fstab æ”¾åœ¨ vendor&#x2F;etc&#x2F;è·¯å¾„ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrecovery æ¨¡å¼æ‰€ç”¨çš„ ramdisk ä¸æ­£å¸¸å¼€æœºçš„ä¸æ˜¯ä¸€ä¸ªï¼Œ æ‰€ä»¥ recovery æ¨¡å¼æ‰€ç”¨çš„ fstab æ–‡ä»¶ï¼Œè·¯å¾„ä¸ç”¨ä¿®æ”¹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>User Data Checkpointæœºåˆ¶</title>
    <link href="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="User-Data-Checkpointæœºåˆ¶-UDC"><a href="#User-Data-Checkpointæœºåˆ¶-UDC" class="headerlink" title="User Data Checkpointæœºåˆ¶(UDC)"></a>User Data Checkpointæœºåˆ¶(UDC)</h1><h2 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1.èƒŒæ™¯"></a>1.èƒŒæ™¯</h2><p>ç”±äºABå‡çº§çš„å›æ»šæœºåˆ¶åªæ”¯æŒåˆ°early_booté˜¶æ®µï¼Œå¦‚æœOTAå‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œdataåˆ†åŒºè¢«ä¿®æ”¹äº†ï¼Œå¹¶ä¸”OTAå‡çº§å¤±è´¥äº†ï¼Œåˆ™dataåˆ†åŒºæ˜¯æ— æ³•å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€çš„ã€‚UDCåŠŸèƒ½æ˜¯ä¸ºäº†è§£å†³OTAå‡çº§å¤±è´¥åï¼Œå½“dataåˆ†åŒºè¢«ä¿®æ”¹åï¼Œä¸æ”¯æŒå›æ»šdataåˆ†åŒºçš„é—®é¢˜ã€‚UDCåŒæ—¶æ”¯æŒç»‘å®škeyç‰ˆæœ¬ä»¥åŠé˜²æ­¢keyå›æ»šçš„åŠŸèƒ½ã€‚</p><h2 id="2-å®ç°UDC"><a href="#2-å®ç°UDC" class="headerlink" title="2.å®ç°UDC"></a>2.å®ç°UDC</h2><blockquote><p>ä¸€å®šè¦å‚è€ƒå®‰å“å®˜ç½‘ï¼š<a href="https://source.android.com/docs/core/ota/user-data-checkpoint?hl=zh-cn">https://source.android.com/docs/core/ota/user-data-checkpoint?hl=zh-cn</a></p></blockquote><h3 id="2-1-è®¾ç½®"><a href="#2-1-è®¾ç½®" class="headerlink" title="2.1 è®¾ç½®"></a>2.1 è®¾ç½®</h3><p>åœ¨ <code>init.hardware.rc</code> æ–‡ä»¶çš„ <code>on fs</code> ä¸­ï¼Œç¡®ä¿æ‚¨å…·æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.$&#123;ro.boot.hardware.platform&#125; --early<br></code></pre></td></tr></table></figure><p>åœ¨ <code>init.hardware.rc</code> æ–‡ä»¶çš„ <code>on late-fs</code> ä¸­ï¼Œç¡®ä¿æ‚¨å…·æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.$&#123;ro.boot.hardware.platform&#125; --late<br></code></pre></td></tr></table></figure><p>åœ¨ <code>fstab.hardware</code> æ–‡ä»¶ä¸­ï¼Œç¡®ä¿å°† <code>/data</code> æ ‡è®°ä¸º <code>latemount</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/bootdevice/by-name/userdata              /data              f2fs<br>noatime,nosuid,nodev,discard,reserve_root=32768,resgid=1065,fsync_mode=nobarrier<br>latemount,wait,check,fileencryption=ice,keydirectory=/metadata/vold/metadata_encryption,quota,formattable,sysfs_path=/sys/devices/platform/soc/1d84000.ufshc,reservedsize=128M,checkpoint=fs<br></code></pre></td></tr></table></figure><h3 id="2-2-æ·»åŠ metadataåˆ†åŒº"><a href="#2-2-æ·»åŠ metadataåˆ†åŒº" class="headerlink" title="2.2 æ·»åŠ metadataåˆ†åŒº"></a>2.2 æ·»åŠ metadataåˆ†åŒº</h3><p>UDC éœ€è¦ä½¿ç”¨ metadata åˆ†åŒºæ¥å­˜å‚¨éå¼•å¯¼åŠ è½½ç¨‹åºé‡è¯•è®¡æ•°å’Œå¯†é’¥ã€‚è®¾ç½® metadata åˆ†åŒºå¹¶æå‰å°†å…¶è£…è½½åœ¨ <code>/metadata</code> ä¸­ã€‚</p><p>åœ¨ <code>fstab.hardware</code> æ–‡ä»¶ä¸­ï¼Œç¡®ä¿å°† <code>/metadata</code> æ ‡è®°ä¸º <code>earlymount</code> æˆ– <code>first_stage_mount</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/by-name/metadata           /metadata           ext4<br>noatime,nosuid,nodev,discard,sync<br>wait,formattable,first_stage_mount<br></code></pre></td></tr></table></figure><p>å°†åˆ†åŒºåˆå§‹åŒ–ä¸ºå…¨é›¶ã€‚</p><p>å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ° <code>BoardConfig.mk</code>ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">BOARD_USES_METADATA_PARTITION := true<br>BOARD_ROOT_EXTRA_FOLDERS := existing_folders metadata<br></code></pre></td></tr></table></figure><h3 id="2-3-æ›´æ–°ç³»ç»Ÿ"><a href="#2-3-æ›´æ–°ç³»ç»Ÿ" class="headerlink" title="2.3 æ›´æ–°ç³»ç»Ÿ"></a>2.3 æ›´æ–°ç³»ç»Ÿ</h3><p><strong>F2FS ç³»ç»Ÿ</strong></p><ul><li><p>å¯¹äºä½¿ç”¨ F2FS æ¥æ ¼å¼åŒ–æ•°æ®çš„ç³»ç»Ÿï¼Œè¯·ç¡®ä¿æ‚¨çš„ F2FS ç‰ˆæœ¬æ”¯æŒæ£€æŸ¥ç‚¹ã€‚</p></li><li><p>å¯¹äºåœ¨ <code>/data</code> è£…è½½çš„è®¾å¤‡ï¼Œè¯·å°† <code>checkpoint=fs</code> æ ‡å¿—æ·»åŠ åˆ° fstab çš„ <code>&lt;fs_mgr_flags&gt;</code> éƒ¨åˆ†ã€‚</p></li></ul><p><strong>é F2FS ç³»ç»Ÿ</strong></p><ul><li>å¯¹äºé F2FS ç³»ç»Ÿï¼Œå¿…é¡»åœ¨å†…æ ¸é…ç½®ä¸­å¯ç”¨ <code>dm-bow</code>ã€‚</li><li>å¯¹äºåœ¨ <code>/data</code> è£…è½½çš„è®¾å¤‡ï¼Œè¯·å°† <code>checkpoint=block</code> æ ‡å¿—æ·»åŠ åˆ° fstab çš„ <code>&lt;fs_mgr_flags&gt;</code> éƒ¨åˆ†ã€‚</li></ul><h2 id="3-f2fsæŒ‚è½½æµç¨‹"><a href="#3-f2fsæŒ‚è½½æµç¨‹" class="headerlink" title="3.f2fsæŒ‚è½½æµç¨‹"></a>3.f2fsæŒ‚è½½æµç¨‹</h2><p>æ—¢ç„¶ä¸Šé¢æåˆ°äº†f2fså¤©ç„¶æ”¯æŒcheckpointï¼Œé‚£æˆ‘ä»¬åˆ†æä¸€ä¸‹å®ƒçš„æŒ‚è½½æµç¨‹</p><h3 id="3-1å¼€å§‹æŒ‚è½½æ‰€æœ‰"><a href="#3-1å¼€å§‹æŒ‚è½½æ‰€æœ‰" class="headerlink" title="3.1å¼€å§‹æŒ‚è½½æ‰€æœ‰"></a>3.1å¼€å§‹æŒ‚è½½æ‰€æœ‰</h3><p>åœ¨rcä¸­ä¼šè°ƒç”¨mount_allæ¥æŒ‚è½½æ‰€æœ‰fstabä¸­çš„entry</p><p>åœ¨<code>device/softwinner/ceres-common/init.sun50iw10p1.rc</code>æ–‡ä»¶çš„on fsä¸­æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.sun50iw10p1 --early<br></code></pre></td></tr></table></figure><p>åœ¨<code>device/softwinner/ceres-b3/fstab.sun50iw10p1.rc</code>æ–‡ä»¶çš„<code>data</code>åˆ†åŒºä¸­æ·»åŠ <code>latemount</code>å’Œ<code>checkpoint=fs</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/by-name/UDISK      /data        f2fs     noatime,nosuid,nodev,discard wait,check,formattable,quota,reservedsize=33554432,fileencryption=aes-256-xts:aes-256-cts,latemount,checkpoint=fs<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ä¼šå»è§£æmount_allå¯¹åº”çš„åŠ¨ä½œï¼Œç„¶åå°†<code>/vendor/etc/fstab.sun50iw10p1</code>ä½œä¸ºarg[0]ï¼Œ<code>--early</code>ä½œä¸ºarg[1]ä¼ ç»™mount_allå¯¹åº”çš„å¤„ç†å‡½æ•°<code>do_mount_all</code></p><img src="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/image-20230315202320251.png" alt="image-20230315202320251"><p>åœ¨<code>do_mount_all</code>ä¸­ä¼šè°ƒç”¨fs_mgr_mount_allæŒ‚è½½æ‰€æœ‰<code>/vendor/etc/fstab.sun50iw10p1</code>ä¸­çš„é¡¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\builtins.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">do_mount_all</span><span class="hljs-params">(<span class="hljs-type">const</span> BuiltinArguments&amp; args)</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    Fstab fstab;<br>    <span class="hljs-keyword">if</span> (mount_all-&gt;fstab_path.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadDefaultFstab</span>(&amp;fstab)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">&quot;Could not read default fstab&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ä¼šå°†/vendor/etc/fstab.sun50iw10p1ä¸­çš„æ¯ä¸€é¡¹è§£æå¥½æ”¾åœ¨fstabæ•°ç»„ä¸­</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadFstabFromFile</span>(mount_all-&gt;fstab_path, &amp;fstab)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">&quot;Could not read fstab&quot;</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è°ƒç”¨fs_mgr_mount_allæŒ‚è½½æ‰€æœ‰è§£æå‡ºæ¥çš„entry</span><br>    <span class="hljs-keyword">auto</span> mount_fstab_result = <span class="hljs-built_in">fs_mgr_mount_all</span>(&amp;fstab, mount_all-&gt;mode);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-fs-mgr-mount-allåšå¥½å‡†å¤‡å·¥ä½œ"><a href="#3-2-fs-mgr-mount-allåšå¥½å‡†å¤‡å·¥ä½œ" class="headerlink" title="3.2 fs_mgr_mount_allåšå¥½å‡†å¤‡å·¥ä½œ"></a>3.2 fs_mgr_mount_allåšå¥½å‡†å¤‡å·¥ä½œ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">MountAllResult <span class="hljs-title">fs_mgr_mount_all</span><span class="hljs-params">(Fstab* fstab, <span class="hljs-type">int</span> mount_mode)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(fstab-&gt;<span class="hljs-built_in">size</span>()); i++) &#123;<br>        <span class="hljs-keyword">auto</span>&amp; current_entry = (*fstab)[i];<br>        <span class="hljs-comment">// è°ƒç”¨checkpoint_managerçš„Updateæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (!checkpoint_manager.<span class="hljs-built_in">Update</span>(&amp;current_entry)) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// system\core\fs_mgr\fs_mgr.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Update</span><span class="hljs-params">(FstabEntry* entry, <span class="hljs-type">const</span> std::string&amp; block_device = std::string())</span> </span>&#123;<br>    <span class="hljs-comment">// fs_mgr_flagsæ˜¯å¦åŒ…å«checkpoint=fsæˆ–checkpoint=blk</span><br>    <span class="hljs-comment">// æ˜¾ç„¶åŒ…å«</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SupportsCheckpoint</span>(entry)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ***********************è¿™é‡Œæ˜¯æœ€é‡è¦çš„***********************</span><br>    <span class="hljs-comment">// ***********************è¿™é‡Œæ˜¯æœ€é‡è¦çš„***********************</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">NeedsCheckpoint</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">UpdateCheckpointPartition</span>(entry, block_device)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Could not set up checkpoint partition, skipping!&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-1-NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint"><a href="#3-2-1-NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint" class="headerlink" title="3.2.1 NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint"></a>3.2.1 NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\fs_mgr.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">NeedsCheckpoint</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// è°ƒç”¨vdcäºŒè¿›åˆ¶ï¼Œä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°checkpoint,ç¬¬äºŒä¸ªå‚æ•°needsCheckpointï¼Œæœ€ç»ˆå›è°ƒçš„ç»“æœæ˜¯needs_checkpoint_</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">call_vdc</span>(&#123;<span class="hljs-string">&quot;checkpoint&quot;</span>, <span class="hljs-string">&quot;needsCheckpoint&quot;</span>&#125;, &amp;needs_checkpoint_)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Failed to find if checkpointing is needed. Assuming no.&quot;</span>;<br>        needs_checkpoint_ = NO;<br>    &#125;<br>    <span class="hljs-keyword">return</span> needs_checkpoint_ == YES;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>vdc</strong>äºŒè¿›åˆ¶ç¼–è¯‘å®Œä»¥åä½äº<code>out/target/product/[productName]</code>ä¸­</p><img src="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/image-20230315204223717.png" alt="image-20230315204223717" style="zoom:50%;"><p>ä¸‹é¢çœ‹ä¸€ä¸‹å®ƒçš„mainå…¥å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\vold\vdc.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (xxx) &#123;<br>        <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;checkpoint&quot;</span> &amp;&amp; args[<span class="hljs-number">1</span>] == <span class="hljs-string">&quot;needsCheckpoint&quot;</span> &amp;&amp; args.<span class="hljs-built_in">size</span>() == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">bool</span> enabled = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// è°ƒç”¨needsCheckpointæ–¹æ³•</span><br>        <span class="hljs-built_in">checkStatus</span>(args, vold-&gt;<span class="hljs-built_in">needsCheckpoint</span>(&amp;enabled));<br>        <span class="hljs-keyword">return</span> enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::needsCheckpoint</span><span class="hljs-params">(<span class="hljs-type">bool</span>* _aidl_return)</span> </span>&#123;<br>    *_aidl_return = <span class="hljs-built_in">cp_needsCheckpoint</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Ok</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cp_needsCheckpoint</span><span class="hljs-params">()</span> </span>&#123;<br><br>    sp&lt;IBootControl&gt; <span class="hljs-keyword">module</span> = IBootControl::<span class="hljs-built_in">getService</span>();<br><br>    <span class="hljs-keyword">if</span> (isCheckpointing) <span class="hljs-keyword">return</span> isCheckpointing;<br><br>    <span class="hljs-comment">// è°ƒç”¨bootctlçš„isSlotMarkedSuccessfulæ–¹æ³•</span><br>    <span class="hljs-comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œé‚£å¿…ç„¶bootåˆ†åŒºæ²¡æœ‰succæ ‡è®°</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> &amp;&amp; <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">isSlotMarkedSuccessful</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getCurrentSlot</span>()) == BoolResult::FALSE) &#123;<br>        isCheckpointing = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>å¦‚æœæ˜¯OTAå‡çº§é˜¶æ®µæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åˆ·å›ºä»¶çš„æ—¶å€™ï¼ˆè°ƒç”¨boot_ctrlåˆ¤æ–­å½“å‰slotæ˜¯å¦å·²ç»Marked Successfuläº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¡¨æ˜æ­¤æ—¶å¤„äºOTAå‡çº§é˜¶æ®µæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åˆ·å›ºä»¶çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œcheckpointï¼‰ï¼Œåˆ™è¿”å›trueï¼›æ­£å¸¸æƒ…å†µå°±æ˜¯falseï¼›</strong></p><h4 id="3-2-2-UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹"><a href="#3-2-2-UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹" class="headerlink" title="3.2.2 UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹"></a>3.2.2 UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹</h4><p>å¦‚æœNeedsCheckpointä¸ºTrueï¼Œè°ƒç”¨UpdateCheckpointPartition</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">UpdateCheckpointPartition</span><span class="hljs-params">(FstabEntry* entry, <span class="hljs-type">const</span> std::string&amp; block_device)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (entry-&gt;fs_mgr_flags.checkpoint_fs) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_f2fs</span>(entry-&gt;fs_type)) &#123;<br>            <span class="hljs-comment">// ä¼šåœ¨è¿™é‡Œæ·»åŠ checkpoint=disable</span><br>            entry-&gt;fs_checkpoint_opts = <span class="hljs-string">&quot;,checkpoint=disable&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-mount-with-alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½"><a href="#3-3-mount-with-alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½" class="headerlink" title="3.3 mount_with_alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½"></a>3.3 mount_with_alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">mount_with_alternatives</span><span class="hljs-params">(<span class="hljs-type">const</span> Fstab&amp; fstab, <span class="hljs-type">int</span> start_idx, <span class="hljs-type">int</span>* end_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">int</span>* attempted_idx)</span> </span>&#123;<br>    <span class="hljs-comment">// æ€»å…±å°è¯•2æ¬¡</span><br> <span class="hljs-type">int</span> retry_count = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">while</span> (retry_count-- &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨__mountå¼€å§‹çœŸæ­£çš„æŒ‚è½½</span><br>        <span class="hljs-keyword">if</span> (!__mount(fstab[i].blk_device, fstab[i].mount_point, fstab[i])) &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4.å‚è€ƒ"></a>4.å‚è€ƒ</h2><blockquote><p> ğŸ­ å‚è€ƒå¤§ç¥pyjestonï¼š<a href="https://www.cnblogs.com/pyjetson/p/14682457.html">https://www.cnblogs.com/pyjetson/p/14682457.html</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ"></a>åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ</h1><blockquote><p>ğŸ‰ <strong>å‚è€ƒåšå®¢</strong>ï¼š<a href="https://www.jianshu.com/p/8966d121263b">https://www.jianshu.com/p/8966d121263b</a></p><p>ğŸ’ <strong>é¡¹ç›®åœ°å€</strong>ï¼š<a href="https://github.com/ZhangShurong/HUST_OS_fs_experiment">https://github.com/ZhangShurong/HUST_OS_fs_experiment</a></p><p>ğŸ <strong>æ–‡ä»¶ç³»ç»Ÿå‰ç½®çŸ¥è¯†ï¼š</strong><a href="https://blog.csdn.net/u012489236/article/details/123834123?spm=1001.2014.3001.5506">https://blog.csdn.net/u012489236/article/details/123834123?spm=1001.2014.3001.5506</a></p></blockquote><h2 id="0-ä¸‹è½½è¿è¡Œ"><a href="#0-ä¸‹è½½è¿è¡Œ" class="headerlink" title="0.ä¸‹è½½è¿è¡Œ"></a>0.ä¸‹è½½è¿è¡Œ</h2><p>æŒ‰ç…§<code>Readme.md</code>æ‰§è¡Œä»¥åï¼Œå¯ä»¥çœ‹åˆ°å…·æœ‰äº†ä¸€ä¸ªåŸºç¡€æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ï¼š</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311221220446.png" alt="image-20230311221220446" style="zoom: 67%;"><p>å¦‚æœæœ‰ç¼–è¯‘æŠ¥é”™ï¼Œæœ‰å…³äºtimepescç±»å‹è½¬æ¢çš„ï¼›è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311224039035.png" alt="image-20230311224039035" style="zoom: 55%;"><h2 id="1-æ€»ä½“è®¾è®¡"><a href="#1-æ€»ä½“è®¾è®¡" class="headerlink" title="1.æ€»ä½“è®¾è®¡"></a>1.æ€»ä½“è®¾è®¡</h2><p>æœ¬æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ç»“æ„å‚è€ƒminixçš„æ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚ä½†æ˜¯è‡ªä¸¾å—ï¼ˆæˆ–ç§°å¼•å¯¼å—ï¼‰ä¸­æ²¡æœ‰æ•°æ®ã€‚ä¸”ä¸é‡‡ç”¨äºŒçº§æˆ–è€…å¤šçº§ç´¢å¼•ï¼Œå…¶ç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">|Dummy Block|Super Block|IMap|BMap|Inode Table|Data blocks|<br></code></pre></td></tr></table></figure><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230312230337246.png" alt="image-20230312230337246" style="zoom:67%;"><p>å…¶ä¸­æ¯ä¸ªå—çš„å¤§å°å®šä¹‰ä¸º4096bytesï¼Œæ¯ä¸ªInodeå«æœ‰10ä¸ªå—æ‰€ä»¥å•ä¸ªæ–‡ä»¶æœ€å¤§ä¸º40KBï¼Œæ”¯æŒçš„æœ€å°ç£ç›˜å¤§å°ä¸º24Kã€‚ä»¥ä¸‹è¯¦ç»†é˜è¿°æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€éœ€è¦çš„ä¸‰ä¸ªåŸºæœ¬æ•°æ®ç»“æ„ã€‚</p><h3 id="1-1-è¶…çº§å—ç»“æ„"><a href="#1-1-è¶…çº§å—ç»“æ„" class="headerlink" title="1.1 è¶…çº§å—ç»“æ„"></a>1.1 è¶…çº§å—ç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_fs_super_block</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> version;<br>    <span class="hljs-type">uint64_t</span> magic;<br>    <span class="hljs-type">uint64_t</span> block_size;<br>    <span class="hljs-type">uint64_t</span> inodes_count;<br>    <span class="hljs-type">uint64_t</span> free_blocks;<br>    <span class="hljs-type">uint64_t</span> blocks_count;<br>    <span class="hljs-type">uint64_t</span> bmap_block;<br>    <span class="hljs-type">uint64_t</span> imap_block;<br>    <span class="hljs-type">uint64_t</span> inode_table_block;<br>    <span class="hljs-type">uint64_t</span> data_block_number;<br>    <span class="hljs-type">char</span> padding[<span class="hljs-number">4016</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¶…çº§å—ä¸­çš„paddingæ•°ç»„ï¼Œæ˜¯ä¸ºäº†ä½¿è¶…çº§å—çš„å¤§å°ä¸º4096bytesï¼Œä»¥ç®€åŒ–åæœŸçš„å·¥ä½œï¼›â€œMagicâ€ä¸º1314522ï¼›indoe_countè®°å½•æ–‡ä»¶ç³»ç»Ÿæ‰€æ”¯æŒçš„inodeä¸ªæ•°ï¼Œè¿™ä¸ªå€¼åœ¨æ ¼å¼åŒ–æ—¶å°±å·²ç»è®¡ç®—å¹¶å†™å…¥è¶…çº§å—äº†ã€‚Bmap_blockè®°å½•ç€bmapå¼€å§‹çš„æ•°æ®å—ç´¢å¼•,imap_blockï¼Œinode_table_blockå’Œdata_block_numberåŒç†ï¼Œè®°å½•ç´¢å¼•æ˜¯ä¸ºäº†ç®€åŒ–æ–‡ä»¶å—çš„å®šä½æ“ä½œã€‚</p><h3 id="1-2-HUST-inodeç»“æ„"><a href="#1-2-HUST-inodeç»“æ„" class="headerlink" title="1.2 HUST_inodeç»“æ„"></a>1.2 HUST_inodeç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> &#123;</span>  <br>    <span class="hljs-type">mode_t</span> mode; <span class="hljs-comment">//sizeof(mode_t) is 4  </span><br>    <span class="hljs-type">uint64_t</span> inode_no;  <br>    <span class="hljs-type">uint64_t</span> blocks;  <br>    <span class="hljs-type">uint64_t</span> block[HUST_N_BLOCKS];  <br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>  <br>        <span class="hljs-type">uint64_t</span> file_size;  <br>        <span class="hljs-type">uint64_t</span> dir_children_count;  <br>    &#125;;  <br>    <span class="hljs-type">int32_t</span> i_uid;   <br>    <span class="hljs-type">int32_t</span> i_gid;  <br>    <span class="hljs-type">int32_t</span> i_nlink;  <br>    <span class="hljs-type">int64_t</span> i_atime;  <br>    <span class="hljs-type">int64_t</span> i_mtime;  <br>    <span class="hljs-type">int64_t</span> i_ctime;  <br>    <span class="hljs-type">char</span> padding[<span class="hljs-number">112</span>];  <br>&#125;;  <br></code></pre></td></tr></table></figure><p>HUST_inodeå¯¹åº”ç€ç£ç›˜ä¸Šçš„inodeç»“æ„ï¼Œåœ¨åæ–‡ä¼šæè¿°å®ƒæ˜¯å¦‚ä½•è½¬æ¢ä¸ºVFSä¸­çš„inodeçš„ã€‚åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­ï¼Œmodeä»£è¡¨è¯¥inodeæ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼Œblocksä»£è¡¨è¯¥inodeçš„å¤§å°ï¼ˆæ‰€å å—çš„æ•°ç›®ï¼‰ï¼Œi_uidå’Œi_gidç”¨äºåé¢çš„å¤šç”¨æˆ·ç®¡ç†ã€‚Paddingæ•°ç»„æ˜¯ä¸ºäº†è®©HUST_inodeç»“æ„ä½“èƒ½å¤Ÿè¢«4096æ•´é™¤ï¼›å®HUST_N_BLOCKè¢«å®šä¹‰ä¸º10ï¼Œæ„å‘³ç€æ¯ä¸ªæ–‡ä»¶ï¼ˆç›®å½•ï¼‰æœ€å¤§çš„å¤§å°ä¸º10ä¸ªå—ï¼›blockæ•°ç»„å­˜å‚¨ç€æ¯ä¸ªå—çš„ç´¢å¼•ï¼Œç”¨äºå®šä½æ–‡ä»¶ã€‚</p><h3 id="1-3-æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„"><a href="#1-3-æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„" class="headerlink" title="1.3 æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„"></a>1.3 æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_dir_record</span> &#123;</span>  <br>    <span class="hljs-type">char</span> filename[HUST_FILENAME_MAX_LEN];  <br>    <span class="hljs-type">uint64_t</span> inode_no;  <br>&#125;;<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶è®°å½•æ˜¯ä¸ºäº†å‚¨å­˜ç›®å½•é¡¹ï¼Œå…¶ä¸­HUST_FILENAME_MAX_LENå®šä¹‰ä¸º256ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶åæœ€å¤§é•¿åº¦256ã€‚<br> ç¼–å†™æ–‡ä»¶ç³»ç»Ÿé™¤äº†è®¾è®¡æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ç»“æ„ï¼Œå®šä¹‰æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æ“ä½œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ï¼Œè¿™ä¸ªç›´æ¥å½±å“äº†æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æœ¬æ–‡ä»¶ç³»ç»Ÿæ”¯æŒåŸºæœ¬çš„æ–‡ä»¶çš„å¢åˆ æ”¹æŸ¥ï¼Œå¤šç”¨æˆ·ç­‰åŠŸèƒ½ï¼Œä½†æ˜¯ä¸æ”¯æŒæ–‡ä»¶çš„ç§»åŠ¨ï¼Œè½¯ç¡¬é“¾æ¥ç­‰æ“ä½œã€‚</p><h2 id="2-mkfsçš„å®ç°"><a href="#2-mkfsçš„å®ç°" class="headerlink" title="2.mkfsçš„å®ç°"></a>2.mkfsçš„å®ç°</h2><p>è¦ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ªç¬¦åˆç£ç›˜å¸ƒå±€çš„æ˜ åƒæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºæŒ‰ç…§æƒ¯ä¾‹å«åšmkfsã€‚æœ¬èŠ‚è¯¦ç»†æè¿°mkfsçš„å®ç°ã€‚</p><p>mkfsçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æ”¹å†™æˆå¯¹åº”äºæˆ‘ä»¬æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ï¼Œå…¶ä¸»è¦åŠŸèƒ½ç‚¹ä¸º<strong>å†™å…¥è¶…çº§å—ï¼Œå†™å…¥imap,bmapï¼Œå†™å…¥inode table</strong>ï¼Œä»¥åŠåˆ›å»ºä¸€ä¸ªæ ¹ç›®å½•å’Œæµ‹è¯•æ–‡ä»¶ã€‚</p><p>è¶…çº§å—åŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬ä¿¡æ¯ï¼Œå…¶ä¿¡æ¯åœ¨ä¸Šæ–‡ä¸­æœ‰è¯¦ç»†æè¿°ã€‚å†™å…¥è¶…çº§å—ä¿¡æ¯ï¼Œéœ€è¦è®¡ç®—æ•´ä¸ªç£ç›˜çš„å¤§å°ï¼Œç„¶åè®¡ç®—imapï¼Œbmapä»¥åŠinode tableçš„å¤§å°ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šå„ä¸ªåŒºåŸŸåœ¨ç£ç›˜ä¸­çš„ä½ç½®ã€‚è¿™äº›å·¥ä½œéƒ½æ˜¯åœ¨init_diskè¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„ã€‚åŸºæœ¬é€»è¾‘ä¸ºè¯»å–éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶å¤§å°ï¼Œè®¡ç®—å‡ºæ•´ä¸ªç£ç›˜ä¸­çš„å—çš„ä¸ªæ•°ï¼Œç®€å•çš„å°†å—çš„ä¸ªæ•°ä¸inodeçš„ä¸ªæ•°ç­‰åŒèµ·æ¥ï¼›ç„¶åé€šè¿‡å—æ•°ä»¥åŠinodeä¸ªæ•°è®¡ç®—imapå’Œbmapçš„å¤§å°ã€‚å…¶ä¸­bmapçš„å¤§å°å¦‚ä¸‹ï¼ˆimapå¤§å°è®¡ç®—å…¬å¼ä¸bmapä¸€è‡´ï¼‰ï¼š<br>$$<br>bmapsize &#x3D; blockcount&#x2F; HUST_BLOCKSIZE * 8<br>$$<br>å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_disk</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span>  <br>&#123;  <br>    <span class="hljs-comment">//è·å–åŸºæœ¬ä¿¡æ¯  </span><br>    <span class="hljs-comment">//... ...  </span><br>    <span class="hljs-comment">//è®¡ç®—bmap  </span><br>    bmap_size = super_block.blocks_count/(<span class="hljs-number">8</span>*HUST_BLOCKSIZE);  <br>    super_block.bmap_block = RESERVE_BLOCKS;  <br>  <br>    <span class="hljs-keyword">if</span> (super_block.blocks_count%(<span class="hljs-number">8</span>*HUST_BLOCKSIZE) != <span class="hljs-number">0</span>) &#123;  <br>        bmap_size += <span class="hljs-number">1</span>;  <br>    &#125;  <br>    bmap = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(bmap_size*HUST_BLOCKSIZE);  <span class="hljs-comment">// å•ä½æ˜¯å—</span><br>    <span class="hljs-built_in">memset</span>(bmap,<span class="hljs-number">0</span>,bmap_size*HUST_BLOCKSIZE);  <br>  <br>    <span class="hljs-comment">//è®¡ç®—imap  </span><br>    imap_size = super_block.inodes_count/(<span class="hljs-number">8</span>*HUST_BLOCKSIZE);  <span class="hljs-comment">// å•ä½æ˜¯å—</span><br>    super_block.imap_block = super_block.bmap_block + bmap_size;  <br> <br>    <span class="hljs-keyword">if</span>(super_block.inodes_count%(<span class="hljs-number">8</span>*HUST_BLOCKSIZE) != <span class="hljs-number">0</span>) &#123;  <br>        imap_size += <span class="hljs-number">1</span>;  <br>    &#125;  <br>    imap = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(imap_size*HUST_BLOCKSIZE);  <br>    <span class="hljs-built_in">memset</span>(imap,<span class="hljs-number">0</span>,imap_size*HUST_BLOCKSIZE);  <br>  <br>    <span class="hljs-comment">//è®¡ç®—inode_table  </span><br>    inode_table_size = super_block.inodes_count/(HUST_BLOCKSIZE/HUST_INODE_SIZE);  <br>    super_block.inode_table_block = super_block.imap_block + imap_size;  <br>    super_block.data_block_number = RESERVE_BLOCKS + bmap_size + imap_size + inode_table_size;  <br>    super_block.free_blocks = super_block.blocks_count - super_block.data_block_number - <span class="hljs-number">1</span>;  <br><br>    <span class="hljs-comment">// è®¾ç½®bmapä»¥åŠimap  </span><br>    <span class="hljs-comment">// ... ...  </span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œimapå’Œbmapä¸ºuint8_tçš„å…¨å±€æ•°ç»„ã€‚</p><p>è®¡ç®—å®ŒåŸºæœ¬ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å†™å…¥æ–‡ä»¶å¹¶åˆ›å»ºæ ¹ç›®å½•å’Œæµ‹è¯•æ–‡ä»¶ã€‚æ–‡ä»¶åˆ›å»ºçš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>æ£€æµ‹ï¼ˆè·å–ï¼‰ç£ç›˜ï¼ˆæ–‡ä»¶ï¼‰å¤§å°ï¼Œç¡®è®¤æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´</li><li>æ‰¾çš„ç©ºé—²çš„inodeå’Œblockï¼Œå¹¶æ ‡è®°imapå’Œbmapã€‚</li><li>ç”Ÿæˆç›¸åº”çš„æ•°æ®ï¼Œå¹¶å†™å…¥å¯¹åº”çš„å—ä¸­ã€‚å¯¹äºæ ¹ç›®å½•æ¥è®²ï¼Œå†™å…¥çš„æ•°æ®ä¸ºä¸‰ä¸ªç›®å½•é¡¹ï¼Œç›®å½•é¡¹çš„å†…å®¹ä¸ºæ–‡ä»¶ï¼ˆç›®å½•ï¼‰åä»¥åŠå¯¹åº”çš„inodeç¼–å·ã€‚ç¬¬ä¸€ä¸ªç›®å½•é¡¹ä¸ºå½“å‰ç›®å½•å’Œå¯¹åº”çš„inodeç¼–å·0ï¼Œç¬¬äºŒä¸ªç›®å½•é¡¹ä¸ºä¸Šä¸€çº§ç›®å½•å’Œå¯¹åº”çš„inodeç¼–å·0ï¼Œç¬¬ä¸‰ä¸ªç›®å½•é¡¹ä¸ºæ¬¢è¿æ–‡ä»¶ï¼Œå†…å®¹ä¸ºæ–‡ä»¶åâ€œfileâ€å’Œå¯¹åº”çš„inodeç¼–å·1ã€‚</li><li>è®¾ç½®å¯¹åº”çš„inodeä¿¡æ¯ï¼Œå¦‚æ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼ˆmodeä¿¡æ¯ï¼‰ï¼Œåˆ›å»ºæ—¶é—´ä¿®æ”¹æ—¶é—´(i_ctimeå’Œi_mtime)ï¼Œç”¨æˆ·idå’Œç»„idä¿¡æ¯ï¼ˆi_uidå’Œi_gidï¼‰ç­‰ã€‚</li><li>æ›´æ–°è¶…çº§å—ä¿¡æ¯ã€‚</li></ol><p>åœ¨æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿå†™å®Œä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ¥æµ‹è¯•æˆ‘ä»¬çš„mkfsæ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œï¼Œé€šè¿‡16è¿›åˆ¶ç¼–è¾‘å™¨æ¥æŸ¥çœ‹æ˜¯å¦åŠŸèƒ½æ­£å¸¸ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>è¿è¡Œä¸‹åˆ—å‘½ä»¤åˆ›å»ºæ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">dd bs=4096 count=100 if=/dev/zero of=image <br><br>- if=æ–‡ä»¶åï¼šè¾“å…¥æ–‡ä»¶åï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ã€‚å³æŒ‡å®šæºæ–‡ä»¶ã€‚<br>- of=æ–‡ä»¶åï¼šè¾“å‡ºæ–‡ä»¶åï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºã€‚å³æŒ‡å®šç›®çš„æ–‡ä»¶ã€‚<br>- bs=bytesï¼šåŒæ—¶è®¾ç½®è¯»å…¥/è¾“å‡ºçš„å—å¤§å°ä¸ºbytesä¸ªå­—èŠ‚ã€‚<br>- count=blocksï¼šä»…æ‹·è´blocksä¸ªå—ï¼Œå—å¤§å°ç­‰äºbsæŒ‡å®šçš„å­—èŠ‚æ•°ã€‚<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘mkfs.c</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc mkfs.c -o mkfs <br></code></pre></td></tr></table></figure><ul><li>æ ¼å¼åŒ–imageæ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./mkfs ./image<br></code></pre></td></tr></table></figure><ul><li>é€šè¿‡hexdumpæ¥æŸ¥çœ‹æ–‡ä»¶çš„ç»“æ„ï¼Œç»“æœå¦‚ä¸‹å›¾ã€‚é€šè¿‡æ£€æŸ¥ï¼Œæˆ‘ä»¬å‘ç°ï¼Œimageæ–‡ä»¶ç»“æ„å†™å…¥æ­£ç¡®æ— è¯¯ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">amx@amxxxx:~/Desktop/simple_fs$ hexdump ./image <br><span class="hljs-number">0000000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0001000</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0</span>eda <span class="hljs-number">0014</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>  <span class="hljs-comment">/* HUST_fsæ–‡ä»¶ç³»ç»Ÿçš„magicä¸º1314522 */</span><br><span class="hljs-number">0001010</span> <span class="hljs-number">1000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0064</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001020</span> <span class="hljs-number">0059</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0064</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001030</span> <span class="hljs-number">0002</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001040</span> <span class="hljs-number">0004</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001050</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0002000</span> <span class="hljs-number">07f</span>f <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0002010</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0003000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0003010</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0004000</span> <span class="hljs-number">4000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004010</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004020</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0004040</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">24</span>ed <span class="hljs-number">4</span>c27 <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004050</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">3760</span> <span class="hljs-number">4</span>c3b <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004060</span> <span class="hljs-number">0</span>d68 <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004070</span> <span class="hljs-number">03e8</span> <span class="hljs-number">0000</span> <span class="hljs-number">03e8</span> <span class="hljs-number">0000</span> <span class="hljs-number">0002</span> <span class="hljs-number">0000</span> <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004080</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004090</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">3848</span> <span class="hljs-number">4</span>c3b <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br>...............................................<br>amx@amxxxx:~/Desktop/simple_fs$ <br></code></pre></td></tr></table></figure><h2 id="3-æ–‡ä»¶ç³»ç»Ÿçš„å®ç°"><a href="#3-æ–‡ä»¶ç³»ç»Ÿçš„å®ç°" class="headerlink" title="3.æ–‡ä»¶ç³»ç»Ÿçš„å®ç°"></a>3.æ–‡ä»¶ç³»ç»Ÿçš„å®ç°</h2><p>ä¸€ä¸ªé€šå¸¸æ„ä¹‰ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨å¯ä»¥å•ç‹¬è¢«ç¼–è¯‘æˆæ¨¡å—åŠ¨æ€åŠ è½½ï¼Œä¹Ÿå¯ä»¥è¢«ç›´æ¥ç¼–è¯‘åˆ°å†…æ ¸ä¸­ï¼Œä¸ºäº†è°ƒè¯•çš„æ–¹ä¾¿ï¼Œæœ¬æ–‡ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé‡‡ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼å®ç°ã€‚å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿…é¡»éµç…§å†…æ ¸çš„ä¸€äº›â€œè§„åˆ™â€ï¼Œä»¥ä¸‹æˆ‘å°†ä»¥é€’è¿›çš„é¡ºåºé˜è¿°æ–‡ä»¶ç³»ç»Ÿçš„å®ç°è¿‡ç¨‹ã€‚</p><h3 id="3-1-æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½"><a href="#3-1-æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½" class="headerlink" title="3.1 æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½"></a>3.1 æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½</h3><p>é¦–å…ˆä¸ºäº†èƒ½å¤ŸæˆåŠŸåŠ è½½æ–‡ä»¶ç³»ç»Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦æä¾›æ–‡ä»¶ç³»ç»Ÿçš„åå­—ï¼Œè¶…çº§å—çš„åŠ è½½å’Œåˆ é™¤æ–¹æ³•ã€‚è¿™äº›ä¸œè¥¿ååº”åœ¨<code>file_system_type</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">HUST_fs_type</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .name = <span class="hljs-string">&quot;HUST_fs&quot;</span>,  <br>    .mount = HUST_fs_mount,  <br>    .kill_sb = HUST_fs_kill_superblock, <span class="hljs-comment">/* unmount */</span>  <br>&#125;;  <br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸€ç§å—è®¾å¤‡é©±åŠ¨ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦å®ç°module_initä»¥åŠmocule_exitã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called when the module is loaded. */</span>  <br><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> ret;  <br>    ret = register_filesystem(&amp;HUST_fs_type);  <br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)  <br>        printk(KERN_INFO <span class="hljs-string">&quot;Sucessfully registered HUST_fs\n&quot;</span>);  <br>    <span class="hljs-keyword">else</span>  <br>        printk(KERN_ERR <span class="hljs-string">&quot;Failed to register HUST_fs. Error: [%d]\n&quot;</span>, ret);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;  <br>  <br><span class="hljs-comment">/* Called when the module is unloaded. */</span>  <br><span class="hljs-type">void</span> <span class="hljs-title function_">HUST_fs_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>  <br><br>    <span class="hljs-type">int</span> ret;  <br>    ret = unregister_filesystem(&amp;HUST_fs_type);  <br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)  <br>        printk(KERN_INFO <span class="hljs-string">&quot;Sucessfully unregistered HUST_fs\n&quot;</span>);  <br>    <span class="hljs-keyword">else</span>  <br>        printk(KERN_ERR <span class="hljs-string">&quot;Failed to unregister HUST_fs. Error: [%d]\n&quot;</span>, ret);  <br>&#125;  <br>module_init(HUST_fs_init);  <br>module_exit(HUST_fs_exit);  <br>  <br>MODULE_LICENSE(<span class="hljs-string">&quot;MIT&quot;</span>);  <br>MODULE_AUTHOR(<span class="hljs-string">&quot;cv&quot;</span>); <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¾å¤‡é©±åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œé©±åŠ¨å‘å†…æ ¸æ³¨å†Œäº†æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œé©±åŠ¨å¸è½½çš„æ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ä¹Ÿè¢«åˆ é™¤ã€‚æ–‡ä»¶ç³»ç»ŸåŠ è½½æ—¶è°ƒç”¨çš„å‡½æ•°ä¸ºHUST_fs_mountï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªå‡½æ•°å‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_fill_super</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> silent)</span>  <br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ä¸VFSäº¤äº’ä»è€Œç”ŸæˆVFSè¶…çº§å—çš„ã€‚åœ¨HUST fsä¸­ï¼Œè¶…çº§å—åœ¨ç£ç›˜çš„ç¬¬äºŒä¸ª4096å­—èŠ‚ä¸Šï¼Œå³å—å·ä¸º1ã€‚è¿™ä¸ªå‡½æ•°æ‰§è¡Œæ—¶ä¼šä»ç£ç›˜ä¸­è¯»å–ä¿¡æ¯ï¼Œå¡«å……åˆ°VFSæä¾›çš„è¶…çº§å—ç»“æ„ä½“ä¸­ï¼Œä¸‹åˆ—ä¸ºéƒ¨åˆ†å…³é”®ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_fill_super</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> silent)</span>  &#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_head</span> *<span class="hljs-title">bh</span>;</span>  <br>    bh = sb_bread(sb, <span class="hljs-number">1</span>);  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_fs_super_block</span> *<span class="hljs-title">sb_disk</span>;</span>  <br>    sb_disk = (<span class="hljs-keyword">struct</span> HUST_fs_super_block *)bh-&gt;b_data;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">root_inode</span>;</span>  <br>    <span class="hljs-keyword">if</span> (sb_disk-&gt;block_size != <span class="hljs-number">4096</span>) &#123;  <br>        printk(KERN_ERR <span class="hljs-string">&quot;HUST_fs expects a blocksize of %d\n&quot;</span>, <span class="hljs-number">4096</span>);  <br>        ret = -EFAULT;  <br>        <span class="hljs-keyword">goto</span> release;  <br>   &#125;  <br>   <span class="hljs-comment">//fill vfs super block  </span><br>    sb-&gt;s_magic = sb_disk-&gt;magic;  <br>    sb-&gt;s_fs_info = sb_disk;  <br>    sb-&gt;s_maxbytes = HUST_BLOCKSIZE * HUST_N_BLOCKS; <span class="hljs-comment">/* Max file size */</span>  <br>    sb-&gt;s_op = &amp;HUST_fs_super_ops;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ç”¨sb_readæ¥è¯»å–ç£ç›˜ä¸Šçš„å†…å®¹ï¼Œç„¶åå¡«å……super_blockç»“æ„ä½“ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæœ‰å…³è¶…çº§å—çš„æ“ä½œå‡½æ•°å³superblock_operationsä¹Ÿæ˜¯åœ¨æ­¤å¤„èµ‹å€¼çš„ã€‚ç”±äºsuper_block* sbåœ¨æ–‡ä»¶ç³»ç»Ÿå¸è½½ä¹‹å‰æ˜¯ä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨s_fs_infoæ¥å­˜å‚¨åŸå§‹çš„è¶…çº§å—ä¿¡æ¯ï¼Œé¿å…åæœŸäº¤äº’æ—¶ å†æ¬¡è¯»å–ç£ç›˜ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿå¸è½½çš„æ—¶å€™è¶…çº§å—ä¿¡æ¯éœ€è¦è¢«åˆ é™¤ï¼Œæ‰€ä»¥HUST_fs_kill_superblockçš„ä½œç”¨æ—¶é‡Šæ”¾è¯¥è¶…çº§å—ï¼Œé€šçŸ¥VFSè¯¥æŒ‚è½½ç‚¹å·²ç»å¸è½½ã€‚</p><p>å®ç°åŸºæœ¬å‡½æ•°åï¼Œå¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒ‚è½½æ“ä½œï¼ŒæŒ‚è½½æ“ä½œçš„è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">sudo umount ./test  <br>sudo rmmod HUST_fs  <br>dd bs=<span class="hljs-number">4096</span> count=<span class="hljs-number">100</span> <span class="hljs-keyword">if</span>=/dev/zero of=image  <br>./mkfs image  <br>insmod HUST_fs.ko  <br>mount -o loop -t HUST_fs image ./test  <br>dmesg<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»ç¬¬0èŠ‚å¯ä»¥çœ‹åˆ°æŒ‚è½½æˆåŠŸ</p><h3 id="3-2-lså‘½ä»¤çš„å®ç°"><a href="#3-2-lså‘½ä»¤çš„å®ç°" class="headerlink" title="3.2  lså‘½ä»¤çš„å®ç°"></a>3.2  lså‘½ä»¤çš„å®ç°</h3><p>åŠ è½½æ–‡ä»¶ç³»ç»Ÿä¹‹åç¬¬ä¸€ä¸ªè¦å®ç°çš„åŠŸèƒ½æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥é€‰æ‹©å®ç°æ–‡ä»¶å¤¹è¯»å–æ“ä½œï¼Œè¿™ä¸€æ“ä½œåœ¨2.xå†…æ ¸ä¸­æ˜¯<code>.readdir</code>å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­æ˜¯<code>.iterate</code>å‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªæŒ‡é’ˆåœ¨ä¿å­˜åœ¨file_operationä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">HUST_fs_dir_ops</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .iterate = HUST_fs_iterate,  <br>&#125;; <br></code></pre></td></tr></table></figure><p>HUST_fs_iterateå‡½æ•°ä¸»è¦åŠŸèƒ½é€»è¾‘æ˜¯è¯»å–inodeçš„å—æ•°æ®ï¼Œå¹¶ä¸”å°†å—æ•°æ®ä¸­çš„inodeå’Œæ–‡ä»¶åé€šè¿‡dir_emitå‡½æ•°ä¼ è¾“åˆ°VFSå±‚ã€‚ä»¥æ ¹ç›®å½•ä¸ºä¾‹ï¼Œæ ¹ç›®å½•çš„åŒ…å«ä¸‰ä¸ªæ•°æ®é¡¹ï¼Œåˆ†åˆ«æ˜¯çˆ¶ç›®å½•ï¼Œå½“å‰ç›®å½•å’Œæ¬¢è¿æ–‡ä»¶ï¼Œæ‰€ä»¥è¯¥å‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å‚æ•°åˆ†åˆ«è¡¨ç¤ºä¸Šä¸‹æ–‡ï¼Œæ–‡ä»¶/ç›®å½•åï¼Œæ–‡ä»¶/ç›®å½•åé•¿åº¦ï¼Œinodeå·ï¼Œæ–‡ä»¶ç±»å‹  </span><br>dir_emit(ctx, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">0</span>, DT_DIR);  <br>dir_emit(ctx, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">0</span>, DT_DIR);  <br>dir_emit(ctx, <span class="hljs-string">&quot;file&quot;</span>, <span class="hljs-number">4</span>,<span class="hljs-number">1</span>, DT_REG);<br></code></pre></td></tr></table></figure><p>å®Œæˆè¯¥å‡½æ•°åï¼Œåœ¨å¡«å……æ ¹ç›®å½•inodeæ—¶å°†HUST_fs_dir_opsæŒ‡é’ˆèµ‹å€¼ï¼Œå³å¯åœ¨æŒ‚åœ¨æ–‡ä»¶ç³»ç»Ÿåæ‰§è¡Œlså‘½ä»¤ã€‚</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311223941193.png" alt="image-20230311223941193" style="zoom: 80%;"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æˆåŠŸçœ‹åˆ°äº†æ¬¢è¿æ–‡ä»¶ã€‚ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬ä¸èƒ½å¯¹æ–‡ä»¶è¿›è¡Œä»»ä½•æ“ä½œï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®ç°å…¶ä»–çš„æ¥å£ã€‚</p><h3 id="3-3-ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°"><a href="#3-3-ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°" class="headerlink" title="3.3 ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°"></a>3.3 ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°</h3><p>è¿™ä¸ªç£ç›˜ç®¡ç†çš„å†…æ¶µåŒ…æ‹¬å‘ç£ç›˜å†™å…¥å’Œä»ç£ç›˜å–å‡ºè¯»å–inodeï¼Œæ›´æ–°inodeä¿¡æ¯ï¼Œç»´æŠ¤imapï¼Œbmapï¼Œinode tableç­‰æ“ä½œã€‚ä¸ºäº†ä½¿ç£ç›˜ä¸Šçš„å†…å®¹æœ‰åºçš„ç»„åˆèµ·æ¥ï¼Œç£ç›˜ç©ºé—´çš„ç®¡ç†ååˆ†çš„é‡è¦ï¼Œåç»­çš„æ–‡ä»¶è¯»å†™æ“ä½œéƒ½ä¸æ­¤ç›¸å…³ã€‚</p><p>å†™å…¥å’Œåˆ é™¤inodeçš„æ“ä½œå­˜æ”¾åœ¨super_operationsè¿™ä¸ªç»“æ„ä½“ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_operations</span> <span class="hljs-title">HUST_fs_super_ops</span> =</span> &#123;  <br>    .evict_inode = HUST_evict_inode,  <br>    .write_inode = HUST_write_inode,  <br>&#125;;<br></code></pre></td></tr></table></figure><p>HUST_fs_super_opséœ€è¦åœ¨å¡«å……è¶…çº§å—æ—¶èµ‹å€¼åˆ°super_blockçš„s_opså­—æ®µä¸­ã€‚HUST_write_inodeå‡½æ•°çš„åŠŸèƒ½æ˜¯å°†å†…å­˜ä¸­çš„inodeä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚å…³é”®ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_write_inode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> writeback_control *wbc)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_head</span> * <span class="hljs-title">bh</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> * <span class="hljs-title">raw_inode</span> =</span> <span class="hljs-literal">NULL</span>;  <br>    HUST_fs_get_inode(inode-&gt;i_sb, inode-&gt;i_ino, raw_inode);  <br>    <span class="hljs-keyword">if</span> (!raw_inode)  <br>        <span class="hljs-keyword">return</span> -EFAULT;  <br>    raw_inode-&gt;mode = inode-&gt;i_mode;  <br>    raw_inode-&gt;i_uid = fs_high2lowuid(i_uid_read(inode));  <br>    raw_inode-&gt;i_gid = fs_high2lowgid(i_gid_read(inode));  <br>    raw_inode-&gt;i_nlink = inode-&gt;i_nlink;  <br>    raw_inode-&gt;file_size = inode-&gt;i_size;      <br>    raw_inode-&gt;i_atime = (inode-&gt;i_atime.tv_sec);  <br>    raw_inode-&gt;i_mtime = (inode-&gt;i_mtime.tv_sec);  <br>    raw_inode-&gt;i_ctime = (inode-&gt;i_ctime.tv_sec);  <br>    mark_buffer_dirty(bh);  <br>    brelse(bh);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;  <br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°çš„å°†vfs inodeä¸­çš„ç›¸å…³ä¿¡æ¯å­˜å‚¨åˆ°HUST_inodeç»“æ„ä½“ä¸­ï¼Œç„¶åå†™å…¥ç£ç›˜ã€‚è¿™ä¸ªæ˜¯å•ç‹¬çš„å†™å…¥ç£ç›˜æ“ä½œï¼Œäº‹å®ä¸Šï¼Œå½“æˆ‘ä»¬ç”³è¯·inodeæ—¶ï¼Œimapä¹Ÿæ˜¯éœ€è¦æ£€æŸ¥åˆ·æ–°çš„ï¼Œéœ€è¦æŠŠç›¸åº”ä½ç½®æ ‡è®°ä¸º1ã€‚åŒç†ï¼Œevict_inodeå‡½æ•°çš„ä½œç”¨æ—¶åˆ é™¤inodeï¼Œåˆ é™¤æˆåŠŸåï¼Œæˆ‘ä»¬éœ€è¦åˆ·æ–°imapçš„å€¼ï¼ŒæŠŠç›¸åº”ä½ç½®æ ‡è®°ä¸º0ã€‚</p><p>è®¾ç½®å’Œå†™å…¥mapçš„æ“ä½œéƒ½åœ¨map.cä¸­ï¼Œä»¥ä¸‹ä»¥imapä¸ºä¾‹ã€‚å¯¹äºimapæ¥è®²ï¼Œç”³è¯·inodeçš„æ—¶å€™éœ€è¦æ£€æŸ¥ç¬¬ä¸€ä¸ªç©ºé—²çš„inodeç¼–å·ï¼Œå½“inodeè¢«é‡Šæ”¾çš„æ—¶å€™ä¹Ÿè¦åŠæ—¶æ¸…é›¶å¯¹åº”çš„imapã€‚ä¸æ­¤ç›¸å…³çš„å‡½æ•°å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ä»ç£ç›˜ä¸­è¯»å–æ•°æ®å¹¶å­˜åœ¨imapæ•°ç»„ä¸­  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_imap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block* sb, <span class="hljs-type">uint8_t</span>* imap, <span class="hljs-type">ssize_t</span> imap_size)</span>;  <br><span class="hljs-comment">//åœ¨vaddræ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º0çš„bitï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºå®šä½ç©ºinodeæˆ–è€…block  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_find_first_zero_bit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *vaddr, <span class="hljs-type">unsigned</span> size)</span>;  <br><span class="hljs-comment">//å°†imapçš„æŸä¸€ä½ç½®0æˆ–è€…1ï¼Œå¹¶ä¿å­˜åœ¨ç£ç›˜ä¸Š  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">set_and_save_imap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block* sb, <span class="hljs-type">uint64_t</span> inode_num, <span class="hljs-type">uint8_t</span> value)</span>;  <br><span class="hljs-comment">//å®šä¹‰çš„ä½æ“ä½œå®å¦‚ä¸‹  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> setbit(number,x) number |= 1UL &lt;&lt; x  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clearbit(number, x) number &amp;= ~(1UL &lt;&lt; x)  </span><br></code></pre></td></tr></table></figure><p>ç”±äºæœ¬æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸æ˜¯ä¸ºäº†å®é™…ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šè¿°çš„æ“ä½œéƒ½æ²¡æœ‰è€ƒè™‘æ€§èƒ½ä»¥åŠå‡†ç¡®æ€§é—®é¢˜ã€‚äº‹å®ä¸Šï¼Œèƒ½å¤ŸåŠ ä¸Šæ ¡éªŒæˆ–è€…å†—ä½™å¤‡ä»½æ˜¯æœ€å¥½çš„ã€‚</p><h3 id="3-4-è¯»å†™æ–‡ä»¶å†…å®¹"><a href="#3-4-è¯»å†™æ–‡ä»¶å†…å®¹" class="headerlink" title="3.4 è¯»å†™æ–‡ä»¶å†…å®¹"></a>3.4 è¯»å†™æ–‡ä»¶å†…å®¹</h3><p>ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿçœ‹åˆ°æ–‡ä»¶ç³»ç»Ÿåœ¨æ­£å¸¸å·¥ä½œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦å®ç°æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚æ–‡ä»¶è¯»å†™æ“ä½œæŒ‰ç…§ä¸€èˆ¬å¤„ç†ï¼Œåº”è¯¥æ˜¯å®ç°åœ¨struct file_operationsè¿™ä¸ªç»“æ„ä½“ä¸­çš„ã€‚äº‹å®ä¸Šï¼Œæœ€å¼€å§‹æˆ‘æ˜¯å®ç°åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­çš„read_iterå‡½æ•°æŒ‡é’ˆä¸­çš„ã€‚ä½†æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å®ç°äº†struct address_space_operationsç»“æ„ä½“ä¸­çš„å‡½æ•°ï¼Œé‚£ä¹ˆstruct file_operationsç»“æ„ä½“ä¸­çš„å‡½æ•°åˆ™å¯ä»¥äº¤ç”±VFSå®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">HUST_fs_file_ops</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .llseek = generic_file_llseek,  <br>    .mmap = generic_file_mmap,  <br>    .fsync = generic_file_fsync,  <br>    .read_iter = generic_file_read_iter,  <br>    .write_iter = generic_file_write_iter,  <br>&#125;;  <br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>   <span class="hljs-title">address_space_operations</span> <span class="hljs-title">HUST_fs_aops</span> =</span> &#123;  <br>    .readpage = HUST_fs_readpage,  <br>    .writepage = HUST_fs_writepage,  <br>    .write_begin = HUST_fs_write_begin,  <br>    .write_end = generic_write_end,  <br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°çš„genericå¼€å¤´çš„å‡½æ•°æ˜¯ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®ç°çš„ã€‚ä¸Šè¿°çš„address_space_operationsæ“ä½œå…¶å®æ˜¯å®ç°äº†é¡µé«˜é€Ÿç¼“å­˜çš„ä¸€äº›æ“ä½œã€‚é¡µé«˜é€Ÿç¼“å­˜æ˜¯linuxå†…æ ¸å®ç°çš„ä¸€ç§ä¸»è¦ç£ç›˜ç¼“å­˜ï¼Œå®ƒä¸»è¦ç”¨æ¥å‡å°‘å¯¹ç£ç›˜çš„IOæ“ä½œï¼Œå…·ä½“åœ°è®²ï¼Œæ˜¯é€šè¿‡æŠŠç£ç›˜ä¸­çš„æ•°æ®ç¼“å­˜åˆ°ç‰©ç†å†…å­˜ä¸­ï¼ŒæŠŠå¯¹ç£ç›˜çš„è®¿é—®å˜ä¸ºå¯¹ç‰©ç†å†…å­˜çš„è®¿é—®ã€‚è¿™äº›æ¥å£ä¸€æ—¦å®ç°ï¼Œé‚£ä¹ˆå¯¹æ–‡ä»¶çš„æ“ä½œå°±å¯ä»¥è½¬ç§»åˆ°å†…å­˜ä¸­ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨genericå¼€å¤´çš„è¿™äº›å‡½æ•°æ¥ä»£æ›¿æ‰‹å†™ã€‚</p><p>HUST_fs_readpage, HUST_fs_writepageä»¥åŠHUST_fs_write_beginéƒ½è¢«æ³¨å†Œå›è°ƒåˆ°åŒä¸€ä¸ªå‡½æ•°HUST_fs_get_blockã€‚HUST_fs_get_blockä¸»è¦è¿”å›å†…æ ¸è¯·æ±‚é•¿åº¦çš„æ•°æ®ã€‚è‡³äºè¯»å†™æ“ä½œï¼Œå†…æ ¸è°ƒç”¨__bwriteå‡½æ•°æœ€ç»ˆè°ƒç”¨å—è®¾å¤‡é©±åŠ¨æ‰§è¡Œã€‚å› ä¸ºåœ¨æˆ‘æ²¡æœ‰é‡‡ç”¨äºŒçº§æˆ–è€…å¤šçº§ç´¢å¼•ï¼Œæ•…è€ŒHUST_fs_get_blockå‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_get_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-type">sector_t</span> block,  </span><br><span class="hljs-params">              <span class="hljs-keyword">struct</span> buffer_head *bh, <span class="hljs-type">int</span> create)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> inode-&gt;i_sb;  <br>    <span class="hljs-keyword">if</span> (block &gt; HUST_N_BLOCKS) <br>        <span class="hljs-keyword">return</span> -ENOSPC;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_inode</span>;</span>  <br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == HUST_fs_get_inode(sb, inode-&gt;i_ino, &amp;H_inode))  <br>        <span class="hljs-keyword">return</span> -EFAULT;  <br>    <span class="hljs-keyword">if</span> (H_inode.blocks == <span class="hljs-number">0</span>)  <br>        <span class="hljs-keyword">if</span>(alloc_block_for_inode(sb, &amp;H_inode, <span class="hljs-number">1</span>)) <br>            <span class="hljs-keyword">return</span> -EFAULT;  <br>    map_bh(bh, sb, H_inode.block[block]);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè¯¥å‡½æ•°åˆ¤æ–­ä¼ å…¥çš„blockçš„å¤§å°ï¼Œå¹¶å°†ç£ç›˜å†…å®¹æ˜ å°„åˆ°bhä¸­ã€‚åç»­çš„è¯»å†™æ“ä½œå°†æœ‰VFSå¸®æˆ‘ä»¬å®Œæˆã€‚</p><h3 id="3-5-inodeæ“ä½œ"><a href="#3-5-inodeæ“ä½œ" class="headerlink" title="3.5 inodeæ“ä½œ"></a>3.5 inodeæ“ä½œ</h3><p>Inodeæ“ä½œæ¶‰åŠæ–‡ä»¶(å¤¹)çš„åˆ›å»ºåˆ é™¤ï¼Œå°†HUST_inodeæ˜ å°„åˆ°VFSä¸­çš„inodeç­‰æ“ä½œã€‚å…·ä½“å®ç°çš„å‡½æ•°å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_operations</span> <span class="hljs-title">HUST_fs_inode_ops</span> =</span> &#123;  <br>    .lookup = HUST_fs_lookup,  <br>    .mkdir = HUST_fs_mkdir,  <br>    .create = HUST_fs_create,  <br>    .unlink = HUST_fs_unlink,  <br>&#125;; <br></code></pre></td></tr></table></figure><p>HUST_fs_lookupæ˜¯å…¶ä¸­æ¯”è¾ƒå¤æ‚çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè´Ÿè´£å°†ä¸€ä¸ªç›®å½•ä¸‹çš„inodeä¿¡æ¯äº¤ç”±VFSç®¡ç†ã€‚é¦–å…ˆï¼ŒHUST_fs_lookupè¯»å–æ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œç„¶åéå†æ–‡ä»¶å¤¹ä¸‹é¢çš„HUST_inodeï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„HUST_inodeï¼Œæ ¹æ®ä¸åŒçš„æ–‡ä»¶å±æ€§ï¼Œç”³è¯·vfs_inodeï¼›å¹¶å¯¹ä¸åŒçš„vfs_inodeè®¾ç½®ä¸åŒçš„æ“ä½œã€‚å‡è®¾vfs_inodeå¯¹åº”çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±è®¾ç½®vfs_inode-&gt;mapping-&gt;a_opsï¼Œå¦‚æœvfs_inodeå¯¹åº”çš„æ˜¯æ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆå°±è®¾ç½®vfs_inode-&gt;f_ops &#x3D; &amp;HUST_fs_dir_ops;æœ€åå°†vfs_inodeæ³¨å†Œåˆ°VFSä¸­ã€‚è¿™éƒ¨åˆ†çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> dentry *<span class="hljs-title function_">HUST_fs_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *parent_inode,  </span><br><span class="hljs-params">                  <span class="hljs-keyword">struct</span> dentry *child_dentry, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> parent_inode-&gt;i_sb;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_inode</span>;</span>  <br><span class="hljs-comment">//çœç•¥ä»£ç   </span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; H_inode.dir_children_count; i++) &#123;  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>  <br>            (child_dentry-&gt;d_name.name, dtptr[i].filename,  <br>             HUST_FILENAME_MAX_LEN) == <span class="hljs-number">0</span>)&#123;  <br>            inode = iget_locked(sb, dtptr[i].inode_no);  <br>            <span class="hljs-keyword">if</span> (inode-&gt;i_state &amp; I_NEW) &#123;  <br>                inode_init_owner(inode, parent_inode, <span class="hljs-number">0</span>);  <br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_child_inode</span>;</span>  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == HUST_fs_get_inode(sb, dtptr[i].inode_no, &amp;H_child_inode))  <br>                    <span class="hljs-keyword">return</span> ERR_PTR(-EFAULT);  <br>                HUST_fs_convert_inode(&amp;H_child_inode, inode);  <br>                inode-&gt;i_op = &amp;HUST_fs_inode_ops;  <br>                <span class="hljs-keyword">if</span> (S_ISDIR(H_child_inode.mode)) &#123;  <br>                    inode-&gt;i_fop = &amp;HUST_fs_dir_ops;  <br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISREG(H_child_inode.mode)) &#123;  <br>                    inode-&gt;i_fop = &amp;HUST_fs_file_ops;;  <br>                    inode-&gt;i_mapping-&gt;a_ops = &amp;HUST_fs_aops;  <br>                &#125;  <br>                inode-&gt;i_mode = H_child_inode.mode;  <br>                inode-&gt;i_size = H_child_inode.file_size;  <br>                insert_inode_hash(inode);  <br>                unlock_new_inode(inode);  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br><span class="hljs-comment">//çœç•¥ä»£ç   </span><br>&#125; <br></code></pre></td></tr></table></figure><p>åªæœ‰åœ¨è¿™é‡Œæ³¨å†Œäº†ç›¸å…³å‡½æ•°ï¼Œç³»ç»Ÿè°ƒç”¨æ‰èƒ½æ­£å¸¸æ‰§è¡Œã€‚ä¸ç„¶å°±ä¼šå‡ºç°ä¸æ”¯æŒçš„æ“ä½œè¿™ç§æŠ¥é”™ä¿¡æ¯ã€‚</p><p>.createä¸.mkdiréƒ½æ˜¯å¯¹åº”äº†inodeçš„åˆ›å»ºï¼Œåªæ˜¯inodeçš„å±æ€§ä¸èƒ½è€Œå·²ã€‚.createåˆ›å»ºæ™®é€šæ–‡ä»¶è€Œ.mkdiråˆ›å»ºæ–‡ä»¶å¤¹ã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½è¢«å‡½æ•°HUST_fs_create_objæ‰€å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°æ¥å—æ–°å»ºæ–‡ä»¶ï¼ˆå¤¹ï¼‰çš„è¯·æ±‚ï¼Œæ£€æŸ¥ç£ç›˜çš„å¤§å°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç©ºä½™çš„indoeï¼Œå¹¶ä¸”åˆ†é…inodeå·ï¼Œç„¶åæ›´æ–°imapä¿¡æ¯ï¼Œæœ€åæ›´æ–°è¶…çº§å—ä¿¡æ¯ã€‚ç”±äºè¯¥å‡½æ•°é€»è¾‘ç®€å•ä½†æ˜¯ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæ•…è€Œä¸åœ¨æ­¤å±•ç¤ºå…¶å…·ä½“å®ç°ã€‚</p><p>åœ¨å®Œæˆä¸Šè¿°å·¥ä½œä¹‹åï¼Œæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»ŸåŸºæœ¬å·²ç»å®Œæˆäº†ï¼Œè¿™ä¸ªç³»ç»Ÿé‡‡ç”¨çº¿æ€§ï¼ˆåŒºåˆ«äºminixiäºŒçº§ç´¢å¼•ç”¨æ ‘æ¥ç®¡ç†ï¼‰çš„æ–¹å¼ç®¡ç†ç£ç›˜ç©ºé—´ï¼Œæ”¯æŒåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ–‡ä»¶æ“ä½œï¼Œæ”¯æŒæ–‡ä»¶æƒé™ï¼Œæ”¯æŒå¤šç”¨æˆ·ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android HIDLæœåŠ¡å®ç°</title>
    <link href="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-HIDLæœåŠ¡å®ç°"><a href="#Android-HIDLæœåŠ¡å®ç°" class="headerlink" title="Android HIDLæœåŠ¡å®ç°"></a>Android HIDLæœåŠ¡å®ç°</h1><blockquote><p><a href="https://www.jianshu.com/p/b75c4321ae0a">https://www.jianshu.com/p/b75c4321ae0a</a></p></blockquote><p><strong>Android O(8.0)</strong> ç‰ˆæœ¬ä¹‹åï¼Œåº•å±‚å®ç°æœ‰äº†æ¯”è¾ƒå¤§çš„å˜åŒ–ï¼Œæœ€æ˜¾è‘—çš„ä¸€ä¸ªæ–¹é¢å°±æ˜¯ <strong>HIDL</strong> æœºåˆ¶çš„å…¨é¢å®æ–½ã€‚æœ¬æ–‡å°†ä» <strong>HIDLçš„åŸºæœ¬æ¦‚å¿µ</strong>ã€<strong>HIDLæœåŠ¡æ¨¡æ‹Ÿ</strong>ã€<strong>frameworkå±‚aidlæœåŠ¡</strong>ã€<strong>åº”ç”¨å±‚ç¨‹åº</strong> è¿™å››ä¸ªæ–¹é¢æ¥å…¨é¢çš„é˜è¿° <strong>HIDL</strong> å·¥ä½œå…¨è¿‡ç¨‹ï¼Œè¿™å¯¹äºç†è§£ç³»ç»Ÿæºç ä¸­ <strong>Gnss</strong>ã€<strong>Usb</strong>ã€<strong>Camera</strong> ç­‰æ¨¡å—çš„å·¥ä½œåŸç†æœ‰æå¤§å¸®åŠ©ã€‚</p><h2 id="1-HIDLè®¾è®¡ç›®çš„"><a href="#1-HIDLè®¾è®¡ç›®çš„" class="headerlink" title="1. HIDLè®¾è®¡ç›®çš„"></a>1. HIDLè®¾è®¡ç›®çš„</h2><p>åœ¨ <strong>Android O(8.0)</strong> ä¹‹å‰ç³»ç»Ÿçš„å‡çº§ç‰µæ‰¯å¤šæ–¹åä½œï¼Œæä¸ºéº»çƒ¦ï¼Œ<strong>HIDL</strong>æœºåˆ¶çš„æ¨å‡ºå°±æ˜¯å°† <strong>framework</strong> ä¸ <strong>hal</strong> å±‚åˆ†å¼€ï¼Œä½¿å¾—æ¡†æ¶éƒ¨åˆ†å¯ä»¥ç›´æ¥è¢«è¦†ç›–ã€æ›´æ–°ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯¹ HAL è¿›è¡Œç¼–è¯‘ï¼Œè¿™æ ·åœ¨ç³»ç»Ÿå‡çº§æ—¶ï¼Œ<strong>OEM</strong> å‚å•† è·³è¿‡ <strong>SoC</strong> å‚å•†ï¼Œå…ˆå¯¹ <strong>framework</strong> è¿›è¡Œå‡çº§ã€‚</p><h3 id="1-1-Android-8-0ä¹‹å‰"><a href="#1-1-Android-8-0ä¹‹å‰" class="headerlink" title="1.1 Android 8.0ä¹‹å‰"></a>1.1 Android 8.0ä¹‹å‰</h3><p><strong>framework</strong> ä¸ <strong>hal</strong> ç´§ç´§è€¦åˆå­˜åœ¨äº <strong>system.img</strong> ä¸­ï¼Œå› æ­¤åœ¨ç‰ˆæœ¬å‡çº§æ—¶éœ€è¦: <strong>OEM</strong> å‚å•†é€‚é… <strong>framework</strong> ï¼Œ<strong>SoCå‚å•†</strong> é€‚é… <strong>hal</strong>ï¼Œ ä¹‹åå°†ä¿®æ”¹æ‰“åŒ…åˆ° <strong>system.img</strong>ï¼Œç”Ÿæˆ OTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡Œ OTA å‡çº§</p><h3 id="1-2-Android-8-0ä¹‹å"><a href="#1-2-Android-8-0ä¹‹å" class="headerlink" title="1.2 Android 8.0ä¹‹å"></a>1.2 Android 8.0ä¹‹å</h3><p><strong>framework</strong> ä¸ <strong>hal</strong> è¿›è¡Œäº†è§£è€¦ï¼Œ <strong>framework</strong> å­˜åœ¨äº <strong>system.img</strong>ï¼Œ<strong>hal</strong> å­˜åœ¨äº<strong>vendor.img</strong>ï¼Œè¿›è¡Œç‰ˆæœ¬å‡çº§æ—¶ï¼Œåˆ†ä¸ºä¸¤æ¬¡å‡çº§:</p><ul><li><strong>frameworkå‡çº§</strong> ï¼š OEM å‚å•†é€‚é… frameworkï¼Œå°†ä¿®æ”¹æ‰“åŒ…åˆ° system.imgï¼Œ ç”ŸæˆOTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡Œ OTA å‡çº§(framework å‘ç”Ÿæ”¹å˜ï¼Œhal å±‚æœªå˜)ã€‚</li><li><strong>halå‡çº§</strong> ï¼šSoC å‚å•†é€‚é… halï¼Œ å°†ä¿®æ”¹æ‰“åŒ…åˆ° vendor.img, ç”ŸæˆOTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡ŒOTAå‡çº§(frameworkå‘ç”Ÿæ”¹å˜ï¼Œhal å±‚å‘ç”Ÿæ”¹å˜)ã€‚</li></ul><h2 id="2-HIDLæœºåˆ¶æ¼”è¿›"><a href="#2-HIDLæœºåˆ¶æ¼”è¿›" class="headerlink" title="2.HIDLæœºåˆ¶æ¼”è¿›"></a>2.HIDLæœºåˆ¶æ¼”è¿›</h2><h3 id="2-1-è€ç‰ˆæœ¬-Framework-ä¸-HAL-çš„é€šä¿¡æ¡†æ¶"><a href="#2-1-è€ç‰ˆæœ¬-Framework-ä¸-HAL-çš„é€šä¿¡æ¡†æ¶" class="headerlink" title="2.1 è€ç‰ˆæœ¬ Framework ä¸ HAL çš„é€šä¿¡æ¡†æ¶"></a>2.1 è€ç‰ˆæœ¬ Framework ä¸ HAL çš„é€šä¿¡æ¡†æ¶</h3><p>æ­£å¦‚ä¸Šè¿°æ‰€è¨€ï¼Œæ—§ç‰ˆçš„ç³»ç»Ÿæ¶æ„ä¸­ï¼Œ Android Framework å±‚ä¸ Hal å±‚æ˜¯æ‰“åŒ…æˆä¸€ä¸ª <strong>system.img</strong> çš„ï¼Œä¸” Framework ä¸ hal å±‚ä¹‹é—´æ˜¯ç´§å¯†è€¦åˆçš„ï¼Œé€šè¿‡é“¾æ¥çš„æ–¹å¼ä½¿ç”¨ç›¸åº”çš„ç¡¬ä»¶ <strong>so</strong> åº“ã€‚å®ƒä»¬ä¹‹é—´çš„æ¶æ„ä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-0fed2e7f185e551d.png" style="zoom:80%;"><h3 id="2-2-HIDL-ç±»å‹ä»‹ç»"><a href="#2-2-HIDL-ç±»å‹ä»‹ç»" class="headerlink" title="2.2  HIDL ç±»å‹ä»‹ç»"></a>2.2  HIDL ç±»å‹ä»‹ç»</h3><p>ä¸ºäº†è§£å†³ä¸¤è€…ä¹‹é—´è¿™ç§ç´§è€¦åˆæ‰€å¸¦æ¥çš„å¼Šç«¯ï¼Œgoogle å¼•å…¥ HIDL æ¥å®šä¹‰ Framework ä¸ HAL ä¹‹é—´çš„æ¥å£ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-ea297e84897f8686.webp" style="zoom:80%;"><p>äº‹å®ä¸Šè™½ç„¶ google æ¨å‡ºäº†è¿™ç§æœºåˆ¶ï¼Œä½†æ˜¯å¾ˆå¤šå‚å•†æ²¡æœ‰å¾ˆå¿«çš„è·Ÿä¸ŠèŠ‚å¥ï¼Œå› æ­¤ä¸ºäº†å‘å‰å…¼å®¹ï¼Œ google å®šä¹‰äº†ä¸‰ç§ç±»å‹ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-5b8123370101b01f.png" style="zoom: 67%;"><p>â‘  æ˜¯ Treble Project ä¹‹å‰ä½¿ç”¨çš„å®ç°æ¶æ„ï¼Œä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿ HAL å’Œæ—§ç‰ˆ HAL</p><p>â‘¡ ç›´é€šæ¨¡å¼ï¼Œpassthrough modeã€‚å¦‚å›¾æ‰€ç¤ºï¼ŒFramework å’Œ HAL å±‚å·¥ä½œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å½“ä¸­ï¼Œä¸‹é¢çš„ HAL æ˜¯ä½¿ç”¨ HIDL å°è£…åçš„åº“ï¼Œæ˜¯ç›´é€šå¼ HALã€‚è¿™äº›åº“æ–‡ä»¶ä¹Ÿå¯ç”¨äº â‘¢ ç»‘å®šæ¨¡å¼</p><p>â‘¢ ç»‘å®šæ¨¡å¼ï¼Œbinderized modeã€‚æ˜¯ç›´é€šå¼ HAL binder åŒ–ï¼Œå˜ä¸ºç»‘å®šå¼ HALã€‚Framework å’Œ HAL å±‚å·¥ä½œåœ¨ä¸åŒçš„è¿›ç¨‹ï¼Œä¹‹é—´é€šè¿‡ Binder è¿›è¡Œ IPC</p><p>â‘£ çº¯ç»‘å®šå¼ã€‚ç›¸å¯¹äº â‘¢ æ¥è¯´ï¼Œç»‘å®šå¼ HAL ä¸­å¹¶ä¸åŒ…å«ç›´é€šå¼ HALï¼Œå› æ­¤ç§°ä¸ºçº¯ç»‘å®šå¼</p><p><strong>ä¸Šè¿°å¯æ€»ç»“ä¸º</strong>ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-619180c0c7f8afc5.png" style="zoom: 67%;"><h2 id="3-Binderized-Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹"><a href="#3-Binderized-Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹" class="headerlink" title="3.Binderized Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹"></a>3.Binderized Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹</h2><p>ä»¬çŸ¥é“ <strong>ç»‘å®šæ¨¡å¼</strong> æ˜¯ google ä¸ºäº†å‘å‰å…¼å®¹è€Œå®šä¹‰çš„ä¸€ç§ç±»å‹ï¼Œä¸” Android 8.0 åŠåç»­ç‰ˆæœ¬çš„è®¾å¤‡éƒ½å¿…é¡»åªæ”¯æŒè¿™ç§æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ Framework ä¸ Hal åˆ†åˆ«ä½äºä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå…¶å®ä»å…·ä½“å®ç°æ¥è®²è¿™ç§æ¨¡å¼ä¹Ÿæ›´åº”è¯¥è¢«ç§°ä¸º <strong>Binder åŒ–çš„ç›´é€šå¼</strong>ã€‚æœ¬æ–‡å°†é€šè¿‡è¿™ç§æ–¹å¼å®ç°ä¸€ä¸ª <strong>HIDL</strong> æœåŠ¡ã€‚</p><h2 id="4-ç¯å¢ƒ-x2F-å·¥å…·å‡†å¤‡"><a href="#4-ç¯å¢ƒ-x2F-å·¥å…·å‡†å¤‡" class="headerlink" title="4.ç¯å¢ƒ&#x2F;å·¥å…·å‡†å¤‡"></a>4.ç¯å¢ƒ&#x2F;å·¥å…·å‡†å¤‡</h2><ul><li>Ubuntu 20.04 TLS</li><li>Android æºç ï¼šAndroid 9.0ï¼Œç¼–è¯‘çƒ§å½•è¯¦è§ <a href="https://www.jianshu.com/p/848414148272">Androidæºç ç¼–è¯‘çƒ§å½•</a></li><li>hidl-gen å·¥å…·ï¼šAndroid ç³»ç»Ÿè‡ªå¸¦ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡</li></ul><h2 id="5-HIDLå®ç°"><a href="#5-HIDLå®ç°" class="headerlink" title="5.HIDLå®ç°"></a>5.HIDLå®ç°</h2><p>æœ¬æ–‡ç›®çš„æ˜¯å®ç°ä¸€ä¸ªå…·æœ‰ <strong>åŠ å‡ä¹˜é™¤</strong> è¿ç®—çš„ HIDL æœåŠ¡,å‘½åä¸º <strong>é“¶æ²³ä¸€å·(GalaxyOne)<strong>ã€‚HIDLç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œåœ¨ç³»ç»Ÿæºç ä¸­çš„ <strong>hardware&#x2F;interfaces</strong> ç›®å½•ä¸‹æœ‰å¾ˆå¤šçš„ HIDLï¼Œæˆ‘ä»¬ä»¿ç…§å…¶ä»– HIDL æ¥åˆ›å»ºè‡ªå·±çš„ç›®å½•ï¼š</strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong></p><h3 id="5-1-åˆ›å»ºIGalaxyOne-hal-æ–‡ä»¶"><a href="#5-1-åˆ›å»ºIGalaxyOne-hal-æ–‡ä»¶" class="headerlink" title="5.1 åˆ›å»ºIGalaxyOne.hal æ–‡ä»¶"></a>5.1 åˆ›å»ºIGalaxyOne.hal æ–‡ä»¶</h3><p><strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;IGalaxyOne.hal</strong></p><p>è¿™é‡Œå®šä¹‰äº†å››ç§åŸºæœ¬çš„è¿ç®—ï¼šåŠ ã€å‡ã€ä¹˜ã€é™¤ï¼Œè¿™æ˜¯ä¸Šå±‚è°ƒç”¨ HAL çš„å…¥å£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">package android.hardware.galaxy_one@<span class="hljs-number">1.0</span>;<br><br>interface IGalaxyOne&#123;<br><br>    <span class="hljs-comment">//åŠ æ³•</span><br>    add(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//å‡æ³•</span><br>    sub(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//ä¹˜æ³•</span><br>    mul(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//é™¤æ³•</span><br>    div(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="5-2-hidl-genç”ŸæˆHIDLæ¡†æ¶"><a href="#5-2-hidl-genç”ŸæˆHIDLæ¡†æ¶" class="headerlink" title="5.2 hidl-genç”ŸæˆHIDLæ¡†æ¶"></a>5.2 hidl-genç”ŸæˆHIDLæ¡†æ¶</h3><p>åœ¨ä½¿ç”¨ hidl-gen ä¹‹å‰éœ€è¦å…ˆåšä¸¤ä»¶äº‹ï¼š<br>1ã€hidl-gen ç”± Android æä¾›ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦å…ˆé…ç½®ä¸€ä¸‹ç³»ç»Ÿè·¯å¾„ï¼Œå¦‚æˆ‘è¿™é‡Œæ‰€åšçš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># vim ~/.bashrc</span><br>export PATH=/home/zsk/AOSP/out/soong/host/linux-x86/bin:$PATH<br></code></pre></td></tr></table></figure><p>2ã€Ubuntu æ–°çš„ç»ˆç«¯çª—å£å¿…é¡»å…ˆè®¾å®šä¸€äº› Android ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">source build/envsetup.sh<br>lunch aosp_sailfish-userdebug  <span class="hljs-comment">// lunch mode æ ¹æ®éœ€æ±‚ä¿®æ”¹</span><br>make hidl-gen<br></code></pre></td></tr></table></figure><p>é…ç½®å®Œæˆä¹‹ååœ¨ <strong>æºç æ ¹ç›®å½•</strong> ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">PACKAGE=android.hardware.galaxy_one@<span class="hljs-number">1.0</span><br>LOC=hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/<br>    <br>hidl-gen -o $LOC -Lc++-impl -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE<br><br>hidl-gen -o $LOC -Landroidbp-impl -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE<br></code></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡ŒæˆåŠŸä¹‹åä¼šå‘ç°åœ¨ <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª <strong>default</strong> ç›®å½•ï¼Œè¿›å…¥ä¹‹åå‘ç°æœ‰å¦‚ä¸‹æ–‡ä»¶ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-0096f7494b4dbff9.png" style="zoom: 80%;"><p>ä¹‹åæ‰§è¡Œ <strong>update-makefiles.sh</strong> è„šæœ¬æ¥ä¸º HIDL ç”Ÿæˆå¯¹åº”çš„ <strong>Android.bp</strong> æ–‡ä»¶ï¼Œæ­¤è„šæœ¬ä½äº <strong>hardware&#x2F;interfaces</strong> ç›®å½•ä¸‹ï¼ŒåŒæ ·å¯åœ¨æºç æ ¹ç›®å½•ä¸‹æ‰§è¡Œ:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">./hardware/interfaces/update-makefiles.sh<br></code></pre></td></tr></table></figure><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-5ea845283e2c2d58.png" style="zoom: 80%;"><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸¤ä¸ªç©ºæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">touch hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/android.hardware.galaxy_one@<span class="hljs-number">1.0</span>-service.rc<br>touch hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/service.cpp<br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹åï¼Œæ•´ä¸ªå·¥ç¨‹ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-118902147dc61749.png" style="zoom: 80%;"><h3 id="5-3-è°ƒç”¨æµç¨‹"><a href="#5-3-è°ƒç”¨æµç¨‹" class="headerlink" title="5.3 è°ƒç”¨æµç¨‹"></a>5.3 è°ƒç”¨æµç¨‹</h3><p>ä¸Šè¿°è¿‡ç¨‹å·²ç»å°† HIDL æœåŠ¡æ‰€éœ€è¦çš„å…¨æœ¬æ–‡ä»¶é…ç½®å®Œæˆï¼Œè™½ç„¶å…¶ä¸­å¾ˆå¤šæ–‡ä»¶æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ²¡æœ‰å…·ä½“å®ç°ï¼Œæˆ‘ä»¬ç°åœ¨å…ˆæ”¾åœ¨ä¸€è¾¹ï¼Œå…ˆæ¥å¯¹æ•´ä½“çš„è°ƒç”¨æµç¨‹åŠå„ä¸ªæ–‡ä»¶çš„åŠŸæ•ˆç•¥ä½œè¯´æ˜ã€‚</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-865d0cf346cee965.png" style="zoom: 80%;"><ul><li>Applicationï¼šæŒ‡ä¸Šå±‚åº”ç”¨</li><li>JNIï¼šæŒ‡ framework å±‚ï¼ŒgetService è·å– hal å±‚ service</li><li><a href="mailto:&#97;&#110;&#100;&#x72;&#111;&#105;&#100;&#46;&#104;&#x61;&#x72;&#x64;&#x77;&#x61;&#114;&#101;&#x2e;&#103;&#97;&#x6c;&#97;&#120;&#x79;&#x5f;&#111;&#110;&#101;&#x40;&#49;&#46;&#48;&#46;&#x73;&#111;">&#97;&#110;&#100;&#x72;&#111;&#105;&#100;&#46;&#104;&#x61;&#x72;&#x64;&#x77;&#x61;&#114;&#101;&#x2e;&#103;&#97;&#x6c;&#97;&#120;&#x79;&#x5f;&#111;&#110;&#101;&#x40;&#49;&#46;&#48;&#46;&#x73;&#111;</a>ï¼šç”± IGalaxyOne.hal ç”Ÿæˆçš„æ¥å£åº“ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;Android.bp</strong> é€šè¿‡ <strong>IGalaxyOne.hal</strong> ç”Ÿæˆï¼Œè¿™æ ·åªè¦è¿™ä¸ªæ¥å£åº“ä¸å˜ï¼Œé‚£ä¹ˆ framework çš„æ›´æ–°å’Œ hal å±‚å°±éš”ç»å¼€äº†</li><li><a href="mailto:&#x61;&#x6e;&#100;&#x72;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#46;&#48;&#45;&#115;&#101;&#x72;&#118;&#105;&#99;&#x65;&#46;&#x72;&#x63;">&#x61;&#x6e;&#100;&#x72;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#46;&#48;&#45;&#115;&#101;&#x72;&#118;&#105;&#99;&#x65;&#46;&#x72;&#x63;</a>ï¼šè®¾å¤‡å¼€æœºæ—¶é€šè¿‡ <strong>rc</strong> æ–‡ä»¶å¯åŠ¨æ­¤æœåŠ¡</li><li>galaxy_hal_serviceï¼šserviceçš„åï¼Œå¯é€šè¿‡ <strong>start galaxy_hal_service</strong> å¯åŠ¨æœåŠ¡ï¼Œç”±service.cppç¼–è¯‘ç”Ÿæˆ</li><li><a href="mailto:&#x61;&#110;&#x64;&#114;&#111;&#105;&#100;&#x2e;&#x68;&#x61;&#114;&#100;&#119;&#97;&#x72;&#x65;&#46;&#103;&#x61;&#108;&#97;&#120;&#x79;&#95;&#x6f;&#110;&#x65;&#64;&#x31;&#46;&#x30;&#45;&#x69;&#109;&#112;&#x6c;&#x2e;&#115;&#111;">&#x61;&#110;&#x64;&#114;&#111;&#105;&#100;&#x2e;&#x68;&#x61;&#114;&#100;&#119;&#97;&#x72;&#x65;&#46;&#103;&#x61;&#108;&#97;&#120;&#x79;&#95;&#x6f;&#110;&#x65;&#64;&#x31;&#46;&#x30;&#45;&#x69;&#109;&#112;&#x6c;&#x2e;&#115;&#111;</a>ï¼šå®ç°åº“ï¼Œä¸Šå±‚åº”ç”¨çš„æœ€ç»ˆè°ƒç”¨ï¼Œç”±GalaxyOne.cppç¼–è¯‘ç”Ÿæˆ</li></ul><p>å…³äº <strong>Applicationã€JNI</strong> è¿™ä¸¤å±‚å†…å®¹ä¼šåœ¨ç¨åç”¨ä¸¤ä¸ªç¯‡å¹…å»åˆ†æï¼Œæ­¤å¤„æš‚ä¸ç†ä¼šã€‚ç°åœ¨æˆ‘ä»¬å°±ç€è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹å°†éœ€è¦çš„å†…å®¹è¡¥å……å®Œæˆã€‚æ˜å‡ºå¤„ã€‚</p><h4 id="5-3-1-æ¥å£åº“ç”Ÿæˆ"><a href="#5-3-1-æ¥å£åº“ç”Ÿæˆ" class="headerlink" title="5.3.1 æ¥å£åº“ç”Ÿæˆ"></a>5.3.1 æ¥å£åº“ç”Ÿæˆ</h4><p><a href="mailto:&#97;&#110;&#100;&#114;&#111;&#x69;&#100;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#103;&#x61;&#x6c;&#x61;&#120;&#x79;&#95;&#111;&#x6e;&#101;&#64;&#x31;&#x2e;&#x30;&#x2e;&#115;&#x6f;">&#97;&#110;&#100;&#114;&#111;&#x69;&#100;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#103;&#x61;&#x6c;&#x61;&#120;&#x79;&#95;&#111;&#x6e;&#101;&#64;&#x31;&#x2e;&#x30;&#x2e;&#115;&#x6f;</a>ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;Android.bp</strong> é€šè¿‡ <strong>IGalaxyOne.hal</strong> ç”Ÿæˆï¼ŒAndroid.bp æ–‡ä»¶æ˜¯åœ¨ä¸Šé¢ä¸€äº›åˆ—å‘½ä»¤æ‰§è¡Œä¹‹åç”Ÿæˆï¼Œè€Œæ¥å£åº“æ˜¯å½“æˆ‘ä»¬æœ€ç»ˆæ‰§è¡Œç¼–è¯‘æ¨¡å—æ—¶ç”Ÿæˆï¼Œå¯ä»¥è¯´è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å‚ä¸ï¼ŒAndroid.bp å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile">// This file is autogenerated by hidl-gen -Landroidbp.<br><br>hidl_interface &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,   //æ­¤å¤„è®¾ç½®æ¥å£åº“çš„åå­—<br>    root: <span class="hljs-string">&quot;android.hardware&quot;</span>,<br>    vndk: &#123;<br>        enabled: true,<br>    &#125;,<br>    srcs: [<br>        <span class="hljs-string">&quot;IGalaxyOne.hal&quot;</span>,<br>    ],<br>    interfaces: [<br>        <span class="hljs-string">&quot;android.hidl.base@1.0&quot;</span>,<br>    ],<br>    gen_java: true,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-2-å®ç°åº“ç”Ÿæˆ"><a href="#5-3-2-å®ç°åº“ç”Ÿæˆ" class="headerlink" title="5.3.2 å®ç°åº“ç”Ÿæˆ"></a>5.3.2 å®ç°åº“ç”Ÿæˆ</h4><p><a href="mailto:&#97;&#x6e;&#x64;&#114;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#100;&#119;&#x61;&#114;&#101;&#x2e;&#103;&#x61;&#108;&#x61;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#x65;&#64;&#x31;&#46;&#48;&#x2d;&#105;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;">&#97;&#x6e;&#x64;&#114;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#100;&#119;&#x61;&#114;&#101;&#x2e;&#103;&#x61;&#108;&#x61;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#x65;&#64;&#x31;&#46;&#48;&#x2d;&#105;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;</a>ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;default&#x2F;Android.bp</strong> é€šè¿‡ <strong>GalaxyOne.cpp</strong> ç”Ÿæˆï¼Œæ³¨æ„è¿™ä¸ª Android.bp æ–‡ä»¶æ˜¯ä½äº <strong>default</strong> ç›®å½•ä¸‹ï¼ŒåŒæ ·çš„åœ¨æœ€åæ¨¡å—ç¼–è¯‘æ—¶ç”Ÿæˆï¼ŒåŸå§‹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile">cc_library_shared &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-impl&quot;</span>,<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br>    proprietary: true,<br>    srcs: [<br>        <span class="hljs-string">&quot;GalaxyOne.cpp&quot;</span>,<br>    ],<br>    shared_libs: [    //è¿™é‡Œå¯ä»¥æ·»åŠ æˆ‘ä»¬éœ€è¦çš„åº“<br>        <span class="hljs-string">&quot;liblog&quot;</span>,     <br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-3-GalaxyOne-cppå®ç°"><a href="#5-3-3-GalaxyOne-cppå®ç°" class="headerlink" title="5.3.3 GalaxyOne.cppå®ç°"></a>5.3.3 GalaxyOne.cppå®ç°</h4><p>åœ¨ <strong>5.3.2</strong> ä¸­ï¼Œå®ç°åº“æ˜¯ç”± <strong>GalaxyOne.cpp</strong> ç¼–è¯‘è€Œæˆï¼Œç°åœ¨æˆ‘ä»¬æ¥å°†æ­¤æ–‡ä»¶è¡¥å……å®Œæˆï¼š</p><p><strong>GalaxyOne.h:</strong><br> BinderåŒ–ç›´é€šå¼ï¼ŒåŒæ ·éœ€è¦å°† HIDL_FETCH_XXX æ‰“å¼€ï¼Œè‡³äºåŸå› æˆ‘ä»¬åœ¨åé¢ä¼šæåŠ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/MQDescriptor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;log/log.h&gt;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> galaxy_one &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><span class="hljs-keyword">namespace</span> implementation &#123;<br><br><span class="hljs-keyword">using</span> ::android::hardware::hidl_array;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_memory;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_string;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_vec;<br><span class="hljs-keyword">using</span> ::android::hardware::Return;<br><span class="hljs-keyword">using</span> ::android::hardware::Void;<br><span class="hljs-keyword">using</span> ::android::sp;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GalaxyOne</span> : <span class="hljs-keyword">public</span> IGalaxyOne &#123;<br>    <span class="hljs-comment">// Methods from ::android::hardware::galaxy_one::V1_0::IGalaxyOne follow.</span><br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">sub</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">mul</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">div</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br><br>    <span class="hljs-comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span><br><br>&#125;;<br><br><span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> most likely delete, this is only for passthrough implementations</span><br> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">IGalaxyOne* <span class="hljs-title">HIDL_FETCH_IGalaxyOne</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span></span>;<br><br>&#125;  <span class="hljs-comment">// namespace implementation</span><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace galaxy_one</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace android</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span></span><br><br></code></pre></td></tr></table></figure><p><strong>GalaxyOne.cpp:</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;GalaxyOne.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> galaxy_one &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><span class="hljs-keyword">namespace</span> implementation &#123;<br><br><span class="hljs-comment">// Methods from ::android::hardware::galaxy_one::V1_0::IGalaxyOne follow.</span><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::add</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a + b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::add  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::sub</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a - b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::sub  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::mul</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a * b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::mul  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::div</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a / b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::div  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span><br><span class="hljs-function">IGalaxyOne* <span class="hljs-title">HIDL_FETCH_IGalaxyOne</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-comment">/* name */</span>)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOG</span>(<span class="hljs-string">&quot;galaxy_one service init success....&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">GalaxyOne</span>();<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace implementation</span><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace galaxy_one</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace android</span><br></code></pre></td></tr></table></figure><h4 id="5-3-4-æ¨¡å—ç¼–è¯‘"><a href="#5-3-4-æ¨¡å—ç¼–è¯‘" class="headerlink" title="5.3.4 æ¨¡å—ç¼–è¯‘"></a>5.3.4 æ¨¡å—ç¼–è¯‘</h4><p>ç°åœ¨é™¤äº†éœ€è¦çš„ <strong>rc</strong> æ–‡ä»¶æ²¡æœ‰è¡¥å……ã€<strong>galaxy-hal-service</strong> æœåŠ¡æ²¡æœ‰ç”Ÿæˆå¤–å…¶ä½™å‡å·²é…ç½®å¥½äº†ï¼Œç°åœ¨è¿›è¡Œç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„åº“ã€‚è¿›å…¥æ ¹ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š(æ³¨æ„æ˜¯åœ¨åˆšåˆšæ‰§è¡Œè¿‡çš„ <strong>source build&#x2F;envsetup.sh</strong> å’Œ <strong>lunch</strong> çš„çª—å£ä¸‹ç¼–è¯‘ï¼Œè‹¥æ˜¯æ–°çª—å£åˆ™éœ€è¦é‡æ–°æ‰§è¡Œè¿™ä¸¤æ¡å‘½ä»¤)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mmm  hardware/interfaces/galaxy_one/1.0<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶åº”è¯¥å¯ä»¥åœ¨ <strong>out&#x2F;tartget&#x2F;product&#x2F;XXX&#x2F;vendor&#x2F;lib64&#x2F;hw</strong> å’Œ <strong>out&#x2F;tartget&#x2F;product&#x2F;XXX&#x2F;system&#x2F;lib64&#x2F;hw</strong> ç›®å½•ä¸‹æ‰¾åˆ° <strong><a href="mailto:&#97;&#x6e;&#100;&#114;&#111;&#x69;&#x64;&#46;&#x68;&#x61;&#114;&#100;&#x77;&#x61;&#x72;&#x65;&#46;&#103;&#97;&#x6c;&#x61;&#120;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#x31;&#x2e;&#48;&#45;&#x69;&#x6d;&#112;&#108;&#x2e;&#x73;&#x6f;">&#97;&#x6e;&#100;&#114;&#111;&#x69;&#x64;&#46;&#x68;&#x61;&#114;&#100;&#x77;&#x61;&#x72;&#x65;&#46;&#103;&#97;&#x6c;&#x61;&#120;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#x31;&#x2e;&#48;&#45;&#x69;&#x6d;&#112;&#108;&#x2e;&#x73;&#x6f;</a></strong> å’Œ <strong><a href="mailto:&#x61;&#110;&#x64;&#x72;&#x6f;&#105;&#100;&#x2e;&#x68;&#97;&#114;&#100;&#x77;&#97;&#x72;&#101;&#x2e;&#103;&#97;&#108;&#x61;&#x78;&#x79;&#x5f;&#111;&#110;&#x65;&#64;&#49;&#x2e;&#48;&#x2e;&#115;&#111;">&#x61;&#110;&#x64;&#x72;&#x6f;&#105;&#100;&#x2e;&#x68;&#97;&#114;&#100;&#x77;&#97;&#x72;&#101;&#x2e;&#103;&#97;&#108;&#x61;&#x78;&#x79;&#x5f;&#111;&#110;&#x65;&#64;&#49;&#x2e;&#48;&#x2e;&#115;&#111;</a></strong> ä¸¤ä¸ªåŠ¨æ€åº“</p><h4 id="5-3-5-serviceç”Ÿæˆ"><a href="#5-3-5-serviceç”Ÿæˆ" class="headerlink" title="5.3.5 serviceç”Ÿæˆ"></a>5.3.5 serviceç”Ÿæˆ</h4><p>ä¸Šé¢è¿‡ç¨‹å°†éœ€è¦çš„åŠ¨æ€åº“ç”Ÿæˆå®Œæ¯•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç”Ÿæˆå¯¹åº”çš„ service å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸‰æ­¥ï¼š</p><p><strong>1ã€å‘&#x2F;defaultä¸‹çš„Android.bp æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹</strong></p><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs make">cc_library &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service&quot;</span>,<br>    defaults: [<span class="hljs-string">&quot;hidl_defaults&quot;</span>],<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br>    vendor: true,<br>    srcs: [<br>        <span class="hljs-string">&quot;service.cpp&quot;</span><br>    ],<br>    init_rc: [<span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service.rc&quot;</span>],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2ã€è¡¥å…… service.cpp å†…å®¹</strong></p><p>å†…å®¹å¾ˆç®€å•ï¼Œ<strong>defaultPassthroughServiceImplementation</strong> å¸®æˆ‘ä»¬è‡ªåŠ¨æ³¨å†ŒæœåŠ¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service&quot;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/LegacySupport.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;GalaxyOne.h&quot;</span></span><br> <br><span class="hljs-comment">// Generated HIDL files</span><br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::IGalaxyOne;<br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::implementation::GalaxyOne;<br> <br><span class="hljs-keyword">using</span> android::hardware::defaultPassthroughServiceImplementation;<br><span class="hljs-keyword">using</span> android::hardware::configureRpcThreadpool;<br><span class="hljs-keyword">using</span> android::hardware::joinRpcThreadpool;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">defaultPassthroughServiceImplementation</span>&lt;IGalaxyOne&gt;();<br>&#125; <br></code></pre></td></tr></table></figure><p><strong>3ã€è¡¥å…… rc æ–‡ä»¶</strong></p><p>æ³¨æ„è¿™é‡Œçš„ <strong>galaxy-hal-service</strong> ç›¸å½“äºè¿™ä¸ªæœåŠ¡çš„åˆ«åï¼Œç³»ç»Ÿå°±æ˜¯æ ¹æ®è¿™ä¸ªæ–‡ä»¶åœ¨å¯åŠ¨çš„åŒæ—¶ä¹Ÿå°†è¿™ä¸ª service å¯åŠ¨ï¼Œå› æ­¤åœ¨ä¸‹é¢æˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•æ—¶æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œä¸è¿‡è¿™é‡Œå…ˆè¡¥å……å®Œæ•´ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">service galaxy-hal-service /vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br>    class hal<br>    user system<br>    group system<br></code></pre></td></tr></table></figure><p>åŒæ ·æ‰§è¡Œ <strong>mmm hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> å‘½ä»¤ï¼Œå®Œæˆä¹‹åå°±ä¼šå¾—åˆ°å¦‚ä¸‹äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ba">out/target/product/sailfish/vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br></code></pre></td></tr></table></figure><h3 id="5-4-clientç«¯"><a href="#5-4-clientç«¯" class="headerlink" title="5.4 clientç«¯"></a>5.4 clientç«¯</h3><p>ç»è¿‡ä¸€ç³»åˆ—è¿‡ç¨‹ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸‰ä¸ªäº§ç‰©<br>1ã€<strong><a href="mailto:&#x61;&#110;&#100;&#x72;&#111;&#105;&#100;&#46;&#x68;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#x2e;&#x67;&#97;&#x6c;&#x61;&#120;&#121;&#95;&#111;&#x6e;&#101;&#x40;&#x31;&#46;&#48;&#46;&#115;&#x6f;">&#x61;&#110;&#100;&#x72;&#111;&#105;&#100;&#46;&#x68;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#x2e;&#x67;&#97;&#x6c;&#x61;&#120;&#121;&#95;&#111;&#x6e;&#101;&#x40;&#x31;&#46;&#48;&#46;&#115;&#x6f;</a></strong><br>2ã€<strong><a href="mailto:&#97;&#110;&#x64;&#114;&#111;&#x69;&#100;&#46;&#104;&#97;&#x72;&#x64;&#119;&#x61;&#114;&#101;&#46;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#x2e;&#x30;&#45;&#x69;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;">&#97;&#110;&#x64;&#114;&#111;&#x69;&#100;&#46;&#104;&#97;&#x72;&#x64;&#119;&#x61;&#114;&#101;&#46;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#x2e;&#x30;&#45;&#x69;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;</a></strong><br>3ã€<strong><a href="mailto:&#97;&#110;&#x64;&#114;&#111;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#95;&#111;&#110;&#101;&#x40;&#x31;&#x2e;&#x30;&#x2d;&#115;&#x65;&#114;&#118;&#105;&#x63;&#x65;">&#97;&#110;&#x64;&#114;&#111;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#95;&#111;&#110;&#101;&#x40;&#x31;&#x2e;&#x30;&#x2d;&#115;&#x65;&#114;&#118;&#105;&#x63;&#x65;</a></strong></p><p>ç°åœ¨éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯æ¥æµ‹è¯•è°ƒç”¨ï¼Œå› æ­¤åœ¨ <strong>default</strong> ç›®å½•ä¸‹æ–°å»º <strong>test</strong> ç›®å½•ï¼Œå¹¶æ–°å»º <strong>client.cppã€Android.bp</strong> æ–‡ä»¶ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-cfccd9a1dea02880.png" style="zoom: 67%;"><p><strong>client.cpp å†…å®¹å¦‚ä¸‹ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;log/log.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> android::sp;<br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::IGalaxyOne;<br><span class="hljs-keyword">using</span> android::hardware::Return;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    android::sp&lt;IGalaxyOne&gt; service = IGalaxyOne::<span class="hljs-built_in">getService</span>();<br>    <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;faile to get galaxy_one service......&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;success to get galaxy_one service.....&quot;</span>);<br><br>    <span class="hljs-type">uint32_t</span> addResult = service-&gt;<span class="hljs-built_in">add</span>(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service add: result = %d&quot;</span>,(<span class="hljs-type">int</span>)addResult);<br><br>    <span class="hljs-type">uint32_t</span> subResult = service-&gt;<span class="hljs-built_in">sub</span>(<span class="hljs-number">8</span>,<span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service sub: result = %d&quot;</span>,(<span class="hljs-type">int</span>)subResult);<br><br>    <span class="hljs-type">uint32_t</span> mulResult = service-&gt;<span class="hljs-built_in">mul</span>(<span class="hljs-number">3</span>,<span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service mul: result = %d&quot;</span>,(<span class="hljs-type">int</span>)mulResult);<br><br>    <span class="hljs-type">uint32_t</span> divResult = service-&gt;<span class="hljs-built_in">div</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service div: result = %d&quot;</span>,(<span class="hljs-type">int</span>)divResult);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Android.bp å†…å®¹å¦‚ä¸‹ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile">cc_binary &#123;<br>    name: <span class="hljs-string">&quot;galaxy_test&quot;</span>,    //è¡¨ç¤ºç”Ÿæˆçš„ client åç§°<br>    srcs: [<br>        <span class="hljs-string">&quot;client.cpp&quot;</span><br>    ],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mmm hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> å‘½ä»¤ç¼–è¯‘ä¹‹åï¼Œå¯ä»¥åœ¨ <strong>out&#x2F;target&#x2F;product&#x2F;XXX&#x2F;system&#x2F;bin</strong> ç›®å½•ä¸‹æ‰¾åˆ° <strong>galaxy_test</strong> ã€‚</p><h3 id="5-5-å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«"><a href="#5-5-å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«" class="headerlink" title="5.5 å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«"></a>5.5 å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«</h3><p><strong>HIDL</strong> æƒ³è¦è¢« <strong>framework</strong> è·å–ä½¿ç”¨è¿˜éœ€è¦åœ¨ <strong>manifest.xml</strong> ä¸­æ³¨å†Œï¼Œæ­¤æ–‡ä»¶ä½äº <code>device/[companyName]/[productName]/manifest.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">hal</span> <span class="hljs-attr">format</span>=<span class="hljs-string">&quot;hidl&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>android.hardware.galaxy_one<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">transport</span>&gt;</span>hwbinder<span class="hljs-tag">&lt;/<span class="hljs-name">transport</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>IGalaxyOne<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">instance</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">instance</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fqname</span>&gt;</span>@1.0::IGalaxyOne/default<span class="hljs-tag">&lt;/<span class="hljs-name">fqname</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">hal</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-6-æ·»åŠ sepolicyç­–ç•¥"><a href="#5-6-æ·»åŠ sepolicyç­–ç•¥" class="headerlink" title="5.6 æ·»åŠ sepolicyç­–ç•¥"></a>5.6 æ·»åŠ sepolicyç­–ç•¥</h3><p>æœ¬æ–‡æš‚æ—¶å…³é—­selinux</p><h2 id="6-éªŒè¯æœåŠ¡"><a href="#6-éªŒè¯æœåŠ¡" class="headerlink" title="6.éªŒè¯æœåŠ¡"></a>6.éªŒè¯æœåŠ¡</h2><h3 id="6-1-pushè®¾å¤‡"><a href="#6-1-pushè®¾å¤‡" class="headerlink" title="6.1 pushè®¾å¤‡"></a>6.1 pushè®¾å¤‡</h3><p>ç°åœ¨æˆ‘ä»¬ä¸€å…±å¾—åˆ° 4 ä¸ªäº§ç‰©ï¼Œä½¿ç”¨ <strong>adb</strong> å‘½ä»¤å°†å…¶ <strong>push</strong> åˆ°æ‰‹æœºå¯¹åº”ç›®å½•ä¸‹ï¼š</p><p>1ã€<a href="mailto:&#97;&#110;&#x64;&#114;&#111;&#x69;&#100;&#x2e;&#104;&#x61;&#x72;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#97;&#108;&#x61;&#120;&#121;&#95;&#111;&#110;&#101;&#64;&#x31;&#46;&#x30;&#45;&#x69;&#x6d;&#x70;&#108;&#46;&#115;&#111;">&#97;&#110;&#x64;&#114;&#111;&#x69;&#100;&#x2e;&#104;&#x61;&#x72;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#x67;&#97;&#108;&#x61;&#120;&#121;&#95;&#111;&#110;&#101;&#64;&#x31;&#46;&#x30;&#45;&#x69;&#x6d;&#x70;&#108;&#46;&#115;&#111;</a> &#x3D;&#x3D;&#x3D;&gt; &#x2F;vendor&#x2F;lib64&#x2F;hw<br>2ã€<a href="mailto:&#97;&#x6e;&#x64;&#114;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#49;&#46;&#48;&#x2e;&#115;&#111;">&#97;&#x6e;&#x64;&#114;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#49;&#46;&#48;&#x2e;&#115;&#111;</a> &#x3D;&#x3D;&#x3D;&gt; vendor&#x2F;lib64<br>3ã€<a href="mailto:&#97;&#x6e;&#x64;&#x72;&#x6f;&#x69;&#x64;&#46;&#104;&#97;&#x72;&#100;&#x77;&#x61;&#114;&#101;&#46;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#x2e;&#48;&#45;&#x73;&#101;&#114;&#x76;&#x69;&#x63;&#101;">&#97;&#x6e;&#x64;&#x72;&#x6f;&#x69;&#x64;&#46;&#104;&#97;&#x72;&#100;&#x77;&#x61;&#114;&#101;&#46;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#101;&#x40;&#x31;&#x2e;&#48;&#45;&#x73;&#101;&#114;&#x76;&#x69;&#x63;&#101;</a> &#x3D;&#x3D;&#x3D;&gt; &#x2F;vendor&#x2F;bin&#x2F;hw<br>4ã€galaxy_test &#x3D;&#x3D;&#x3D;&gt; &#x2F;system&#x2F;bin</p><h3 id="6-2-è¿è¡Œservice"><a href="#6-2-è¿è¡Œservice" class="headerlink" title="6.2 è¿è¡Œservice"></a>6.2 è¿è¡Œservice</h3><p>è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨ï¼Œç”¨äºæµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br></code></pre></td></tr></table></figure><h3 id="6-3-è¿è¡Œclient"><a href="#6-3-è¿è¡Œclient" class="headerlink" title="6.3 è¿è¡Œclient"></a>6.3 è¿è¡Œclient</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./system/bin/galaxy_test<br></code></pre></td></tr></table></figure><p>è¿è¡ŒæˆåŠŸä¹‹åå¯æŸ¥çœ‹æ—¥å¿—ï¼Œæœ‰å¦‚ä¸‹å†…å®¹åˆ™è¡¨ç¤ºæœåŠ¡å»ºç«‹æˆåŠŸï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-a17a33c648493e73.png" style="zoom: 75%;">]]></content>
    
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹</title>
    <link href="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/"/>
    <url>/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹"><a href="#æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹"></a>æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹</h1><blockquote><p>ğŸ’ <strong>ç¯å¢ƒ</strong>ï¼šå†…æ ¸ç‰ˆæœ¬4.5</p><p>ğŸ‰ <strong>è¯´æ˜</strong>ï¼šå‚è€ƒ<a href="https://blog.csdn.net/zr_lang/article/details/39963253%EF%BC%8C%E9%9D%9E%E5%B8%B8%E6%84%9F%E8%B0%A2%EF%BC%8C%E6%94%B6%E8%8E%B7%E9%A2%87%E4%B8%B0">https://blog.csdn.net/zr_lang/article/details/39963253ï¼Œéå¸¸æ„Ÿè°¢ï¼Œæ”¶è·é¢‡ä¸°</a></p></blockquote><p>ä»ç”¨æˆ·ä¸‹å‘mountæŒ‡ä»¤åˆ°å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒ‚è½½ï¼Œå¤§è‡´ç»å†äº†ä¸‹é¢çš„æ­¥éª¤ã€ä»¥<code>f2fs</code>æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ã€‘ã€‚</p><img src="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/image-20230309225903725.png" alt="image-20230309225903725" style="zoom: 67%;"><h2 id="1-æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file-system-type"><a href="#1-æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file-system-type" class="headerlink" title="1.æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file_system_type"></a>1.æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file_system_type</h2><p>æ¯ä¸ªäººåœ¨å†²æµªçš„éƒ½æœ‰è‡ªå·±çš„æ˜µç§°ï¼Œè‡ªå·±çš„ä¸ªæ€§æ ‡ç­¾ï¼Œè¿™ä»¿ä½›æ˜¯æ¯ä¸ªäººå…±åŒçš„æ ·å­ï¼Œä¸å¦¨å°†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿä¹ŸæŠ½è±¡æˆåŒä¸€ä¸ªæ ·å­è¡¨ç¤º<code>file_system_type</code>ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè‚¯å®šæœ‰</p><ul><li>name: æ–‡ä»¶ç³»ç»Ÿçš„åå­—ï¼Œå¦‚xfs, ext2ç­‰</li><li>fs_flags: è¯´æ˜æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹</li><li>mount: ä»£æ›¿æ—©æœŸçš„get_sb()ï¼Œç”¨æˆ·æŒ‚è½½æ­¤æ–‡ä»¶ç³»ç»Ÿæ—¶ä½¿ç”¨çš„å›è°ƒå‡½æ•°ã€‚</li><li>kill_sb: åˆ é™¤å†…å­˜ä¸­çš„super blockï¼Œåœ¨å¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä½¿ç”¨ã€‚</li><li>owner: æŒ‡å‘å®ç°è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ¨¡å—ï¼Œé€šå¸¸ä¸ºTHIS_MODULEå®ã€‚</li><li>next: æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿç±»å‹é“¾è¡¨çš„ä¸‹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</li><li>fs_supers: å…·æœ‰åŒæ ·æ­¤æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„è¶…çº§å—ç»“æ„ï¼Œéƒ½ä¸²è¿åœ¨è¿™ä¸ªè¡¨å¤´ä¸‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\fs.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> &#123;</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>        <span class="hljs-type">int</span> fs_flags;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_REQUIRES_DEV         1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_BINARY_MOUNTDATA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_HAS_SUBTYPE          4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_USERNS_MOUNT         8       <span class="hljs-comment">/* Can be mounted by userns root */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_USERNS_DEV_MOUNT     16 <span class="hljs-comment">/* A userns mount does not imply MNT_NODEV */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_RENAME_DOES_D_MOVE   32768   <span class="hljs-comment">/* FS will handle d_move() during rename() internally. */</span></span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *(*<span class="hljs-title">mount</span>) (<span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *, <span class="hljs-title">int</span>, <span class="hljs-title">const</span> <span class="hljs-title">char</span> *, <span class="hljs-title">void</span> *);</span><br>        <span class="hljs-type">void</span> (*kill_sb) (<span class="hljs-keyword">struct</span> super_block *);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">owner</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> * <span class="hljs-title">next</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span> <span class="hljs-title">fs_supers</span>;</span><br>       <span class="hljs-comment">// ....</span><br>        <span class="hljs-comment">//ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæ­¤å¤„çœç•¥è‹¥å¹²é”ç›¸å…³å˜é‡ã€‚</span><br>        <span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨kernelçš„<code>/fs</code>æœ‰å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼Œfile_system_typeç»“æ„ä¸€èˆ¬è¢«å®šä¹‰åœ¨super.cã€‚ä¸‹é¢ä»¥<strong>f2fs</strong>æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ä»‹ç»ä¸€ä¸‹ä»–çš„<code>file_system_type</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fs\f2fs\super.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">f2fs_fs_type</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.name= <span class="hljs-string">&quot;f2fs&quot;</span>,<br>.mount= f2fs_mount,<br>.kill_sb= kill_f2fs_super,<br>.fs_flags= FS_REQUIRES_DEV,<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>ownerè¯´æ˜f2fsæ¨¡å—æœ¬èº«æ‹¥æœ‰è¿™ä¸ªfile_system_typeã€‚</p></li><li><p>nameæ˜¯f2fsã€‚</p></li><li><p>fs_flagsæ˜¯FS_REQUIRES_DEVï¼Œè¡¨æ˜f2fsä¸€å®šè¦è¢«ä½¿ç”¨åœ¨ç‰©ç†è®¾å¤‡ä¸Šã€‚</p></li><li><p>mountæ˜¯f2fs_mountï¼Œè¯´æ˜ f2fs_mountè¿™ä¸ªå‡½æ•°å®ç°äº†f2fsçš„å…·ä½“mountæ“ä½œã€‚åœ¨ç¬¬3èŠ‚é˜è¿°</p></li></ul><h2 id="2-æ³¨å†Œè´¦å·register-filesystem"><a href="#2-æ³¨å†Œè´¦å·register-filesystem" class="headerlink" title="2.æ³¨å†Œè´¦å·register_filesystem"></a>2.æ³¨å†Œè´¦å·register_filesystem</h2><p>å½“ç„¶ï¼Œä½ è‡ªå·±æƒ³è±¡å¥½äº†è‡ªå·±çš„æ˜µç§°ï¼Œè‡ªå·±çš„ä¸ªæ€§è¡¨å‹ï¼Œè‡ªå·±çš„èƒ½åŠ›ï¼Œè¿˜æœ‰è‡ªå·±çš„ä¸€ä»½ç®€å†ã€superblockã€‘ï¼Œä¸æ³¨å†Œè´¦å·æ€ä¹ˆå†²æµªå˜›ğŸ„</p><p>åŒç†å½“åˆå§‹åŒ–å¥½äº†ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¹Ÿè¦å‘å†…æ ¸è¿›è¡Œæ³¨å†Œ<code>register_filesystem</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">register_filesystem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type * fs)</span><br>&#123;<br>        <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> ** <span class="hljs-title">p</span>;</span><br> <br>        BUG_ON(<span class="hljs-built_in">strchr</span>(fs-&gt;name, <span class="hljs-string">&#x27;.&#x27;</span>));<br>        <span class="hljs-keyword">if</span> (fs-&gt;next)<br>                <span class="hljs-keyword">return</span> -EBUSY;<br>        write_lock(&amp;file_systems_lock);<br>       <br>        <span class="hljs-comment">// éå†å…¨å±€file_systemsé“¾è¡¨ï¼Œå°è¯•æŸ¥æ‰¾æœ¬æ¬¡è¦æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿåã€‚</span><br>        p = find_filesystem(fs-&gt;name, <span class="hljs-built_in">strlen</span>(fs-&gt;name));<br>        <span class="hljs-keyword">if</span> (*p) <span class="hljs-comment">// å¦‚æœä¸ä¸ºNULLï¼Œåˆ™è¯´æ˜æ‰¾åˆ°äº†é‡åçš„æ–‡ä»¶ç³»ç»Ÿã€‚æ³¨å†Œå¤±è´¥ã€‚</span><br>                res = -EBUSY;<br>        <span class="hljs-keyword">else</span> <span class="hljs-comment">// å¦‚æœè¿”å›NULLï¼Œè¯´æ˜å·²ç»åˆ°é“¾è¡¨ç»“å°¾ï¼Œå¯ä»¥æ³¨å†Œæ­¤æ–‡ä»¶ç³»ç»Ÿã€‚</span><br>                *p = fs; <span class="hljs-comment">// å°†æ­¤æ–‡ä»¶ç³»ç»Ÿé“¾æ¥åˆ°é“¾è¡¨ç»“å°¾ã€‚</span><br>        write_unlock(&amp;file_systems_lock);<br>        <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>file_system_typeçš„åŸºæœ¬æ“ä½œéƒ½åœ¨fs&#x2F;filesystems.cæ–‡ä»¶é‡Œï¼Œæ–‡ä»¶ä¸é•¿ï¼Œå¯ä»¥ç®€çŸ­çš„æµè§ˆä¸€ä¸‹éƒ½æœ‰é‚£äº›æ“ä½œå‡½æ•°ã€‚æœ€ä¸»è¦çš„å˜é‡è«è¿‡äºæ­¤æ–‡ä»¶å†…çš„å…¨å±€å˜é‡ï¼š</p><p>&#x2F;&#x2F; æ­¤å˜é‡æ˜¯æ–‡ä»¶ç³»ç»Ÿç±»å‹å•é“¾è¡¨çš„å¤´æŒ‡é’ˆ<code>static struct file_system_type *file_systems</code></p></blockquote><p>é‚£ä¹ˆf2fsåœ¨å“ªé‡Œæ³¨å†Œçš„å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">init_f2fs_fs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    err = register_filesystem(&amp;f2fs_fs_type);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-å¼€å§‹å±äºf2fsçš„mount"><a href="#3-å¼€å§‹å±äºf2fsçš„mount" class="headerlink" title="3.å¼€å§‹å±äºf2fsçš„mount"></a>3.å¼€å§‹å±äºf2fsçš„mount</h2><p>åœ¨æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œ<code>mount -t f2fs /dev/xxx /mntdir/xxx</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šå»è°ƒç”¨f2fsçš„mountå‡½æ•°ï¼Œåœ¨ç¬¬1èŠ‚çš„f2fs_fs_typeæŒ‡æ˜äº†f2fsæ–‡ä»¶ç³»ç»Ÿçš„mountå‡½æ•°ä¸º<code>f2fs_mount</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> dentry *<span class="hljs-title function_">f2fs_mount</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_name, <span class="hljs-type">void</span> *data)</span><br>&#123;<br><span class="hljs-keyword">return</span> mount_bdev(fs_type, flags, dev_name, data, f2fs_fill_super);<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ªmount_bdev()å‡½æ•°ï¼Œä½†æ˜¯çœ‹å‚æ•°å¯ä»¥çœ‹åˆ°ä¸€äº›é‡è¦çš„ä¸œè¥¿</p><ul><li>fs_typeä¸ç”¨å¤šè¯´ï¼Œæºå¸¦file_system_typeçš„ä¿¡æ¯ï¼Œè¿™é‡Œä¼ é€’å®ƒä¸»è¦æ˜¯å› ä¸ºå®ƒæºå¸¦äº†super blockçš„é“¾è¡¨å’Œå¾ˆå¤šé”å˜é‡ã€‚</li><li>flagsæ–‡ä»¶ç³»ç»Ÿçš„é€šç”¨æŒ‚è½½é€‰é¡¹ã€‚</li><li>dev_nameæ˜¯mountæ“ä½œæ—¶çš„è®¾å¤‡åï¼Œå¦‚&#x2F;dev&#x2F;sda1ã€‚åé¢ä¼šç”¨åˆ°è¿™ä¸ªè®¾å¤‡åæ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯ï¼Œä»è€Œä»ä¸­è·å¾—super blockã€‚</li><li>dataæ˜¯æŒ‚è½½æ—¶æŒ‡å®šçš„æŒ‚è½½é€‰é¡¹ä¿¡æ¯ã€‚</li><li>f2fs_fill_superæ˜¯ä¸€ä¸ªç”±f2fsç‰¹å®šå®ç°çš„fill_superæ–¹æ³•ï¼Œç”¨æ¥æ ¹æ®f2fsæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§è§£æmount dataå¹¶ç»§ç»­å¡«å……super blockçš„å­—æ®µï¼Œå¹¶ä¸”åˆå§‹åŒ–æŒ‚è½½ç‚¹çš„æ ¹ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡å’Œç›®å½•é¡¹å¯¹è±¡ã€‚</li></ul><h2 id="4-æŒ‚è½½é€‰é¡¹flagå’Œdata"><a href="#4-æŒ‚è½½é€‰é¡¹flagå’Œdata" class="headerlink" title="4.æŒ‚è½½é€‰é¡¹flagå’Œdata"></a>4.æŒ‚è½½é€‰é¡¹flagå’Œdata</h2><p>åœ¨ç¬¬3èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°f2fsæŒ‚è½½çš„æ—¶å€™æœ‰flagså’Œdataï¼Œä½†æ˜¯æˆ‘ä»¬å¹³å¸¸æŒ‚è½½çš„åªæœ‰ä¸€ä¸ª<code>- o</code>å‚æ•°å•Šï¼Œä¾‹å¦‚<code>mount -t f2fs -o ro /dev/xxx /mntdir/xxx</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åŒºåˆ†å…·ä½“çš„flagå’Œdataå‘¢ï¼Ÿ</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹flagséƒ½æœ‰å“ªäº›å¯é€‰å€¼(å–è‡ª<code>include/uapi/linux/fs.h</code>)ï¼Œæˆ‘ä»¬æ¥å°½é‡æŠŠå®ƒä»¬å’Œmountå‘½ä»¤é‡Œçš„é€‰é¡¹å¯¹åº”ä¸€ä¸‹(man 2 mount)ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * These are the fs-independent mount-flags: up to 32 flags are supported</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RDONLY        1         <span class="hljs-comment">/* å¯¹åº”-o ro/rw */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOSUID        2         <span class="hljs-comment">/* å¯¹åº”-o suid/nosuid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NODEV         4         <span class="hljs-comment">/*  å¯¹åº”-o suid/nosuid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOEXEC        8         <span class="hljs-comment">/* å¯¹åº”-o exec/noexec */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SYNCHRONOUS  16         <span class="hljs-comment">/* å¯¹åº”-o sync/async */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_REMOUNT      32         <span class="hljs-comment">/* å¯¹åº”-o remountï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡remountæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MANDLOCK     64         <span class="hljs-comment">/* å¯¹åº”-o mand/nomand */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_DIRSYNC      128        <span class="hljs-comment">/* å¯¹åº”-o dirsync */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOATIME      1024       <span class="hljs-comment">/* å¯¹åº”-o atime/noatime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NODIRATIME   2048       <span class="hljs-comment">/* å¯¹åº”-o diratime/nodiratime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_BIND         4096       <span class="hljs-comment">/* å¯¹åº”-B/--bindé€‰é¡¹ï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡bindæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MOVE         8192       <span class="hljs-comment">/* å¯¹åº”-M/--moveï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡moveæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_REC          16384      <span class="hljs-comment">/* recæ˜¯recursiveçš„æ„æ€ï¼Œè¿™ä¸ªflagä¸€èˆ¬ä¸å•ç‹¬å‡ºç°ï¼Œéƒ½æ˜¯ä¼´éšè¿™å…¶å®ƒflagï¼Œè¡¨ç¤ºé€’å½’çš„è¿›è¡Œæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_VERBOSE      32768      <span class="hljs-comment">/* å¯¹åº”-v/--verbose */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SILENT       32768      <span class="hljs-comment">/* å¯¹åº”-o silent/loud */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_POSIXACL     (1&lt;&lt;16)    <span class="hljs-comment">/* è®©VFSä¸åº”ç”¨umaskï¼Œå¦‚NFS */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_UNBINDABLE   (1&lt;&lt;17)    <span class="hljs-comment">/* å¯¹åº”--make-unbindable */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_PRIVATE      (1&lt;&lt;18)    <span class="hljs-comment">/* å¯¹åº”--make-private */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SLAVE        (1&lt;&lt;19)    <span class="hljs-comment">/* å¯¹åº”--make-slave */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SHARED       (1&lt;&lt;20)    <span class="hljs-comment">/* å¯¹åº”--make-shared */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RELATIME     (1&lt;&lt;21)    <span class="hljs-comment">/* å¯¹åº”-o relatime/norelatime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_KERNMOUNT    (1&lt;&lt;22)    <span class="hljs-comment">/* è¿™ä¸ªä¸€èˆ¬ä¸åœ¨åº”ç”¨å±‚ä½¿ç”¨ï¼Œä¸€èˆ¬å†…æ ¸æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå¦‚sysfsä½¿ç”¨ï¼Œè¡¨ç¤ºä½¿ç”¨kern_mount()è¿›è¡ŒæŒ‚è½½ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_I_VERSION    (1&lt;&lt;23)    <span class="hljs-comment">/* å¯¹åº”-o iversion/noiversion */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_STRICTATIME  (1&lt;&lt;24)    <span class="hljs-comment">/* å¯¹åº”-o strictatime/nostrictatime */</span></span><br> <br><span class="hljs-comment">/* ä¸‹é¢è¿™å‡ ä¸ªflagséƒ½æ˜¯å†…æ ¸å†…éƒ¨ä½¿ç”¨çš„ï¼Œå®ƒä»¬çš„å«ä¹‰æˆ‘åªæ˜¯é€šè¿‡ç®€å•çš„æŸ¥çœ‹ä»£ç é€»è¾‘æš‚æ—¶çŒœæµ‹çš„ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOSEC        (1&lt;&lt;28)    <span class="hljs-comment">/* æœ‰äº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒsuidï¼Œsecurity xattrç­‰å®‰å…¨æ ‡è®° */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_BORN         (1&lt;&lt;29)    <span class="hljs-comment">/* è¡¨ç¤ºå†…å­˜superblockå·²ç»åˆ›å»ºå®Œæˆ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_ACTIVE       (1&lt;&lt;30)    <span class="hljs-comment">/* è¡¨ç¤ºå†…å­˜superblockæ­£å¤„äºæ´»åŠ¨çŠ¶æ€ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOUSER       (1&lt;&lt;31)    <span class="hljs-comment">/* è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿä¸èƒ½è¢«åº”ç”¨å±‚æŒ‚è½½ä½¿ç”¨ï¼Œåªèƒ½è¢«å†…æ ¸ä½¿ç”¨ï¼Œå¦‚rootfs */</span></span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Superblock flags that can be altered by MS_REMOUNT</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RMT_MASK     (MS_RDONLY|MS_SYNCHRONOUS|MS_MANDLOCK|MS_I_VERSION)  <span class="hljs-comment">// å¯ä»¥åœ¨remountæ˜¯æ”¹å˜çš„flags</span></span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Old magic mount flag and mask</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MGC_VAL 0xC0ED0000      <span class="hljs-comment">/* è¿‡å»ä½¿ç”¨çš„magicï¼Œç°åœ¨åŸºæœ¬è¢«å¿½ç•¥äº† */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MGC_MSK 0xffff0000      <span class="hljs-comment">/* è¿‡å»ä½¿ç”¨çš„flagçš„çš„mask */</span></span><br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒflagsåŸºæœ¬ä¸Šæ˜¯optionsä¸­é€šç”¨çš„é‚£äº›ï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬æ˜¯<strong>é¢å‘æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿé€šç”¨çš„</strong>ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›æ˜¯å†…æ ¸ä½¿ç”¨çš„ã€‚è¿™äº›flagså¤§éƒ¨åˆ†éƒ½åœ¨VFSå±‚è¢«è§£æä½¿ç”¨ã€‚</p><p>è€Œdataå‘¢ï¼ŒæŠŠoptionsä¸­é€šç”¨çš„å»æ‰ï¼Œ<strong>å‰©ä¸‹çš„å°±æ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿå„è‡ªæ”¯æŒçš„æŒ‚è½½é€‰é¡¹</strong>ã€‚</p><p>ğŸˆè®©æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼šæˆ‘ä»¬é€‰å–ä¸€ä¸ªä¸flagså¯¹åº”çš„optionï¼Œå¦‚nodevã€‚åœ¨ä»xfsã€ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ç³»ç»Ÿã€‘ä¸­é€‰å–ä¸€ä¸ªç‰¹å®šçš„optionï¼Œå¦‚noquotaã€‚ç„¶åç”¨straceè·Ÿè¸ªä¸€ä¸‹mountçš„è¿‡ç¨‹ï¼Œæ‰§è¡Œ</p><p><code>strace mount /dev/loop0 /mnt/test -o noquota,nodev</code></p><p>åœ¨æ¥è¿‘æœ€åçš„ä½ç½®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°mountç³»ç»Ÿè°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mount(<span class="hljs-string">&quot;/dev/loop0&quot;</span>, <span class="hljs-string">&quot;/mnt/test&quot;</span>, <span class="hljs-string">&quot;xfs&quot;</span>, MS_MGC_VAL|MS_NODEV, <span class="hljs-string">&quot;noquota&quot;</span>) = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>æœç„¶ï¼Œnodevè¢«è§£é‡Šä¸ºflagï¼Œnoquotaè¢«å½“ä½œäº†mount dataã€‚</p><h2 id="5-mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys-mountï¼‰"><a href="#5-mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys-mountï¼‰" class="headerlink" title="5.mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys_mountï¼‰"></a>5.mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys_mountï¼‰</h2><p>å¦‚æœè¦ç ”ç©¶mountçš„æ‰§è¡Œè¿‡ç¨‹å…ˆè¦æ‰¾åˆ°mountçš„å‘èµ·ä½ç½®ï¼Œæœ‰äº›mountæ˜¯å†…æ ¸å‘èµ·çš„ï¼Œç”±å†…æ ¸è‡ªä¸»æŒ‚è½½ã€‚è€Œç»å¤§éƒ¨åˆ†çš„mountéƒ½æ˜¯ç”¨æˆ·é€šè¿‡mountç³»ç»Ÿè°ƒç”¨å‘èµ·çš„ï¼Œæˆ‘ä»¬å°±ä»¥åè€…ä¸ºèµ·ç‚¹å¼€å§‹åˆ†æã€‚<strong>mountç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆsys_mountï¼‰å®šä¹‰åœ¨fs&#x2F;namespace.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fs\namespace.c</span><br><br>SYSCALL_DEFINE5(mount, <span class="hljs-type">char</span> __user *, dev_name, <span class="hljs-type">char</span> __user *, dir_name,<br>                <span class="hljs-type">char</span> __user *, type, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, flags, <span class="hljs-type">void</span> __user *, data)<br>&#123;<br>        <span class="hljs-type">int</span> ret;<br>        <span class="hljs-type">char</span> *kernel_type;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">filename</span> *<span class="hljs-title">kernel_dir</span>;</span><br>        <span class="hljs-type">char</span> *kernel_dev;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data_page;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿç±»å‹å */</span><br>        ret = copy_mount_string(type, &amp;kernel_type);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_type;<br> <br>        <span class="hljs-comment">/* å¾—åˆ°æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹å */</span><br>        kernel_dir = getname(dir_name);<br>        <span class="hljs-keyword">if</span> (IS_ERR(kernel_dir)) &#123;<br>                ret = PTR_ERR(kernel_dir);<br>                <span class="hljs-keyword">goto</span> out_dir;<br>        &#125;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡å */</span><br>        ret = copy_mount_string(dev_name, &amp;kernel_dev);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_dev;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿå®šåˆ¶çš„mount data */</span><br>        ret = copy_mount_options(data, &amp;data_page);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_data;<br> <br>        <span class="hljs-comment">/* åˆ°æ­¤mountæ‰€éœ€è¦çš„fstype, dev_name, mountpoint, flagså’Œdataè¿™å‡ ä¸ªå‚æ•°éƒ½æ‹·è´åˆ°å†…æ ¸ç©ºé—´äº† */</span><br>        <span class="hljs-comment">/* è°ƒç”¨do_mountå‡½æ•°ç»§ç»­ä¸‹é¢çš„æ“ä½œ */</span><br>        ret = do_mount(kernel_dev, kernel_dir-&gt;name, kernel_type, flags,<br>                (<span class="hljs-type">void</span> *) data_page);<br> <br>        free_page(data_page);<br>out_data:<br>        kfree(kernel_dev);<br>out_dev:<br>        putname(kernel_dir);<br>out_dir:<br>        kfree(kernel_type);<br>out_type:<br>        <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-do-mountè°ƒç”¨"><a href="#6-do-mountè°ƒç”¨" class="headerlink" title="6.do_mountè°ƒç”¨"></a>6.do_mountè°ƒç”¨</h2><p>ç³»ç»Ÿè°ƒç”¨sys_mountåï¼Œä¼šç»§ç»­æ‰§è¡Œdo_mountå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨VFSå±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">do_mount</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dir_name,</span><br><span class="hljs-params">                <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type_page, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags, <span class="hljs-type">void</span> *data_page)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span> <span class="hljs-title">path</span>;</span><br>        <span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> mnt_flags = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">/* Discard magic */</span><br>        <span class="hljs-keyword">if</span> ((flags &amp; MS_MGC_MSK) == MS_MGC_VAL)<br>                flags &amp;= ~MS_MGC_MSK;<br>        <span class="hljs-comment">/* Basic sanity checks */</span><br>        <span class="hljs-keyword">if</span> (!dir_name || !*dir_name || !<span class="hljs-built_in">memchr</span>(dir_name, <span class="hljs-number">0</span>, PAGE_SIZE))<br>                <span class="hljs-keyword">return</span> -EINVAL;<br>        <span class="hljs-keyword">if</span> (data_page)<br>                ((<span class="hljs-type">char</span> *)data_page)[PAGE_SIZE - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// æŠŠmountpointè§£é‡Šæˆpathå†…æ ¸ç»“æ„ï¼Œè¿™é‡Œæ˜¯è·¯å¾„åè§£æçš„è¿‡ç¨‹</span><br>        <span class="hljs-comment">// è°ƒç”¨do_path_lookupã€‚å…³äºè·¯å¾„åè§£ææˆ‘ä»¬åé¢å†è¯´</span><br>        <span class="hljs-comment">/* ... and get the mountpoint */</span><br>        retval = kern_path(dir_name, LOOKUP_FOLLOW, &amp;path);<br>        <span class="hljs-keyword">if</span> (retval)<br>                <span class="hljs-keyword">return</span> retval;<br>        retval = security_sb_mount(dev_name, &amp;path,<br>                                   type_page, flags, data_page);<br>        <span class="hljs-keyword">if</span> (!retval &amp;&amp; !may_mount())<br>                retval = -EPERM;<br>        <span class="hljs-keyword">if</span> (retval)<br>                <span class="hljs-keyword">goto</span> dput_out;<br>        <span class="hljs-comment">// ä»è¿™é‡Œå¼€å§‹å°±æ˜¯ä¸€ç³»åˆ—çš„å¯¹flagsçš„è§£æï¼ŒæŠŠé€šç”¨optionæå‡ºæ¥</span><br>        <span class="hljs-comment">// å¹¶ä¸”æ‰¾å‡ºæˆ‘ä»¬è¦mountåšå“ªç§æ“ä½œï¼Œå¦‚bind, remount, newmountç­‰</span><br>        <span class="hljs-comment">/* Default to relatime unless overriden */</span><br>        <span class="hljs-keyword">if</span> (!(flags &amp; MS_NOATIME))<br>                mnt_flags |= MNT_RELATIME;<br>        <span class="hljs-comment">/* Separate the per-mountpoint flags */</span><br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOSUID)<br>                mnt_flags |= MNT_NOSUID;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NODEV)<br>                mnt_flags |= MNT_NODEV;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOEXEC)<br>                mnt_flags |= MNT_NOEXEC;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOATIME)<br>                mnt_flags |= MNT_NOATIME;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NODIRATIME)<br>                mnt_flags |= MNT_NODIRATIME;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_STRICTATIME)<br>                mnt_flags &amp;= ~(MNT_RELATIME | MNT_NOATIME);<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_RDONLY)<br>                mnt_flags |= MNT_READONLY;<br>        <span class="hljs-comment">/* The default atime for remount is preservation */</span><br>        <span class="hljs-keyword">if</span> ((flags &amp; MS_REMOUNT) &amp;&amp;<br>            ((flags &amp; (MS_NOATIME | MS_NODIRATIME | MS_RELATIME |<br>                       MS_STRICTATIME)) == <span class="hljs-number">0</span>)) &#123;<br>                mnt_flags &amp;= ~MNT_ATIME_MASK;<br>                mnt_flags |= path.mnt-&gt;mnt_flags &amp; MNT_ATIME_MASK;<br>        &#125;<br>        flags &amp;= ~(MS_NOSUID | MS_NOEXEC | MS_NODEV | MS_ACTIVE | MS_BORN |<br>                   MS_NOATIME | MS_NODIRATIME | MS_RELATIME| MS_KERNMOUNT |<br>                   MS_STRICTATIME);<br>        <span class="hljs-comment">// æ ¹æ®flagsçš„æŒ‡ç¤ºï¼Œå†³å®šåšå“ªç§mountæ“ä½œ</span><br>        <span class="hljs-keyword">if</span> (flags &amp; MS_REMOUNT)<br>                retval = do_remount(&amp;path, flags &amp; ~MS_REMOUNT, mnt_flags,<br>                                    data_page);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; MS_BIND)<br>                retval = do_loopback(&amp;path, dev_name, flags &amp; MS_REC);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; (MS_SHARED | MS_PRIVATE | MS_SLAVE | MS_UNBINDABLE))<br>                retval = do_change_type(&amp;path, flags);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; MS_MOVE)<br>                retval = do_move_mount(&amp;path, dev_name);<br>        <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// æˆ‘ä»¬è¿™é‡Œä»¥new mountä¸ºå…¥æ‰‹ç‚¹ï¼Œç»§ç»­å‘ä¸‹åˆ†æ</span><br>                retval = do_new_mount(&amp;path, type_page, flags, mnt_flags,<br>                                      dev_name, data_page);<br>dput_out:<br>        path_put(&amp;path);<br>        <span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¾—å‡ºdo_mountä¸»è¦å¹²è¿™ä¹ˆå‡ ä¸ªäº‹ï¼š</p><ol><li><p>è§£æmountpointè·¯å¾„åï¼ŒæŠŠå­—ç¬¦ä¸²è·¯å¾„åå˜æˆå†…æ ¸dentryæˆ–è€…è¯´pathç»“æ„</p></li><li><p>è§£æflagsï¼ŒæŠŠé€šç”¨optionåˆ†å‡ºæ¥ã€‚</p></li><li><p>æ ¹æ®flagsä¸­æŒ‡æ˜mountæ“ä½œçš„æ ‡å¿—ï¼Œå†³å®šåšå“ªä¸€ç§mountæ“ä½œã€‚</p></li><li><p>æ‰§è¡Œremount&#x2F;bind&#x2F;shared&#x2F;move&#x2F;new mountæ“ä½œã€‚</p></li></ol><p>åˆ°æ­¤mountå°±å¯èƒ½åš5ç§mountæ“ä½œï¼ˆremount, bind, chang type, moveå’Œnew mountï¼‰ä¹‹ä¸€ã€‚æˆ‘ä»¬ä»¥do_new_mountä¸ºä¾‹ç»§ç»­åˆ†æï¼Œdo_new_mountå±äºæœ€å¸¸è§çš„æƒ…å†µï¼ŒæŒ‚è½½ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="7-do-new-mountè°ƒç”¨"><a href="#7-do-new-mountè°ƒç”¨" class="headerlink" title="7.do_new_mountè°ƒç”¨"></a>7.do_new_mountè°ƒç”¨</h2><p>do_new_mountå‡½æ•°ä¹Ÿåœ¨namespace.cé‡Œå¯ä»¥æ‰¾åˆ°ï¼Œå®ƒä¸»è¦åšä¸‰ä»¶äº‹ï¼š</p><ol><li>æ ¹æ®fstypeä»å…¨å±€æ–‡ä»¶ç³»ç»Ÿç±»å‹(file_system_type)é“¾è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ç»“æ„</li><li>ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹ç»“æ„ä¸­çš„mountå›è°ƒå‡½æ•°æ‰§è¡Œä¸‹é¢çš„æŒ‚è½½æ“ä½œï¼Œæœ€ç»ˆæ„å»ºä¸€ä¸ªmountç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«vfsmountä¿¡æ¯ã€‚</li><li>å°†å¾—åˆ°çš„mountç»“æ„ä½“åŠ å…¥å…¨å±€æ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_new_mount</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> path *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fstype, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">                        <span class="hljs-type">int</span> mnt_flags, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">type</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> *<span class="hljs-title">user_ns</span> =</span> current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfsmount</span> *<span class="hljs-title">mnt</span>;</span><br>        <span class="hljs-type">int</span> err;<br> <br>        <span class="hljs-keyword">if</span> (!fstype)<br>                <span class="hljs-keyword">return</span> -EINVAL;<br> <br>        <span class="hljs-comment">// æ ¹æ®fsç±»å‹åï¼ˆå¦‚xfsï¼‰åœ¨å…¨å±€æ–‡ä»¶ç³»ç»Ÿç±»å‹é“¾è¡¨ä¸Šæ‰¾åˆ°å…¶å¯¹åº”çš„file_system_typeç»“æ„</span><br>        type = get_fs_type(fstype);<br>        <span class="hljs-keyword">if</span> (!type)<br>                <span class="hljs-keyword">return</span> -ENODEV;<br> <br>        <span class="hljs-comment">// è°ƒç”¨æ­¤å‡½æ•°å‡†å¤‡è¿›å…¥æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¸ªåˆ«å¤„ç†å‡½æ•°ï¼Œæ„å»ºä¸€ä¸ªvfsmntç»“æ„</span><br>        <span class="hljs-comment">// æ³¨æ„è¿™é‡Œä»¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€æŒ‚è½½æ ‡è®°ã€è®¾å¤‡åå’ŒæŒ‚è½½é€‰é¡¹ä¿¡æ¯ä¸ºå‚æ•°ï¼Œå¹¶æ²¡æœ‰mountpointå‚æ•°ã€‚è¿™é‡Œåªæ˜¯æƒ³ç”¨typeä¸­çš„mountå›è°ƒå‡½æ•°è¯»å–è®¾å¤‡çš„superblockä¿¡æ¯ï¼Œå¡«å……mntç»“æ„ï¼Œç„¶åæŠŠflagå’Œdataè§£æåå¡«å……åˆ°mntç»“æ„ä¸­ã€‚</span><br>        mnt = vfs_kern_mount(type, flags, name, data);<br>        <span class="hljs-keyword">if</span> (!IS_ERR(mnt) &amp;&amp; (type-&gt;fs_flags &amp; FS_HAS_SUBTYPE) &amp;&amp;<br>            !mnt-&gt;mnt_sb-&gt;s_subtype)<br>                mnt = fs_set_subtype(mnt, fstype);<br> <br>        put_filesystem(type);<br>        <span class="hljs-keyword">if</span> (IS_ERR(mnt))<br>                <span class="hljs-keyword">return</span> PTR_ERR(mnt);<br> <br>        <span class="hljs-comment">// å‡†å¤‡å°†å¾—åˆ°çš„mntç»“æ„åŠ å…¥å…¨å±€æ–‡ä»¶ç³»ç»Ÿæ ‘</span><br>        <span class="hljs-comment">// æ³¨æ„pathå˜é‡ï¼Œä¹Ÿå°±æ˜¯mountpointåœ¨è¿™é‡Œ</span><br>        err = do_add_mount(real_mount(mnt), path, mnt_flags);<br>        <span class="hljs-keyword">if</span> (err)<br>                mntput(mnt);<br>        <span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="99-å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file-operations"><a href="#99-å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file-operations" class="headerlink" title="99.å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file_operations"></a>99.å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file_operations</h2><p>æˆ‘ä»¬æŒ‰ç…§å­¦ä¹ é©±åŠ¨çš„æ–¹å¼ï¼Œå­¦ä¹ æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚åœ¨å­¦ä¹ é©±åŠ¨çš„æ—¶å€™ï¼Œæœ€å…³é”®çš„å°±æ˜¯å­—ç¬¦è®¾å¤‡æ“ä½œé›†<code>file_operations </code>ï¼Œæˆ‘ä»¬å†™é©±åŠ¨çš„æ—¶å€™ä¼šåˆå§‹åŒ–æ¯ä¸€ä¸ªé©±åŠ¨å¯¹åº”çš„æ“ä½œé›†ï¼Œä¾‹å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªledé©±åŠ¨ï¼Œæˆ‘ä»¬å¸¸å¸¸å†™æˆä¸‹é¢çš„æ ·å­ï¼Œæ¯ä¸€ä¸ªfile_operationçš„æ“ä½œï¼Œå¦‚openã€writeéƒ½åœ¨è‡ªå·±çš„é©±åŠ¨ä¸­æŒ‡æ˜å¯¹åº”çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">led_fops</span> =</span> &#123;<br>    .owner = THIS_MODULE,<br>    .open = led_open,<br>    .write = led_write,<br>    .release = led_release,<br>&#125;;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯é€šç”¨çš„é“ç†ï¼Œä¹Ÿæœ‰æ–‡ä»¶ç³»ç»Ÿè‡ªå·±çš„æ“ä½œé›†<code>file_operations</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\fs.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">owner</span>;</span><br><span class="hljs-type">loff_t</span> (*llseek) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">int</span>);<br><span class="hljs-type">ssize_t</span> (*read) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">char</span> __user *, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *);<br><span class="hljs-type">ssize_t</span> (*write) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *);<br><span class="hljs-type">ssize_t</span> (*read_iter) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-keyword">struct</span> iov_iter *);<br><span class="hljs-type">ssize_t</span> (*write_iter) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-keyword">struct</span> iov_iter *);<br><span class="hljs-type">int</span> (*iterate) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> dir_context *);<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span> <span class="hljs-params">(*poll)</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> poll_table_struct *)</span>;<br><span class="hljs-type">long</span> (*unlocked_ioctl) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br><span class="hljs-type">long</span> (*compat_ioctl) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br><span class="hljs-type">int</span> (*mmap) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> vm_area_struct *);<br><span class="hljs-type">int</span> (*mremap)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> vm_area_struct *);<br><span class="hljs-type">int</span> (*open) (<span class="hljs-keyword">struct</span> inode *, <span class="hljs-keyword">struct</span> file *);<br><span class="hljs-type">int</span> (*flush) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">fl_owner_t</span> id);<br><span class="hljs-type">int</span> (*release) (<span class="hljs-keyword">struct</span> inode *, <span class="hljs-keyword">struct</span> file *);<br><span class="hljs-type">int</span> (*fsync) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">loff_t</span>, <span class="hljs-type">int</span> datasync);<br><span class="hljs-type">int</span> (*aio_fsync) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-type">int</span> datasync);<br><span class="hljs-type">int</span> (*fasync) (<span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*lock) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file_lock *);<br><span class="hljs-type">ssize_t</span> (*sendpage) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> page *, <span class="hljs-type">int</span>, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *, <span class="hljs-type">int</span>);<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">long</span> <span class="hljs-params">(*get_unmapped_area)</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)</span>;<br><span class="hljs-type">int</span> (*check_flags)(<span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*flock) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file_lock *);<br><span class="hljs-type">ssize_t</span> (*splice_write)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span> *, <span class="hljs-type">size_t</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>);<br><span class="hljs-type">ssize_t</span> (*splice_read)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span> *, <span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-type">size_t</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*setlease)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">long</span>, <span class="hljs-keyword">struct</span> file_lock **, <span class="hljs-type">void</span> **);<br><span class="hljs-type">long</span> (*fallocate)(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">int</span> mode, <span class="hljs-type">loff_t</span> offset,<br>  <span class="hljs-type">loff_t</span> len);<br><span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-keyword">struct</span> file *f);<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MMU</span><br><span class="hljs-type">unsigned</span> (*mmap_capabilities)(<span class="hljs-keyword">struct</span> file *);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿext4ã€f2fsç­‰ï¼Œéƒ½ä¼šæŒ‡æ˜è‡ªå·±çš„file_operationsï¼Œä»¥f2fsä¸ºä¾‹</p><img src="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/image-20230309230859994.png" alt="image-20230309230859994" style="zoom: 67%;"><p>åŠ å…¥æˆ‘ä»¬åœ¨ç”¨æˆ·æ€æ‰§è¡Œioctlæ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„<code>f2fs_ioct</code>lå°±ä¼šæ‰§è¡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‡‚å¾—äº†Android I/Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰</title>
    <link href="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/"/>
    <url>/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="æ‡‚å¾—äº†Android-I-x2F-Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰"><a href="#æ‡‚å¾—äº†Android-I-x2F-Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰" class="headerlink" title="æ‡‚å¾—äº†Android I&#x2F;Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰"></a>æ‡‚å¾—äº†Android I&#x2F;Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰</h1><blockquote><p>ğŸ€è½¬è½½è‡ªï¼š<a href="https://www.cnblogs.com/mysweetAngleBaby/articles/16066846.html">https://www.cnblogs.com/mysweetAngleBaby/articles/16066846.html</a></p></blockquote><h2 id="1-I-x2F-Oçš„åŸºæœ¬çŸ¥è¯†"><a href="#1-I-x2F-Oçš„åŸºæœ¬çŸ¥è¯†" class="headerlink" title="1.I&#x2F;Oçš„åŸºæœ¬çŸ¥è¯†"></a>1.I&#x2F;Oçš„åŸºæœ¬çŸ¥è¯†</h2><p>åœ¨å·¥ä½œä¸­ï¼Œæˆ‘å‘ç°å¾ˆå¤šå·¥ç¨‹å¸ˆå¯¹I&#x2F;Oçš„è®¤è¯†å…¶å®æ¯”è¾ƒæ¨¡ç³Šï¼Œè®¤ä¸ºI&#x2F;Oå°±æ˜¯åº”ç”¨ç¨‹åºæ‰§è¡Œread()ã€write()è¿™æ ·çš„ä¸€äº›æ“ä½œï¼Œå¹¶ä¸æ¸…æ¥šè¿™äº›æ“ä½œèƒŒåçš„æ•´ä¸ªæµç¨‹æ˜¯æ€æ ·çš„ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-b807a907e68b8792.png" style="zoom: 67%;"><p>æˆ‘ç”»äº†ä¸€å¼ ç®€å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°æ•´ä¸ªæ–‡ä»¶I&#x2F;Oæ“ä½œç”±åº”ç”¨ç¨‹åºã€æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜å…±åŒå®Œæˆã€‚é¦–å…ˆåº”ç”¨ç¨‹åºå°†I&#x2F;Oå‘½ä»¤å‘é€ç»™æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åæ–‡ä»¶ç³»ç»Ÿä¼šåœ¨åˆé€‚çš„æ—¶æœºæŠŠI&#x2F;Oæ“ä½œå‘ç»™ç£ç›˜ã€‚<br>è¿™å°±å¥½æ¯”CPUã€å†…å­˜ã€ç£ç›˜ä¸‰ä¸ªå°ä¼™ä¼´ä¸€èµ·å®Œæˆæ¥åŠ›è·‘ï¼Œæœ€ç»ˆè·‘å®Œçš„æ—¶é—´å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæœ€æ…¢çš„å°ä¼™ä¼´ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒCPUå’Œå†…å­˜ç›¸æ¯”ç£ç›˜æ˜¯é«˜é€Ÿè®¾å¤‡ï¼Œæ•´ä¸ªæµç¨‹çš„ç“¶é¢ˆåœ¨äºç£ç›˜I&#x2F;Oçš„æ€§èƒ½ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ¯”ç£ç›˜æ€§èƒ½æ›´åŠ é‡è¦ï¼Œä¸ºäº†é™ä½ç£ç›˜å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦é€šè¿‡å„ç§å„æ ·çš„æ‰‹æ®µè¿›è¡Œä¼˜åŒ–ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹æ–‡ä»¶ç³»ç»Ÿã€‚</p><h3 id="1-1-æ–‡ä»¶ç³»ç»Ÿ"><a href="#1-1-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.1 æ–‡ä»¶ç³»ç»Ÿ"></a>1.1 æ–‡ä»¶ç³»ç»Ÿ</h3><p>æ–‡ä»¶ç³»ç»Ÿï¼Œç®€å•æ¥è¯´å°±æ˜¯å­˜å‚¨å’Œç»„ç»‡æ•°æ®çš„æ–¹å¼ã€‚æ¯”å¦‚åœ¨iOS 10.3ç³»ç»Ÿä»¥åï¼Œè‹¹æœä½¿ç”¨APFSï¼ˆApple File Systemï¼‰æ›¿ä»£ä¹‹å‰æ—§çš„æ–‡ä»¶ç³»ç»ŸHFS+ã€‚å¯¹äºAndroidæ¥è¯´ï¼Œç°åœ¨æ™®éä½¿ç”¨çš„æ˜¯Linuxå¸¸ç”¨çš„ext4æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å…³äºæ–‡ä»¶ç³»ç»Ÿè¿˜éœ€è¦å¤šè¯´ä¸¤å¥ï¼Œåä¸ºåœ¨EMUI 5.0ä»¥åå°±ä½¿ç”¨F2FSå–ä»£ext4ï¼ŒGoogleä¹Ÿåœ¨æœ€æ–°çš„æ——èˆ°æ‰‹æœºPixel 3ä½¿ç”¨äº†F2FSæ–‡ä»¶ç³»ç»Ÿã€‚Flash-Friendly File Systemæ˜¯ä¸‰æ˜Ÿæ˜¯ä¸“é—¨ä¸ºNANDé—ªå­˜èŠ¯ç‰‡å¼€å‘çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿåšäº†å¤§é‡é’ˆå¯¹é—ªå­˜çš„ä¼˜åŒ–ã€‚æ ¹æ®åä¸ºçš„æµ‹è¯•æ•°æ®ï¼ŒF2FSæ–‡ä»¶ç³»ç»Ÿåœ¨å°æ–‡ä»¶çš„éšæœºè¯»å†™æ–¹é¢æ¯”ext4æ›´å¿«ï¼Œä¾‹å¦‚éšæœºå†™å¯ä»¥ä¼˜åŒ–60%ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºå¯é æ€§æ–¹é¢å‡ºç°è¿‡ä¸€äº›é—®é¢˜ã€‚æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œéšç€Googleã€åä¸ºçš„æŠ•å…¥å’Œè§„æ¨¡åŒ–ä½¿ç”¨ï¼ŒF2FSç³»ç»Ÿåº”è¯¥æ˜¯æœªæ¥Androidçš„ä¸»æµæ–‡ä»¶ç³»ç»Ÿã€‚</p><p>è¿˜æ˜¯å›åˆ°æ–‡ä»¶ç³»ç»Ÿçš„I&#x2F;Oã€‚åº”ç”¨ç¨‹åºè°ƒç”¨read()æ–¹æ³•ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸­æ–­ä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸å¤„ç†æµç¨‹ï¼Œç„¶åç»è¿‡VFSï¼ˆVirtual File Systemï¼Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ã€å…·ä½“æ–‡ä»¶ç³»ç»Ÿã€é¡µç¼“å­˜Page Cacheã€‚ä¸‹é¢æ˜¯Linuxä¸€ä¸ªé€šç”¨çš„I&#x2F;Oæ¶æ„æ¨¡å‹ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-a7586fb52f51be3a.png" style="zoom: 67%;"><ul><li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ã€‚å®ƒä¸»è¦ç”¨äºå®ç°å±è”½å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºåº”ç”¨ç¨‹åºçš„æ“ä½œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚è¿™æ ·ä¿è¯å°±ç®—å‚å•†æŠŠæ–‡ä»¶ç³»ç»Ÿä»ext4åˆ‡æ¢åˆ°F2FSï¼Œåº”ç”¨ç¨‹åºä¹Ÿä¸ç”¨åšä»»ä½•ä¿®æ”¹ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰ã€‚ext4ã€F2FSéƒ½æ˜¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ–‡ä»¶å…ƒæ•°æ®å¦‚ä½•ç»„ç»‡ã€ç›®å½•å’Œç´¢å¼•ç»“æ„å¦‚ä½•è®¾è®¡ã€æ€ä¹ˆåˆ†é…å’Œæ¸…ç†æ•°æ®ï¼Œè¿™äº›éƒ½æ˜¯è®¾è®¡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿…é¡»è¦è€ƒè™‘çš„ã€‚<strong>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰é€‚åˆè‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬ä¸èƒ½è¯´F2FSå°±ä¸€å®šæ¯”ext4è¦å¥½ã€‚</strong>F2FSåœ¨è¿ç»­è¯»å–å¤§æ–‡ä»¶ä¸Šå¹¶æ²¡æœ‰ä¼˜åŠ¿ï¼Œè€Œä¸”ä¼šå ç”¨æ›´å¤§çš„ç©ºé—´ã€‚åªæ˜¯å¯¹ä¸€èˆ¬åº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒéšæœºI&#x2F;Oä¼šæ›´åŠ é¢‘ç¹ï¼Œç‰¹åˆ«æ˜¯åœ¨å¯åŠ¨çš„åœºæ™¯ã€‚ä½ å¯ä»¥åœ¨&#x2F;proc&#x2F;filesystemsçœ‹åˆ°ç³»ç»Ÿå¯ä»¥è¯†åˆ«çš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åˆ—è¡¨ã€‚</li><li>é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ã€‚åœ¨å¯åŠ¨ä¼˜åŒ–ä¸­æˆ‘å·²ç»è®²è¿‡Page Cacheè¿™ä¸ªæ¦‚å¿µäº†ï¼Œåœ¨è¯»æ–‡ä»¶çš„æ—¶å€™ä¼šï¼Œå…ˆçœ‹å®ƒæ˜¯ä¸æ˜¯å·²ç»åœ¨Page Cacheä¸­ï¼Œå¦‚æœå‘½ä¸­å°±ä¸ä¼šå»è¯»å–ç£ç›˜ã€‚åœ¨Linux 2.4.10ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªå•ç‹¬çš„Buffer Cacheï¼Œåæ¥å®ƒä¹Ÿåˆå¹¶åˆ°Page Cacheä¸­çš„Buffer Pageäº†ã€‚</li></ul><p>å…·ä½“æ¥è¯´ï¼ŒPage Cacheå°±åƒæ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„æ•°æ®ç¼“å­˜ï¼Œæ˜¯æ–‡ä»¶ç³»ç»Ÿå¯¹æ•°æ®çš„ç¼“å­˜ï¼Œç›®çš„æ˜¯æå‡å†…å­˜å‘½ä¸­ç‡ã€‚Buffer Cacheå°±åƒæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„BufferInputStreamï¼Œæ˜¯ç£ç›˜å¯¹æ•°æ®çš„ç¼“å­˜ï¼Œç›®çš„æ˜¯åˆå¹¶éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿçš„I&#x2F;Oè¯·æ±‚ã€é™ä½ç£ç›˜I&#x2F;Oçš„æ¬¡æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬æ—¢ä¼šç”¨åœ¨è¯»è¯·æ±‚ä¸­ï¼Œä¹Ÿä¼šç”¨åˆ°å†™è¯·æ±‚ä¸­ã€‚<br>é€šè¿‡&#x2F;proc&#x2F;meminfoæ–‡ä»¶å¯ä»¥æŸ¥çœ‹ç¼“å­˜çš„å†…å­˜å ç”¨æƒ…å†µï¼Œå½“æ‰‹æœºå†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå›æ”¶å®ƒä»¬çš„å†…å­˜ï¼Œè¿™æ ·æ•´ä½“I&#x2F;Oçš„æ€§èƒ½å°±ä¼šæœ‰æ‰€é™ä½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">MemTotal:    2866492 kB<br>MemFree:      72192 kB<br>Buffers:      62708 kB      // Buffer Cache<br>Cached:      652904 kB      // Page Cache<br></code></pre></td></tr></table></figure><h3 id="1-2-ç£ç›˜"><a href="#1-2-ç£ç›˜" class="headerlink" title="1.2 ç£ç›˜"></a>1.2 ç£ç›˜</h3><p>ç£ç›˜æŒ‡çš„æ˜¯ç³»ç»Ÿçš„å­˜å‚¨è®¾å¤‡ï¼Œå°±åƒå°æ—¶å€™æˆ‘ä»¬å¸¸å¬çš„CDæˆ–è€…ç”µè„‘ä½¿ç”¨çš„æœºæ¢°ç¡¬ç›˜ï¼Œå½“ç„¶è¿˜æœ‰ç°åœ¨æ¯”è¾ƒæµè¡Œçš„SSDå›ºæ€ç¡¬ç›˜ã€‚<br>æ­£å¦‚æˆ‘ä¸Šé¢æ‰€è¯´ï¼Œå¦‚æœå‘ç°åº”ç”¨ç¨‹åºè¦read()çš„æ•°æ®æ²¡æœ‰åœ¨é¡µç¼“å­˜ä¸­ï¼Œè¿™æ—¶å€™å°±éœ€è¦çœŸæ­£å‘ç£ç›˜å‘èµ·I&#x2F;Oè¯·æ±‚ã€‚è¿™ä¸ªè¿‡ç¨‹è¦å…ˆç»è¿‡å†…æ ¸çš„é€šç”¨å—å±‚ã€I&#x2F;Oè°ƒåº¦å±‚ã€è®¾å¤‡é©±åŠ¨å±‚ï¼Œæœ€åæ‰ä¼šäº¤ç»™å…·ä½“çš„ç¡¬ä»¶è®¾å¤‡å¤„ç†ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-5a8d09f33aacf7fd.png" style="zoom: 67%;"><ul><li>é€šç”¨å—å±‚ã€‚ç³»ç»Ÿä¸­èƒ½å¤Ÿéšæœºè®¿é—®å›ºå®šå¤§å°æ•°æ®å—ï¼ˆblockï¼‰çš„è®¾å¤‡ç§°ä¸ºå—è®¾å¤‡ï¼ŒCDã€ç¡¬ç›˜å’ŒSSDè¿™äº›éƒ½å±äºå—è®¾å¤‡ã€‚é€šç”¨å—å±‚ä¸»è¦ä½œç”¨æ˜¯æ¥æ”¶ä¸Šå±‚å‘å‡ºçš„ç£ç›˜è¯·æ±‚ï¼Œå¹¶æœ€ç»ˆå‘å‡ºI&#x2F;Oè¯·æ±‚ã€‚å®ƒè·ŸVFSçš„ä½œç”¨ç±»ä¼¼ï¼Œè®©ä¸Šå±‚ä¸éœ€è¦å…³å¿ƒåº•å±‚ç¡¬ä»¶è®¾å¤‡çš„å…·ä½“å®ç°ã€‚</li><li>I&#x2F;Oè°ƒåº¦å±‚ã€‚ç£ç›˜I&#x2F;Oé‚£ä¹ˆæ…¢ï¼Œä¸ºäº†é™ä½çœŸæ­£çš„ç£ç›˜I&#x2F;Oï¼Œæˆ‘ä»¬ä¸èƒ½æ¥æ”¶åˆ°ç£ç›˜è¯·æ±‚å°±ç«‹åˆ»äº¤ç»™é©±åŠ¨å±‚å¤„ç†ã€‚æ‰€ä»¥æˆ‘ä»¬å¢åŠ äº†I&#x2F;Oè°ƒåº¦å±‚ï¼Œå®ƒä¼šæ ¹æ®è®¾ç½®çš„è°ƒåº¦ç®—æ³•å¯¹è¯·æ±‚åˆå¹¶å’Œæ’åºã€‚è¿™é‡Œæ¯”è¾ƒå…³é”®çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é˜Ÿåˆ—é•¿åº¦ï¼Œä¸€ä¸ªæ˜¯å…·ä½“çš„è°ƒåº¦ç®—æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–‡ä»¶å¯ä»¥æŸ¥çœ‹å¯¹åº”å—è®¾å¤‡çš„é˜Ÿåˆ—é•¿åº¦å’Œä½¿ç”¨çš„è°ƒåº¦ç®—æ³•ã€‚</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">/sys/block/[disk]/queue/nr_requests      // é˜Ÿåˆ—é•¿åº¦ï¼Œä¸€èˆ¬æ˜¯ 128ã€‚<br>/sys/block/[disk]/queue/scheduler        // è°ƒåº¦ç®—æ³•<br></code></pre></td></tr></table></figure><ul><li>å—è®¾å¤‡é©±åŠ¨å±‚ã€‚å—è®¾å¤‡é©±åŠ¨å±‚æ ¹æ®å…·ä½“çš„ç‰©ç†è®¾å¤‡ï¼Œé€‰æ‹©å¯¹åº”çš„é©±åŠ¨ç¨‹åºé€šè¿‡æ“æ§ç¡¬ä»¶è®¾å¤‡å®Œæˆæœ€ç»ˆçš„I&#x2F;Oè¯·æ±‚ã€‚ä¾‹å¦‚å…‰ç›˜æ˜¯é æ¿€å…‰åœ¨è¡¨é¢çƒ§å½•å­˜å‚¨ã€é—ªå­˜æ˜¯é ç”µå­æ“¦å†™å­˜å‚¨æ•°æ®</li></ul><h2 id="2-I-x2F-Oçš„æ€§èƒ½è¯„ä¼°"><a href="#2-I-x2F-Oçš„æ€§èƒ½è¯„ä¼°" class="headerlink" title="2.I&#x2F;Oçš„æ€§èƒ½è¯„ä¼°"></a>2.I&#x2F;Oçš„æ€§èƒ½è¯„ä¼°</h2><p>æ­£å¦‚ä¸‹å›¾ä½ æ‰€çœ‹åˆ°çš„ï¼Œæ•´ä¸ªI&#x2F;Oçš„æµç¨‹æ¶‰åŠçš„é“¾è·¯éå¸¸é•¿ã€‚æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­é€šè¿‡æ‰“ç‚¹ï¼Œå‘ç°ä¸€ä¸ªæ–‡ä»¶è¯»å–éœ€è¦300msã€‚ä½†æ˜¯ä¸‹é¢æ¯ä¸€å±‚å¯èƒ½éƒ½æœ‰è‡ªå·±çš„ç­–ç•¥å’Œè°ƒåº¦ç®—æ³•ï¼Œå› æ­¤å¾ˆéš¾çœŸæ­£çš„å¾—åˆ°æ¯ä¸€å±‚çš„è€—æ—¶ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-ee5db940a613d188.png" style="zoom: 67%;"><p>åœ¨å‰é¢çš„å¯åŠ¨ä¼˜åŒ–å†…å®¹ä¸­ï¼Œæˆ‘è®²è¿‡Facebookå’Œæ”¯ä»˜å®é‡‡ç”¨ç¼–è¯‘å•ç‹¬ROMçš„æ–¹æ³•æ¥è¯„ä¼°I&#x2F;Oæ€§èƒ½ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚ä½†æ˜¯æœ‰æ•ˆçš„åšæ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šåˆ¶æºç ï¼Œé€‰æ‹©æ‰“å¼€æ„Ÿå…´è¶£çš„æ—¥å¿—æ¥è¿½è¸ªI&#x2F;Oçš„æ€§èƒ½ã€‚</p><ol><li>I&#x2F;Oæ€§èƒ½æŒ‡æ ‡<br>I&#x2F;Oæ€§èƒ½è¯„ä¼°ä¸­æœ€ä¸ºæ ¸å¿ƒçš„æŒ‡æ ‡æ˜¯ååé‡å’ŒIOPSã€‚ä»Šå¤©æ–‡ç« å¼€å¤´æ‰€è¯´çš„ï¼Œâ€œè¿ç»­è¯»å–ä¸è¶…è¿‡550MB&#x2F;sï¼Œè¿ç»­å†™å…¥ä¸è¶…è¿‡520MB&#x2F;sâ€ï¼Œå°±æŒ‡çš„æ˜¯I&#x2F;Oååé‡ã€‚<br>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æŒ‡æ ‡æ˜¯IOPSï¼Œå®ƒæŒ‡çš„æ˜¯æ¯ç§’å¯ä»¥è¯»å†™çš„æ¬¡æ•°ã€‚å¯¹äºéšæœºè¯»å†™é¢‘ç¹çš„åº”ç”¨ï¼Œä¾‹å¦‚å¤§é‡çš„å°æ–‡ä»¶å­˜å‚¨ï¼ŒIOPSæ˜¯å…³é”®çš„è¡¡é‡æŒ‡æ ‡ã€‚</li><li>I&#x2F;Oæµ‹é‡<br>å¦‚æœä¸é‡‡ç”¨å®šåˆ¶æºç çš„æ–¹å¼ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•å¯ä»¥ç”¨æ¥æµ‹é‡I&#x2F;Oçš„æ€§èƒ½å‘¢ï¼Ÿ\</li></ol><p><strong>ç¬¬ä¸€ç§æ–¹æ³•ï¼šä½¿ç”¨procã€‚</strong><br>æ€»çš„æ¥è¯´ï¼ŒI&#x2F;Oæ€§èƒ½ä¼šè·Ÿå¾ˆå¤šå› ç´ æœ‰å…³ï¼Œæ˜¯è¯»è¿˜æ˜¯å†™ã€æ˜¯å¦æ˜¯è¿ç»­ã€I&#x2F;Oå¤§å°ç­‰ã€‚å¦å¤–ä¸€ä¸ªå¯¹I&#x2F;Oæ€§èƒ½å½±å“æ¯”è¾ƒå¤§çš„å› ç´ æ˜¯è´Ÿè½½ï¼ŒI&#x2F;Oæ€§èƒ½ä¼šéšç€è´Ÿè½½çš„å¢åŠ è€Œé™ä½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡I&#x2F;Oçš„ç­‰å¾…æ—¶é—´å’Œæ¬¡æ•°æ¥è¡¡é‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">proc/self/schedstat:<br>  se.statistics.iowait_countï¼šIO ç­‰å¾…çš„æ¬¡æ•°<br>  se.statistics.iowait_sumï¼š  IO ç­‰å¾…çš„æ—¶é—´<br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯rootçš„æœºå™¨ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯å†…æ ¸çš„I&#x2F;Oç›‘æ§ï¼Œå°†æ‰€æœ‰blockè¯»å†™dumpåˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡dmesgå‘½ä»¤æ¥æŸ¥çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo 1 &amp;gt; /proc/sys/vm/block_dump<br>dmesg -c grep pid<br>.sample.io.test(7540): READ block 29262592 on dm-1 (256 sectors)<br>.sample.io.test(7540): READ block 29262848 on dm-1 (256 sectors)<br></code></pre></td></tr></table></figure><p><strong>ç¬¬äºŒç§æ–¹æ³•ï¼šä½¿ç”¨straceã€‚</strong><br>Linuxæä¾›äº†iostatã€iotopç­‰ä¸€äº›ç›¸å…³çš„å‘½ä»¤ï¼Œä¸è¿‡å¤§éƒ¨åˆ†Anroidè®¾å¤‡éƒ½ä¸æ”¯æŒã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ straceæ¥è·Ÿè¸ªI&#x2F;Oç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°å’Œè€—æ—¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">strace -ttT -f -p [pid]<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000447&amp;gt;<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000084&amp;gt;<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000059&amp;gt;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ—¥å¿—ï¼Œä½ å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºåœ¨è¯»å–æ–‡ä»¶æ“ä½œç¬¦ä¸º53çš„æ–‡ä»¶ï¼Œæ¯æ¬¡è¯»å–1024ä¸ªå­—èŠ‚ã€‚ç¬¬ä¸€æ¬¡è¯»å–èŠ±äº†447usï¼Œåé¢ä¸¤æ¬¡éƒ½ä½¿ç”¨äº†100usä¸åˆ°ã€‚è¿™è·Ÿå¯åŠ¨ä¼˜åŒ–æåˆ°çš„â€œæ•°æ®é‡æ’â€æ˜¯ä¸€ä¸ªåŸå› ï¼Œæ–‡ä»¶ç³»ç»Ÿæ¯æ¬¡è¯»å–ä»¥blockä¸ºå•ä½ï¼Œè€Œblockçš„å¤§å°ä¸€èˆ¬æ˜¯4KBï¼Œåé¢ä¸¤æ¬¡çš„è¯»å–æ˜¯ä»é¡µç¼“å­˜å¾—åˆ°ã€‚<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡straceç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„è€—æ—¶æ¦‚å†µã€‚ä¸è¿‡straceæœ¬èº«ä¹Ÿä¼šæ¶ˆè€—ä¸å°‘èµ„æºï¼Œå¯¹æ‰§è¡Œæ—¶é—´ä¹Ÿä¼šäº§ç”Ÿå½±å“ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">strace -c -f -p [pid]<br><span class="hljs-meta prompt_">% </span><span class="language-bash">time     seconds  usecs/call     calls    errors  syscall</span><br>------ ----------- ----------- --------- --------- â€”â€”â€”â€”â€”â€”â€”â€”<br> 97.56    0.041002          21      1987             read<br>  1.44    0.000605          55        11             write<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¿¡æ¯ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¯»å äº†97.56%çš„æ—¶é—´ï¼Œä¸€å…±è°ƒç”¨äº†1987æ¬¡ï¼Œè€—æ—¶0.04sï¼Œå¹³å‡æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨21usã€‚åŒæ ·çš„é“ç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¡ç®—åº”ç”¨ç¨‹åºæŸä¸ªä»»åŠ¡I&#x2F;Oè€—æ—¶çš„ç™¾åˆ†æ¯”ã€‚å‡è®¾ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œäº†10sï¼ŒI&#x2F;OèŠ±äº†9sï¼Œé‚£ä¹ˆI&#x2F;Oè€—æ—¶ç™¾åˆ†æ¯”å°±æ˜¯90%ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒI&#x2F;Oå°±æ˜¯æˆ‘ä»¬ä»»åŠ¡å¾ˆå¤§çš„ç“¶é¢ˆï¼Œéœ€è¦å»åšè¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚</p><p><strong>ç¬¬ä¸‰ç§æ–¹æ³•ï¼šä½¿ç”¨vmstatã€‚</strong><br>vmstatçš„å„ä¸ªå­—æ®µè¯´æ˜å¯ä»¥å‚è€ƒã€Švmstatç›‘è§†å†…å­˜ä½¿ç”¨æƒ…å†µã€‹ï¼Œå…¶ä¸­Memoryä¸­çš„buffå’Œcacheï¼ŒI&#x2F;Oä¸­çš„biå’Œboï¼ŒSystemä¸­çš„csï¼Œä»¥åŠCPUä¸­çš„syå’Œwaï¼Œè¿™äº›å­—æ®µçš„æ•°å€¼éƒ½ä¸I&#x2F;Oè¡Œä¸ºæœ‰å…³ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é…åˆddå‘½ä»¤æ¥é…åˆæµ‹è¯•ï¼Œè§‚å¯Ÿvmstatçš„è¾“å‡ºæ•°æ®å˜åŒ–ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯Androidé‡Œé¢çš„ddå‘½ä»¤ä¼¼ä¹å¹¶ä¸æ”¯æŒconvå’Œflagå‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">//æ¸…é™¤Bufferå’ŒCacheå†…å­˜ç¼“å­˜<br>echo 3 &amp;gt; /proc/sys/vm/drop_caches<br>//æ¯éš”1ç§’è¾“å‡º1ç»„vmstatæ•°æ®<br>vmstat 1<br>//æµ‹è¯•å†™å…¥é€Ÿåº¦ï¼Œå†™å…¥æ–‡ä»¶/data/data/testï¼Œbufferå¤§å°ä¸º4Kï¼Œæ¬¡æ•°ä¸º1000æ¬¡<br>dd if=/dev/zero of=/data/data/test bs=4k count=1000<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°</title>
    <link href="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/"/>
    <url>/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"><a href="#Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°" class="headerlink" title="Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"></a>Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°</h1><p>å†™ä»£ç æ—¶å¯¹å­—ç¬¦å’Œå­—ç¬¦ä¸²çš„å¤„ç†å¾ˆé¢‘ç¹ï¼Œä½†æ˜¯Cè¯­è¨€ä¸­æœ¬èº«æ²¡æœ‰å­—ç¬¦ä¸²ç±»å‹ï¼Œå­—ç¬¦ä¸²é€šå¸¸å­˜å‚¨åœ¨<strong>å¸¸é‡å­—ç¬¦ä¸²ï¼ˆconst char* strï¼‰</strong>ä¸­æˆ–è€…<strong>å­—ç¬¦æ•°ç»„ï¼ˆchar str[] &#x3D; â€œamxâ€ï¼‰</strong>ä¸­ã€‚<strong>å¸¸é‡å­—ç¬¦ä¸²</strong>é€‚ç”¨äºé‚£äº›å¯¹å®ƒä¸åšä¿®æ”¹çš„å­—ç¬¦ä¸²å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®å®šåœ¨Cè¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²éƒ½æ˜¯ä»¥\0ç»“å°¾çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬åˆ›å»ºçš„æ—¶å€™ä¸ç”¨è‡ªå·±æ·»åŠ ï¼Œæ˜¯ç¼–è¯‘çš„æ—¶å€™ç”±ç¼–è¯‘å™¨æ·»åŠ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-keyword">if</span> (str[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;æœ«å°¾æ˜¯\\0\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/æˆªå±2022-05-21 16.32.40.png"><h2 id="1-å­—ç¬¦ä¸²çš„é•¿åº¦"><a href="#1-å­—ç¬¦ä¸²çš„é•¿åº¦" class="headerlink" title="1.å­—ç¬¦ä¸²çš„é•¿åº¦"></a>1.å­—ç¬¦ä¸²çš„é•¿åº¦</h2><h3 id="1-1-strlen"><a href="#1-1-strlen" class="headerlink" title="1.1 strlen"></a>1.1 strlen</h3><p>ä½œç”¨ï¼šæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strlen</span>(str)); <span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#2-é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="2.é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"></a>2.é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°</h2><h3 id="2-1-strcpy"><a href="#2-1-strcpy" class="headerlink" title="2.1  strcpy"></a>2.1  strcpy</h3><p>ä½œç”¨ï¼šå¤åˆ¶å­—ç¬¦ä¸²</p><p>å°†<strong>æº</strong>æ‰€æŒ‡å‘çš„ C å­—ç¬¦ä¸²å¤åˆ¶åˆ°<strong>ç›®æ ‡</strong>æ‰€æŒ‡å‘çš„æ•°ç»„ä¸­ï¼ŒåŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼ˆå¹¶åœ¨è¯¥ç‚¹åœæ­¢ï¼‰ã€‚</p><blockquote><p>ä¸ºé¿å…æº¢å‡ºï¼Œç›®æ ‡æ‰€æŒ‡å‘çš„æ•°ç»„çš„å¤§å°åº”è¶³å¤Ÿé•¿ï¼Œä»¥åŒ…å«ä¸æºç›¸åŒçš„ C å­—ç¬¦ä¸²ï¼ˆåŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼‰ï¼Œå¹¶ä¸”ä¸åº”åœ¨å†…å­˜ä¸­ä¸ source é‡å ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[<span class="hljs-number">20</span>];<br>    <br>    <span class="hljs-built_in">strcpy</span>(str2,str);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// amx</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-strcat"><a href="#2-2-strcat" class="headerlink" title="2.2 strcat"></a>2.2 strcat</h3><p>ä½œç”¨ï¼šè¿æ¥å­—ç¬¦ä¸²</p><p>å°†â€â€<strong>æº</strong>â€â€å­—ç¬¦ä¸²çš„å‰¯æœ¬è¿½åŠ åˆ°â€â€<strong>ç›®æ ‡</strong>â€â€å­—ç¬¦ä¸²ã€‚â€<em>â€</em>ç›®æ ‡â€â€ä¸­çš„ç»ˆæ­¢ç©ºå­—ç¬¦è¢«â€<em>â€</em>æº<em>â€</em>â€çš„ç¬¬ä¸€ä¸ªå­—ç¬¦è¦†ç›–ï¼Œå¹¶ä¸”åœ¨â€<em>â€</em>ç›®æ ‡<em>â€</em>â€ä¸­ç”±ä¸¤è€…ä¸²è”å½¢æˆçš„æ–°å­—ç¬¦ä¸²çš„æœ«å°¾åŒ…å«ä¸€ä¸ªç©ºå­—ç¬¦ã€‚â€</p><blockquote><p>æ³¨ï¼šç›®çš„åœ°â€â€å’Œâ€â€æ¥æºâ€â€ä¸å¾—é‡å ã€‚<strong>è‡ªå·±ä¸èƒ½ç»™è‡ªå·±è¿½åŠ ã€‚</strong></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hello &quot;</span>;<br>    <br>    <span class="hljs-built_in">strcat</span>(str2,str1);  <span class="hljs-comment">// å°†str1æ·»åŠ åˆ°str2åé¢å»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// hello amx</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-strcmp"><a href="#2-3-strcmp" class="headerlink" title="2.3 strcmp"></a>2.3 strcmp</h3><p>ä½œç”¨ï¼šæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²</p><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/d04949f8-1e4a-482b-be1c-b1de518ec939.png"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hello &quot;</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strcmp</span>(str1,str2));  <span class="hljs-comment">// -7</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#3-é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="3.é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"></a>3.é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°</h2><h3 id="3-1-strncpy"><a href="#3-1-strncpy" class="headerlink" title="3.1 strncpy"></a>3.1 strncpy</h3><p>ä½œç”¨ï¼š<strong>Copy characters from string</strong>ä»å­—ç¬¦ä¸²ä¸­å¤åˆ¶å­—ç¬¦</p><p>å°†<strong>æº</strong>çš„å‰<strong>num</strong>å­—ç¬¦å¤åˆ¶åˆ°<strong>ç›®æ ‡</strong>ã€‚å¦‚æœåœ¨å¤åˆ¶<strong>num</strong>ä¸ªå­—ç¬¦ä¹‹å‰æ‰¾åˆ°<strong>æº</strong>C å­—ç¬¦ä¸²ï¼ˆç”±ç©ºå­—ç¬¦æŒ‡ç¤ºï¼‰çš„æœ«å°¾ï¼Œåˆ™<strong>ç›®æ ‡</strong>å°†å¡«å……é›¶ï¼Œç›´åˆ°å‘å…¶å†™å…¥æ€»å…±<strong>num</strong>ä¸ªå­—ç¬¦ã€‚</p><blockquote><p>å¦‚æœæºçš„é•¿åº¦è¶…è¿‡ numï¼Œåˆ™ä¸ä¼šåœ¨ç›®æ ‡æœ«å°¾éšå¼è¿½åŠ ç©ºå­—ç¬¦ã€‚</p><p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>ç›®æ ‡</strong>ä¸åº”è¢«è§†ä¸ºä»¥ç©ºå€¼ç»“å°¾çš„ C å­—ç¬¦ä¸²ï¼ˆè¿™æ ·è¯»å–å®ƒä¼šæº¢å‡ºï¼‰ã€‚</p><p>ç›®çš„åœ°å’Œæ¥æºä¸å¾—é‡å ï¼ˆé‡å æ—¶ï¼Œè¯·å‚é˜… memmove ä»¥äº†è§£æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼‰ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[<span class="hljs-number">20</span>];<br>    <br>    <span class="hljs-built_in">strncpy</span>(str2,str1,<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// hello</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-strncat"><a href="#3-2-strncat" class="headerlink" title="3.2 strncat"></a>3.2 strncat</h3><p>ä½œç”¨ï¼šå°†<strong>æº</strong>çš„å‰<strong>num</strong>ä¸ªå­—ç¬¦è¿½åŠ åˆ°<strong>ç›®æ ‡</strong>ï¼ŒåŠ ä¸Šä¸€ä¸ªç»ˆæ­¢ç©ºå­—ç¬¦ã€‚</p><blockquote><p>å¦‚æœæºä¸­ C å­—ç¬¦ä¸²çš„é•¿åº¦å°äº<strong>num</strong>ï¼Œåˆ™ä»…å¤åˆ¶ç›´åˆ°ç»ˆæ­¢ç©ºå­—ç¬¦çš„å†…å®¹ã€‚</p><p>å¦‚æœsourceæ‹·è´è¿›å»ä¹‹ådesinationè¿˜æœ‰åŸæœ¬å­˜åœ¨çš„å­—ç¬¦ä¼šä¸»åŠ¨è¿½åŠ ä¸€ä¸ªâ€™\0â€™ã€‚</p><p>å¦‚æœè¿½åŠ é•¿åº¦numå¤§äºstrlen(source),åˆ™åªè¿½åŠ sourceåŸæœ¬çš„å­—ç¬¦ä¸²å’Œä¸€ä¸ªâ€™\0â€™</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;HI!&quot;</span>;<br>    <br>    <span class="hljs-built_in">strncat</span>(str2,str1,<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// HI!hello</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-strncmp"><a href="#3-3-strncmp" class="headerlink" title="3.3 strncmp"></a>3.3 strncmp</h3><p>ä½œç”¨ï¼šå°† C å­—ç¬¦ä¸²<strong>str1</strong>çš„<strong>æœ€å¤š num</strong>ä¸ªå­—ç¬¦ä¸ C å­—ç¬¦ä¸²<strong>str2</strong>çš„å­—ç¬¦æ•°è¿›è¡Œæ¯”è¾ƒã€‚</p><blockquote><p>æ­¤å‡½æ•°å¼€å§‹æ¯”è¾ƒæ¯ä¸ªå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœå®ƒä»¬å½¼æ­¤ç›¸ç­‰ï¼Œåˆ™ç»§ç»­å‘åæ¯”è¾ƒï¼Œç›´åˆ°å­—ç¬¦ä¸åŒï¼Œç›´åˆ°è¾¾åˆ°ç»ˆæ­¢ç©ºå­—ç¬¦ï¼Œæˆ–è€…ç›´åˆ°ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸­çš„<strong>num</strong>å­—ç¬¦åŒ¹é…ï¼Œä»¥å…ˆå‘ç”Ÿçš„æƒ…å†µä¸ºå‡†ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hellaaaa&quot;</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strncmp</span>(str1,str2,<span class="hljs-number">4</span>));  <span class="hljs-comment">// 0</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strncmp</span>(str1,str2,<span class="hljs-number">5</span>));  <span class="hljs-comment">// 14</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#4-å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="4.å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°"></a>4.å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°</h2><blockquote><p>ä¸ºäº†å‡è½»ç¨‹åºå‘˜æ·»åŠ ç»“æŸç¬¦å’Œå¤„ç†å­—ç¬¦ä¸²æˆªæ–­çš„è´Ÿæ‹…ï¼Œå¯ä»¥ä½¿ç”¨strlcpyå’Œstrlcatå‡½æ•°ã€‚</p><p>ğŸ­æ–‡æ¡£ï¼š<a href="https://gratisoft.us/todd/papers/strlcpy.html">https://gratisoft.us/todd/papers/strlcpy.html</a></p></blockquote><h3 id="4-1-strlcpy"><a href="#4-1-strlcpy" class="headerlink" title="4.1 strlcpy"></a>4.1 strlcpy</h3><p>ä½œç”¨ï¼š</p><p><strong>strlcpyæºä»£ç ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">strlcpy</span><span class="hljs-params">(<span class="hljs-type">char</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src, <span class="hljs-type">size_t</span> dsize)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *osrc = src;<br>    <span class="hljs-type">size_t</span> nleft = dsize;<br>    <span class="hljs-comment">/* Copy as many bytes as will fit. */</span><br>    <span class="hljs-keyword">if</span> (nleft != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">while</span> (--nleft != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> ((*dst++ = *src++) == <span class="hljs-string">&#x27;\0&#x27;</span>)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/* Not enough room in dst, add NUL and traverse rest of src. */</span><br>    <span class="hljs-keyword">if</span> (nleft == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (dsize != <span class="hljs-number">0</span>)<br>            *dst = <span class="hljs-string">&#x27;\0&#x27;</span>;        <span class="hljs-comment">/* NUL-terminate dst */</span><br>        <span class="hljs-keyword">while</span> (*src++);<br>    &#125;<br>    <span class="hljs-keyword">return</span>(src - osrc - <span class="hljs-number">1</span>);    <span class="hljs-comment">/* count does not include NUL */</span><br>&#125;<br></code></pre></td></tr></table></figure><p> <code>strlcpy</code>å°† <code>src</code> æŒ‰å­—ç¬¦æ‹·è´åˆ° <code>dst</code>ä¸­ï¼Œæœ€å¤šæ‹·è´<code>dszie-1</code>ä¸ªå­—ç¬¦ï¼Œæ‹·è´ç»“æŸååœ¨ <code>dst</code> æœ«å°¾æ·»åŠ  <code>0x00</code>ç»“æŸç¬¦ï¼Œè¿”å›å€¼æ˜¯ <code>src</code>çš„é•¿åº¦ã€‚ä¸€èˆ¬å°† <code>dsize</code>ç½®ä¸º<code>dst</code>çš„å¤§å°ã€‚ç›¸è¾ƒäºstrncpyï¼Œ<strong>strlcpyæœ‰ä¸¤ä¸ªä¼˜ç‚¹</strong>ï¼š</p><ul><li>å½“<code>strlen(src)</code>å¤§äºç­‰äº<code>dsize</code>æ—¶è‡ªåŠ¨åœ¨<code>dst</code>æœ«å°¾æ·»åŠ ç»“æŸç¬¦ï¼›</li><li>è¿”å›å€¼å¤§äºç­‰äº<code>dsize</code>æ—¶ç¡®å®šå‘ç”Ÿå­—ç¬¦ä¸²æˆªæ–­ã€‚ä»¥ä¸Šä¸¤ç‚¹å¸®åŠ©ç¨‹åºå‘˜è¿›è¡Œåˆ¤æ–­ï¼Œæ–¹ä¾¿åç»­å¤„ç†ã€‚</li></ul><h3 id="4-2-strlcat"><a href="#4-2-strlcat" class="headerlink" title="4.2 strlcat"></a>4.2 strlcat</h3><p>ä½œç”¨ï¼š</p><p><strong>strlcatæºä»£ç ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">strlcat</span><span class="hljs-params">(<span class="hljs-type">char</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src, <span class="hljs-type">size_t</span> dsize)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *odst = dst;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *osrc = src;<br>    <span class="hljs-type">size_t</span> n = dsize;<br>    <span class="hljs-type">size_t</span> dlen;<br>    <span class="hljs-comment">/* Find the end of dst and adjust bytes left but don&#x27;t go past end. */</span><br>    <span class="hljs-keyword">while</span> (n-- != <span class="hljs-number">0</span> &amp;&amp; *dst != <span class="hljs-string">&#x27;\0&#x27;</span>)<br>        dst++;<br>    dlen = dst - odst;<br>    n = dsize - dlen;<br><br>    <span class="hljs-keyword">if</span> (n-- == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(dlen + <span class="hljs-built_in">strlen</span>(src));<br>    <span class="hljs-keyword">while</span> (*src != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-keyword">if</span> (n != <span class="hljs-number">0</span>) &#123;<br>            *dst++ = *src;<br>            n--;<br>        &#125;<br>        src++;<br>    &#125;<br>    *dst = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-keyword">return</span>(dlen + (src - osrc));    <span class="hljs-comment">/* count does not include NUL */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>dlen</code>æ˜¯ <code>dst</code>ä¸­åŸæœ‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸åŒ…å«<code>0x00</code>ç»“æŸç¬¦ï¼‰ï¼›<code>dsize</code>æ˜¯ <code>dst</code>ç¼“å†²åŒºçš„æ€»å¤§å°ï¼ˆåŒ…å«ç»“æŸç¬¦ï¼‰ã€‚ å®ƒé¦–å…ˆæ‰¾åˆ° <code>dst</code>ä¸­æºå­—ç¬¦ä¸²çš„ç»“æŸç¬¦ï¼Œç„¶åè®¡ç®—å‰©ä½™ç©ºé—´å¤§å°ï¼Œå¦‚æœä¸º0ï¼Œåˆ™è¿”å›ã€‚å¦‚æœæœ‰å‰©ä½™ç©ºé—´ï¼Œå°±ä¾æ¬¡å¾€å…¶ä¸­æ·»åŠ <code>src</code>å­—ç¬¦ä¸²ï¼Œç›´è‡³<code>dst</code>ç¼“å†²åŒºå¡«æ»¡ï¼Œè¿”å›å€¼æ˜¯<code>dst</code>åŸå­—ç¬¦ä¸²é•¿åº¦ä¸<code>src</code>é•¿åº¦ä¹‹å’Œã€‚ç›¸æ¯”è¾ƒstrncatï¼Œ<strong>strlcatçš„ä¼˜ç‚¹æ˜¯</strong>ï¼š</p><ul><li>ç¬¬ä¸‰ä¸ªå‚æ•°å¤§å°ç›´æ¥å¸¦å…¥<code>dst</code>çš„å¤§å°ï¼Œä¸éœ€è¦è®¡ç®—å‰©ä½™ç©ºé—´ï¼›</li><li>è¿”å›å€¼å¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿå­—ç¬¦ä¸²æˆªæ–­ã€‚</li></ul><h2 id="5-å­—ç¬¦ä¸²æŸ¥æ‰¾"><a href="#5-å­—ç¬¦ä¸²æŸ¥æ‰¾" class="headerlink" title="5.å­—ç¬¦ä¸²æŸ¥æ‰¾"></a>5.å­—ç¬¦ä¸²æŸ¥æ‰¾</h2><h3 id="5-1-strstr"><a href="#5-1-strstr" class="headerlink" title="5.1 strstr"></a>5.1 strstr</h3><p>ä½œç”¨ï¼šè¿”å›ä¸€ä¸ªæŒ‡å‘<strong>str1</strong>ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„<strong>str2</strong>çš„æŒ‡é’ˆï¼Œå¦‚æœ<strong>str2</strong> ä¸æ˜¯ <strong>str1</strong>çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ</p><blockquote><p>åŒ¹é…è¿‡ç¨‹ä¸åŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼Œä½†ç¢°åˆ°å®ƒå°±æ­¤åœæ­¢ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] =<span class="hljs-string">&quot;This is a simple string&quot;</span>;  <br>    <span class="hljs-type">char</span>* pch;<br>    pch = <span class="hljs-built_in">strstr</span>(str,<span class="hljs-string">&quot;is&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p&quot;</span>,*pch);  <span class="hljs-comment">// 0X69</span><br>        <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-strtok"><a href="#5-2-strtok" class="headerlink" title="5.2 strtok"></a>5.2 strtok</h3><p>ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºæ ‡è®°</p><p>å¯¹è¯¥å‡½æ•°çš„ä¸€ç³»åˆ—è°ƒç”¨å°†stræ‹†åˆ†ä¸ºæ ‡è®°ï¼Œè¿™äº›æ ‡è®°æ˜¯ç”±åˆ†éš”ç¬¦ä¸­çš„ä»»ä½•å­—ç¬¦åˆ†éš”çš„è¿ç»­å­—ç¬¦åºåˆ—ã€‚</p><h2 id="6-é”™è¯¯ä¿¡æ¯æŠ¥å‘Š"><a href="#6-é”™è¯¯ä¿¡æ¯æŠ¥å‘Š" class="headerlink" title="6.é”™è¯¯ä¿¡æ¯æŠ¥å‘Š"></a>6.é”™è¯¯ä¿¡æ¯æŠ¥å‘Š</h2><h3 id="6-1-strerror"><a href="#6-1-strerror" class="headerlink" title="6.1 strerror"></a>6.1 strerror</h3><p>ä½œç”¨ï¼š<strong>string</strong>è·å–æŒ‡å‘é”™è¯¯æ¶ˆæ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</p><p>é”™è¯¯ç æ˜¯ç¨‹åºå‘˜çŸ¥é“çš„ï¼Œä½†æ˜¯è¦è½¬åŒ–ä¸ºç”¨æˆ·èƒ½çœ‹æ‡‚çš„é”™è¯¯ä¿¡æ¯ï¼Œå°±éœ€è¦ä½¿ç”¨å‡½æ•°å°†å…¶è½¬åŒ–ä¸ºé”™è¯¯ä¿¡æ¯ã€‚</p><p>è§£é‡Š<strong>errnum</strong>çš„å€¼ï¼Œç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ä¸€æ¡æè¿°é”™è¯¯æ¡ä»¶çš„æ¶ˆæ¯ï¼Œå°±å¥½åƒè¢«åº“çš„å‡½æ•°è®¾ç½®ä¸º<strong>errno</strong>ä¸€æ ·ã€‚</p><blockquote><p>errnoåœ¨å¤´æ–‡ä»¶&lt;errno.h&gt;ä¸­</p><p>errnoæ˜¯ä¸€ä¸ªå…¨å±€çš„é”™è¯¯ç å˜é‡</p><p>å½“Cè¯­è¨€çš„åº“å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šæŠŠå¯¹åº”çš„é”™è¯¯ç ï¼Œèµ‹å€¼åˆ°errnoä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    FILE * pFile;<br>    <span class="hljs-comment">//æ‰“å¼€æ–‡ä»¶</span><br>    pFile = fopen (<span class="hljs-string">&quot;unexist.ent&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (pFile == <span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error opening file unexist.ent: %s\n&quot;</span>,strerror(errno));<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Win opening file!&quot;</span>);<br>    &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/4b271827-30e6-493f-a1b7-59db778d01d7.png"><h2 id="7-å­—ç¬¦åˆ†ç±»å‡½æ•°"><a href="#7-å­—ç¬¦åˆ†ç±»å‡½æ•°" class="headerlink" title="7.å­—ç¬¦åˆ†ç±»å‡½æ•°"></a>7.å­—ç¬¦åˆ†ç±»å‡½æ•°</h2><p>å‡½æ•°ä½¿ç”¨éœ€è¦çš„å¤´æ–‡ä»¶<code>#include &lt;ctype.h&gt;</code></p><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/df04e811-541d-4e15-9bfe-3525a4827235.png"><p><strong>å­—ç¬¦è½¬æ¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">tolower</span>(c);<span class="hljs-comment">//è½¬å°å†™å­—æ¯</span><br><span class="hljs-built_in">toupper</span>(c);<span class="hljs-comment">//è½¬å¤§å†™å­—æ¯</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;I Am A Good Student&quot;</span>;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(str[i])&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isupper</span>(str[i]))&#123;<br>            str[i] = <span class="hljs-built_in">tolower</span>(str[i]);<br>        &#125;<br>        i++;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str);  <span class="hljs-comment">// i am a good student</span><br>   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°"><a href="#Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°" class="headerlink" title="Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°"></a>Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°</h1><h2 id="1-Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ"><a href="#1-Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ" class="headerlink" title="1.Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ"></a>1.Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ</h2><h3 id="1-1-å‰è¨€"><a href="#1-1-å‰è¨€" class="headerlink" title="1.1 å‰è¨€"></a>1.1 å‰è¨€</h3><p>Aè¿›ç¨‹æƒ³è¦æŠŠæ•°æ®ä¼ é€’ç»™Bè¿›ç¨‹ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†<strong>IPC</strong>ï¼ˆInter Process Communication è·¨è¿›ç¨‹é€šä¿¡ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230305230100824.png" alt="image-20230305230100824" style="zoom:80%;"><p>ä¾‹å¦‚Aè¿›ç¨‹æƒ³è¦é€šè¿‡<code>led_open</code> æˆ–è€… <code>led_ctl</code> æ‰“å¼€ledï¼Œä½†æ˜¯å½“å‰Aè¿›ç¨‹æ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆä¼šé€šè¿‡RPCè¿›ç¨‹é€šä¿¡ï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230305230747468.png" alt="image-20230305230747468" style="zoom:80%;"><p>ä»è¿™ä¸ªå›¾æ¥çœ‹ï¼Œä»åº•ä¸‹æ¥çœ‹ä»¿ä½›æ˜¯Aè¿›ç¨‹è°ƒç”¨äº†ä¸€ä¸ªæœ¬åœ°çš„æ–¹æ³•led_open&#x2F;led_ctlï¼Œç„¶åæŠŠæ•°æ®å‘ç»™Bï¼Œç”±Bè¿›ç¨‹æ¥æ“ä½œç¡¬ä»¶ï¼ã€æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯RPCã€‘</p><blockquote><p><strong>RPC</strong>:(Reomote Procedure Call è¿œç¨‹è¿‡ç¨‹è°ƒç”¨) ï¼šå®¢æˆ·ç«¯å°†è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•åˆ™æ˜¯è´Ÿè´£é€æ˜çš„ä¸è¿œç¨‹æœåŠ¡ç«¯è¿›è¡Œè¿‡ç¨‹é—´é€šä¿¡ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•ä¼šå°†ç›¸å…³å‚æ•°é¡ºåºæ‰“åŒ…åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªæ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯æä¾›çš„æ–¹æ³•ï¼ŒæœåŠ¡ç«¯çš„æ–¹æ³•ä¼šä»æ¶ˆæ¯ä¸­è§£å‡ºåºåˆ—åŒ–å‘å‡ºæ¥çš„å‚æ•°ï¼Œç„¶åæ‰§è¡Œï¼Œæœ€åä»ä»¥åŒæ ·çš„æ–¹å¼å°†æ–¹æ³•çš„è¿”å›å€¼å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p></blockquote><h3 id="1-2-binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC"><a href="#1-2-binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC" class="headerlink" title="1.2 binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC"></a>1.2 binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC</h3><p>binderç³»ç»Ÿä¸­IPCéœ€è¦å…·å¤‡ä¸‹é¢ä¸‰ä¸ªè¦ç´ ï¼š</p><ul><li><strong>æº</strong>ï¼šåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæºå°±æ˜¯è¿›ç¨‹A</li><li><strong>ç›®çš„</strong>ï¼š1ï¼‰B å‘ servicemanager æ³¨å†ŒledæœåŠ¡ï¼›2ï¼‰A å‘ servicemanager æŸ¥è¯¢ledæœåŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ªhandle</li><li><strong>æ•°æ®</strong>ï¼šå°±æ˜¯ä¸€ä¸ªchar bufï¼Œç”¨æ¥å­˜æ”¾é€šä¿¡çš„æ•°æ®</li></ul><p><strong>å®é™…çš„RPCè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦æ€è€ƒä¸‹é¢çš„é—®é¢˜</strong>ï¼š</p><ol><li>Aè¿›ç¨‹éœ€è¦è°ƒç”¨Bè¿›ç¨‹çš„ä»€ä¹ˆå‡½æ•°</li><li>Aè¿›ç¨‹éœ€è¦ä¼ é€’ä»€ä¹ˆå‚æ•°ç»™Bè¿›ç¨‹</li><li>Aè¿›ç¨‹ä¼šå¾—åˆ°Bè¿›ç¨‹çš„ä»€ä¹ˆè¿”å›å€¼</li></ol><blockquote><p>ç¬¬2æ­¥Aè¿›ç¨‹é€šè¿‡IPCå°†bufä¼ è¾“æ•°æ®ç»™Bï¼›</p><p>ç¬¬3æ­¥åŒæ ·Bè¿›ç¨‹å¤„ç†å®Œä»¥åé€šè¿‡IPCå°†æ•°æ®è¿”å›ç»™A</p></blockquote><h2 id="2-Binderæœºåˆ¶åˆ†æ"><a href="#2-Binderæœºåˆ¶åˆ†æ" class="headerlink" title="2 Binderæœºåˆ¶åˆ†æ"></a>2 Binderæœºåˆ¶åˆ†æ</h2><h3 id="2-1-servicemanagerçš„ä½œç”¨"><a href="#2-1-servicemanagerçš„ä½œç”¨" class="headerlink" title="2.1 servicemanagerçš„ä½œç”¨"></a>2.1 servicemanagerçš„ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/d12a5c80-9140-4483-bbf4-3ac05cd8a5f9.png" style="zoom: 67%;"><p>ä»£ç è·¯å¾„ï¼šframeworks&#x2F;native&#x2F;cmds&#x2F;servicemanager&#x2F;service_manager.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);  <span class="hljs-comment">// æ‰“å¼€binderé©±åŠ¨ã€bsæ˜¯æè¿°binderé©±åŠ¨çš„ç»“æ„ä½“ã€‘</span><br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        ALOGE(<span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å‘Šè¯‰binderé©±åŠ¨æˆ‘å°±æ˜¯servicemanager</span><br>    <span class="hljs-keyword">if</span> (binder_become_context_manager(bs)) &#123;<br>        ALOGE(<span class="hljs-string">&quot;cannot become context manager (%s)\n&quot;</span>, strerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    svcmgr_handle = BINDER_SERVICE_MANAGER;<br>    binder_loop(bs, svcmgr_handler);  <span class="hljs-comment">// å¾ªç¯ç›‘å¬binderé©±åŠ¨ï¼Œå®Œæˆç›¸åº”æœåŠ¡çš„å‡½æ•°è°ƒç”¨</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼šsvcmgr_handleæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_transaction_data *txn,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *msg,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *reply)</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">switch</span>(txn-&gt;code) &#123;<br>    <span class="hljs-keyword">case</span> SVC_MGR_GET_SERVICE:<br>    <span class="hljs-keyword">case</span> SVC_MGR_CHECK_SERVICE:<br>        <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">case</span> SVC_MGR_ADD_SERVICE:<br>        <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">case</span> SVC_MGR_LIST_SERVICES: &#123;<br>       <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    bio_put_uint32(reply, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°svcmgr_handlerå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ã€è¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šæ ¹æ®ä¼ è¿›æ¥çš„txnç»“æ„ä½“ä¸­çš„codeæ¥å†³å®šï¼Œåˆ°åº•æ˜¯å»æ³¨å†ŒæœåŠ¡è¿˜æ˜¯è°ƒç”¨æœåŠ¡ã€‘</p><ul><li>å¦‚æœæ˜¯<code>SVC_MGR_ADD_SERVICE</code>ï¼Œå°±æ˜¯æ³¨å†ŒæœåŠ¡</li><li>å¦‚æœæ˜¯<code>SVC_MGR_CHECK_SERVICE</code>ï¼Œå°±æ˜¯æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨</li><li>å¦‚æœæ˜¯<code>SVC_MGR_GET_SERVICE</code>ï¼Œå°±æ˜¯è·å–æœåŠ¡</li></ul><blockquote><p>è¿™é‡Œæ­£å¥½å¯¹åº”ä¸Šäº†å¼€å¤´æ€ç»´å¯¼å›¾ä¸Šçš„æœ€åä¸€é¡¹servicemanagerçš„ä½œç”¨</p></blockquote><h3 id="1-3-2-serverç«¯ä½œç”¨"><a href="#1-3-2-serverç«¯ä½œç”¨" class="headerlink" title="1.3.2 serverç«¯ä½œç”¨"></a>1.3.2 serverç«¯ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1a4196fb-da3b-4125-99f4-a1a9516218fd.png" style="zoom: 50%;"><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ³¨å†ŒæœåŠ¡çš„æµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_publish</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br>    bio_put_obj(&amp;msg, ptr);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    status = bio_get_uint32(&amp;reply);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡æ—¶ä¼šè°ƒç”¨<code>svcmgr_publish</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢æœ€ä¸»è¦çš„æ˜¯å»è°ƒç”¨<code>binder_call</code>å‡½æ•°</p><p><strong>binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE)</strong></p><ul><li>bsï¼šæè¿°binderé©±åŠ¨çš„ç»“æ„ä½“</li><li>msgï¼šè¡¨ç¤ºè¦æ³¨å†ŒæœåŠ¡çš„ç›¸å…³ä¿¡æ¯çš„binder_ioç»“æ„ä½“</li><li>replyï¼šè¡¨ç¤ºservicemanagerå›å¤çš„æ•°æ®</li><li>targetï¼šæ³¨å†Œæ—¶targetä¼ çš„æ˜¯BINDER_SERVICE_MANAGERï¼Œè¯¥å€¼è¡¨ç¤ºçš„å°±æ˜¯servicemanager</li><li>SVC_MGR_ADD_SERVICEï¼šè¡¨ç¤ºè°ƒç”¨ç›®æ ‡çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„CODEå€¼ä¸ºSVC_MGR_ADD_SERVICEã€åœ¨æ³¨å†Œæ—¶ç›¸å½“äºè°ƒç”¨servicemanagerçš„addserviceæœåŠ¡ã€‘</li></ul><h3 id="1-3-3-clientç«¯ä½œç”¨"><a href="#1-3-3-clientç«¯ä½œç”¨" class="headerlink" title="1.3.3 clientç«¯ä½œç”¨"></a>1.3.3 clientç«¯ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/f955b7ac-25ac-4cd8-82b1-af135a447d3b.png" style="zoom: 50%;"><p>clientç«¯é¦–å…ˆä¼šå»è·å–æœåŠ¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">svcmgr_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_CHECK_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    handle = bio_get_ref(&amp;reply);<br><br>    <span class="hljs-keyword">if</span> (handle)<br>        binder_acquire(bs, handle);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> handle;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ ·ä¹Ÿä¼šå»è°ƒç”¨binder_callå‡½æ•°</p><p><strong>binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE)</strong></p><ul><li>bsï¼šæè¿°binderé©±åŠ¨çš„ç»“æ„ä½“</li><li>msgï¼šè¡¨ç¤ºå³å°†æŸ¥è¯¢æœåŠ¡çš„ç›¸å…³ä¿¡æ¯çš„binder_ioç»“æ„ä½“</li><li>replyï¼šè¡¨ç¤ºservicemanagerå›å¤çš„æ•°æ®ï¼Œæ•°æ®é‡Œé¢ä¼šåŒ…å«åˆšåˆšæƒ³è¦æŸ¥è¯¢æœåŠ¡çš„è¿›ç¨‹</li><li>targetï¼šæ³¨å†Œæ—¶targetä¼ çš„æ˜¯BINDER_SERVICE_MANAGERï¼Œè¯¥å€¼è¡¨ç¤ºçš„å°±æ˜¯servicemanager</li><li>SVC_MGR_CHECK_SERVICEï¼šè¡¨ç¤ºè°ƒç”¨ç›®æ ‡çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„CODEå€¼ä¸ºSVC_MGR_CHECK_SERVICEã€åœ¨æ³¨å†Œæ—¶ç›¸å½“äºè°ƒç”¨servicemanagerçš„getserviceæœåŠ¡ã€‘</li></ul><h3 id="1-3-4-ç†è§£binder-callå‡½æ•°"><a href="#1-3-4-ç†è§£binder-callå‡½æ•°" class="headerlink" title="1.3.4 ç†è§£binder_callå‡½æ•°"></a>1.3.4 ç†è§£binder_callå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">binder_call</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                <span class="hljs-keyword">struct</span> binder_io *msg, <span class="hljs-keyword">struct</span> binder_io *reply,</span><br><span class="hljs-params">                <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">uint32_t</span> code)</span><br>&#123;<br>    <span class="hljs-type">int</span> res;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_write_read</span> <span class="hljs-title">bwr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">uint32_t</span> cmd;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_transaction_data</span> <span class="hljs-title">txn</span>;</span><br>    &#125; __attribute__((packed)) writebuf;<br>    <span class="hljs-type">unsigned</span> readbuf[<span class="hljs-number">32</span>];<br><br>    <span class="hljs-keyword">if</span> (msg-&gt;flags &amp; BIO_F_OVERFLOW) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;binder: txn buffer overflow\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> fail;<br>    &#125;<br><br>    writebuf.cmd = BC_TRANSACTION;<br>    writebuf.txn.target.handle = target;<br>    writebuf.txn.code = code;<br>    writebuf.txn.flags = <span class="hljs-number">0</span>;<br>    writebuf.txn.data_size = msg-&gt;data - msg-&gt;data0;<br>    writebuf.txn.offsets_size = ((<span class="hljs-type">char</span>*) msg-&gt;offs) - ((<span class="hljs-type">char</span>*) msg-&gt;offs0);<br>    writebuf.txn.data.ptr.buffer = (<span class="hljs-type">uintptr_t</span>)msg-&gt;data0;<br>    writebuf.txn.data.ptr.offsets = (<span class="hljs-type">uintptr_t</span>)msg-&gt;offs0;<br><br>    bwr.write_size = <span class="hljs-keyword">sizeof</span>(writebuf);<br>    bwr.write_consumed = <span class="hljs-number">0</span>;<br>    bwr.write_buffer = (<span class="hljs-type">uintptr_t</span>) &amp;writebuf;<br><br>    hexdump(msg-&gt;data0, msg-&gt;data - msg-&gt;data0);<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        bwr.read_size = <span class="hljs-keyword">sizeof</span>(readbuf);<br>        bwr.read_consumed = <span class="hljs-number">0</span>;<br>        bwr.read_buffer = (<span class="hljs-type">uintptr_t</span>) readbuf;<br><br>        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);<br><br>        <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;binder: ioctl failed (%s)\n&quot;</span>, strerror(errno));<br>            <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br><br>        res = binder_parse(bs, reply, (<span class="hljs-type">uintptr_t</span>) readbuf, bwr.read_consumed, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> fail;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>binder_callå°±æ˜¯rpcä¸­çš„è¿œç¨‹è°ƒç”¨å‡½æ•°</strong></p><p>åœ¨æ³¨å†ŒæœåŠ¡ï¼Œè·å–æœåŠ¡ï¼Œè°ƒç”¨æœåŠ¡ä¸­çš„æ¥å£å‡½æ•°éƒ½æ˜¯ä½¿ç”¨äº†binder_callå‡½æ•°ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹binder_callå‡½æ•°å…·ä½“åœ¨å¹²å˜›ï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3bdaac93-c274-45df-b04b-2a106eb4a42c.png" style="zoom: 67%;"><p><strong>binder_callå†…éƒ¨å®ç°ï¼š</strong></p><ol><li>æ„é€ å‚æ•°msgï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªbinder_ioç±»å‹çš„æ•°æ®</li><li>å°†binder_ioæ•°æ®è½¬åŒ–ä¸º<code>binder_write_read</code>ç±»å‹çš„æ•°æ®ï¼Œå› ä¸ºbinderé©±åŠ¨çš„ioctlä¸­ä¼ é€’çš„æ˜¯<code>binder_write_read</code>ç±»å‹çš„æ•°æ®</li></ol><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9b6e2287-0653-4646-8533-7cf9bdaf8b79.png" style="zoom: 67%;"><ol start="3"><li>å®¢æˆ·ç«¯ä¼šè°ƒç”¨ioctlå‘é€æ•°æ®</li></ol><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4f6deea3-edd7-44e5-9d8a-01d697da89d2.png" style="zoom: 67%;"><ol start="4"><li>æœåŠ¡ç«¯ä¼šè°ƒç”¨ioctlæ¥æ”¶æ•°æ®</li></ol><h2 id="3-Cç¨‹åºå®ç°HelloæœåŠ¡"><a href="#3-Cç¨‹åºå®ç°HelloæœåŠ¡" class="headerlink" title="3.Cç¨‹åºå®ç°HelloæœåŠ¡"></a>3.Cç¨‹åºå®ç°HelloæœåŠ¡</h2><h3 id="3-1-serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯"><a href="#3-1-serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯" class="headerlink" title="3.1 serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯"></a>3.1 serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯</h3><p><strong>clientç«¯ï¼š</strong></p><ul><li>æ‰“å¼€é©±åŠ¨ï¼Œbinder_open</li><li>è·å–æœåŠ¡çš„handleã€æœåŠ¡ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œå°±æ˜¯è·å¾—æœåŠ¡å¯¹åº”è¿›ç¨‹çš„handleã€‘</li><li>æ„é€ å‚æ•°binder_io</li><li>è°ƒç”¨å‡½æ•°binder_callè¿›è¡Œè¿œç¨‹æœåŠ¡è®¿é—®</li><li>è¿”å›binder_ioï¼Œå–å‡ºè¿”å›å€¼</li><li>é‡Šæ”¾è·å¾—çš„handle</li></ul><p><strong>serverç«¯ï¼š</strong></p><ul><li>æ‰“å¼€é©±åŠ¨ï¼Œbinder_open</li><li>è°ƒç”¨svcmgr_publishæ³¨å†ŒæœåŠ¡</li><li>ioctlå»è¯»å–binderé©±åŠ¨çš„æ•°æ®</li><li>è§£ææ•°æ®ï¼Œå°†binder_write_readç±»å‹çš„æ•°æ®è½¬æ¢ä¸ºbinder_ioç±»å‹çš„æ•°æ®</li><li>æ ¹æ®è§£æå‡ºçš„æ•°æ®ä¸­çš„CODEå€¼ï¼Œå»è°ƒç”¨å½“å‰æœåŠ¡çš„å¯¹åº”å‡½æ•°</li><li>æŠŠè¿”å›å€¼è½¬æ¢ä¸ºbinder_io</li></ul><h3 id="3-2-helloæœåŠ¡çš„serverç«¯"><a href="#3-2-helloæœåŠ¡çš„serverç«¯" class="headerlink" title="3.2 helloæœåŠ¡çš„serverç«¯"></a>3.2 helloæœåŠ¡çš„serverç«¯</h3><ul><li>test_server.h</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å®šä¹‰helloæœåŠ¡çš„CODEç¼–ç ï¼Œæ¥è¡¨ç¤ºå½“å‰åº”è¯¥è°ƒç”¨æœåŠ¡çš„å“ªä¸€ä¸ªå‡½æ•°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _TEST_SERVER_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _TEST_SERVER_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HELLO_SVR_CMD_SAYHELLO     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HELLO_SVR_CMD_SAYHELLO_TO  2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GOODBYE_SVR_CMD_SAYGOODBYE     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GOODBYE_SVR_CMD_SAYGOODBYE_TO  2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// _TEST_SERVER_H</span></span><br></code></pre></td></tr></table></figure><ul><li>test_server.c</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/* Copyright 2008 The Android Open Source Project</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;private/android_filesystem_config.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;binder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test_server.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_publish</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br>    bio_put_obj(&amp;msg, ptr);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    status = bio_get_uint32(&amp;reply);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sayhello</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;say hello : %d\n&quot;</span>, ++cnt);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sayhello_to</span><span class="hljs-params">(<span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;say hello to %s : %d\n&quot;</span>, name, ++cnt);<br>    <span class="hljs-keyword">return</span> cnt;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">hello_service_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_transaction_data *txn,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *msg,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *reply)</span><br>&#123;<br>    <span class="hljs-comment">/* æ ¹æ®txn-&gt;codeçŸ¥é“è¦è°ƒç”¨å“ªä¸€ä¸ªå‡½æ•°</span><br><span class="hljs-comment">     * å¦‚æœéœ€è¦å‚æ•°, å¯ä»¥ä»msgå–å‡º</span><br><span class="hljs-comment">     * å¦‚æœè¦è¿”å›ç»“æœ, å¯ä»¥æŠŠç»“æœæ”¾å…¥reply</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/* sayhello</span><br><span class="hljs-comment">     * sayhello_to</span><br><span class="hljs-comment">     */</span><br>    <br>    <span class="hljs-type">uint16_t</span> *s;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">size_t</span> len;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">uint32_t</span> strict_policy;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span><br>    <span class="hljs-comment">// header with the strict mode policy mask and the interface name.</span><br>    <span class="hljs-comment">// Note that we ignore the strict_policy and don&#x27;t propagate it</span><br>    <span class="hljs-comment">// further (since we do no outbound RPCs anyway).</span><br>    strict_policy = bio_get_uint32(msg);<br><br>    <span class="hljs-keyword">switch</span>(txn-&gt;code) &#123;<br>    <span class="hljs-keyword">case</span> HELLO_SVR_CMD_SAYHELLO:<br>        sayhello();<br>        bio_put_uint32(reply, <span class="hljs-number">0</span>); <span class="hljs-comment">/* no exception */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">case</span> HELLO_SVR_CMD_SAYHELLO_TO:<br>        <span class="hljs-comment">/* ä»msgé‡Œå–å‡ºå­—ç¬¦ä¸² */</span><br>        s = bio_get_string16(msg, &amp;len);  <span class="hljs-comment">//&quot;IHelloService&quot;</span><br>        s = bio_get_string16(msg, &amp;len);  <span class="hljs-comment">// name</span><br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>            name[i] = s[i];<br>        name[i] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>        <span class="hljs-comment">/* å¤„ç† */</span><br>        i = sayhello_to(name);<br><br>        <span class="hljs-comment">/* æŠŠç»“æœæ”¾å…¥reply */</span><br>        bio_put_uint32(reply, <span class="hljs-number">0</span>); <span class="hljs-comment">/* no exception */</span><br>        bio_put_uint32(reply, i);<br>        <br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;unknown code %d\n&quot;</span>, txn-&gt;code);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br>    <span class="hljs-type">uint32_t</span> svcmgr = BINDER_SERVICE_MANAGER;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">int</span> ret;<br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* add service */</span><br>    ret = svcmgr_publish(bs, svcmgr, <span class="hljs-string">&quot;hello&quot;</span>, hello_service_handler);<br>    <span class="hljs-keyword">if</span> (ret) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to publish hello service\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">/* read data */</span><br>        <span class="hljs-comment">/* parse data, and process */</span><br>        <span class="hljs-comment">/* reply */</span><br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    binder_set_maxthreads(bs, <span class="hljs-number">10</span>);<br><br>    binder_loop(bs, hello_service_handler);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-helloæœåŠ¡çš„clientç«¯"><a href="#3-3-helloæœåŠ¡çš„clientç«¯" class="headerlink" title="3.3 helloæœåŠ¡çš„clientç«¯"></a>3.3 helloæœåŠ¡çš„clientç«¯</h3><ul><li>test_client.c</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs c">&lt;&gt;<span class="hljs-comment">/* Copyright 2008 The Android Open Source Project</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;private/android_filesystem_config.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;binder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test_server.h&quot;</span></span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">svcmgr_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_CHECK_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    handle = bio_get_ref(&amp;reply);<br><br>    <span class="hljs-keyword">if</span> (handle)<br>        binder_acquire(bs, handle);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> handle;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">g_bs</span>;</span><br><span class="hljs-type">uint32_t</span> g_hello_handle;<br><span class="hljs-type">uint32_t</span> g_goodbye_handle;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sayhello</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    <span class="hljs-comment">/* æ„é€ binder_io */</span><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, <span class="hljs-string">&quot;IHelloService&quot;</span>);<br><br>    <span class="hljs-comment">/* æ”¾å…¥å‚æ•° */</span><br><br>    <span class="hljs-comment">/* è°ƒç”¨binder_call */</span><br>    <span class="hljs-keyword">if</span> (binder_call(g_bs, &amp;msg, &amp;reply, g_hello_handle, HELLO_SVR_CMD_SAYHELLO))<br>        <span class="hljs-keyword">return</span> ;<br>    <br>    <span class="hljs-comment">/* ä»replyä¸­è§£æå‡ºè¿”å›å€¼ */</span><br><br>    binder_done(g_bs, &amp;msg, &amp;reply);<br>    <br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sayhello_to</span><span class="hljs-params">(<span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">int</span> exception;<br><br>    <span class="hljs-comment">/* æ„é€ binder_io */</span><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, <span class="hljs-string">&quot;IHelloService&quot;</span>);<br><br>    <span class="hljs-comment">/* æ”¾å…¥å‚æ•° */</span><br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-comment">/* è°ƒç”¨binder_call */</span><br>    <span class="hljs-keyword">if</span> (binder_call(g_bs, &amp;msg, &amp;reply, g_hello_handle, HELLO_SVR_CMD_SAYHELLO_TO))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">/* ä»replyä¸­è§£æå‡ºè¿”å›å€¼ */</span><br>    exception = bio_get_uint32(&amp;reply);<br>    <span class="hljs-keyword">if</span> (exception)<br>        ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">else</span><br>        ret = bio_get_uint32(&amp;reply);<br><br>    binder_done(g_bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> ret;<br>    <br>&#125;<br><br><br><span class="hljs-comment">/* ./test_client hello</span><br><span class="hljs-comment"> * ./test_client hello &lt;name&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br>    <span class="hljs-type">uint32_t</span> svcmgr = BINDER_SERVICE_MANAGER;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage:\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s &lt;hello&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s &lt;hello&gt; &lt;name&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    g_bs = bs;<br><br>    <span class="hljs-comment">/* get service */</span><br>    handle = svcmgr_lookup(bs, svcmgr, <span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!handle) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to get hello service\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    g_hello_handle = handle;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Handle for hello service = %d\n&quot;</span>, g_hello_handle);<br><br>    <span class="hljs-comment">/* send data to server */</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;hello&quot;</span>))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">2</span>) &#123;<br>            sayhello();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">3</span>) &#123;<br>            ret = sayhello_to(argv[<span class="hljs-number">2</span>]);<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;get ret of sayhello_to = %d\n&quot;</span>, ret);      <br>        &#125;<br>    &#125;<br><br>    binder_release(bs, handle);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3f3601eb-c63d-46bb-9692-1dfdc4d24690.png"><h3 id="3-4-æ€»ç»“"><a href="#3-4-æ€»ç»“" class="headerlink" title="3.4 æ€»ç»“"></a>3.4 æ€»ç»“</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/b20537c9-9aff-4da7-84ae-dd1dbcb30baf.png">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Android 8.1ä»é›¶å¼€å§‹å†™HAL</title>
    <link href="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/"/>
    <url>/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-8-1ä»é›¶å¼€å§‹å†™HAL"><a href="#Android-8-1ä»é›¶å¼€å§‹å†™HAL" class="headerlink" title="Android 8.1ä»é›¶å¼€å§‹å†™HAL"></a>Android 8.1ä»é›¶å¼€å§‹å†™HAL</h1><blockquote><p>ğŸ›ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒQidi_Huangã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>ğŸœåŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/Qidi_Huang/article/details/107426961">https://blog.csdn.net/Qidi_Huang/article/details/107426961</a></p></blockquote><h2 id="1-å®šä¹‰æ¥å£"><a href="#1-å®šä¹‰æ¥å£" class="headerlink" title="1.å®šä¹‰æ¥å£"></a>1.å®šä¹‰æ¥å£</h2><p>ã€å‰è¨€ã€‘<br>æˆ‘ä»¬éƒ½çŸ¥é“ä» <code>Android 8.0</code> å¼€å§‹ï¼Œ Google å¯åŠ¨äº† <code>Treble é¡¹ç›®</code>ï¼Œè‡ªæ­¤å¼€å§‹æ¨è¡Œ Binder åŒ–çš„ HAL å®ç°ã€‚é™¤å°‘æ•°ç±»å‹ HAL å¤–ï¼Œåœ¨ Android 9.0 åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ï¼ŒGoogle ç”šè‡³è¦æ±‚å¤§éƒ¨åˆ†<strong>å¤–è®¾</strong>(peripherals) å¿…é¡»æ”¯æŒä½¿ç”¨ Binder åŒ–çš„ HALï¼Œå¦åˆ™éƒ½ä¸å†è§†ä¸ºåˆè§„ã€‚å› æ­¤ï¼Œæœ¬æ–‡ä¸­çš„ HAL æŒ‡çš„æ˜¯ç”¨ HIDL è¯­è¨€æè¿°ã€ä½¿ç”¨ Binder æ–¹å¼å®ç°çš„ HALã€‚</p><p>åœ¨é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« å‰ï¼Œå¦‚æœä½ å·²ç»å¤§è‡´äº†è§£ <code>Android SELinux</code> æ¦‚å¿µï¼ˆæ¯”å¦‚ <code>*.te</code> æ–‡ä»¶å’Œ <code>file_contexts</code>ï¼‰ï¼Œä»¥åŠ Binder çš„åŸºæœ¬è°ƒç”¨æ–¹æ³•ï¼ˆæ¯”å¦‚çŸ¥é“åºåˆ—åŒ–çš„æ¦‚å¿µã€ transact()&#x2F;onTransact()çš„è°ƒç”¨æ—¶æœºï¼‰ï¼Œå¯¹äºç†è§£æœ¬æ–‡çš„å†…å®¹ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p><p>æ ¹æ®é¡¹ç›®ä¸åŒï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè®¸å¸Œæœ›åœ¨è®¾å¤‡ä¸Šä½¿ç”¨ä¸€ç§æ–°çš„å¤–è®¾ï¼Œæ¯”å¦‚æŸç§ä¼ æ„Ÿå™¨ï¼›æˆ–è€…æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ Android native å±‚è¿è¡Œä¸€ä¸ªç‰¹å®šè¿›ç¨‹ï¼Œç”¨æ¥è¾…åŠ©å¤„ç†æ¥è‡ª Android Frameworks çš„æ•°æ®ï¼Œæˆ–è€…ç”¨äºå’Œå…¶å®ƒ native å±‚çš„è¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚å¯¹äºå‰ä¸€ç§åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå¤–è®¾ç¼–å†™å…¨æ–°çš„ HALï¼›å¯¹äºåä¸€ç§åœºæ™¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç¼–å†™ HALï¼Œä½†éœ€è¦å®ç°ä¸€ä¸ªå¾ˆç±»ä¼¼çš„ vendor serviceã€‚è¿™äºŒè€…çš„å®ç°æ–¹å¼æå…¶ç±»ä¼¼ï¼ŒåŒºåˆ«åªåœ¨äºä»–ä»¬ä½¿ç”¨çš„è®¾å¤‡èŠ‚ç‚¹ä¸åŒï¼ˆä¸€ä¸ªä½¿ç”¨<code>/dev/hwbinder</code>ï¼Œå¦ä¸€ä¸ªä½¿ç”¨ <code>/dev/vndbinder</code>ï¼‰ï¼Œè¿˜æœ‰å„è‡ªç”³è¯·çš„ sepolicy æƒé™æœ‰åˆ«ã€‚</p><p>ä»¥ä¸‹æ­£æ–‡ä»¥å®ç°ä¸€ä¸ªå…¨æ–°çš„ HAL ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œä½†å¹¶ä¸æ¶‰åŠå¯¹è®¾å¤‡èŠ‚ç‚¹çš„æ“ä½œã€‚</p><h3 id="1-1-æ˜ç¡®HALæ¥å£"><a href="#1-1-æ˜ç¡®HALæ¥å£" class="headerlink" title="1.1 æ˜ç¡®HALæ¥å£"></a>1.1 æ˜ç¡®HALæ¥å£</h3><p>Android å¤§é‡é‡‡ç”¨é¢å‘æ¥å£ç¼–ç¨‹çš„ç†å¿µï¼ŒHAL ä¹Ÿä¸ä¾‹å¤–ã€‚å¸¸ç”¨çš„ HAL æ¨¡å—æ¥å£å·²ç»ç”± Google å’Œä¸šç•Œå……åˆ†è®¨è®ºå¹¶é¢„å®šä¹‰ï¼Œæ¯”å¦‚ Audio å’Œ Cameraï¼Œè¿™äº›æ¨¡å—éœ€è¦æ”¯æŒçš„åŠŸèƒ½ä¹Ÿå·²ç»æ˜ç¡®ï¼Œå…¶æ¥å£æè¿°å¯ä»¥åœ¨ <code>/hardware/interfaces/</code> ç›®å½•ä¸‹æ‰¾åˆ°ã€‚</p><p>åŒç†ï¼Œæˆ‘ä»¬å®ç°è‡ªå·±çš„ HAL æ—¶ï¼Œä¹Ÿåº”è¯¥å…ˆæ˜ç¡®æ–° HAL è¦æ”¯æŒçš„åŠŸèƒ½ï¼Œå†æ ¹æ®éœ€æ±‚éœ€è¦è®¾è®¡è¦æš´éœ²ç»™ç»™å…¶å®ƒè¿›ç¨‹çš„æ¥å£ã€‚</p><p><strong>ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸ä»¥çœŸå®çš„å¤–è®¾ HAL æ¥æè¿°ï¼Œè€Œæ˜¯åšä¸€ç³»åˆ—å‡è®¾ï¼Œè‡ªå·±ç»™è‡ªå·±è®¾è®¡éœ€æ±‚ã€‚è™½ç„¶è¿™æ ·çš„ HAL ä¸å¯¹åº”å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼Œä½†é“ç†æ˜¯ç›¸é€šçš„ï¼Œå®Œå…¨å¯ä»¥ç…§çŒ«ç”»è™ã€ä¸¾ä¸€åä¸‰ã€‚</strong></p><p>æˆ‘ä»¬å‡è®¾æ–° HAL éœ€è¦æ”¯æŒ 3 ä¸ªåŠŸèƒ½ï¼š</p><ul><li>å…è®¸å…¶å®ƒè¿›ç¨‹ä¸»åŠ¨è®¾ç½®çŠ¶æ€</li><li>å…è®¸å…¶å®ƒè¿›ç¨‹æ³¨å†Œå›è°ƒå‡½æ•°</li><li>å…è®¸å…¶å®ƒè¿›ç¨‹æ³¨é”€å›è°ƒå‡½æ•°</li></ul><p>ç»™ <strong>æ–°å¤–è®¾</strong>å–åä¸º <code>demoComponent</code>ï¼Œç»™<strong>æ–° HAL çš„è¿›ç¨‹</strong>å–åä¸º <code>demoService</code>ã€‚ç»™æ”¯æŒä¸Šè¿° 3 é¡¹åŠŸèƒ½çš„æ¥å£åˆ†åˆ«å–åä¸º <code>setStatus() </code>ã€ <code>registerCallback()</code> å’Œ <code>unregisterCallback()</code>ã€‚å‡è®¾å…¶å®ƒè¿›ç¨‹æ‰€è®¾ç½®çš„â€œçŠ¶æ€â€æ˜¯ä¸€ä¸ª <code>DemoData</code> ç»“æ„ä½“ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-built_in">string</span>  name;<br>    <span class="hljs-type">int</span>     value;<br>&#125; DemoData;<br></code></pre></td></tr></table></figure><p>å‡è®¾å›è°ƒå‡½æ•°æ–¹æ³•ä¸º <code>onCallbackEvent()</code>ï¼Œ å‚æ•°åŒæ ·ä¸º <code>DemoData</code> ç»“æ„ã€‚</p><h3 id="1-2-ç¼–å†™æ¥å£æè¿°æ–‡ä»¶"><a href="#1-2-ç¼–å†™æ¥å£æè¿°æ–‡ä»¶" class="headerlink" title="1.2 ç¼–å†™æ¥å£æè¿°æ–‡ä»¶"></a>1.2 ç¼–å†™æ¥å£æè¿°æ–‡ä»¶</h3><p>é€šå¸¸ï¼Œç»è¿‡å‰è¿°æ­¥éª¤æ˜ç¡®æ¥å£ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºå®Œæ•´çš„å¤´æ–‡ä»¶æ¥äº†ï¼Œç»§è€Œå¯¹åº”å®ç°å„æ¥å£ã€‚ä½†æ˜¯åœ¨ HAL å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å†™çš„ä¸æ˜¯å¤´æ–‡ä»¶ï¼Œè€Œæ˜¯åˆ›ä½œå‡ºç”¨ HIDL è¯­è¨€ç¼–å†™çš„ <code>*.hal</code> æ¥å£æè¿°æ–‡ä»¶ã€‚ï¼ˆ<strong>ä¸è¿‡ï¼Œåœ¨ Android R ä¸Šå°†æ”¯æŒç”¨ AIDL è¯­è¨€æ¥ç¼–å†™æ¥å£æè¿°æ–‡ä»¶ï¼Œä»¥åå¯èƒ½é€æ­¥åºŸå¼ƒ HIDL è¯­è¨€</strong>ï¼‰</p><p>æŒ‰ç…§ç›®å‰çš„å¼€å‘è§„èŒƒï¼Œæˆ‘ä»¬çš„è‡ªå®šä¹‰æ¥å£æè¿°æ–‡ä»¶é€šå¸¸æ”¾åœ¨ <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/&lt;ComponentName&gt;/&lt;SubComponentName&gt;/&lt;VersionCode&gt;/</code> ç›®å½•ä¸‹ã€‚ æ ¹æ®æˆ‘ä»¬å‰æ–‡çš„å‡è®¾ï¼Œè¿™é‡Œçš„<code>&lt;ComponentName&gt;</code>å°±æ˜¯ demoComponentã€‚<code>&lt;SubComponentName&gt;</code> å¯æœ‰å¯æ— ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å¯¹åº”çš„æ˜¯ demoServiceã€‚VersionCode è¡¨ç¤º HAL æ¥å£çš„ç‰ˆæœ¬å·ï¼Œå› ä¸ºæˆ‘ä»¬ç¼–å†™çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„ HALï¼Œæ‰€ä»¥ç‰ˆæœ¬å·æ˜¯ 1.0ã€‚</p><p>å› ä¸ºæˆ‘ä»¬çš„å®ç°æ¶‰åŠ <strong>HAL è¿›ç¨‹ã€å›è°ƒå‡½æ•°ã€å‚æ•°æ•°æ®</strong> 3 ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥å¯¹åº”çš„ hal æ–‡ä»¶ä¹Ÿæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><strong>IDemoServiceDef.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br>import IDemoCallback;<br><br>interface IDemoServiceDef &#123;<br><br>    setStatus(DemoData data) generates (<span class="hljs-type">int32_t</span> status);<br>    registerCallback(IDemoCallback cb) generates (<span class="hljs-type">int32_t</span> status);<br>    unregisterCallback(IDemoCallback cb) generates (<span class="hljs-type">int32_t</span> status);<br>&#125;;<br><br></code></pre></td></tr></table></figure><ul><li><strong>IDemoCallback.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br>interface IDemoCallback &#123;<br><br>   onCallbackEvent(DemoData payload) generates (<span class="hljs-type">int32_t</span> status);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong>types.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DemoData</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-built_in">string</span>  name;<br>    <span class="hljs-type">int32_t</span> value;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰å››ä¸ªåŸºæœ¬ç‚¹éœ€è¦æ³¨æ„ã€‚</p><ol><li><p><strong>æ•°æ®ç±»å‹æè¿°æ–‡ä»¶çš„æ–‡ä»¶åæ˜¯ä¸ªå›ºå®šåç§°</strong> <code>types.hal</code>ï¼›æ¥å£æè¿°æ–‡ä»¶çš„æ–‡ä»¶åè¦ä»¥<strong>å¤§å†™å­—æ¯ I</strong> å¼€å¤´å†™ä½œ <code>IXxxx.hal</code>ï¼Œå¹¶ä¸”ç›¸åº”åœ°ä»¥<code>interface IXxxx &#123;&#125; </code>è¿›è¡Œæè¿°ï¼›<strong>generates</strong> ååŠ æ•°æ®ç±»å‹è¡¨ç¤ºæ¥å£çš„è¿”å›å€¼ç±»å‹ã€‚</p></li><li><p>æ¯ä¸ª<code> *.hal</code> æ–‡ä»¶éƒ½éœ€è¦åœ¨æ–‡ä»¶å¤´å£°æ˜å®ƒæ‰€å±çš„åŒ…ã€‚è¿™é‡Œçš„åŒ…åä¸º<code> package vendor.harman.hardware.demoComponent.demoService@1.0;</code>ã€‚</p></li><li><p>HIDL è¯­è¨€æ‰€ä½¿ç”¨çš„æ•°æ®ç±»å‹å’Œ C&#x2F;C++&#x2F;Java çš„æ•°æ®ç±»å‹ç¨æœ‰åŒºåˆ«ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå¯¹æ¯” DemoData ç»“æ„ä½“çš„åŸå§‹å†™æ³•ä¸ HIDL å†™æ³•ï¼Œå¯ä»¥çœ‹åˆ° int32 è¢«æ›¿æ¢æˆäº† int32_tã€‚ å†æ¯”å¦‚è¯´ï¼ŒHIDL æ•°æ®ç±»å‹ä¹Ÿä¸æ”¯æŒ C&#x2F;C++ çš„åŸå§‹æŒ‡é’ˆã€‚å…³äº HIDL æ•°æ®ç±»å‹çš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒã€ŠHIDL æ•°æ®ç±»å‹ã€‹ã€‚</p></li><li><p>å¦å¤–ï¼Œ<code>*.hal</code> æ–‡ä»¶ä¹‹é—´ç›¸äº’å¼•ç”¨æ—¶ï¼Œä½¿ç”¨ <code>import</code> å…³é”®å­—è¿›è¡Œå£°æ˜ã€‚</p></li></ol><p>è¿™äº›å›ºå®šå½¢å¼æ˜¯ç”± HIDL æ¡†æ¶å†³å®šçš„ï¼Œæˆ‘ä»¬å¿…é¡»éµä»ã€‚</p><p>ç¼–å†™å®Œæˆåç”¨ <code>ls</code> å‘½ä»¤æŸ¥çœ‹ï¼Œå°±æ˜¯ä¸‹å›¾ä¸­ 3 ä¸ªç»¿è‰²æ–‡ä»¶çš„æ ·å­ï¼ˆ<code>Android.*</code> æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œ1.3èŠ‚å°±è¦è®²åˆ°ã€‚<code>default/</code> çš„å«ä¹‰å’Œä½œç”¨ç•™å¾…ç¬¬2ç« è¿›è¡Œä»‹ç»ï¼‰ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200717231917282.png"><h3 id="1-3-ç”Ÿæˆ-Makefile"><a href="#1-3-ç”Ÿæˆ-Makefile" class="headerlink" title="1.3 ç”Ÿæˆ Makefile"></a>1.3 ç”Ÿæˆ Makefile</h3><p>ç¼–å†™å¥½æ¥å£æè¿°æ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œè„šæœ¬ <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/update-makefiles.sh</code> ä¸ºæ¥å£æè¿°æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ 2 ä¸ª Makefile â€”â€” <code>Android.bp</code> å’Œ <code>Android.mk</code>ã€‚</p><p>æœ‰äº†è¿™ 2 ä¸ª Makefileï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥è‡ªåŠ¨ä»æ¥å£æè¿°æ–‡ä»¶ç”Ÿæˆ Binder æ¡†æ¶çš„æºæ–‡ä»¶ã€å¤´æ–‡ä»¶ä»¥å’Œå¯¹åº”çš„åº“ï¼Œè€Œæ— éœ€æˆ‘ä»¬æ‰‹åŠ¨æ•²ä¸€éï¼Œååˆ†æ–¹ä¾¿ã€‚</p><h2 id="2-å®ç°-HAL-ä¸»ä½“"><a href="#2-å®ç°-HAL-ä¸»ä½“" class="headerlink" title="2.å®ç° HAL ä¸»ä½“"></a>2.å®ç° HAL ä¸»ä½“</h2><h3 id="2-1-é…ç½®HAL"><a href="#2-1-é…ç½®HAL" class="headerlink" title="2.1 é…ç½®HAL"></a>2.1 é…ç½®HAL</h3><p>å› ä¸ºä¸åŒçš„äº§å“å¯èƒ½ä½¿ç”¨ä¸åŒçš„å¤–è®¾ï¼Œæ‰€ä»¥æ¯ä¸ªäº§å“éƒ½æœ‰è‡ªå·±çš„èµ„æºæ¸…å• <code>manifest.xml</code>ï¼Œä½äºç›®å½• <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/</code> ä¸‹ã€‚æ¸…å•ä¸­ä¼šåˆ—å‡ºè¯¥æ¬¾äº§å“æ”¯æŒçš„æ‰€æœ‰å¤–è®¾ã€æœåŠ¡å’Œå®ƒä»¬çš„ HAL ç±»å‹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿåº”è¯¥æŠŠæ­£åœ¨åˆ›å»ºçš„ demoComponent HAL æ·»åŠ è¿›è¿™ä¸ªæ¸…å•é‡Œã€‚ä»¥æˆ‘ç”¨çš„ Intel å¹³å°ä¸ºä¾‹ï¼Œäº§å“ä»£å·å°±ä¸è¯´äº†ï¼Œ<code>manifest.xml</code> ä½äº <code>/device/harman/broxton/XXXX/</code> ç›®å½•ä¸‹ã€‚æ·»åŠ å®Œæˆåçœ‹èµ·æ¥ç±»ä¼¼ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;device&quot;</span>&gt;</span><br><br>    ......<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">hal</span> <span class="hljs-attr">format</span>=<span class="hljs-string">&quot;hidl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>vendor.harman.hardware.demoComponent.demoService<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">transport</span>&gt;</span>hwbinder<span class="hljs-tag">&lt;/<span class="hljs-name">transport</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>IDemoServiceDef<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">instance</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">instance</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">hal</span>&gt;</span><br><br>    ......<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sepolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>27.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sepolicy</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&lt;hal format=&quot;hidl&quot;&gt;</code> è¡¨ç¤º HAL ä½¿ç”¨ HIDL æè¿°ï¼› <code>&lt;name&gt;</code> çš„å€¼å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯æ¥å£æè¿°æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼Œä½†ä¸­é—´å°‘äº†ä¸ª <strong>â€œ.interfacesâ€</strong> ï¼›<code>&lt;transport&gt;</code> è¡¨ç¤º HAL å®ç°æ‰€ä¾èµ–çš„ binder ç±»å‹ï¼›<code>&lt;version&gt;</code> è¡¨ç¤º HAL ç‰ˆæœ¬ï¼Œå›å¿†ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™æ¥å£æè¿°æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶å­˜æ”¾è·¯å¾„é‡Œä¹Ÿæœ‰ä¸ª HAL ç‰ˆæœ¬å·ï¼Œè¿™ä¸¤ä¸ªç‰ˆæœ¬å·è¦ä¸€è‡´ï¼› <code>&lt;interface&gt;</code> èŠ‚ç‚¹ç”¨æ¥æ ‡æ˜ HAL æ¥å£ï¼Œä¸‹å±çš„<code> &lt;name&gt;</code> æŒ‡å®šäº† HAL çš„æ¥å£æè¿°æ–‡ä»¶ä¸º <code>IDemoServiceDef.hal</code>ï¼Œ <code>&lt;instance&gt;</code> æŒ‡å®šäº† HAL çš„å®ç°ä½äº <code>default/</code> ç›®å½•ä¸‹ã€‚</p><p>default&#x2F; <strong>ç›®å½•éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»ºï¼Œä½äº</strong> <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/&lt;ComponentName&gt;/&lt;SubComponentName&gt;/&lt;VersionCode&gt;/</code>ã€‚ è¿˜æ˜¯ä»¥æˆ‘ç”¨çš„å¹³å°ä¸ºä¾‹ï¼Œå®Œæ•´è·¯å¾„ä¸º <code>/vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/default</code>ã€‚</p><h3 id="2-2-å®ç°HALä¸»ä½“"><a href="#2-2-å®ç°HALä¸»ä½“" class="headerlink" title="2.2 å®ç°HALä¸»ä½“"></a>2.2 å®ç°HALä¸»ä½“</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç° demoComponent HAL çš„ä¸»ä½“ã€‚ å› ä¸º <strong>Binder åŒ–åçš„ HAL æ˜¯ä»¥æœåŠ¡è¿›ç¨‹çš„å½¢å¼è¿è¡Œåœ¨ Android native å±‚</strong>çš„ï¼Œæ‰€ä»¥æˆ‘ç»™è¿™ä¸ªä¸»ä½“å–åä¸º demoServiceã€‚åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»º <code>DemoServiceImpl.h</code> å’Œ<code>DemoServiceImpl.cpp</code>ã€‚</p><p>è¿™ä¹‹åè¦åšçš„äº‹å¤§å®¶å°±å¾ˆç†Ÿæ‚‰äº† â€”â€” åœ¨ <code>DemoServiceImpl.h</code> é‡Œå¼•ç”¨å¿…è¦çš„å¤´æ–‡ä»¶ã€å£°æ˜ç±»å’Œæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hardware/hardware.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IServiceManager.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IPCThreadState.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoServiceDef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoServiceImpl</span> : <span class="hljs-keyword">public</span> IDemoServiceDef &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DemoServiceImpl</span>();<br>    ~<span class="hljs-built_in">DemoServiceImpl</span>() &#123;&#125;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> <span class="hljs-keyword">override</span></span>;<br><br><br><span class="hljs-keyword">private</span>:<br>    android::sp&lt;IDemoCallback&gt; callback = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong><code>DemoServiceImpl</code> ç±»ç»§æ‰¿è‡ª <code>IDemoServiceDef</code> ç±»ï¼Œå¹¶å¯¹æ¥å£è¿›è¡Œè¦†å†™ï¼ŒåŒæ—¶å£°æ˜äº†ä¸€ä¸ª <code>IDemoCallback</code> æŒ‡é’ˆç”¨æ¥ä¿å­˜å›è°ƒå‡½æ•°ã€‚</strong></p><p>å¤§å®¶å¯èƒ½ä¼šå›°æƒ‘<strong>IDemoServiceDef</strong> ç±»å’Œæ¥å£å£°æ˜æ˜¯å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡åå­—æ¨æµ‹å®ƒæ˜¯ç”± <strong>IDemoServiceDef.hal</strong> ç”Ÿæˆçš„ã€‚å®é™…ä¸Šå’Œæ¨æµ‹ä¸€æ ·ï¼Œç¼–è¯‘é˜¶æ®µè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ä¼šè¢«æ”¾åœ¨ <code>/out/soong/.intermediates/vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/</code> ç›®å½•ï¼Œå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶å¯ä»¥åˆ†åˆ«åœ¨ <code>vendor.harman.hardware.demoComponent.demoService@1.0_genc++_headers</code> å’Œ <code>vendor.harman.hardware.demoComponent.demoService@1.0_genc++ </code>ä¸­æ‰¾åˆ°ã€‚ <strong>åœ¨ <code>DemoServiceImpl.h</code> é‡Œéœ€è¦ <code>#include</code> å¼•ç”¨è¿™äº›è‡ªåŠ¨ç”Ÿæˆçš„å¤´æ–‡ä»¶ã€‚</strong></p><p>ä¸‹æ–¹å±•ç¤ºçš„æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å¤´æ–‡ä»¶ <code>IDemoServiceDef.h</code> çš„éƒ¨åˆ†ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hidl/base/1.0/IBase.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hidl/manager/1.0/IServiceNotification.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/HidlSupport.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/MQDescriptor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/NativeHandle.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/misc.h&gt;</span></span><br><br><span class="hljs-keyword">namespace</span> vendor &#123;<br><span class="hljs-keyword">namespace</span> harman &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> demoComponent &#123;<br><span class="hljs-keyword">namespace</span> demoService &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IDemoServiceDef</span> : <span class="hljs-keyword">public</span> ::android::hidl::base::V1_0::IBase &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isRemote</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; &#125;<br><br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; data)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// ....çœç•¥</span><br>&#125;;<br><br><span class="hljs-function">std::string <span class="hljs-title">toString</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoServiceDef&gt;&amp;)</span></span>;<br><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace demoService</span><br>&#125;  <span class="hljs-comment">// namespace demoComponent</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace harman</span><br>&#125;  <span class="hljs-comment">// namespace vendor</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span></span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>DemoServiceImpl.cpp</code> ä¸­å®ç°å„æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceImpl.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br>DemoServiceImpl::<span class="hljs-built_in">DemoServiceImpl</span>() &#123;<br><br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl setStatus&quot;</span>);<br>    <span class="hljs-comment">// çœç•¥è®¾ç½®çŠ¶æ€çš„ä»£ç </span><br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService invokes callback&quot;</span>);<br>    <span class="hljs-comment">// åœ¨æœ€åæ‰§è¡Œå›è°ƒå‡½æ•°å‘é€é€šçŸ¥</span><br>    callback-&gt;<span class="hljs-built_in">onCallbackEvent</span>(sta);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl registerCallback&quot;</span>);<br>    <span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°</span><br>    callback = cb;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function saved&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl unregisterCallback&quot;</span>);<br>    <span class="hljs-keyword">if</span> (callback == cb) &#123;<br>        <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function cleared.&quot;</span>);<br>        <span class="hljs-comment">// æ¸…ç©ºå›è°ƒå‡½æ•°</span><br>        callback = <span class="hljs-literal">nullptr</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function mismatch, uncleared.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 3 ä¸ªæ¥å£çš„å®ç°å†™å¾—å¾ˆç®€å•ï¼Œç›´æ¥çœ‹ä»£ç æ³¨é‡Šå°±å¯ä»¥ï¼Œæ— éœ€èµ˜è¨€ã€‚</p><h3 id="2-3-å°†-HAL-æ³¨å†Œä¸º-Binder-æœåŠ¡"><a href="#2-3-å°†-HAL-æ³¨å†Œä¸º-Binder-æœåŠ¡" class="headerlink" title="2.3 å°† HAL æ³¨å†Œä¸º Binder æœåŠ¡"></a>2.3 å°† HAL æ³¨å†Œä¸º Binder æœåŠ¡</h3><p><strong>å› ä¸º Binder åŒ–çš„ HAL ä»¥ç‹¬ç«‹æœ¬åœ°è¿›ç¨‹çš„å½¢å¼è¿è¡Œ</strong>ï¼Œ<strong>æ‰€ä»¥å¿…å®šéœ€è¦ main() å‡½æ•°ä½œä¸ºè¿›ç¨‹å¯åŠ¨å…¥å£</strong>ã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥æŠŠ main() å†™åœ¨ DemoServiceImpl.cpp ä¸­ï¼Œä½†ä¸ºäº†ä¸æ¥å£å®ç°è¿›è¡ŒåŒºåˆ†ï¼Œæˆ‘åœ¨<code>default/ </code>ç›®å½•ä¸‹æ–°å»ºæºæ–‡ä»¶ <code>DemoService.cpp</code>ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å®ç°ä¸”ä»…å®ç° main() å‡½æ•°ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/ProcessState.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/LegacySupport.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceImpl.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-comment">/* argc */</span>, <span class="hljs-type">char</span>* <span class="hljs-comment">/* argv */</span> [])</span> </span>&#123;<br>    android::ProcessState::<span class="hljs-built_in">initWithDriver</span>(<span class="hljs-string">&quot;/dev/hwbinder&quot;</span>);  <span class="hljs-comment">// åˆå§‹åŒ– Binder é©±åŠ¨</span><br>    <span class="hljs-keyword">auto</span> service = std::<span class="hljs-built_in">make_unique</span>&lt;DemoServiceImpl&gt;();      <span class="hljs-comment">// æ„é€  DemoServiceImpl å®ä¾‹</span><br>    android::hardware::<span class="hljs-built_in">configureRpcThreadpool</span>(<span class="hljs-number">4</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* callerWillJoin */</span>);<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService registerAsService&quot;</span>);<br>    android::<span class="hljs-type">status_t</span> status = service-&gt;<span class="hljs-built_in">registerAsService</span>();  <span class="hljs-comment">// æ³¨å†Œä¸º Binder æœåŠ¡</span><br>    <span class="hljs-keyword">if</span> (status != android::OK) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Unable to register DemoService (%d)&quot;</span>, status);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    android::hardware::<span class="hljs-built_in">joinRpcThreadpool</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åœ¨ <strong>main()</strong> å‡½æ•°ä¸­ä¸»è¦å¹²äº†äº›äº‹ï¼šä½¿ç”¨è®¾å¤‡èŠ‚ç‚¹ <code>/dev/hwbinder</code> åˆå§‹åŒ– Binder é©±åŠ¨ï¼Œå¹¶ä»¥å•ä¾‹ï¼ˆSingletonï¼‰çš„æ–¹å¼å°† <code>DemoServiceImpl</code> ç±»çš„ä¸€ä¸ªå®ä¾‹æ³¨å†Œä¸º Binder æœåŠ¡ã€‚</p><p><strong>å¦‚æœä½ å¸Œæœ› HAL è¿›ç¨‹ä¹Ÿèƒ½ä¸å…¶å®ƒæœ¬åœ°è¿›ç¨‹äº¤äº’ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ–é©±åŠ¨çš„æ—¶å€™åº”è¯¥ä½¿ç”¨</strong> <code>/dev/vndbinder</code>ã€‚</p><h2 id="3-å®ç°-Bpã€Bn-ç«¯"><a href="#3-å®ç°-Bpã€Bn-ç«¯" class="headerlink" title="3.å®ç° Bpã€Bn ç«¯"></a>3.å®ç° Bpã€Bn ç«¯</h2><p><strong>ã€å‰è¨€ã€‘</strong></p><p>æ—¢ç„¶ Binder åŒ–çš„ HAL ä¾èµ–äº Binder æœºåˆ¶è¿›è¡Œå®ç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å¿…é¡»æŒ‰ç…§ Binder æ¡†æ¶ï¼Œç›¸åº”ç¼–å†™ <strong>demoComponent HAL</strong> çš„ <strong>Bp</strong> ç«¯å’Œ <strong>Bn</strong> ç«¯ã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½æ‰“é€šå®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨åˆ°æœåŠ¡ç«¯è¿›ç¨‹ â€”â€” æˆ‘ä»¬çš„ demoService â€”â€” çš„é€šè·¯ã€‚</p><h3 id="3-1-å®šä¹‰demoServiceæ¥å£ç±»"><a href="#3-1-å®šä¹‰demoServiceæ¥å£ç±»" class="headerlink" title="3.1 å®šä¹‰demoServiceæ¥å£ç±»"></a>3.1 å®šä¹‰demoServiceæ¥å£ç±»</h3><p>è¦å°† demoService æ¥å…¥ Binderï¼Œå°±å¿…é¡»å®šä¹‰ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„æ¥å£ç±»ï¼Œç»§æ‰¿ Binder çš„æ¥å£åŸºç±» <code>IInterface</code>ï¼Œå¹¶å®ç°æ‰€æœ‰ Binder é€šä¿¡è¿‡ç¨‹ä¸­è¦ç”¨åˆ°çš„æ–¹æ³•ã€‚ä¸è¿‡æˆ‘ä»¬å¹¶ä¸éœ€è¦äº‹æ— å·¨ç»†åœ°å®Œæˆè¿™é¡¹ç¹æ‚çš„å·¥ä½œï¼Œå› ä¸º Binder æ¡†æ¶æä¾›äº†æ•°ä¸ªæ¨¡æ¿ç±»å’Œå®ï¼Œå¤§å¤§æ–¹ä¾¿äº†æˆ‘ä»¬å®ç°ã€‚</p><p>è¿˜è®°å¾—åœ¨ä¸Šä¸€èŠ‚ã€Šå®ç° HAL ä¸»ä½“ã€‹é‡Œæˆ‘ä»¬åˆ›å»ºäº† <code>default/</code> ç›®å½•ã€‚åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå¤´æ–‡ä»¶ <code>DemoServiceBinderInterface.h</code>ï¼Œå¹¶åœ¨è¿™ä¸ªå¤´æ–‡ä»¶é‡Œå®šä¹‰æ¥å£ç±» <code>IDemoService</code>ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IInterface.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMOSERVICE_NAME <span class="hljs-string">&quot;com.qidi.demoService&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::IDemoCallback;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::DemoData;<br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-comment">// command codes for binder transactions</span><br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">eDemoServiceTransactionID</span><br>    &#123;<br>        SET_STATUS = android::IBinder::FIRST_CALL_TRANSACTION,<br>        REGISTER_CALLBACK,<br>        UNREGISTER_CALLBACK<br>    &#125;;<br><br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">IDemoService</span>: <span class="hljs-keyword">public</span> IInterface &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-built_in">DECLARE_META_INTERFACE</span>(DemoService);<br><br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>= <span class="hljs-number">0</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤äº†å®šä¹‰ç±» <code>IDemoService</code>ï¼Œæˆ‘ä»¬è¿˜åœ¨å¤´æ–‡ä»¶ <code>DemoServiceBinderInterface.h</code> é‡Œä»¥<strong>æšä¸¾æ•°æ®çš„å½¢å¼</strong>å®šä¹‰äº†å’Œ demoService Binder è°ƒç”¨ç›¸å…³çš„ Command codeã€‚ ä¸‰ä¸ª Command code <code>SET_STATUS</code>ã€<code>REGISTER_CALLBACK</code> å’Œ <code>UNREGISTER_CALLBACK</code> åˆ†åˆ«å¯¹åº” demoService çš„ä¸‰ä¸ªæ¥å£ã€‚<strong>ç¬¬ä¸€ä¸ª Command code å¿…é¡»èµ‹å€¼ä¸º</strong> <code>android::IBinder::FIRST_CALL_TRANSACTION</code>ã€‚</p><p>å® <code>DECLARE_META_INTERFACE()</code> ä¸»è¦ç”¨æ¥å£°æ˜ç”¨äº Binder é€šä¿¡çš„æˆå‘˜å˜é‡ <code>descriptor</code> å’Œé€šç”¨æ¥å£ <code>asInterface()</code> ã€ <code>getInterfaceDescriptor()</code>ã€‚ ç›¸å…³ä»£ç ä½äº <code>IInterface.h</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DECLARE_META_INTERFACE(INTERFACE)                               \</span><br><span class="hljs-meta">    static const ::android::String16 descriptor;                        \</span><br><span class="hljs-meta">    static ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> asInterface(                     \</span><br><span class="hljs-meta">            const ::android::sp<span class="hljs-string">&lt;::android::IBinder&gt;</span>&amp; obj);              \</span><br><span class="hljs-meta">    virtual const ::android::String16&amp; getInterfaceDescriptor() const;  \</span><br><span class="hljs-meta">    I##INTERFACE();                                                     \</span><br><span class="hljs-meta">    virtual ~I##INTERFACE();                                            \</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒdemoService çš„æ¥å£ç±»å°±å®šä¹‰å¥½äº†ã€‚</p><h3 id="3-2-å£°æ˜-Bpã€Bn-ç«¯"><a href="#3-2-å£°æ˜-Bpã€Bn-ç«¯" class="headerlink" title="3.2 å£°æ˜ Bpã€Bn ç«¯"></a>3.2 å£°æ˜ Bpã€Bn ç«¯</h3><p>æœ‰äº†æ¥å£ç±»ä¹‹åï¼Œå°±å¯ä»¥æ­£å¼ç€æ‰‹ Bpã€Bn ç«¯çš„å·¥ä½œäº†ã€‚ä¾ç…§å…ˆå£°æ˜åå®ç°çš„é¡ºåºï¼Œæˆ‘ä»¬ç»§ç»­åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºå¤´æ–‡ä»¶ <code>BpDemoService.h</code> å’Œ <code>BnDemoService.h</code>ã€‚<strong>Binder æ¡†æ¶æä¾›äº†æ¨¡æ¿ç±»<code>BpInterface&lt;&gt;</code>å’Œ <code>BnInterface&lt;&gt;</code> æ¥ç®€åŒ–è¿™ä¸€è¿‡ç¨‹</strong>ã€‚</p><ul><li><strong><code>BpDemoService.h</code> ä»£ç å¦‚ä¸‹ï¼š</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">BpDemoService</span>: <span class="hljs-keyword">public</span> BpInterface&lt;android::IDemoService&gt; &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-built_in">BpDemoService</span>(<span class="hljs-type">const</span> sp&lt;IBinder&gt;&amp; impl);<br><br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span></span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span></span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span></span>;<br>    &#125;;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Bp ç«¯å¤´æ–‡ä»¶ä¸­å°† <code>IDemoService</code> ä½œä¸ºå‚æ•°ä¼ å…¥ <code>BpInterface&lt;&gt;</code> æ¨¡æ¿ï¼Œæ‰€ä»¥éœ€è¦å¼•ç”¨ <code>DemoServiceBinderInterface.h</code>ã€‚ç”±äºæ¨¡æ¿ç±»çš„è®¾è®¡ï¼Œæ–‡ä»¶ä¸­å£°æ˜çš„ demoService çš„ 3 ä¸ªæ¥å£å°†è¢«æ•´åˆåˆ° Binder æ¡†æ¶ä»£ç ä¸­ã€‚æˆ‘ä»¬å³ä¾¿ä¸å»å…³æ³¨å…¶ä¸­çš„ç»†èŠ‚ä¹Ÿæ²¡å…³ç³»ï¼Œåªè¦è´Ÿè´£å¡«å…¥æ¥å£ç±»å’Œæ¥å£å£°æ˜ï¼Œå‰©ä¸‹çš„äº¤ç»™ Binder æ¡†æ¶å°±å¥½ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å……æ»¡å¥½å¥‡ä¸”æ—¶é—´å……è£•ï¼Œä¹Ÿå¯ä»¥ä¸€å¤´æ‰è¿›å»ç†ä¸€ç†æ€è·¯ã€‚ <code>BpInterface&lt;&gt;</code> æ¨¡æ¿ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> INTERFACE&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BpInterface</span> : <span class="hljs-keyword">public</span> INTERFACE, <span class="hljs-keyword">public</span> BpRefBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span>                    <span class="hljs-title">BpInterface</span><span class="hljs-params">(<span class="hljs-type">const</span> sp&lt;IBinder&gt;&amp; remote)</span></span>;<br><br><span class="hljs-keyword">protected</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> IBinder*            <span class="hljs-title">onAsBinder</span><span class="hljs-params">()</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong><code>BnDemoService.h</code> ä»£ç å¦‚ä¸‹ï¼š</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">BnDemoService</span>: <span class="hljs-keyword">public</span> BnInterface&lt;IDemoService&gt; &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">onTransact</span><span class="hljs-params">( <span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel&amp; data,</span></span><br><span class="hljs-params"><span class="hljs-function">                Parcel* reply, <span class="hljs-type">uint32_t</span> flags = <span class="hljs-number">0</span>)</span></span>;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Bn ç«¯å¤´æ–‡ä»¶çš„å†…å®¹ä¸ Bp ç«¯ç±»ä¼¼ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œç”±äº Binder æ¡†æ¶çš„è®¾è®¡åŸå› ï¼Œè¿™é‡Œçš„æ–¹æ³•å <code>onTransact()</code> åŠå‚æ•°éƒ½æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬ä¸èƒ½å†™æˆå…¶å®ƒå½¢å¼ã€‚</strong> <code>BnInterface&lt;&gt;</code> æ¨¡æ¿ç±»åœ¨ <code>IInterface.h</code> ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> INTERFACE&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BnInterface</span> : <span class="hljs-keyword">public</span> INTERFACE, <span class="hljs-keyword">public</span> BBinder<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> sp&lt;IInterface&gt;      <span class="hljs-title">queryLocalInterface</span><span class="hljs-params">(<span class="hljs-type">const</span> String16&amp; _descriptor)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">const</span> String16&amp;     <span class="hljs-title">getInterfaceDescriptor</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br><span class="hljs-keyword">protected</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> IBinder*            <span class="hljs-title">onAsBinder</span><span class="hljs-params">()</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3-3-å®ç°-Bpã€Bn-ç«¯"><a href="#3-3-å®ç°-Bpã€Bn-ç«¯" class="headerlink" title="3.3 å®ç° Bpã€Bn ç«¯"></a>3.3 å®ç° Bpã€Bn ç«¯</h3><p>å£°æ˜ä¹‹åï¼Œè¯¥è¿›è¡Œå®ç°äº†ã€‚ç»§ç»­åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºæºæ–‡ä»¶ <code>BpDemoService.cpp</code> å’Œ <code>BnDemoService.cpp</code>ã€‚</p><p>å®ç°è¿‡ç¨‹åªæ˜¯é¡ºæ°´æ¨èˆŸè€Œå·²ï¼Œç›´æ¥çœ‹ä»£ç å§ã€‚</p><ul><li><strong>BpDemoService.cpp:</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IServiceManager.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/Parcel.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BpDemoService.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_D ALOGD</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_E ALOGE</span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;sta, <span class="hljs-built_in">sizeof</span>(DemoData));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(SET_STATUS, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status != NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::setStatus transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;cb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(REGISTER_CALLBACK, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status != NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::registerCallback transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;cb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(UNREGISTER_CALLBACK, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status == NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::unregisterCallback transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br>BpDemoService::<span class="hljs-built_in">BpDemoService</span>(<span class="hljs-type">const</span> sp&lt;IBinder&gt; &amp;impl) : <span class="hljs-built_in">BpInterface</span>&lt;IDemoService&gt;(impl) &#123;&#125;<br><span class="hljs-built_in">IMPLEMENT_META_INTERFACE</span>(DemoService, DEMOSERVICE_NAME);<br><br></code></pre></td></tr></table></figure><p>Bp ç«¯çš„æºæ–‡ä»¶é‡Œä½¿ç”¨äº†å® <code>IMPLEMENT_META_INTERFACE()</code>ï¼Œæ‰©å±•ä¹‹åå³æ˜¯å® <code>DECLARE_META_INTERFACE()</code> æ‰€å£°æ˜çš„æ¥å£çš„å®ç°ã€‚</p><p>è¿™ä¸ªå®åŒæ ·å®šä¹‰åœ¨ <code>IInterface.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span><br><span class="hljs-meta">    const ::android::String16 I##INTERFACE::descriptor(NAME);           \</span><br><span class="hljs-meta">    const ::android::String16&amp;                                          \</span><br><span class="hljs-meta">            I##INTERFACE::getInterfaceDescriptor() const &#123;              \</span><br><span class="hljs-meta">        return I##INTERFACE::descriptor;                                \</span><br><span class="hljs-meta">    &#125;                                                                   \</span><br><span class="hljs-meta">    ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> I##INTERFACE::asInterface(              \</span><br><span class="hljs-meta">            const ::android::sp<span class="hljs-string">&lt;::android::IBinder&gt;</span>&amp; obj)               \</span><br><span class="hljs-meta">    &#123;                                                                   \</span><br><span class="hljs-meta">        ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> intr;                               \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (obj != NULL) &#123;                                              \</span><br><span class="hljs-meta">            intr = static_cast<span class="hljs-string">&lt;I##INTERFACE*&gt;</span>(                          \</span><br><span class="hljs-meta">                obj-&gt;queryLocalInterface(                               \</span><br><span class="hljs-meta">                        I##INTERFACE::descriptor).get());               \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (intr == NULL) &#123;                                         \</span><br><span class="hljs-meta">                intr = new Bp##INTERFACE(obj);                          \</span><br><span class="hljs-meta">            &#125;                                                           \</span><br><span class="hljs-meta">        &#125;                                                               \</span><br><span class="hljs-meta">        return intr;                                                    \</span><br><span class="hljs-meta">    &#125;                                                                   \</span><br><span class="hljs-meta">    I##INTERFACE::I##INTERFACE() &#123; &#125;                                    \</span><br><span class="hljs-meta">    I##INTERFACE::~I##INTERFACE() &#123; &#125;                                   \</span><br></code></pre></td></tr></table></figure><ul><li><strong>BnDemoService.cpp:</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Errors.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/Parcel.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BnDemoService.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_D ALOGD</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_E ALOGE</span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::DemoData;<br><br><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">BnDemoService::onTransact</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel &amp;data, Parcel *reply, <span class="hljs-type">uint32_t</span> flags)</span> </span>&#123;<br>    <span class="hljs-type">status_t</span> retCode = NO_ERROR;<br>    <span class="hljs-keyword">switch</span> (code) &#123;<br>        <span class="hljs-keyword">case</span> SET_STATUS:&#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService SET_STATUS()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            DemoData sta;<br>            data.<span class="hljs-built_in">read</span>(&amp;sta, <span class="hljs-built_in">sizeof</span>(DemoData));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">setStatus</span>(sta));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> REGISTER_CALLBACK:&#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService REGISTER_CALLBACK()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            ::android::sp&lt;IDemoCallback&gt; rcb;<br>            data.<span class="hljs-built_in">read</span>(&amp;rcb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">registerCallback</span>(rcb));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> UNREGISTER_CALLBACK: &#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService UNREGISTER_CALLBACK()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            sp&lt;IDemoCallback&gt; urcb;<br>            data.<span class="hljs-built_in">read</span>(&amp;urcb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">unregisterCallback</span>(urcb));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>: &#123;<br>            <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BnDemoService::onTransact(0x%x,0x%x)&quot;</span>, code, flags);<br>            retCode = BBinder::<span class="hljs-built_in">onTransact</span>(code, data, reply, flags);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> retCode;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Bn ç«¯çš„æºæ–‡ä»¶é‡Œå¯¹ <code>onTransact()</code> è¿›è¡Œå®ç°ï¼Œä½¿ç”¨ <code>switch...case...</code> å¯¹ Command code è¿›è¡Œå¤„ç†ã€‚<strong>åœ¨æ¯ä¸ª case çš„æœ«å°¾å¯ä»¥çœ‹åˆ°å¯¹ demoService é‡Œå„ä¸ªæ–¹æ³•çš„è°ƒç”¨</strong>ï¼Œå¹¶å°†è°ƒç”¨çš„è¿”å›å€¼å†™å…¥ replyã€‚</p><h2 id="4-ç¼–è¯‘ä¸æ‰“åŒ…"><a href="#4-ç¼–è¯‘ä¸æ‰“åŒ…" class="headerlink" title="4.ç¼–è¯‘ä¸æ‰“åŒ…"></a>4.ç¼–è¯‘ä¸æ‰“åŒ…</h2><h3 id="4-1-ç¼–å†™Makefile"><a href="#4-1-ç¼–å†™Makefile" class="headerlink" title="4.1 ç¼–å†™Makefile"></a>4.1 ç¼–å†™Makefile</h3><p><strong>è¿™é‡Œè¯´çš„ Makefile æ˜¯æŒ‡ <code>Android.bp</code>ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>Android.mk</code>ï¼Œè¯­æ³•ç¨æœ‰åŒºåˆ«ï¼‰</strong>ã€‚</p><p>åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ <code>Android.bp</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp">cc_defaults &#123;<br>    name: <span class="hljs-string">&quot;demoSvc_v1_0_default&quot;</span>,<br>    shared_libs: [<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;libhardware&quot;</span>,<br>        <span class="hljs-string">&quot;libbinder&quot;</span>,<br>        <span class="hljs-string">&quot;vendor.harman.hardware.demoComponent.demoService@1.0_vendor&quot;</span>,<br>    ],<br>    cflags: [<br>        <span class="hljs-string">&quot;-Wall&quot;</span>,<br>        <span class="hljs-string">&quot;-Wextra&quot;</span>,<br>        <span class="hljs-string">&quot;-Werror&quot;</span>,<br>    ],<br>&#125;<br><br>cc_binary &#123;<br>    name: <span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service&quot;</span>,<br>    defaults: [<span class="hljs-string">&quot;demoSvc_v1_0_default&quot;</span>],<br>    init_rc: [<span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service.rc&quot;</span>],<br>    vendor: <span class="hljs-literal">true</span>,<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br><br>    include_dirs:[<span class="hljs-string">&quot;vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/default&quot;</span>],<br>    srcs: [<br>        <span class="hljs-string">&quot;DemoService.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;DemoServiceImpl.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;BpDemoService.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;BnDemoService.cpp&quot;</span><br>    ],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;libbase&quot;</span>,<br>        <span class="hljs-string">&quot;libprotobuf-cpp-lite&quot;</span>,<br>        <span class="hljs-string">&quot;vendor.harman.hardware.demoComponent.demoService@1.0_vendor&quot;</span><br>    ],<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>ç›®æ ‡ demoSvc_v1_0_default å¯ä»¥ç†è§£æˆæ˜¯å°†å’Œ Binder æ¡†æ¶ç›¸å…³çš„åº“æ‰“åŒ…è€Œæˆçš„ä¸€ä¸ªæ€»çš„åº“æ–‡ä»¶ï¼Œ<a href="mailto:&#118;&#101;&#110;&#x64;&#111;&#x72;&#x2e;&#104;&#97;&#x72;&#109;&#97;&#110;&#x2e;&#104;&#97;&#114;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#100;&#x65;&#109;&#x6f;&#x43;&#111;&#x6d;&#x70;&#111;&#x6e;&#x65;&#110;&#116;&#x2e;&#100;&#101;&#x6d;&#x6f;&#x53;&#101;&#x72;&#x76;&#x69;&#x63;&#x65;&#x40;&#49;&#x2e;&#48;&#x5f;&#118;&#x65;&#110;&#100;&#x6f;&#114;">&#118;&#101;&#110;&#x64;&#111;&#x72;&#x2e;&#104;&#97;&#x72;&#109;&#97;&#110;&#x2e;&#104;&#97;&#114;&#100;&#x77;&#x61;&#x72;&#101;&#x2e;&#100;&#x65;&#109;&#x6f;&#x43;&#111;&#x6d;&#x70;&#111;&#x6e;&#x65;&#110;&#116;&#x2e;&#100;&#101;&#x6d;&#x6f;&#x53;&#101;&#x72;&#x76;&#x69;&#x63;&#x65;&#x40;&#49;&#x2e;&#48;&#x5f;&#118;&#x65;&#110;&#100;&#x6f;&#114;</a> æ˜¯é€šè¿‡æ¥å£æè¿°æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼ŒåŒæ ·å¯ä»¥åœ¨ &#x2F;out&#x2F;soong&#x2F;.intermediates&#x2F;â€¦ ç›®å½•ä¸‹æ‰¾åˆ°ï¼›</p></li><li><p>ç›®æ ‡ <a href="mailto:&#118;&#x65;&#x6e;&#x64;&#111;&#x72;&#46;&#x68;&#x61;&#x72;&#x6d;&#x61;&#x6e;&#x2e;&#100;&#x65;&#x6d;&#111;&#x43;&#111;&#x6d;&#x70;&#x6f;&#x6e;&#101;&#110;&#x74;&#x2e;&#100;&#101;&#x6d;&#111;&#x53;&#x65;&#114;&#118;&#105;&#99;&#101;&#64;&#49;&#46;&#48;&#x2d;&#115;&#x65;&#114;&#118;&#x69;&#x63;&#x65;">&#118;&#x65;&#x6e;&#x64;&#111;&#x72;&#46;&#x68;&#x61;&#x72;&#x6d;&#x61;&#x6e;&#x2e;&#100;&#x65;&#x6d;&#111;&#x43;&#111;&#x6d;&#x70;&#x6f;&#x6e;&#101;&#110;&#x74;&#x2e;&#100;&#101;&#x6d;&#111;&#x53;&#x65;&#114;&#118;&#105;&#99;&#101;&#64;&#49;&#46;&#48;&#x2d;&#115;&#x65;&#114;&#118;&#x69;&#x63;&#x65;</a> å°±æ˜¯æœ€ç»ˆè¦ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼›</p></li><li><p>å±æ€§ vendor: true è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ–‡ä»¶ï¼›</p></li><li><p>å±æ€§ relative_install_path: â€œhwâ€ å’Œå‰ä¸€ä¸ªå±æ€§å…±åŒä½œç”¨ï¼Œè¡¨ç¤ºç”Ÿæˆæ–‡ä»¶çš„ç›¸å¯¹å­˜æ”¾ä½ç½®åœ¨ <code>out/target/product/&lt;ProductName&gt;/vendor/bin/hw/ </code>ç›®å½•ï¼›</p></li><li><p>å±æ€§ srcs å±æ€§ä¸‹åŒ…å«äº†æˆ‘ä»¬åœ¨ä¹‹å‰å‡ ç¯‡æ–‡ç« é‡Œç¼–å†™çš„æ‰€æœ‰æºæ–‡ä»¶ â€”â€” DemoService.cppã€DemoServiceImpl.cppã€BpDemoService.cpp å’Œ BnDemoService.cppã€‚</p></li></ul><h3 id="4-2-ç¼–å†™HALå¯åŠ¨è„šæœ¬"><a href="#4-2-ç¼–å†™HALå¯åŠ¨è„šæœ¬" class="headerlink" title="4.2 ç¼–å†™HALå¯åŠ¨è„šæœ¬"></a>4.2 ç¼–å†™HALå¯åŠ¨è„šæœ¬</h3><p>åŸºäºä¸Šè¿°çš„ Makefile åœ¨ <code>default/</code> ç›®å½•ä¸‹<strong>æ‰‹åŠ¨ï¼ˆmm å‘½ä»¤ï¼‰</strong>è¿›è¡Œç¼–è¯‘ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°åä¸º <code>vendor.harman.demoComponent.demoService@1.0-service</code> çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¸ºäº†è®© demoComponent HAL éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ <code>*.rc</code> è„šæœ¬ï¼Œå¹¶åœ¨è„šæœ¬ä¸­æ ‡æ³¨è¿›ç¨‹åã€å¯æ‰§è¡Œæ–‡ä»¶ã€ç”¨æˆ·ç»„ç­‰ä¿¡æ¯ã€‚</p><p>ä¸€èˆ¬ä»¥å¯æ‰§è¡Œæ–‡ä»¶åä½œä¸ºè„šæœ¬åï¼Œä¹Ÿå°±æ˜¯ <code>vendor.harman.demoComponent.demoService@1.0-service.rc</code>ã€‚</p><p>åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºè„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">service MyDemoService /vendor/bin/hw/vendor.harman.demoComponent.demoService@1.0-service<br>    class main<br>    user system<br>    group system<br>    capabilities sys_nice net_bind_service net_admin net_raw<br></code></pre></td></tr></table></figure><ul><li><p>å…³é”®å­— service ç”¨æ¥å®šä¹‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆæˆ–ç§°ä¸ºæœ¬åœ°æœåŠ¡ï¼‰ï¼Œåé¢ç¬¬ä¸€ä¸ªå‚æ•° MyDemoService æ˜¯è¿›ç¨‹åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼›</p></li><li><p>class main è¡¨ç¤ºæŠŠ MyDemoService å½’å±åˆ° main ç±»ï¼›</p></li><li><p>user system å’Œ group system è¡¨ç¤º MyDemoService çš„ç”¨æˆ·å’Œç»„ç”¨æˆ·éƒ½æ˜¯ systemï¼›</p></li><li><p>capabilities æŒ‡å®šäº†ä¸€äº›æƒé™ç›¸å…³çš„å±æ€§ã€‚</p></li></ul><h3 id="4-3-æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ"><a href="#4-3-æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ" class="headerlink" title="4.3 æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ"></a>4.3 æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ</h3><p>è¦å®ç° demoComponent HAL éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ï¼Œéœ€è¦å°†å®ƒçš„ <code>å¯æ‰§è¡Œæ–‡ä»¶</code> å’Œ <code>*.rc</code> æ–‡ä»¶éƒ½æ‰“åŒ…è¿›ç³»ç»Ÿé•œåƒã€‚é€šè¿‡ä¿®æ”¹äº§å“çš„ Makefile å¯ä»¥å®ç°è¿™ä¸€ç›®çš„ã€‚</p><p>å…ˆåœ¨ <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/common/</code> è·¯å¾„ä¸‹ä¸º demoComponent HAL æ–°å»ºä¸€ä¸ªåä¸º <code>demoComponent/</code> çš„ä¸“å±ç›®å½•ï¼Œå†åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºåä¸º <code>device_demoComponent.mk</code> çš„ Makefileã€‚ï¼ˆå…¶å®å«ä»€ä¹ˆåå­—éƒ½å¯ä»¥ï¼Œä½†æ˜¯ç”¨ demoComponent æ›´ç›´è§‚ï¼‰</p><p><strong>å¦‚æ­¤ä¸€æ¥æˆ‘ä»¬å°±æœ‰äº† <code>/device/harman/broxton/common/demoComponent/device_demoComponent.mk</code>ã€‚</strong> é™¤å»æ³¨é‡Šï¼ŒMakefile å†…å®¹åªæœ‰ä¸€å¥è¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">############################</span><br><span class="hljs-comment"># DemoService</span><br><span class="hljs-comment">############################</span><br><br>PRODUCT_PACKAGES += vendor.harman.demoComponent.demoService@1.0-service<br></code></pre></td></tr></table></figure><p>è¿™å¥è¯è¡¨ç¤ºè¦å°†å¯æ‰§è¡Œæ–‡ä»¶ <code>vendor.harman.demoComponent.demoService@1.0-service</code> æ‰“åŒ…è¿›ç³»ç»Ÿé•œåƒï¼Œç¡®åˆ‡åœ°è¯´æ˜¯æ‰“åŒ…è¿› <code>vendor.img</code>ã€‚</p><p>åˆ‡è®°ï¼Œä¸è¦å¿˜äº†æŠŠæˆ‘ä»¬æ–°å»ºçš„ Makefile æ·»åŠ åˆ°äº§å“çš„ Makefile ä¸­ã€‚ äº§å“ Makefile ä¸€èˆ¬ä½äº <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/device.mk</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>/device/harman/broxton/XXXX/device.mk</code> ä¸­å¢åŠ ä»¥ä¸‹è¯­å¥ï¼ˆä»¥ diff å½¢å¼å±•ç¤ºï¼‰ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">diff --git a/XXXX/device.mk b/XXXX/device.mk<br>index b0866f3d2..d7a7d8ef7 100755<br>--- a/XXXX/device.mk<br>+++ b/XXXX/device.mk<br>@@ -1,5 +1,6 @@<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/device_common.mk<br> <span class="hljs-keyword">include</span> <span class="hljs-variable">$(LOCAL_PATH)</span>/audio/device_audio.mk<br>+<span class="hljs-keyword">include</span> device/harman/broxton/common/demoComponent/device_demoComponent.mk<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/tuner/device_radioTuner.mk<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/speech/vpa.mk<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢ä»¥ <code>+</code> å¼€å¤´çš„ <code>include</code> è¯­å¥ï¼Œå°±æ˜¯åœ¨å¼•ç”¨æˆ‘ä»¬çš„æ–°å»º Makefileã€‚</p><hr><p><strong>ã€ç»“è¯­ã€‘</strong></p><p>æ‰“åŒ…å·²ç»å®Œæˆï¼Œæˆ‘ä»¬çš„ demoComponent HAL æ­£è·ƒè·ƒæ¬²è¯•ã€‚ä½†å¦‚æœä½ å°†æ‰“åŒ…å¥½çš„ç³»ç»Ÿé•œåƒçƒ§å†™åˆ°è®¾å¤‡ä¸Šï¼Œä¼šå‘ç° demoComponent HAL ä¸èƒ½æŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œç”šè‡³è¿è‡ªå¯åŠ¨éƒ½åšä¸åˆ°ã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šåœ¨ logcat æˆ– dmesg é‡Œå‘ç°æœ‰å¾ˆå¤šæ—¥å¿—æç¤ºæˆ‘ä»¬æ²¡æœ‰æ“ä½œæƒé™ã€‚ ä¸‹ä¸€èŠ‚ã€Šæ·»åŠ æ‰§è¡Œæƒé™ã€‹å°†ä»‹ç»å¦‚ä½•ç»™ demoComponent HAL æ·»åŠ å¿…è¦çš„æƒé™ã€‚</p><p>å¦‚æœä½ æ€¥åˆ‡åœ°æƒ³çœ‹ä¸€çœ‹åˆšåˆšå†™å¥½çš„ HAL è¿›ç¨‹è¿è¡Œçš„æ ·å­ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ <code>setenforce 0</code> å°†è®¾å¤‡çš„ SELinux ç­–ç•¥æš‚æ—¶å…³é—­ã€‚ è¿™æ ·å°½ç®¡ç³»ç»Ÿä»ç„¶ä¼šæŠ¥å‘Šæƒé™é”™è¯¯ï¼Œä½†ä¸ä¼šç¦æ­¢è¿è¡Œã€‚</p><h2 id="5-æ·»åŠ æ‰§è¡Œæƒé™"><a href="#5-æ·»åŠ æ‰§è¡Œæƒé™" class="headerlink" title="5.æ·»åŠ æ‰§è¡Œæƒé™"></a>5.æ·»åŠ æ‰§è¡Œæƒé™</h2><p><strong>ã€å‰è¨€ã€‘</strong></p><p>demoComponent HAL å·²ç»æˆåŠŸç¼–è¯‘ä¸”æ‰“åŒ…åˆ°ç³»ç»Ÿé•œåƒä¸­ï¼Œä½†åˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰è¢«èµ‹äºˆè®¿é—® Binder çš„æƒé™ã€‚æ‰€ä»¥æˆ‘ä»¬è‡³å°‘ä¼šçœ‹åˆ°ï¼Œåœ¨å°† demoService æ³¨å†Œä¸º Binder æœåŠ¡æ—¶ï¼Œæ—¥å¿—ä¸­ä¼šæ‰“å°ç±»ä¼¼ä¸‹æ–¹çš„æç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">[   <span class="hljs-number">10.368517</span>] type=<span class="hljs-number">1400</span> <span class="hljs-built_in">audit</span>(<span class="hljs-number">1483292256.112</span>:<span class="hljs-number">14</span>): avc: denied &#123; add &#125; ...<br></code></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« å°±æ˜¯è¦è¯´æ˜å®Œå–„ demoComponent HAL æ‰€éœ€è¦çš„ SELinux æƒé™çš„æ–¹æ³•ã€‚</p><h3 id="5-1-ç¼–å†™ç­–ç•¥æ–‡ä»¶"><a href="#5-1-ç¼–å†™ç­–ç•¥æ–‡ä»¶" class="headerlink" title="5.1 ç¼–å†™ç­–ç•¥æ–‡ä»¶"></a>5.1 ç¼–å†™ç­–ç•¥æ–‡ä»¶</h3><p>ä¾å„å…¬å¸ä¹ æƒ¯ä¸åŒï¼Œç”¨äºé…ç½®äº§å“æƒé™çš„æ–‡ä»¶ä¸€èˆ¬æ”¾åœ¨ <code>/device/&lt;CompanyName&gt;/sepolicy/</code> æˆ– <code>/device/&lt;CompanyName&gt;/common/sepolicy/</code> ç›®å½•ä¸‹ï¼ˆä¹Ÿä¸æ’é™¤æ˜¯å…¶å®ƒè·¯å¾„çš„å¯èƒ½æ€§ï¼Œä½†è‚¯å®šæ˜¯åœ¨<code>device/</code> ç›®å½•ä¸‹çš„æŸä¸ª <code>sepolicy/ </code>å­ç›®å½•ï¼‰ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå†ä¸ºä¸åŒçš„éƒ¨ä»¶åˆ†åˆ«åˆ›å»ºç›¸åº”çš„å­ç›®å½•ï¼Œå¹¶åœ¨è¿™ä¸ªå­ç›®å½•ä¸­æ–°å»º <code>*.te</code> æ–‡ä»¶å’Œ <code>*_contexts</code> æ–‡ä»¶ï¼Œä»¥æ·»åŠ å¿…è¦çš„æƒé™ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘æ­£åœ¨ä½¿ç”¨çš„å¹³å°ä¸ºä¾‹ï¼Œåˆ›å»ºæ–°ç›®å½• <code>/device/harman/sepolicy/demoComponent/</code>ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ–‡ä»¶ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200720203213989.png"><p>è¯´æ˜ä¸‹å„æ–‡ä»¶çš„å†…å®¹å’Œä½œç”¨ï¼š</p><ul><li><strong>file_contexts:</strong><ul><li>é¦–å…ˆç¼–å†™ <code>file_contexts</code> æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶åæ˜¯ç”± SELinux æ¡†æ¶å›ºå®šçš„ã€‚æˆ‘ä»¬åœ¨ <code>file_contexts</code> ä¸­å°† demoService çš„å¯æ‰§è¡Œæ–‡ä»¶å®šä¹‰ä¸ºå®‰å…¨å¯¹è±¡ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> demoService executable binary as a security object</span><br>/vendor/bin/hw/vendor.harman.demoComponent.demoService@<span class="hljs-number">1.0</span>-service   u:object_r:demoService_exec:s0<br></code></pre></td></tr></table></figure><ul><li><strong>hwservice_contexts:</strong><ul><li>ç„¶åï¼Œå› ä¸º demoComponent HAL ä¾èµ– hwbinder è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ <code>hwservice_contexts</code>ã€‚è¿™ä¸ªæ–‡ä»¶åä¹Ÿæ˜¯ç”± SELinux æ¡†æ¶å›ºå®šçš„ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å°†æ–°å¢çš„æ¥å£å®šä¹‰ä¸ºä¸€ä¸ªå®‰å…¨å¯¹è±¡ï¼Œä½œç”¨å’Œ file_contexts ç±»ä¼¼ã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ vndservice_contextsï¼‰</li><li>ä» Android 8.0 å¼€å§‹ï¼ŒSELinux ä¹Ÿä¸€åˆ†ä¸ºäºŒæˆä¸ºäº† system éƒ¨åˆ†å’Œ vendor éƒ¨åˆ†ã€‚å…¶ä¸­ vendor éƒ¨åˆ†åˆå› ä¸ºä¸åŒéƒ¨ä»¶ä½¿ç”¨çš„ binder èŠ‚ç‚¹ä¸åŒï¼Œä»åŸå…ˆå”¯ä¸€çš„çš„ <code>service_contexts</code> ä¸­å‰¥ç¦»å‡ºäº† <code>hwservice_contexts</code> å’Œ <code>vndservice_contexts</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å½“ä½¿ç”¨ &#x2F;dev&#x2F;hwbinder æ—¶æ‰‹åŠ¨åˆ›å»ºå‰è€…å¹¶åœ¨æ–‡ä»¶ä¸­æ·»åŠ å®šä¹‰ï¼Œå½“ä½¿ç”¨ &#x2F;dev&#x2F;vndbinder æ—¶åˆ›å»ºåè€…å¹¶åŒæ ·åœ¨æ–‡ä»¶ä¸­æ·»åŠ å®šä¹‰ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> HAL interface as a security object</span><br>vendor.harman.hardware.demoComponent.demoService::IDemoServiceDef  u:object_r:vendor_demoService_hwservice:s0<br></code></pre></td></tr></table></figure><ul><li><strong>hwservicemanager.te</strong>:<ul><li>ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ hwbinder èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜åº”è¯¥ç¼–å†™ hwservicemanager.teã€‚æ–‡ä»¶åä¹Ÿæ˜¯å›ºå®šçš„ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å£°æ˜ demoService éœ€è¦ä½¿ç”¨ hwbinderã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ vndservicemanager.teï¼‰</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># grant demoService permission of using hwbinder</span><br><span class="hljs-built_in">hwbinder_use</span>(demoService)<br></code></pre></td></tr></table></figure><ul><li><strong>hwservice.te:</strong><ul><li>åŒç†ï¼Œç¼–å†™ <code>hwservice.te</code>ã€‚æ–‡ä»¶åä¾ç„¶æ˜¯å›ºå®šçš„ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¸º demoService å®šä¹‰äº†ä¸“å±çš„ hwservice ç±»å‹ï¼Œåœ¨æ·»åŠ  â€œæ³¨å†ŒæœåŠ¡â€ æƒé™æ—¶ä¼šç”¨åˆ°ã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ <code>vndservice.te</code>ï¼‰</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> demoService as hwservice_manager, so it can be added as a hwservice</span><br>type vendor_demoService_hwservice, hwservice_manager_type;<br></code></pre></td></tr></table></figure><ul><li><strong>demoService.te:</strong><ul><li>æ¥ç€ç¼–å†™ demoService.te æ–‡ä»¶ã€‚ è¿™ä¸ªæ–‡ä»¶é€šå¸¸ä»¥éœ€è¦æ·»åŠ æƒé™çš„å¯¹è±¡ä¸ºåã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸º demoService å®šä¹‰äº†ä¸€ä¸ªä¸“å±çš„å®‰å…¨åŸŸï¼Œèµ‹äºˆå¯ demoService çš„æ‰§è¡Œæ–‡ä»¶ä»¥éœ€è¦çš„æ–‡ä»¶å±æ€§ï¼Œå¹¶ä¸”ä¸º demoService åŸŸæ·»åŠ å’Œ Binder æ“ä½œç›¸å…³çš„å¿…è¦æƒé™ï¼Œæ¯”å¦‚ â€œæ³¨å†Œä¸ºæœåŠ¡â€ã€â€œå…è®¸ hwbinder è°ƒç”¨â€ ç­‰ã€‚</li><li>ä¸åŒçš„ HAL è¿›ç¨‹æˆ–æœ¬åœ°æœåŠ¡è¦æ“ä½œçš„æ–‡ä»¶ä¸åŒï¼Œå…¶å®ç°çš„ä½œç”¨ä¹Ÿä¸åŒï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å·®å¼‚ä¹Ÿå¾ˆå¤§ã€‚ä¾ç…§æœ€å°æƒé™è§„åˆ™ï¼Œæ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦æ·»åŠ æƒé™å³å¯ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> a security domain for demo service</span><br>type demoService, domain;<br><br><span class="hljs-meta"># specify demo service attributes</span><br>type demoService_exec, exec_type, file_type, vendor_file_type;<br><br><span class="hljs-meta"># initialize demo service domain</span><br><span class="hljs-built_in">init_daemon_domain</span>(demoService)<br><br><span class="hljs-built_in">add_hwservice</span>(demoService, vendor_demoService_hwservice)<br><br><span class="hljs-built_in">binder_call</span>(demoService, vndservicemanager)<br><span class="hljs-built_in">binder_call</span>(demoService, hwservicemanager)<br><span class="hljs-built_in">binder_call</span>(demoService, system_app)<br><br>allow demoService vndbinder_device:chr_file rw_file_perms;<br>allow demoService hwservicemanager_prop:file r_file_perms;<br></code></pre></td></tr></table></figure><ul><li><strong>system_app.te:</strong><ul><li>æœ€åï¼Œè¿˜è¦ä¸ºç”¨æˆ·è¿›ç¨‹æ·»åŠ è°ƒç”¨æƒé™ã€‚æˆ‘ä»¬é€šå¸¸ä¼šä»¥ APP å¯¹ demoService çš„è°ƒç”¨ä¸ºä¾‹è¯´æ˜è°ƒç”¨è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ–°å»º <code>system_app.te</code>ã€‚ä¸º system_app æ·»åŠ é€šè¿‡ hwservice_manager æŸ¥æ‰¾æœåŠ¡ã€ä»¥åŠé€šè¿‡ binder è°ƒç”¨ demoService çš„æƒé™ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"># <span class="hljs-function">APP access priviledges <span class="hljs-keyword">for</span> demoService</span><br><span class="hljs-function"><span class="hljs-title">binder_call</span><span class="hljs-params">(system_app, demoService)</span></span><br><span class="hljs-function">allow system_app vendor_demoService_hwservice:hwservice_manager find;</span><br></code></pre></td></tr></table></figure><h3 id="5-2-åº”ç”¨ç­–ç•¥æ–‡ä»¶"><a href="#5-2-åº”ç”¨ç­–ç•¥æ–‡ä»¶" class="headerlink" title="5.2 åº”ç”¨ç­–ç•¥æ–‡ä»¶"></a>5.2 åº”ç”¨ç­–ç•¥æ–‡ä»¶</h3><p>ä¸ºäº†ä½¿æ–°å¢çš„å®‰å…¨è§„åˆ™ç”Ÿæ•ˆï¼Œéœ€è¦å°†åˆšåˆšåˆ›å»ºçš„ç›®å½•æ·»åŠ åˆ° Makefile ä¸­ï¼Œè¿™æ ·ä¸€æ¥ç¼–è¯‘é•œåƒæ—¶å°±å¯ä»¥æ‰«æåˆ°äº†ã€‚æˆ‘ä»¬ä¸€èˆ¬æŠŠè¿™ä¸ªæ”¹åŠ¨æ·»åŠ åˆ° <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/BoardConfig.mk</code>ã€‚</p><p>è¿™é‡Œæˆ‘æ”¹åŠ¨çš„æ–‡ä»¶æ˜¯ <code>/device/harman/broxton/XXXX/BoardConfig.mk</code>ï¼Œä¿®æ”¹éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile">diff --git a/XXXX/BoardConfig.mk b/XXXX/BoardConfig.mk<br>index 4979507a7..8e700f22d 100755<br>--- a/XXXX/BoardConfig.mk<br>+++ b/XXXX/BoardConfig.mk<br>@@ -72,6 +72,12 @@ BOARD_SEPOLICY_DIRS += device/harman/sepolicy/vold<br> INTEL_AUDIO_HAL=imc<br> BOARD_SEPOLICY_DIRS += device/harman/sepolicy/audio<br>+<br>+<span class="hljs-comment">########################################################</span><br>+<span class="hljs-comment"># DemoService</span><br>+<span class="hljs-comment">########################################################</span><br>+BOARD_SEPOLICY_DIRS += device/harman/sepolicy/demoComponent<br>+<br></code></pre></td></tr></table></figure><hr><p><strong>ã€ç»“è¯­ã€‘</strong></p><p>å®Œå…¨ç¼–è¯‘åï¼Œçƒ§å†™é•œåƒåˆ°è®¾å¤‡ä¸Šã€‚å¾…è®¾å¤‡å¯åŠ¨åï¼Œæ‰§è¡Œå‘½ä»¤ <code>ps -A | grep -i demo</code> ï¼Œç»ˆäºå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ demoComponent HAL è¿›ç¨‹å·²ç»éšç³»ç»Ÿå¯åŠ¨æˆåŠŸã€‚</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/2020072020305469.png"><p>å¦‚æœåœ¨ç³»ç»Ÿåˆšå¯åŠ¨æ—¶æ‰§è¡Œå‘½ä»¤ <code>logcat | grep -i demo</code>ï¼Œè¿˜å¯ä»¥çœ‹åˆ° demoComponent HAL æ³¨å†Œä¸º Binder æœåŠ¡çš„æ—¥å¿—æ‰“å°ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200720203133940.png"><h2 id="6-æ„Ÿè°¢"><a href="#6-æ„Ÿè°¢" class="headerlink" title="6.æ„Ÿè°¢"></a>6.æ„Ÿè°¢</h2><p>ğŸŠå†æ¬¡æ„Ÿè°¢å¤§ä½¬ã€Qidi_Huangã€‘çš„ç²¾å½©åšå®¢ï¼</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–è¯‘åŸç†å­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/02/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/02/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°"><a href="#ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°" class="headerlink" title="ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°"></a>ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°</h1><blockquote><p>æœ¬ç³»åˆ—åšå®¢ä¸»è¦è®°å½•è‡ªå·±å­¦ä¹ ç¼–è¯‘åŸç†çš„ç¬”è®°ï¼Œå¹¶æ‰‹å†™ä¸€ä¸ªCè¯­è¨€ç¼–è¯‘å™¨</p><ul><li>â˜ƒï¸<strong>ç¼–è¯‘åŸç†å­¦ä¹ èµ„æ–™</strong>ï¼šå“ˆå·¥å¤§é™ˆé„è€å¸ˆçš„ã€Šç¼–è¯‘åŸç†ã€‹</li></ul></blockquote><ul><li><p>âœï¸ç¬¬ä¸€ç« ï¼š<a href="https://anmuxixixi.github.io/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/">ç¼–è¯‘åŸç†ç»ªè®º</a></p></li><li><p>ğŸ–Šï¸ç¬¬äºŒç« ï¼š<a href="https://anmuxixixi.github.io/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/">è¯æ³•åŠæ–‡æ³•</a></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>äºŒã€è¯­è¨€åŠå…¶æ–‡æ³•</title>
    <link href="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/"/>
    <url>/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="äºŒã€è¯­è¨€åŠæ–‡æ³•"><a href="#äºŒã€è¯­è¨€åŠæ–‡æ³•" class="headerlink" title="äºŒã€è¯­è¨€åŠæ–‡æ³•"></a>äºŒã€è¯­è¨€åŠæ–‡æ³•</h1><h2 id="1-å­—æ¯è¡¨"><a href="#1-å­—æ¯è¡¨" class="headerlink" title="1.å­—æ¯è¡¨"></a>1.å­—æ¯è¡¨</h2><p>å­—æ¯è¡¨Î£æ˜¯ä¸€ä¸ªæœ‰ç©·ç¬¦å·é›†åˆï¼›è¿™é‡Œçš„ç¬¦å·å¯ä»¥æ˜¯å­—æ¯ã€æ•°å­—ã€æ ‡ç‚¹ç¬¦å·â€¦â€¦ä¸‹é¢çš„ä¾‹å­éƒ½æ˜¯å­—æ¯è¡¨</p><ul><li>äºŒè¿›åˆ¶å­—æ¯è¡¨ï¼š{0,1}</li><li>ASCIIå­—ç¬¦é›†</li><li>Unicodeå­—ç¬¦é›†</li></ul><p>å­—æ¯è¡¨æœ‰ä¸‹é¢å‡ ç§è¿ç®—ï¼š</p><ul><li>ä¹˜ç§¯</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235051480.png" alt="image-20230302235051480" style="zoom:50%;"><ul><li>næ¬¡å¹‚</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235116133.png" alt="image-20230302235116133" style="zoom:50%;"><ul><li>æ­£é—­åŒ…</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235140690.png" alt="image-20230302235140690" style="zoom:50%;"><ul><li>å…‹æ—é—­åŒ…</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235156202.png" alt="image-20230302235156202" style="zoom:50%;"><h2 id="2-ä¸²"><a href="#2-ä¸²" class="headerlink" title="2.ä¸²"></a>2.ä¸²</h2><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235218276.png" alt="image-20230302235218276" style="zoom: 50%;"><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ä¸²ä¸Šçš„è¿ç®—ï¼š</p><ul><li>è¿æ¥</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235351581.png" alt="image-20230302235351581" style="zoom: 50%;"><ul><li>å¹‚</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235405401.png" alt="image-20230302235405401" style="zoom:50%;"><h2 id="3-æ–‡æ³•çš„å®šä¹‰"><a href="#3-æ–‡æ³•çš„å®šä¹‰" class="headerlink" title="3.æ–‡æ³•çš„å®šä¹‰"></a>3.æ–‡æ³•çš„å®šä¹‰</h2>]]></content>
    
    
    <categories>
      
      <category>ç¼–è¯‘åŸç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘åŸç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º</title>
    <link href="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/"/>
    <url>/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º"><a href="#ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º" class="headerlink" title="ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º"></a>ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º</h1><h2 id="1-ä»€ä¹ˆæ˜¯ç¼–è¯‘"><a href="#1-ä»€ä¹ˆæ˜¯ç¼–è¯‘" class="headerlink" title="1.ä»€ä¹ˆæ˜¯ç¼–è¯‘"></a>1.ä»€ä¹ˆæ˜¯ç¼–è¯‘</h2><p>ğŸ«<strong>ç¼–è¯‘</strong>ï¼šå°†é«˜çº§è¯­è¨€ã€æºè¯­è¨€ã€‘ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€æˆ–æœºå™¨è¯­è¨€ã€ç›®æ ‡è¯­è¨€ã€‘çš„è¿‡ç¨‹</p><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302225554584.png" alt="image-20230302225554584" style="zoom:67%;"><p>æˆ‘ä»¬æŠŠCè¯­è¨€ä¸­çš„x &#x3D; 2ç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€<code>MOV X,2</code>ï¼Œæˆ–æ˜¯ç›´æ¥ç¼–è¯‘æˆæœºå™¨è¯­è¨€<code>C706 0000 0002</code></p><p><strong>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•´ä¸ªç¼–è¯‘çš„æµç¨‹ï¼š</strong></p><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302225855228.png" alt="image-20230302225855228" style="zoom: 67%;"><ul><li>é¢„å¤„ç†å™¨ï¼šæŠŠå­˜å‚¨åœ¨ä¸åŒæ–‡ä»¶ä¸­çš„æºç¨‹åºèšåˆåœ¨ä¸€èµ·ï¼›æŠŠè¢«ç§°ä¸ºå®çš„ç¼©å†™è¯­å¥è½¬æ¢ä¸ºåŸå§‹è¯­å¥</li><li>å¯é‡å®šä½çš„æœºå™¨ä»£ç ï¼šæ±‡ç¼–å™¨ç”Ÿæˆçš„å¯é‡å®šä½èµ·å§‹ä»£ç åœ¨å†…å­˜ä¸­å­˜æ”¾çš„èµ·å§‹ä½ç½®ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€æœ‰åœ°å€éƒ½æ˜¯ç›¸å¯¹äºèµ·å§‹ä½ç½®çš„ç›¸å¯¹åœ°å€</li><li>åŠ è½½å™¨ï¼šä¿®æ”¹å¯é‡å®šä½åœ°å€ï¼›å°†ä¿®æ”¹åçš„æŒ‡ä»¤å’Œæ•°æ®æ”¾åœ¨å†…å­˜ä¸­é€‚åˆçš„ä½ç½®</li><li>é“¾æ¥å™¨ï¼šå°†å¤šä¸ªå¯é‡å®šä½çš„æœºå™¨ä»£ç æ–‡ä»¶ï¼ˆåŒ…æ‹¬åº“æ–‡ä»¶ï¼‰è¿æ¥åˆ°ä¸€èµ·ï¼›è§£å†³å¤–éƒ¨å†…éƒ¨åœ°å€é—®é¢˜</li></ul><h2 id="2-ç¼–è¯‘å™¨çš„ç»“æ„"><a href="#2-ç¼–è¯‘å™¨çš„ç»“æ„" class="headerlink" title="2.ç¼–è¯‘å™¨çš„ç»“æ„"></a>2.ç¼–è¯‘å™¨çš„ç»“æ„</h2><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302230959458.png" alt="image-20230302230959458" style="zoom:67%;"><p>ç¼–è¯‘å™¨å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>å‰ç«¯éƒ¨åˆ†ï¼Œä¸æºè¯­è¨€ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯ä¸æˆ‘ä»¬å†™çš„é«˜çº§è¯­è¨€C&#x2F;Javaç­‰æœ‰å…³</p></li><li><p>åç«¯éƒ¨åˆ†ï¼Œä¸ç›®æ ‡è¯­è¨€ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆçš„ç›®æ ‡æœºå™¨è¯­è¨€</p></li><li><p>ä¸­é—´éƒ¨åˆ†ï¼šæœºå™¨æ— å…³ä»£ç ä¼˜åŒ–å™¨</p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°</title>
    <link href="/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°"><a href="#kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°" class="headerlink" title="kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°"></a>kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°</h1><blockquote><p>ğŸ›<strong>å¤§éƒ¨åˆ†å†…å®¹è½¬è½½è‡ª</strong>ï¼š</p><ul><li><a href="https://www.cnblogs.com/lifexy/p/7993136.html">https://www.cnblogs.com/lifexy/p/7993136.html</a></li><li><a href="https://blog.csdn.net/skyflying2012/article/details/41078349?spm=1001.2014.3001.5506">https://blog.csdn.net/skyflying2012/article/details/41078349?spm=1001.2014.3001.5506</a></li></ul></blockquote><h2 id="1-åœ¨é©±åŠ¨è°ƒè¯•ä¸­-ä½¿ç”¨printk-æ˜¯æœ€ç®€å•-æœ€æ–¹ä¾¿çš„åŠæ³•"><a href="#1-åœ¨é©±åŠ¨è°ƒè¯•ä¸­-ä½¿ç”¨printk-æ˜¯æœ€ç®€å•-æœ€æ–¹ä¾¿çš„åŠæ³•" class="headerlink" title="1.åœ¨é©±åŠ¨è°ƒè¯•ä¸­,ä½¿ç”¨printk(),æ˜¯æœ€ç®€å•,æœ€æ–¹ä¾¿çš„åŠæ³•"></a>1.åœ¨é©±åŠ¨è°ƒè¯•ä¸­,ä½¿ç”¨printk(),æ˜¯æœ€ç®€å•,æœ€æ–¹ä¾¿çš„åŠæ³•</h2><p>âœ¨<strong>å…ˆè¯´ç»“è®ºï¼Œå½“ubootå‘½ä»¤è¡Œä¸­è®¾ç½®ä¸åŒçš„consoleå‚æ•°ï¼Œè¾“å‡ºåˆ°çš„è®¾å¤‡ä¸åŒï¼š</strong></p><ul><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;tty1â€</strong>æ—¶,è¡¨ç¤ºprintk()è¾“å‡ºåœ¨å¼€å‘æ¿çš„LCDå±ä¸Š</p></li><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;ttySA0,115200â€</strong>æ—¶,è¡¨ç¤ºprintk()è¾“å‡ºåœ¨ä¸²å£UART0ä¸Š,æ³¢ç‰¹ç‡&#x3D;115200</p></li><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;tty1 console&#x3D;ttySA0,115200â€</strong>æ—¶,è¡¨ç¤ºprintk()åŒæ—¶è¾“å‡ºåœ¨ä¸²å£ä¸Š,ä»¥åŠå¼€å‘æ¿çš„LCDå±ä¸Š</p></li></ul><p>å†…æ ¸åˆæ˜¯æ€ä¹ˆæ ¹æ®ä¸Šé¢å‘½ä»¤è¡Œå‚æ•°æ¥ç¡®å®šprintk()çš„è¾“å‡ºè®¾å¤‡ï¼Ÿ</p><h2 id="2-ä»¥console-ttySA0-115200ä¸ºä¾‹åˆ†æprintk"><a href="#2-ä»¥console-ttySA0-115200ä¸ºä¾‹åˆ†æprintk" class="headerlink" title="2.ä»¥console=ttySA0,115200ä¸ºä¾‹åˆ†æprintk"></a>2.ä»¥<code>console=ttySA0,115200</code>ä¸ºä¾‹åˆ†æprintk</h2><h3 id="2-1-å‘½ä»¤è¡Œæ¿€æ´»-setup"><a href="#2-1-å‘½ä»¤è¡Œæ¿€æ´»-setup" class="headerlink" title="2.1 å‘½ä»¤è¡Œæ¿€æ´»__setup"></a>2.1 å‘½ä»¤è¡Œæ¿€æ´»__setup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel\printk\printk.c</span><br>__setup(<span class="hljs-string">&quot;console=&quot;</span>, console_setup);<br></code></pre></td></tr></table></figure><p>**__setup()**çš„ä½œç”¨å°±æ˜¯ï¼šè‹¥ubootä¼ é€’è¿›æ¥çš„å‘½ä»¤è¡Œå­—ç¬¦ä¸²é‡Œå«æœ‰â€œconsole&#x3D;â€,ä¾¿è°ƒç”¨console_setup()å‡½æ•°,å¹¶å¯¹â€œconsole&#x3D;â€åé¢å¸¦çš„å­—ç¬¦ä¸²â€ttySA0,115200â€è¿›è¡Œåˆ†æ</p><h3 id="2-2-è°ƒç”¨console-setupå‡½æ•°"><a href="#2-2-è°ƒç”¨console-setupå‡½æ•°" class="headerlink" title="2.2 è°ƒç”¨console_setupå‡½æ•°"></a>2.2 è°ƒç”¨console_setupå‡½æ•°</h3><p>æˆ‘ä»¬ä»¥ttySA0,115200ä¸ºä¾‹ï¼Œåˆ†æä¸€ä¸ª<code>console_setup</code>å‡½æ•°ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œç»“æ„ä½“å’Œæ•°ç»„åŒåï¼Œéƒ½æ˜¯<code>console_cmdline</code>ï¼ŒåŒºåˆ†ä¸€ä¸‹ğŸ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CMDLINECONSOLES 8</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">char</span>name[<span class="hljs-number">16</span>];<span class="hljs-comment">/* Name of the driver    */</span><br><span class="hljs-type">int</span>    index;<span class="hljs-comment">/* Minor dev. to use    */</span><br><span class="hljs-type">char</span>*options;<span class="hljs-comment">/* Options for the driver   */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span> <span class="hljs-title">console_cmdline</span>[<span class="hljs-title">MAX_CMDLINECONSOLES</span>];</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">console_setup</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span>                    <span class="hljs-comment">//*str=&quot;ttySA0,115200&quot;</span><br>&#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-keyword">sizeof</span>(console_cmdline[<span class="hljs-number">0</span>].name)];     <span class="hljs-comment">// char name[16]</span><br>    <span class="hljs-type">char</span> *s, *options;<br>    <span class="hljs-type">int</span> idx; <br><br>    <span class="hljs-keyword">if</span> (str[<span class="hljs-number">0</span>] &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; str[<span class="hljs-number">0</span>] &lt;= <span class="hljs-string">&#x27;9&#x27;</span>) &#123;                    <br>            <span class="hljs-built_in">strcpy</span>(name, <span class="hljs-string">&quot;ttyS&quot;</span>);<br>            <span class="hljs-built_in">strncpy</span>(name + <span class="hljs-number">4</span>, str, <span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">5</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">strncpy</span>(name, str, <span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">1</span>);   <span class="hljs-comment">//*name=&quot;ttySA0,115200&quot;</span><br>    &#125;<br><br>    name[<span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;  <br>    <span class="hljs-keyword">if</span> ((options = <span class="hljs-built_in">strchr</span>(str, <span class="hljs-string">&#x27;,&#x27;</span>)) != <span class="hljs-literal">NULL</span>)   <span class="hljs-comment">// æ‰¾åˆ°&#x27;,&#x27;,è¿”å›ç»™options</span><br>            *(options++) = <span class="hljs-number">0</span>;                <span class="hljs-comment">//*options=&quot;115200&quot;</span><br><br><br>    <span class="hljs-keyword">for</span> (s = name; *s; s++)                                     <span class="hljs-comment">//*s=&quot;0&quot;</span><br>            <span class="hljs-keyword">if</span> ((*s &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; *s &lt;= <span class="hljs-string">&#x27;9&#x27;</span>) || *s == <span class="hljs-string">&#x27;,&#x27;</span>)<br>                    <span class="hljs-keyword">break</span>;<br><br>idx = simple_strtoul(s, <span class="hljs-literal">NULL</span>, <span class="hljs-number">10</span>);   <span class="hljs-comment">//å’Œstrtoul()ä¸€æ ·,å°†sä¸­çš„&quot;0&quot;æå‡ºæ¥,æ‰€ä»¥idx=0</span><br>    *s = <span class="hljs-number">0</span>;<br><br>add_preferred_console(name, idx, options);      <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å’Œæ³¨é‡Šå¾—åˆ°ï¼Œæœ€ç»ˆè°ƒç”¨add_preferred_console(â€œttySAâ€, 0, â€œ115200â€)å‡½æ•°æ¥æ·»åŠ æ§åˆ¶å°</p><h3 id="2-3-è°ƒç”¨add-preferred-consoleå‡½æ•°"><a href="#2-3-è°ƒç”¨add-preferred-consoleå‡½æ•°" class="headerlink" title="2.3 è°ƒç”¨add_preferred_consoleå‡½æ•°"></a>2.3 è°ƒç”¨add_preferred_consoleå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">add_preferred_console</span><span class="hljs-params">(<span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> idx, <span class="hljs-type">char</span> *options)</span><br>&#123;<br><span class="hljs-keyword">return</span> __add_preferred_console(name, idx, options, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __add_preferred_console(<span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> idx, <span class="hljs-type">char</span> *options, <span class="hljs-type">char</span> *brl_options)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">int</span> i;<br><br>    <span class="hljs-comment">// MAX_CMDLINECONSOLES=8,è¡¨ç¤ºæœ€å¤šæ·»åŠ 8ä¸ªæ§åˆ¶å°</span><br>    <span class="hljs-comment">// è¿™æ˜¯ç›´æ¥å°†cæŒ‡å‘äº†å…¨å±€å˜é‡console_cmdline</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, c = console_cmdline; i &lt; MAX_CMDLINECONSOLES &amp;&amp; c-&gt;name[<span class="hljs-number">0</span>]; i++, c++) &#123;<br>        <span class="hljs-comment">// è¯¥consoleåå­—å’Œä¸‹æ ‡å¥½å·²ç»å­˜åœ¨äº†ã€ç›®çš„æ˜¯ä¸ºäº†å»é‡ã€‘</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(c-&gt;name, name) == <span class="hljs-number">0</span> &amp;&amp; c-&gt;index == idx) &#123;<br><span class="hljs-keyword">if</span> (!brl_options)<br>selected_console = i;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br>    <br>    <span class="hljs-comment">// i == 8,è¡¨ç¤ºæ•°ç»„å­˜æ»¡äº†</span><br><span class="hljs-keyword">if</span> (i == MAX_CMDLINECONSOLES)<br><span class="hljs-keyword">return</span> -E2BIG;<br><span class="hljs-keyword">if</span> (!brl_options)<br>selected_console = i; <span class="hljs-comment">// å°†selected_consoleè®¾ç½®ä¸ºæœ€æ–°æ·»åŠ çš„console_cmdlineçš„ä¸‹æ ‡å·</span><br><br>strlcpy(c-&gt;name, name, <span class="hljs-keyword">sizeof</span>(c-&gt;name));<br>c-&gt;options = options;<br>braille_set_options(c, brl_options);<br><br>c-&gt;index = idx;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__add_preferred_console</code>å°†name idx optionsä¿å­˜åˆ°æ•°ç»„ä¸‹ä¸€ä¸ªæˆå‘˜console_cmdlineç»“æ„ä½“ä¸­ï¼Œå¦‚æœæ•°ç»„ä¸­å·²æœ‰é‡åï¼Œåˆ™ä¸æ·»åŠ ï¼Œå¹¶ç½®selected_consoleä¸ºæœ€æ–°æ·»åŠ çš„console_cmdlineçš„ä¸‹æ ‡å·ã€‚</p><p>æ¯”å¦‚cmdlineä¸­æœ‰â€œconsole&#x3D;ttyS0,115200 console&#x3D;ttyS1,9600â€</p><p>åˆ™åœ¨console_cmdline[8]æ•°ç»„ä¸­console_cmdline[0]ä»£è¡¨ttyS0ï¼Œconsole_cmdline[1]ä»£è¡¨ttyS1ï¼Œè€Œselected_console&#x3D;1.</p><h3 id="2-4-kernelä¸‹å¦‚ä½•é€‰æ‹©printk-console"><a href="#2-4-kernelä¸‹å¦‚ä½•é€‰æ‹©printk-console" class="headerlink" title="2.4 kernelä¸‹å¦‚ä½•é€‰æ‹©printk console"></a>2.4 kernelä¸‹å¦‚ä½•é€‰æ‹©printk console</h3><p>æ ¹æ®<a href="https://anmuxixixi.github.io/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/">printkçš„å®ç°åŸç†</a>ï¼Œprintkæœ€åè°ƒç”¨console_unlockå®ç°log_bufæ•°æ®åˆ·å‡ºåˆ°æŒ‡å®šè®¾å¤‡ã€‚</p><p>è¿™é‡Œå…ˆä¸å…³å¿ƒprintkå¦‚ä½•å¤„ç†log bufæ•°æ®(æ¯”å¦‚æ·»åŠ å†…å®¹çº§åˆ«)ï¼Œåªå…³å¿ƒprintkå¦‚ä½•ä¸€æ­¥æ­¥æ‰¾åˆ°æŒ‡å®šçš„è¾“å‡ºè®¾å¤‡ï¼Œæ ¹æ®printk.cä»£ç ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹çº¿ç´¢ã€‚</p><p><strong>printk-&gt;vprintk-&gt;console_unlock-&gt;call_console_drivers</strong></p><p>çœ‹çº¿ç´¢æœ€åº•å±‚çš„call_console_drivers</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">console_drivers</span>;</span> <span class="hljs-comment">// å…¨å±€</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> for_each_console(con) \</span><br><span class="hljs-meta">for (con = console_drivers; con != NULL; con = con-&gt;next)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">call_console_drivers</span><span class="hljs-params">(<span class="hljs-type">int</span> level, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *text, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">con</span>;</span><br><br>trace_console(text, len);<br><br><span class="hljs-keyword">if</span> (level &gt;= console_loglevel &amp;&amp; !ignore_loglevel)<br><span class="hljs-keyword">return</span>;<br><span class="hljs-keyword">if</span> (!console_drivers)<br><span class="hljs-keyword">return</span>;<br><br>for_each_console(con) &#123;<br><span class="hljs-keyword">if</span> (exclusive_console &amp;&amp; con != exclusive_console)  <span class="hljs-comment">// å¦‚æœæŒ‡æ˜äº†å”¯ä¸€çš„consoleï¼Œä¸”å½“å‰ä¸æ˜¯é‚£ä¸ªconsole</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!(con-&gt;flags &amp; CON_ENABLED))  <span class="hljs-comment">// å½“å‰çš„consoleä¸æ˜¯enabledçš„</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!con-&gt;write)   <span class="hljs-comment">// å½“å‰consoleæ²¡æœ‰writeå‡½æ•°</span><br><span class="hljs-keyword">continue</span>;<br>con-&gt;write(con, text, len);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>éå†console_driversé“¾è¡¨æ‰€æœ‰console structï¼Œè°ƒç”¨æ‰€æœ‰<u><strong>ENABLE</strong></u>çš„consoleçš„writeæ–¹æ³•å°†log bufä¸­startåˆ°endçš„å†…å®¹å‘å‡ºã€‚</p><blockquote><p>åˆ°è¿™é‡Œå°±å¾ˆæ˜äº†äº†ï¼Œkernelä¸‹æ¯æ¬¡printkæ‰“å°ï¼Œé¦–å…ˆå­˜log_bufï¼Œç„¶åéå†console_driversï¼Œæ‰¾åˆ°åˆé€‚consoleï¼Œåˆ·å‡ºlogã€‚</p><p>console_driversé“¾è¡¨çš„æˆå‘˜æ˜¯å“ªé‡Œæ¥çš„ï¼Œæ¥ç€æ¥çœ‹ä¸‹ä¸€éƒ¨åˆ†ï¼Œkernelä¸‹consoleçš„æ³¨å†Œ</p></blockquote><h3 id="2-5-consoleé©±åŠ¨æ³¨å†Œ"><a href="#2-5-consoleé©±åŠ¨æ³¨å†Œ" class="headerlink" title="2.5 consoleé©±åŠ¨æ³¨å†Œ"></a>2.5 consoleé©±åŠ¨æ³¨å†Œ</h3><p>æ¥ä¸‹æ¥æ¥æœç´¢è¯¥æ•°ç»„ï¼Œçœ‹çœ‹printk()å¦‚ä½•è°ƒç”¨æ§åˆ¶å°çš„ç¡¬ä»¶å¤„ç†å‡½æ•°çš„ã€‚æœç´¢åˆ°åœ¨<code>Printk.c</code>é‡Œçš„<code>register_console(struct console *console)</code>å‡½æ•°,æœ‰ç”¨åˆ°console_cmdline[]</p><p>æ˜¾ç„¶,register_console()å‡½æ•°å°±ç”¨æ¥æ³¨å†Œæ§åˆ¶å°çš„,ç»§ç»­æœç´¢register_console</p><img src="/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/image-20230225225234632.png" alt="image-20230225225234632" style="zoom:67%;"><p>æˆ‘ä»¬ä»¥<code>drivers\tty\serial\serial_ks8695.c</code>ä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ks8695_console_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>add_preferred_console(SERIAL_KS8695_DEVNAME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>register_console(&amp;ks8695_console);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>console_initcall(ks8695_console_init); <span class="hljs-comment">// å£°æ˜æ§åˆ¶å°åˆå§‹åŒ–å‡½æ•°</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢é€šè¿‡register_console()æ¥æ³¨å†Œ<code>ks8695_console</code>ç»“æ„ä½“,è¯¥ç»“æ„ä½“æˆå‘˜å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERIAL_KS8695_DEVNAME<span class="hljs-string">&quot;ttyAM&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> <span class="hljs-title">ks8695_console</span> =</span> &#123;<br>.name= SERIAL_KS8695_DEVNAME,  <span class="hljs-comment">// æ§åˆ¶å°åç§°</span><br>.write= ks8695_console_write,   <span class="hljs-comment">// æ‰“å°ä¸²å£æ•°æ®çš„ç¡¬ä»¶å¤„ç†å‡½æ•°</span><br>.device= uart_console_device,    <span class="hljs-comment">// ttyé©±åŠ¨</span><br>.setup= ks8695_console_setup,   <span class="hljs-comment">// ç”¨æ¥è®¾ç½®UARTçš„æ³¢ç‰¹ç‡ï¼Œå‘é€ï¼Œæ¥æ”¶ç­‰åŠŸèƒ½</span><br>.flags= CON_PRINTBUFFER,        <span class="hljs-comment">// æ ‡å¿—ä½</span><br>.index= <span class="hljs-number">-1</span>,                     <span class="hljs-comment">// ç´¢å¼•</span><br>.data= &amp;ks8695_reg,            <span class="hljs-comment">// å¯„å­˜å™¨</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨register_console()é‡Œï¼Œä¾¿ä¼šé€šè¿‡<code>ttyAM</code>æ¥åŒ¹é…console_cmdline[i]çš„åç§°,å½“åŒ¹é…æˆåŠŸï¼Œprintk()è°ƒç”¨çš„consoleç»“æ„ä½“ä¾¿æ˜¯ks8695_consoleäº†</p><p>â˜ƒï¸å½“é©±åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šèµ°åˆ°MODULE_INITï¼Œç„¶åèµ°åˆ°å¯¹åº”é©±åŠ¨æ³¨å†Œçš„initå‡½æ•°ä¸­ï¼Œåœ¨è¿™é‡Œå°±æ˜¯<code>ks8695_console_init</code>ï¼Œç´§æ¥ç€ä¼šè°ƒç”¨<code>register_console</code>ï¼Œè¿™é‡Œçš„register_consoleå°±æ˜¯<code>printk.c</code>ä¸­çš„register_consoleã€‚</p><hr><p>å› æ­¤æˆ‘ä»¬æ¥çœ‹ä¸‹printk.cä¸­çš„register_console</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_console</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> console *newcon)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">bcon</span> =</span> <span class="hljs-literal">NULL</span>;<br> <br>    <span class="hljs-comment">//å¦‚æœæ³¨å†Œçš„æ˜¯bootconsoleï¼ˆkernelæ—©æœŸå¯åŠ¨æ‰“å°ï¼‰ï¼Œéœ€è¦æ£€æŸ¥console_driversä¸­</span><br>    <span class="hljs-comment">//æ²¡æœ‰â€œreal consoleâ€ä¹Ÿå°±æ˜¯è¯´bootconsoleå¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªæ³¨å†Œçš„consoleã€‚</span><br>    <span class="hljs-keyword">if</span> (console_drivers &amp;&amp; newcon-&gt;flags &amp; CON_BOOT) &#123;<br>        <span class="hljs-comment">/* find the last or real console */</span><br>        for_each_console(bcon) &#123;<br>            <span class="hljs-keyword">if</span> (!(bcon-&gt;flags &amp; CON_BOOT)) &#123;<br>                printk(KERN_INFO <span class="hljs-string">&quot;Too late to register bootconsole %s%d\n&quot;</span>,<br>                    newcon-&gt;name, newcon-&gt;index);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">if</span> (console_drivers &amp;&amp; console_drivers-&gt;flags &amp; CON_BOOT)<br>        bcon = console_drivers;<br> <br>    <span class="hljs-comment">//preferred consoleä¸ºconsole_cmdlineä¸­æœ€åä¸€ä¸ªconsole</span><br>    <span class="hljs-keyword">if</span> (preferred_console &lt; <span class="hljs-number">0</span> || bcon || !console_drivers)<br>        preferred_console = selected_console;<br> <br>    <span class="hljs-keyword">if</span> (newcon-&gt;early_setup)<br>        newcon-&gt;early_setup();<br> <br>    <span class="hljs-keyword">if</span> (preferred_console &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &lt; <span class="hljs-number">0</span>)<br>            newcon-&gt;index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;setup == <span class="hljs-literal">NULL</span> ||<br>            newcon-&gt;setup(newcon, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">0</span>) &#123;<br>            newcon-&gt;flags |= CON_ENABLED;<br>            <span class="hljs-keyword">if</span> (newcon-&gt;device) &#123;<br>                newcon-&gt;flags |= CON_CONSDEV;<br>                preferred_console = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-comment">//æ£€æŸ¥newconæ˜¯å¦æ˜¯cmdlineæŒ‡å®šçš„consoleï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä½¿èƒ½(CON_ENABLE)å¹¶åˆå§‹åŒ–è¯¥console</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_CMDLINECONSOLES &amp;&amp; console_cmdline[i].name[<span class="hljs-number">0</span>];<br>            i++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(console_cmdline[i].name, newcon-&gt;name) != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &gt;= <span class="hljs-number">0</span> &amp;&amp;<br>            newcon-&gt;index != console_cmdline[i].index)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &lt; <span class="hljs-number">0</span>)<br>            newcon-&gt;index = console_cmdline[i].index;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;setup &amp;&amp;<br>            newcon-&gt;setup(newcon, console_cmdline[i].options) != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">break</span>;<br>        newcon-&gt;flags |= CON_ENABLED;<br>        newcon-&gt;index = console_cmdline[i].index;<br>        <span class="hljs-keyword">if</span> (i == selected_console) &#123;<br>            <span class="hljs-comment">//å¦‚æœnewconæ˜¯cmdlineæŒ‡å®šçš„æœ€æ–°çš„consoleï¼Œåˆ™ç½®ä½CONSDEV</span><br>            newcon-&gt;flags |= CON_CONSDEV;<br>            preferred_console = selected_console;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">//è¯¥consoleæ²¡æœ‰ä½¿èƒ½ï¼Œé€€å‡º</span><br>    <span class="hljs-keyword">if</span> (!(newcon-&gt;flags &amp; CON_ENABLED))<br>        <span class="hljs-keyword">return</span>;<br> <br>    <span class="hljs-comment">//å¦‚æœæœ‰bootconsoleï¼Œåˆ™newconä¸éœ€è¦è¾“å‡ºregisterä¹‹å‰çš„logï¼Œå› ä¸ºå¦‚æœbootconsoleå’Œnewconæ˜¯åŒä¸€ä¸ªè®¾å¤‡</span><br>    <span class="hljs-comment">//åˆ™ä¹‹å‰çš„logå°±è¾“å‡º2æ¬¡</span><br>    <span class="hljs-keyword">if</span> (bcon &amp;&amp; ((newcon-&gt;flags &amp; (CON_CONSDEV | CON_BOOT)) == CON_CONSDEV))<br>        newcon-&gt;flags &amp;= ~CON_PRINTBUFFER;<br> <br>    <span class="hljs-comment">//æŠŠnewconåŠ å…¥console_driversé“¾è¡¨ï¼Œå¯¹äºç½®ä½CON_CONSDEVçš„conï¼Œæ”¾åœ¨é“¾è¡¨é¦–</span><br>    console_lock();<br>    <span class="hljs-keyword">if</span> ((newcon-&gt;flags &amp; CON_CONSDEV) || console_drivers == <span class="hljs-literal">NULL</span>) &#123;<br>        newcon-&gt;next = console_drivers;<br>        console_drivers = newcon;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;next)<br>            newcon-&gt;next-&gt;flags &amp;= ~CON_CONSDEV;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        newcon-&gt;next = console_drivers-&gt;next;<br>        console_drivers-&gt;next = newcon;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (newcon-&gt;flags &amp; CON_PRINTBUFFER) &#123;<br>        <span class="hljs-comment">//å¦‚æœnewconç½®ä½PRINTBUFFER,åˆ™å°†logå…¨éƒ¨åˆ·å‡º</span><br>        raw_spin_lock_irqsave(&amp;logbuf_lock, flags);<br>        con_start = log_start;<br>        raw_spin_unlock_irqrestore(&amp;logbuf_lock, flags);<br>        <span class="hljs-comment">//ä¿®æ”¹printkè¾“å‡ºçš„æŒ‡å®šå”¯ä¸€exclusive_consoleä¸ºnewcon</span><br>        <span class="hljs-comment">//ä¿è¯å°†ä¹‹å‰çš„logåªè¾“å‡ºåˆ°newcon</span><br>        exclusive_console = newcon;<br>    &#125;<br>    <span class="hljs-comment">//è§£é”consoleï¼Œåˆ·å‡ºlogåˆ°newcon</span><br>    console_unlock();<br>    console_sysfs_notify();<br> <br>    <span class="hljs-comment">//å¦‚æœæœ‰bootconsoleï¼Œåˆ™unregister bootconsoleï¼ˆä»console_driversä¸­åˆ æ‰ï¼‰</span><br>    <span class="hljs-comment">//å¹¶å‘Šè¯‰ä½¿ç”¨è€…ç°åœ¨consoleåˆ‡æ¢</span><br>    <span class="hljs-keyword">if</span> (bcon &amp;&amp;<br>        ((newcon-&gt;flags &amp; (CON_CONSDEV | CON_BOOT)) == CON_CONSDEV) &amp;&amp;<br>        !keep_bootcon) &#123;<br>        printk(KERN_INFO <span class="hljs-string">&quot;console [%s%d] enabled, bootconsole disabled\n&quot;</span>,<br>            newcon-&gt;name, newcon-&gt;index);<br>        for_each_console(bcon)<br>            <span class="hljs-keyword">if</span> (bcon-&gt;flags &amp; CON_BOOT)<br>                unregister_console(bcon);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        printk(KERN_INFO <span class="hljs-string">&quot;%sconsole [%s%d] enabled\n&quot;</span>,<br>            (newcon-&gt;flags &amp; CON_BOOT) ? <span class="hljs-string">&quot;boot&quot;</span> : <span class="hljs-string">&quot;&quot;</span> ,<br>            newcon-&gt;name, newcon-&gt;index);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¹‹å‰æ³¨å†Œäº†bootconsoleï¼Œåˆ™ä¸ä¼šå°†è¯¥æ¬¡registerä¹‹å‰çš„logåˆ·å‡ºï¼Œé˜²æ­¢bootconsoleå’Œè¯¥æ¬¡æ³¨å†Œçš„newconæ˜¯åŒä¸€ä¸ªç‰©ç†è®¾å¤‡æ—¶ï¼Œlogæ‰“å°2æ¬¡ã€‚</p><p>å¦‚æœæ²¡æœ‰bootconsoleï¼Œåˆ™ä¼šæŒ‡å®šexclusive_console&#x3D;newconï¼Œconsole_unlockæ—¶ï¼Œåˆ·æ–°å…¨éƒ¨logåˆ°è¯¥æŒ‡å®šexclusive consoleã€‚</p><p>console_unlockç»“æŸæ—¶ä¼šå°†exclusive_consoleç½®NULLï¼Œæ‰€ä»¥exclusive consoleé»˜è®¤æƒ…å†µä¸‹å°±æ˜¯NULLã€‚</p><p>æœ€åä¼šunregister bootconsoleï¼Œæ˜¯å°†bootconsoleä»console_driversä¸­åˆ é™¤ï¼Œè¿™æ ·ä¹‹åçš„printkå°±ä¸ä¼šå‘bootconsoleè¾“å‡ºäº†ã€‚</p><p>æœ‰æ„æ€çš„ä¸€ä¸ªåœ°æ–¹æ˜¯ï¼Œåœ¨unregister bootconsoleä¹‹å‰çš„printkï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">printk(KERN_INFO <span class="hljs-string">&quot;console [%s%d] enabled, bootconsole disabled\n&quot;</span>,<br>            newcon-&gt;name, newcon-&gt;index);<br></code></pre></td></tr></table></figure><p><u>å› ä¸ºæ­¤æ—¶bootconsoleè¿˜æ²¡åˆ æ‰ï¼Œè€Œnewconsoleå·²ç»åŠ å…¥console_driversï¼Œå¦‚æœbootconsoleå’Œnewconsoleæ˜¯åŒä¸€ä¸ªç‰©ç†è®¾å¤‡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™å¥printkä¼šå‡ºç°2æ¬¡å“¦ï¼</u></p><p>å¦‚æœåœ¨cmdlineæŒ‡å®š2ä¸ªI&#x2F;Oè®¾å¤‡ï¼Œå¦‚<code>&quot;console==ttyS0,115200 console=ttyS1,115200&quot;</code>ï¼Œå› ttySè®¾å¤‡éƒ½æ˜¯serial driverä¸­æ³¨å†Œçš„real consoleï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°kernelçš„æ‰“å°åˆ†åˆ«å‡ºç°åœ¨2ä¸ªä¸²å£ä¸Šï¼</p><p><u><strong>boot console</strong>å’Œ<strong>real console</strong>å·®åˆ«åœ¨äºbootconsoleæ³¨å†Œäºkernelå¯åŠ¨æ—©æœŸï¼Œæ–¹ä¾¿å¯¹äºkernelæ—©æœŸå¯åŠ¨è¿›è¡Œè°ƒè¯•æ‰“å°ã€‚</u></p><p>é‚£è¿™äº›consoleæ˜¯åœ¨å“ªé‡Œè°ƒç”¨register_consoleè¿›è¡Œæ³¨å†Œçš„ï¼Ÿ</p><ul><li><p>bootconsoleçš„æ³¨å†Œï¼Œå¦‚arch&#x2F;arm&#x2F;kernel&#x2F;early_printk.cï¼Œæ˜¯åœ¨parse_argså‚æ•°è§£æé˜¶æ®µæ³¨å†Œbootconsoleã€‚</p><ul><li>åœ¨start_kernelä¸­console_initå‡½æ•°ä¹Ÿä¼šéå†.con_initcall.initæ®µä¸­æ‰€æœ‰æ³¨å†Œå‡½æ•°ï¼Œè€Œè¿™äº›æ³¨å†Œå‡½æ•°ä¹Ÿå¯ä»¥æ¥æ³¨å†Œbootconsoleã€‚</li><li>.con_initcall.initæ®µä¸­å‡½æ•°çš„æ³¨å†Œå¯ä»¥ä½¿ç”¨å®å®šä¹‰console_initcallã€‚è¿™äº›å‡½æ•°ä¸­è°ƒç”¨register_consoleï¼Œæ–¹ä¾¿åœ¨kernelåˆæœŸå®ç°printkæ‰“å°ã€‚</li></ul></li><li><p>realconsoleçš„æ³¨å†Œï¼Œæ˜¯åœ¨å„ä¸ªdriverï¼Œå¦‚serialåŠ è½½æ—¶å®Œæˆã€‚</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†</title>
    <link href="/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/"/>
    <url>/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/</url>
    
    <content type="html"><![CDATA[<h1 id="linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†"><a href="#linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†" class="headerlink" title="linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†"></a>linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†</h1><blockquote><p>ğŸ•è½¬è½½è‡ªï¼š<a href="https://mp.weixin.qq.com/s/mdDLw6AIp9ws9LTaHg64pg">https://mp.weixin.qq.com/s/mdDLw6AIp9ws9LTaHg64pg</a></p><p>ğŸ¥¯æ„Ÿè°¢å¤§ä½¬ç²¾å½©çš„æ–‡ç« ï¼ï¼ï¼</p></blockquote><p><img src="/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/image-20230221230542976.png" alt="image-20230221230542976">æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™å¼ å›¾ï¼Œæ¥ç†è§£printkçš„æ•´ä½“æ¶æ„ã€‚</p><h2 id="1-printkå®ç°ç®€è¿°"><a href="#1-printkå®ç°ç®€è¿°" class="headerlink" title="1.printkå®ç°ç®€è¿°"></a>1.printkå®ç°ç®€è¿°</h2><h3 id="1-1-å†…æ ¸æ€printk"><a href="#1-1-å†…æ ¸æ€printk" class="headerlink" title="1.1 å†…æ ¸æ€printk"></a>1.1 å†…æ ¸æ€printk</h3><p>åœ¨å†…æ ¸ç¼–ç æ—¶ï¼Œå¦‚æœæƒ³è¦è¾“å‡ºä¸€äº›ä¿¡æ¯ï¼Œé€šå¸¸å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨printkï¼Œè€Œæ˜¯ä¼šä½¿ç”¨å…¶è¡ç”Ÿå‡½æ•°ï¼Œæ¯”å¦‚ pr_err &#x2F; pr_info &#x2F; pr_debug ç­‰ï¼Œè¿™äº›è¡ç”Ÿå‡½æ•°é™„å¸¦äº†æ—¥å¿—çº§åˆ«ã€æ‰€å±æ¨¡å—ç­‰å…¶ä»–ä¿¡æ¯ï¼Œæ¯”è¾ƒå‹å¥½ï¼Œä½†å…¶æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†printkã€‚</p><p>printkå‡½æ•°ä¼šå°†æ¯æ¬¡è¾“å‡ºçš„æ—¥å¿—ï¼Œæ”¾åˆ°å†…æ ¸ä¸ºå…¶ä¸“é—¨åˆ†é…çš„åä¸º<strong>ring buffer</strong>çš„ä¸€ä¸ªæ§½ä½é‡Œã€‚</p><ul><li><p>ring bufferå…¶å®å°±æ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œä¸è¿‡æ—¢ç„¶æ˜¯ç¯å½¢é˜Ÿåˆ—ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå³å½“ring bufferæ»¡äº†çš„æ—¶å€™ï¼Œä¸‹ä¸€æ¡æ–°çš„æ—¥å¿—ï¼Œä¼šè¦†ç›–æœ€å¼€å§‹çš„æ—§çš„æ—¥å¿—ã€‚</p></li><li><p>ring bufferçš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸å‚æ•°æ¥ä¿®æ”¹ã€‚</p></li><li><p>printkåœ¨å°†æ—¥å¿—æ”¾åˆ°ring bufferåï¼Œä¼šå†è°ƒç”¨ç³»ç»Ÿconsoleçš„ç›¸å…³æ–¹æ³•ï¼Œå°†è¿˜æœªè¾“å‡ºåˆ°ç³»ç»Ÿæ§åˆ¶å°çš„æ¶ˆæ¯ï¼Œç»§ç»­è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¿™ä¸ªåé¢ä¼šè¯¦ç»†è¯´ï¼Œè¿™é‡Œå°±æš‚ä¸èµ˜è¿°ã€‚</p></li></ul><p>ä»¥ä¸Šå°±æ˜¯printkåœ¨å†…æ ¸æ€çš„å®ç°ã€‚</p><h3 id="1-2-ç”¨æˆ·æ€printk"><a href="#1-2-ç”¨æˆ·æ€printk" class="headerlink" title="1.2 ç”¨æˆ·æ€printk"></a>1.2 ç”¨æˆ·æ€printk</h3><p>åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªæ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹printkè¾“å‡ºçš„å†…æ ¸æ—¥å¿—ï¼Œæ¯”å¦‚ä½¿ç”¨dmesgå‘½ä»¤ï¼Œcat &#x2F;proc&#x2F;kmsgæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨klogctlå‡½æ•°ç­‰ï¼Œè¿™äº›æ–¹å¼åˆ†åˆ«å¯¹åº”äºå…¨æ™¯å›¾ä¸­ç”¨æˆ·æ€çš„æ©™è‰²ã€ç»¿è‰²ã€å’Œè“è‰²çš„éƒ¨åˆ†ã€‚</p><p><strong>ï¼ˆ1ï¼‰dmesgå‘½ä»¤</strong></p><p><strong>dmesgå‘½ä»¤ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯é€šè¿‡è¯»å–&#x2F;dev&#x2F;kmsgæ–‡ä»¶</strong>ï¼Œæ¥å®ç°æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„ã€‚</p><p>å½“è¯¥å‘½ä»¤è¿è¡Œæ—¶ï¼Œdmesgä¼šå…ˆè°ƒç”¨openå‡½æ•°ï¼Œæ‰“å¼€&#x2F;dev&#x2F;kmsgæ–‡ä»¶ï¼Œè¯¥æ‰“å¼€æ“ä½œåœ¨å†…æ ¸ä¸­çš„é€»è¾‘ï¼Œä¼šä¸ºdmesgåˆ†é…ä¸€ä¸ªfileå®ä¾‹ï¼Œåœ¨è¿™ä¸ªfileå®ä¾‹é‡Œï¼Œä¼šæœ‰ä¸€ä¸ªseqå˜é‡ï¼Œè¯¥å˜é‡è®°å½•ç€ä¸‹ä¸€æ¡è¦è¯»å–çš„å†…æ ¸æ—¥å¿—åœ¨ring bufferä¸­çš„ä½ç½®ã€‚</p><p>åˆšæ‰“å¼€&#x2F;dev&#x2F;kmsgæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªseqæŒ‡å‘çš„å°±æ˜¯ring bufferä¸­æœ€å¼€å§‹çš„é‚£æ¡æ—¥å¿—ã€‚</p><p>ä¹‹åï¼Œdmesgä¼šä»¥æ‰“å¼€çš„&#x2F;dev&#x2F;kmsgæ–‡ä»¶ä¸ºåª’ä»‹ï¼Œä¸æ–­çš„è°ƒç”¨readå‡½æ•°ï¼Œä»å†…æ ¸ä¸­è¯»å–æ—¥å¿—æ¶ˆæ¯ï¼Œæ¯è¯»å–å‡ºä¸€æ¡ï¼Œseqçš„å€¼éƒ½ä¼šåŠ ä¸€ï¼Œå³æŒ‡å‘ä¸‹ä¸€æ¡æ—¥å¿—çš„ä½ç½®ï¼Œä¾æ¬¡å¾€å¤ï¼Œç›´åˆ°æ‰€æœ‰çš„å†…æ ¸æ—¥å¿—è¯»å–å®Œæ¯•ï¼Œdmesgé€€å‡ºã€‚</p><p>ä»¥ä¸Šå°±æ˜¯dmesgçš„ä¸»ä½“å®ç°ã€‚</p><p><strong>ï¼ˆ2ï¼‰cat &#x2F;proc&#x2F;kmsg å‘½ä»¤</strong></p><p>ç¬¬äºŒç§æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡ cat &#x2F;proc&#x2F;kmsg å‘½ä»¤ã€‚</p><p>è¯¥å‘½ä»¤å’Œdmesgå‘½ä»¤çš„å®ç°æœºåˆ¶åŸºæœ¬ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡è¯»æ–‡ä»¶ï¼Œåªä¸è¿‡catè¯»å–çš„æ˜¯&#x2F;proc&#x2F;kmsgæ–‡ä»¶ï¼Œè€Œdmesgè¯»å–çš„æ˜¯&#x2F;dev&#x2F;kmsgæ–‡ä»¶ã€‚</p><p>è¯»å–è¿™ä¸¤ä¸ªæ–‡ä»¶æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œ&#x2F;dev&#x2F;kmsgæ–‡ä»¶æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œå†…æ ¸éƒ½ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå•ç‹¬çš„seqå˜é‡ï¼Œè€Œ&#x2F;proc&#x2F;kmsgæ–‡ä»¶æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå…¨å±€çš„é™æ€seqå˜é‡ï¼Œå«åšsyslog_seqã€‚</p><p>syslog_seqæŒ‡å‘çš„ä¹Ÿæ˜¯ä¸‹ä¸€æ¡è¦è¯»å–çš„å†…æ ¸æ—¥å¿—åœ¨ring bufferä¸­çš„ä½ç½®ï¼Œä½†å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡ï¼Œå½“æœ‰å¤šä¸ªè¿›ç¨‹è¦è¯»å–&#x2F;proc&#x2F;kmsgæ–‡ä»¶æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œå³å†…æ ¸æ—¥å¿—ä¼šè¢«è¿™å‡ ä¸ªè¿›ç¨‹éšæœºæŠ¢å è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªè¿›ç¨‹è¯»åˆ°çš„éƒ½æ˜¯æ•´ä¸ªå†…æ ¸æ—¥å¿—çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ä¸å®Œæ•´çš„ï¼Œè¿™ä¹Ÿæ˜¯dmesgå‘½ä»¤é»˜è®¤ä¸ä½¿ç”¨&#x2F;proc&#x2F;kmsgæ–‡ä»¶çš„åŸå› ã€‚</p><p><strong>ï¼ˆ3ï¼‰klogctlå‡½æ•°</strong></p><p>ç¬¬ä¸‰ç§æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡klogctlå‡½æ•°ã€‚</p><p>è¯¥å‡½æ•°æ˜¯glibcå¯¹syslogç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªç®€å•å°è£…ï¼Œå…¶å…·ä½“ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒå…¨æ™¯å›¾ä¸­ç”¨æˆ·æ€çš„è“è‰²éƒ¨åˆ†ã€‚</p><p>klogctlå‡½æ•°å¯ä»¥æŒ‡å®šå¾ˆå¤šå‘½ä»¤ï¼Œåœ¨ä¸Šå›¾çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯SYSLOG_ACTION_READå‘½ä»¤ï¼Œä»¥æ­¤æ¥æ¨¡æ‹Ÿ cat &#x2F;proc&#x2F;kmsg è¡Œä¸ºã€‚</p><p>å…¶å®åœ¨å†…æ ¸å±‚é¢ï¼Œcat &#x2F;proc&#x2F;kmsgå‘½ä»¤ï¼Œä½¿ç”¨çš„å°±æ˜¯klogctlå¯¹åº”çš„syslogç³»ç»Ÿè°ƒç”¨çš„SYSLOG_ACTION_READå‘½ä»¤çš„å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥ç¤ºä¾‹ä¸­çš„klogctlå‡½æ•°ç›¸å…³ä»£ç ï¼Œå’Œ cat &#x2F;proc&#x2F;kmsg å‘½ä»¤å…¶å®æ˜¯ç­‰ä»·çš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œklogctlå‡½æ•°åœ¨å†…æ ¸é‡Œä½¿ç”¨çš„ä¹Ÿæ˜¯syslog_seqå˜é‡ï¼Œå®ƒä¹Ÿæœ‰å’Œ&#x2F;proc&#x2F;kmsgæ–‡ä»¶åŒæ ·çš„é—®é¢˜ã€‚</p><p><strong>ï¼ˆ4ï¼‰ç³»ç»Ÿæ§åˆ¶å°</strong></p><p>å…¶å®è¿˜æœ‰ä¸€ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œå°±æ˜¯é€šè¿‡ç³»ç»Ÿæ§åˆ¶å°ã€‚</p><p>ä½†è¿™ç§æ–¹å¼å’Œå‰é¢è®²çš„ä¸‰ç§æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯å®Œå…¨è¢«åŠ¨çš„ï¼Œæ˜¯å†…æ ¸åœ¨è°ƒç”¨printkå‡½æ•°ï¼Œå°†æ—¥å¿—ä¿¡æ¯æ”¾åˆ°ring bufferåï¼Œå†å»é€šçŸ¥ç³»ç»Ÿæ§åˆ¶å°ï¼Œå‘ŠçŸ¥å…¶å¯ä»¥è¾“å‡ºè¿™äº›æ—¥å¿—ã€‚</p><p>ç³»ç»Ÿæ§åˆ¶å°ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªconsole_seqå˜é‡ï¼Œè®°å½•ä¸‹ä¸€æ¡è¦è¾“å‡ºå†…æ ¸æ—¥å¿—çš„æ‰€åœ¨ä½ç½®ã€‚</p><p>ç³»ç»Ÿæ§åˆ¶å°è¾“å‡ºçš„å†…å®¹ï¼Œæ˜¯è¢«æ—¥å¿—çº§åˆ«è¿‡æ»¤è¿‡çš„ï¼Œå†…æ ¸é»˜è®¤çš„æ—¥å¿—è¿‡æ»¤çº§åˆ«æ˜¯7ï¼Œå³debugçº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—ï¼Œæ¯”å¦‚info &#x2F; err ç­‰ï¼Œè¿™äº›éƒ½ä¼šè¾“å‡ºï¼Œä½†debugçº§åˆ«ä¸ä¼šè¾“å‡ºã€‚</p><p>è¯¥æ—¥å¿—è¿‡æ»¤çº§åˆ«ï¼Œå¯ä»¥é€šè¿‡å¾ˆå¤šæ–¹å¼æ”¹å˜ï¼Œæ¯”å¦‚è¯´ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸å‚æ•° loglevelï¼Œæ‰€ä»¥ï¼Œå¦‚æœå‘ç°ç³»ç»Ÿæ§åˆ¶å°æ²¡æœ‰è¾“å‡ºæƒ³è¦çš„æ—¥å¿—ä¿¡æ¯ï¼Œå…ˆçœ‹ä¸‹å…¶æ˜¯å¦è¢«è¿‡æ»¤æ‰äº†ã€‚</p><h2 id="2-kernelæ—¥å¿—è°ƒè¯•è®¾ç½®"><a href="#2-kernelæ—¥å¿—è°ƒè¯•è®¾ç½®" class="headerlink" title="2.kernelæ—¥å¿—è°ƒè¯•è®¾ç½®"></a>2.kernelæ—¥å¿—è°ƒè¯•è®¾ç½®</h2><h3 id="2-1-æŸ¥çœ‹æ—¥å¿—çº§åˆ«"><a href="#2-1-æŸ¥çœ‹æ—¥å¿—çº§åˆ«" class="headerlink" title="2.1 æŸ¥çœ‹æ—¥å¿—çº§åˆ«"></a>2.1 æŸ¥çœ‹æ—¥å¿—çº§åˆ«</h3><p>è¾“å…¥<code>cat proc/sys/kernel/printk</code></p><p>è¿™å››ä¸ªæ•°å­—ä¾æ¬¡å¯¹åº” console_loglevelï¼Œdefault_message_loglevelï¼Œminimum_console_loglevelï¼Œdefault_console_loglevelã€‚</p><ul><li><p><strong>console_loglevelï¼š</strong>æ§åˆ¶å°ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ï¼›</p></li><li><p><strong>default_message_loglevelï¼š</strong>è°ƒç”¨ printk() æœªæŒ‡å®šæ—¥å¿—çº§åˆ«æ—¶ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ï¼›</p></li><li><p><strong>minimum_console_loglevelï¼š</strong>å…è®¸è®¾ç½®çš„æ§åˆ¶å°æ—¥å¿—çº§åˆ«ï¼ˆconsole_loglevelï¼‰æœ€å°å€¼ï¼›</p></li><li><p><strong>default_console_loglevelï¼š</strong>ç³»ç»Ÿå¯åŠ¨æ—¶ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ã€‚</p></li></ul><h3 id="2-2-ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«"><a href="#2-2-ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«" class="headerlink" title="2.2 ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«"></a>2.2 ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«</h3><p>ï¼ˆ1ï¼‰æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯ï¼š<code>echo xxx &gt; proc/sys/kernel/printk</code>ï¼Œå…¶ä½™æ–¹å¼å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_34597963/article/details/128669281">https://blog.csdn.net/qq_34597963/article/details/128669281</a></p><p>æ—¥å¿—çº§åˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_EMERG      KERN_SOH <span class="hljs-string">&quot;0&quot;</span>    /* system is unusable */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_ALERT      KERN_SOH <span class="hljs-string">&quot;1&quot;</span>    /* action must be taken immediately */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_CRIT       KERN_SOH <span class="hljs-string">&quot;2&quot;</span>    /* critical conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_ERR        KERN_SOH <span class="hljs-string">&quot;3&quot;</span>    /* error conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_WARNING    KERN_SOH <span class="hljs-string">&quot;4&quot;</span>    /* warning conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_NOTICE     KERN_SOH <span class="hljs-string">&quot;5&quot;</span>    /* normal but significant condition */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_INFO       KERN_SOH <span class="hljs-string">&quot;6&quot;</span>    /* informational */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_DEBUG      KERN_SOH <span class="hljs-string">&quot;7&quot;</span>    /* debug-level messages */</span><br><br>-----------------<br><br>è‡´å‘½çº§(KERN_EMESG),<br>è­¦æˆ’çº§(KERN_ALERT),<br>ä¸´ç•Œçº§(KERN_CRIT),<br>é”™è¯¯çº§(KERN_ERR),<br>å‘Šè­¦çº§(KERN_WARN)<br>æ³¨æ„çº§(KERN_NOTICE),<br>é€šçŸ¥çº§(KERN_INFO),<br>è°ƒè¯•çº§(KERN_DEBUG).<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åœ¨kernelä¸­ä¿®æ”¹logé»˜è®¤ç­‰çº§</p><p>æ‰¾åˆ°<code>/include/linux/printk.h</code>ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">console_verbose</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">console_loglevel = CONSOLE_LOGLEVEL_MIN; <span class="hljs-comment">//CONSOLE_LOGLEVEL_MOTORMOUTH;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-Android-Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨"><a href="#2-3-Android-Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨" class="headerlink" title="2.3 Android Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨"></a>2.3 Android Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨</h3><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/superlee1125/article/details/114099144?spm=1001.2014.3001.5506">https://blog.csdn.net/superlee1125/article/details/114099144?spm=1001.2014.3001.5506</a></p></blockquote><p>åœ¨æŠ“Androidå†…æ ¸çš„logæ—¶ï¼Œinitè¿›ç¨‹çš„logå¾€å¾€æ‰“å°ä¸å…¨ï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸é™åˆ¶äº†logçš„è¾“å‡ºï¼Œåœ¨å†…æ ¸ä»£ç ä¸­æ‰¾åˆ°ä¸‹é¢çš„æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§ä¸‹é¢çš„æç¤ºæŠŠä»£ç æ³¨é‡Šæ‰ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œå†åˆ·åˆ°è®¾å¤‡ä¸­ï¼Œinitè¿›ç¨‹çš„æ‰“å°å°±å®Œæ•´äº†ã€‚</p><p>å†…æ ¸ä»£ç ä¸­æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ <code>kernel/printk/printk.c</code>ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">devkmsg_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br></code></pre></td></tr></table></figure><p>æ³¨é‡Šæ‰ä¸‹é¢è¿™ä¸¤å¥è¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* Ratelimit when not explicitly enabled. */</span><br>    <span class="hljs-keyword">if</span> (!(devkmsg_log &amp; DEVKMSG_LOG_MASK_ON)) &#123;<br>-       <span class="hljs-keyword">if</span> (!___ratelimit(&amp;user-&gt;rs, current-&gt;comm))<br>-           <span class="hljs-keyword">return</span> ret;<br>+       <span class="hljs-comment">//if (!___ratelimit(&amp;user-&gt;rs, current-&gt;comm))</span><br>+           <span class="hljs-comment">//return ret;</span><br>    &#125;<br>    buf = kmalloc(len+<span class="hljs-number">1</span>, GFP_KERNEL);<br></code></pre></td></tr></table></figure><h3 id="2-4-Androidä¿®æ”¹æ—¥å¿—çº§åˆ«"><a href="#2-4-Androidä¿®æ”¹æ—¥å¿—çº§åˆ«" class="headerlink" title="2.4 Androidä¿®æ”¹æ—¥å¿—çº§åˆ«"></a>2.4 Androidä¿®æ”¹æ—¥å¿—çº§åˆ«</h3><p>ä»¥Android 10.0 qcomå¹³å°ä¸ºä¾‹ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š<code>device/qcom/common/rootdir/etc/init.qcom.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">case &quot;$buildvariant&quot; in<br>    &quot;userdebug&quot; | &quot;eng&quot;)<br>        #set default loglevel to KERN_INFO<br>        echo &quot;6 6 1 7&quot; &gt; /proc/sys/kernel/printk  ##### æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹<br><br>        ;;<br>    *)<br>        #set default loglevel to KERN_WARNING<br>        echo &quot;4 4 1 4&quot; &gt; /proc/sys/kernel/printk<br>        ;;<br>esac<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidé€šç”¨å†…æ ¸GKI</title>
    <link href="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/"/>
    <url>/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/</url>
    
    <content type="html"><![CDATA[<h1 id="Androidé€šç”¨å†…æ ¸GKI"><a href="#Androidé€šç”¨å†…æ ¸GKI" class="headerlink" title="Androidé€šç”¨å†…æ ¸GKI"></a>Androidé€šç”¨å†…æ ¸GKI</h1><h2 id="1-GKIæ¦‚è¿°"><a href="#1-GKIæ¦‚è¿°" class="headerlink" title="1.GKIæ¦‚è¿°"></a>1.GKIæ¦‚è¿°</h2><p><strong>å¿«é€Ÿäº†è§£</strong>ï¼š GKIå…¨ç§°ä¸ºGeneric kernel Imageã€‚è‡ª2019å¹´å¼€å§‹ï¼Œæ¥è‡ªGoogle Androidçš„Kernel teamç»è¿‡å¤šå¹´å‡†å¤‡ï¼Œå¼€å§‹åœ¨Android 11.0çš„ç ”å‘ç‰ˆæœ¬ä¸Šæ¨è¡ŒGKIè®¾è®¡ã€‚GKIçš„ç›®æ ‡åœ¨äºæ¶ˆé™¤Androidé˜µè¥Linux Kernelçš„ç¢ç‰‡åŒ–çŠ¶æ€ã€‚ <strong>GKIçš„ç»ˆæç›®æ ‡æ˜¯ç”±Googleç»Ÿä¸€å‘å¸ƒboot.imageé•œåƒç»™å…¨çƒç”¨æˆ·ä½¿ç”¨</strong>ã€‚GKIæ˜¯Google Trebleé¡¹ç›®çš„é‡è¦ä¸¾æªä¹‹ä¸€ã€‚</p><h3 id="1-1-è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI"><a href="#1-1-è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI" class="headerlink" title="1.1 è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI"></a>1.1 è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI</h3><p>ç›´æ¥æ¬è¿å®˜ç½‘ï¼Œè®²çš„å¤ªè¯¦ç»†äº†ã€‚</p><p><u><strong>Android é€šç”¨å†…æ ¸ (ACK)</strong></u> æ˜¯æ‰€æœ‰ Android äº§å“å†…æ ¸çš„åŸºç¡€ã€‚ä¾›åº”å•†å†…æ ¸å’Œè®¾å¤‡å†…æ ¸ä½äº ACK çš„ä¸‹æ¸¸ã€‚ä¾›åº”å•†é€šè¿‡ä¿®æ”¹å†…æ ¸æºä»£ç å¹¶æ·»åŠ è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œæ·»åŠ äº†å¯¹ SoC å’Œå¤–å›´è®¾å¤‡çš„æ”¯æŒã€‚è¿™äº›ä¿®æ”¹å†…å®¹å¯èƒ½å¾ˆå¤šï¼Œä»¥è‡³äºè®¾å¤‡ä¸Šè¿è¡Œçš„ä»£ç ä¸­æœ‰å¤šè¾¾ 50% æ˜¯æ ‘å¤–ä»£ç ï¼ˆå¹¶éæ¥è‡ªä¸Šæ¸¸ Linux å’Œ AOSP é€šç”¨å†…æ ¸ï¼‰ã€‚</p><p>å› æ­¤ï¼Œè®¾å¤‡å†…æ ¸ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ä¸Šæ¸¸ï¼šæ¥è‡ª kernel.org çš„ Linux å†…æ ¸</li><li>AOSPï¼šAOSP é€šç”¨å†…æ ¸çš„å…¶ä»– Android ä¸“ç”¨è¡¥ä¸ç¨‹åº</li><li>ä¾›åº”å•†ï¼šä¾›åº”å•†æä¾›çš„ SoC å’Œå¤–å›´è®¾å¤‡æ”¯æŒä»¥åŠä¼˜åŒ–è¡¥ä¸ç¨‹åº</li><li>åŸå§‹è®¾å¤‡åˆ¶é€ å•† (OEM)&#x2F;è®¾å¤‡ï¼šå…¶ä»–è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œè‡ªå®šä¹‰é¡¹</li></ul><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230217234034047.png" alt="image-20230217234034047" style="zoom: 67%;"><p>Kernelä»Linuxåˆ†æ”¯ä¸€è·¯åˆ°OEMå‚å•†ï¼Œä¸æ–­è¿›è¡Œä¿®æ”¹ï¼Œå…¨çƒè¿™ä¹ˆå¤švendorå‚å•†ï¼Œè¿™ä¹ˆå¤šoemå‚å•†ï¼Œæ¯å®¶éƒ½æ¥è¿™ä¹ˆä¸€å¥—è‡ªå·±çš„kernelï¼Œç¢ç‰‡åŒ–å¤ªå¤ªå¤ªä¸¥é‡äº†ï¼Œè°·æ­ŒçœŸçš„å¾ˆéš¾ç»´æŠ¤ã€‚ç”¨å®˜ç½‘çš„è¯ï¼Œ<strong>å†…æ ¸ç¢ç‰‡åŒ–ä¼šå¯¹ Android ç¤¾åŒºäº§ç”Ÿè‹¥å¹²è´Ÿé¢å½±å“</strong>ã€‚</p><ul><li>å®‰å…¨æ›´æ–°éœ€è¦è€—è´¹å¤§é‡äººåŠ›<ul><li>Android å®‰å…¨å…¬å‘Š (ASB) ä¸­å¼•ç”¨çš„å®‰å…¨è¡¥ä¸ç¨‹åºå¿…é¡»å‘åç§»æ¤åˆ°æ¯ä¸ªè®¾å¤‡å†…æ ¸ä¸­ã€‚ä½†æ˜¯ï¼Œç”±äºå­˜åœ¨å†…æ ¸ç¢ç‰‡åŒ–é—®é¢˜ï¼Œå‘æ­£å¸¸ä½¿ç”¨çš„ Android è®¾å¤‡ä¼ æ’­å®‰å…¨ä¿®å¤çš„ä»£ä»·éå¸¸ä¹‹é«˜ã€‚</li></ul></li><li>å¾ˆéš¾åˆå¹¶é•¿æœŸæ”¯æŒçš„æ›´æ–°<ul><li>é•¿æœŸæ”¯æŒ (LTS) ç‰ˆæœ¬åŒ…å«å®‰å…¨ä¿®å¤å’Œå…¶ä»–é‡å¤§é—®é¢˜ä¿®å¤ã€‚äº‹å®è¯æ˜ï¼Œä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬æ˜¯æä¾›å®‰å…¨ä¿®å¤çš„æœ€æœ‰æ•ˆæ–¹å¼ã€‚æˆ‘ä»¬å‘ç°ï¼ŒASB æŠ¥å‘Šçš„å†…æ ¸å®‰å…¨é—®é¢˜ä¸­æœ‰ 90% éƒ½å·²åœ¨ä¿æŒæœ€æ–°çŠ¶æ€çš„ Pixel è®¾å¤‡ä¸Šå¾—åˆ°ä¿®å¤ã€‚</li></ul></li><li>å¦¨ç¢ Android å¹³å°è¿›è¡Œç‰ˆæœ¬å‡çº§<ul><li>ç”±äºç¢ç‰‡åŒ–é—®é¢˜ï¼Œå¾ˆéš¾å‘æ­£å¸¸ä½¿ç”¨çš„è®¾å¤‡æ·»åŠ éœ€è¦æ›´æ”¹å†…æ ¸çš„ Android æ–°åŠŸèƒ½ã€‚Android æ¡†æ¶ä»£ç å¿…é¡»å‡è®¾æ”¯æŒçš„å†…æ ¸ç‰ˆæœ¬å¤šè¾¾ 5 ä¸ªï¼Œå¹¶ä¸”æ²¡æœ‰é’ˆå¯¹æ–°çš„å¹³å°ç‰ˆæœ¬è¿›è¡Œä»»ä½•å†…æ ¸æ›´æ”¹ï¼ˆAndroid 10 æ”¯æŒå†…æ ¸ç‰ˆæœ¬ 3.18ã€4.4ã€4.9ã€4.14 å’Œ 4.19ï¼›åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™äº›ç‰ˆæœ¬è‡ª 2017 å¹´ Android 8 å‘å¸ƒä»¥æ¥è¿˜æœªæ·»åŠ æ–°åŠŸèƒ½ï¼‰ã€‚</li></ul></li><li>å¾ˆéš¾å°†å†…æ ¸æ›´æ”¹è´¡çŒ®å›ä¸Šæ¸¸ Linux<ul><li>å¯¹å†…æ ¸è¿›è¡Œå®Œæ‰€æœ‰æ›´æ”¹åï¼Œå¤§å¤šæ•°æ——èˆ°è®¾å¤‡é™„å¸¦çš„å†…æ ¸ç‰ˆæœ¬å·²ç»è‡³å°‘å­˜åœ¨ 18 ä¸ªæœˆäº†ã€‚ä¾‹å¦‚ï¼Œ<code>kernel.org</code> äº 2017 å¹´ 11 æœˆå‘å¸ƒäº† 4.14 ç‰ˆå†…æ ¸ï¼Œè€Œé¦–æ‰¹ä½¿ç”¨ 4.14 ç‰ˆå†…æ ¸çš„ Android æ‰‹æœºäº 2019 å¹´æ˜¥å­£æ‰å‘å¸ƒã€‚</li><li>ä¸Šæ¸¸å†…æ ¸å‘å¸ƒä¸äº§å“å‘å¸ƒä¹‹é—´çš„è¿™ç§é•¿æ—¶é—´å»¶è¿Ÿå¯¼è‡´ Android ç¤¾åŒºå¾ˆéš¾å°†æ‰€éœ€çš„åŠŸèƒ½å’Œé©±åŠ¨ç¨‹åºé¦ˆé€åˆ°ä¸Šæ¸¸å†…æ ¸ä¸­ï¼Œå› æ­¤è§£å†³ç¢ç‰‡åŒ–é—®é¢˜å¹¶éæ˜“äº‹ã€‚</li></ul></li></ul><h3 id="1-2-è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–"><a href="#1-2-è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–" class="headerlink" title="1.2 è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–"></a>1.2 è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–</h3><p>é€šç”¨å†…æ ¸æ˜ åƒ (GKI) é¡¹ç›®é€šè¿‡ç»Ÿä¸€æ ¸å¿ƒå†…æ ¸å¹¶å°† SoC å’Œæ¿çº§æ”¯æŒä»æ ¸å¿ƒå†…æ ¸ç§»è‡³å¯åŠ è½½æ¨¡å—ä¸­ï¼Œè§£å†³äº†å†…æ ¸ç¢ç‰‡åŒ–é—®é¢˜ã€‚GKI å†…æ ¸ä¸ºå†…æ ¸æ¨¡å—æä¾›äº†ç¨³å®šçš„å†…æ ¸æ¨¡å—æ¥å£ (KMI)ï¼Œå› æ­¤æ¨¡å—å’Œå†…æ ¸å¯ä»¥ç‹¬ç«‹è¿›è¡Œæ›´æ–°ã€‚</p> <img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230217234449847.png" style="zoom: 80%;"><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒGoogle ä¼šæä¾› KMI æ¥å£ï¼Œç”¨äº vendor modules å’Œ GKI çš„é€šè®¯ã€‚</p><blockquote><p>ç›´ç™½ç‚¹è¯´ï¼Œå°±æ˜¯è°·æ­ŒæŠŠæ‰€æœ‰é€šç”¨çš„Kernelæ”¾åœ¨äº†<code>Generic Kernel</code>é‡Œé¢ï¼ŒæŠŠé€šç”¨çš„Moudulesæ”¾åœ¨äº†<code>GKI Modules</code>é‡Œé¢ã€‚è€Œä¸ç¡¬ä»¶å¼ºç›¸å…³çš„ï¼Œä¸å„å‚å•†ç´§å¯†è”ç³»çš„æ¨¡å—æ”¾åœ¨äº†<code>Vendor Modules</code>é‡Œé¢ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Œæˆ‘ç”¨æˆ·å¯ä»¥å¿«é€Ÿå‡çº§ï¼Œåªè¦åˆ°è°·æ­Œå®˜ç½‘æ‰¾åˆ°æœ€æ–°çš„GKIï¼Œå°±å¯ä»¥ç”¨ä¸Šæœ€æ–°ï¼Œæœ€å®‰å…¨çš„Kernelï¼è€Œä¸ç¡¬ä»¶å¼ºç›¸å…³çš„ï¼Œæ™šç‚¹å‡çº§ä¹Ÿæ²¡äº‹ï¼Œæ—¢ç„¶æ‰‹æœºèƒ½ç”¨ï¼Œè¯´æ˜å„å¤§å‚å•†å¯¹äºé©±åŠ¨ç­‰æ—©å°±é€‚é…å¥½äº†ã€‚</p></blockquote><h3 id="1-3-GKIå‘å±•å†ç¨‹"><a href="#1-3-GKIå‘å±•å†ç¨‹" class="headerlink" title="1.3 GKIå‘å±•å†ç¨‹"></a>1.3 GKIå‘å±•å†ç¨‹</h3><p>Gogole GKI åˆ†ä¸ºä¸‹é¢ä¸¤ä¸ªé˜¶æ®µæ¨è¿›ï¼š</p><blockquote><p><em>â€¢</em> I. GKI å…¼å®¹æ€§ï¼šAndroid 11(R) + linux-5.4 require GKI compatibility test.</p><p><em>â€¢</em> II. GKI äº§å“åŒ–ï¼šAndroid 12(S) + linux-5.x åŠä¹‹å require GKI kernel</p></blockquote><p><strong>GKI 1.0 - GKI å…¼å®¹æ€§è¦æ±‚</strong></p><p>å¯¹äº Android 11 å¹³å°ç‰ˆæœ¬ï¼Œä¸ºäº†ä¿è¯ä¸ Treble å…¼å®¹ï¼Œå¿…é¡»å¯¹è¿è¡Œ v5.4 å†…æ ¸çš„è®¾å¤‡è¿›è¡Œ GKI æµ‹è¯•ã€‚</p><p>å…·å¤‡ GKI å…¼å®¹æ€§æ˜¯æŒ‡è®¾å¤‡é€šè¿‡å°† GKI å¯åŠ¨æ˜ åƒåˆ·å†™åˆ° <code>boot</code> åˆ†åŒºå¹¶å°† GSI ç³»ç»Ÿæ˜ åƒåˆ·å†™åˆ° <code>system</code> åˆ†åŒºæ¥å®‰è£…é€šç”¨ç³»ç»Ÿæ˜ åƒ (GSI) å’Œ GKI å†…æ ¸ï¼Œå› æ­¤é€šè¿‡äº† VTS å’Œ CTS-on-GSI+GKI æµ‹è¯•ã€‚è®¾å¤‡å¯ä»¥é™„å¸¦ä¸åŒçš„äº§å“å†…æ ¸ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ GKI æœªæä¾›çš„å¯åŠ è½½æ¨¡å—ã€‚ä¸è¿‡ï¼Œäº§å“å†…æ ¸å’Œ GKI å†…æ ¸éƒ½å¿…é¡»ä»ç›¸åŒçš„ <code>vendor_boot</code> å’Œ <code>vendor</code> åˆ†åŒºåŠ è½½æ¨¡å—ã€‚å› æ­¤ï¼Œæ‰€æœ‰äº§å“å†…æ ¸éƒ½å¿…é¡»å…·æœ‰ç›¸åŒçš„äºŒè¿›åˆ¶å†…æ ¸æ¨¡å—æ¥å£ (KMI)ã€‚ä¾›åº”å•†å¯ä»¥æ‰©å±•äº§å“å†…æ ¸çš„ KMIï¼Œå‰ææ˜¯å®ƒä¸ GKI KMI å…¼å®¹ã€‚GKI 1.0 ä¸è¦æ±‚ä¾›åº”å•†æ¨¡å—å¯å¸è½½ã€‚</p><p><strong>GKI 2.0 - GKI äº§å“</strong></p><p>æ­è½½ Android S (2021) å¹³å°ç‰ˆæœ¬ä¸”ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬ v5.xï¼ˆ5.x æ˜¯ 2020 å¹´å¹´åº•è¢«é€‰ä¸º LTS çš„å†…æ ¸ç‰ˆæœ¬ï¼‰æˆ–æ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡å¿…é¡»é™„å¸¦ GKI å†…æ ¸ã€‚å°†æä¾›å·²ç­¾åçš„å¯åŠ¨æ˜ åƒï¼Œå¹¶é€šè¿‡ LTS å’Œé‡å¤§é—®é¢˜ä¿®å¤å®šæœŸå¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚ç”±äº KMI å°†ä¿æŒäºŒè¿›åˆ¶ç¨³å®šæ€§ï¼Œå› æ­¤æ— éœ€å¯¹ä¾›åº”å•†æ˜ åƒè¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå³å¯å®‰è£…è¿™äº›å¯åŠ¨æ˜ åƒã€‚</p><h2 id="2-GKIåå„é•œåƒçš„å˜åŒ–"><a href="#2-GKIåå„é•œåƒçš„å˜åŒ–" class="headerlink" title="2.GKIåå„é•œåƒçš„å˜åŒ–"></a>2.GKIåå„é•œåƒçš„å˜åŒ–</h2><h3 id="2-1-bootåˆ†åŒºå˜åŒ–"><a href="#2-1-bootåˆ†åŒºå˜åŒ–" class="headerlink" title="2.1 bootåˆ†åŒºå˜åŒ–"></a>2.1 bootåˆ†åŒºå˜åŒ–</h3><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230219232030518.png" style="zoom:67%;"><p><code>boot</code> åˆ†åŒºåŒ…æ‹¬å¤´æ–‡ä»¶ã€å†…æ ¸ä»¥åŠå†…å«å¯åŠ¨ ramdisk é€šç”¨éƒ¨åˆ†çš„ CPIO å½’æ¡£ã€‚</p><p><code>boot</code> åˆ†åŒºä½¿ç”¨ v3 ç‰ˆå¯åŠ¨å¤´æ–‡ä»¶åï¼Œå…ˆå‰çš„ <code>boot</code> åˆ†åŒºçš„ä»¥ä¸‹éƒ¨åˆ†å°†ä¸å¤å­˜åœ¨ï¼š</p><ul><li>ç¬¬äºŒé˜¶æ®µå¼•å¯¼åŠ è½½ç¨‹åºï¼šå¦‚æœè®¾å¤‡å…·æœ‰ç¬¬äºŒé˜¶æ®µå¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ™å¿…é¡»å°†ç›¸åº”å¼•å¯¼åŠ è½½ç¨‹åºå­˜å‚¨åœ¨è‡ªå·±çš„åˆ†åŒºä¸­ã€‚</li><li>DTBï¼šDTB å­˜å‚¨åœ¨ä¾›åº”å•†å¯åŠ¨åˆ†åŒºä¸­ã€‚</li></ul><p><code>boot</code> åˆ†åŒºåŒ…å«ä¸€ä¸ª CPIOå‹ç¼©åŒ…ï¼Œå†…å«ä»¥ä¸‹ GKI ç»„ä»¶ï¼š</p><ul><li>ä½äº <code>/lib/modules/</code> çš„ GKI å†…æ ¸æ¨¡å—</li><li><code>first_stage_init</code> åŠå…¶ä¾èµ–çš„åº“</li><li><code>fastbootd</code> å’Œ <code>recovery</code>ï¼ˆç”¨äº A&#x2F;B å’Œè™šæ‹Ÿ A&#x2F;B è®¾å¤‡ï¼‰</li></ul><h3 id="2-2-å‡ºç°vendor-bootåˆ†åŒº"><a href="#2-2-å‡ºç°vendor-bootåˆ†åŒº" class="headerlink" title="2.2 å‡ºç°vendor_bootåˆ†åŒº"></a>2.2 å‡ºç°vendor_bootåˆ†åŒº</h3><p><code>vendor_boot</code> åˆ†åŒºéš GKI å¼•å…¥ã€‚è¯¥åˆ†åŒºæ˜¯é‡‡ç”¨A&#x2F;B åˆ†åŒºï¼ŒåŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶ã€ä¾›åº”å•† ramdisk å’Œè®¾å¤‡æ ‘ Blobã€‚vendor ramdisk æ˜¯ä¸€ä¸ª CPIO å‹ç¼©åŒ…ï¼Œå…¶ä¸­åŒ…å«è®¾å¤‡å¯åŠ¨æ‰€éœ€çš„ä¾›åº”å•†æ¨¡å—ã€‚è¿™åŒ…æ‹¬ç”¨äºå¯ç”¨å…³é”® SoC åŠŸèƒ½çš„æ¨¡å—ï¼Œä»¥åŠå¯åŠ¨è®¾å¤‡å’Œæ˜¾ç¤ºå¯åŠ¨ç”»é¢æ‰€éœ€çš„å­˜å‚¨å’Œæ˜¾ç¤ºé©±åŠ¨ç¨‹åºã€‚</p><p>è¯¥ CPIO å‹ç¼©åŒ…åŒ…å«ï¼š</p><ul><li>ç¬¬ä¸€é˜¶æ®µ <code>init</code> ä¾›åº”å•†å†…æ ¸æ¨¡å—ï¼Œä½äº <code>/lib/modules/</code></li><li><code>modprobe</code> é…ç½®æ–‡ä»¶ï¼Œä½äº <code>/lib/modules</code></li><li><code>modules.load</code> æ–‡ä»¶ï¼Œç”¨äºæŒ‡ç¤ºè¦åœ¨ç¬¬ä¸€é˜¶æ®µ <code>init</code> æœŸé—´åŠ è½½çš„æ¨¡å—</li></ul><h3 id="2-3-æ€»ç»“"><a href="#2-3-æ€»ç»“" class="headerlink" title="2.3 æ€»ç»“"></a>2.3 æ€»ç»“</h3><blockquote><p>å…¨å¿—çš„æ–‡æ¡£å†™çš„å¤ªå¥½ï¼Œéå¸¸æ„Ÿè°¢ğŸ˜¸</p></blockquote><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230219232422846.png"><p>ä¸Šå›¾æ˜¯ boot åˆ†åŒºæ”¯æŒ GKI çš„å˜åŒ–æƒ…å†µï¼Œè¿™å¼ å›¾å¾ˆæœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œå…¶ä¸­å…³é”®ç‚¹æœ‰ï¼š</p><ul><li>boot.img å˜ä¸º boot.img + vendor-boot.imgï¼Œå…¶ä¸­ boot.img ä¸­æ”¾çš„æ˜¯ GKI é•œåƒ + ramdiskï¼Œ<u>vendor-boot.img ä¸­æ”¾çš„æ˜¯éœ€è¦å¯åŠ¨åŠ è½½çš„ vendor æ¨¡å— ko</u>ï¼›</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ bootloader åŠ è½½å¹¶æ•´åˆ boot.img å’Œ vendor-boot.imgä¸­çš„ä¸¤ä¸ªramdisk</li><li>ä¸ GKI å¯¹åº”çš„ï¼ŒGoogle è¿˜æ¨å‡º GSIï¼Œä¹Ÿå°±æ˜¯é€šç”¨ system é•œåƒï¼›</li><li>vendor.img å¯ä»¥å­˜æ”¾ä¸éœ€è¦è¦å¯åŠ¨åŠ è½½çš„ koï¼Œè¿™ä¸ªè·Ÿä»¥å‰æ˜¯ä¸€æ ·çš„ã€‚</li></ul><p>bootloader å¼€å‘éœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ï¼š</p><ul><li>boot header V3.0</li><li>DTB çš„å­˜æ”¾ä½ç½®ä» boot.img æ”¹åˆ°äº† vendor-boot</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­ boot éœ€è¦åŠ è½½ boot.img å’Œ vendor-boot.img ä¸­çš„ ramdisk å¹¶åšæ•´åˆï¼Œè€Œä¸” boot.img çš„ ramdisk ä¼˜å…ˆçº§é«˜</li></ul><h3 id="2-4-ramdiskæ‹¼æ¥"><a href="#2-4-ramdiskæ‹¼æ¥" class="headerlink" title="2.4 ramdiskæ‹¼æ¥"></a>2.4 ramdiskæ‹¼æ¥</h3><ul><li>Android 11ä¸­ï¼Œramdisk åˆ†ä¸ºä¸¤ä»½ï¼Œä¸€ä»½ä¸º<strong>boot_ramdisk</strong>ï¼Œå­˜æ”¾åœ¨ <strong>boot.img</strong>ä¸­ã€‚ä¸€ä»½ä¸º<strong>vendor_boot_ramdisk</strong> å­˜æ”¾åœ¨ <strong>vendor_boot.img</strong> ä¸­ã€‚</li><li>åœ¨ bootloader å¯åŠ¨æ—¶éœ€è¦å…ˆååŠ è½½ boot_ramdiskï¼Œvendor_boot_ramdisk å¹¶è¿›è¡Œå‰åæ‹¼æ¥ã€‚</li><li>ramdisk ç”¨çš„æ˜¯ cpio.lz4 æ ¼å¼ï¼Œå¯ä»¥è¿›è¡Œç®€å•çš„é¦–å°¾æ‹¼æ¥ï¼Œ<u><strong>ä½†æ˜¯ bootloader éœ€è¦æ³¨æ„ä¸¤ä¸ªramdisk ä¸­é—´å¿…é¡»ç´§å¯†æ‹¼æ¥ï¼Œä¸èƒ½å¯¹é½å†æ‹¼æ¥ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…æ ¸è§£å‹æ—¶å¤±è´¥</strong></u>ï¼ŒåŒæ—¶æ‹¼æ¥åæ”¹å˜ramdisk çš„å¤§å°ã€‚</li></ul><h2 id="3-å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI"><a href="#3-å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI" class="headerlink" title="3.å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI"></a>3.å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI</h2><h3 id="3-1-å®‰å“å®˜ç½‘æè¿°"><a href="#3-1-å®‰å“å®˜ç½‘æè¿°" class="headerlink" title="3.1 å®‰å“å®˜ç½‘æè¿°"></a>3.1 å®‰å“å®˜ç½‘æè¿°</h3><p>Androidå®˜ç½‘ï¼š<a href="https://source.android.com/docs/core/architecture/kernel/gki-android12-5_10-release-builds?hl=zh-cn">https://source.android.com/docs/core/architecture/kernel/gki-android12-5_10-release-builds?hl=zh-cn</a></p><p>å¦‚æœè¦ä½¿ç”¨<code>boot.img</code>ï¼Œé€‰æ‹©boot-xxx.img</p><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230221223931378.png" alt="image-20230221223931378" style="zoom:67%;"><p>å¦‚æœä½¿ç”¨GKIï¼Œåˆ™ç‚¹å‡»kernelï¼Œé€‰æ‹©image</p><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230221224045860.png" alt="image-20230221224045860" style="zoom:67%;"><blockquote><p>boot-xxx.imgä¸­çš„kernelå’Œè¿™ä¸ªimageæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ ·çš„ï¼ï¼ï¼</p></blockquote><h3 id="3-2-å…¨å¿—æ–‡æ¡£"><a href="#3-2-å…¨å¿—æ–‡æ¡£" class="headerlink" title="3.2 å…¨å¿—æ–‡æ¡£"></a>3.2 å…¨å¿—æ–‡æ¡£</h3><p>æ ¹æ®å…¨å¿—æ–‡æ¡£ï¼ŒAndroid 12ä¸‹è½½ç¼–è¯‘æµç¨‹å¦‚ä¸‹ï¼š</p><p><strong>1ï¼‰ä¸‹è½½</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir android-kernel<br>cd android-kernel/<br>repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.4<br>repo sync<br>repo start --all android12-5.4<br></code></pre></td></tr></table></figure><p><strong>2ï¼‰ ä½¿ç”¨ Google æºç ç¼–è¯‘ GKI é•œåƒ</strong></p><p>åœ¨ google æºç ç›®å½•ä¸‹è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_BOOT_IMG=1 SKIP_VENDOR_BOOT=1 KERNEL_BINARY=Image GKI_RAMDISK_PREBUILT_BINARY=gki-<br>ramdisk.img BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è¿‡ç¨‹ä¸­åœ¨ LTO vmlinux.o é˜¶æ®µå¯èƒ½ä¼šå¡ä¸»ä¸€æ®µæ—¶é—´ï¼ˆå¤§æ¦‚ååˆ†é’Ÿï¼‰ï¼Œå±äºæ­£å¸¸ç°åœºï¼Œç¬¬ä¸€æ¬¡ç¼–è¯‘ä¼šæ¯”è¾ƒè€—æ—¶ã€‚</p><p>ç¼–è¯‘å®Œæˆä»¥åï¼Œboot.imgå­˜æ”¾åœ¨<code>android-kernel/out/android12-5.4/dist/boot.img</code></p><h2 id="4-GKIå¯åŠ¨æµç¨‹"><a href="#4-GKIå¯åŠ¨æµç¨‹" class="headerlink" title="4. GKIå¯åŠ¨æµç¨‹"></a>4. GKIå¯åŠ¨æµç¨‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">boot0<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">uboot: åŠ è½½boot.imgä¸­çš„GKIå’Œramdisk_1ï¼ŒåŠ è½½vendor-boot.imgçš„ramdisk_2ï¼Œæ•´åˆramdisk_1å’Œ</span><br>ramdisk_2,jump to GKI<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">GKI: core kernel init</span><br>--&gt; kernel initï¼š load modules ko<br>--&gt; android bringup<br></code></pre></td></tr></table></figure><h2 id="5-å‚è€ƒ"><a href="#5-å‚è€ƒ" class="headerlink" title="5.å‚è€ƒ"></a>5.å‚è€ƒ</h2><ul><li><a href="https://bbs.16rd.com/thread-583693-1-1.html">https://bbs.16rd.com/thread-583693-1-1.html</a></li><li><a href="https://zhuanlan.zhihu.com/p/240117889">https://zhuanlan.zhihu.com/p/240117889</a></li><li><a href="https://source.android.com/docs/core/architecture/kernel/generic-kernel-image?hl=zh-cn">https://source.android.com/docs/core/architecture/kernel/generic-kernel-image?hl=zh-cn</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>udevè®¾å¤‡ç®¡ç†</title>
    <link href="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/"/>
    <url>/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="udevè®¾å¤‡ç®¡ç†å™¨"><a href="#udevè®¾å¤‡ç®¡ç†å™¨" class="headerlink" title="udevè®¾å¤‡ç®¡ç†å™¨"></a>udevè®¾å¤‡ç®¡ç†å™¨</h1><p>ğŸ‹ğŸ‹ğŸ‹<strong>ååˆ†æ¨èé˜…è¯»</strong>ï¼š<a href="http://www.kroah.com/linux/talks/ols_2003_udev_paper/Reprint-Kroah-Hartman-OLS2003.pdf">http://www.kroah.com/linux/talks/ols_2003_udev_paper/Reprint-Kroah-Hartman-OLS2003.pdf</a></p><h2 id="1-ä¸ºä»€ä¹ˆä¼šå‡ºç°udev"><a href="#1-ä¸ºä»€ä¹ˆä¼šå‡ºç°udev" class="headerlink" title="1.ä¸ºä»€ä¹ˆä¼šå‡ºç°udev"></a>1.ä¸ºä»€ä¹ˆä¼šå‡ºç°udev</h2><p><strong>devfs</strong>(è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿ)æ˜¯ç”±Linux2.4å†…æ ¸å¼•å…¥çš„ï¼Œå½“æ—¶è¢«è®¸å¤šå·¥ç¨‹å¸ˆåŸºäºäº†é«˜åº¦çš„è¯„ä»·ï¼Œdevfsçš„å‡ºç°ä½¿å¾—è®¾å¤‡é©±åŠ¨ç¨‹åºèƒ½å¤Ÿè‡ªä¸»çš„ç®¡ç†è‡ªå·±çš„è®¾å¤‡æ–‡ä»¶ã€‚æ¯”å¦‚ï¼Œå¯ä»¥é€šè¿‡ç¨‹åºåœ¨è®¾å¤‡åˆå§‹åŒ–çš„æ—¶å€™åœ¨ &#x2F;dev ç›®å½•ä¸‹åˆ›å»ºè®¾å¤‡æ–‡ä»¶ï¼Œå¸è½½æ—¶å°†ä»–åˆ é™¤ï¼Œè€Œä¸”è®¾å¤‡é©±åŠ¨ç¨‹åºå¯ä»¥æŒ‡å®šè®¾å¤‡åï¼Œæ‰€æœ‰è€…å’Œæƒé™ä½ï¼Œè€Œä¸”ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ä¿®æ”¹æ‰€æœ‰è€…å’Œæƒé™ä½ï¼Œå¹¶ä¸”ä¸å†éœ€è¦ä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åºåˆ†é…ä¸»è®¾å¤‡å·ä»¥åŠæ¬¡è®¾å¤‡å·ï¼Œåœ¨ç¨‹åºä¸­å¯ä»¥ç›´æ¥ç»™ register_chrdev()ä¼ é€’0ä¸»è®¾å¤‡å·ç”¨æ¥è·å–å¯ç”¨çš„ä¸»è®¾å¤‡å·ã€‚å¹¶ä¸”å¯ä»¥åœ¨ devfs_register() ä¸­æŒ‡å®šæ¬¡è®¾å¤‡å·ã€‚</p><p>ğŸ¦‹å°½ç®¡devfsæœ‰è¿™æ ·å’Œé‚£æ ·çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯ï¼Œåœ¨Linux 2.6å†…æ ¸ä¸­ï¼Œdevfsè¢«è®¤ä¸ºæ˜¯è¿‡æ—¶çš„æ–¹æ³•ï¼Œå¹¶æœ€ç»ˆè¢«æŠ›å¼ƒäº†ï¼Œ<strong>udevå–ä»£äº†å®ƒ</strong>ã€‚</p><p>ğŸ¬<strong>Linux VFSå†…æ ¸ç»´æŠ¤è€…Al ViroæŒ‡å‡ºäº†å‡ ç‚¹udevå–ä»£devfsçš„åŸå› ï¼š</strong></p><ul><li>devfsæ‰€åšçš„å·¥ä½œè¢«ç¡®ä¿¡å¯ä»¥åœ¨ç”¨æˆ·æ€æ¥å®Œæˆã€‚</li><li>devfsè¢«åŠ å…¥å†…æ ¸ä¹‹æ—¶ï¼Œå¤§å®¶æœŸæœ›å®ƒçš„è´¨é‡å¯ä»¥è¿å¤´èµ¶ä¸Š</li><li>å‘ç°devfsæœ‰ä¸€äº›å¯ä¿®å¤å’Œæ— æ³•ä¿®å¤çš„bugã€‚</li><li>å¯¹äºå¯ä¿®å¤çš„bugï¼Œå‡ ä¸ªæœˆå‰å°±å·²ç»è¢«ä¿®å¤äº†ï¼Œå…¶ç»´æŠ¤è€…è®¤ä¸ºä¸€åˆ‡è‰¯å¥½</li><li>å¯¹äºåè€…ï¼Œåœ¨ç›¸å½“é•¿çš„ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¹è§‚</li><li>devfsçš„ç»´æŠ¤è€…å’Œä½œè€…å¯¹å®ƒæ„Ÿåˆ°å¤±æœ›å¹¶ä¸”å·²ç»åœæ­¢äº†å¯¹ä»£ç çš„ç»´æŠ¤å·¥ä½œ</li></ul><h2 id="2-udevç®€ä»‹"><a href="#2-udevç®€ä»‹" class="headerlink" title="2.udevç®€ä»‹"></a>2.udevç®€ä»‹</h2><p>udevæ˜¯ä¸€ä¸ªè®¾å¤‡ç®¡ç†å·¥å…·ï¼Œ**<u>udevä»¥å®ˆæŠ¤è¿›ç¨‹çš„å½¢å¼è¿è¡Œ</u>**ï¼Œé€šè¿‡ä¾¦å¬å†…æ ¸å‘å‡ºæ¥çš„ueventæ¥ç®¡ç†&#x2F;devç›®å½•ä¸‹çš„è®¾å¤‡æ–‡ä»¶ã€‚udevåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œè€Œä¸åœ¨å†…æ ¸ç©ºé—´ è¿è¡Œã€‚å®ƒèƒ½å¤Ÿæ ¹æ®ç³»ç»Ÿä¸­çš„ç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€åŠ¨æ€æ›´æ–°è®¾å¤‡æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºï¼Œåˆ é™¤ç­‰ã€‚è®¾å¤‡æ–‡ä»¶é€šå¸¸æ”¾åœ¨&#x2F;devç›®å½•ä¸‹ã€‚ä½¿ç”¨udevåï¼Œåœ¨&#x2F;devç›®å½•ä¸‹å°±åªåŒ…å«ç³»ç»Ÿä¸­çœŸæ­£å­˜åœ¨çš„è®¾å¤‡ã€‚</p><blockquote><p><strong>DEVFSä¸UDEVçš„ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«ï¼š</strong></p><ul><li>é‡‡ç”¨devfsï¼Œå½“ä¸€ä¸ª<strong>å¹¶ä¸å­˜åœ¨çš„&#x2F;devèŠ‚ç‚¹</strong>è¢«æ‰“å¼€çš„æ—¶å€™ï¼Œdevfsèƒ½<strong>è‡ªåŠ¨åŠ è½½å¯¹åº”çš„é©±åŠ¨</strong>ï¼Œè€Œ<strong>udevåˆ™ä¸è¿™ä¹ˆåš</strong></li><li>è¿™æ˜¯å› ä¸ºudevçš„è®¾è®¡è€…è®¤ä¸ºLinuxåº”è¯¥åœ¨è®¾å¤‡è¢«å‘ç°çš„æ—¶å€™åŠ è½½é©±åŠ¨æ¨¡å—ï¼Œè€Œä¸æ˜¯å½“å®ƒè¢«è®¿é—®çš„æ—¶å€™ã€‚udevçš„è®¾è®¡è€…è®¤ä¸ºdevfsæ‰€æä¾›çš„æ‰“å¼€&#x2F;devèŠ‚ç‚¹æ—¶è‡ªåŠ¨åŠ è½½é©±åŠ¨çš„åŠŸèƒ½<strong>å¯¹ä¸€ä¸ªé…ç½®æ­£ç¡®çš„è®¡ç®—æœºæ¥è¯´æ˜¯å¤šä½™çš„</strong>ã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„è®¾å¤‡éƒ½åº”è¯¥äº§ç”Ÿçƒ­æ’æ‹”äº‹ä»¶å¹¶åŠ è½½æ°å½“çš„é©±åŠ¨ï¼Œ è€Œudevèƒ½æ³¨æ„åˆ°è¿™ç‚¹å¹¶ä¸”ä¸ºå®ƒåˆ›å»ºå¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹</li></ul></blockquote><h2 id="3-udevçš„é…ç½®æ–‡ä»¶"><a href="#3-udevçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.udevçš„é…ç½®æ–‡ä»¶"></a>3.udevçš„é…ç½®æ–‡ä»¶</h2><p>ä¸»è¦çš„udevé…ç½®æ–‡ä»¶æ˜¯&#x2F;etc&#x2F;udev&#x2F;udev.confæ–‡ä»¶ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">udev_root=<span class="hljs-string">&quot;/dev/&quot;</span><br><br>udev_rules=<span class="hljs-string">&quot;/etc/udev/rules.d/&quot;</span><br><br>udev_log=<span class="hljs-string">&quot;err&quot;</span><br></code></pre></td></tr></table></figure><ul><li>udev_rootï¼šä»£è¡¨ç€è®¾å¤‡æ–‡ä»¶æ·»åŠ åˆ°å“ªã€‚</li><li>udev_rulesï¼šä»£è¡¨ç€udevçš„è§„åˆ™å­˜å‚¨çš„ç›®å½•ã€‚è¿™ä¸ªç›®å½•å­˜å‚¨çš„æ˜¯ä»¥.rulesç»“æŸçš„æ–‡ä»¶ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶å¤„ç†ä¸€ç³»åˆ—è§„åˆ™æ¥å¸®åŠ©udevåˆ†é…åå­—ç»™è®¾å¤‡æ–‡ä»¶ä»¥ä¿è¯èƒ½è¢«å†…æ ¸è¯†åˆ«ã€‚ä½ çš„&#x2F;etc&#x2F;udev&#x2F;rules.dä¸‹é¢å¯èƒ½æœ‰å¥½å‡ ä¸ªudevè§„åˆ™æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸€éƒ¨åˆ†æ˜¯udevåŒ…å®‰è£…çš„ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ™æ˜¯å¯èƒ½æ˜¯åˆ«çš„ç¡¬ä»¶æˆ–è€…è½¯ä»¶åŒ…ç”Ÿæˆçš„ã€‚è¯¥ç›®å½•ä¸‹æœ‰å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œudevè¯»å–æ–‡ä»¶æ˜¯æŒ‰ç…§æ–‡ä»¶åçš„ASCIIå­—æ¯é¡ºåºæ¥è¯»å–çš„ï¼Œå¦‚æœudevä¸€æ—¦æ‰¾åˆ°äº†ä¸æ–°åŠ å…¥çš„è®¾å¤‡åŒ¹é…çš„è§„åˆ™ï¼Œudev å°±ä¼šæ ¹æ®è§„åˆ™å®šä¹‰çš„æªæ–½å¯¹æ–°è®¾å¤‡è¿›è¡Œé…ç½®ã€‚åŒæ—¶ä¸å†è¯»åç»­çš„è§„åˆ™æ–‡ä»¶ã€‚</li><li>udev_logï¼šä»£è¡¨ç€udevçš„æ—¥å¿—çº§åˆ«ï¼Œç”¨syslogè®°å½•é”™è¯¯ä¿¡æ¯ã€‚</li></ul><h2 id="4-udevçš„å·¥ä½œæµç¨‹å›¾"><a href="#4-udevçš„å·¥ä½œæµç¨‹å›¾" class="headerlink" title="4.udevçš„å·¥ä½œæµç¨‹å›¾"></a>4.udevçš„å·¥ä½œæµç¨‹å›¾</h2><img src="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/image-20230215234615127.png" style="zoom:80%;"><h2 id="5-udevçš„åŒ¹é…è§„åˆ™"><a href="#5-udevçš„åŒ¹é…è§„åˆ™" class="headerlink" title="5.udevçš„åŒ¹é…è§„åˆ™"></a>5.udevçš„åŒ¹é…è§„åˆ™</h2><p>åœ¨&#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ç³»åˆ—çš„.rulesæ–‡ä»¶ï¼Œåœ¨è¿™äº›æ–‡ä»¶ä¸­æœ‰ä¸€äº›åŒ¹é…è§„åˆ™ï¼š</p><h3 id="5-1-udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦"><a href="#5-1-udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦" class="headerlink" title="5.1 udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦"></a>5.1 udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦</h3><ul><li><p>&#x3D;&#x3D; ï¼šæ¯”è¾ƒé”®ã€å€¼ï¼Œè‹¥ç­‰äºï¼Œåˆ™è¯¥æ¡ä»¶æ»¡è¶³ï¼›</p></li><li><p>!&#x3D;  ï¼šæ¯”è¾ƒé”®ã€å€¼ï¼Œè‹¥ä¸ç­‰äºï¼Œåˆ™è¯¥æ¡ä»¶æ»¡è¶³ï¼›</p></li><li><p>&#x3D;   ï¼šå¯¹ä¸€ä¸ªé”®èµ‹å€¼ï¼›</p></li><li><p>+&#x3D; ï¼šä¸ºä¸€ä¸ªè¡¨ç¤ºå¤šä¸ªæ¡ç›®çš„é”®èµ‹å€¼ã€‚</p></li><li><p>:&#x3D;  ï¼šå¯¹ä¸€ä¸ªé”®èµ‹å€¼ï¼Œå¹¶æ‹’ç»ä¹‹åæ‰€æœ‰å¯¹è¯¥é”®çš„æ”¹åŠ¨ã€‚ç›®çš„æ˜¯é˜²æ­¢åé¢çš„è§„åˆ™æ–‡ä»¶å¯¹è¯¥é”®èµ‹å€¼ã€‚</p></li></ul><h3 id="5-2-udevè§„åˆ™çš„åŒ¹é…é”®"><a href="#5-2-udevè§„åˆ™çš„åŒ¹é…é”®" class="headerlink" title="5.2 udevè§„åˆ™çš„åŒ¹é…é”®"></a>5.2 <strong>udevè§„åˆ™çš„åŒ¹é…é”®</strong></h3><ul><li>ACTIONï¼šäº‹ä»¶(uevent)çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼šadd(æ·»åŠ è®¾å¤‡)ã€remove(åˆ é™¤è®¾å¤‡)ã€‚</li><li>KERNELï¼šå†…æ ¸è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ï¼šsda,cdromã€‚</li><li>DEVPATHï¼šè®¾å¤‡çš„devpathè·¯å¾„ã€‚</li><li>SUBSYSTEMï¼šè®¾å¤‡çš„å­ç³»ç»Ÿåç§°ï¼Œä¾‹å¦‚ï¼šsdaçš„å­ç³»ç»Ÿä¸ºblockã€‚</li><li>BUSï¼šè®¾å¤‡åœ¨devpath é‡Œçš„æ€»çº¿åç§°ï¼Œä¾‹å¦‚ï¼šusbã€‚</li><li>DRIVERï¼šè®¾å¤‡åœ¨devpath é‡Œçš„è®¾å¤‡é©±åŠ¨åç§°ï¼Œä¾‹å¦‚ï¼šide-cdromã€‚</li><li>IDï¼šè®¾å¤‡åœ¨devpath é‡Œçš„è¯†åˆ«å·ã€‚</li><li>SYSFS{filename}ï¼šè®¾å¤‡çš„devpath è·¯å¾„ä¸‹ï¼Œè®¾å¤‡çš„å±æ€§æ–‡ä»¶â€œfilenameâ€é‡Œçš„å†…å®¹ã€‚</li></ul><blockquote><p>ä¾‹å¦‚ï¼šSYSFS{model}&#x3D;&#x3D;â€œST936701SSâ€è¡¨ç¤ºï¼šå¦‚æœè®¾å¤‡çš„å‹å·ä¸ºST936701SSï¼Œåˆ™è¯¥è®¾å¤‡åŒ¹é…è¯¥åŒ¹é…é”®ã€‚</p><p>åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡SYSFSçš„åŒ¹é…é”®ã€‚</p></blockquote><ul><li>ENV{key}ï¼šç¯å¢ƒå˜é‡ã€‚åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡ç¯å¢ƒå˜é‡çš„åŒ¹é…é”®ã€‚</li><li>PROGRAMï¼šè°ƒç”¨å¤–éƒ¨å‘½ä»¤ã€‚</li><li>RESULTï¼šå¤–éƒ¨å‘½ä»¤PROGRAM çš„è¿”å›ç»“æœã€‚ä¾‹å¦‚ï¼š</li></ul><blockquote><p>PROGRAM&#x3D;&#x3D;â€&#x2F;lib&#x2F;udev&#x2F;scsi_id-g -s $devpathâ€, RESULT&#x3D;&#x3D;â€œ35000c50000a7ef67â€</p><p>è°ƒç”¨å¤–éƒ¨å‘½ä»¤&#x2F;lib&#x2F;udev&#x2F;scsi_idæŸ¥è¯¢è®¾å¤‡çš„SCSIIDï¼Œå¦‚æœè¿”å›ç»“æœä¸º35000c50000a7ef67ï¼Œåˆ™è¯¥è®¾å¤‡åŒ¹é…è¯¥åŒ¹é…é”®ã€‚</p></blockquote><h3 id="5-3-udev-çš„é‡è¦èµ‹å€¼é”®"><a href="#5-3-udev-çš„é‡è¦èµ‹å€¼é”®" class="headerlink" title="5.3 udev çš„é‡è¦èµ‹å€¼é”®"></a>5.3 udev çš„é‡è¦èµ‹å€¼é”®</h3><ul><li>NAMEï¼šåœ¨&#x2F;devä¸‹äº§ç”Ÿçš„è®¾å¤‡æ–‡ä»¶åã€‚åªæœ‰ç¬¬ä¸€æ¬¡å¯¹æŸä¸ªè®¾å¤‡çš„NAMEçš„èµ‹å€¼è¡Œä¸ºç”Ÿæ•ˆï¼Œä¹‹ååŒ¹é…çš„è§„åˆ™å†å¯¹è¯¥è®¾å¤‡çš„NAMEèµ‹å€¼è¡Œä¸ºå°†è¢«å¿½ç•¥ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™å¯¹è®¾å¤‡çš„NAMEèµ‹å€¼ï¼Œudevå°†ä½¿ç”¨å†…æ ¸è®¾å¤‡åç§°æ¥äº§ç”Ÿè®¾å¤‡æ–‡ä»¶ã€‚</li><li>SYMLINKï¼šä¸º&#x2F;dev&#x2F;ä¸‹çš„è®¾å¤‡æ–‡ä»¶äº§ç”Ÿç¬¦å·é“¾æ¥ã€‚ç”±äºudevåªèƒ½ä¸ºæŸä¸ªè®¾å¤‡äº§ç”Ÿä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†ä¸è¦†ç›–ç³»ç»Ÿé»˜è®¤çš„udevè§„åˆ™æ‰€äº§ç”Ÿçš„æ–‡ä»¶ï¼Œæ¨èä½¿ç”¨ç¬¦å·é“¾æ¥ã€‚</li><li>OWNER, GROUP, MODEï¼šä¸ºè®¾å¤‡è®¾å®šæƒé™ã€‚</li><li>ENV{key}ï¼šå¯¼å…¥ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚</li><li>RUN:è¿è¡Œåé¢çš„ç¨‹åºã€‚</li></ul><h3 id="5-4-udev-çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦"><a href="#5-4-udev-çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦" class="headerlink" title="5.4 udev çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦"></a>5.4 udev çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦</h3><p>åœ¨é”®å€¼å¯¹ä¸­çš„é”®å’Œæ“ä½œç¬¦éƒ½ä»‹ç»å®Œäº†ï¼Œæœ€åæ˜¯å€¼(value)ã€‚Linuxç”¨æˆ·å¯ä»¥éšæ„åœ°å®šåˆ¶udevè§„åˆ™æ–‡ä»¶çš„å€¼ã€‚ä¾‹å¦‚ï¼šmy_root_disk,my_printerã€‚åŒæ—¶ä¹Ÿå¯ä»¥å¼•ç”¨ä¸‹é¢çš„æ›¿æ¢æ“ä½œç¬¦ï¼š</p><ul><li>$kernel, %kï¼šè®¾å¤‡çš„å†…æ ¸è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ï¼šsdaã€cdromã€‚</li><li>$number, %nï¼šè®¾å¤‡çš„å†…æ ¸å·ç ï¼Œä¾‹å¦‚ï¼šsda3çš„å†…æ ¸å·ç æ˜¯3ã€‚</li><li>$devpath, %pï¼šè®¾å¤‡çš„devpathè·¯å¾„ã€‚</li><li>$id, %bï¼šè®¾å¤‡åœ¨devpathé‡Œçš„IDå·ã€‚</li><li>$sysfs{file}ï¼Œ%s{file}ï¼šè®¾å¤‡çš„sysfsé‡Œfileçš„å†…å®¹ã€‚å…¶å®å°±æ˜¯è®¾å¤‡çš„å±æ€§å€¼ã€‚ä¾‹å¦‚ï¼šsysfs{size}è¡¨ç¤ºè¯¥è®¾å¤‡(ç£ç›˜) çš„å¤§å°ã€‚</li><li>$env{key}, %E{key}ï¼šä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼ã€‚</li><li>$major, %Mï¼šè®¾å¤‡çš„majorå·ã€‚</li><li>$minor %mï¼šè®¾å¤‡çš„minorå·ã€‚</li><li>$result, %cï¼šPROGRAMè¿”å›çš„ç»“æœã€‚</li><li>$parent, %Pï¼šçˆ¶è®¾å¤‡çš„è®¾å¤‡æ–‡ä»¶åã€‚</li><li>$root, %rï¼šudev_rootçš„å€¼ï¼Œé»˜è®¤æ˜¯&#x2F;dev&#x2F;ã€‚</li><li>$tempnode, %Nï¼šä¸´æ—¶è®¾å¤‡åã€‚</li><li>%%ï¼šç¬¦å·%æœ¬èº«ã€‚</li><li>$$ï¼š ç¬¦ å· ï¼šç¬¦å·ï¼šç¬¦å·æœ¬èº«ã€‚</li></ul><p>æ³¨æ„ï¼šåœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ï¼Œè¦åŒ¹é…æ‰€æœ‰çš„æ¯”è¾ƒé”®éƒ½æ»¡è¶³æ—¶ï¼Œæ‰ç®—åŒ¹é…æˆåŠŸã€‚</p><h2 id="6-udevçš„ä½¿ç”¨æ–¹æ³•"><a href="#6-udevçš„ä½¿ç”¨æ–¹æ³•" class="headerlink" title="6.udevçš„ä½¿ç”¨æ–¹æ³•"></a>6.udevçš„ä½¿ç”¨æ–¹æ³•</h2><ol><li>ä½¿ç”¨udevadm å‘½ä»¤æ¥æŸ¥çœ‹è®¾å¤‡çš„ä¿¡æ¯ï¼šåœ¨ä½¿ç”¨udevæ—¶éœ€è¦è·å¾—è¯¥è®¾å¤‡çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¥ç”¨äºåŒ¹é…è§„åˆ™ã€‚</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">udevadm info -a -p $(udevadm info -q path -n /dev/sdb)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­&#x2F;dev&#x2F;sdbæ˜¯æ’å…¥è®¾å¤‡åè®¾å¤‡åœ¨&#x2F;devä¸‹çš„åå­—ã€‚</p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs shell">Udevadm info starts with the device specified by the devpath and then<br>walks up the chain of parent devices. It prints for every device<br>found, all possible attributes in the udev rules key format.<br>A rule to match, can be composed by the attributes of the device<br>and the attributes from one single parent device.<br><br>  looking at device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1/20:0:1:0/block/sdb&#x27;:<br>    KERNEL==&quot;sdb&quot;<br>    SUBSYSTEM==&quot;block&quot;<br>    DRIVER==&quot;&quot;<br>    ATTR&#123;alignment_offset&#125;==&quot;0&quot;<br>    ATTR&#123;capability&#125;==&quot;50&quot;<br>    ATTR&#123;discard_alignment&#125;==&quot;0&quot;<br>    ATTR&#123;events&#125;==&quot;&quot;<br>    ATTR&#123;events_async&#125;==&quot;&quot;<br>    ATTR&#123;events_poll_msecs&#125;==&quot;-1&quot;<br>    ATTR&#123;ext_range&#125;==&quot;256&quot;<br>    ATTR&#123;hidden&#125;==&quot;0&quot;<br>    ATTR&#123;inflight&#125;==&quot;       0        0&quot;<br>    ATTR&#123;range&#125;==&quot;16&quot;<br>    ATTR&#123;removable&#125;==&quot;0&quot;<br>    ATTR&#123;ro&#125;==&quot;0&quot;<br>    ATTR&#123;size&#125;==&quot;41943040&quot;<br>    ATTR&#123;stat&#125;==&quot;      85        0     4184       20        0        0        0        0        0        8       20&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1/20:0:1:0&#x27;:<br>    KERNELS==&quot;20:0:1:0&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;sd&quot;<br>    ATTRS&#123;blacklist&#125;==&quot;&quot;<br>    ATTRS&#123;device_blocked&#125;==&quot;0&quot;<br>    ATTRS&#123;device_busy&#125;==&quot;0&quot;<br>    ATTRS&#123;dh_state&#125;==&quot;detached&quot;<br>    ATTRS&#123;eh_timeout&#125;==&quot;10&quot;<br>    ATTRS&#123;evt_capacity_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_inquiry_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_lun_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_media_change&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_mode_parameter_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_soft_threshold_reached&#125;==&quot;0&quot;<br>    ATTRS&#123;inquiry&#125;==&quot;&quot;<br>    ATTRS&#123;iocounterbits&#125;==&quot;32&quot;<br>    ATTRS&#123;iodone_cnt&#125;==&quot;0x7a&quot;<br>    ATTRS&#123;ioerr_cnt&#125;==&quot;0x3&quot;<br>    ATTRS&#123;iorequest_cnt&#125;==&quot;0x7a&quot;<br>    ATTRS&#123;model&#125;==&quot;VMware Virtual S&quot;<br>    ATTRS&#123;queue_depth&#125;==&quot;32&quot;<br>    ATTRS&#123;queue_ramp_up_period&#125;==&quot;120000&quot;<br>    ATTRS&#123;queue_type&#125;==&quot;simple&quot;<br>    ATTRS&#123;rev&#125;==&quot;1.0 &quot;<br>    ATTRS&#123;scsi_level&#125;==&quot;3&quot;<br>    ATTRS&#123;state&#125;==&quot;running&quot;<br>    ATTRS&#123;timeout&#125;==&quot;180&quot;<br>    ATTRS&#123;type&#125;==&quot;0&quot;<br>    ATTRS&#123;vendor&#125;==&quot;VMware, &quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1&#x27;:<br>    KERNELS==&quot;target20:0:1&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20&#x27;:<br>    KERNELS==&quot;host20&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0&#x27;:<br>    KERNELS==&quot;0000:00:10.0&quot;<br>    SUBSYSTEMS==&quot;pci&quot;<br>    DRIVERS==&quot;mptspi&quot;<br>    ATTRS&#123;broken_parity_status&#125;==&quot;0&quot;<br>    ATTRS&#123;class&#125;==&quot;0x010000&quot;<br>    ATTRS&#123;config&#125;==&quot;&quot;<br>    ATTRS&#123;consistent_dma_mask_bits&#125;==&quot;32&quot;<br>    ATTRS&#123;d3cold_allowed&#125;==&quot;0&quot;<br>    ATTRS&#123;device&#125;==&quot;0x0030&quot;<br>    ATTRS&#123;dma_mask_bits&#125;==&quot;32&quot;<br>    ATTRS&#123;driver_override&#125;==&quot;(null)&quot;<br>    ATTRS&#123;enable&#125;==&quot;1&quot;<br>    ATTRS&#123;irq&#125;==&quot;17&quot;<br>    ATTRS&#123;local_cpulist&#125;==&quot;0-3&quot;<br>    ATTRS&#123;local_cpus&#125;==&quot;00000000,00000000,00000000,0000000f&quot;<br>    ATTRS&#123;msi_bus&#125;==&quot;1&quot;<br>    ATTRS&#123;numa_node&#125;==&quot;-1&quot;<br>    ATTRS&#123;revision&#125;==&quot;0x01&quot;<br>    ATTRS&#123;subsystem_device&#125;==&quot;0x1976&quot;<br>    ATTRS&#123;subsystem_vendor&#125;==&quot;0x15ad&quot;<br>    ATTRS&#123;vendor&#125;==&quot;0x1000&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00&#x27;:<br>    KERNELS==&quot;pci0000:00&quot;<br>    SUBSYSTEMS==&quot;&quot;<br>    DRIVERS==&quot;&quot;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç¼–å†™.rulesæ–‡ä»¶çš„è§„åˆ™ï¼šè¿›å…¥&#x2F;etc&#x2F;udev&#x2F;rules.dæ–‡ä»¶å¤¹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /etc/udev/rules.d<br></code></pre></td></tr></table></figure><p>æ–°å»ºæ–‡ä»¶10-usb.rulesï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi 10-usb.rules<br></code></pre></td></tr></table></figure><p>åœ¨10-usb.rulesæ–‡ä»¶ä¸­è¾“å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">KERNEL==&quot;sdb&quot;,SUBSYSTEM==&quot;block&quot;,ACTION==&quot;add&quot;,SYMLINK+=&quot;USB_link&quot;<br></code></pre></td></tr></table></figure><p>ç„¶åä¿å­˜ï¼Œé€€å‡ºã€‚</p><ol start="3"><li>ä½¿å¾—udevæ–‡ä»¶ç”Ÿæ•ˆçš„æ–¹æ³•ï¼šé€šå¸¸ï¼Œä½¿å¾—é…ç½®åçš„æ–‡ä»¶ç”Ÿæ•ˆï¼Œéœ€è¦é‡‡ç”¨çƒ­æ’æ‹”çš„æ–¹æ³•æ›´æ–°udevè§„åˆ™ï¼Œä¸è¿‡æœ‰æ›´ç®€å•çš„æ–¹æ³•å¦‚ä¸‹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">udevadm test /sys/class/block/sdb<br></code></pre></td></tr></table></figure><p>4.ç»“æœå¦‚ä¸‹ï¼šåœ¨&#x2F;devæ–‡ä»¶å¤¹ä¸‹</p><img src="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/20201228214401604.png"><h2 id="7-çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ"><a href="#7-çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="7.çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ"></a>7.çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ</h2><p>ç”±äºå†·æ’æ‹”çš„è®¾å¤‡å¼€æœºæ—¶å°±å·²ç»å­˜åœ¨ï¼Œåœ¨udevå¯åŠ¨å‰å·²ç»è¢«æ’å…¥ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œsysfsä¸‹çš„è®¾å¤‡éƒ½å­˜åœ¨ueventæ–‡ä»¶ï¼Œå‘è¯¥æ–‡ä»¶å†™ä¸€ä¸ªâ€œaddâ€,å†…æ ¸ä¼šé‡æ–°å‘é€netlinkï¼Œä¹‹åudevå°±å¯ä»¥æ”¶åˆ°è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯äº†ï¼Œä»è€Œåˆ›å»º&#x2F;devä¸‹å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p><h2 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h2><ul><li><a href="https://blog.csdn.net/chengziwang/article/details/111873757">https://blog.csdn.net/chengziwang/article/details/111873757</a></li><li><a href="https://gitee.com/low-level-of-logic/RaspberryPi/blob/master/docs/">https://gitee.com/low-level-of-logic/RaspberryPi/blob/master/docs/</a></li><li><a href="https://blog.csdn.net/woyimibayi/article/details/78320915">https://blog.csdn.net/woyimibayi/article/details/78320915</a></li><li><a href="http://m.wfuyu.com/server/23483.html">http://m.wfuyu.com/server/23483.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€å®éªŒã€‘/devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘-x2F-devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ"><a href="#ã€å®éªŒã€‘-x2F-devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ã€å®éªŒã€‘&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ"></a>ã€å®éªŒã€‘&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ</h1><p>å…ˆä»‹ç»ä¸€ä¸‹æˆ‘çš„å¼€å‘æ¿ï¼ŒNXPçš„IMX6ULLï¼Œé‡Œé¢æ˜¯åŸç”Ÿçš„Linuxå†…æ ¸ï¼Œç‰ˆæœ¬ä¸º<code>4.1.5</code>ã€‚</p><p>ä¸‹é¢å¼€å§‹åšå®éªŒï¼Œè¯æ˜&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h2><p><strong>1.å¼€æœºåæŸ¥çœ‹å½“å‰çš„æŒ‚è½½çš„è®¾å¤‡</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220652226.png" alt="image-20230215220652226" style="zoom:67%;"><blockquote><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶devtmpfså¤§å°ä¸º88.3M</p></blockquote><p><strong>2.å°è¯•æ‰‹åŠ¨æŒ‚è½½&#x2F;dev</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220610703.png" alt="image-20230215220610703" style="zoom:67%;"><p>æˆ‘ä»¬çŸ¥é“tmpfsæŒ‚è½½åé»˜è®¤æ˜¯RAMçš„ä¸€åŠ</p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220830308.png" alt="image-20230215220830308" style="zoom:67%;"><blockquote><p>å¯ä»¥å‘ç°devtmpfsè·Ÿéštmpfsä¸€èµ·åŠæˆäº†RAMçš„ä¸€åŠå¤§å°</p></blockquote><p><strong>3.å†æ¬¡ç¡®è®¤æŒ‚è½½æƒ…å†µ</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220510027.png"><p><strong>4.æŸ¥çœ‹æ­¤æ—¶&#x2F;devç›®å½•æ˜¯å¦æ­£å¸¸</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215221013735.png"><blockquote><p>æ­¤æ—¶&#x2F;devç›®å½•ä¸‹ä¸ºç©ºï¼Œè®¿é—®ä¸åˆ°ä»»ä½•ç›®å½•</p></blockquote><h2 id="å®éªŒç»“è®º"><a href="#å®éªŒç»“è®º" class="headerlink" title="å®éªŒç»“è®º"></a>å®éªŒç»“è®º</h2><p>é€šè¿‡å®éªŒæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯ä»¥åŒæ—¶ç»™<code>/dev</code>æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰é—®é¢˜</li><li>å½“ç³»ç»Ÿä»¥<code>devtmpfs</code>æŒ‚è½½åï¼Œå†æ¬¡ä»¥<code>tmpfs</code>æŒ‚è½½åï¼Œ<code>devtmpfs</code>ä¼šéš<code>tmpfs</code>å¤§å°ä¸€èµ·å˜åŒ–ï¼Œå¦‚æœ<code>tmpfs</code>æŒ‚è½½æ—¶ä¸æŒ‡æ˜å¤§å°ï¼Œé»˜è®¤ä¸ºå†…å­˜çš„ä¸€åŠ</li><li>ç»™<code>/dev</code>æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿåï¼Œ<code>/dev</code>ç›®å½•æ— æ³•æ­£å¸¸è®¿é—®</li></ul><p><strong>è¯´æ˜ï¼šæœ¬æ–‡æ°´å¹³æœ‰é™ï¼Œå¯èƒ½å­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œè¯·æŒ‡æ­£ï¼</strong></p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“</title>
    <link href="/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/"/>
    <url>/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/</url>
    
    <content type="html"><![CDATA[<h1 id="tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“"><a href="#tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“" class="headerlink" title="tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“"></a>tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“</h1><h2 id="1-ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ"></a>1.ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ</h2><p>å…ˆæ¥çœ‹ä¸€ä¸‹Kernelæ–‡æ¡£å¯¹äºtmpfsæ–‡ä»¶ç³»ç»Ÿçš„æè¿°ï¼š<a href="https://www.kernel.org/doc/Documentation/filesystems/tmpfs.txt">https://www.kernel.org/doc/Documentation/filesystems/tmpfs.txt</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">Tmpfs is a file system <span class="hljs-built_in">which</span> keeps all files <span class="hljs-keyword">in</span> virtual memory.<br><br>Everything <span class="hljs-keyword">in</span> tmpfs is temporary <span class="hljs-keyword">in</span> the sense that no files will be created on your hard drive. If you unmount a tmpfs instance, everything stored there <span class="hljs-keyword">in</span> is lost.<br><br>tmpfs puts everything into the kernel internal caches and grows andshrinks to accommodate the files it contains and is able to swap unneeded pages out to swap space. It has maximum size limits <span class="hljs-built_in">which</span> can be adjusted on the fly via <span class="hljs-string">&#x27;mount -o remount ...&#x27;</span><br><br>If you compare it to ramfs (<span class="hljs-built_in">which</span> was the template to create tmpfs) you gain swapping and <span class="hljs-built_in">limit</span> checking. Another similar thing is the RAMdisk (/dev/ram*), <span class="hljs-built_in">which</span> simulates a fixed size hard disk <span class="hljs-keyword">in</span> physical RAM, <span class="hljs-built_in">where</span> you have to create an ordinary filesystem on top. Ramdisks cannot swap and you <span class="hljs-keyword">do</span> not have the possibility to resize them. <br></code></pre></td></tr></table></figure><ul><li><p>tmpfsæ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æ–‡ä»¶ä¿å­˜åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p></li><li><p>tmpfsä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸´æ—¶çš„ï¼Œå› ä¸ºä¸ä¼šåœ¨ç¡¬ç›˜ä¸Šåˆ›å»ºä»»ä½•æ–‡ä»¶ã€‚å¦‚æœå¸è½½tmpfså®ä¾‹ï¼Œå­˜å‚¨åœ¨å…¶ä¸­çš„æ‰€æœ‰ä¸œè¥¿éƒ½ä¸¢å¤±äº†</p></li><li><p>tmpfså°†æ‰€æœ‰å†…å®¹æ”¾å…¥å†…æ ¸å†…éƒ¨ç¼“å­˜ï¼Œå¹¶è¿›è¡Œå¢é•¿å’Œæ”¶ç¼©ä»¥å®¹çº³å…¶ä¸­åŒ…å«çš„æ–‡ä»¶ï¼Œå¹¶èƒ½å¤Ÿå°†ä¸éœ€è¦çš„é¡µé¢äº¤æ¢å‡ºæ¥ä»¥äº¤æ¢ç©ºé—´ã€‚å®ƒå…·æœ‰sizeé™åˆ¶ï¼Œå¯ä»¥é€šè¿‡â€œmount-o remountâ€¦â€è¿›è¡ŒåŠ¨æ€è°ƒæ•´</p></li><li><p>å¦‚æœå°†å…¶ä¸ramfsï¼ˆåˆ›å»ºtmpfsçš„æ¨¡æ¿ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™ä¼šè·å¾—äº¤æ¢å’Œé™åˆ¶æ£€æŸ¥ã€‚å¦ä¸€ä¸ªç±»ä¼¼çš„ä¸œè¥¿æ˜¯RAMdiskï¼ˆ&#x2F;dev&#x2F;ram*ï¼‰ï¼Œå®ƒåœ¨ç‰©ç†ramä¸­æ¨¡æ‹Ÿå›ºå®šå¤§å°çš„ç¡¬ç›˜ï¼Œæ‚¨å¿…é¡»åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ç³»ç»Ÿã€‚Ramdisksæ— æ³•äº’æ¢ï¼Œæ‚¨æ— æ³•è°ƒæ•´å…¶å¤§å°ã€‚</p></li></ul><p><strong>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹tmpfsçš„ç‰¹ç‚¹ï¼š</strong></p><ol><li>ç”±äºæ˜¯æ„å»ºåœ¨å†…å­˜ä¸­ï¼Œå­˜æ”¾åœ¨tmpfsä¸­çš„æ‰€æœ‰æ•°æ®åœ¨å¸è½½æˆ–è€…æ–­åä¸¢å¤±ã€‚ã€ä¸´æ—¶æ€§ã€‘</li><li>å†…å­˜çš„è®¿é—®é€Ÿåº¦è¿œè¿œå¤§äºç£ç›˜IOæ“ä½œï¼Œå³ä½¿ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜ï¼Œæ€§èƒ½ä»ç„¶ä¼˜äºç£ç›˜ã€‚ã€å¿«é€Ÿè¯»å†™ã€‘</li><li>tmpfsä¸€å¼€å§‹ä½¿ç”¨å¾ˆå°çš„ç©ºé—´ï¼Œä½†æ˜¯éšç€æ–‡ä»¶çš„å¤åˆ¶å’Œåˆ›å»ºï¼Œtmpfsæ–‡ä»¶ç³»ç»Ÿä¼šåˆ†é…æ›´å¤šçš„å†…å­˜ï¼Œå¹¶æŒ‰ç…§éœ€æ±‚åŠ¨æ€å¢åŠ æ–‡ä»¶ç³»ç»Ÿçš„ç©ºé—´ï¼Œè€Œä¸”tmpfsæ–‡ä»¶ç³»ç»Ÿä¼šåŠ¨æ€ç¼©å°æ–‡ä»¶å¹¶é‡Šæ”¾å†…å­˜èµ„æº</li><li>åƒæ™®é€šå—è®¾å¤‡éœ€è¦mkfsæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿåæ‰å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯tmpfsæ˜¯ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåªè¦æŒ‚è½½å°±å¯ä»¥ä½¿ç”¨ã€‚</li></ol><h2 id="2-Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ"><a href="#2-Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ"></a>2.Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ</h2><p>Androidä¸­æŒ‚è½½tmpfsæ–‡ä»¶ç³»ç»Ÿçš„æ—¶æœºä¸»è¦åœ¨å®‰å“initè¿›ç¨‹ä¸­çš„ç¬¬ä¸€é˜¶æ®µæŒ‚è½½å’Œç¬¬äºŒé˜¶æ®µæŒ‚è½½ã€åŸºäºAndroid Sã€‘</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FirstStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/dev&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="hljs-string">&quot;mode=0755&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/mnt&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=1000&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/debug_ramdisk&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br># --------------------------------------------------------------------------------------<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-built_in">MountExtraFilesystems</span>();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">MountExtraFilesystems</span><span class="hljs-params">()</span> </span>&#123;<br><br>    <span class="hljs-comment">// /apex is used to mount APEXes</span><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/apex&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br><br>    <span class="hljs-comment">// /linkerconfig is used to keep generated linker configuration</span><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/linkerconfig&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®‰å“çœŸå®è¿è¡Œç¯å¢ƒä¸­çš„æŒ‚è½½æƒ…å†µ</p><img src="/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/image-20230214223605505.png" style="zoom:80%;"><p>ğŸ–ã€ä¸ªäººçŒœæƒ³ã€‘ä¸ºä»€ä¹ˆç±»ä¼¼&#x2F;devï¼Œ&#x2F;apexè¿™ç§éœ€è¦ä½¿ç”¨tmpfsæ–‡ä»¶ç³»ç»Ÿï¼š</p><ul><li>åƒå®‰å“çš„è®¾å¤‡åˆ›å»ºåéƒ½åœ¨&#x2F;devç›®å½•ä¸‹ï¼Œé©±åŠ¨ä¼šä»¥&#x2F;dev&#x2F;xxxçš„æ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šå‘ç”Ÿå¤§é‡çš„IOæ“ä½œï¼Œæ˜¾ç„¶ä½¿ç”¨tmpfsæ›´å¿«</li><li>åƒARTï¼ŒVNDKç­‰éƒ½å­˜åœ¨äº&#x2F;apexä¸­ï¼Œå®‰å“å¯åŠ¨çš„æ—¶å€™è™šæ‹ŸæœºARTåˆ›å»ºéƒ½åœ¨&#x2F;apexä¸­</li></ul><h2 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h2><ul><li><a href="https://www.bilibili.com/video/BV1HG4y1K76E/">https://www.bilibili.com/video/BV1HG4y1K76E/</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹åŠ¨æŒ‚è½½apexåŒ…åˆ°loopè®¾å¤‡</title>
    <link href="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/"/>
    <url>/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ"><a href="#ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ" class="headerlink" title="ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ"></a>ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ</h1><h2 id="1-loopè®¾å¤‡"><a href="#1-loopè®¾å¤‡" class="headerlink" title="1.loopè®¾å¤‡"></a>1.loopè®¾å¤‡</h2><p>åœ¨ç±» UNIX ç³»ç»Ÿé‡Œï¼Œloop è®¾å¤‡æ˜¯ä¸€ç§ä¼ªè®¾å¤‡(pseudo-device)ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ˜¯ä»¿çœŸè®¾å¤‡ã€‚å®ƒèƒ½ä½¿æˆ‘ä»¬åƒå—è®¾å¤‡ä¸€æ ·è®¿é—®ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>è¿™è¦å…ˆä»mountçš„æµç¨‹æ¥ç†è§£ï¼ŒæŒ‚è½½æ“ä½œï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠè®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ&#x2F;ç›®å½•æ–‡ä»¶è¿æ¥åˆ°æŒ‡å®šçš„ç›®å½•ï¼ˆdirectoryï¼‰ä¸‹ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢å°±æ˜¯æŠŠæŒ‚è½½è®¾å¤‡å’ŒæŒ‚è½½ç›®å½•çš„å¯¹åº”å…³ç³»åŠ åˆ°å†…æ ¸ä¸­çš„Vfsmounté‡Œçš„å¯¹åº”è¡¨å•é‡Œï¼ˆå†…æ ¸å¯åŠ¨åä¼šä»ç¡¬ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜é‡Œï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®ç›®å½•è·¯å¾„æ¥è®¿é—®è®¾å¤‡ä¸Šçš„æ•°æ®äº†ã€‚</p><p>loop mountæ˜¯å¦ä¸€ç§mountæ–¹å¼ï¼Œå¦‚æœè¯´æ™®é€šmountè§£å†³äº†å®é™…ç¡¬ä»¶å­˜å‚¨è®¾å¤‡çš„æŒ‚è½½ï¼Œbind mountè§£å†³äº†ç›®å½•åˆ°ç›®å½•çš„æŒ‚è½½ï¼Œé‚£ä¹ˆloop mountåˆ™è§£å†³äº†å°†<strong>æ¡£æ¡ˆæ–‡ä»¶</strong>åˆ°ç›®å½•çš„æŒ‚è½½</p><p>æ¡£æ¡ˆï¼Œè‹±æ–‡Archiveï¼Œä¸æ–‡ä»¶ï¼ˆfileï¼‰ä¸åŒï¼Œæ˜¯ä¸€ä¸ªæ‰“åŒ…å¥½çš„æ–‡ä»¶é›†ï¼Œé‡Œé¢ä¸€èˆ¬åŒ…å«è®¸å¤šæ–‡ä»¶, æ¯”å¦‚ tarï¼Œjarï¼Œiso ï¼Œimgå°±æ˜¯å¸¸è§çš„æ¡£æ¡ˆæ ¼å¼</p><p>é‚£åˆæ˜¯æ€ä¹ˆå®ç°å°†æ¡£æ¡ˆæ–‡ä»¶æŒ‚è½½åˆ°ç›®å½•ä¸‹å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs she">å®é™…ä¸Šï¼Œç³»ç»Ÿå…ˆæŠŠæ¡£æ¡ˆæ–‡ä»¶ï¼ˆæ¯”å¦‚æŸä¸ª.isoæ–‡ä»¶ï¼‰æ˜ å°„åˆ°loopè®¾å¤‡ä¸Š<br>#losetup  /dev/loop0   xxxx.iso        ä½¿ç³»ç»Ÿè¯¯è®¤ä¸ºxxxx.isoä¸ºå­˜å‚¨è®¾å¤‡/dev/loop0<br><br>å†æ¬ºéª—mountå‘½ä»¤ï¼Œä½¿ä»–è®¤ä¸º  /dev/loop0çœŸçš„æ˜¯ä¸ªè®¾å¤‡åœ¨è¿è¡Œï¼ŒæŒ‚è½½åˆ°æŒ‡å®šç›®å½•<br>#mount   -t   xxxx.iso   /dev/loop0    /loopè®¾å¤‡è·¯å¾„    <br><br></code></pre></td></tr></table></figure><p>ä½†å‰ææ˜¯ï¼Œè¢«è®¿é—®çš„loopè®¾å¤‡é‡Œçš„æ¡£æ¡ˆæ–‡ä»¶å…·æœ‰linuxè¯†åˆ«çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåƒtar, jar, zip è¿™æ ·çš„æ¡£æ¡ˆï¼Œåªæ˜¯ä¸€ç§å‹ç¼©æ ¼å¼ï¼Œæœ¬èº«ä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå³ä½¿é€šè¿‡loop mountæŒ‚è½½ä¸Šå»äº†ï¼Œç›´æ¥è®¿é—®ä»–ä¹Ÿè¯»ä¸å‡ºä»€ä¹ˆæ•°æ®ï¼Œè¿™å¾ˆå¥½ç†è§£ï¼Œå°±åƒåœ¨windowsä¸‹ä¸è£…ä»»ä½•è§£å‹è½¯ä»¶ï¼Œå°±æ— æ³•æ‰“å¼€å‹ç¼©æ–‡ä»¶ä¸€æ ·ã€‚<u><strong>æ‰€æœ‰ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯æ‹¿imgã€isoæ˜ å°„åˆ°loopè®¾å¤‡ã€‚</strong></u></p><h2 id="2-apexåŒ…ç»“æ„"><a href="#2-apexåŒ…ç»“æ„" class="headerlink" title="2.apexåŒ…ç»“æ„"></a>2.apexåŒ…ç»“æ„</h2><p>APEXæ–‡ä»¶æ ¼å¼å¦‚ä¸‹</p><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/20200601191934566.png"><p>ä»é¡¶å±‚çœ‹ï¼ŒAPEXæ–‡ä»¶æ˜¯ä¸€ä¸ªZipæ–‡ä»¶ï¼Œå…¶ä¸­çš„æ–‡ä»¶å‡æ˜¯æœªå‹ç¼©çš„ã€‚</p><p>å…¶ä¸­çš„å››ä¸ªæ–‡ä»¶æœ‰<code>apex_manifest.json</code>ï¼Œ<code>AndroidManifest.xml</code>ï¼Œ<code>apex_pubkey</code>ï¼Œ<code>apex_payload.img</code></p><ul><li><p>apex_manifest.jsonæ–‡ä»¶åŒ…æ‹¬package nameå’Œç‰ˆæœ¬ï¼Œç”¨æ¥æ ‡è¯†è¯¥APEXæ–‡ä»¶</p></li><li><p>AndroidManifest.xmlå¯ä»¥å…è®¸APEXæ–‡ä»¶ä½¿ç”¨ä¸€äº›apkçš„å·¥å…·ï¼Œåƒadbã€package managerã€ app install appç­‰ã€‚ä¸¾ä¸ªä¾‹å­APEXæ–‡ä»¶å¯ä»¥ä½¿ç”¨aaptæ£€æŸ¥æ–‡ä»¶çš„metadataã€‚è¯¥æ–‡ä»¶è¿˜åŒ…æ‹¬packcage nameå’Œç‰ˆæœ¬å·ï¼Œè¿™äº›å†…å®¹é€šå¸¸ä¹Ÿä¼šå†apex_manifest.jsonæ–‡ä»¶ä¸­ã€‚</p></li><li><p>apex_payload.imgæ˜¯ä¾èµ–dm-verityçš„EXT4æ–‡ä»¶ç³»ç»Ÿé•œåƒã€‚è¯¥é•œåƒåœ¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå›ç¯è®¾å¤‡åŠ è½½ã€‚å…·ä½“åœ°è¯´ï¼Œmetadataå’Œhash treeæ˜¯é€šè¿‡libavbåˆ›å»ºçš„ã€‚apex_payload.imgè¿˜æ²¡æœ‰è¢«è§£æï¼Œå› ä¸ºè¦æ±‚è¯¥æ–‡ä»¶æ˜¯å¯æŒ‚è½½çš„ã€‚ä¸€äº›å¸¸è§„æ–‡ä»¶åŒ…å«åœ¨è¯¥é•œåƒä¸­ã€‚</p></li><li><p>apex_pubkeyæ˜¯ç”¨æ¥ç»™æ–‡ä»¶ç³»ç»Ÿç­¾åçš„å…¬é’¥ã€‚è¯¥å…¬é’¥ç¡®ä¿ä¸‹è½½çš„apexæ–‡ä»¶æ˜¯ä»¥ç¼–è¯‘é˜¶æ®µç›¸åŒçš„æ–¹å¼ç­¾åã€‚</p></li></ul><h2 id="3-å¼€å§‹å®éªŒ"><a href="#3-å¼€å§‹å®éªŒ" class="headerlink" title="3.å¼€å§‹å®éªŒ"></a>3.å¼€å§‹å®éªŒ</h2><ol><li><p><strong>å°†apexè§£å‹ç¼©ï¼Œä¸Šä¼ åˆ°Linuxä¸­</strong></p><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/image-20230204111723539.png"></li></ol><p>å…¶å®apexåŒ…å°±æ˜¯ä¸ªå‹ç¼©åŒ…ï¼Œå°†åç¼€åæ”¹æˆ<code>.zip</code>ï¼Œè‡ªè¡Œä½¿ç”¨Windowsè§£å‹å·¥å…·è¿›è¡Œè§£å‹</p><p><strong>ä¸Šä¼ åæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„æ–‡ä»¶ç»“æ„å’Œå®ƒçš„æ–‡ä»¶ç³»ç»Ÿå±æ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ file apex_payload.img <br>apex_payload.img: Linux rev 1.0 ext2 filesystem data, UUID=7d1522e1-9dfa-5edb-a43e-98e3a4d20250 (extents) (large files) (huge files)<br><br>amx@amxxxx:~/Android/system$ tune2fs -l apex_payload.img <br>tune2fs 1.44.5 (15-Dec-2018)<br>Filesystem volume name:   &lt;none&gt;<br>Last mounted on:          &lt;not available&gt;<br>Filesystem UUID:          7d1522e1-9dfa-5edb-a43e-98e3a4d20250<br>Filesystem magic number:  0xEF53<br>Filesystem revision <span class="hljs-comment">#:    1 (dynamic)</span><br>Filesystem features:      ext_attr dir_index filetype extent sparse_super large_file huge_file uninit_bg dir_nlink extra_isize shared_blocks<br>Filesystem flags:         signed_directory_hash <br>Default mount options:    user_xattr acl<br>Filesystem state:         clean<br>Errors behavior:          Continue<br>Filesystem OS <span class="hljs-built_in">type</span>:       Linux<br>Inode count:              32<br>Block count:              8213<br>Reserved block count:     0<br>Free blocks:              8<br>Free inodes:              5<br>First block:              0<br>Block size:               4096<br>Fragment size:            4096<br>Blocks per group:         32768<br>Fragments per group:      32768<br>Inodes per group:         32<br>Inode blocks per group:   2<br>Filesystem created:       Thu Jan  1 08:00:01 1970<br>Last mount time:          n/a<br>Last write time:          Thu Jan  1 08:00:01 1970<br>Mount count:              0<br>Maximum mount count:      -1<br>Last checked:             Thu Jan  1 08:00:01 1970<br>Check interval:           0 (&lt;none&gt;)<br>Lifetime writes:          32 MB<br>Reserved blocks uid:      0 (user root)<br>Reserved blocks gid:      0 (group root)<br>First inode:              11<br>Inode size:               256<br>Required extra isize:     32<br>Desired extra isize:      32<br>Default directory <span class="hljs-built_in">hash</span>:   half_md4<br>Directory Hash Seed:      7d1522e1-9dfa-5edb-a43e-98e3a4d20250<br></code></pre></td></tr></table></figure><ol start="2"><li><strong>æŸ¥çœ‹å½“å‰ç©ºé—²çš„loopè®¾å¤‡</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo losetup -f<br>/dev/loop0<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“å‰ç©ºé—²çš„loopè®¾å¤‡ä¸º<code>/dev/loop0</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“ç®—å°†apexä¸&#x2F;dev&#x2F;loop0è¿›è¡Œå…³è”</p><ol start="3"><li><strong>å°†apexé•œåƒä¸loopè®¾å¤‡å…³è”</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo losetup /dev/loop0 apex_payload.img<br></code></pre></td></tr></table></figure><ol start="4"><li><strong>å°†loopè®¾å¤‡æŒ‚è½½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Š</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo mount -o ro /dev/loop0 /home/amx/Android/apex/com.android.i18n<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ¨¡ä»¿äº†å®‰å“å°†å®ƒæŒ‚è½½åˆ°äº†<code>/home/amx/Android/apex/com.android.i18n</code></p><blockquote><p>è¿™é‡Œåªèƒ½ä½¿ç”¨roåªè¯»å½¢å¼æŒ‚è½½ï¼Œå› ä¸ºapex_playload.imgé‡‡ç”¨äº†ext4æ–‡ä»¶ç³»ç»Ÿï¼Œä¸”åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ äº†<code>shared_block</code>å±æ€§ï¼Œè¯¥å±æ€§ä¸å…è®¸éšæ„ä¿®æ”¹é•œåƒæ–‡ä»¶ï¼Œä¹Ÿæ˜¯ä¸ºäº†å°†é•œåƒæ–‡ä»¶å°½é‡å‹ç¼©åˆ°æœ€å°ï¼ˆä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥å…±äº«å—ï¼‰ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡æ”¹å˜inodeç»“æ„æ”¹å˜è¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯æœ‰ç‚¹éš¾åº¦ï¼Œéœ€è¦äº†è§£extæ–‡ä»¶ç³»ç»Ÿæ‰è¡Œã€‚</p></blockquote><ol start="5"><li><strong>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½æˆåŠŸ</strong></li></ol><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/image-20230204111215939.png"><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥åƒè®¿é—®å—è®¾å¤‡ä¸€æ ·è®¿é—®apexåŒ…å•¦</p><ol start="6"><li><strong>è¯´æ˜</strong></li></ol><p>çœŸå®çš„å®‰å“ç¯å¢ƒä¸­æ˜¯å…ˆsystem&#x2F;apexä¸‹é¢çš„apexåŒ…æŒ‚è½½åˆ°å¯¹åº”çš„ç‰ˆæœ¬ç›®å½•ä¸‹ï¼Œä¾‹å¦‚adbä¼šå…ˆæŒ‚è½½åˆ°<code>/apex/com.android.adb@300009</code>ï¼Œç„¶åå†å°†<code>/apex/com.android.adb@300009</code>ä»¥bindæ–¹å¼æŒ‚è½½åˆ°<code>/apex/com.android.adb</code></p><h2 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4.å‚è€ƒ"></a>4.å‚è€ƒ</h2><ul><li><a href="https://blog.csdn.net/shengxia1999/article/details/52081286?spm=1001.2014.3001.5506">https://blog.csdn.net/shengxia1999/article/details/52081286?spm=1001.2014.3001.5506</a></li><li><a href="https://blog.csdn.net/qq_28351465/article/details/106458089?spm=1001.2014.3001.5506">https://blog.csdn.net/qq_28351465/article/details/106458089?spm=1001.2014.3001.5506</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“å¼€æœºåŠ¨ç”»</title>
    <link href="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/"/>
    <url>/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹"><a href="#å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹" class="headerlink" title="å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹"></a>å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹</h1><p>å¼€æœºåŠ¨ç”»æ˜¯<strong>åœ¨SurfaceFlingerå®ä¾‹é€šè¿‡è°ƒç”¨startBootAnim()å¯åŠ¨çš„</strong>ï¼ŒBootAnimæ˜¯å¦‚ä½•å¯åŠ¨å’Œç»“æŸçš„ï¼Œæ€»ä½“æ¡†æ¶å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/æ•´ä½“æ¶æ„2.png"><h2 id="1-SurfaceFlingerè¿›ç¨‹å¯åŠ¨"><a href="#1-SurfaceFlingerè¿›ç¨‹å¯åŠ¨" class="headerlink" title="1.SurfaceFlingerè¿›ç¨‹å¯åŠ¨"></a>1.SurfaceFlingerè¿›ç¨‹å¯åŠ¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/frameworks/native/services/surfaceflinger/surfaceflinger.rc</span><br>service surfaceflinger /system/bin/surfaceflinger<br>    class core animation<br>    user system<br>    group graphics drmrpc readproc<br>    capabilities SYS_NICE<br>    onrestart restart zygote<br>    task_profiles HighPerformance<br>    socket pdx/system/vr/display/client     stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0<br>    socket pdx/system/vr/display/manager    stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0<br>    socket pdx/system/vr/display/vsync      stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0<br><br></code></pre></td></tr></table></figure><p>initè¿›ç¨‹ä¼šæ ¹æ®surfaceflinger.rcé…ç½®å¯åŠ¨surfaceflingerè¿›ç¨‹ï¼Œsurfaceflingerè¿›ç¨‹(&#x2F;system&#x2F;bin&#x2F;surfaceflinger)å¯åŠ¨ï¼Œä¼šèµ°åˆ°mainå‡½æ•°é‡Œé¢ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/frameworks/native/services/surfaceflinger/Android.bp</span><br>filegroup &#123;<br>    name: &quot;surfaceflinger_binary_sources&quot;,<br>    srcs: [<br>        &quot;:libsurfaceflinger_sources&quot;,<br>        &quot;main_surfaceflinger.cpp&quot;,<br>    ],<br>&#125;<br><br>cc_binary &#123;<br>    name: &quot;surfaceflinger&quot;,<br>    defaults: [&quot;libsurfaceflinger_binary&quot;],<br>    init_rc: [&quot;surfaceflinger.rc&quot;],<br>    srcs: [<br>        &quot;:surfaceflinger_binary_sources&quot;,<br>        // Note: SurfaceFlingerFactory is not in the filegroup so that it<br>        // can be easily replaced.<br>        &quot;SurfaceFlingerFactory.cpp&quot;,<br>    ],<br>    shared_libs: [<br>        &quot;libSurfaceFlingerProp&quot;,<br>    ],<br><br>     logtags: [&quot;EventLog/EventLogTags.logtags&quot;],<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘surfaceflingeräºŒè¿›åˆ¶è¿›ç¨‹çš„æºæ–‡ä»¶ä¸º<code>surfaceflinger_binary_sources</code>å’Œ<code>SurfaceFlingerFactory.cpp</code>ï¼Œå…¶ä¸­surfaceflinger_binary_sourcesæ¥æºäº<code>main_surfaceflinger.cpp</code></p><h2 id="2-æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡"><a href="#2-æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡" class="headerlink" title="2.æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡"></a>2.æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span>**)</span> </span>&#123;<br><span class="hljs-comment">// ...</span><br><br>    sp&lt;SurfaceFlinger&gt; flinger = surfaceflinger::<span class="hljs-built_in">createSurfaceFlinger</span>(); <span class="hljs-comment">//åˆ›å»ºsurfaceflingeræœåŠ¡å®ä¾‹</span><br><br><span class="hljs-comment">// ...</span><br>    flinger-&gt;<span class="hljs-built_in">init</span>();  <span class="hljs-comment">// åˆå§‹åŒ–flingerå®ä¾‹</span><br><br>    <span class="hljs-comment">// å‘ServiceManageræ³¨å†ŒsurfaceflingeræœåŠ¡</span><br>    <span class="hljs-function">sp&lt;IServiceManager&gt; <span class="hljs-title">sm</span><span class="hljs-params">(defaultServiceManager())</span></span>;<br>    sm-&gt;<span class="hljs-built_in">addService</span>(<span class="hljs-built_in">String16</span>(SurfaceFlinger::<span class="hljs-built_in">getServiceName</span>()), flinger, <span class="hljs-literal">false</span>,<br>                   IServiceManager::DUMP_FLAG_PRIORITY_CRITICAL | IServiceManager::DUMP_FLAG_PROTO);<br><br><span class="hljs-comment">// ...</span><br><br>    flinger-&gt;<span class="hljs-built_in">run</span>();   <span class="hljs-comment">// å¯åŠ¨surfaceflingeræœåŠ¡</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨SurfaceFlingerå¯¹è±¡çš„initæ–¹æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SurfaceFlinger::init</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    mStartPropertySetThread = <span class="hljs-built_in">getFactory</span>().<span class="hljs-built_in">createStartPropertySetThread</span>(presentFenceReliable);<br><br>    <span class="hljs-keyword">if</span> (mStartPropertySetThread-&gt;<span class="hljs-built_in">Start</span>() != NO_ERROR) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Run StartPropertySetThread failed!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">ALOGV</span>(<span class="hljs-string">&quot;Done initializing&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>SurfaceFlingerè°ƒç”¨initæ–¹æ³•æ—¶ä¼šè·å–mStartPropertySetThreadï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„Startæ–¹æ³•ï¼Œå…¶å®æ˜¯å‡†å¤‡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»å¯åŠ¨BootAnimation</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/StartPropertySetThread.cpp</span><br><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">StartPropertySetThread::Start</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">run</span>(<span class="hljs-string">&quot;SurfaceFlinger::StartPropertySetThread&quot;</span>, PRIORITY_NORMAL);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">StartPropertySetThread::threadLoop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Set property service.sf.present_timestamp, consumer need check its readiness</span><br>    <span class="hljs-built_in">property_set</span>(kTimestampProperty, mTimestampPropertyValue ? <span class="hljs-string">&quot;1&quot;</span> : <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// æ¸…é™¤BootAnimationé€€å‡ºæ ‡å¿—ä½service.bootanim.exit</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.exit&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// è®¾ç½®bootanimçš„è¿›åº¦ä¸º0</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.progress&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// é€šè¿‡service.bootanim.exit</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ctl.start&quot;</span>, <span class="hljs-string">&quot;bootanim&quot;</span>);<br>    <span class="hljs-comment">// ç«‹å³é€€å‡º</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¿™é‡Œä¸€å¼€å§‹çœ‹èµ·æ¥æ¯”è¾ƒç–‘æƒ‘ï¼Œé¦–å…ˆæ˜¯StartPropertySetThread::Startå‡½æ•°ï¼Œåœ¨<code>StartPropertySetThread.h</code>è¡¨æ˜StartPropertySetThreadç»§æ‰¿è‡ªçˆ¶ç±»Threadï¼Œè€Œçˆ¶ç±»Threadæ˜¯ç”±&lt;utils&#x2F;Thread.h&gt; å¼•å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å­ç±»å¼•ç”¨çˆ¶ç±»æ–¹æ³•ï¼Œè¿™é‡Œçš„runå‡½æ•°å°±æ˜¯å°±æ˜¯threadçš„runæ–¹æ³•ã€‚è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»è¿è¡Œï¼Œçº¿ç¨‹åä¸ºâ€StartPropertySetThreadâ€ï¼Œçº¿ç¨‹ä¼˜å…ˆçº§ä¸ºPRIORITY_NORMALã€‚çº¿ç¨‹å¯åŠ¨ä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>_threadLoop</code> å‡½æ•°ï¼Œå®ƒä¼šå»è°ƒç”¨threadLoopå‡½æ•°ã€‚è¿™é‡Œæ•´ä¸ªå‡½æ•°è°ƒç”¨æ ˆå°±æ¸…æ¥šäº†ï¼š</li></ul><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/çº¿ç¨‹å‡½æ•°è°ƒç”¨.png"><ul><li>å½“ç³»ç»Ÿå±æ€§å‘ç”Ÿæ”¹å˜æ—¶ï¼Œinitè¿›ç¨‹å°±ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿå±æ€§å˜åŒ–é€šçŸ¥ï¼Œè¿™ä¸ªé€šçŸ¥æœ€ç»ˆæ˜¯ç”±åœ¨initè¿›ç¨‹ä¸­çš„å‡½æ•°handle_property_set_fdæ¥å¤„ç†</li></ul><h2 id="3-bootanimè¿›ç¨‹å¯åŠ¨"><a href="#3-bootanimè¿›ç¨‹å¯åŠ¨" class="headerlink" title="3.bootanimè¿›ç¨‹å¯åŠ¨"></a>3.bootanimè¿›ç¨‹å¯åŠ¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// /frameworks/base/cmds/bootanimation/bootanimation_main.cpp</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    setpriority(PRIO_PROCESS, <span class="hljs-number">0</span>, ANDROID_PRIORITY_DISPLAY);<br><br>    <span class="hljs-type">bool</span> noBootAnimation = bootAnimationDisabled();<br>    ALOGI_IF(noBootAnimation,  <span class="hljs-string">&quot;boot animation disabled&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!noBootAnimation) &#123;<br>        <span class="hljs-comment">// å¯åŠ¨Binderçº¿ç¨‹æ± </span><br>        sp&lt;ProcessState&gt; <span class="hljs-title function_">proc</span><span class="hljs-params">(ProcessState::self())</span>;<br>        ProcessState::self()-&gt;startThreadPool();<br>        <br>        sp&lt;BootAnimation&gt; boot = new BootAnimation(audioplay::createAnimationCallbacks());<br><br>        waitForSurfaceFlinger();<br>        <br>        boot-&gt;run(<span class="hljs-string">&quot;BootAnimation&quot;</span>, PRIORITY_DISPLAY);<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">bootAnimationDisabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> value[PROPERTY_VALUE_MAX];<br>    <span class="hljs-comment">// å¦‚æœdebug.sf.nobootanimation=1ï¼Œåˆ™ä¸ä¼šæ˜¾ç¤ºåŠ¨ç”»</span><br>    property_get(<span class="hljs-string">&quot;debug.sf.nobootanimation&quot;</span>, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-keyword">if</span> (atoi(value) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><span class="hljs-comment">// å¦‚æœro.boot.quiescent=1ï¼Œåˆ™ä¸æ˜¾ç¤ºå¼€æœºåŠ¨ç”»</span><br>    property_get(<span class="hljs-string">&quot;ro.boot.quiescent&quot;</span>, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-keyword">if</span> (atoi(value) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// Only show the bootanimation for quiescent boots if this system property is set to enabled</span><br>        <span class="hljs-keyword">if</span> (!property_get_bool(<span class="hljs-string">&quot;ro.bootanim.quiescent.enabled&quot;</span>, <span class="hljs-literal">false</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ¤æ–­å®ŒBootAnimationæ˜¯ä¸æ˜¯disabledä¹‹åï¼Œå¦‚æœnoBootAnimationä¸ºfalseï¼Œåˆ™åˆ›å»ºä¸€ä¸ªBootAnimationå¯¹è±¡ã€‚åˆ›å»ºå®Œäº†BootAnimationå¯¹è±¡åï¼Œè°ƒç”¨å…¶runæ–¹æ³•ï¼Œç”±äºBootAnimationä¹Ÿç»§æ‰¿äº†Threadï¼Œæ‰€ä»¥æœ€ç»ˆä¹Ÿä¼šèµ°åˆ°å¯¹åº”çš„threadLoopæ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BootAnimation::threadLoop</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> r;<br><br>    <span class="hljs-keyword">if</span> (mZipFileName == <span class="hljs-literal">NULL</span>) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        r = <span class="hljs-built_in">movie</span>();  <span class="hljs-comment">// è°ƒç”¨movieæ–¹æ³•</span><br>    &#125;<br>    <span class="hljs-comment">// é”€æ¯ opengl å’Œ egl</span><br>    <span class="hljs-built_in">eglMakeCurrent</span>(mDisplay, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);<br>    <span class="hljs-built_in">eglDestroyContext</span>(mDisplay, mContext);<br>    <span class="hljs-built_in">eglDestroySurface</span>(mDisplay, mSurface);<br>    mFlingerSurface.<span class="hljs-built_in">clear</span>();<br>    mFlingerSurfaceControl.<span class="hljs-built_in">clear</span>();<br>    <span class="hljs-built_in">eglTerminate</span>(mDisplay);<br>    IPCThreadState::<span class="hljs-built_in">self</span>()-&gt;<span class="hljs-built_in">stopProcess</span>();<br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BootAnimation::movie</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    String8 desString;<br>    <span class="hljs-comment">// è¯»å– desc.txt é…ç½®æ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">readFile</span>(<span class="hljs-string">&quot;desc.txt&quot;</span>, desString)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-type">char</span> <span class="hljs-type">const</span>* s = desString.<span class="hljs-built_in">string</span>();<br><br>    <span class="hljs-comment">// è§£ææè¿°æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i=<span class="hljs-number">0</span> ; i&lt;pcount ; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> r=<span class="hljs-number">0</span> ; !part.count || r&lt;part.count ; r++) &#123;<br>            <span class="hljs-comment">// opengl ç»˜åˆ¶æ“ä½œ</span><br>            <span class="hljs-built_in">glClearColor</span>(<br>                    part.backgroundColor[<span class="hljs-number">0</span>],<br>                    part.backgroundColor[<span class="hljs-number">1</span>],<br>                    part.backgroundColor[<span class="hljs-number">2</span>],<br>                    <span class="hljs-number">1.0f</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j=<span class="hljs-number">0</span> ; j&lt;fcount &amp;&amp; (!<span class="hljs-built_in">exitPending</span>() || part.playUntilComplete) ; j++) &#123;<br>                <span class="hljs-function"><span class="hljs-type">const</span> Animation::Frame&amp; <span class="hljs-title">frame</span><span class="hljs-params">(part.frames[j])</span></span>;<br>                <span class="hljs-type">nsecs_t</span> lastFrame = <span class="hljs-built_in">systemTime</span>();<br>                ...<br>                <span class="hljs-keyword">if</span> (r &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, frame.tid);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    ...<br>                    <span class="hljs-built_in">initTexture</span>(frame);<br>                &#125;<br>                <br>                <span class="hljs-comment">// specify the y center as ceiling((mHeight - animation.height) / 2)</span><br>                <span class="hljs-comment">// which is equivalent to mHeight - (yc + animation.height)</span><br>                <span class="hljs-built_in">glDrawTexiOES</span>(xc, mHeight - (yc + animation.height),<br>                              <span class="hljs-number">0</span>, animation.width, animation.height);<br>                <span class="hljs-built_in">eglSwapBuffers</span>(mDisplay, mSurface);<br><br>                <span class="hljs-comment">// ä¸æ–­ç»˜åˆ¶æ—¶æ£€æµ‹æ˜¯å¦éœ€è¦é€€å‡º</span><br>                <span class="hljs-built_in">checkExit</span>();<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœé€€å‡ºäº†å°±è·³å‡ºç»“æŸç»˜åˆ¶</span><br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exitPending</span>() &amp;&amp; !part.count)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// free the textures for this part</span><br>        <span class="hljs-keyword">if</span> (part.count != <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j=<span class="hljs-number">0</span> ; j&lt;fcount ; j++) &#123;<br>                <span class="hljs-function"><span class="hljs-type">const</span> Animation::Frame&amp; <span class="hljs-title">frame</span><span class="hljs-params">(part.frames[j])</span></span>;<br>                <span class="hljs-built_in">glDeleteTextures</span>(<span class="hljs-number">1</span>, &amp;frame.tid);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">// è¯»å– service.bootanim.exit å€¼æ˜¯å¦æ˜¯ 1 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXIT_PROP_NAME <span class="hljs-string">&quot;service.bootanim.exit&quot;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BootAnimation::checkExit</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Allow surface flinger to gracefully request shutdown</span><br>    <span class="hljs-type">char</span> value[PROPERTY_VALUE_MAX];<br>    <span class="hljs-built_in">property_get</span>(EXIT_PROP_NAME, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-type">int</span> exitnow = <span class="hljs-built_in">atoi</span>(value);<br>    <span class="hljs-keyword">if</span> (exitnow) &#123;<br>        <span class="hljs-built_in">requestExit</span>();<br>        <span class="hljs-keyword">if</span> (mAudioPlayer != <span class="hljs-literal">NULL</span>) &#123;<br>            mAudioPlayer-&gt;<span class="hljs-built_in">requestExit</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨åŠ¨ç”»åº•å±‚é‡‡ç”¨çš„æ˜¯ opengles çš„æ–¹å¼æ¥æ¸²æŸ“ç»˜åˆ¶çš„ï¼Œç»˜åˆ¶çš„å†…å®¹æ˜¯æœ¬åœ°çš„ä¸€ä¸ªå¯åŠ¨åŠ¨ç”»èµ„æºåŒ…ï¼Œåœ¨ç»˜åˆ¶çš„è¿‡ç¨‹ä¸­ä¼šä¸æ–­çš„åˆ¤æ–­æ˜¯å¦éœ€è¦é€€å‡ºï¼Œè¯»å–çš„å­—æ®µæ˜¯ service.bootanim.exit ï¼Œä¸º 1 ä»£è¡¨éœ€è¦ break é€€å‡ºå¾ªç¯ç»˜åˆ¶ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ° service.bootanim.exit åœ¨å“ªé‡Œè®¾ç½®ä¸º 1 çš„ï¼Œä¾¿å¯æ‰¾åˆ°é€€å‡ºå¯åŠ¨åŠ¨ç”»çš„å…¥å£ã€‚å…³é—­åŠ¨ç”»çš„å…¥å£è¿˜æ˜¯åœ¨ SurfaceFlinger ä¸­åªæ˜¯è¿™ä¸ªè°ƒç”¨æµç¨‹æ¯”è¾ƒå¤æ‚è€Œå·²ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-type">void</span> <span class="hljs-title">handleResumeActivity</span><span class="hljs-params">(IBinder token,</span></span><br><span class="hljs-params"><span class="hljs-function">                                boolean clearHide, boolean isForward, boolean reallyResume)</span> </span>&#123;<br>    ActivityClientRecord r = <span class="hljs-built_in">performResumeActivity</span>(token, clearHide);<br>    <span class="hljs-keyword">if</span> (r != null) &#123;<br>        <span class="hljs-keyword">if</span> (!r.onlyLocalRequest) &#123;<br>            r.nextIdle = mNewActivities;<br>            mNewActivities = r;<br>            <span class="hljs-comment">// æ·»åŠ äº†ä¸€ä¸ª IdleHandler æ¶ˆæ¯</span><br>            Looper.<span class="hljs-built_in">myQueue</span>().<span class="hljs-built_in">addIdleHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Idler</span>());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ...<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> Idler implements MessageQueue.IdleHandler &#123;<br>    @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> boolean <span class="hljs-built_in">queueIdle</span>() &#123;<br>        ActivityClientRecord a = mNewActivities;<br>        <span class="hljs-keyword">if</span> (a != null) &#123;<br>            mNewActivities = null;<br>            IActivityManager am = ActivityManagerNative.<span class="hljs-built_in">getDefault</span>();<br>            ActivityClientRecord prev;<br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-keyword">if</span> (a.activity != null &amp;&amp; !a.activity.mFinished) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// è°ƒç”¨ AMS çš„ activityIdle</span><br>                        am.<span class="hljs-built_in">activityIdle</span>(a.token, a.createdConfig, stopProfiling);<br>                    &#125; <span class="hljs-built_in">catch</span> (RemoteException ex) &#123;<br>                        <span class="hljs-comment">// Ignore</span><br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">while</span> (a != null);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><br>@<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">void</span> <span class="hljs-title">activityIdle</span><span class="hljs-params">(IBinder token, Configuration config, boolean stopProfiling)</span> </span>&#123;<br>    <span class="hljs-built_in">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>        ActivityStack stack = ActivityRecord.<span class="hljs-built_in">getStackLocked</span>(token);<br>        <span class="hljs-keyword">if</span> (stack != null) &#123;<br>            ActivityRecord r = mStackSupervisor.<span class="hljs-built_in">activityIdleInternalLocked</span>(token, <span class="hljs-literal">false</span>, config);<br>        &#125;<br>    &#125;<br>    Binder.<span class="hljs-built_in">restoreCallingIdentity</span>(origId);<br>&#125;<br><br><span class="hljs-comment">// Checked.</span><br><span class="hljs-function"><span class="hljs-keyword">final</span> ActivityRecord <span class="hljs-title">activityIdleInternalLocked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> IBinder token, boolean fromTimeout,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                Configuration config)</span> </span>&#123;<br>    ActivityRecord r = ActivityRecord.forTokenLocked(token);<br>    <span class="hljs-keyword">if</span> (r != null) &#123;<br>        ...<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isFrontStack</span>(r.task.stack) || fromTimeout) &#123;<br>                booting = <span class="hljs-built_in">checkFinishBootingLocked</span>();<br>            &#125;<br>    &#125;<br>    ...<br>        <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> boolean <span class="hljs-title">checkFinishBootingLocked</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> boolean booting = mService.mBooting;<br>    boolean enableScreen = <span class="hljs-literal">false</span>;<br>    mService.mBooting = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!mService.mBooted) &#123;<br>        mService.mBooted = <span class="hljs-literal">true</span>;<br>        enableScreen = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (booting || enableScreen) &#123;<br>        mService.<span class="hljs-built_in">postFinishBooting</span>(booting, enableScreen);<br>    &#125;<br>    <span class="hljs-keyword">return</span> booting;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">enableScreenAfterBoot</span><span class="hljs-params">()</span> </span>&#123;<br>    mWindowManager.<span class="hljs-built_in">enableScreenAfterBoot</span>();<br>    <span class="hljs-built_in">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>        <span class="hljs-built_in">updateEventDispatchingLocked</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">performEnableScreen</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">synchronized</span>(mWindowMap) &#123;<br>        <span class="hljs-keyword">if</span> (!mBootAnimationStopped) &#123;<br>            <span class="hljs-comment">// å‘SurfaceFlinger è¿›ç¨‹å‘èµ·å…³é—­å¼€æœºç•Œé¢çš„æ¶ˆæ¯</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                IBinder surfaceFlinger = ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">&quot;SurfaceFlinger&quot;</span>);<br>                <span class="hljs-keyword">if</span> (surfaceFlinger != null) &#123;<br>                    Parcel data = Parcel.<span class="hljs-built_in">obtain</span>();<br>                    data.<span class="hljs-built_in">writeInterfaceToken</span>(<span class="hljs-string">&quot;android.ui.ISurfaceComposer&quot;</span>);<br>                    <span class="hljs-comment">// å‘SurfaceComposerå‘é€</span><br>                    surfaceFlinger.<span class="hljs-built_in">transact</span>(IBinder.FIRST_CALL_TRANSACTION, <span class="hljs-comment">// BOOT_FINISHED</span><br>                                            data, null, <span class="hljs-number">0</span>);<br>                    data.<span class="hljs-built_in">recycle</span>();<br>                &#125;<br>            &#125; <span class="hljs-built_in">catch</span> (RemoteException ex) &#123;<br>                ...<br>            &#125;<br>            mBootAnimationStopped = <span class="hljs-literal">true</span>;<br>        &#125;<br>        ...<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ----------------------------------------------------------------------</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">ISurfaceComposerTag</span> &#123;<br>    BOOT_FINISHED = IBinder::FIRST_CALL_TRANSACTION,<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// /frameworks/native/libs/gui/ISurfaceComposer.cpp</span><br><span class="hljs-type">status_t</span> BnSurfaceComposer::<span class="hljs-built_in">onTransact</span>(<br>    <span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel&amp; data, Parcel* reply, <span class="hljs-type">uint32_t</span> flags)&#123;<br>    <span class="hljs-keyword">switch</span>(code) &#123;<br>            <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">case</span> BOOT_FINISHED: &#123;<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(ISurfaceComposer, data, reply);<br>            <span class="hljs-built_in">bootFinished</span>();<br>            <span class="hljs-keyword">return</span> NO_ERROR;<br>        &#125;<br>            <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">// ----------------------------------------------------------------------</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SurfaceFlinger::bootFinished</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// æŠŠ service.bootanim.exit å±æ€§è®¾ç½®ä¸º 1 ï¼Œbootanim è¿›ç¨‹è¯»åˆ° 1 æ—¶å°±ä¼šé€€å‡ºå¼€æœºå¯åŠ¨åŠ¨ç”»</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.exit&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é—­å¼€æœºå¯åŠ¨åŠ¨ç”»çš„æµç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæˆ‘ä»¬æ¥ç¼•ä¸€ç¼•æ•´ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬çš„ Launcher è¿›ç¨‹å¯åŠ¨åä¼šå¯åŠ¨æˆ‘ä»¬ Launcher Activity ç•Œé¢ï¼Œè€Œ Activity çš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨éƒ½æ˜¯ç”± ActivityThread æ¥æ‰§è¡Œçš„ï¼Œå…¶ä¸­å°±ä¼šæ‰§è¡Œåˆ° handleResumeActivity æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šæ·»åŠ ä¸€ä¸ª IdleHandler æ¶ˆæ¯ï¼Œä¼šè°ƒç”¨åˆ° AMS çš„ activityIdle æ–¹æ³•ï¼ŒAMS ä¼šè°ƒç”¨ WMS çš„ enableScreenAfterBoot æ–¹æ³•ï¼ŒWMS ä¼šè·¨è¿›ç¨‹é€šçŸ¥ SurfaceFlinger å»å…³é—­æˆ‘ä»¬çš„å¼€æœºå¯åŠ¨åŠ¨ç”»ã€‚</p><h2 id="4-å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ"><a href="#4-å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ" class="headerlink" title="4.å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ"></a>4.å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ</h2><p>è¿™é‡Œå»ºè®®å…ˆçœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š&#x2F;frameworks&#x2F;base&#x2F;cmds&#x2F;bootanimation&#x2F;FORMAT.md</p><p>å¼€æœºåŠ¨ç”»æŒ‡çš„æ˜¯ä»¥bootanimation.zipæ–¹å¼å­˜åœ¨ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šä¾æ¬¡é€‰æ‹©ä¸€ä¸ªbootanimation.zipåŠ è½½</p><ol><li>&#x2F;system&#x2F;media&#x2F;bootanimation-encrypted.zip (if getprop(â€œvold.decryptâ€) &#x3D; â€˜1â€™)</li><li>&#x2F;system&#x2F;media&#x2F;bootanimation.zip</li><li>&#x2F;oem&#x2F;media&#x2F;bootanimation.zip</li></ol><p><code>bootanimation.zip</code> æ–‡ä»¶ä¸­åŒ…å«ï¼š</p><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/å‹ç¼©æ–‡ä»¶.png"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">desc.txt - a text file<br>part0  \<br>part1   \  directories full of PNG frames<br>...     /<br>partN  /<br></code></pre></td></tr></table></figure><p><strong>â€œdesc.txtâ€</strong>ï¼š<strong>ç”¨æ¥æè¿°ç”¨æˆ·è‡ªå®šä¹‰çš„å¼€æœºåŠ¨ç”»æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„</strong>ã€‚</p><p>ä»¥ä¸‹é¢çš„ä¾‹å­ä¸ºä¾‹ï¼š</p><blockquote><p>1280 720 1</p><p>p 1 1 part0</p><p>p 0 1 part1</p></blockquote><p>ç¬¬ä¸€è¡Œçš„ä¸‰ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºå¼€æœºåŠ¨ç”»åœ¨å±å¹•ä¸­çš„æ˜¾ç¤ºå®½åº¦ã€é«˜åº¦ä»¥åŠå¸§é€Ÿ(fps)ã€‚å‰©ä½™çš„æ¯ä¸€è¡Œéƒ½ç”¨æ¥æè¿°ä¸€ä¸ªåŠ¨ç”»ç‰‡æ–­ï¼Œè¿™äº›è¡Œå¿…é¡»è¦ä»¥å­—ç¬¦â€œpâ€æ¥å¼€å¤´ï¼Œåé¢ç´§è·Ÿç€ä¸¤ä¸ªæ•°å­—ä»¥åŠä¸€ä¸ªæ–‡ä»¶ç›®å½•è·¯å¾„åç§°ã€‚</p><p>ç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤ºä¸€ä¸ªç‰‡æ–­çš„å¾ªç¯æ˜¾ç¤ºæ¬¡æ•°ï¼Œå¦‚æœå®ƒçš„å€¼ç­‰äº0ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºæ— é™å¾ªç¯åœ°æ˜¾ç¤ºè¯¥åŠ¨ç”»ç‰‡æ–­ã€‚</p><p>ç¬¬äºŒä¸ªæ•°å­—è¡¨ç¤ºæ¯ä¸€ä¸ªç‰‡æ–­åœ¨ä¸¤æ¬¡å¾ªç¯æ˜¾ç¤ºä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚è¿™ä¸ªæ—¶é—´é—´éš”æ˜¯ä»¥ä¸€ä¸ªå¸§çš„æ—¶é—´ä¸ºå•ä½çš„ã€‚</p><p>æ–‡ä»¶ç›®å½•ä¸‹é¢ä¿å­˜çš„æ˜¯ä¸€ç³»åˆ—pngæ–‡ä»¶ï¼Œè¿™äº›pngæ–‡ä»¶ä¼šè¢«ä¾æ¬¡æ˜¾ç¤ºåœ¨å±å¹•ä¸­ã€‚</p><h2 id="å‚è€ƒèµ„æ–™ï¼š"><a href="#å‚è€ƒèµ„æ–™ï¼š" class="headerlink" title="å‚è€ƒèµ„æ–™ï¼š"></a>å‚è€ƒèµ„æ–™ï¼š</h2><ul><li><a href="https://blog.51cto.com/u_11176305/3796348">https://blog.51cto.com/u_11176305/3796348</a></li><li><a href="https://www.cnblogs.com/lufeibin/p/13529981.html">https://www.cnblogs.com/lufeibin/p/13529981.html</a></li><li><a href="https://blog.csdn.net/weixin_36044720/article/details/117277602?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_36044720/article/details/117277602?spm=1001.2014.3001.5506</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android-Trebleè®¡åˆ’</title>
    <link href="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/"/>
    <url>/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/</url>
    
    <content type="html"><![CDATA[<ul><li>ğŸ•Šï¸æœ¬æ–‡æ¥è‡ªè§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=zbebx1Kvqho">https://www.youtube.com/watch?v=zbebx1Kvqho</a></li><li>å¼•ç”¨éƒ¨åˆ†åšå®¢ï¼š<a href="https://new.qq.com/rain/a/20191016A070PF00">https://new.qq.com/rain/a/20191016A070PF00</a></li><li><a href="https://www.freesion.com/article/69471423144/">https://www.freesion.com/article/69471423144/</a></li></ul><h2 id="1-Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜"><a href="#1-Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜" class="headerlink" title="1.Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜"></a>1.Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜</h2><p>åœ¨Android 8.0ï¼ˆAndroid Oreoï¼‰ä¹‹å‰é‚£ä¸ªæ—¶ä»£ï¼Œè‹¹æœæ‰‹æœºä¸€æ—¦æœ‰äº†æ–°çš„ç³»ç»Ÿæ›´æ–°ï¼Œç”¨æˆ·éƒ½èƒ½åœ¨çŸ­æ—¶é—´å†…æ›´æ–°ç³»ç»Ÿï¼Œå¯¹ç”¨æˆ·æ¥è¯´å®åœ¨å¤ªç®€å•äº†ï¼Œç”¨æˆ·åªéœ€è¦ç‚¹å‡»æ›´æ–°ä¸‹è½½æ–°ç³»ç»Ÿå°±å¯ä»¥å®Œç¾çš„æ‹¥æœ‰æœ€æ–°çš„ç³»ç»ŸåŠŸèƒ½ã€‚è€Œå¯¹äºå®‰å“ç”¨æˆ·è€Œè¨€ï¼Œå½“å®‰å“å‘å¸ƒæ–°çš„æºç ä»¥åï¼Œä¼šç»è¿‡ä¸‹é¢ä¸€ç³»åˆ—çš„æ“ä½œï¼Œç”¨æˆ·æ‰èƒ½ç”¨ä¸ŠçœŸæ­£çš„å…¨æ–°å®‰å“ç³»ç»Ÿã€‚</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/ç”Ÿæˆè¿‡ç¨‹.png" style="zoom: 80%;"><ol><li>å‘å¸ƒæºç ï¼šGoogleå°†æ–°ç³»ç»Ÿæºç å‘å¸ƒè‡³AOSP</li><li>å¯åŠ¨ç¡¬ä»¶é€‚é…ï¼šèŠ¯ç‰‡åˆ¶é€ å•†å¦‚<strong>ä¸‰æ˜Ÿ</strong>ã€<strong>é«˜é€š</strong>ã€<strong>è”å‘ç§‘</strong>ã€<strong>åä¸º</strong>ç­‰å¯¹æºç è¿›è¡Œä¿®æ”¹ï¼Œç¡®ä¿è‡ªå®¶çš„èŠ¯ç‰‡åœ¨æ–°ç‰ˆAndroidèƒ½æ­£å¸¸è¿è¡Œå’Œå‘æŒ¥æ€§èƒ½</li><li>OEMé€‚é…ï¼šOEM å‚å•†è¿›ä¸€æ­¥ä¿®æ”¹æ–°ç³»ç»Ÿ</li><li>OEMæµ‹è¯•ï¼šOEM å‚å•†å¯¹ç³»ç»Ÿè¿›è¡Œå†…éƒ¨æµ‹è¯•</li><li>æ¨é€ç»™ç”¨æˆ·ï¼šè¯•æ— è¯¯åçš„æ–°ç‰ˆç³»ç»Ÿé€šè¿‡ OTA æ¨é€ç»™ç”¨æˆ·</li></ol><p>è¿™æ ·å¸¦æ¥çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Œç”¨è°·æ­Œå¼€å‘å›¢é˜Ÿçš„è¯æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šèŠ±è´¹5-12ä¸ªæœˆçš„æ—¶é—´â€¦â€¦å¯„ğŸ“</p><p>è™½ç„¶Googleåœ¨æäº¤AOSPæºç ä¸Šéå¸¸è¿…é€Ÿï¼Œä½†æ˜¯èŠ¯ç‰‡åˆ¶é€ å•†å’ŒOEMå‚å•†å¾€å¾€å› ä¸ºæŠ€æœ¯é—®é¢˜ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®šåˆ¶åŸå› ç­‰å¯¼è‡´æ•´ä½“çš„è¿›ç¨‹åæ…¢ï¼Œæœ€ç»ˆå½¢æˆäº†ç”¨æˆ·èŒ«èŒ«ç„¶çš„ç­‰å¾…ï¼Œä»ä»¥å¾€çš„æ•°æ®ç»Ÿè®¡æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒAndroidæ‰‹æœºä¸­æ–°ç³»ç»Ÿçš„è¦†ç›–ç‡å¯¥å¯¥æ— å‡ ã€‚</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/licheng.png" style="zoom: 50%;"><blockquote><p>å¯ä»¥çœ‹åˆ°è‡ªä»å®‰å“8.0é€€å‡ºTrebleä»¥æ¥ï¼Œå®‰å“9.0å¼€å§‹çªé£çŒ›è¿›ï¼Œæ›´æ–°çš„ç”¨æˆ·å‡ ä¹æ˜¯8.0çš„ä¸€å€</p></blockquote><h2 id="2-Trebleè®¡åˆ’"><a href="#2-Trebleè®¡åˆ’" class="headerlink" title="2.Trebleè®¡åˆ’"></a>2.Trebleè®¡åˆ’</h2><h3 id="2-1-Trebleç®€ä»‹"><a href="#2-1-Trebleç®€ä»‹" class="headerlink" title="2.1 Trebleç®€ä»‹"></a>2.1 Trebleç®€ä»‹</h3><p>Android 8.0 ç‰ˆæœ¬çš„ä¸€é¡¹æ–°å…ƒç´ æ˜¯ Project Trebleã€‚è¿™æ˜¯ Androidæ¶æ„æ–¹é¢çš„ä¸€é¡¹é‡å¤§æ”¹å˜ï¼Œä¸»è¦è§£å†³Android ç‰ˆæœ¬ç¢ç‰‡åŒ–é—®é¢˜ï¼Œæ›´æ–¹ä¾¿å¿«æ·çš„å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚å…¶ä¸­æœ€æ ¸å¿ƒçš„ä¸€ç‚¹æ˜¯å°†AOSPä»£ç å’Œä¾›åº”å•†ï¼ˆVendorï¼‰ä»£ç åšå¥½è§£è€¦ã€‚è´´ä¸€å¼ å¼ æ¶æ„å‰åçš„å¯¹æ¯”å›¾ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¶æ„å˜åŒ–.png"><ul><li>å‡çº§å‰ï¼šFrameworkä»£ç å’ŒVendorçš„ä»£ç è€¦åˆï¼Œå³ä½¿è°·æ­Œå‘å¸ƒä¼šå®Œæœ€æ–°AOSPä»£ç ï¼Œè®¾å¤‡å‚å•†ä¹Ÿéœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´å¤„ç†å’ŒVendorä»£ç é€‚é…é—®é¢˜ã€Reworkedã€‘ï¼Œæ‰€ä»¥å‡çº§ä¼šèŠ±è´¹å¾ˆå¤§é‡çš„æ—¶é—´</li></ul><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ–°æ¶æ„.png"><ul><li>æ–°çš„æ¶æ„ï¼šTrebleåœ¨Frameworkå’ŒVendorå®ç°ä»£ç ä¸­é—´å®šä¹‰ä¸€ä¸ªç¨³å®šçš„æ¥å£ï¼Œè¿™æ ·Frameworkä»£ç å’ŒVendorçš„ä»£ç å®ç°è§£è€¦ï¼Œè¿™æ ·è®¾å¤‡å‚å•†èƒ½å¤Ÿå¿«é€Ÿçš„å‡çº§AOSPï¼Œåªè¦æ¥å£ä¸å˜ï¼Œç³»ç»Ÿè¿˜èƒ½æ­£å¸¸èµ·æ¥ã€‚</li></ul><p>ä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹ä»¥å‰çš„Frameworkå±‚å’ŒHALå±‚æ˜¯æ€ä¹ˆäº¤äº’çš„ï¼Ÿ</p><p><strong>Android Oä¹‹å‰ç‰ˆæœ¬çš„æ¡†æ¶ï¼š</strong></p><p>åœ¨æ­¤ä¹‹å‰çš„Android ç³»ç»Ÿæ¶æ„å½“ä¸­ï¼ŒAndroid Framework ä¸Android HALæ˜¯æ‰“åŒ…æˆä¸€ä¸ªsystem.imgçš„ï¼Œè€Œä¸”Framework ä¸HALä¹‹é—´æ˜¯ç´§è€¦åˆçš„ï¼Œé€šè¿‡é“¾æ¥çš„æ–¹å¼ä½¿ç”¨ç›¸åº”çš„ç¡¬ä»¶ç›¸å…³soåº“ã€‚è€ç‰ˆæœ¬çš„android çš„ç³»ç»Ÿæ¡†æ¶å½“ä¸­frameworkä¸HALä¹‹é—´çš„ä¸€èˆ¬æ¶æ„æ¡†æ¶æ˜¯ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¡†æ¶.png"><p>æ‰€ä»¥æ¯æ¬¡Android frameworkçš„å‡çº§éœ€è¦å¯¹åº”çš„Android HALå‡çº§ã€‚æ‰€ä»¥è¿™æ ·æ¯æ¬¡Android å‡çº§éƒ½éœ€è¦Android è®¾å¤‡åˆ¶é€ å•†æŠ•å…¥å¤§é‡çš„äººåŠ›ç‰©ç†å»å‡çº§ç›¸åº”çš„Vendor HAL Implemetation.</p><p><strong>Android OåŠä¹‹åçš„ç‰ˆæœ¬çš„æ¡†æ¶ï¼š</strong></p><p>åœ¨Android Oä»¥åŠä»¥åçš„ç‰ˆæœ¬å½“ä¸­ï¼ŒAndroid æ›´æ–°äº†æ–°çš„æ¡†æ¶è®¾è®¡åœ¨æ–°çš„æ¡†æ¶è®¾è®¡å½“ä¸­ï¼Œå¼•å…¥äº†ä¸€å¥—å«HIDLçš„è¯­è¨€æ¥å®šä¹‰Freameworkä¸HALä¹‹é—´çš„æ¥å£ï¼Œæ–°çš„æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/HIDL.png"><p>è·Ÿä»¥å¾€çš„Android ç‰ˆæœ¬ç›¸æ¯”è¾ƒï¼ŒAndroid Oé‡Œä½¿ç”¨HIDLæ¥è§£è€¦System Framework ä¸Vendor HAL Implemetationä¹‹é—´çš„å…³ç³»ã€ï¼Œä»è€Œç®€åŒ–é™ä½Androidç³»ç»Ÿå‡çº§çš„å½±å“ä¸éš¾åº¦ã€‚å¹¶ä¸”ç›®å‰çœ‹èµ·æ¥ï¼ŒAndroid Frameworkä¸Vendor HAL Implemetationä¼šå­˜æ”¾åœ¨ä¸åŒçš„åˆ†åŒºå½“ä¸­ï¼ŒAndroid Frameworkä¼šåœ¨systemåˆ†åŒºå½“ä¸­ï¼Œè€ŒVendor HAL Implemetationä¼šåœ¨ä¸€ä¸ªæ–°å®šä¹‰çš„åˆ†åŒº(Vendor.img)å½“ä¸­ï¼Œè¿™æ ·åˆ·æ–°çš„system.img æ‰ä¸ä¼šå½±å“åˆ°Vendor HAL Implemetationã€‚</p><p><strong>æ›´æ¸…æ™°çš„è°ƒç”¨å…³ç³»</strong></p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/Oä¹‹å‰.png" style="zoom:70%;"><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/Oä¹‹å.png" style="zoom:70%;"><h3 id="2-2-Trebleæ–°æŠ€æœ¯"><a href="#2-2-Trebleæ–°æŠ€æœ¯" class="headerlink" title="2.2 Trebleæ–°æŠ€æœ¯"></a>2.2 Trebleæ–°æŠ€æœ¯</h3><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¶æ„å¯¹æ¯”.png"><p><strong>Trebleæ¶æ„ä¸­ä¸ºäº†å®ç°ç³»ç»Ÿå’Œä¾›åº”å•†çš„åˆ†ç¦»ï¼Œå¼•å…¥äº†è®¸å¤šæ–°æŠ€æœ¯ã€‚å…³é”®æŠ€æœ¯åŒ…æ‹¬ï¼š</strong></p><ul><li>HIDLï¼šHALæ¥å£å®šä¹‰è¯­è¨€ï¼Œç”¨äºæŒ‡å®šHALå’Œå…¶ä»–ç”¨æˆ·ä¹‹é—´çš„æ¥å£çš„ä¸€ç›´æ¥å£æè¿°è¯­è¨€(IDL)</li><li>HALï¼šè¿è¡ŒAndroid8.0æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡å¿…é¡»æ”¯æŒä½¿ç”¨HIDLè¯­è¨€ç¼–å†™çš„HALï¼Œåˆ†ä¸ºbinderized HALï¼ˆç»‘å®šå¼ï¼‰å’Œpassthrough HALï¼ˆç›´é€šå¼ï¼‰ã€‚</li><li>è®¾å¤‡æ ‘å åŠ å±‚(DTO)ï¼šå°†è®¾å¤‡æ•°(DT)åˆ†å‰²ä¸ºä¸»DTå’Œå åŠ DTã€‚å åŠ DTç”±ODMå‚å•†æä¾›ï¼Œå­˜æ”¾åœ¨ODMåˆ†åŒºã€‚é€šè¿‡å¯¹å åŠ DTçš„ä¿®æ”¹å‡çº§ï¼Œå¯ä»¥å®ç°åœ¨DTä¸­å¢åŠ è®¾å¤‡èŠ‚ç‚¹å’Œä¿®æ”¹è®¾å¤‡å±æ€§ã€‚</li><li>ä¾›åº”å•†åŸç”Ÿå¼€å‘å¥—ä»¶(VNDK)ï¼šæä¾›äº†ä¸€ç»„è®©ä¾›åº”å•†å®ç°å…¶HALçš„ä¸“ç”¨åº“ã€‚</li><li>ä¾›åº”å•†æ¥å£å¯¹è±¡(VINTF)ï¼šç”¨äºæ±‡æ€»è®¾å¤‡çš„ç›¸å…³ä¿¡æ¯å¹¶é€šè¿‡å¯æŸ¥è¯¢çš„APIæä¾›è¯¥ä¿¡æ¯ã€‚</li><li>SELinuxï¼šAndroid8.0å®ç°SELinuxç­–ç•¥çš„æ¨¡å—åŒ–å’Œå…¼å®¹æ€§ï¼Œç›®æ ‡æ˜¯ä½¿SOCä¾›åº”å•†å’ŒODMç”Ÿäº§å•†èƒ½å¤Ÿä»¥éš”ç¦»æ–¹å¼è‡ªå®šä¹‰SELinuxé…ç½®ï¼Œè€Œæ— éœ€è·¨åˆ†åŒºä¿®æ”¹ã€‚</li></ul><h2 id="ä¿®æ”¹å†å²"><a href="#ä¿®æ”¹å†å²" class="headerlink" title="ä¿®æ”¹å†å²"></a>ä¿®æ”¹å†å²</h2><ul><li>2023&#x2F;01&#x2F;14ï¼šé¦–æ¬¡ç¼–å†™ã€ŠAndroid-Trebleè®¡åˆ’ã€‹</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå­¦ä¹ ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•æ­å»ºhexoéƒ¨ç½²åˆ°github</title>
    <link href="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/"/>
    <url>/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/</url>
    
    <content type="html"><![CDATA[<blockquote><p>ğŸ“æœ¬æ–‡çš„å†…å®¹æ˜¯è®°å½•æ­å»ºhexoåšå®¢ï¼Œå¹¶ä¸”éƒ¨ç½²åˆ°githubä¸Š<br>ğŸ–å“ˆå“ˆå“ˆï¼Œæˆ‘å°±æ˜¯è¯¾ä»£è¡¨<br>ğŸ”æ‰€æœ‰å†…å®¹å‡æ¥è‡ªäºï¼š<strong>Bç«™CodeSheep</strong></p></blockquote><h2 id="1-å®‰è£…Nodejs"><a href="#1-å®‰è£…Nodejs" class="headerlink" title="1.å®‰è£…Nodejs"></a>1.å®‰è£…Nodejs</h2><h3 id="1-1-å®‰è£…Nodejs"><a href="#1-1-å®‰è£…Nodejs" class="headerlink" title="1.1 å®‰è£…Nodejs"></a>1.1 å®‰è£…Nodejs</h3><p>Nodejså®˜ç½‘ï¼š<a href="https://nodejs.org/en/">https://nodejs.org/en/</a></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/nodejså®‰è£….png" alt="image-20230114121402814" style="zoom: 67%;"><p>ç›´æ¥æ— è„‘ä¸‹ä¸€æ­¥å®‰è£…ï¼Œå®‰è£…å®Œæˆå<code>node -v</code>æŸ¥çœ‹ç‰ˆæœ¬ç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸ</p><h3 id="1-2-æ›´æ¢é•œåƒ"><a href="#1-2-æ›´æ¢é•œåƒ" class="headerlink" title="1.2 æ›´æ¢é•œåƒ"></a>1.2 æ›´æ¢é•œåƒ</h3><p>ç”±äºnpmåŒ…ç®¡ç†å·¥å…·å®åœ¨å¤ªæ…¢äº†ï¼Œæ‰€ä»¥æ‰“ç®—ä½¿ç”¨æ·˜å®é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install -g cnpm --registry=https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure><p>æœ€åå¯ä»¥é€šè¿‡<code>cnpm -v</code>æŸ¥çœ‹ä¸€ä¸‹cnpmæ˜¯å¦å®‰è£…æˆåŠŸ</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/å®‰è£…npm.png" alt="image-20230114121402814" style="zoom: 67%;"><h2 id="2-å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®"><a href="#2-å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®" class="headerlink" title="2.å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®"></a>2.å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®</h2><h3 id="2-1-å®‰è£…hexo"><a href="#2-1-å®‰è£…hexo" class="headerlink" title="2.1 å®‰è£…hexo"></a>2.1 å®‰è£…hexo</h3><p>å…ˆé€šè¿‡npmå®‰è£…hexo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cnpm install -g hexo-cli<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆä»¥åï¼Œå¯ä»¥é€šè¿‡<code>hexo -v</code> æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p><h3 id="2-2-åˆå§‹åŒ–hexoé¡¹ç›®"><a href="#2-2-åˆå§‹åŒ–hexoé¡¹ç›®" class="headerlink" title="2.2 åˆå§‹åŒ–hexoé¡¹ç›®"></a>2.2 åˆå§‹åŒ–hexoé¡¹ç›®</h3><ol><li>æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾hexoçš„æ‰€æœ‰å†…å®¹</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir hexo-blog<br></code></pre></td></tr></table></figure><ol start="2"><li>è¿›å…¥è¯¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œè¿›è¡Œåˆå§‹åŒ–</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo init<br></code></pre></td></tr></table></figure><ol start="3"><li>æœ¬åœ°æ‰“å¼€è¯¥é¡¹ç›®</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo s<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>localhost:4000</code>è¿›è¡Œè®¿é—®</p><h3 id="2-3-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"><a href="#2-3-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®" class="headerlink" title="2.3 åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"></a>2.3 åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®</h3><p>åˆ›å»ºè‡ªå·±çš„æ–°åšå®¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo new &quot;å¦‚ä½•æ­å»ºhexoéƒ¨ç½²åˆ°github&quot;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆé™æ€æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo g<br></code></pre></td></tr></table></figure><p>å¯åŠ¨é¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo s<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>localhost:4000</code>è¿›è¡Œè®¿é—®</p><h2 id="3-å°†hexoéƒ¨ç½²åˆ°github"><a href="#3-å°†hexoéƒ¨ç½²åˆ°github" class="headerlink" title="3.å°†hexoéƒ¨ç½²åˆ°github"></a>3.å°†hexoéƒ¨ç½²åˆ°github</h2><h3 id="3-1-æ–°å»ºä¸€ä¸ªgithubä»“åº“"><a href="#3-1-æ–°å»ºä¸€ä¸ªgithubä»“åº“" class="headerlink" title="3.1 æ–°å»ºä¸€ä¸ªgithubä»“åº“"></a>3.1 æ–°å»ºä¸€ä¸ªgithubä»“åº“</h3><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåˆ›å»ºçš„ä»“åº“åå¿…é¡»ä¸ä½ çš„usernameæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚æˆ‘çš„usrnameæ˜¯anmuxixixiï¼Œåˆ™åˆ›å»ºçš„ä»“åº“åä¸ºanmuxixixi.github.ioï¼›è¯¦æƒ…è§GitHubå¦‚ä½•åˆ›å»ºä¸€ä¸ªPage</p></blockquote><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/åˆ›å»ºgithub.jpg" alt="image-20230114121402814" style="zoom: 60%;"><h3 id="3-2-å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶"><a href="#3-2-å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶" class="headerlink" title="3.2 å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶"></a>3.2 å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cnpm install --save hexo-deployer-git<br></code></pre></td></tr></table></figure><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/å®‰è£…æ’ä»¶.png" alt="image-20230114121402814" style="zoom: 80%;"><h3 id="3-2-éƒ¨ç½²åˆ°github"><a href="#3-2-éƒ¨ç½²åˆ°github" class="headerlink" title="3.2 éƒ¨ç½²åˆ°github"></a>3.2 éƒ¨ç½²åˆ°github</h3><p>æ‰“å¼€é¡¹ç›®çš„<code>_config.xml</code>ï¼Œè®¾ç½®<code>deploy</code>å±æ€§</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/è®¾ç½®deploy.png" alt="image-20230114121402814" style="zoom: 80%;"><blockquote><p> è¿™ä¸ªrepoå¯¹åº”çš„ä»“åº“åå°±æ˜¯æˆ‘ä»¬çš„<strong>githubä»“åº“åœ°å€</strong></p></blockquote><p>å°†å…¶éƒ¨ç½²åˆ°githubä¸Š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo cl</span><br><span class="hljs-attribute">hexo g</span><br><span class="hljs-attribute">hexo d</span><br></code></pre></td></tr></table></figure><p>æµè§ˆå™¨è¾“å…¥<code>https://anmuxixixi.github.io/</code></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ‰“å¼€ä»“åº“.png" alt="image-20230114121402814" style="zoom: 50%;"><h2 id="4-è®¾ç½®ä¸»é¢˜"><a href="#4-è®¾ç½®ä¸»é¢˜" class="headerlink" title="4.è®¾ç½®ä¸»é¢˜"></a>4.è®¾ç½®ä¸»é¢˜</h2><h3 id="4-1-å®‰è£…ä¸»é¢˜"><a href="#4-1-å®‰è£…ä¸»é¢˜" class="headerlink" title="4.1 å®‰è£…ä¸»é¢˜"></a>4.1 å®‰è£…ä¸»é¢˜</h3><ul><li>Hexoå®˜æ–¹è®¾ç½®ä¸»é¢˜çš„ç½‘ç«™ï¼š<a href="https://hexo.io/themes/">https://hexo.io/themes/</a></li><li>Fluidä¸»é¢˜ï¼š<a href="https://github.com/fluid-dev/hexo-theme-fluid">https://github.com/fluid-dev/hexo-theme-fluid</a></li><li>Fluidä¸»é¢˜æ–‡æ¡£ï¼š<a href="https://hexo.fluid-dev.com/docs/guide/">https://hexo.fluid-dev.com/docs/guide/</a></li></ul><p>æ‰“å¼€githubï¼Œä¸‹è½½å¥½Fluidä¸»é¢˜ï¼Œå°†å…¶è§£å‹æ”¾åœ¨themesæ–‡ä»¶å¤¹ä¸‹</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/ä¸‹è½½ä¸»é¢˜.png" alt="image-20230114121402814" style="zoom: 80%;"><p>æ‰“å¼€<code>_config.xml</code>ï¼Œè®¾ç½®<code>theme</code>ä¸º<code>fluid</code>ï¼Œè®¾ç½®<code>language</code>ä¸º<code>zh-CN</code></p><p>å¯åŠ¨åçœ‹ä¸‹æ•´ä½“çš„æ•ˆæœ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo cl &amp;&amp; hexo g &amp;&amp; hexo s<br></code></pre></td></tr></table></figure><h3 id="4-2-ç®€å•çš„é¡µé¢è®¾ç½®"><a href="#4-2-ç®€å•çš„é¡µé¢è®¾ç½®" class="headerlink" title="4.2 ç®€å•çš„é¡µé¢è®¾ç½®"></a>4.2 ç®€å•çš„é¡µé¢è®¾ç½®</h3><ol><li>ä¿®æ”¹ç½‘é¡µå¯¼èˆªæ æ ‡é¢˜</li></ol><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/ä¿®æ”¹ç½‘é¡µæ ‡é¢˜.png" alt="image-20230114203236266" style="zoom:67%;"><p>å…¶å¯¹åº”çš„æ•ˆæœå¦‚ä¸‹</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ ‡é¢˜æ .png"><ol start="2"><li>ä¿®æ”¹èƒŒæ™¯å›¾ç‰‡</li></ol><p>è‡ªå·±å¤åˆ¶ä¸€å¼ å›¾ç‰‡ï¼Œå°†åå­—ä¿®æ”¹ä¸º<code>default.png</code></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/èƒŒæ™¯.png"><ol start="3"><li>ä¿®æ”¹ä¸­é—´æ‰“å­—æœºæ–‡å­—</li></ol><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ‰“å­—æœº.png" alt="image-20230114203653973" style="zoom:79%;"><ol start="4"><li>æ•´ä½“æ•ˆæœå¦‚ä¸‹</li></ol><p><a href="https://anmuxixixi.github.io/">https://anmuxixixi.github.io/</a></p><p>æ¬¢è¿å“å°ğŸŒ­</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/zhengti.png">]]></content>
    
    
    <categories>
      
      <category>è½¯ä»¶å®‰è£…</category>
      
    </categories>
    
    
    <tags>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
