<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æ¨±æ¡ƒcherryé”®ç›˜Winé”®å¤±çµ</title>
    <link href="/2024/04/21/%E6%A8%B1%E6%A1%83cherry%E9%94%AE%E7%9B%98Win%E9%94%AE%E5%A4%B1%E7%81%B5/"/>
    <url>/2024/04/21/%E6%A8%B1%E6%A1%83cherry%E9%94%AE%E7%9B%98Win%E9%94%AE%E5%A4%B1%E7%81%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨±æ¡ƒcherryé”®ç›˜Winé”®å¤±çµ"><a href="#æ¨±æ¡ƒcherryé”®ç›˜Winé”®å¤±çµ" class="headerlink" title="æ¨±æ¡ƒcherryé”®ç›˜Winé”®å¤±çµ"></a>æ¨±æ¡ƒcherryé”®ç›˜Winé”®å¤±çµ</h1><p>cherryé”®ç›˜winé”®ä¸èƒ½ç”¨ã€‚æ˜¯å› ä¸ºæœ‰ä¸¤ç§æ¨¡å¼ï¼šåŠå…¬æ¨¡å¼å’Œæ¸¸æˆæ¨¡å¼ã€‚</p><ul><li>åŠå…¬æ¨¡å¼ï¼š Windows æŒ‡ä»¤èƒ½ç”¨ã€‚</li><li>æ¸¸æˆæ¨¡å¼ï¼šWindowsé”®é”å®šï¼Œé˜²æ­¢æ„å¤–æ‰§è¡ŒWindowsæŒ‡ä»¤ã€‚</li></ul><p><code>Fn + F9</code>åˆ‡æ¢æ¨¡å¼ã€‚</p><p>æˆ‘çš„é”®ç›˜æ˜¯Cherry G80-3000sçš®å¡ä¸˜ï¼ŒæŒ‰ä½<strong>Fn + F9</strong>å°±å¯ä»¥äº†ã€‚ã€å®˜æ–¹å®£ä¼ å›¾é‡Œé¢å°±æœ‰å±å¹•WINé”®ï¼Œå¯æ¶å•ŠğŸ§¸ã€‘</p><img src="/2024/04/21/%E6%A8%B1%E6%A1%83cherry%E9%94%AE%E7%9B%98Win%E9%94%AE%E5%A4%B1%E7%81%B5/image-20240421202815207.png" alt="image-20240421202815207" style="zoom: 67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>rcu_read_lockå’Œdown_read_trylockåŒºåˆ«</title>
    <link href="/2024/04/06/rcu-read-lock%E5%92%8Cdown-read-trylock%E5%8C%BA%E5%88%AB/"/>
    <url>/2024/04/06/rcu-read-lock%E5%92%8Cdown-read-trylock%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸¤ç§é”æœºåˆ¶åŒºåˆ«"><a href="#ä¸¤ç§é”æœºåˆ¶åŒºåˆ«" class="headerlink" title="ä¸¤ç§é”æœºåˆ¶åŒºåˆ«"></a>ä¸¤ç§é”æœºåˆ¶åŒºåˆ«</h2><p><code>rcu_read_lock</code> å’Œ <code>down_read_trylock</code> éƒ½æ˜¯ Linux å†…æ ¸ä¸­çš„è¯»é”æœºåˆ¶ï¼Œä½†å®ƒä»¬ç”¨äºä¸åŒçš„ä¸Šä¸‹æ–‡å’Œç›®çš„ã€‚</p><ol><li><strong>rcu_read_lock å’Œ rcu_read_unlock</strong>:<ul><li>è¿™å¯¹å‡½æ•°ç”¨äº RCU (Read-Copy Update) æœºåˆ¶ã€‚RCU æ˜¯ä¸€ç§ç”¨äºåŒæ­¥è¯»è€…å’Œå†™è€…çš„æŠ€æœ¯ï¼Œå®ƒå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®æ•°æ®ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªå†™è€…å¯ä»¥ä¿®æ”¹æ•°æ®ã€‚RCU æœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œåœ¨å†™è€…ä¿®æ”¹æ•°æ®ä¹‹å‰ï¼Œå®ƒä¼šé¦–å…ˆä¸ºæ•°æ®åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œç„¶åä¿®æ”¹è¿™ä¸ªå‰¯æœ¬ã€‚è¯»è€…åœ¨æ­¤æœŸé—´å¯ä»¥ç»§ç»­è¯»å–åŸå§‹æ•°æ®ï¼Œè€Œä¸éœ€è¦ä»»ä½•é˜»å¡ã€‚å½“æ‰€æœ‰è¯»è€…éƒ½å®Œæˆäº†å¯¹åŸå§‹æ•°æ®çš„è¯»å–åï¼Œå†™è€…ä¼šæ›´æ–°æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æ–°çš„ã€å·²ä¿®æ”¹çš„æ•°æ®ã€‚</li><li><code>rcu_read_lock</code> ç”¨äºæ ‡è®° RCU è¯»æ“ä½œçš„å¼€å§‹ï¼Œè€Œ <code>rcu_read_unlock</code> ç”¨äºæ ‡è®°è¯»æ“ä½œçš„ç»“æŸã€‚</li><li>RCU éå¸¸é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå› ä¸ºå®ƒå…è®¸è¯»è€…åœ¨å†™è€…è¿›è¡Œæ›´æ–°æ—¶ç»§ç»­è®¿é—®æ•°æ®ã€‚</li></ul></li><li><strong>down_read_trylock</strong>:<ul><li>è¿™ä¸ªå‡½æ•°æ˜¯è¯»å†™é”ï¼ˆread-write lockï¼‰æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå°è¯•è·å–è¯»é”ï¼Œä½†ä¸ä¼šé˜»å¡ã€‚å¦‚æœè¯»é”å½“å‰å¯ç”¨ï¼ˆå³æ²¡æœ‰è¢«å†™é”æŒæœ‰ï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–è¯»é”æŒæœ‰è€…ï¼‰ï¼Œåˆ™ <code>down_read_trylock</code> ä¼šæˆåŠŸè·å–è¯»é”å¹¶è¿”å› trueã€‚å¦åˆ™ï¼Œå®ƒä¼šç«‹å³è¿”å› falseï¼Œè€Œä¸ä¼šä½¿è°ƒç”¨è€…è¿›å…¥ç¡çœ çŠ¶æ€ã€‚</li><li>è¯»å†™é”é€šå¸¸ç”¨äºæœ‰å¤šä¸ªè¯»è€…å’Œä¸€ä¸ªæˆ–å¤šä¸ªå†™è€…çš„åœºæ™¯ã€‚ä¸äº’æ–¥é”ï¼ˆmutexï¼‰ä¸åŒï¼Œè¯»å†™é”å…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è®¿é—®æ•°æ®ï¼Œä½†åœ¨æœ‰å†™è€…è®¿é—®æ—¶ï¼Œå®ƒä¼šé˜»æ­¢å…¶ä»–è¯»è€…å’Œå†™è€…ã€‚</li></ul></li></ol><p><strong>åŒºåˆ«</strong>:</p><ul><li><strong>ç”¨é€”å’Œä¸Šä¸‹æ–‡</strong>: RCU å’Œè¯»å†™é”éƒ½æ˜¯ç”¨äºåŒæ­¥çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬çš„ç”¨é€”å’Œä¸Šä¸‹æ–‡æœ‰æ‰€ä¸åŒã€‚RCU ä¸»è¦ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œè€Œè¯»å†™é”åˆ™æ›´é€šç”¨ï¼Œé€‚ç”¨äºå„ç§è¯»å†™æ¯”ä¾‹çš„åœºæ™¯ã€‚</li><li><strong>é˜»å¡è¡Œä¸º</strong>: <code>rcu_read_lock</code> ä¸ä¼šé˜»å¡ï¼Œå®ƒåªæ˜¯æ ‡è®° RCU è¯»æ“ä½œçš„å¼€å§‹ã€‚è€Œ <code>down_read_trylock</code> å°è¯•è·å–è¯»é”ï¼Œå¦‚æœé”ä¸å¯ç”¨ï¼Œå®ƒä¼šç«‹å³è¿”å› falseï¼Œä¸ä¼šé˜»å¡ã€‚</li><li><strong>å¤æ‚æ€§</strong>: RCU çš„å®ç°æ¯”è¯»å†™é”æ›´å¤æ‚ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°æ•°æ®å‰¯æœ¬çš„åˆ›å»ºå’ŒæŒ‡é’ˆçš„æ›´æ–°ã€‚è€Œè¯»å†™é”çš„å®ç°ç›¸å¯¹ç®€å•ï¼Œä¸»è¦å…³æ³¨äºè¯»è€…å’Œå†™è€…ä¹‹é—´çš„åŒæ­¥ã€‚</li></ul><p>æ€»çš„æ¥è¯´ï¼Œé€‰æ‹©ä½¿ç”¨ RCU è¿˜æ˜¯è¯»å†™é”å–å†³äºå…·ä½“çš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ã€‚åœ¨éœ€è¦é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘è¯»æ“ä½œçš„åœºæ™¯ä¸­ï¼ŒRCU å¯èƒ½æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚è€Œåœ¨å…¶ä»–è¯»å†™æ¯”ä¾‹æ›´ä¸ºå‡è¡¡çš„åœºæ™¯ä¸­ï¼Œè¯»å†™é”å¯èƒ½æ›´åˆé€‚ã€‚</p><h2 id="rw-semaphore-åŸç†ä¸ä»£ç åˆ†æ"><a href="#rw-semaphore-åŸç†ä¸ä»£ç åˆ†æ" class="headerlink" title="rw_semaphore åŸç†ä¸ä»£ç åˆ†æ"></a>rw_semaphore åŸç†ä¸ä»£ç åˆ†æ</h2><p><a href="https://blog.csdn.net/feisezaiyue/article/details/127809980">https://blog.csdn.net/feisezaiyue/article/details/127809980</a></p><img src="/2024/04/06/rcu-read-lock%E5%92%8Cdown-read-trylock%E5%8C%BA%E5%88%AB/image-20240406225928168.png" alt="image-20240406225928168" style="zoom:80%;"><h2 id="rcu-æœºåˆ¶ç®€ä»‹"><a href="#rcu-æœºåˆ¶ç®€ä»‹" class="headerlink" title="rcu æœºåˆ¶ç®€ä»‹"></a>rcu æœºåˆ¶ç®€ä»‹</h2><p><a href="https://zhuanlan.zhihu.com/p/113999842">https://zhuanlan.zhihu.com/p/113999842</a></p><img src="/2024/04/06/rcu-read-lock%E5%92%8Cdown-read-trylock%E5%8C%BA%E5%88%AB/image-20240406230704661.png" alt="image-20240406230704661" style="zoom: 80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿä¸ç­‰å¾…é˜Ÿåˆ—</title>
    <link href="/2024/03/17/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97/"/>
    <url>/2024/03/17/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿä¸ç­‰å¾…é˜Ÿåˆ—"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿä¸ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿä¸ç­‰å¾…é˜Ÿåˆ—"></a>f2fsæ–‡ä»¶ç³»ç»Ÿä¸ç­‰å¾…é˜Ÿåˆ—</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_wait_on_all_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> type)</span><br>&#123;<br>DEFINE_WAIT(wait);<br><br><span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-keyword">if</span> (!get_pages(sbi, type))<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">if</span> (type == F2FS_DIRTY_META)<br>f2fs_sync_meta_pages(sbi, META, LONG_MAX, FS_CP_META_IO);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == F2FS_WB_CP_DATA)<br>f2fs_submit_merged_write(sbi, DATA);<br><br>prepare_to_wait(&amp;sbi-&gt;cp_wait, &amp;wait, TASK_UNINTERRUPTIBLE);<br>io_schedule_timeout(DEFAULT_IO_TIMEOUT);<br>&#125;<br>finish_wait(&amp;sbi-&gt;cp_wait, &amp;wait);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>DEFINE_WAITï¼šå®šä¹‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹</li><li>f2fs_submit_merged_writeï¼šæäº¤å†™IO</li><li>prepare_to_waitï¼šå°†å®šä¹‰çš„ç­‰å¾…é˜Ÿåˆ—é¡¹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—å¤´<code>sbi-&gt;cp_wait</code>ä¸­</li><li>io_schedule_timeoutï¼šç¡çœ ä¸€å°ä¼šåå”¤é†’f2fs checkpointçº¿ç¨‹f2fs_ckptã€å³ä½¿ä¸åœ¨å…¶ä»–åœ°æ–¹ä¸»åŠ¨å”¤é†’ï¼Œä¹Ÿä¼šè¶…æ—¶å”¤é†’ã€‘</li><li>finish_waitï¼šå°†ç­‰å¾…é˜Ÿåˆ—é¡¹ä»ç­‰å¾…é˜Ÿåˆ—å¤´é‡Œé¢åˆ é™¤</li></ul><p><strong>è¿™é‡Œå¾ªç¯ä¼šä¸€ç›´è¿›è¡Œï¼Œç›´åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿä¸­ä¸å­˜åœ¨typeç±»å‹çš„é¡µ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> s64 <span class="hljs-title function_">get_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> count_type)</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-type">atomic_read</span>(&amp;sbi-&gt;nr_pages[count_type]);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å½“å†™IOå®Œæˆä»¥åï¼Œä¼šå°†è¯¥ç±»å‹çš„é¡µä»sbi-&gt;nr_pagesä¸­åˆ é™¤</strong></p><img src="/2024/03/17/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97/image-20240317224353560.png" alt="image-20240317224353560" style="zoom:50%;"><p>ğŸ§¸<strong>å› æ­¤ï¼Œf2fsæ–‡ä»¶ç³»ç»Ÿæ•´æ®µä¸ç­‰å¾…é˜Ÿåˆ—çš„æ“ä½œå°±æ˜¯åœ¨ç­‰å¾…æ‰€æœ‰çš„å†™IOå®Œæˆï¼Œè¿™ä¹Ÿä¸å‡½æ•°åf2fs_wait_on_all_pagesä¸€è‡´ã€‚</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxç­‰å¾…é˜Ÿåˆ—(é©±åŠ¨å’Œæ–‡ä»¶ç³»ç»Ÿ)</title>
    <link href="/2024/03/17/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97-%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2024/03/17/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97-%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxç­‰å¾…é˜Ÿåˆ—-é©±åŠ¨å’Œæ–‡ä»¶ç³»ç»Ÿ"><a href="#Linuxç­‰å¾…é˜Ÿåˆ—-é©±åŠ¨å’Œæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="Linuxç­‰å¾…é˜Ÿåˆ—(é©±åŠ¨å’Œæ–‡ä»¶ç³»ç»Ÿ)"></a>Linuxç­‰å¾…é˜Ÿåˆ—(é©±åŠ¨å’Œæ–‡ä»¶ç³»ç»Ÿ)</h1><h2 id="1-ç­‰å¾…é˜Ÿåˆ—"><a href="#1-ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="1.ç­‰å¾…é˜Ÿåˆ—"></a>1.ç­‰å¾…é˜Ÿåˆ—</h2><h2 id="2-é©±åŠ¨ä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—"><a href="#2-é©±åŠ¨ä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="2.é©±åŠ¨ä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—"></a>2.é©±åŠ¨ä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—</h2><p><a href="https://blog.csdn.net/qq_37596943/article/details/103795769">https://blog.csdn.net/qq_37596943/article/details/103795769</a></p><h2 id="3-æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—"><a href="#3-æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="3.æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—"></a>3.æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—</h2><p>å½“æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªæ“ä½œï¼ˆå¦‚è¯»å–æˆ–å†™å…¥æ–‡ä»¶ï¼‰éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼ˆä¾‹å¦‚ï¼Œç­‰å¾…ç£ç›˜I&#x2F;Oæ“ä½œå®Œæˆæˆ–ç­‰å¾…é”é‡Šæ”¾ï¼‰ï¼Œçº¿ç¨‹å¯ä»¥å°†è‡ªå·±åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚è¿™æ ·ï¼Œçº¿ç¨‹ä¸ä¼šç»§ç»­å ç”¨CPUèµ„æºï¼Œè€Œæ˜¯ç­‰å¾…äº‹ä»¶å‘ç”Ÿæ—¶ç”±å†…æ ¸è‡ªåŠ¨å”¤é†’ã€‚è¿™ç§æœºåˆ¶æœ‰åŠ©äºé¿å…å¿™ç­‰å¾…ï¼ˆbusy-waitingï¼‰ï¼Œæé«˜äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚</p><p>âœ…æ–‡ä»¶ç³»ç»Ÿå¸¸å¸¸ä½¿ç”¨ç­‰å¾…é˜Ÿåˆ—çš„æ¨¡æ¿ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">DEFINE_WAIT(wait);<br>prepare_to_wait(wq, &amp;wait, TASK_UNINTERRUPTIBLE);<br>schedule();<br>finish_wait(&amp;ei-&gt;i_fc_wait, &amp;wait);<br></code></pre></td></tr></table></figure><p>è¿™åªæ˜¯ç®€å•çš„ä¸€ä¸ªæ¨¡æ¿ï¼Œä¸­é—´å¯èƒ½ä¼šæœ‰ä¿¡å·é‡çš„åˆ¤æ–­æˆ–è€…ä¸€äº›è¯»å†™é”æ·»åŠ ã€‚</p><ul><li><p><code>DEFINE_WAIT(wait)</code>ï¼šå®šä¹‰äº†ä¸€ä¸ª<strong>ç­‰å¾…é˜Ÿåˆ—é¡¹</strong><code>wait</code></p></li><li><p><code>prepare_to_wait</code>ï¼šå°†å½“å‰è¿›ç¨‹æ·»åŠ åˆ°<strong>ç­‰å¾…é˜Ÿåˆ— å¤´</strong><code>wq</code> ä¸­ï¼Œå¹¶è®¾ç½®è¿›ç¨‹çŠ¶æ€ä¸º <code>TASK_UNINTERRUPTIBLE</code>ï¼Œæ„å‘³ç€è¿›ç¨‹å¯ä»¥åœ¨ç­‰å¾…æœŸé—´ä¸å¯ä»¥è¢«ä¿¡å·ä¸­æ–­</p></li><li><p><code>schedule</code>ï¼šå°†å½“å‰çº¿ç¨‹è°ƒåº¦èµ°ï¼Œè¿›å…¥ç¡çœ çŠ¶æ€</p></li><li><p><code>finish_wait</code>ï¼šï¼ˆå½“è°ƒåº¦åˆ°å½“å‰çº¿ç¨‹ï¼Œå”¤é†’ä»¥åï¼‰å°†å½“å‰ç­‰å¾…é˜Ÿåˆ—é¡¹ä»ç­‰å¾…é˜Ÿåˆ—å¤´ä¸­åˆ é™¤</p></li></ul><p>æ–‡ä»¶ç³»ç»Ÿä¸­å¸¸è§çš„ç­‰å¾…é˜Ÿåˆ—ä½¿ç”¨å¦‚ä¸‹ï¼š</p><img src="/2024/03/17/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97-%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20240317210425801.png" alt="image-20240317210425801" style="zoom:67%;"><hr><img src="/2024/03/17/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97-%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20240317210449444.png" alt="image-20240317210449444" style="zoom: 60%;"><hr><blockquote><p>å¯ä»¥å‘ç°btrfsæ–‡ä»¶ç³»ç»Ÿä¸f2fsæ–‡ä»¶ç³»ç»Ÿç›¸æ¯”ï¼Œf2fsæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨çš„æ˜¯io_schedule_timeoutï¼Œè€Œésheduleï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡æŒ¥å°ç¡ä¸€ä¼šä¼šï¼Œä¼šé‡Œé¢å”¤é†’å½“å‰çš„çº¿ç¨‹ç¡®ä¿IOå®Œæˆä¸‹å‘ã€‚</p></blockquote><img src="/2024/03/17/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97-%E9%A9%B1%E5%8A%A8%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20240317210515200.png" alt="image-20240317210515200" style="zoom:60%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ¸¯è¯¡å®å½•æˆå°±--çº¿ç´¢</title>
    <link href="/2024/03/17/%E6%B8%AF%E8%AF%A1%E5%AE%9E%E5%BD%95%E6%88%90%E5%B0%B1-%E7%BA%BF%E7%B4%A2/"/>
    <url>/2024/03/17/%E6%B8%AF%E8%AF%A1%E5%AE%9E%E5%BD%95%E6%88%90%E5%B0%B1-%E7%BA%BF%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¸¯è¯¡å®å½•æˆå°±â€“çº¿ç´¢"><a href="#æ¸¯è¯¡å®å½•æˆå°±â€“çº¿ç´¢" class="headerlink" title="æ¸¯è¯¡å®å½•æˆå°±â€“çº¿ç´¢"></a>æ¸¯è¯¡å®å½•æˆå°±â€“çº¿ç´¢</h1><p>è¿™ä¸ªæˆå°±ä¸éœ€è¦åšå…¨æœé›†é‚£äº›æ–‡ä»¶ï¼Œåªéœ€è¦åœ¨æœ€åä¸€ç« ã€Šè¯¡ç§˜å±‹é‚¨(cun)ã€‹çš„æ‘©å¤©è½®é‚£è¾¹æ‹¿åˆ°ä¸€ä»½æ–‡ä»¶ã€Šå¤ä¹¦é¡µå››ã€‹</p><ol><li>ä»é“è½¨è°ƒåˆ°æ‘©å¤©è½®ä¸Šï¼Œç„¶åç­‰æ‘©å¤©è½®ç¼“ç¼“ä¸Šå‡åï¼Œè°ƒåˆ°é»„è‰²é“è½¨ä¸Š</li></ol><img src="/2024/03/17/%E6%B8%AF%E8%AF%A1%E5%AE%9E%E5%BD%95%E6%88%90%E5%B0%B1-%E7%BA%BF%E7%B4%A2/20240317104541_1.jpg" alt="20240317104541_1" style="zoom: 50%;"><ol start="2"><li>ä»é»„è‰²é“è½¨èµ°åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å»çš„æ¥¼å±‚ï¼Œèµ°å‡ æ­¥å°±ä¼šæ‰“é›·ï¼Œæ¡Œå­ä¸Šæ”¾äº†ä¸€ä»½æ–‡ä»¶ï¼Œæ‰“å¼€åå…³é—­å°±å¯ä»¥è§£é”æˆå°±ã€Šçº¿ç´¢ã€‹</li></ol><img src="/2024/03/17/%E6%B8%AF%E8%AF%A1%E5%AE%9E%E5%BD%95%E6%88%90%E5%B0%B1-%E7%BA%BF%E7%B4%A2/20240317104602_1.jpg" alt="20240317104602_1" style="zoom: 50%;"><img src="/2024/03/17/%E6%B8%AF%E8%AF%A1%E5%AE%9E%E5%BD%95%E6%88%90%E5%B0%B1-%E7%BA%BF%E7%B4%A2/20240317105128_1.jpg" alt="20240317105128_1" style="zoom: 50%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å†…å­˜å›æ”¶å‘½ä»¤drop_cacheså¤§å…¨</title>
    <link href="/2024/03/10/%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%91%BD%E4%BB%A4drop-caches%E5%A4%A7%E5%85%A8/"/>
    <url>/2024/03/10/%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%91%BD%E4%BB%A4drop-caches%E5%A4%A7%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="å†…å­˜å›æ”¶å‘½ä»¤drop-cacheså¤§å…¨"><a href="#å†…å­˜å›æ”¶å‘½ä»¤drop-cacheså¤§å…¨" class="headerlink" title="å†…å­˜å›æ”¶å‘½ä»¤drop_cacheså¤§å…¨"></a>å†…å­˜å›æ”¶å‘½ä»¤drop_cacheså¤§å…¨</h1><h2 id="1-drop-cacheså‘½ä»¤"><a href="#1-drop-cacheså‘½ä»¤" class="headerlink" title="1.drop cacheså‘½ä»¤"></a>1.drop cacheså‘½ä»¤</h2><h2 id="2-f2fs-drop-inodeè°ƒç”¨æ ˆ"><a href="#2-f2fs-drop-inodeè°ƒç”¨æ ˆ" class="headerlink" title="2.f2fs_drop_inodeè°ƒç”¨æ ˆ"></a>2.f2fs_drop_inodeè°ƒç”¨æ ˆ</h2><img src="/2024/03/10/%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E5%91%BD%E4%BB%A4drop-caches%E5%A4%A7%E5%85%A8/image-20240310221621378.png" alt="image-20240310221621378" style="zoom: 67%;"><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs txt">=&gt; drop_caches_sysctl_handler<br>=&gt; drop_slab<br>=&gt; shrink_slab<br>=&gt; prune_dcache_sb<br>=&gt; prune_dentry_list<br>=&gt; _dentry_kill<br>=&gt; dentry_unlink_inode<br>=&gt; iput<br>=&gt; f2fs_drop_inode<br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs txt">=&gt; drop_caches_sysctl_handler<br>=&gt; drop_slab<br>=&gt; shrink_slab<br>=&gt; prube_icache_sb<br>=&gt; list_lru_walk_sb<br>=&gt; _list_lru_walk_sb<br>=&gt; inode_lru_isolate<br>=&gt; iput<br>=&gt; f2fs_drop_inode<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// éå† s_dentry_lru é“¾è¡¨  </span><br>list_for_each(lru, &amp;sb-&gt;s_dentry_lru) &#123;  <br>    dentry = list_entry(lru, <span class="hljs-keyword">struct</span> dentry, d_lru);  <br>    printk(KERN_INFO <span class="hljs-string">&quot;dentry: inode=%p, name=%s\n&quot;</span>,  <br>           dentry-&gt;d_inode, dentry-&gt;d_name.name);  <br>&#125;<br></code></pre></td></tr></table></figure><p>Linuxä¸­çš„VFSå®ç° [äºŒ]ï¼š<a href="https://zhuanlan.zhihu.com/p/107247475">https://zhuanlan.zhihu.com/p/107247475</a></p><p>inodeç”Ÿå‘½å‘¨æœŸï¼š<a href="https://blog.csdn.net/u010039418/article/details/115234532?spm=1001.2014.3001.5506">https://blog.csdn.net/u010039418/article/details/115234532?spm=1001.2014.3001.5506</a></p><p>drop_cachesåŸç†ï¼š<a href="https://zhuanlan.zhihu.com/p/93962657">https://zhuanlan.zhihu.com/p/93962657</a></p><p>vfs dentry cache æ¨¡å—å®ç°åˆ†æï¼š<a href="https://zhuanlan.zhihu.com/p/457005511?utm_id=0">https://zhuanlan.zhihu.com/p/457005511?utm_id=0</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ioç ”ç©¶å¤‡å¿˜å½•</title>
    <link href="/2024/03/04/io%E7%A0%94%E7%A9%B6%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    <url>/2024/03/04/io%E7%A0%94%E7%A9%B6%E5%A4%87%E5%BF%98%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="http://www.lenzhao.com/topic/5acf20c5bedc2a8b075a6072">ç”µæ¢¯ç®—æ³•åŠIOè°ƒåº¦çš„æºç åˆ†æ</a>ï¼šä¸»è¦è®²ç”µæ¢¯é˜Ÿåˆ—å’Œrequesté˜Ÿåˆ—å‡½æ•°blk_queue_bio</li><li><a href="https://www.cnblogs.com/Linux-tech/p/12961286.html">linux IO Block layer è§£æ</a>ï¼šä¸»è¦é‡Œé¢çš„å›¾ç”»çš„ä¸é”™ï¼Œä¸”bioç»“æ„è®²çš„æ¯”è¾ƒæ¸…æ™°</li><li><a href="https://www.cnblogs.com/felton/p/10624947.html">Linux Blockå­ç³»ç»Ÿâ€”â€”IOè°ƒåº¦å±‚</a>ï¼šä¸»è¦é‡Œé¢è¿™å¼ å›¾ä¸é”™</li></ul><img src="/2024/03/04/io%E7%A0%94%E7%A9%B6%E5%A4%87%E5%BF%98%E5%BD%95/1624300-20190331223524431-790777662.jpg" alt="img"><img src="/2024/03/04/io%E7%A0%94%E7%A9%B6%E5%A4%87%E5%BF%98%E5%BD%95/1624300-20190330232530720-1691499771.png" alt="img" style="zoom:80%;"><ul><li><a href="https://github.com/0voice/linux_kernel_wiki/blob/main/%E6%96%87%E7%AB%A0/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/Linux%20IO%20%E4%B9%8B%20%E5%9D%97IO%E6%B5%81%E7%A8%8B%E4%B8%8EIO%E8%B0%83%E5%BA%A6%E5%99%A8.md">å—I&#x2F;Oæµç¨‹ä¸ I&#x2F;Oè°ƒåº¦å™¨</a>ï¼šå·¥å…·blktraceã€å·¥å…·blkparseã€å·¥å…·ftrace</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå‘½ä»¤è§£æå¤§å…¨</title>
    <link href="/2024/03/03/Linux%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90%E5%A4%A7%E5%85%A8/"/>
    <url>/2024/03/03/Linux%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90%E5%A4%A7%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå‘½ä»¤è§£æå¤§å…¨"><a href="#Linuxå‘½ä»¤è§£æå¤§å…¨" class="headerlink" title="Linuxå‘½ä»¤è§£æå¤§å…¨"></a>Linuxå‘½ä»¤è§£æå¤§å…¨</h1><ul><li><p>dfå‘½ä»¤ï¼š<a href="https://anmuxixixi.github.io/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"> Linuxå‘½ä»¤dfåŸç†è§£æ</a></p></li><li><p>blkidå‘½ä»¤ï¼š<a href="https://anmuxixixi.github.io/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">blkidäºŒè¿›åˆ¶æºç è§£æ</a></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå‘½ä»¤dfåŸç†è§£æ</title>
    <link href="/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå‘½ä»¤dfåŸç†è§£æ"><a href="#Linuxå‘½ä»¤dfåŸç†è§£æ" class="headerlink" title="Linuxå‘½ä»¤dfåŸç†è§£æ"></a>Linuxå‘½ä»¤dfåŸç†è§£æ</h1><h2 id="1-dfå‘½ä»¤åŸç†"><a href="#1-dfå‘½ä»¤åŸç†" class="headerlink" title="1.dfå‘½ä»¤åŸç†"></a>1.dfå‘½ä»¤åŸç†</h2><p>ä½¿ç”¨<code>statfs</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥è¯»å–åˆ†åŒºçš„è¶…çº§å—ä¿¡æ¯è·å–åˆ†åŒºä½¿ç”¨æƒ…å†µã€‚å®ƒçš„æ•°æ®æ˜¯åŸºäºåˆ†åŒºå…ƒæ•°æ®çš„ï¼Œ</p><p>æ‰€ä»¥åªèƒ½é’ˆå¯¹æ•´ä¸ªåˆ†åŒºã€‚ç”±äºdfç›´æ¥è¯»å–è¶…çº§å—ï¼Œæ‰€ä»¥è¿è¡Œé€Ÿåº¦ä¸å—æ–‡ä»¶å¤šå°‘å½±å“ã€‚</p><blockquote><p>ä¸‹é¢æˆ‘ä»¬è¿›è¡Œå®éªŒï¼Œé€šè¿‡**dfå‘½ä»¤æ‰“å° **å’Œ <strong>statfs</strong> å‡½æ•°è°ƒç”¨ï¼Œæ¯”è¾ƒä¸¤è€…æ˜¯ä¸æ˜¯ç›¸åŒçš„</p></blockquote><h3 id="1-1-å®éªŒç¯å¢ƒå‡†å¤‡"><a href="#1-1-å®éªŒç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.1 å®éªŒç¯å¢ƒå‡†å¤‡"></a>1.1 å®éªŒç¯å¢ƒå‡†å¤‡</h3><blockquote><p>ç›´æ¥æ‹¿ä¹‹å‰çš„å®éªŒå“å§ï¼š<a href="https://anmuxixixi.github.io/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/">f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾</a></p></blockquote><img src="/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20240303111412902.png" alt="image-20240303111412902" style="zoom:80%;"><h3 id="1-2-dfå‘½ä»¤ç»“æœ"><a href="#1-2-dfå‘½ä»¤ç»“æœ" class="headerlink" title="1.2 dfå‘½ä»¤ç»“æœ"></a>1.2 dfå‘½ä»¤ç»“æœ</h3><img src="/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20240303111312649.png" alt="image-20240303111312649" style="zoom: 80%;"><p>129024æ˜¯æ‰€æœ‰1Kå¤§å°çš„blockæ•°ç›®ï¼Œæ‰€ä»¥å¾—åˆ°çš„æ€»å¤§å°ä¸ºï¼š<strong>129024 &#x2F;1024 &#x3D; 126M</strong></p><p><strong>Qï¼šä¸ºä»€ä¹ˆæ¯”æˆ‘ä»¬æ ¼å¼åŒ–çš„128Må°äº†2M</strong></p><p><strong>Aï¼š</strong>å¯ä»¥çœ‹ç¬¬2ç« çš„è§£æï¼Œå› ä¸ºf2fsæ–‡ä»¶ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªsegmentæ˜¯ç»™superblockç”¨çš„ï¼Œæ€»å¤§å°æ˜¯ä»segment0å¼€å§‹ç®—çš„ã€‚è€Œä¸€ä¸ªsegmentçš„å¤§å°ä¸º2M</p><h3 id="1-3-statfså‡½æ•°è°ƒç”¨ç»“æœ"><a href="#1-3-statfså‡½æ•°è°ƒç”¨ç»“æœ" class="headerlink" title="1.3 statfså‡½æ•°è°ƒç”¨ç»“æœ"></a>1.3 statfså‡½æ•°è°ƒç”¨ç»“æœ</h3><p>é¦–å…ˆç¼–å†™ä¸‹é¢çš„ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/statfs.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span>* path = <span class="hljs-string">&quot;/home/amx/Desktop/f2fs/root_dir&quot;</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">statfs</span> <span class="hljs-title">stStatfs</span>;</span><br>    <span class="hljs-type">int</span> percentage;<br>    statfs(path, &amp;stStatfs);<br>    percentage = (stStatfs.f_blocks - stStatfs.f_bfree) * <span class="hljs-number">100</span> / <br>                    (stStatfs.f_blocks - stStatfs.f_bfree + stStatfs.f_bavail) + <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Filesystem   1K-blocks   Used   Available   Use%%   Mounted on\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%ld %ld %ld %ld %d%% %s\n&quot;</span>, stStatfs.f_type, <br>        <span class="hljs-number">4</span>*stStatfs.f_blocks, <span class="hljs-number">4</span>*(stStatfs.f_blocks - stStatfs.f_bfree), <br>        <span class="hljs-number">4</span>*stStatfs.f_bavail, percentage, path);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œåçš„ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20240303111139313.png" alt="image-20240303111139313" style="zoom:80%;"><hr><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">statfs</span>&#123;</span><br><span class="hljs-type">long</span> f_type;     <span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹</span><br><span class="hljs-type">long</span> f_bsize;   <span class="hljs-comment">//ç»ä¼˜åŒ–åçš„ä¼ è¾“å—çš„å¤§å°</span><br><span class="hljs-type">long</span> f_blocks;  <span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—æ€»æ•°</span><br><span class="hljs-type">long</span> f_bfree;    <span class="hljs-comment">//å¯ç”¨å—æ•°</span><br><span class="hljs-type">long</span> f_bavail;   <span class="hljs-comment">//æ™®é€šç”¨æˆ·èƒ½å¤Ÿè·å¾—çš„å—æ•°</span><br><span class="hljs-type">long</span> f_files;      <span class="hljs-comment">//æ–‡ä»¶ç»“ç‚¹æ€»æ•°</span><br><span class="hljs-type">long</span> f_ffree;     <span class="hljs-comment">//å¯ç”¨æ–‡ä»¶ç»“ç‚¹æ•°</span><br><span class="hljs-type">fisd_t</span> f_fsid;     <span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿæ ‡è¯†</span><br><span class="hljs-type">long</span> f_namelen;  <span class="hljs-comment">//æ–‡ä»¶åçš„æœ€å¤§é•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-ä¸åŒæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„statfsç³»ç»Ÿè°ƒç”¨"><a href="#2-ä¸åŒæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„statfsç³»ç»Ÿè°ƒç”¨" class="headerlink" title="2.ä¸åŒæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„statfsç³»ç»Ÿè°ƒç”¨"></a>2.ä¸åŒæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„statfsç³»ç»Ÿè°ƒç”¨</h2><img src="/2024/03/03/Linux%E5%91%BD%E4%BB%A4df%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20240303111916590.png" alt="image-20240303111916590" style="zoom: 80%;"><p>æœ¬æ–‡ä»¥æˆ‘æœ€ç†Ÿæ‚‰çš„f2fsæ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼Œè¯´æ˜è¿™äº›æ•°å€¼æ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_statfs</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dentry *dentry, <span class="hljs-keyword">struct</span> kstatfs *buf)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> dentry-&gt;d_sb;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sb_info</span> *<span class="hljs-title">sbi</span> =</span> F2FS_SB(sb);<br>u64 id = huge_encode_dev(sb-&gt;s_bdev-&gt;bd_dev);<br><span class="hljs-type">block_t</span> total_count, user_block_count, start_count;<br>u64 avail_node_count;<br><br>total_count = le64_to_cpu(sbi-&gt;raw_super-&gt;block_count);  <span class="hljs-comment">// æ•´ä¸ªf2fs.imgåŒ…å«çš„blockæ•°</span><br>user_block_count = sbi-&gt;user_block_count;<br>start_count = le32_to_cpu(sbi-&gt;raw_super-&gt;segment0_blkaddr);  <span class="hljs-comment">// superblockä½äºç¬¬ä¸€ä¸ªsegmentï¼Œå 2M</span><br>buf-&gt;f_type = F2FS_SUPER_MAGIC;<br>buf-&gt;f_bsize = sbi-&gt;blocksize;<br><br>buf-&gt;f_blocks = total_count - start_count;<br>buf-&gt;f_bfree = user_block_count - valid_user_blocks(sbi) -<br>sbi-&gt;current_reserved_blocks;<br><br>    buf-&gt;f_bfree -= sbi-&gt;unusable_block_count;<br><br><br><span class="hljs-keyword">if</span> (buf-&gt;f_bfree &gt; F2FS_OPTION(sbi).root_reserved_blocks)<br>buf-&gt;f_bavail = buf-&gt;f_bfree -<br>F2FS_OPTION(sbi).root_reserved_blocks;<br><span class="hljs-keyword">else</span><br>buf-&gt;f_bavail = <span class="hljs-number">0</span>;<br><br>avail_node_count = sbi-&gt;total_node_count - F2FS_RESERVED_NODE_NUM;<br><br><span class="hljs-keyword">if</span> (avail_node_count &gt; user_block_count) &#123;<br>buf-&gt;f_files = user_block_count;<br>buf-&gt;f_ffree = buf-&gt;f_bavail;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>buf-&gt;f_files = avail_node_count;<br>buf-&gt;f_ffree = min(avail_node_count - valid_node_count(sbi),<br>buf-&gt;f_bavail);<br>&#125;<br><br>buf-&gt;f_namelen = F2FS_NAME_LEN;<br>buf-&gt;f_fsid    = u64_to_fsid(id);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>SSDå›ºæ€ç¡¬ç›˜Trimå‘½ä»¤</title>
    <link href="/2024/02/19/SSD%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98Trim%E5%91%BD%E4%BB%A4/"/>
    <url>/2024/02/19/SSD%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98Trim%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="SSDå›ºæ€ç¡¬ç›˜Trimå‘½ä»¤"><a href="#SSDå›ºæ€ç¡¬ç›˜Trimå‘½ä»¤" class="headerlink" title="SSDå›ºæ€ç¡¬ç›˜Trimå‘½ä»¤"></a>SSDå›ºæ€ç¡¬ç›˜Trimå‘½ä»¤</h1><h2 id="ä¸ºå•¥æˆ‘ä»¬éœ€è¦Trimï¼Ÿ"><a href="#ä¸ºå•¥æˆ‘ä»¬éœ€è¦Trimï¼Ÿ" class="headerlink" title="ä¸ºå•¥æˆ‘ä»¬éœ€è¦Trimï¼Ÿ"></a>ä¸ºå•¥æˆ‘ä»¬éœ€è¦Trimï¼Ÿ</h2><p> åœ¨é—ªå­˜å†…ï¼Œæ•°æ®å­˜å‚¨ä¸€èˆ¬æ˜¯ä»¥pageï¼ˆé¡µï¼‰ä¸ºæœ€å°å•ä½å­˜å‚¨çš„ï¼ˆå…¸å‹çš„ä¸º4KBï¼‰ï¼Œè€Œ128ä¸ªpageç»„æˆäº†ä¸€ä¸ªblockï¼ˆå—ï¼‰ï¼Œæ•°æ®å¯ä»¥ä»¥4KBå¤§å°çš„é¡µæ¥è¯»å–å’Œå†™å…¥ï¼Œä½†å´åªèƒ½ä»¥512KB(128 page)çš„å—å¤§å°æ¥åˆ é™¤ã€‚å½“è¯»å–æ•°æ®æˆ–è€…å†™å…¥åˆ°ä¸€ä¸ªæ²¡æœ‰è¢«ä½¿ç”¨è¿‡çš„pageä¸Šæ—¶ï¼Œå›ºæ€ç¡¬ç›˜çš„é€Ÿåº¦æ˜¯å¾ˆå¿«çš„ï¼Œä½†æ˜¯è¦†å†™æ•°æ®çš„è¯ï¼Œå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œéœ€è¦è®¸å¤šæ­¥éª¤æ¥å®Œæˆã€‚æ­¥éª¤å¯è§ä¸‹å›¾ï¼š</p><img src="/2024/02/19/SSD%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98Trim%E5%91%BD%E4%BB%A4/1_120607163326_1.jpg" alt="img" style="zoom:90%;"><p>å½“SSDçš„æ‰€æœ‰ç©ºé—²å—éƒ½è¢«ä½¿ç”¨åï¼Œå†æœ‰å†™å…¥æ“ä½œï¼Œå®ƒåªèƒ½è¦†å†™æ•°æ®åˆ°ä¹‹å‰è¢«æ“ä½œç³»ç»Ÿæ ‡è®°ä¸ºåˆ é™¤çš„åŒºåŸŸã€‚è¿™ä¹Ÿæ˜¯é€Ÿåº¦ä¸‹é™çš„å¼€å§‹ï¼š</p><p>è¦è¦†å†™ä¸€ä¸ª4KB é¡µçš„æ–‡ä»¶ç³»ç»Ÿï¼Œé¦–å…ˆè¦æŠŠæ•´ä¸ª512KB å—å¤åˆ¶è¿›ç¼“å­˜é‡Œã€‚ç„¶åï¼Œåœ¨ç¼“å­˜é‡Œåˆ é™¤è¿™ä¸ª4KBé¡µï¼Œæ›¿æ¢æˆæ–°çš„æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œæ¸…ç©ºæ•´ä¸ªé—ªå­˜å†…çš„è¿™ä¸ª512KBåŒºåŸŸï¼Œå¹¶ä»ç¼“å­˜é‡ŒæŠŠæ–°çš„æ•°æ®å†™å›å»ã€‚å¦‚æœä½ éœ€è¦åŒæ—¶è¦†å†™å¾ˆå¤šçš„å— - â€ä¾‹å¦‚æ˜¯ä¸€ç³»åˆ—å°æ–‡ä»¶éšæœºå†™å…¥æ“ä½œæˆ–è€…åªæ˜¯ç®€å•çš„å†™å…¥ä¸€ä¸ªå¤§æ–‡ä»¶åˆ°SSDâ€œã€‚ä½ ä¼šè®©ä½ çš„SSDç¼“å­˜å¿«é€Ÿè¿‡è½½ï¼Œç„¶åä½ çš„å†™å…¥é€Ÿåº¦å°±ä¼šâ€å‚ç›´è½ä½“â€œã€‚ã€‚ã€‚å‘Šè¯‰ä½ ï¼Œä½ èƒ½ä½“ä¼šåˆ°ä¼šæœ‰å¤šæ…¢ï¼Œæ—©æœŸç¼“å­˜å°‘çš„SSDç”šè‡³ä¼šå»¶è¿Ÿæ¥è¿‘1ç§’ï¼ˆJMF602ä¹‹æµï¼‰ï¼Œä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼ŒSSDå‚å•†ä¸€ä¸ªä¸ªéƒ½åœ¨æ–°ä¸»æ§åˆ¶å™¨ä¸ŠåŠ å…¥äº†è¶Šæ¥è¶Šå¤§çš„å¤–ç½®ç¼“å­˜ï¼Œè¿™è™½ç„¶ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†éšæœºå†™å…¥å¡çš„é—®é¢˜ï¼Œä½†æ˜¯å´ä¸èƒ½è§£å†³SSDåœ¨è¦†å†™æ—¶é€Ÿåº¦ä¸‹é™çš„é—®é¢˜ã€‚</p><h2 id="Trimå‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#Trimå‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Trimå‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ"></a>Trimå‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</h2><p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿä¸èƒ½å’ŒSSDçš„ä¸»æ§è¿›è¡Œåˆ é™¤æ–‡ä»¶çš„äº¤æµé€ æˆçš„ï¼Œå¦‚æœæœ‰ä¹‹å‰æ²¡æ¸…é™¤å¹²å‡€çš„æ•°æ®ï¼Œæ‰€æœ‰å†™å…¥çš„é¡µçš„æ“ä½œéƒ½è¦å…ˆæ¸…é™¤å—å†æ”¹å†™ï¼Œå°†ä¸¥é‡å½±å“å†™å…¥é€Ÿåº¦ã€‚æœ‰2ç§é€”å¾„æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼š</p><p>ç¬¬ä¸€ä¸ªå°±æ˜¯å®šæœŸè¿è¡Œåƒåœ¾å›æ”¶ç¨‹åº(GC)ï¼ˆè¿™ä¸ªæ“ä½œæœ‰ç‚¹åƒæ•´ç†ï¼Œåœ¨SSDç©ºé—²æ—¶ï¼Œå…¨ç›˜æ‰«ææœ‰æ•ˆçš„é¡µå¹¶åˆå¹¶æ•´ç†èµ·æ¥å˜ä¸ºä¸€ä¸ªåŒ…å«å…¨éƒ¨æœ‰æ•ˆé¡µçš„å—ï¼Œè€Œé‚£äº›æ— æ•ˆçš„é¡µå’Œå—éƒ½å°†è¢«å®Œå…¨çš„æ¸…é™¤ï¼‰ã€‚</p><p>ç¬¬äºŒä¸ªæ›´å¥½çš„é€”å¾„å°±æ˜¯å½“æ•°æ®åˆ é™¤æ—¶å€™è®©ç³»ç»Ÿå‘Šè¯‰SSDæ•°æ®æ²¡äº†ï¼Œè®©SSDç«‹å³æ“¦æ‰é‚£äº›æ•°æ®å ç”¨çš„å—ï¼Œè¿™å°±æ˜¯Trimå‘½ä»¤åšçš„äº‹ã€‚<br>å½“ä¸€ä¸ªæ–‡ä»¶åœ¨æ”¯æŒTrimçš„ç³»ç»Ÿé‡Œè¢«åˆ é™¤åï¼Œæ“ä½œç³»ç»Ÿä¼šå‘ä¸ªå‘½ä»¤ç»™SSDï¼Œè®©ä»–çŸ¥é“è¿™ä¸ªæ•°æ®æ‰€åœ¨çš„è¿™ä¸ªpageå¯ä»¥ç›´æ¥è¢«å†™å…¥ï¼Œç­‰äºæŠŠæ§åˆ¶æƒä»æ“ä½œç³»ç»Ÿå˜ä¸ºäº†SSDä¸»æ§åˆ¶å™¨å›ºä»¶ã€‚SSDä¸€æ ·ä¼šå¤åˆ¶æ•´ä¸ªåŒ…å«åˆ é™¤æ•°æ®çš„å—åˆ°ç¼“å­˜ï¼Œæ¸…ç©ºå—å¹¶å†™å…¥æœ‰æ•ˆæ•°æ®çš„é¡µå›å»ï¼Œ<strong>åŒºåˆ«æ˜¯è¿™æ ·ç­‰äºæŠŠè¿™ä¸ªå»¶è¿Ÿæ—¶é—´ä»è¦†å†™æ•°æ®çš„é‚£ä¸ªæ—¶é—´æå‰åˆ°äº†åˆ é™¤æ•°æ®çš„æ—¶å€™</strong>ï¼ˆè¿™ä¸ªæ—¶å€™ä½ å¯¹é€Ÿåº¦ä¸æ•æ„Ÿï¼Œå¦‚æœä½ åˆ é™¤äº†å¾ˆå¤§å¾ˆå¤§çš„æ•°æ®ï¼Œå¯ä»¥å»è§‚å¯Ÿç¡¬ç›˜ç¯åœ¨ä½ åˆ é™¤ä¹‹åå‡ ç§’å†…ç‹‚é—ªï¼‰ï¼Œè‡ªç„¶å°±ä¼šæ˜¾å¾—SSDçš„é€Ÿåº¦å›æ¥äº†ï¼Œå› ä¸ºä½ å†™å…¥çš„æ—¶å€™æœ‰å¯ç”¨çš„ç©ºå—ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ï¼ŒTrimä¿è¯é€Ÿåº¦ä¸ä¸‹è·Œçš„çœŸæ­£ç§˜å¯†æ˜¯ï¼š æŠŠå°†æ¥è¦åšçš„äº‹æå‰åšæ‰äº†ã€‚ ä½†æ˜¯è¿™ä»¶äº‹è¿Ÿæ—©è¦åšï¼Œæ‰€ä»¥åŸºæœ¬ä¸ä¼šå½±å“SSDåŸæœ‰çš„å†™å…¥æ¬¡æ•°ï¼ˆå¯¿å‘½ï¼‰ã€‚<br>æœ‰å¾ˆå¤šäººè¯´ï¼ŒTrimæ˜¯ä¸ºæµ‹è¯•è€Œç”Ÿçš„ï¼Œè¿™è¯å…¶å®æ²¡é”™ï¼Œå› ä¸º 1.Trimä¸èƒ½æé€Ÿï¼Œåªæ˜¯ä¿è¯é€Ÿåº¦å°½å¯èƒ½ä¸ä¸‹é™ã€‚ï¼ˆå®é™…æ˜¯SSDä¸Šæ²¡è¢«ä½¿ç”¨çš„å®¹é‡é‚£é‡Œçš„é€Ÿåº¦ä¸ä¸‹é™ã€‚Trimæå‰æŠŠé‚£é‡Œçš„å—æ¸…ç©ºäº†ã€‚ä¸‹æ¬¡ç›´æ¥å¯ä»¥å†™å½“ç„¶å¿«äº†ã€‚ï¼‰2.Trimæ²¡æ”¹å˜åŸæœ¬è¦åšçš„äº‹ï¼Œåªæ˜¯æå‰åšæ‰äº†ï¼Œæµ‹è¯•è½¯ä»¶æµ‹è¯•æ—¶å€™å°±ä¸éœ€è¦åšäº†ï¼Œä»è€Œâ€œæ˜¾å¾—â€é€Ÿåº¦ä¸Šå»äº†ã€‚<br>å¯¹äºGCæ¥è¯´ï¼Œç”±äºæ˜¯ç§»åŠ¨ï¼Œæ•´ç†ï¼Œåˆå¹¶äº†æ—§é¡µåˆ°æ–°å—ï¼Œåˆ é™¤äº†æ— æ•ˆçš„æ—§å—ï¼Œä¼šç‰ºç‰²ç‚¹å†™å…¥æ¬¡æ•°ï¼ˆå¯¿å‘½ï¼‰ã€‚ä½†æ˜¯GCæ”¯æŒRAIDï¼Œä¹Ÿç®—æœ‰åˆ©æœ‰å¼Šå§ã€‚</p><blockquote><p><a href="https://bbs.pceva.com.cn/thread-20195-1-1.html">https://bbs.pceva.com.cn/thread-20195-1-1.html</a></p></blockquote><img src="/2024/02/19/SSD%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98Trim%E5%91%BD%E4%BB%A4/image-20240219221341603.png" alt="image-20240219221341603" style="zoom:80%;"><h2 id="TRIMå·¥å…·ï¼šIOBitå…¬å¸çš„Smart-Defrag"><a href="#TRIMå·¥å…·ï¼šIOBitå…¬å¸çš„Smart-Defrag" class="headerlink" title="TRIMå·¥å…·ï¼šIOBitå…¬å¸çš„Smart Defrag"></a>TRIMå·¥å…·ï¼šIOBitå…¬å¸çš„Smart Defrag</h2><p><a href="https://www.bilibili.com/video/BV1Jv4y1T7zH">https://www.bilibili.com/video/BV1Jv4y1T7zH</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿdentryä¸inodeå­¦ä¹ ç¬”è®°</title>
    <link href="/2024/02/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdentry%E4%B8%8Einode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2024/02/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdentry%E4%B8%8Einode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿdentryä¸inodeå­¦ä¹ ç¬”è®°"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿdentryä¸inodeå­¦ä¹ ç¬”è®°" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿdentryä¸inodeå­¦ä¹ ç¬”è®°"></a>f2fsæ–‡ä»¶ç³»ç»Ÿdentryä¸inodeå­¦ä¹ ç¬”è®°</h1><h2 id="inodeç›¸å…³"><a href="#inodeç›¸å…³" class="headerlink" title="inodeç›¸å…³"></a>inodeç›¸å…³</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">block_operations</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">writeback_control</span> <span class="hljs-title">wbc</span> =</span> &#123;<br>.sync_mode = WB_SYNC_ALL,<br>.nr_to_write = LONG_MAX,<br>.for_reclaim = <span class="hljs-number">0</span>,<br>&#125;;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>, cnt = <span class="hljs-number">0</span>;<br><br>f2fs_flush_inline_data(sbi);<br><br>retry_flush_dents:<br><span class="hljs-keyword">if</span> (get_pages(sbi, F2FS_DIRTY_DENTS)) &#123;<br>f2fs_unlock_all(sbi);<br>err = f2fs_sync_dirty_inodes(sbi, DIR_INODE);<br><span class="hljs-keyword">goto</span> retry_flush_quotas;<br>&#125;<br><br>down_write(&amp;sbi-&gt;node_change);<br><br><span class="hljs-keyword">if</span> (get_pages(sbi, F2FS_DIRTY_IMETA)) &#123;<br>up_write(&amp;sbi-&gt;node_change);<br>f2fs_unlock_all(sbi);<br>err = f2fs_sync_inode_meta(sbi);<br><span class="hljs-keyword">goto</span> retry_flush_quotas;<br>&#125;<br><br>retry_flush_nodes:<br>down_write(&amp;sbi-&gt;node_write);<br><br><span class="hljs-keyword">if</span> (get_pages(sbi, F2FS_DIRTY_NODES)) &#123;<br>up_write(&amp;sbi-&gt;node_write);<br><span class="hljs-type">atomic_inc</span>(&amp;sbi-&gt;wb_sync_req[NODE]);<br>err = f2fs_sync_node_pages(sbi, &amp;wbc, <span class="hljs-literal">false</span>, FS_CP_NODE_IO);<br><span class="hljs-type">atomic_dec</span>(&amp;sbi-&gt;wb_sync_req[NODE]);<br><span class="hljs-keyword">goto</span> retry_flush_nodes;<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="f2fs-sync-dirty-inodesï¼šåˆ·å†™inodeæ–‡ä»¶å¯¹åº”çš„ã€Šè„æ•°æ®é¡µã€‹"><a href="#f2fs-sync-dirty-inodesï¼šåˆ·å†™inodeæ–‡ä»¶å¯¹åº”çš„ã€Šè„æ•°æ®é¡µã€‹" class="headerlink" title="f2fs_sync_dirty_inodesï¼šåˆ·å†™inodeæ–‡ä»¶å¯¹åº”çš„ã€Šè„æ•°æ®é¡µã€‹"></a>f2fs_sync_dirty_inodesï¼šåˆ·å†™inodeæ–‡ä»¶å¯¹åº”çš„ã€Šè„æ•°æ®é¡µã€‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sync_dirty_inodes</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">enum</span> inode_type type)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br>fi = list_first_entry(head, <span class="hljs-keyword">struct</span> f2fs_inode_info, dirty_list);<br>inode = igrab(&amp;fi-&gt;vfs_inode);<br>spin_unlock(&amp;sbi-&gt;inode_lock[type]);<br><span class="hljs-keyword">if</span> (inode) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cur_ino = inode-&gt;i_ino;<br>F2FS_I(inode)-&gt;cp_task = current;<br><span class="hljs-comment">// filemap_fdatawriteä½œç”¨ç±»ä¼¼äºfdatasync:</span><br>        <span class="hljs-comment">// filemap_fdatawriteçš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰è„é¡µå†™å›åˆ°å­˜å‚¨è®¾å¤‡ã€‚</span><br>        <span class="hljs-comment">// *****filemap_fdatawriteå‡½æ•°æœ¬èº«ä¸æ˜¯é˜»å¡å¼çš„ã€‚å®ƒä¸ä¼šä½¿è°ƒç”¨è€…ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ç³»ç»Ÿå±‚æˆ–é¡µç¼“å­˜å±‚ï¼‰ç­‰å¾…å†™æ“ä½œå®Œæˆ*****</span><br>        <span class="hljs-comment">// *****è°ƒç”¨æ—¶ï¼Œå®ƒåªæ˜¯ç¡®ä¿æ‰€æœ‰è„é¡µéƒ½è¢«æ ‡è®°ä¸ºéœ€è¦å†™å›*****</span><br>filemap_fdatawrite(inode-&gt;i_mapping);<br>F2FS_I(inode)-&gt;cp_task = <span class="hljs-literal">NULL</span>;<br>iput(inode);<br><span class="hljs-keyword">if</span> (ino == cur_ino)<br>cond_resched();<br><span class="hljs-keyword">else</span><br>ino = cur_ino;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>f2fs_submit_merged_write(sbi, DATA);<br>cond_resched();<br>&#125;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="f2fs-sync-inode-metaï¼šåˆ·å†™inodeå¯¹åº”çš„ã€Šè„å…ƒæ•°æ®é¡µã€‹"><a href="#f2fs-sync-inode-metaï¼šåˆ·å†™inodeå¯¹åº”çš„ã€Šè„å…ƒæ•°æ®é¡µã€‹" class="headerlink" title="f2fs_sync_inode_metaï¼šåˆ·å†™inodeå¯¹åº”çš„ã€Šè„å…ƒæ•°æ®é¡µã€‹"></a>f2fs_sync_inode_metaï¼šåˆ·å†™inodeå¯¹åº”çš„ã€Šè„å…ƒæ•°æ®é¡µã€‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sync_inode_meta</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">head</span> =</span> &amp;sbi-&gt;inode_list[DIRTY_META];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_inode_info</span> *<span class="hljs-title">fi</span>;</span><br>s64 total = get_pages(sbi, F2FS_DIRTY_IMETA);<br><br><span class="hljs-keyword">while</span> (total--) &#123;<br>fi = list_first_entry(head, <span class="hljs-keyword">struct</span> f2fs_inode_info,<br>gdirty_list);<br>inode = igrab(&amp;fi-&gt;vfs_inode);<br>spin_unlock(&amp;sbi-&gt;inode_lock[DIRTY_META]);<br><span class="hljs-keyword">if</span> (inode) &#123;<br>sync_inode_metadata(inode, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (is_inode_flag_set(inode, FI_DIRTY_INODE))<br>f2fs_update_inode_page(inode);<br>iput(inode);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè°ƒç”¨sync_inode_metadataå»åˆ·å†™inodeå¯¹åº”çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯inodeä¿¡æ¯ï¼Œå…¶æœ€ç»ˆçš„è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">sync_inode_metadata<br>-&gt; sync_inode_metadata<br>-&gt; sync_inode<br>-&gt; writeback_single_inode<br>-&gt; __writeback_single_inode<br></code></pre></td></tr></table></figure><h3 id="f2fs-sync-node-pagesï¼šå›å†™ã€Šæ‰€æœ‰è„node-pageé¡µã€‹"><a href="#f2fs-sync-node-pagesï¼šå›å†™ã€Šæ‰€æœ‰è„node-pageé¡µã€‹" class="headerlink" title="f2fs_sync_node_pagesï¼šå›å†™ã€Šæ‰€æœ‰è„node pageé¡µã€‹"></a>f2fs_sync_node_pagesï¼šå›å†™ã€Šæ‰€æœ‰è„node pageé¡µã€‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sync_node_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> writeback_control *wbc,</span><br><span class="hljs-params"><span class="hljs-type">bool</span> do_balance, <span class="hljs-keyword">enum</span> iostat_type io_type)</span><br>&#123;<br>    <span class="hljs-comment">// f2fsæ–‡ä»¶ç³»ç»Ÿçš„1å·å…ƒæ•°æ®node inodeç”¨æ¥ç®¡ç†æ‰€æœ‰ç¼“å­˜çš„node pageé¡µä¿¡æ¯ï¼Œè¯»å–é‡Œé¢çš„è„é¡µå¼‚æ­¥å›å†™</span><br><span class="hljs-keyword">while</span> (!done &amp;&amp; (nr_pages = pagevec_lookup_tag(&amp;pvec,<br>NODE_MAPPING(sbi), &amp;index, PAGECACHE_TAG_DIRTY))) &#123;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++) &#123;<br>            <span class="hljs-comment">// æ‰¾åˆ°å¯¹åº”çš„node pageæ–°å—åœ°å€ï¼Œç„¶åä¸‹å‘bio</span><br>ret = __write_node_page(page, <span class="hljs-literal">false</span>, &amp;submitted, wbc, do_balance, io_type, <span class="hljs-literal">NULL</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2024/02/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdentry%E4%B8%8Einode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240216225600102.png" alt="image-20240216225600102" style="zoom:80%;"><h3 id="pageé¡µçŠ¶æ€å’ŒåŸºæ•°æ ‘"><a href="#pageé¡µçŠ¶æ€å’ŒåŸºæ•°æ ‘" class="headerlink" title="pageé¡µçŠ¶æ€å’ŒåŸºæ•°æ ‘"></a>pageé¡µçŠ¶æ€å’ŒåŸºæ•°æ ‘</h3><blockquote><p>æ‘˜è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/68071761?utm_source=wechat_session">https://zhuanlan.zhihu.com/p/68071761?utm_source=wechat_session</a></p></blockquote><p>å¦‚ä½•åœ¨radix treeä¸­æ‰¾åˆ°ä¸€ä¸ªæŒ‡å®šçš„pageå‘¢ï¼Ÿé‚£å°±è¦å›é¡¾ä¸‹struct pageä¸­çš„<strong>mapping</strong>å’Œ<strong>index</strong>åŸŸäº†ï¼ŒmappingæŒ‡å‘pageæ‰€å±æ–‡ä»¶å¯¹åº”çš„address_spaceï¼Œè¿›è€Œå¯ä»¥æ‰¾åˆ°address_spaceçš„radix treeï¼Œindexæ—¢æ˜¯pageåœ¨æ–‡ä»¶å†…çš„offsetï¼Œä¹Ÿå¯ä½œä¸ºæŸ¥æ‰¾è¿™ä¸ªradix treeçš„ç´¢å¼•ï¼Œå› ä¸ºradix treeå°±æ˜¯æŒ‰pageçš„indexæ¥ç»„ç»‡struct pageçš„ã€‚</p><p>Linuxä¸­radix treeçš„æ¯ä¸ªsloté™¤äº†å­˜æ”¾æŒ‡é’ˆï¼Œè¿˜å­˜æ”¾ç€<strong>pageçš„æ ‡å¿—flagå’Œç£ç›˜æ–‡ä»¶åŒæ­¥çŠ¶æ€çš„tag</strong>ã€‚å¦‚æœpage cacheä¸­ä¸€ä¸ªpageåœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹åæ²¡æœ‰åŒæ­¥åˆ°ç£ç›˜ï¼Œå°±è¯´è¿™ä¸ªpageæ˜¯dirtyçš„ï¼Œæ­¤æ—¶tagå°±æ˜¯PAGECACHE_TAG_DIRTYã€‚å¦‚æœæ­£åœ¨åŒæ­¥ï¼Œtagå°±æ˜¯PAGECACHE_TAG_WRITEBACKã€‚</p><p>åªè¦ä¸‹ä¸€å±‚ä¸­æœ‰ä¸€ä¸ªslotæŒ‡å‘çš„pageæ˜¯dirtyçš„ï¼Œé‚£ä¹ˆä¸Šä¸€å±‚çš„è¿™ä¸ªslotçš„tagå°±æ˜¯â€dirtyâ€çš„ï¼ˆå°±åƒä¸€æ»´å¢¨æ°´ä¸€æ ·ï¼Œæ”¾å…¥æ¸…æ°´åï¼Œæ¸…æ°´ä¹Ÿå°±ä¸å†å®Œå…¨æ¸…æ¾ˆäº†ï¼‰ã€‚å‰é¢ä»‹ç»struct pageä¸­çš„<strong>flags</strong>æ—¶æåˆ°ï¼Œflagså¯ä»¥æ˜¯PG_dirtyæˆ–PG_writebackï¼Œæ—¢ç„¶struct pageä¸­å·²ç»æœ‰äº†æ ‡è¯†åŒæ­¥çŠ¶æ€çš„ä¿¡æ¯ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œradix treeè¿˜è¦å†åŠ ä¸Štagæ¥æ ‡è®°å‘¢ï¼Ÿ</p><p>å› ä¸ºpageæ•°é‡ä¼—å¤šï¼Œå†…æ ¸ä¸å¯èƒ½ä¸ºæ¯ä¸€ä¸ªpageç»´æŠ¤ä¸€ä¸ªtimerï¼Œå› æ­¤åœ¨åˆ¤æ–­æ˜¯å¦åº”è¯¥writebackæ—¶ï¼Œæ˜¯ä»¥inodeä¸ºå•ä½çš„ï¼Œè€Œä¸€ä¸ªinodeå¯¹åº”çš„address spaceä¸­ï¼Œæœ‰å¾ˆå¤šæ˜¯dirtyçš„pageï¼Œå¾ˆå¤šæ˜¯cleançš„ï¼Œcleançš„pageä¸éœ€è¦writebackã€‚</p><p>åœ¨éå†radix treeçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå»é€ä¸€æ¯”å¯¹æ¯ä¸ªpageçš„â€PG_dirtyâ€æ ‡å¿—ä½ï¼Œå°†åšå¾ˆå¤šæ— ç”¨åŠŸã€‚è€Œå½“slotä¹ŸåŠ ä¸Šâ€dirtyâ€æ ‡å¿—ä½åï¼Œé‚£ä¹ˆå¦‚æœslotæ˜¯cleançš„ï¼Œå°±æ²¡æœ‰å¿…è¦å†æ‰«æå…¶ä¸‹ä¸€å±‚çš„slotå’Œpageäº†ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¼€é”€ã€‚</p><blockquote><p>ğŸ”´ç°åœ¨address_spaceä¸­radix treeå·²ç»è¢«xarrayå–ä»£äº†ï¼ˆå‚è€ƒ<a href="https://link.zhihu.com/?target=https://lwn.net/Articles/745073/">è¿™ç¯‡æ–‡ç« </a>ï¼‰ã€‚</p><p>xarrayç›¸å…³çš„APIï¼š<a href="https://blog.csdn.net/Rong_Toa/article/details/106441355?spm=1001.2014.3001.5506">https://blog.csdn.net/Rong_Toa/article/details/106441355?spm=1001.2014.3001.5506</a></p></blockquote><h3 id="æ¸…é™¤è„é¡µçŠ¶æ€PAGECACHE-TAG-DIRTY"><a href="#æ¸…é™¤è„é¡µçŠ¶æ€PAGECACHE-TAG-DIRTY" class="headerlink" title="æ¸…é™¤è„é¡µçŠ¶æ€PAGECACHE_TAG_DIRTY"></a>æ¸…é™¤è„é¡µçŠ¶æ€PAGECACHE_TAG_DIRTY</h3><p>æ¸…é™¤è„é¡µçŠ¶æ€PAGECACHE_TAG_DIRTYçš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">set_page_writeback<br>=&gt; test_set_page_writeback<br>=&gt; __test_set_page_writeback(page, false)<br>=&gt; if (!PageDirty(page) [æ¡ä»¶æˆç«‹] xas_clear_mark(&amp;xas, PAGECACHE_TAG_DIRTY);<br></code></pre></td></tr></table></figure><img src="/2024/02/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdentry%E4%B8%8Einode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240218203147942.png" alt="image-20240218203147942" style="zoom:80%;"><p>â“<strong>è¿™é‡Œæœ‰2ä¸ªç–‘é—®éœ€è¦å»è§£ç­”ï¼š</strong></p><p><strong>Q1ï¼šä»€ä¹ˆæ—¶å€™è°ƒç”¨set_page_writeback</strong></p><blockquote><p>A1ï¼šç®€å•å†™ä¸€ä¸‹f2fsæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„è°ƒç”¨æ ˆï¼šf2fs_write_cache_pages -&gt; f2fs_write_single_data_page -&gt; f2fs_do_write_data_page -&gt; set_page_writeback</p></blockquote><p><strong>Q2ï¼šåˆ¤æ–­æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™æ‰ä¼šèµ°åˆ°xas_clear_markï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ¸…é™¤è„é¡µæ ‡è®°å‘¢</strong></p><blockquote><p>A2ï¼šä¸‹é¢ä¸€ç« èŠ‚å°±å¼€å§‹å†™</p></blockquote><h3 id="æ¸…é™¤è„é¡µæ ‡è®°PG-dirty"><a href="#æ¸…é™¤è„é¡µæ ‡è®°PG-dirty" class="headerlink" title="æ¸…é™¤è„é¡µæ ‡è®°PG_dirty"></a>æ¸…é™¤è„é¡µæ ‡è®°PG_dirty</h3><p>æ¸…é™¤è„é¡µæ ‡è®°PG_dirtyçš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">è°ƒç”¨writepagesæ¥å£<br>=&gt; f2fs_write_data_pages<br>=&gt; __f2fs_write_data_pages<br>=&gt; f2fs_write_cache_pages<br>=&gt; clear_page_dirty_for_io<br>=&gt; TestClearPageDirty<br></code></pre></td></tr></table></figure><img src="/2024/02/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdentry%E4%B8%8Einode%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240218210103084.png" alt="image-20240218210103084" style="zoom:80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å†…æ ¸æ–‡ä»¶åŠ å¯†</title>
    <link href="/2024/01/19/%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86/"/>
    <url>/2024/01/19/%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="å†…æ ¸æ–‡ä»¶åŠ å¯†"><a href="#å†…æ ¸æ–‡ä»¶åŠ å¯†" class="headerlink" title="å†…æ ¸æ–‡ä»¶åŠ å¯†"></a>å†…æ ¸æ–‡ä»¶åŠ å¯†</h1><h2 id="åŠ å¯†ç­–ç•¥-fscrypt-policy"><a href="#åŠ å¯†ç­–ç•¥-fscrypt-policy" class="headerlink" title="åŠ å¯†ç­–ç•¥(fscrypt policy)"></a>åŠ å¯†ç­–ç•¥(fscrypt policy)</h2><p>åŠ å¯†ç­–ç•¥V1ï¼šv1ç­–ç•¥çš„ç§˜é’¥é€šè¿‡ä¸€ä¸ª8å­—èŠ‚çš„æ ‡è¯†ç¬¦â€descriptorâ€ä»keyringä¸­è¯†åˆ«</p><p>åŠ å¯†ç­–ç•¥V2ï¼šv2ç­–ç•¥çš„ç§˜é’¥é€šè¿‡ä¸€ä¸ª16å­—èŠ‚çš„æ ‡è¯†ç¬¦â€identifierâ€ä»keyringä¸­è¯†åˆ«</p><img src="/2024/01/19/%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86/image-20240119224248512.png" alt="image-20240119224248512" style="zoom:50%;"><h2 id="FBEç§˜é’¥ç®€ä»‹"><a href="#FBEç§˜é’¥ç®€ä»‹" class="headerlink" title="FBEç§˜é’¥ç®€ä»‹"></a>FBEç§˜é’¥ç®€ä»‹</h2><p>å¯†é’¥ç®¡ç†ä¸­æœ‰ä»¥ä¸‹å…³é”®å¯¹è±¡ï¼š</p><img src="/2024/01/19/%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86/image-20240119225051283.png" alt="image-20240119225051283" style="zoom:67%;"><p>è¿™ä¸‰è€…çš„å…³ç³»å¯ä»¥ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š</p><ol><li>åœ¨ userdata åˆ†åŒºä¸­ï¼Œ ä½äº System DE Storage ä¸­çš„æ¯ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹éƒ½æœ‰è‡ªå·±çš„ System DE Encryption Policyï¼Œè¢«è®°å½•åˆ°æ–‡ä»¶çš„æ‰©å±•å±æ€§ä¸­ï¼›</li><li>System DE Encryption Policy è®°å½•äº†ï¼š<ol><li>åŠ å¯†ä½¿ç”¨çš„ key ï¼Œå³ System DE Master Keyï¼›</li><li>æ–‡ä»¶å†…å®¹çš„åŠ å¯†ç®—æ³•ï¼›</li><li>æ–‡ä»¶åçš„åŠ å¯†ç®—æ³•ï¼›</li></ol></li><li>åœ¨ I&#x2F;O æ—¶ï¼Œåº•å±‚é©±åŠ¨æ ¹æ®æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„ System DE Encryption Policy åŠ å¯†å’Œè§£å¯†æ•°æ®ï¼›</li></ol><h2 id="fscrypt-ctlå‘½ä»¤è§£æ"><a href="#fscrypt-ctlå‘½ä»¤è§£æ" class="headerlink" title="fscrypt_ctlå‘½ä»¤è§£æ"></a>fscrypt_ctlå‘½ä»¤è§£æ</h2><h3 id="æ·»åŠ ç§˜é’¥add-key"><a href="#æ·»åŠ ç§˜é’¥add-key" class="headerlink" title="æ·»åŠ ç§˜é’¥add_key"></a>æ·»åŠ ç§˜é’¥add_key</h3><p>ä¸€å¥è¯æ€»ç»“ï¼šç”¨æˆ·æ€æ„é€ fscrypt_add_key_argå‚æ•°ç»“æ„ä½“ï¼Œé€šè¿‡ioctlçš„FS_IOC_ADD_ENCRYPTION_KEYå®‰è£…ç§˜é’¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cmd_add_key</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[])</span> &#123;<br>  handle_no_options(&amp;argc, &amp;argv);<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mountpoint = argv[<span class="hljs-number">0</span>];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_add_key_arg</span> *<span class="hljs-title">arg</span> =</span><br>      <span class="hljs-built_in">calloc</span>(<span class="hljs-keyword">sizeof</span>(*arg) + FSCRYPT_MAX_KEY_SIZE, <span class="hljs-number">1</span>);<br><br>  <span class="hljs-type">int</span> status = EXIT_FAILURE;<br>  arg-&gt;raw_size = read_key(arg-&gt;raw);<br>  arg-&gt;key_spec.type = FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER;<br><br>  <span class="hljs-type">int</span> fd = open(mountpoint, O_RDONLY | O_CLOEXEC);<br><br>  <span class="hljs-comment">// å‘æŒ‚è½½ç‚¹çš„super blockçš„keyringä¸­å®‰è£…arg-&gt;raw(ä¹Ÿå°±æ˜¯ç”¨æˆ·è®¾ç½®çš„key)</span><br>  <span class="hljs-keyword">if</span> (ioctl(fd, FS_IOC_ADD_ENCRYPTION_KEY, arg) != <span class="hljs-number">0</span>) &#123;<br>    close(fd);<br>    <span class="hljs-keyword">goto</span> cleanup;<br>  &#125;<br>  close(fd);<br><br>  <span class="hljs-comment">// å†…æ ¸è¿”å›çš„identifierï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidentifieråœ¨å†…æ ¸çš„keyringä¸­æ‰¾åˆ°å¯¹åº”çš„key</span><br>  <span class="hljs-type">char</span> identifier_hex[FSCRYPT_KEY_IDENTIFIER_HEX_SIZE];<br>  bytes_to_hex(arg-&gt;key_spec.u.identifier, FSCRYPT_KEY_IDENTIFIER_SIZE,<br>               identifier_hex);<br>  <span class="hljs-built_in">puts</span>(identifier_hex);<br>  status = EXIT_SUCCESS;<br>cleanup:<br>  secure_wipe(arg-&gt;raw, arg-&gt;raw_size);<br>  <span class="hljs-built_in">free</span>(arg);<br>  <span class="hljs-keyword">return</span> status;<br>&#125;<br><br><span class="hljs-comment">// ä½œç”¨: read_until_limit_or_eofè¯»å–è¾“å…¥çš„ç§˜é’¥</span><br><span class="hljs-comment">//      è¿™é‡Œçš„STDIN_FILENOé€šè¿‡é‡å®šå‘çš„æ–‡ä»¶è¯»å–</span><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">read_key</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> raw_key[FSCRYPT_MAX_KEY_SIZE])</span> &#123;<br>  <span class="hljs-type">uint8_t</span> buf[FSCRYPT_MAX_KEY_SIZE + <span class="hljs-number">1</span>];<br>  <span class="hljs-type">ssize_t</span> ret = read_until_limit_or_eof(STDIN_FILENO, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>  <span class="hljs-built_in">memcpy</span>(raw_key, buf, ret);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><img src="/2024/01/19/%E5%86%85%E6%A0%B8%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86/image-20240119225545849.png" alt="image-20240119225545849" style="zoom:67%;"><p>å†…æ ¸å¤„ç†IOCTL</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fscrypt_ioctl_add_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">void</span> __user *_uarg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> file_inode(filp)-&gt;i_sb;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_add_key_arg</span> __<span class="hljs-title">user</span> *<span class="hljs-title">uarg</span> =</span> _uarg;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_add_key_arg</span> <span class="hljs-title">arg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_master_key_secret</span> <span class="hljs-title">secret</span>;</span><br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;arg, uarg, <span class="hljs-keyword">sizeof</span>(arg)))<br><span class="hljs-keyword">return</span> -EFAULT;<br>    <br><span class="hljs-built_in">memset</span>(&amp;secret, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secret));<br><span class="hljs-keyword">if</span> (arg.key_id) &#123;<br>err = get_keyring_key(arg.key_id, arg.key_spec.type, &amp;secret);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>secret.size = arg.raw_size;<br>        <span class="hljs-comment">// ç”¨æˆ·æ€ä¼ è¿›æ¥çš„key</span><br>copy_from_user(secret.raw, uarg-&gt;raw, secret.size)<br>&#125;<br><br>err = add_master_key(sb, &amp;secret, &amp;arg.key_spec);<br><br><span class="hljs-keyword">if</span> (arg.key_spec.type == FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER &amp;&amp;<br>    copy_to_user(uarg-&gt;key_spec.u.identifier, arg.key_spec.u.identifier,<br> FSCRYPT_KEY_IDENTIFIER_SIZE))<br><span class="hljs-keyword">goto</span> out_wipe_secret;<br>err = <span class="hljs-number">0</span>;<br>out_wipe_secret:<br>wipe_master_key_secret(&amp;secret);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœŸæ­£çš„å‘keyringä¸­æ·»åŠ keyçš„å‡½æ•°ä¸ºadd_master_key</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_master_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> fscrypt_master_key_secret *secret,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> fscrypt_key_specifier *key_spec)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">// hkdf: æ˜¯ä¸€ç§å¯†é’¥æ´¾ç”Ÿå‡½æ•°,ç”¨äºä»è¾ƒçŸ­çš„è¾“å…¥å¯†é’¥ä¸­æ´¾ç”Ÿå‡ºæ›´é•¿çš„è¾“å‡ºå¯†é’¥ã€‚</span><br><span class="hljs-keyword">if</span> (key_spec-&gt;type == FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER) &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– KDF å‡½æ•°ï¼Œè®¾ç½® KDF Keyï¼›</span><br>err = fscrypt_init_hkdf(&amp;secret-&gt;hkdf, secret-&gt;raw,<br>secret-&gt;size);<br><br>memzero_explicit(secret-&gt;raw, secret-&gt;size);<br><br>        <span class="hljs-comment">// é€šè¿‡ KDF ï¼Œä» KDF Key æ´¾ç”Ÿå‡ºæ–°çš„ keyï¼Œä½œä¸º master_key_identifierå¹¶è¿”å›ç»™ä¸Šå±‚ç”¨æˆ·</span><br>err = fscrypt_hkdf_expand(&amp;secret-&gt;hkdf,<br>  HKDF_CONTEXT_KEY_IDENTIFIER, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>,<br>  key_spec-&gt;u.identifier,<br>  FSCRYPT_KEY_IDENTIFIER_SIZE);<br>&#125;<br><span class="hljs-keyword">return</span> do_add_master_key(sb, secret, key_spec);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Blockæ¨¡å—ä¹‹IOåˆå¹¶ä»£ç è§£æ</title>
    <link href="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Blockæ¨¡å—ä¹‹IOåˆå¹¶ä»£ç è§£æ"><a href="#Blockæ¨¡å—ä¹‹IOåˆå¹¶ä»£ç è§£æ" class="headerlink" title="Blockæ¨¡å—ä¹‹IOåˆå¹¶ä»£ç è§£æ"></a>Blockæ¨¡å—ä¹‹IOåˆå¹¶ä»£ç è§£æ</h1><p><a href="https://www.cnblogs.com/jrchyang/p/16795368.html">https://www.cnblogs.com/jrchyang/p/16795368.html</a></p><p><a href="https://www.ubuntukylin.com/news/791-cn.html">https://www.ubuntukylin.com/news/791-cn.html</a></p><h2 id="é€»è¾‘å…¥å£"><a href="#é€»è¾‘å…¥å£" class="headerlink" title="é€»è¾‘å…¥å£"></a>é€»è¾‘å…¥å£</h2><h2 id="Plugåˆå¹¶"><a href="#Plugåˆå¹¶" class="headerlink" title="Plugåˆå¹¶"></a>Plugåˆå¹¶</h2><p>Plugåˆå¹¶æ˜¯å†…æ ¸é€šç”¨å—å±‚æä¾›çš„æœºåˆ¶ï¼Œå¦‚æœéœ€è¦å¼€å¯åˆ™åœ¨æäº¤IOå‰æ‰§è¡Œ <code>blk_start_plug()</code> å‡½æ•°å¯åŠ¨è“„æµï¼ŒIOå…¨éƒ¨æäº¤å®Œæˆåæ‰§è¡Œ <code>blk_finish_plug()</code> å‡½æ•°è¿›è¡Œæ³„æµã€‚å¯åŠ¨è“„æµä¸»è¦æ˜¯ä¸ºå½“å‰è¿›ç¨‹ï¼ˆ <code>current</code> å®ï¼‰åˆ†é…plugé“¾è¡¨ï¼Œæäº¤IOæ—¶plugé“¾è¡¨å­˜åœ¨åˆ™IOå…ˆç¼“å­˜åˆ°è¯¥é“¾è¡¨ä¸­ï¼Œæ‰§è¡Œæ³„æµæ—¶å°†è¯¥é“¾è¡¨ä¸­ç¼“å­˜çš„IOä¸‹å‘ã€‚æ‰§è¡Œplugåˆå¹¶çš„å‡½æ•°ä¸º <code>blk_attempt_plug_merge()</code> ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘ä¸ºéå† <code>current-&gt;plug-&gt;list</code> ä¸­çš„æ‰€æœ‰è¯·æ±‚ï¼Œå°†å±äºåŒä¸€ä¸ªåº•å±‚è®¾å¤‡é˜Ÿåˆ—ä¸”ä½ç½®ç›¸é‚»çš„è¯·æ±‚åˆå¹¶åœ¨ä¸€èµ·ï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">blk_attempt_plug_merge</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request_queue *q, <span class="hljs-keyword">struct</span> bio *bio,</span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *request_count,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> request **same_queue_rq)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> *<span class="hljs-title">plug</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> *<span class="hljs-title">rq</span>;</span><br><span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">plug_list</span>;</span><br> <br>plug = current-&gt;plug;<br><span class="hljs-keyword">if</span> (!plug)<br><span class="hljs-keyword">goto</span> out;<br>*request_count = <span class="hljs-number">0</span>;<br> <br><span class="hljs-keyword">if</span> (q-&gt;mq_ops)<br>plug_list = &amp;plug-&gt;mq_list;<br><span class="hljs-keyword">else</span><br>plug_list = &amp;plug-&gt;<span class="hljs-built_in">list</span>;<br> <br>list_for_each_entry_reverse(rq, plug_list, queuelist) &#123;<br><span class="hljs-type">int</span> el_ret;<br> <br><span class="hljs-comment">/* ç»™plug_listä¸­åŒä¸€ä¸ªè®¾å¤‡çš„è¯·æ±‚è®¡æ•° */</span><br><span class="hljs-keyword">if</span> (rq-&gt;q == q) &#123;<br>(*request_count)++;<br><span class="hljs-keyword">if</span> (same_queue_rq)<br>*same_queue_rq = rq;<br>&#125;<br> <br><span class="hljs-comment">/* åŒä¸€é˜Ÿåˆ—ï¼Œæ»¡è¶³åˆå¹¶çš„æ‰èƒ½åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (rq-&gt;q != q || !blk_rq_merge_ok(rq, bio))<br><span class="hljs-keyword">continue</span>;<br> <br><span class="hljs-comment">/* åˆ¤æ–­èƒ½è¿›è¡Œåˆå¹¶çš„ä½ç½® */</span><br>el_ret = blk_try_merge(rq, bio);<br><span class="hljs-keyword">if</span> (el_ret == ELEVATOR_BACK_MERGE) &#123;<br>ret = bio_attempt_back_merge(q, rq, bio);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el_ret == ELEVATOR_FRONT_MERGE) &#123;<br>ret = bio_attempt_front_merge(q, rq, bio);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br>out:<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥é€»è¾‘ä¸­æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ã€‚ä¸€æ˜¯ <code>request_count</code> è®¡æ•°ï¼Œè¯¥å˜é‡ç»Ÿè®¡plugé“¾è¡¨ä¸­ä¸å½“å‰IOå±äºåŒä¸€é˜Ÿåˆ—çš„è¯·æ±‚ä¸ªæ•°ï¼Œå½“æ•°é‡è¶…è¿‡ <code>BLK_MAX_REQUEST_COUNT</code> ï¼ˆå½“å‰å®šä¹‰ä¸º16ï¼‰æ—¶åˆ™ä¸»åŠ¨ä¸‹åˆ·plugä¸­çš„è¯·æ±‚ï¼›äºŒæ˜¯å‡½æ•° <code>blk_rq_merge_ok()</code> ä¸å‡½æ•° <code>blk_try_merge()</code> ï¼Œå…¶ä¸­ <code>blk_rq_merge_ok()</code> æ£€æŸ¥reqåŠbioå±æ€§æ˜¯å¦æ”¯æŒåˆå¹¶ï¼Œ <code>blk_try_merge()</code> åˆ™æ˜¯æ ¹æ®reqåŠbioçš„èµ·å§‹ä½ç½®ä¸é•¿åº¦æ¥æ£€æŸ¥æ˜¯å¦ç›¸é‚»ï¼Œä»¥åˆ¤æ–­èƒ½å¦åˆå¹¶ä»¥åŠåˆå¹¶çš„ç±»å‹ï¼ˆå‰å‘&#x2F;åå‘ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">blk_rq_merge_ok</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request *rq, <span class="hljs-keyword">struct</span> bio *bio)</span><br>&#123;<br><span class="hljs-comment">/* rq_mergeable - åˆ¤æ–­rqæ˜¯å¦æœ‰ä¸å…è®¸åˆå¹¶çš„æ ‡è®°</span><br><span class="hljs-comment"> * bio_mergeable - åˆ¤æ–­bioæ˜¯å¦æœ‰ä¸å…è®¸åˆå¹¶çš„æ ‡è®°</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!rq_mergeable(rq) || !bio_mergeable(bio))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-comment">/* åˆ¤æ–­rqå’Œbioæ˜¯å¦æ˜¯ç‰¹æ®Šçš„è¯·æ±‚ï¼Œ</span><br><span class="hljs-comment"> * å¦‚æœæ˜¯ç‰¹æ®Šè¯·æ±‚å¹¶ä¸”ä¸¤è€…ç›¸åŒåˆ™ä¸å…è®¸åˆå¹¶</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!blk_check_merge_flags(rq-&gt;cmd_flags, bio-&gt;bi_rw))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-comment">/* è¯·æ±‚æ–¹å‘ä¸åŒï¼Œä¸èƒ½åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (bio_data_dir(bio) != rq_data_dir(rq))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-comment">/* æŒ‡å‘çš„é€šç”¨ç£ç›˜ä¸åŒæˆ–è€…rqæ˜¯ç‰¹æ®Šè¯·æ±‚ï¼Œä¸èƒ½åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (rq-&gt;rq_disk != bio-&gt;bi_bdev-&gt;bd_disk || req_no_special_merge(rq))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-comment">/* å®Œæ•´æ€§ä¿æŠ¤ä¸åŒçš„è¯·æ±‚å’Œbioï¼Œä¸èƒ½åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (bio_integrity(bio) != blk_integrity_rq(rq))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-comment">/* REQ_WRITE_SAMEè¯·æ±‚ï¼Œæ¥è‡ªä¸åŒçš„pageï¼Œä¸èƒ½åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (rq-&gt;cmd_flags &amp; REQ_WRITE_SAME &amp;&amp;<br>    !blk_write_same_mergeable(rq-&gt;bio, bio))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> <br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">blk_try_merge</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request *rq, <span class="hljs-keyword">struct</span> bio *bio)</span><br>&#123;<br><span class="hljs-comment">/* rqç»“æŸä½ç½®ç­‰äºbioèµ·å§‹ä½ç½®è¿”å›åå‘åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (blk_rq_pos(rq) + blk_rq_sectors(rq) == bio-&gt;bi_sector)<br><span class="hljs-keyword">return</span> ELEVATOR_BACK_MERGE;<br><span class="hljs-comment">/* bioç»“æŸä½ç½®ç­‰äºrqèµ·å§‹ä½ç½®è¿”å›å‰å‘åˆå¹¶ */</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (blk_rq_pos(rq) - bio_sectors(bio) == bio-&gt;bi_sector)<br><span class="hljs-keyword">return</span> ELEVATOR_FRONT_MERGE;<br><span class="hljs-keyword">return</span> ELEVATOR_NO_MERGE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="bioå‘ååˆå¹¶"><a href="#bioå‘ååˆå¹¶" class="headerlink" title="bioå‘ååˆå¹¶"></a>bioå‘ååˆå¹¶</h3><p>ä¸ºäº†éªŒè¯IOè¯·æ±‚åœ¨é€šç”¨å—å±‚çš„å„ç§åˆå¹¶å½¢å¼ï¼Œå‡†å¤‡äº†ä»¥ä¸‹æµ‹è¯•ç¨‹åºï¼Œè¯¥æµ‹è¯•ç¨‹åºä½¿ç”¨å†…æ ¸åŸç”Ÿæ”¯æŒçš„å¼‚æ­¥IOå¼•æ“ï¼Œå¯å¼‚æ­¥åœ°å‘å†…æ ¸ä¸€æ¬¡æäº¤å¤šä¸ªIOè¯·æ±‚ã€‚ä¸ºäº†å‡å°‘page cacheå’Œæ–‡ä»¶ç³»ç»Ÿçš„å¹²æ‰°ï¼Œä½¿ç”¨O_DIRECTçš„æ–¹å¼ç›´æ¥å‘è£¸è®¾å¤‡æ´¾å‘IOã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// iotc.c</span><br><br><span class="hljs-comment">/* dispatch 3 4k-size ios using the io_type specified by user */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM_EVENTS  3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ALIGN_SIZE  4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WR_SIZE  4096</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">io_type</span> &#123;</span><br>SEQUENCE_IO,<span class="hljs-comment">/* dispatch 3 ios: 0-4k(0+8), 4-8k(8+8), 8-12k(16+8) */</span><br>REVERSE_IO,<span class="hljs-comment">/* dispatch 3 ios: 8-12k(16+8), 4-8k(8+8),0-4k(0+8) */</span><br>INTERLEAVE_IO, <span class="hljs-comment">/* dispatch 3 ios: 8-12k(16+8), 0-4k(0+8),4-8k(8+8) */</span> ,<br>IO_TYPE_END<br>&#125;;<br><br><span class="hljs-type">int</span> io_units[IO_TYPE_END][NUM_EVENTS] = &#123;<br>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;,<span class="hljs-comment">/* corresponding to SEQUENCE_IO */</span><br>&#123;<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;,<span class="hljs-comment">/* corresponding to REVERSE_IO */</span><br>&#123;<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;<span class="hljs-comment">/* corresponding to INTERLEAVE_IO */</span><br>&#125;;<br><br><span class="hljs-type">char</span> *io_opt = <span class="hljs-string">&quot;srid:&quot;</span>;<span class="hljs-comment">/* acceptable options */</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">io_context_t</span> ctx;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">tms</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_event</span> <span class="hljs-title">events</span>[<span class="hljs-title">NUM_EVENTS</span>];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iocb</span> <span class="hljs-title">iocbs</span>[<span class="hljs-title">NUM_EVENTS</span>],</span><br><span class="hljs-class">                *<span class="hljs-title">iocbp</span>[<span class="hljs-title">NUM_EVENTS</span>];</span><br><span class="hljs-type">int</span> i, io_flag = <span class="hljs-number">-1</span>;;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">bool</span> hit = <span class="hljs-literal">false</span>;<br><span class="hljs-type">char</span> *dev = <span class="hljs-literal">NULL</span>, opt;<br><br><span class="hljs-comment">/* io_flag and dev got set according the options passed by user , donâ€™t paste the code of parsing here to shrink space */</span><br>fd = open(dev, O_RDWR | __O_DIRECT);<br><br><span class="hljs-comment">/* we can dispatch 32 IOs at 1 systemcall */</span><br>ctx = <span class="hljs-number">0</span>;<br><br>io_setup(<span class="hljs-number">32</span>, &amp;ctx);<br>posix_memalign(&amp;buf,ALIGN_SIZE,WR_SIZE);<br><br><span class="hljs-comment">/* prepare IO request according to io_type */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NUM_EVENTS; iocbp[i] = iocbs + i, ++i)<br>io_prep_pwrite(&amp;iocbs[i], fd, buf, WR_SIZE, io_units[io_flag][i] * WR_SIZE);<br><br><span class="hljs-comment">/* submit IOs using io_submit systemcall */</span><br>io_submit(ctx, NUM_EVENTS, iocbp);<br><br><span class="hljs-comment">/* get the IO result with a timeout of 1S*/</span><br>tms.tv_sec = <span class="hljs-number">1</span>;<br>tms.tv_nsec = <span class="hljs-number">0</span>;<br>io_getevents(ctx, <span class="hljs-number">1</span>, NUM_EVENTS, events, &amp;tms);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åºæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºä½œç”¨çš„è®¾å¤‡ï¼Œç¬¬äºŒä¸ªä¸ºIOç±»å‹ï¼Œå®šä¹‰äº†ä¸‰ç§IOç±»å‹ï¼šSEQUENCE_IOï¼ˆé¡ºåºï¼‰ï¼ŒREVERSE_IOï¼ˆé€†åºï¼‰ï¼ŒINTERLEAVE_IOï¼ˆäº¤æ›¿ï¼‰åˆ†åˆ«ç”¨æ¥éªŒè¯è“„æµé˜¶æ®µçš„bioåå‘åˆå¹¶ã€å‰å‘åˆå¹¶å’Œæ³„æµé˜¶æ®µçš„requeståˆå¹¶ã€‚ä¸ºäº†å‡å°‘ç¯‡å¹…ï¼Œæ­¤å¤„è´´å‡ºçš„æºç åˆ é™¤äº†é€‰é¡¹è§£æå’Œå®¹é”™å¤„ç†ï¼Œåªä¿ç•™ä¸»å¹²ï¼ŒåŸç‰ˆä½äºï¼š <a href="https://github.com/liuzhengyuan/iotc%E3%80%82">https://github.com/liuzhengyuan/iotcã€‚</a></p><p>ä¸ºéªŒè¯bioåœ¨è“„æµé˜¶æ®µçš„åå‘åˆå¹¶ï¼Œç”¨ä¸Šé¢çš„æµ‹è¯•ç¨‹åºiotcé¡ºåºæ´¾å‘ä¸‰ä¸ªå†™io:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ./iotc -d /dev/sdb -s</span><br></code></pre></td></tr></table></figure><p>-dæŒ‡å®šä½œç”¨çš„è®¾å¤‡sdbï¼Œ-sæŒ‡å®šIOæ–¹å¼ä¸ºSEQUENCE_IOï¼ˆé¡ºåºï¼‰ï¼Œè¡¨ç¤ºé¡ºåºå‘èµ·ä¸‰ä¸ªå†™è¯·æ±‚ï¼šbio0(0 + 8), bio1(8 + 8), bio2(16 + 8)ã€‚é€šè¿‡blktraceæ¥è§‚å¯Ÿiotcæ´¾å‘çš„bioè¯·æ±‚åœ¨é€šç”¨å—å±‚è“„æµé“¾è¡¨ä¸­çš„åˆå¹¶æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">blktrace -d /dev/sdb -o - | blkparse -i -<br></code></pre></td></tr></table></figure><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254084160608.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶"><p>ä¸Šé¢çš„è¾“å‡ºå¯ä»¥ç®€å•è§£æä¸ºï¼š</p><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254095647471.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶"><p>ç¬¬ä¸€ä¸ªbio(bio0)è¿›å…¥é€šç”¨å—å±‚æ—¶ï¼Œæ­¤æ—¶è“„æµé“¾è¡¨ä¸ºç©ºï¼Œäºæ˜¯ç”³è¯·ä¸€ä¸ªrequestå¹¶ç”¨bio0åˆå§‹åŒ–ï¼Œå†å°†requestæ·»åŠ è¿›è“„æµé“¾è¡¨ï¼ŒåŒæ—¶å‘Šè¯‰blktraceè“„æµå·²æ­£å¼å·¥ä½œã€‚ç¬¬äºŒä¸ªbio(bio1)åˆ°æ¥çš„æ—¶å€™ä¼šèµ°blk_attempt_plug_mergeçš„é€»è¾‘ï¼Œå°è¯•è°ƒç”¨bio_attempt_back_mergeä¸è“„æµé“¾è¡¨ä¸­çš„requeståˆå¹¶ï¼Œå‘ç°æ­£å¥½èƒ½åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªbioæ‰€åœ¨çš„requestå°¾éƒ¨ï¼Œäºæ˜¯ç›´æ¥è¿”å›ã€‚ç¬¬ä¸‰ä¸ªbio(bio2)çš„å¤„ç†ä¸ç¬¬äºŒä¸ªåŒç†ã€‚é€šè¿‡è“„æµåˆå¹¶ä¹‹åï¼Œä¸‰ä¸ªIOè¯·æ±‚æœ€ç»ˆåˆå¹¶æˆäº†ä¸€ä¸ªrequest(0 + 24)ã€‚ç”¨ä¸€å‰¯å›¾æ¥å±•ç¤ºæ•´ä¸ªåˆå¹¶è¿‡ç¨‹ï¼š</p><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254105303637.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶" style="zoom: 80%;"><h3 id="bioå‘å‰åˆå¹¶"><a href="#bioå‘å‰åˆå¹¶" class="headerlink" title="bioå‘å‰åˆå¹¶"></a>bioå‘å‰åˆå¹¶</h3><p>ä¸ºéªŒè¯bioåœ¨è“„æµé˜¶æ®µçš„å‰å‘åˆå¹¶ï¼Œä½¿ç”¨iotcé€†åºæ´¾å‘ä¸‰ä¸ªå†™io:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ./iotc -d /dev/sdb -r</span><br></code></pre></td></tr></table></figure><p>-ræŒ‡å®šIOæ–¹å¼ä¸ºREVERSE_IOï¼ˆé€†åºï¼‰ï¼Œè¡¨ç¤ºé€†åºå‘èµ·ä¸‰ä¸ªå†™è¯·æ±‚ï¼šbio0(16 + 8),bio1(8 + 8), bio2(0 + 8)ã€‚blktraceçš„è§‚å¯Ÿç»“æœä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">blktrace -d /dev/sdb -o - | blkparse -i -<br></code></pre></td></tr></table></figure><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254118631038.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶"><p>ä¸Šé¢çš„è¾“å‡ºå¯ä»¥ç®€å•è§£æä¸ºï¼š</p><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254143306219.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶"><p>ä¸å‰é¢çš„åå‘åˆå¹¶ç›¸æ¯”ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åˆå¹¶æ–¹å¼ç”±ä¹‹å‰çš„â€Mâ€å˜æˆäº†ç°åœ¨çš„â€Fâ€ï¼Œå³åœ¨blk_attempt_plug_mergeä¸­èµ°çš„æ˜¯bio_attempt_front_mergeåˆ†æ”¯ã€‚é€šè¿‡ä¸‹é¢çš„å›¾æ¥å±•ç¤ºå‰å‘åˆå¹¶è¿‡ç¨‹ï¼š</p><img src="/2024/01/04/Block%E6%A8%A1%E5%9D%97%E4%B9%8BIO%E5%90%88%E5%B9%B6%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/1528254164616153.png" alt="Linuxé€šç”¨å—å±‚ä¹‹IOåˆå¹¶" style="zoom:80%;"><p>â€œplugåˆå¹¶â€ä¸ä¼šåšrequestä¸requestçš„è¿›é˜¶åˆå¹¶ï¼Œè“„æµé“¾è¡¨ä¸­çš„requestä¹‹é—´çš„åˆå¹¶ä¼šåœ¨æ³„æµçš„æ—¶å€™åšï¼Œå³åœ¨ä¸‹é¢ä»‹ç»çš„â€œelevatoråˆå¹¶â€ä¸­åšã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kernel-4.1.15çš„bioæµç¨‹</title>
    <link href="/2024/01/03/kernel-4-1-15%E7%9A%84bio%E6%B5%81%E7%A8%8B/"/>
    <url>/2024/01/03/kernel-4-1-15%E7%9A%84bio%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="kernel-4-1-15çš„bioæµç¨‹"><a href="#kernel-4-1-15çš„bioæµç¨‹" class="headerlink" title="kernel-4.1.15çš„bioæµç¨‹"></a>kernel-4.1.15çš„bioæµç¨‹</h1><p>å—è®¾å¤‡é©±åŠ¨ï¼š<a href="https://blog.csdn.net/morecrazylove/article/details/128712522">https://blog.csdn.net/morecrazylove/article/details/128712522</a></p><p>blockå±‚æ¼”å˜ï¼š<a href="https://blog.csdn.net/weixin_30522983/article/details/112331407">https://blog.csdn.net/weixin_30522983/article/details/112331407</a></p><p>linuxå—è®¾å¤‡é©±åŠ¨blk-mqï¼š<a href="https://www.cnblogs.com/zyly/p/16690841.html">https://www.cnblogs.com/zyly/p/16690841.html</a></p><h2 id="1-å‘é€bioçš„è¿‡ç¨‹"><a href="#1-å‘é€bioçš„è¿‡ç¨‹" class="headerlink" title="1.å‘é€bioçš„è¿‡ç¨‹"></a>1.å‘é€bioçš„è¿‡ç¨‹</h2><h3 id="submit-bio"><a href="#submit-bio" class="headerlink" title="submit_bio"></a>submit_bio</h3><p>submit_bioæ˜¯æäº¤bioçš„æ€»çš„æ¥å£ï¼Œåœ¨å—å±‚ä¹‹ä¸Šï¼Œå³æ–‡ä»¶ç³»ç»Ÿå±‚æ ¹æ®å®é™…åœºæ™¯æœ‰å¾ˆå¤šå¯¹submit_bioçš„ä¸åŒå°è£…ï¼Œsubmit_bioä¸»è¦è°ƒç”¨generic_make_requestæŠŠbioè½¬æ¢æˆrequestã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">submit_bio</span><span class="hljs-params">(<span class="hljs-type">int</span> rw, <span class="hljs-keyword">struct</span> bio *bio)</span><br>&#123;<br>    generic_make_request(bio);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="generic-make-request"><a href="#generic-make-request" class="headerlink" title="generic_make_request"></a>generic_make_request</h3><blockquote><p>æ³¨æ„ï¼šcurrentåœ¨kernelæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªbio_list</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">generic_make_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bio *bio)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_list</span> <span class="hljs-title">bio_list_on_stack</span>;</span><br>    <br>    <span class="hljs-keyword">if</span> (current-&gt;bio_list) &#123;<br>bio_list_add(current-&gt;bio_list, bio);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>    <br>    bio_list_init(&amp;bio_list_on_stack);<br>current-&gt;bio_list = &amp;bio_list_on_stack;<br><span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">// è·å–å—è®¾å¤‡å¯¹åº”çš„I/Oè¯·æ±‚é˜Ÿåˆ—</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> *<span class="hljs-title">q</span> =</span> bdev_get_queue(bio-&gt;bi_bdev);<br>        <span class="hljs-comment">// è°ƒç”¨è¯·æ±‚å¤„ç†å‡½æ•°ï¼Œæœ¬æ–‡ä¸ºblk_queue_bio</span><br>q-&gt;make_request_fn(q, bio);<br>bio = bio_list_pop(current-&gt;bio_list);<br>&#125; <span class="hljs-keyword">while</span> (bio);<br>current-&gt;bio_list = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* deactivate */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸ”´<strong>ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªè¿›ç¨‹è¦è®¾ç½®ä¸€ä¸ªbio_list</strong></p><blockquote><p>è¯¦è§£ï¼š<a href="https://blog.csdn.net/flyingnosky/article/details/121362813">https://blog.csdn.net/flyingnosky/article/details/121362813</a></p></blockquote><p><strong>å¯¹äºæ¯ä¸ªçº¿ç¨‹ï¼Œå­˜åœ¨æˆå‘˜current-&gt;bio_listæ¥æ”¾ç½®æœ¬çº¿ç¨‹å‘é€çš„BIOã€‚è¿™é‡Œæœ‰ä¸‰æ¡è·¯å¾„å‘é€IOåˆ°åº•å±‚ï¼š</strong></p><ul><li>è·¯å¾„ä¸€ï¼Œä½¿èƒ½äº†plug&#x2F;unplugæœºåˆ¶ï¼Œæ­¤æ—¶ä¼šç­‰å¾…plugæ± ä¸­å­˜å–è¶³å¤Ÿçš„IOåç»Ÿä¸€å¾€è°ƒåº¦å™¨æ’å…¥IOï¼Œå¹¶é€‰å–IOä¸‹å‘ï¼›</li><li>è·¯å¾„äºŒï¼Œæ²¡æœ‰ä½¿èƒ½plug&#x2F;unplugæœºåˆ¶ï¼Œæ­¤æ—¶ä¼šå°†IOæ’å…¥è°ƒåº¦å™¨ä¸­ï¼Œå¹¶é€‰å–IOä¸‹å‘ï¼›</li><li>è·¯å¾„ä¸‰ï¼Œè·³è¿‡è°ƒåº¦å±‚ï¼Œç›´æ¥ä¸‹å‘IOï¼›</li></ul><img src="/2024/01/03/kernel-4-1-15%E7%9A%84bio%E6%B5%81%E7%A8%8B/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAZmx5aW5nbm9za3k=,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt="img" style="zoom:80%;"><h3 id="blk-queue-io"><a href="#blk-queue-io" class="headerlink" title="blk_queue_io"></a>blk_queue_io</h3><p><code>blk_queue_io()</code> å‡½æ•°æ˜¯é€šç”¨å—å±‚è¿›è¡ŒIOåˆå¹¶çš„å…¥å£å‡½æ•°ï¼Œè¯¥å‡½æ•°å†…å…ˆå°è¯•Plugåˆå¹¶ï¼Œåˆå¹¶æˆåŠŸè¿”å›ï¼Œåˆå¹¶å¤±è´¥åˆ™ç»§ç»­å°è¯•Elevatoråˆå¹¶ï¼Œåˆå¹¶æˆåŠŸè¿”å›ï¼Œåˆå¹¶å¤±è´¥åˆ™ä¸ºbioåˆ›å»ºä¸€ä¸ªæ–°çš„requestæ’å…¥åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œå°è¯•IOåˆå¹¶éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">blk_queue_io</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request_queue *q, <span class="hljs-keyword">struct</span> bio *bio)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> sync = !!(bio-&gt;bi_rw &amp; REQ_SYNC);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> *<span class="hljs-title">plug</span>;</span><br><span class="hljs-type">int</span> el_ret, rw_flags, where = ELEVATOR_INSERT_SORT;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> *<span class="hljs-title">req</span>, *<span class="hljs-title">free</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> request_count = <span class="hljs-number">0</span>;<br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åšDMAæ—¶çš„ç›¸å…³åœ°å€é™åˆ¶ï¼Œå¯èƒ½è¯¥bioåªèƒ½è®¿é—®ä½ç«¯å†…å­˜ï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤éœ€è¦å°†é«˜ç«¯å†…å­˜ä¸­çš„bioæ•°æ®æ‹·è´åˆ°ä½ç«¯å†…å­˜ä¸­</span><br><span class="hljs-comment"> */</span><br>blk_queue_bounce(q, &amp;bio);<br> <br><span class="hljs-comment">/* å®Œæ•´æ€§æ ¡éªŒ */</span><br><span class="hljs-keyword">if</span> (bio_integrity_enabled(bio) &amp;&amp; bio_integrity_prep(bio)) &#123;<br>bio_endio(bio, -EIO);<br><span class="hljs-keyword">return</span>;<br>&#125;<br> <br><span class="hljs-comment">/* FLUSHå’ŒFUAç›´æ¥ç”Ÿæˆæ–°çš„è¯·æ±‚å¤„ç† */</span><br><span class="hljs-keyword">if</span> (bio-&gt;bi_rw &amp; (REQ_FLUSH | REQ_FUA)) &#123;<br>spin_lock_irq(q-&gt;queue_lock);<br>where = ELEVATOR_INSERT_FLUSH;<br><span class="hljs-keyword">goto</span> get_rq;<br>&#125;<br> <br><span class="hljs-comment">/* å…ˆå°è¯•plugåˆå¹¶ï¼Œplugä¸­ä¸ºå½“å‰è¿›ç¨‹çš„reqé“¾è¡¨ï¼Œåˆå¹¶æˆåŠŸç›´æ¥è¿”å› */</span><br><span class="hljs-keyword">if</span> (!blk_queue_nomerges(q)) &#123;<br><span class="hljs-keyword">if</span> (blk_attempt_plug_merge(q, bio, &amp;request_count, <span class="hljs-literal">NULL</span>))<br><span class="hljs-keyword">return</span>;<br>&#125; <span class="hljs-keyword">else</span><br>request_count = blk_plug_queued_count(q);<br> <br><span class="hljs-comment">/* ä¸ç®¡æ˜¯ä¸é˜Ÿåˆ—ä¸­çš„è¯·æ±‚åˆå¹¶è¿˜æ˜¯æ’å…¥æ–°çš„è¯·æ±‚éƒ½éœ€è¦åŠ é” */</span><br>spin_lock_irq(q-&gt;queue_lock);<br> <br><span class="hljs-comment">/* è¿™é‡Œè®°å½•ä¸‹ç”µæ¢¯å“ˆå¸Œå’Œè°ƒåº¦ç®—æ³•è°ƒåº¦é˜Ÿåˆ—</span><br><span class="hljs-comment"> * bioç”Ÿæˆæ–°çš„è¯·æ±‚åï¼Œä¼šæ’å…¥ä¸¤ä¸ªåœ°æ–¹</span><br><span class="hljs-comment"> * 1.ç”µæ¢¯çš„é€šç”¨å“ˆå¸Œè¡¨ï¼Œä»¥è¯·æ±‚çš„ç»“æŸä¸ºæ­¢ä¸ºå“ˆå¸Œå€¼è¿›è¡Œå“ˆå¸Œï¼Œ</span><br><span class="hljs-comment"> *   ä¾¿äºæŸ¥æ‰¾å¯ä»¥å‘ååˆå¹¶çš„è¯·æ±‚</span><br><span class="hljs-comment"> *   q-&gt;elevator-&gt;hash</span><br><span class="hljs-comment"> * 2.å…·ä½“è°ƒåº¦ç®—æ³•çš„è°ƒåº¦é˜Ÿåˆ—ï¼Œç”¨äºè°ƒåº¦ç®—æ³•è¿›è¡Œè°ƒåº¦ï¼Œä»¥deadlineä¸ºä¾‹</span><br><span class="hljs-comment"> *   q-&gt;elevator-&gt;elevator_data-&gt;sort_list/fifo_expire</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è°ƒåº¦ç®—æ³•æ´¾å‘è¯·æ±‚åï¼Œè¯·æ±‚ä¼šè¿›å…¥qçš„æ´¾å‘é˜Ÿåˆ—ï¼Œ</span><br><span class="hljs-comment"> *   åŒæ—¶ä»å“ˆå¸Œå’Œè°ƒåº¦é˜Ÿåˆ—ä¸­ç§»é™¤</span><br><span class="hljs-comment"> */</span><br> <br><span class="hljs-comment">/* åœ¨è¯·æ±‚é˜Ÿåˆ—çš„å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾å¯ä»¥å‘ååˆå¹¶çš„è¯·æ±‚ï¼Œåœ¨è°ƒåº¦ç®—æ³•</span><br><span class="hljs-comment"> * çš„è°ƒåº¦é˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¯ä»¥åˆå¹¶çš„è¯·æ±‚ï¼ˆdeadlineç®—æ³•ä¸­åªæœ‰å‘å‰åˆå¹¶ï¼‰</span><br><span class="hljs-comment"> */</span><br>el_ret = elv_merge(q, &amp;req, bio);<br><span class="hljs-keyword">if</span> (el_ret == ELEVATOR_BACK_MERGE) &#123;<br><span class="hljs-comment">/* å°è¯•è¿›è¡Œbioä¸reqçš„åˆå¹¶ */</span><br><span class="hljs-keyword">if</span> (bio_attempt_back_merge(q, req, bio)) &#123;<br><span class="hljs-comment">/* åˆå¹¶æˆåŠŸçš„è¯ï¼Œè°ƒç”¨å…·ä½“è°ƒåº¦ç®—æ³•çš„åç»­å¤„ç†ï¼ˆdeadlineä¸­å¹¶æ²¡æœ‰å®ç°æ¥å£ï¼‰ */</span><br>elv_bio_merged(q, req, bio);<br><span class="hljs-comment">/* è¿™æ¬¡åˆå¹¶çš„bioå¯èƒ½ä¼šå¼¥è¡¥ä¸¤ä¸ªbioä¹‹é—´çš„ç©ºéš™ï¼Œæ‰€ä»¥è¿™é‡ŒæŸ¥æ‰¾æ ¹æ®</span><br><span class="hljs-comment"> * ç»™å®šreqåè¾¹çš„ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ¤æ–­èƒ½å¦è¿›è¡Œåˆå¹¶</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">free</span> = attempt_back_merge(q, req);<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">free</span>)<br><span class="hljs-comment">/* å¦‚æœä¸Šè¾¹æ²¡æœ‰æ£€æµ‹åˆ°å¯ä»¥åˆå¹¶çš„requestï¼Œåˆ™è°ƒç”¨æ¥å£å¤„ç†</span><br><span class="hljs-comment"> * bioåˆå¹¶åˆ°requestä¹‹åçš„å¤„ç†ï¼š</span><br><span class="hljs-comment"> *   1.è°ƒç”¨è°ƒåº¦ç®—æ³•çš„å›è°ƒå‡½æ•°å¤„ç†è°ƒåº¦ç®—æ³•éœ€è¦æ‰§è¡Œçš„æ“ä½œ</span><br><span class="hljs-comment"> *   2.å¦‚æœæ˜¯å‘ååˆå¹¶è¿˜éœ€è¦æ›´æ–°ç”µæ¢¯å“ˆå¸Œ</span><br><span class="hljs-comment"> */</span><br>elv_merged_request(q, req, el_ret);<br><span class="hljs-keyword">else</span><br>__blk_put_request(q, <span class="hljs-built_in">free</span>);<br><span class="hljs-keyword">goto</span> out_unlock;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el_ret == ELEVATOR_FRONT_MERGE) &#123;<br><span class="hljs-keyword">if</span> (bio_attempt_front_merge(q, req, bio)) &#123;<br>elv_bio_merged(q, req, bio);<br><span class="hljs-built_in">free</span> = attempt_front_merge(q, req);<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">free</span>)<br>elv_merged_request(q, req, el_ret);<br><span class="hljs-keyword">else</span><br>__blk_put_request(q, <span class="hljs-built_in">free</span>);<br><span class="hljs-keyword">goto</span> out_unlock;<br>&#125;<br>&#125;<br> <br>get_rq:<br><span class="hljs-comment">/* bioæ— æ³•åˆå¹¶ï¼Œä¸ºå…¶ç”³è¯·ä¸€ä¸ªæ–°çš„request */</span><br>rw_flags = bio_data_dir(bio);<br><span class="hljs-keyword">if</span> (sync)<br>rw_flags |= REQ_SYNC;<br> <br>blk_queue_enter_live(q);<br><span class="hljs-comment">/* è·å–ç©ºé—²çš„è¯·æ±‚ */</span><br>req = get_request(q, rw_flags, bio, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(req)) &#123;<br>blk_queue_exit(q);<br>bio_endio(bio, PTR_ERR(req));<span class="hljs-comment">/* @q is dead */</span><br><span class="hljs-keyword">goto</span> out_unlock;<br>&#125;<br> <br><span class="hljs-comment">/* æ ¹æ®bioåˆå§‹åŒ–request */</span><br>init_request_from_bio(req, bio);<br> <br><span class="hljs-keyword">if</span> (test_bit(QUEUE_FLAG_SAME_COMP, &amp;q-&gt;queue_flags))<br>req-&gt;cpu = raw_smp_processor_id();<br> <br><span class="hljs-comment">/* å¦‚æœå½“å‰è¿›ç¨‹æœ‰plug_listï¼Œé¦–å…ˆæ’å…¥åˆ°plug_listä¸­ */</span><br>plug = current-&gt;plug;<br><span class="hljs-keyword">if</span> (plug) &#123;<br><span class="hljs-keyword">if</span> (!request_count || list_empty(&amp;plug-&gt;<span class="hljs-built_in">list</span>))<br>trace_block_plug(q);<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">struct</span> request *last = list_entry_rq(plug-&gt;<span class="hljs-built_in">list</span>.prev);<br><span class="hljs-keyword">if</span> (request_count &gt;= BLK_MAX_REQUEST_COUNT ||<br>    blk_rq_bytes(last) &gt;= BLK_PLUG_FLUSH_SIZE) &#123;<br>blk_flush_plug_list(plug, <span class="hljs-literal">false</span>);<br>trace_block_plug(q);<br>&#125;<br>&#125;<br><span class="hljs-comment">/* æ’å…¥åˆ°plugé“¾è¡¨ */</span><br>list_add_tail(&amp;req-&gt;queuelist, &amp;plug-&gt;<span class="hljs-built_in">list</span>);<br>blk_account_io_start(req, <span class="hljs-literal">true</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>spin_lock_irq(q-&gt;queue_lock);<br><span class="hljs-comment">/* æ’å…¥åˆ°ç”µæ¢¯åŠè°ƒåº¦ç®—æ³•ä¸­ */</span><br>add_acct_request(q, req, where);<br><span class="hljs-comment">/* æ‰§è¡Œq-&gt;request_fn(q)ï¼Œè°ƒç”¨åº•å±‚é©±åŠ¨çš„ç­–ç•¥ä¾‹ç¨‹å¤„ç†è¯·æ±‚ã€‚</span><br><span class="hljs-comment"> * ä»¥SCSIä¸ºä¾‹ï¼Œrequest_fnåˆå§‹åŒ–ä¸ºscsi_request_fn</span><br><span class="hljs-comment"> * scsi_request_fn-&gt;blk_peek_request-&gt;__elv_next_request</span><br><span class="hljs-comment"> * __elv_next_requestä¸­ä¼šä½¿ç”¨è°ƒåº¦å…·ä½“ç®—æ³•çš„</span><br><span class="hljs-comment"> * dispatchå›è°ƒå‡½æ•°å–å‡ºè¯·æ±‚è¿›è¡Œå¤„ç†</span><br><span class="hljs-comment"> */</span><br>__blk_run_queue(q);<br>out_unlock:<br>spin_unlock_irq(q-&gt;queue_lock);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ufsä¸bioæµç¨‹å¤‡å¿˜</title>
    <link href="/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/"/>
    <url>/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<h1 id="ufsä¸bioæµç¨‹å¤‡å¿˜"><a href="#ufsä¸bioæµç¨‹å¤‡å¿˜" class="headerlink" title="ufsä¸bioæµç¨‹å¤‡å¿˜"></a>ufsä¸bioæµç¨‹å¤‡å¿˜</h1><p><strong>ç–‘é—®1ï¼šUFSä¸Scsiçš„å…³ç³»</strong></p><img src="/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/wps1.jpg" alt="img"> <p><a href="https://blog.csdn.net/marlos/article/details/130212441">https://blog.csdn.net/marlos/article/details/130212441</a></p><p><strong>ç–‘é—®2ï¼šUFSå’ŒMMCå¤„ç†requestçš„åŒºåˆ«</strong></p><p>æ¯ä¸ªå—è®¾å¤‡åœ¨ç”Ÿæˆæ—¶ï¼Œä¼šè®¾ç½®è‡ªå·±çš„request_queueåŠå…¶å±æ€§ï¼Œå›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚mmcå’Œufsè®¾å¤‡åˆ†åˆ«è®¾å®šäº†mmc_request_fnå’Œscsi_request_fnä½œä¸ºè¿™ä¸ªrequest_queueçš„request_fnï¼Œä»è€Œå®ç°äº†blockå±‚å’Œè®¾å¤‡é©±åŠ¨å±‚çš„è§£è€¦ã€‚</p><img src="/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/wps2.jpg" alt="img"> <p><a href="https://mp.weixin.qq.com/s/2TphQjyCkKeN5jy2kGHfoA">https://mp.weixin.qq.com/s/2TphQjyCkKeN5jy2kGHfoA</a></p><p><strong>ç–‘é—®3ï¼šufsè®¾å¤‡å’Œscsié©±åŠ¨åŠ è½½æµç¨‹ï¼Œåœ¨scsiåŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šè®¾ç½®request_fn</strong></p><p><a href="http://www.taodudu.cc/news/show-2094536.html?action=onClick">http://www.taodudu.cc/news/show-2094536.html?action=onClick</a></p><p><img src="/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/wps3.jpg" alt="img"> </p><p>scsi_probe_and_add_lun</p><p>scsi_alloc_sdev</p><p>scsi_alloc_queue</p><p>__scsi_alloc_queue</p><p>blk_init_queue</p><p>blk_init_queue_node</p><p>blk_alloc_queue_node</p><img src="/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/wps4.jpg" alt="img"> <p>æ­¤æ—¶ä¼šä¼ é€’scsi_request_fnä¸ºæœ€ç»ˆåœ¨blk_init_allocated_queueä¸­è®¾ç½®ä¸ºrequest_queueçš„request_fnå€¼</p><img src="/2024/01/03/ufs%E4%B8%8Ebio%E6%B5%81%E7%A8%8B%E5%A4%87%E5%BF%98/wps5.jpg" alt="img"> ]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fs.fsckç®€è®°</title>
    <link href="/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/"/>
    <url>/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fs-fsckç®€è®°"><a href="#f2fs-fsckç®€è®°" class="headerlink" title="f2fs.fsckç®€è®°"></a>f2fs.fsckç®€è®°</h1><img src="/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>æ–‡ä»¶æ ¡éªŒæµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"># æ ¹ç›®å½•å¼€å§‹: fsck_chk_node_blk(sbi, <span class="hljs-literal">NULL</span>, sbi-&gt;root_ino_num, F2FS_FT_DIR, TYPE_INODE, &amp;blk_cnt, <span class="hljs-literal">NULL</span>);<br># æ‰¾åˆ°æ ¹ç›®å½•å¯¹åº”çš„Node blockï¼Œæ–‡ä»¶å¤¹å¯¹åº”f2fs_inode: ä»¥fsck_chk_inode_blk(sbi, nid, ftype, node_blk, blk_cnt, &amp;ni, child);<br># æ‰¾åˆ°i_addrä¸ºå¯¹åº”çš„data block: fsck_chk_data_blk(sbi,IS_CASEFOLDED(&amp;node_blk-&gt;i),blkaddr,...)<br># æ­¤data blockä¸ºdentry blockï¼Œå¤„ç†ç›®å½•é¡¹: __chk_dentries<br># å»ºç«‹ç›®å½•æ ‘ï¼Œå¼€å§‹æ ¡éªŒå­æ–‡ä»¶ã€é€æ­¥é€’å½’ï¼Œæ£€éªŒæ‰€æœ‰ã€‘: fsck_chk_node_blk(sbi,<span class="hljs-literal">NULL</span>, le32_to_cpu(dentry[i].ino), ftype, TYPE_INODE,...)<br></code></pre></td></tr></table></figure><p>æ ¡éªŒåˆ°ä¸€ä¸ªnodeå—æŸåçš„å—æœ‰ä»¥ä¸‹ç°è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sanity_check_nid</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, u32 nid,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_node *node_blk,</span><br><span class="hljs-params"><span class="hljs-keyword">enum</span> FILE_TYPE ftype, <span class="hljs-keyword">enum</span> NODE_TYPE ntype,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> node_info *ni)</span><br>&#123;<br>    <br>    get_node_info(sbi, nid, ni);<br>    ret = dev_read_block(node_blk, ni-&gt;blk_addr);<br>    <br>    <span class="hljs-comment">// é—®é¢˜å‡ºåœ¨è¿™é‡Œ</span><br>    <span class="hljs-keyword">if</span> (le32_to_cpu(node_blk-&gt;footer.nid) != nid) &#123;<br>ASSERT_MSG(<span class="hljs-string">&quot;nid[0x%x] blk_addr[0x%x] footer.nid[0x%x]&quot;</span>,<br>nid, ni-&gt;blk_addr,<br>le32_to_cpu(node_blk-&gt;footer.nid));<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/image-20231228233647975.png" alt="image-20231228233647975" style="zoom:67%;"><p>å¯ä»¥çœ‹åˆ°æ­¤å¤„æŠŠä½å›¾æ¸…ç†äº†ã€‚</p><p>ä¸‹æ¬¡ç´¢å¼•çš„æ—¶å€™å°±ä¸ä¼šå†æ£€æŸ¥äº†</p><img src="/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/image-20231228235700614.png" alt="image-20231228235700614" style="zoom:67%;"><hr><p>ä¸€ä¸ªdentry blockå¯ä»¥è®°å½•214ä¸ªdentryå’Œæ–‡ä»¶åï¼Œæˆå‘˜åŒ…æ‹¬ï¼šä¸€ä¸ªä½å›¾ã€é¢„ç•™ç©ºé—´ã€dentries éƒ¨åˆ† å’Œ æ–‡ä»¶åéƒ¨åˆ†ï¼Œå…±4KBã€‚<br>Dentry Block(4 K) &#x3D; bitmap (27 bytes) + reserved (3 bytes) + dentries(11 * 214 bytes) + file name (8 * 214 bytes)<br>å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2023/12/28/f2fs-fsck%E7%AE%80%E8%AE%B0/image-20231228235527206.png" alt="image-20231228235527206" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Androidåº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æï¼‰</title>
    <link href="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/"/>
    <url>/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Androidåº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æï¼‰"><a href="#Androidåº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æï¼‰" class="headerlink" title="Androidåº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æï¼‰"></a>Androidåº”ç”¨å¯åŠ¨å…¨æµç¨‹åˆ†æï¼ˆæºç æ·±åº¦å‰–æï¼‰</h1><blockquote><p>ä½œè€…ï¼šåŠªæ¯”äºšæŠ€æœ¯å›¢é˜Ÿ<br>æºç æ¥æºï¼šåŠªæ¯”äºšæŠ€æœ¯å›¢é˜Ÿ</p></blockquote><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h2><p>ä»ç”¨æˆ·æ‰‹æŒ‡ç‚¹å‡»æ¡Œé¢ä¸Šçš„åº”ç”¨å›¾æ ‡åˆ°å±å¹•ä¸Šæ˜¾ç¤ºå‡ºåº”ç”¨ä¸»Activityç•Œé¢è€Œå®Œæˆåº”ç”¨å¯åŠ¨ï¼Œå¿«çš„è¯å¾€å¾€éƒ½ä¸éœ€è¦ä¸€ç§’é’Ÿï¼Œä½†æ˜¯è¿™æ•´ä¸ªè¿‡ç¨‹å´æ˜¯ååˆ†å¤æ‚çš„ï¼Œå…¶ä¸­æ¶‰åŠäº†Androidç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚åŒæ—¶åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ä¹Ÿç»å¯¹æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç”¨æˆ·ä½“éªŒæŒ‡æ ‡ä¹‹ä¸€ï¼Œå¤šå°‘å¹´æ¥ï¼Œæ— è®ºæ˜¯è°·æ­Œæˆ–æ˜¯æ‰‹æœºç³»ç»Ÿå‚å•†ä»¬è¿˜æ˜¯å„ä¸ªAndroidåº”ç”¨å¼€å‘è€…ï¼Œéƒ½åœ¨ä¸ºå®ç°åº”ç”¨æ‰“å¼€é€Ÿåº¦æ›´å¿«ä¸€ç‚¹çš„ç›®æ ‡è€Œä¸æ–­åŠªåŠ›ã€‚ä½†æ˜¯è¦æƒ³çœŸæ­£åšå¥½åº”ç”¨å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–è¿™ä»¶äº‹æƒ…ï¼Œæˆ‘æƒ³æ˜¯å¿…é¡»è¦å¯¹åº”ç”¨å¯åŠ¨çš„æ•´ä¸ªæµç¨‹æœ‰å……åˆ†çš„è®¤è¯†å’Œç†è§£çš„ï¼Œæ‰€ä»¥æ— è®ºä½œä¸ºAndroidç³»ç»Ÿæˆ–åº”ç”¨å¼€å‘è€…ï¼Œéƒ½æœ‰å¿…è¦å¥½å¥½çš„å­¦ä¹ å’Œäº†è§£ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹çš„ã€‚ç½‘ä¸Šæœ‰å¾ˆå¤šä»‹ç»åº”ç”¨å¯åŠ¨æµç¨‹æºç çš„æ–‡ç« ï¼Œä½†æ˜¯æ€»æ„Ÿè§‰å¤§å¤šæ•°éƒ½ä¸å¤ªå…¨é¢ï¼Œå¾ˆå¤šåªæ˜¯ä»‹ç»äº†åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†æµç¨‹ï¼Œè€Œæ²¡æœ‰æ€»ä½“æ¸…æ™°çš„è®¤è¯†åº”ç”¨å¯åŠ¨è¿‡ç¨‹çš„æ€»ä½“è„‰ç»œä¸ç³»ç»Ÿæ¶æ„è®¾è®¡æ€æƒ³ã€‚æ‰€ä»¥æœ¬æ–‡å°†ç»“åˆç¬”è€…å¤šå¹´æ¥çš„å·¥ä½œç»å†ï¼Œç»“åˆsystraceåˆ†æå·¥å…·ï¼ŒåŸºäºAndroid R AOSPæºç å®Œæ•´çš„åˆ†æä¸€ä¸‹è¿™ä¸ªä»ç”¨æˆ·æ‰‹æŒ‡è§¦æ§ç‚¹å‡»å±å¹•åº”ç”¨å›¾æ ‡åˆ°åº”ç”¨ç•Œé¢å±•ç¤ºåˆ°å±å¹•ä¸Šçš„æ•´ä¸ªåº”ç”¨å¯åŠ¨è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯å¯¹ä¹‹å‰æ‰€åšæ‰€å­¦çš„ä¸€ä¸ªæ€»ç»“ä¸å½’çº³ã€‚</p><h2 id="2-å¤§çº²"><a href="#2-å¤§çº²" class="headerlink" title="2.å¤§çº²"></a>2.å¤§çº²</h2><ul><li><strong>Androidè§¦æ§äº‹ä»¶å¤„ç†æœºåˆ¶</strong></li><li><strong>Zygoteè¿›ç¨‹å¯åŠ¨å’Œåº”ç”¨è¿›ç¨‹åˆ›å»ºæµç¨‹</strong></li><li><strong>Handleræ¶ˆæ¯æœºåˆ¶</strong></li><li><strong>AMSçš„Activityç»„ä»¶ç®¡ç†</strong></li><li><strong>åº”ç”¨Applicationå’ŒActivityç»„ä»¶åˆ›å»ºä¸åˆå§‹åŒ–</strong></li><li><strong>åº”ç”¨UIå¸ƒå±€ä¸ç»˜åˆ¶</strong></li><li><strong>RenderThreadæ¸²æŸ“</strong></li><li><strong>SurfaceFlingeråˆæˆæ˜¾ç¤º</strong></li><li><strong>å†™åœ¨æœ€å</strong></li><li><strong>å‚è€ƒ</strong></li></ul><h2 id="3-Inputè§¦æ§äº‹ä»¶å¤„ç†æµç¨‹"><a href="#3-Inputè§¦æ§äº‹ä»¶å¤„ç†æµç¨‹" class="headerlink" title="3.Inputè§¦æ§äº‹ä»¶å¤„ç†æµç¨‹"></a>3.Inputè§¦æ§äº‹ä»¶å¤„ç†æµç¨‹</h2><h2 id="4-åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨"><a href="#4-åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨" class="headerlink" title="4.åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨"></a>4.åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨</h2><h3 id="4-1-Pauseæ¡Œé¢åº”ç”¨"><a href="#4-1-Pauseæ¡Œé¢åº”ç”¨" class="headerlink" title="4.1 Pauseæ¡Œé¢åº”ç”¨"></a>4.1 Pauseæ¡Œé¢åº”ç”¨</h3><p>æ¥ç€ä¸Šä¸€èŠ‚ç»§ç»­å¾€ä¸‹çœ‹ï¼Œæ¡Œé¢è¿›ç¨‹æ”¶åˆ°inputè§¦æ§äº‹ä»¶å¹¶å¤„ç†å<code>binder</code>è°ƒç”¨æ¡†æ¶<code>AMS</code>çš„çš„<code>startActivity</code>æ¥å£å¯åŠ¨åº”ç”¨ï¼Œç›¸å…³ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityUnchecked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="hljs-params">                                   IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span> startFlags, <span class="hljs-type">boolean</span> doResume, ActivityOptions options, Task inTask,</span><br><span class="hljs-params">                                   <span class="hljs-type">boolean</span> restrictedBgActivity, NeededUriGrants intentGrants)</span> &#123;<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        ...<br>        <span class="hljs-comment">// æ·»åŠ â€œstartActivityInnerâ€çš„systrace tag</span><br>        Trace.traceBegin(Trace.TRACE_TAG_WINDOW_MANAGER, <span class="hljs-string">&quot;startActivityInner&quot;</span>);<br>        <span class="hljs-comment">// æ‰§è¡ŒstartActivityInnerå¯åŠ¨åº”ç”¨çš„é€»è¾‘</span><br>        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,<br>                                    startFlags, doResume, options, inTask, restrictedBgActivity, intentGrants);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        Trace.traceEnd(Trace.TRACE_TAG_WINDOW_MANAGER);<br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œ<code>startActivityInner</code>å¯åŠ¨åº”ç”¨é€»è¾‘ä¸­ï¼Œ<code>AMS</code>ä¸­çš„<code>Activity</code>æ ˆç®¡ç†çš„é€»è¾‘ï¼Œ<strong>æ£€æŸ¥å‘ç°å½“å‰å¤„äºå‰å°<code>Resume</code>çŠ¶æ€çš„<code>Activity</code>æ˜¯æ¡Œé¢åº”ç”¨ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥éœ€è¦é€šçŸ¥æ¡Œé¢åº”ç”¨çš„<code>Activity</code>è¿›å…¥<code>Paused</code>çŠ¶æ€</strong>ï¼Œç›¸å…³ç®€åŒ–ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/services/core/java/com/android/server/wm/ActivityStack.java*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">resumeTopActivityInnerLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> &#123;<br>   ...<br>   <span class="hljs-comment">// mResumedActivityä¸ä¸ºnullï¼Œè¯´æ˜å½“å‰å­˜åœ¨å¤„äºresumeçŠ¶æ€çš„Activityä¸”ä¸æ˜¯æ–°éœ€è¦å¯åŠ¨çš„åº”ç”¨</span><br>   <span class="hljs-keyword">if</span> (mResumedActivity != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// æ‰§è¡ŒstartPausingLockedé€šçŸ¥æ¡Œé¢åº”ç”¨è¿›å…¥pausedçŠ¶æ€</span><br>      pausing |= startPausingLocked(userLeaving, <span class="hljs-literal">false</span> <span class="hljs-comment">/* uiSleeping */</span>, next);<br>   &#125;<br>   ...<br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startPausingLocked</span><span class="hljs-params">(<span class="hljs-type">boolean</span> userLeaving, <span class="hljs-type">boolean</span> uiSleeping,</span><br><span class="hljs-params">            ActivityRecord resuming)</span> &#123;<br>    ...<br>    <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> mResumedActivity;<br>    ...<br>    <span class="hljs-keyword">if</span> (prev.attachedToProcess()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>             ...<br>             <span class="hljs-comment">// ç›¸å…³æ‰§è¡ŒåŠ¨ä½œå°è£…äº‹åŠ¡ï¼Œbinderé€šçŸ¥mResumedActivityä¹Ÿå°±æ˜¯æ¡Œé¢æ‰§è¡ŒpauseåŠ¨ä½œ</span><br>             mAtmService.getLifecycleManager().scheduleTransaction(prev.app.getThread(),<br>                        prev.appToken, PauseActivityItem.obtain(prev.finishing, userLeaving,<br>                        prev.configChangeFlags, pauseImmediately));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           ...<br>        &#125;<br>     &#125;<br>     ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¡Œé¢åº”ç”¨è¿›ç¨‹è¿™è¾¹æ‰§è¡Œæ”¶åˆ°<code>pause</code>æ¶ˆæ¯åæ‰§è¡Œ<code>Activity</code>çš„<code>onPause</code>ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæˆåï¼Œä¼š<code>binder</code>è°ƒç”¨<code>AMS</code>çš„<code>activityPaused</code>æ¥å£é€šçŸ¥ç³»ç»Ÿæ‰§è¡Œå®Œ<code>activity</code>çš„<code>pause</code>åŠ¨ä½œï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postExecute</span><span class="hljs-params">(ClientTransactionHandler client, IBinder token,</span><br><span class="hljs-params">                        PendingTransactionActions pendingActions)</span> &#123;<br>    ...<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// binderé€šçŸ¥AMSå½“å‰åº”ç”¨activityå·²ç»æ‰§è¡Œå®Œpauseçš„æµç¨‹</span><br>        ActivityTaskManager.getService().activityPaused(token);<br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>        <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>AMS</code>è¿™è¾¹æ”¶åˆ°åº”ç”¨çš„<code>activityPaused</code>è°ƒç”¨åï¼Œç»§ç»­æ‰§è¡Œå¯åŠ¨åº”ç”¨çš„é€»è¾‘ï¼Œ<strong>åˆ¤æ–­éœ€è¦å¯åŠ¨çš„åº”ç”¨<code>Activity</code>æ‰€åœ¨çš„è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦å…ˆ<code>startProcessAsync</code>åˆ›å»ºåº”ç”¨è¿›ç¨‹</strong>ï¼Œç›¸å…³ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/services/core/java/com/android/server/wm/ActivityStackSupervisor.java*/</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSpecificActivity</span><span class="hljs-params">(ActivityRecord r, <span class="hljs-type">boolean</span> andResume, <span class="hljs-type">boolean</span> checkConfig)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowProcessController</span> <span class="hljs-variable">wpc</span> <span class="hljs-operator">=</span><br>                mService.getProcessController(r.processName, r.info.applicationInfo.uid);<br>     ...<br>     <span class="hljs-comment">// 1.å¦‚æœwpcä¸ä¸ºnullä¸”hasThreadè¡¨ç¤ºåº”ç”¨Activityæ‰€å±è¿›ç¨‹å­˜åœ¨ï¼Œç›´æ¥realStartActivityLockedå¯åŠ¨Activity</span><br>     <span class="hljs-keyword">if</span> (wpc != <span class="hljs-literal">null</span> &amp;&amp; wpc.hasThread()) &#123;<br>         <span class="hljs-keyword">try</span> &#123;<br>             realStartActivityLocked(r, wpc, andResume, checkConfig);<br>             <span class="hljs-keyword">return</span>;<br>         &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>             Slog.w(TAG, <span class="hljs-string">&quot;Exception when starting activity &quot;</span><br>                    + r.intent.getComponent().flattenToShortString(), e);<br>         &#125;<br>         ...<br>     &#125;<br>     ...<br>     <span class="hljs-comment">// 2.å¦åˆ™ï¼Œè°ƒç”¨AMSçš„startProcessAsyncæ­£å¼å¼€å§‹åˆ›å»ºåº”ç”¨è¿›ç¨‹ </span><br>     mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? <span class="hljs-string">&quot;top-activity&quot;</span> : <span class="hljs-string">&quot;activity&quot;</span>);<br> &#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿‡ç¨‹ä»systraceä¸Šçœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><ol><li>é€šçŸ¥pauseæ¡Œé¢åº”ç”¨</li></ol><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/9d1d580904014f5094bacd9c18b1fe81.webp" alt="img" style="zoom:80%;"><ol start="2"><li>ç¡®è®¤æ¡Œé¢<code>activityPaused</code>çŠ¶æ€ä¹‹åï¼Œå¼€å§‹åˆ›å»ºåº”ç”¨è¿›ç¨‹ï¼š</li></ol><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/da7a06facb0a4155b795d8c1464ed71d.webp" alt="img" style="zoom:80%;"><h3 id="4-2-åˆ›å»ºåº”ç”¨è¿›ç¨‹"><a href="#4-2-åˆ›å»ºåº”ç”¨è¿›ç¨‹" class="headerlink" title="4.2 åˆ›å»ºåº”ç”¨è¿›ç¨‹"></a>4.2 åˆ›å»ºåº”ç”¨è¿›ç¨‹</h3><p>æ¥ä¸Šä¸€å°èŠ‚çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒAndroidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨æ˜¯è¢«åŠ¨å¼çš„ï¼Œåœ¨æ¡Œé¢ç‚¹å‡»å›¾æ ‡å¯åŠ¨ä¸€ä¸ªåº”ç”¨çš„ç»„ä»¶å¦‚Activityæ—¶ï¼Œå¦‚æœActivityæ‰€åœ¨çš„è¿›ç¨‹ä¸å­˜åœ¨ï¼Œå°±ä¼šåˆ›å»ºå¹¶å¯åŠ¨è¿›ç¨‹ã€‚<strong>Androidç³»ç»Ÿä¸­ä¸€èˆ¬åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºéƒ½æ˜¯ç»Ÿä¸€ç”±zygoteè¿›ç¨‹forkåˆ›å»ºçš„ï¼ŒAMSåœ¨éœ€è¦åˆ›å»ºåº”ç”¨è¿›ç¨‹æ—¶ï¼Œä¼šé€šè¿‡socketè¿æ¥å¹¶é€šçŸ¥åˆ°åˆ°zygoteè¿›ç¨‹åœ¨å¼€æœºé˜¶æ®µå°±åˆ›å»ºå¥½çš„socketæœåŠ¡ç«¯ï¼Œç„¶åç”±zygoteè¿›ç¨‹forkåˆ›å»ºå‡ºåº”ç”¨è¿›ç¨‹ã€‚</strong>æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/3067c5b0d9284ef7b41f32c758ec3a24.webp" alt="img" style="zoom:80%;"><p>æˆ‘ä»¬æ¥ç€ä¸ŠèŠ‚ä¸­çš„åˆ†æï¼Œç»§ç»­ä»<code>AMS#startProcessAsync</code>åˆ›å»ºè¿›ç¨‹å‡½æ•°å…¥æ‰‹ï¼Œç»§ç»­çœ‹ä¸€ä¸‹åº”ç”¨è¿›ç¨‹åˆ›å»ºç›¸å…³ç®€åŒ–æµç¨‹ä»£ç ï¼š</p><h4 id="4-2-1-AMS-å‘é€socketè¯·æ±‚"><a href="#4-2-1-AMS-å‘é€socketè¯·æ±‚" class="headerlink" title="4.2.1 AMS å‘é€socketè¯·æ±‚"></a>4.2.1 AMS å‘é€socketè¯·æ±‚</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java*/</span>  <br> <span class="hljs-meta">@GuardedBy(&quot;this&quot;)</span><br> <span class="hljs-keyword">final</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(...)</span> &#123;<br>      <span class="hljs-keyword">return</span> mProcessList.startProcessLocked(...);<br> &#125;<br> <br> <span class="hljs-comment">/*frameworks/base/services/core/java/com/android/server/am/ProcessList.java*/</span><br> <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startProcess</span><span class="hljs-params">(HostingRecord hostingRecord, String entryPoint,</span><br><span class="hljs-params">          ProcessRecord app, <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> zygotePolicyFlags,</span><br><span class="hljs-params">          <span class="hljs-type">int</span> mountExternal, String seInfo, String requiredAbi, String instructionSet,</span><br><span class="hljs-params">          String invokeWith, <span class="hljs-type">long</span> startTime)</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// åŸç”Ÿæ ‡è¯†åº”ç”¨è¿›ç¨‹åˆ›å»ºæ‰€åŠ çš„systrace tag</span><br>          Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;Start proc: &quot;</span> +<br>                  app.processName);<br>          ...<br>          <span class="hljs-comment">// è°ƒç”¨Processçš„startæ–¹æ³•åˆ›å»ºè¿›ç¨‹</span><br>          startResult = Process.start(...);<br>          ...<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>      &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">/*frameworks/base/core/java/android/os/Process.java*/</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(...)</span> &#123;<br>      <span class="hljs-comment">// è°ƒç”¨ZygoteProcessçš„startå‡½æ•°</span><br>      <span class="hljs-keyword">return</span> ZYGOTE_PROCESS.start(...);<br>  &#125;<br>  <br>  <span class="hljs-comment">/*frameworks/base/core/java/android/os/ZygoteProcess.java*/</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Process.ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(...)</span>&#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">return</span> startViaZygote(...);<br>      &#125; <span class="hljs-keyword">catch</span> (ZygoteStartFailedEx ex) &#123;<br>         ...<br>      &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startViaZygote</span><span class="hljs-params">(...)</span>&#123;<br>      ArrayList&lt;String&gt; argsForZygote = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>      ...<br>      <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);<br>  &#125;<br></code></pre></td></tr></table></figure><p>åœ¨ZygoteProcess#startViaZygoteä¸­ï¼Œæœ€ååˆ›å»ºåº”ç”¨è¿›ç¨‹çš„é€»è¾‘ï¼š</p><ol><li>openZygoteSocketIfNeededå‡½æ•°ä¸­æ‰“å¼€æœ¬åœ°socketå®¢æˆ·ç«¯è¿æ¥åˆ°zygoteè¿›ç¨‹çš„socketæœåŠ¡ç«¯ï¼›</li><li>zygoteSendArgsAndGetResultå‘é€socketè¯·æ±‚å‚æ•°ï¼Œå¸¦ä¸Šäº†åˆ›å»ºçš„åº”ç”¨è¿›ç¨‹å‚æ•°ä¿¡æ¯ï¼›</li><li>returnè¿”å›çš„æ•°æ®ç»“æ„ProcessStartResultä¸­ä¼šæœ‰æ–°åˆ›å»ºçš„è¿›ç¨‹çš„pidå­—æ®µã€‚</li></ol><p>ä»systraceä¸Šçœ‹è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/831376e8bd384f588e52d31b3907bc41.webp" alt="img" style="zoom:80%;"><h3 id="4-2-2-Zygote-å¤„ç†socketè¯·æ±‚"><a href="#4-2-2-Zygote-å¤„ç†socketè¯·æ±‚" class="headerlink" title="4.2.2 Zygote å¤„ç†socketè¯·æ±‚"></a>4.2.2 Zygote å¤„ç†socketè¯·æ±‚</h3><p>å…¶å®æ—©åœ¨ç³»ç»Ÿå¼€æœºé˜¶æ®µï¼Œ<code>zygote</code>è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œå°±ä¼šåœ¨<code>ZygoteInit#main</code>å…¥å£å‡½æ•°ä¸­åˆ›å»ºæœåŠ¡ç«¯<code>socket</code>ï¼Œ<strong>å¹¶é¢„åŠ è½½ç³»ç»Ÿèµ„æºå’Œæ¡†æ¶ç±»ï¼ˆåŠ é€Ÿåº”ç”¨è¿›ç¨‹å¯åŠ¨é€Ÿåº¦ï¼‰</strong>ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/core/java/com/android/internal/os/ZygoteInit.java*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span> &#123;<br>       <span class="hljs-type">ZygoteServer</span> <span class="hljs-variable">zygoteServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        ...<br>       <span class="hljs-keyword">try</span> &#123;<br>           ...<br>           <span class="hljs-comment">// 1.preloadæå‰åŠ è½½æ¡†æ¶é€šç”¨ç±»å’Œç³»ç»Ÿèµ„æºåˆ°è¿›ç¨‹ï¼ŒåŠ é€Ÿè¿›ç¨‹å¯åŠ¨</span><br>           preload(bootTimingsTraceLog);<br>           ...<br>           <span class="hljs-comment">// 2.åˆ›å»ºzygoteè¿›ç¨‹çš„socket serveræœåŠ¡ç«¯å¯¹è±¡</span><br>           zygoteServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteServer</span>(isPrimaryZygote);<br>           ...<br>           <span class="hljs-comment">// 3.è¿›å…¥æ­»å¾ªç¯ï¼Œç­‰å¾…AMSå‘è¯·æ±‚è¿‡æ¥</span><br>           caller = zygoteServer.runSelectLoop(abiList);<br>       &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>           ...<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           ...<br>       &#125;<br>       ...<br>   &#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­å¾€ä¸‹çœ‹<code>ZygoteServer#runSelectLoop</code>å¦‚ä½•ç›‘å¬å¹¶å¤„ç†AMSå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/core/java/com/android/internal/os/ZygoteServer.java*/</span><br>Runnable <span class="hljs-title function_">runSelectLoop</span><span class="hljs-params">(String abiList)</span> &#123;<br>    <span class="hljs-comment">// è¿›å…¥æ­»å¾ªç¯ç›‘å¬</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>       <span class="hljs-keyword">while</span> (--pollIndex &gt;= <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">if</span> (pollIndex == <span class="hljs-number">0</span>) &#123;<br>            ...<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) &#123;<br>            <span class="hljs-comment">// Session socket accepted from the Zygote server socket</span><br>            <span class="hljs-comment">// å¾—åˆ°ä¸€ä¸ªè¯·æ±‚è¿æ¥å°è£…å¯¹è±¡ZygoteConnection</span><br>            <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> peers.get(pollIndex);<br>            <span class="hljs-comment">// processCommandå‡½æ•°ä¸­å¤„ç†AMSå®¢æˆ·ç«¯è¯·æ±‚</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> connection.processCommand(<span class="hljs-built_in">this</span>, multipleForksOK);<br>          &#125;<br>       &#125;<br>    &#125;<br>&#125;<br><br>Runnable <span class="hljs-title function_">processCommand</span><span class="hljs-params">(ZygoteServer zygoteServer, <span class="hljs-type">boolean</span> multipleOK)</span> &#123;<br>        ...<br>        <span class="hljs-comment">// 1.forkåˆ›å»ºåº”ç”¨å­è¿›ç¨‹</span><br>        pid = Zygote.forkAndSpecialize(...);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>                ...<br>                <span class="hljs-comment">// 2.pidä¸º0ï¼Œå½“å‰å¤„äºæ–°åˆ›å»ºçš„å­åº”ç”¨è¿›ç¨‹ä¸­ï¼Œå¤„ç†è¯·æ±‚å‚æ•°</span><br>                <span class="hljs-keyword">return</span> handleChildProc(parsedArgs, childPipeFd, parsedArgs.mStartChildZygote);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ...<br>                handleParentProc(pid, serverPipeFd);<br>            &#125;<br>         &#125; <span class="hljs-keyword">finally</span> &#123;<br>            ...<br>         &#125;<br>&#125;<br><br> <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">handleChildProc</span><span class="hljs-params">(ZygoteArguments parsedArgs,</span><br><span class="hljs-params">           FileDescriptor pipeFd, <span class="hljs-type">boolean</span> isZygote)</span> &#123;<br>       ...<br>       <span class="hljs-comment">// å…³é—­ä»çˆ¶è¿›ç¨‹zygoteç»§æ‰¿è¿‡æ¥çš„ZygoteServeræœåŠ¡ç«¯åœ°å€</span><br>       closeSocket();<br>       ...<br>       <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) &#123;<br>          ...<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">if</span> (!isZygote) &#123;<br>               <span class="hljs-comment">// ç»§ç»­è¿›å…¥ZygoteInit#zygoteInitç»§ç»­å®Œæˆå­åº”ç”¨è¿›ç¨‹çš„ç›¸å…³åˆå§‹åŒ–å·¥ä½œ</span><br>               <span class="hljs-keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,<br>                       parsedArgs.mDisabledCompatChanges,<br>                       parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               ...<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿‡ç¨‹ä»systraceä¸Šçœ‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/a789b961b94945a2bc1cff228350c927.webp" alt="img" style="zoom:80%;"><h4 id="4-2-3-åº”ç”¨è¿›ç¨‹åˆå§‹åŒ–"><a href="#4-2-3-åº”ç”¨è¿›ç¨‹åˆå§‹åŒ–" class="headerlink" title="4.2.3 åº”ç”¨è¿›ç¨‹åˆå§‹åŒ–"></a>4.2.3 åº”ç”¨è¿›ç¨‹åˆå§‹åŒ–</h4><p>æ¥ä¸Šä¸€èŠ‚ä¸­çš„åˆ†æï¼Œ<code>zygote</code>è¿›ç¨‹ç›‘å¬æ¥æ”¶<code>AMS</code>çš„è¯·æ±‚ï¼Œ<code>fork</code>åˆ›å»ºå­åº”ç”¨è¿›ç¨‹ï¼Œç„¶å<code>pid</code>ä¸º0æ—¶è¿›å…¥å­è¿›ç¨‹ç©ºé—´ï¼Œç„¶ååœ¨ <code>ZygoteInit#zygoteInit</code>ä¸­å®Œæˆè¿›ç¨‹çš„åˆå§‹åŒ–åŠ¨ä½œï¼Œç›¸å…³ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/core/java/com/android/internal/os/ZygoteInit.java*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,</span><br><span class="hljs-params">            String[] argv, ClassLoader classLoader)</span> &#123;<br>        ...<br>        <span class="hljs-comment">// åŸç”Ÿæ·»åŠ åä¸ºâ€œZygoteInit â€çš„systrace tagä»¥æ ‡è¯†è¿›ç¨‹åˆå§‹åŒ–æµç¨‹</span><br>        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ZygoteInit&quot;</span>);<br>        RuntimeInit.redirectLogStreams();<br>        <span class="hljs-comment">// 1.RuntimeInit#commonInitä¸­è®¾ç½®åº”ç”¨è¿›ç¨‹é»˜è®¤çš„javaå¼‚å¸¸å¤„ç†æœºåˆ¶</span><br>        RuntimeInit.commonInit();<br>        <span class="hljs-comment">// 2.ZygoteInit#nativeZygoteInitå‡½æ•°ä¸­JNIè°ƒç”¨å¯åŠ¨è¿›ç¨‹çš„binderçº¿ç¨‹æ± </span><br>        ZygoteInit.nativeZygoteInit();<br>        <span class="hljs-comment">// 3.RuntimeInit#applicationInitä¸­åå°„åˆ›å»ºActivityThreadå¯¹è±¡å¹¶è°ƒç”¨å…¶â€œmainâ€å…¥å£æ–¹æ³•</span><br>        <span class="hljs-keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,<br>                classLoader);<br> &#125;<br></code></pre></td></tr></table></figure><p>åº”ç”¨è¿›ç¨‹å¯åŠ¨åï¼Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸»è¦ä¾æ¬¡å®Œæˆä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p><ol><li>åº”ç”¨è¿›ç¨‹é»˜è®¤çš„javaå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆå¯ä»¥å®ç°ç›‘å¬ã€æ‹¦æˆªåº”ç”¨è¿›ç¨‹æ‰€æœ‰çš„Java crashçš„é€»è¾‘ï¼‰ï¼›</li><li>JNIè°ƒç”¨å¯åŠ¨è¿›ç¨‹çš„binderçº¿ç¨‹æ± ï¼ˆæ³¨æ„åº”ç”¨è¿›ç¨‹çš„binderçº¿ç¨‹æ± èµ„æºæ˜¯è‡ªå·±åˆ›å»ºçš„å¹¶éä»zygoteçˆ¶è¿›ç¨‹ç»§æ‰¿çš„ï¼‰ï¼›</li><li>é€šè¿‡åå°„åˆ›å»ºActivityThreadå¯¹è±¡å¹¶è°ƒç”¨å…¶â€œmainâ€å…¥å£æ–¹æ³•ã€‚</li></ol><p>æˆ‘ä»¬ç»§ç»­çœ‹<code>RuntimeInit#applicationInit</code>ç®€åŒ–çš„ä»£ç æµç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*frameworks/base/core/java/com/android/internal/os/RuntimeInit.java*/</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,</span><br><span class="hljs-params">           String[] argv, ClassLoader classLoader)</span> &#123;<br>       ...<br>       <span class="hljs-comment">// ç»“æŸâ€œZygoteInit â€çš„systrace tag</span><br>       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>       <span class="hljs-comment">// Remaining arguments are passed to the start class&#x27;s static main</span><br>       <span class="hljs-keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);<br> &#125;<br> <br> <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">findStaticMain</span><span class="hljs-params">(String className, String[] argv,</span><br><span class="hljs-params">           ClassLoader classLoader)</span> &#123;<br>       Class&lt;?&gt; cl;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-comment">// 1.åå°„åŠ è½½åˆ›å»ºActivityThreadç±»å¯¹è±¡</span><br>           cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);<br>       &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>           ...<br>       &#125;<br>       Method m;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-comment">// 2.åå°„è°ƒç”¨å…¶mainæ–¹æ³•</span><br>           m = cl.getMethod(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String[].class &#125;);<br>       &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>           ...<br>       &#125; <span class="hljs-keyword">catch</span> (SecurityException ex) &#123;<br>           ...<br>       &#125;<br>       ...<br>       <span class="hljs-comment">// 3.è§¦å‘æ‰§è¡Œä»¥ä¸Šé€»è¾‘</span><br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAndArgsCaller</span>(m, argv);<br>   &#125;<br><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿›ç¨‹<code>ActivityThread#main</code>å‡½æ•°åˆå§‹åŒ–çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š</p><ol><li><strong>åˆ›å»ºå¹¶å¯åŠ¨ä¸»çº¿ç¨‹çš„<code>loop</code>æ¶ˆæ¯å¾ªç¯ï¼›</strong></li><li><strong>é€šè¿‡<code>binder</code>è°ƒç”¨<code>AMS</code>çš„<code>attachApplication</code>æ¥å£å°†è‡ªå·±<code>attach</code>æ³¨å†Œåˆ°<code>AMS</code>ä¸­ã€‚</strong></li></ol><p>ä»¥ä¸Šåˆå§‹åŒ–è¿‡ç¨‹ã€‚ä»systraceä¸Šçœ‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/12/26/Android%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E5%85%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%EF%BC%89/e729f9e2f20d43a8a9e4853ec09e2e76.webp" alt="img" style="zoom:80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–mke2fs</title>
    <link href="/2023/12/25/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%BC%E5%BC%8F%E5%8C%96mke2fs/"/>
    <url>/2023/12/25/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%BC%E5%BC%8F%E5%8C%96mke2fs/</url>
    
    <content type="html"><![CDATA[<h1 id="ext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–mke2fs"><a href="#ext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–mke2fs" class="headerlink" title="ext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–mke2fs"></a>ext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–mke2fs</h1><h2 id="ext2ç£ç›˜å¸ƒå±€"><a href="#ext2ç£ç›˜å¸ƒå±€" class="headerlink" title="ext2ç£ç›˜å¸ƒå±€"></a>ext2ç£ç›˜å¸ƒå±€</h2><img src="/2023/12/25/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%BC%E5%BC%8F%E5%8C%96mke2fs/Center.gif" alt="img" style="zoom: 90%;"><p>æ ¼å¼åŒ–çš„ä»£ç éƒ½æ˜¯å›´ç»•è¿™å¼ å›¾æ¥è¿›è¡Œçš„</p><h2 id="å‚æ•°åˆå§‹åŒ–"><a href="#å‚æ•°åˆå§‹åŒ–" class="headerlink" title="å‚æ•°åˆå§‹åŒ–"></a>å‚æ•°åˆå§‹åŒ–</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">errcode_t</span> <span class="hljs-title function_">ext2fs_initialize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> ext2_super_block *param,</span><br><span class="hljs-params">    io_manager manager, ext2_filsys *ret_fs)</span><br>&#123;<br>    ext2_filsysfs;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ext2_super_block</span> *<span class="hljs-title">super</span>;</span><br>    <br>    retval = ext2fs_get_mem(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> struct_ext2_filsys), &amp;fs);<br>    <span class="hljs-built_in">memset</span>(fs, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> struct_ext2_filsys));<br>fs-&gt;magic = EXT2_ET_MAGIC_EXT2FS_FILSYS;<br>fs-&gt;flags = flags | EXT2_FLAG_RW;<br>fs-&gt;umask = <span class="hljs-number">022</span>;<br>fs-&gt;default_bitmap_type = EXT2FS_BMAP64_RBTREE;<br>    <br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/12/25/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%BC%E5%BC%8F%E5%8C%96mke2fs/image-20231225232019834.png" alt="image-20231225232019834" style="zoom: 67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">handle_bad_blocks</span><span class="hljs-params">(ext2_filsys fs, badblocks_list bb_list)</span><br>&#123;<br>    <span class="hljs-comment">// å—ç»„0çš„è¶…çº§å—å’Œå—ç»„æè¿°ç¬¦å¿…é¡»æ˜¯å¥½å—</span><br>    <span class="hljs-comment">// fs-&gt;super-&gt;s_first_data_blockè¡¨ç¤ºå—ç»„0çš„èµ·å§‹å—</span><br>    <span class="hljs-comment">// fs-&gt;desc_blocksè¡¨ç¤ºå—ç»„æè¿°ç¬¦å ç”¨çš„å—æ•°</span><br>must_be_good = fs-&gt;super-&gt;s_first_data_block + <span class="hljs-number">1</span> + fs-&gt;desc_blocks;<br><span class="hljs-keyword">for</span> (i = fs-&gt;super-&gt;s_first_data_block; i &lt;= must_be_good; i++) &#123;<br>        <span class="hljs-comment">// å½“å‰çš„å—åœ¨åå—ä½å›¾ä¸­æ˜¯å¦ç½®ä½</span><br><span class="hljs-keyword">if</span> (ext2fs_badblocks_list_test(bb_list, i)) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// group_blockä¸ºå—ç»„1çš„èµ·å§‹å—</span><br>group_block = fs-&gt;super-&gt;s_first_data_block + fs-&gt;super-&gt;s_blocks_per_group;<br><br>    <span class="hljs-comment">// ä»å—ç»„1å¼€å§‹ï¼Œæ£€éªŒæ‰€æœ‰å—ç»„çš„è¶…çº§å—å’Œå—ç»„æè¿°ç¬¦</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; fs-&gt;group_desc_count; i++) &#123;<br>group_bad = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; j &lt; fs-&gt;desc_blocks+<span class="hljs-number">1</span>; j++) &#123;<br><span class="hljs-keyword">if</span> (ext2fs_badblocks_list_test(bb_list, group_block + j)) &#123;<br>group_bad++;<br>group = ext2fs_group_of_blk2(fs, group_block+j);<br>ext2fs_bg_free_blocks_count_set(fs, group, ext2fs_bg_free_blocks_count(fs, group) + <span class="hljs-number">1</span>);<br>ext2fs_group_desc_csum_set(fs, group);<br>ext2fs_free_blocks_count_add(fs-&gt;super, <span class="hljs-number">1</span>);<br>&#125;<br>&#125;<br>group_block += fs-&gt;super-&gt;s_blocks_per_group;<br>&#125;<br><br>retval = ext2fs_badblocks_list_iterate_begin(bb_list, &amp;bb_iter);<br><br>    <span class="hljs-comment">// å°†æ‰€æœ‰çš„åå—æ ‡è®°ä¸ºå·²ä½¿ç”¨</span><br><span class="hljs-keyword">while</span> (ext2fs_badblocks_list_iterate(bb_iter, &amp;blk))<br>ext2fs_mark_block_bitmap2(fs-&gt;block_map, EXT2FS_B2C(fs, blk));<br>ext2fs_badblocks_list_iterate_end(bb_iter);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åå—ä½å›¾ä¸­äºŒåˆ†æŸ¥æ‰¾"><a href="#åå—ä½å›¾ä¸­äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="åå—ä½å›¾ä¸­äºŒåˆ†æŸ¥æ‰¾"></a>åå—ä½å›¾ä¸­äºŒåˆ†æŸ¥æ‰¾</h2><p>åœ¨mke2fsæºç é‡Œé¢è°ƒç”¨äº†libe2fs.soä¸­æä¾›çš„ä½å›¾æŸ¥è¯¢æ¥å£ï¼š<code>ext2fs_badblocks_list_test</code></p><p>ext2fs_u32_list_findç»“æ„ä½“ä¸­çš„å˜é‡listå­˜æ”¾äº†æ‰€æœ‰åå—çš„ç´¢å¼•ï¼Œä¾‹å¦‚ç°åœ¨åå—çš„ä½ç½®ä¸º6,76,289,409ã€‚é‚£ä¹ˆbb-&gt;listå³ä¸º[6,76,289,409]ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">ext2fs_badblocks_list_test</span><span class="hljs-params">(ext2_badblocks_list bb, <span class="hljs-type">blk_t</span> blk)</span><br>&#123;<br><span class="hljs-keyword">return</span> ext2fs_u32_list_test((ext2_u32_list) bb, (__u32) blk);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ext2fs_u32_list_test</span><span class="hljs-params">(ext2_u32_list bb, __u32 blk)</span><br>&#123;<br><span class="hljs-keyword">if</span> (ext2fs_u32_list_find(bb, blk) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">ext2fs_u32_list_find</span><span class="hljs-params">(ext2_u32_list bb, __u32 blk)</span><br>&#123;<br><span class="hljs-type">int</span>low, high, mid;<br><br><span class="hljs-keyword">if</span> (bb-&gt;magic != EXT2_ET_MAGIC_BADBLOCKS_LIST)<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-keyword">if</span> (bb-&gt;num == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>low = <span class="hljs-number">0</span>;<br>high = bb-&gt;num<span class="hljs-number">-1</span>;<br><span class="hljs-keyword">if</span> (blk == bb-&gt;<span class="hljs-built_in">list</span>[low])<br><span class="hljs-keyword">return</span> low;<br><span class="hljs-keyword">if</span> (blk == bb-&gt;<span class="hljs-built_in">list</span>[high])<br><span class="hljs-keyword">return</span> high;<br><br><span class="hljs-keyword">while</span> (low &lt; high) &#123;<br>mid = ((<span class="hljs-type">unsigned</span>)low + (<span class="hljs-type">unsigned</span>)high)/<span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (mid == low || mid == high)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (blk == bb-&gt;<span class="hljs-built_in">list</span>[mid])<br><span class="hljs-keyword">return</span> mid;<br><span class="hljs-keyword">if</span> (blk &lt; bb-&gt;<span class="hljs-built_in">list</span>[mid])<br>high = mid;<br><span class="hljs-keyword">else</span><br>low = mid;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å…¸å‹çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œåœ¨åå—åˆ—è¡¨ä¸­æŸ¥æ‰¾ç›®æ ‡å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è¿”å›åˆ—è¡¨ç´¢å¼•ï¼Œå¤±è´¥è¿”å›-1ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>yaffsæ–‡ä»¶ç³»ç»Ÿåå—å¤„ç†ç®€è®°</title>
    <link href="/2023/12/20/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%9D%8F%E5%9D%97%E5%A4%84%E7%90%86%E7%AE%80%E8%AE%B0/"/>
    <url>/2023/12/20/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%9D%8F%E5%9D%97%E5%A4%84%E7%90%86%E7%AE%80%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="yaffsæ–‡ä»¶ç³»ç»Ÿåå—å¤„ç†ç®€è®°"><a href="#yaffsæ–‡ä»¶ç³»ç»Ÿåå—å¤„ç†ç®€è®°" class="headerlink" title="yaffsæ–‡ä»¶ç³»ç»Ÿåå—å¤„ç†ç®€è®°"></a>yaffsæ–‡ä»¶ç³»ç»Ÿåå—å¤„ç†ç®€è®°</h1><p>å…ˆçœ‹ä¸‹<strong>æ—å­é›¨è€å¸ˆã€Šé—ªå­˜æ•°æ®åº“æ¦‚å¿µä¸æŠ€æœ¯ã€‹</strong>ä¸­çš„æè¿°ï¼š</p><p>NAND é—ªå­˜è¢«è®¾è®¡æˆå…·æœ‰å¾ˆä½çš„ä»£ä»·å’Œå¾ˆé«˜çš„å¯†åº¦ã€‚ä¸ºäº†è·å¾—æ›´é«˜çš„äº§å‡ºï¼Œä»è€Œå‡å°äº§å“æˆæœ¬ï¼ŒNAND é—ªå­˜é€šå¸¸éƒ½ä¼šåœ¨å‡ºå‚æ—¶åŒ…å«ä¸€äº›åå—ï¼Œæ­¤å¤–ï¼Œåœ¨é—ªå­˜è®¾å¤‡ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šå‡ºç°ä¸€äº›æ–°çš„åå—ã€‚å› æ­¤ï¼Œå¯¹äºä»»ä½•é—ªå­˜æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œå¦‚æœä¸å…·å¤‡åå—å¤„ç†æœºåˆ¶ï¼Œå°±ä¸é€‚åˆç”¨æ¥ç®¡ç†é—ªå­˜ã€‚</p><p>Yaffs1 ä½¿ç”¨ SM å¡ç±»å‹çš„åå—æ ‡è®°ï¼Œå®ƒä¼šæ£€æŸ¥é—ªå­˜é¡µçš„å¸¦å¤–åŒºåŸŸçš„ç¬¬6 ä¸ªå­—èŠ‚ï¼ˆå­—èŠ‚ 5ï¼‰ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¥½å—ï¼Œè¿™ä¸ªå­—èŠ‚åº”è¯¥æ˜¯ 0XFFï¼Œå¦‚æœä¸€ä¸ªå—åœ¨å‡ºå‚æ—¶å·²ç»è¢«æ ‡è®°ä¸ºåå—ï¼Œè¿™ä¸ªå­—èŠ‚åº”è¯¥æ˜¯ 0X00ã€‚å½“é—ªå­˜è®¾å¤‡åœ¨åç»­ä½¿ç”¨è¿‡ç¨‹ä¸­å‡ºç°åå—æ—¶ï¼ŒYaffs1 ä¼šä½¿ç”¨è‡ªå·±çš„æ–¹å¼å¯¹åå—è¿›è¡Œæ ‡è®°ï¼Œä»è€Œå’Œå·¥å‚æ ‡è®°çš„åå—åŠ ä»¥åŒºåˆ†ã€‚å½“è¯»æˆ–å†™æ“ä½œå¤±è´¥çš„æ—¶å€™ï¼Œæˆ–è€…å½“ä¸‰ä¸ª ECCé”™è¯¯è¢«æ¢æµ‹åˆ°çš„æ—¶å€™ï¼ŒYaffs å°±ä¼šæŠŠä¸€ä¸ªå—æ ‡è®°ä¸ºâ€•åå—â€–ã€‚ECC å¯ä»¥é€šè¿‡ç¡¬ä»¶å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è½¯ä»¶é©±åŠ¨å®ç°ï¼Œæˆ–è€…åœ¨ Yaffs è‡ªèº«å†…éƒ¨å®ç°ã€‚éœ€è¦å†æ¬¡å¼ºè°ƒçš„æ˜¯ï¼Œä»»ä½•ç¼ºä¹æœ‰æ•ˆ ECCå¤„ç†æœºåˆ¶çš„é—ªå­˜æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯ä¸é€‚åˆä½œä¸ºé—ªå­˜ç®¡ç†çš„ã€‚å¦‚æœ Yaffs1 ç¡®å®šä¸€ä¸ªå—æ˜¯åå—ï¼Œå®ƒå°±ä¼šæŠŠè¯¥å—æ ‡è®°ä¸º 0X59ï¼ˆâ€™Yâ€™ï¼‰ã€‚ä¸€ä¸ªå—è¢«æ ‡è®°ä¸ºåå—ä»¥åï¼Œå°±ä¼šé€€å‡ºä½¿ç”¨ï¼Œä»è€Œæ”¹è¿›äº†æ–‡ä»¶ç³»ç»Ÿçš„é²æ£’æ€§ã€‚</p><p>Yaffs2 æ¨¡å¼è¢«è®¾è®¡æˆæ”¯æŒæ›´å¤§èŒƒå›´çš„è®¾å¤‡å’Œå¸¦å¤–åŒºåŸŸå¸ƒå±€ã€‚å› æ­¤ï¼ŒYaffs2 æ²¡æœ‰ç¡®å®šå¸¦å¤–åŒºåŸŸçš„å“ªä¸ªå­—èŠ‚ä½œä¸ºæ ‡è®°ä½ï¼Œè€Œæ˜¯è°ƒç”¨é©±åŠ¨å‡½æ•°æ¥ç¡®å®šä¸€ä¸ªå—æ˜¯å¦æ˜¯åå—ä»¥åŠæ ‡è®°å®ƒä¸ºåå—ã€‚Yaffs2 æ²¡æœ‰æä¾›å†…ç½®çš„ ECCï¼Œè€Œæ˜¯éœ€è¦ç”±é©±åŠ¨ç¨‹åºæä¾› ECC</p><hr><p>åœ¨yaffsæ–‡ä»¶ç³»ç»Ÿä¸­æ ‡è®°åå—å¹¶ä¸”é€€å‡ºä½¿ç”¨çš„å‡½æ•°è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">yaffs_block_became_dirty<br>    yaffs_retire_block<br>    yaffs_mark_bad<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>yaffsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</title>
    <link href="/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/"/>
    <url>/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="yaffsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"><a href="#yaffsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€" class="headerlink" title="yaffsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"></a>yaffsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</h1><h2 id="nand-flashç»“æ„"><a href="#nand-flashç»“æ„" class="headerlink" title="nand flashç»“æ„"></a>nand flashç»“æ„</h2><img src="/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/Center.png" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°" style="zoom:75%;"><p>nand flashçš„å­˜å‚¨ç»“æ„ä¸ºï¼šä¸€ä¸ªflashç”±è®¸å¤šä¸ªblockç»„æˆï¼Œä¸€ä¸ªblockåˆæ˜¯æœ‰è®¸å¤šä¸ªpageç»„æˆï¼Œä¸€ä¸ªpageåˆæ˜¯ç”±æœ‰æ•ˆçš„æ•°æ®åŒºå’Œspare areaåŒºï¼ˆå³oobåŒºï¼‰ã€‚ </p><p>å¦‚ä¸Šå›¾flashæœ‰1024ä¸ªblockï¼Œä¸€ä¸ªblockæœ‰64ä¸ªpageï¼Œä¸€ä¸ªpageæœ‰2Kbytesçš„æœ‰æ•ˆæ•°æ®+64bytesçš„oobæ•°æ®ã€‚<br>æˆ‘ä»¬é€šå¸¸è®¡ç®—nand flashå®¹é‡å¤§å°ä¸ºï¼šæ€»å…±çš„blockæ•° * ä¸€ä¸ªblockä¸­çš„pageæ•° * ä¸€ä¸ªpageä¸­çš„æœ‰æ•ˆæ•°æ®åŒºã€‚oobåŒºä¸ºç‰¹æ®Šæ•°æ®ï¼Œç”¨ä½œç¡¬ä»¶çº é”™å’Œåå—ç®¡ç†çš„ã€‚</p><blockquote><p>è¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/davion_zhang/article/details/79013293?spm=1001.2014.3001.5506">https://blog.csdn.net/davion_zhang/article/details/79013293?spm=1001.2014.3001.5506</a></p></blockquote><h2 id="ä»€ä¹ˆæ˜¯chunk"><a href="#ä»€ä¹ˆæ˜¯chunk" class="headerlink" title="ä»€ä¹ˆæ˜¯chunk"></a>ä»€ä¹ˆæ˜¯chunk</h2><p>chunkåœ¨è‹±æ–‡ä¸­çš„è§£é‡Šæ˜¯â€ç»„å—â€ï¼Œå®ƒçš„å¸ƒå±€æ–¹å¼å®Œå…¨æ˜¯æŒ‰ç…§nand flashçš„ç»“æ„æ¥çš„ï¼Œè¿™é‡Œä»¥yaffsæ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹</p><blockquote><p>yaffsæ–‡ä»¶ç³»ç»Ÿæ˜¯é’ˆå¯¹pageä¸­æ•°æ®åŒºä½512Byteè®¾è®¡çš„ï¼Œè€Œyaffs2æ–‡ä»¶ç³»ç»Ÿåˆ™æ˜¯é’ˆå¯¹pageä¸­æ•°æ®åŒºä¸º2048Byteè®¾è®¡çš„ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾ï¼‰</p></blockquote><img src="/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20231218230704748.png" alt="image-20231218230704748" style="zoom:67%;"><blockquote><p>è¦è¯´æ˜çš„æ˜¯ï¼šyaffså¯¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ‰€æœ‰å†…å®¹ï¼ˆæ¯”å¦‚æ­£å¸¸æ–‡ä»¶ï¼Œç›®å½•ï¼Œé“¾æ¥ï¼Œè®¾å¤‡æ–‡ä»¶ç­‰ç­‰ï¼‰éƒ½ç»Ÿä¸€å½“åšæ–‡ä»¶æ¥å¤„ç†ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªé¡µé¢ä¸“é—¨å­˜æ”¾æ–‡ä»¶å¤´ï¼Œæ–‡ä»¶å¤´ä¿å­˜äº†æ–‡ä»¶çš„æ¨¡å¼ï¼Œæ‰€æœ‰è€…IDï¼Œç»„IDï¼Œé•¿åº¦ï¼Œæ–‡ä»¶åï¼ŒParent Object IDç­‰ä¿¡æ¯ã€‚</p></blockquote><p>å› æ­¤ï¼Œyaffsæ–‡ä»¶ç³»ç»Ÿä¸­çš„chunkåˆåˆ†ä¸º<strong>header chunk</strong>å’Œ<strong>data chunk</strong>ï¼Œ</p><ul><li>headerçš„chunk_idä¸º0</li><li>æ¯æ–‡ä»¶çš„chunkéƒ½æœ‰ä¸€ä¸ªchunk_idï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å æ®äº†å¤šä¸ªchunk(page)ï¼Œé‚£ä¹ˆchunk_idä»1å¼€å§‹è®¡æ•°</li></ul><h2 id="chunk-idä¸obj-idçš„åŒºåˆ†"><a href="#chunk-idä¸obj-idçš„åŒºåˆ†" class="headerlink" title="chunk_idä¸obj_idçš„åŒºåˆ†"></a>chunk_idä¸obj_idçš„åŒºåˆ†</h2><p>æ¯ä¸€ä¸ªchunkéƒ½æ˜¯ä¸€ä¸ªobjectï¼Œæ‰€ä»¥éƒ½æœ‰ä¸€ä¸ªobj_idï¼Œæ ¹ç›®å½•header chunkå¯¹åº”çš„chunkå…¶obj_idä¸º1ï¼Œå…¶ä½™çš„æ‰€æœ‰æ–‡ä»¶å¯¹åº”çš„ä¸€ä¸ªä¸ªchunkä»257(<code>YAFFS_NOBJECT_BUCKETS + 1</code>)å¼€å§‹ä¾æ¬¡é€’å¢</p><p>è€Œæ¯ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶éƒ½æ˜¯ç”±<strong>header + data</strong>çš„å½¢å¼æ„æˆï¼Œæ–‡ä»¶çš„å¤´(header chunk)ï¼Œå…¶chunk_idä¸º0ï¼ŒçœŸæ­£çš„æ–‡ä»¶å†…å®¹(data chunk)ï¼Œå…¶chunk_idä»1å¼€å§‹é€’å¢ï¼Œç›´åˆ°æ–‡ä»¶ç»“æŸ</p><h2 id="æ–‡ä»¶å¸ƒå±€"><a href="#æ–‡ä»¶å¸ƒå±€" class="headerlink" title="æ–‡ä»¶å¸ƒå±€"></a>æ–‡ä»¶å¸ƒå±€</h2><p>æ¯ä¸€ä¸ªæ­£å¸¸æ–‡ä»¶çš„å¸ƒå±€éƒ½åº”è¯¥æ˜¯header chunkï¼Œç„¶åæ¥ä¸‹æ¥æ˜¯æ‰€æœ‰æ–‡ä»¶çš„data chunk</p><img src="/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20231218232136406.png" alt="image-20231218232136406" style="zoom:80%;"><p>ä»£ç ä¾æ®æ¥è‡ªäºï¼š<code>yaffs2\utils\mkyaffsimage.c</code></p><img src="/2023/12/18/yaffs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20231218232317681.png" alt="image-20231218232317681" style="zoom: 60%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿç‰¹æ€§æ ‡å¿—ä½</title>
    <link href="/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/"/>
    <url>/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿç‰¹æ€§æ ‡å¿—ä½"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿç‰¹æ€§æ ‡å¿—ä½" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿç‰¹æ€§æ ‡å¿—ä½"></a>f2fsæ–‡ä»¶ç³»ç»Ÿç‰¹æ€§æ ‡å¿—ä½</h1><p>åœ¨f2fsæ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™ä¼šè°ƒç”¨<code>parse_options</code>è§£ææŒ‚è½½é€‰é¡¹ï¼š</p><img src="/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/image-20231218213547571.png" alt="image-20231218213547571" style="zoom:67%;"><p>è¿™é‡Œæœ‰ä¸€äº›æ£€æŸ¥ç‰¹æ€§çš„å‡½æ•°ä¾‹å¦‚ï¼šf2fs_sb_has_quota_inoã€f2fs_sb_has_casefoldç­‰å‡½æ•°æ­»æ´»åœ¨f2fsæºç é‡Œé¢æ‰¾ä¸åˆ°å®ç°ã€‚</p><p>å…¶å®ï¼Œè¿™äº›ç‰¹æ€§å‡½æ•°æ ¡éªŒå‡½æ•°éƒ½æœ‰ä¸€ä¸ªè§„å¾‹ï¼Œéƒ½æ˜¯ä»¥<code>f2fs_sb_has</code>å¼€å¤´ï¼Œå› æ­¤è”æƒ³åˆ°ä¼šä¸æ˜¯æ˜¯å®æ§åˆ¶çš„ã€‚</p><blockquote><p>ç¡®å®æ˜¯è¿™æ ·çš„ï¼Œè¿™è¾¹ç”¨å®å»å®šä¹‰äº†æ‰€æœ‰çš„ç‰¹æ€§æ ¡éªŒå‡½æ•°</p></blockquote><img src="/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/image-20231218220358355.png" alt="image-20231218220358355" style="zoom: 67%;"><p>ä¸Šé¢çš„ä»£ç å¯ä»¥ç¿»è¯‘æˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sb_has_encrypt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> F2FS_HAS_FEATURE(sbi, F2FS_FEATURE_ENCRYPT);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sb_has_blkzoned</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> F2FS_HAS_FEATURE(sbi, F2FS_FEATURE_BLKZONED);<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_sb_has_compression</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> F2FS_HAS_FEATURE(sbi, F2FS_FEATURE_COMPRESSION);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ç»ˆçš„ <strong>f2fs_sb_has</strong> çš„ç‰¹æ€§æ ¡éªŒå‡½æ•°ä¼šè°ƒç”¨åˆ° <strong>F2FS_HAS_FEATURE</strong></p><img src="/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/image-20231218221212511.png" alt="image-20231218221212511" style="zoom:67%;"><p>æœ€ç»ˆä¼šå»super_blockä¸­æ‹¿åˆ°å±æ€§ä½åš<strong>ä¸æ“ä½œ</strong></p><blockquote><p>æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼å»ç¡®å®šæŒ‚è½½f2fsæ–‡ä»¶ç³»ç»Ÿçš„é•œåƒæœ‰å“ªäº›ç‰¹æ€§ï¼š</p><ul><li>hexdump -s 0xc80 -n 1024 xxxï¼›ç¬¬0xC84~0xC87å°±æ˜¯å±æ€§æ ‡å¿—ä½ï¼ŒæŠŠ16è¿›åˆ¶è½¬åŒ–æˆäºŒè¿›åˆ¶ä¸ç‰¹æ€§åšä¸æ“ä½œå°±èƒ½ç¡®å®šæ˜¯å¦å«æœ‰è¯¥ç‰¹æ€§</li><li>è°ƒç”¨fsck.f2fså»è·‘ä¸€éæ ¡éªŒï¼Œä¹Ÿä¼šæ‰“å°æ‰€æœ‰ç‰¹æ€§ï¼Œå¥½å¤„å°±æ˜¯æ¯”è¾ƒæ˜æ˜¾ï¼Œä¸€çœ¼å°±çŸ¥é“æœ‰å“ªäº›ç‰¹æ€§</li></ul><img src="/2023/12/18/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%89%B9%E6%80%A7%E6%A0%87%E5%BF%97%E4%BD%8D/image-20231218223414141.png" alt="image-20231218223414141" style="zoom: 67%;"></blockquote><p>âœ… <strong>ä¸€å¥è¯æ€»ç»“ï¼šç±»ä¼¼äºf2fs_sb_has_casecoldè¿™ç§ç‰¹æ€§æ ¡éªŒå‡½æ•°ï¼Œæœ€ç»ˆéƒ½åªæ˜¯å»çœ‹super_blockä¸­çš„å±æ€§æ ¡éªŒä½featureï¼Œä½äº0xc84~0xc87ï¼›</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>stm32f103é—ªå­˜flashè¯»å†™</title>
    <link href="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/"/>
    <url>/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/</url>
    
    <content type="html"><![CDATA[<h1 id="stm32f103é—ªå­˜flashè¯»å†™"><a href="#stm32f103é—ªå­˜flashè¯»å†™" class="headerlink" title="stm32f103é—ªå­˜flashè¯»å†™"></a>stm32f103é—ªå­˜flashè¯»å†™</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h2><p>é—ªå­˜ï¼ˆFlash Memoryï¼‰æ˜¯ä¸€ç§é•¿å¯¿å‘½çš„éæ˜“å¤±æ€§ï¼ˆåœ¨æ–­ç”µæƒ…å†µä¸‹ä»èƒ½ä¿æŒæ‰€å­˜å‚¨çš„æ•°æ®ä¿¡æ¯ï¼‰çš„å­˜å‚¨å™¨ã€‚ç”¨é€”SDå¡ã€å›ºæ€ç¡¬ç›˜ã€èŠ¯ç‰‡å†…å­˜å­˜å‚¨å•å…ƒå­˜å‚¨ä»£ç ã€‚</p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213222937519.png" alt="image-20231213222937519" style="zoom:67%;"><h2 id="2-STM32å†…éƒ¨Flash"><a href="#2-STM32å†…éƒ¨Flash" class="headerlink" title="2.STM32å†…éƒ¨Flash"></a>2.STM32å†…éƒ¨Flash</h2><p><strong>1.ä¸»è¦ç‰¹æ€§</strong></p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223036882.png" alt="image-20231213223036882" style="zoom:67%;"><p><strong>2.æ“ä½œæŠ€å·§</strong></p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223059908.png" alt="image-20231213223059908" style="zoom:67%;"><p><strong>3.ç¼–ç¨‹&#x2F;æ“¦é™¤ä½æ•°ä¸ç”µå‹ä¹‹é—´çš„å…³ç³»</strong></p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223124094.png" alt="image-20231213223124094" style="zoom:67%;"><h2 id="3-é—ªå­˜è¯»å†™å®éªŒ"><a href="#3-é—ªå­˜è¯»å†™å®éªŒ" class="headerlink" title="3.é—ªå­˜è¯»å†™å®éªŒ"></a>3.é—ªå­˜è¯»å†™å®éªŒ</h2><ol><li>ä»¥åˆ†åŒºå½¢å¼è¿›è¡Œè§„åˆ’ï¼Œé…ç½®æ•°æ®æœ€å¥½ä»æœ€åæ‰‡åŒºè¿›è¡Œæ“ä½œï¼Œé˜²æ­¢è¦†ç›–æ‰‡åŒº0çš„ä»£ç ã€‚</li></ol><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223211555.png" alt="image-20231213223211555" style="zoom:67%;"><ol start="2"><li>F103çš„é—ªå­˜æ˜¯ä»¥é¡µä¸ºå•ä½çš„ã€æ¯ä¸ªé¡µ2Kbã€‘</li></ol><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223303433.png" alt="image-20231213223303433" style="zoom:67%;"><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223321033.png" alt="image-20231213223321033" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stm32f10x.h&quot;</span>                  <span class="hljs-comment">// Device header</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PBout(x) *(volatile uint32_t *)(0x42000000 + ((uint32_t)&amp;GPIOB-&gt;ODR - 0x40000000)*32 + x * 4)</span><br><br><span class="hljs-type">static</span>   GPIO_InitTypeDef    GPIO_InitStructure;<br><span class="hljs-type">static</span>   USART_InitTypeDef   USART_InitStructure;<br><span class="hljs-type">static</span>   NVIC_InitTypeDef    NVIC_InitStructure;<br><br><br><span class="hljs-comment">// 1msçš„ç²’åº¦</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">delay_ms</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> ms)</span><br>&#123;<br>    <span class="hljs-keyword">while</span>(ms --)<br>    &#123;<br>        SysTick-&gt;CTRL = <span class="hljs-number">0</span>;                         <span class="hljs-comment">// å…³é—­ç³»ç»Ÿå®šæ—¶å™¨åæ‰èƒ½é…ç½®å¯„å­˜å™¨</span><br>        SysTick-&gt;LOAD = <span class="hljs-number">72000</span><span class="hljs-number">-1</span>;                   <span class="hljs-comment">// è®¾ç½®è®¡æ•°å€¼ï¼Œç”¨äºè®¾ç½®å®šæ—¶çš„æ—¶é—´</span><br>        SysTick-&gt;VAL = <span class="hljs-number">0</span>;                         <span class="hljs-comment">// æ¸…ç©ºå½“å‰å€¼è¿˜æœ‰è®¡æ•°æ ‡å¿—ä½</span><br>        SysTick-&gt;CTRL = <span class="hljs-number">5</span>;                         <span class="hljs-comment">// ä½¿èƒ½ç³»ç»Ÿå®šæ—¶å™¨å·¥ä½œ</span><br>        <span class="hljs-keyword">while</span> ((SysTick-&gt;CTRL &amp; (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">16</span>))==<span class="hljs-number">0</span>);      <span class="hljs-comment">// ç­‰å¾…ç³»ç»Ÿå®šæ—¶å™¨è®¡æ•°å®Œæ¯• </span><br>    &#125;<br>    SysTick-&gt;CTRL = <span class="hljs-number">0</span>;                         <span class="hljs-comment">// å…³é—­ç³»ç»Ÿå®šæ—¶å™¨       </span><br>&#125;   <br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usart1_init</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> baud)</span><br>&#123;<br>    <span class="hljs-comment">// æ‰“å¼€PAç¡¬ä»¶æ—¶é’Ÿ</span><br>    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_AFIO, ENABLE);<br>    <br>    <span class="hljs-comment">// æ‰“å¼€ä¸²å£1ç¡¬ä»¶æ—¶é’Ÿ</span><br>    RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE);<br>    <br>    <span class="hljs-comment">//USART1_TX GPIOA_9</span><br>    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;     <span class="hljs-comment">// è¾“å‡ºæ¨¡å¼ä¸ºå¤šåŠŸèƒ½å¤ç”¨æ¨¡å¼</span><br>    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;  <span class="hljs-comment">// ç¬¬9æ ¹å¼•è„š</span><br>    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;  <span class="hljs-comment">// 50MHzå‘Šè¯‰å“åº”</span><br>    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);<br>    <br>    <br>    <span class="hljs-comment">//USART1_RX GPIOA_10</span><br>    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;     <span class="hljs-comment">// è¾“å‡ºæ¨¡å¼ä¸ºå¤šåŠŸèƒ½å¤ç”¨æ¨¡å¼</span><br>    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;  <span class="hljs-comment">// ç¬¬10æ ¹å¼•è„š</span><br>    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);<br>    <br>    <br>    <span class="hljs-comment">// é…ç½®ä¸²å£1ç›¸å…³å‚æ•°ï¼šæ³¢ç‰¹ç‡ã€æ— å¥‡å¶æ ¡éªŒã€8ä½æ•°æ®ä½ã€1ä¸ªåœæ­¢ä½â€¦â€¦</span><br>    USART_InitStructure.USART_BaudRate = baud;   <span class="hljs-comment">// æ³¢ç‰¹ç‡</span><br>    USART_InitStructure.USART_WordLength = USART_WordLength_8b;  <span class="hljs-comment">// 8æ•°æ®ä½</span><br>    USART_InitStructure.USART_StopBits = USART_StopBits_1;  <span class="hljs-comment">// 1ä¸ªåœæ­¢ä½</span><br>    USART_InitStructure.USART_Parity = USART_Parity_No; <span class="hljs-comment">// æ— å¥‡å¶æ ¡éªŒä½ </span><br>    USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;  <span class="hljs-comment">// æ— ç¡¬ä»¶æµæ§åˆ¶</span><br>    USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;  <span class="hljs-comment">// å…è®¸æ¥æ”¶/å‘é€æ•°æ®</span><br>    USART_Init(USART1, &amp;USART_InitStructure);<br><br>    <span class="hljs-comment">// é…ç½®ä¸²å£1çš„ä¸­æ–­è§¦å‘æ–¹æ³•ï¼šæ¥å£ä¸€ä¸ªå­—èŠ‚</span><br>    USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);<br>    <br>    <span class="hljs-comment">// é…ç½®ä¸²å£1çš„ä¸­æ–­ä¼˜å…ˆçº§</span><br>    NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;  <span class="hljs-comment">// æ‰“å¼€å¤–éƒ¨ä¸­æ–­0çš„è¯·æ±‚é€šé“</span><br>    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="hljs-number">0</span>;  <span class="hljs-comment">// æŠ¢å ä¼˜å…ˆçº§</span><br>    NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="hljs-number">0</span>;  <span class="hljs-comment">// å“åº”ä¼˜å…ˆçº§</span><br>    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;<br>    NVIC_Init(&amp;NVIC_InitStructure);<br>    <br>    <span class="hljs-comment">// ä½¿èƒ½ä¸²å£1å·¥ä½œ</span><br>    USART_Cmd(USART1, ENABLE);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">FILE</span> &#123;</span> <span class="hljs-type">int</span> handle; <span class="hljs-comment">/* Add whatever you need here */</span> &#125;;<br>FILE __stdout;<br>FILE __stdin;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fputc</span><span class="hljs-params">(<span class="hljs-type">int</span> ch, FILE *f)</span> &#123;<br>        <br>    USART_SendData(USART1,ch);<br>    <span class="hljs-keyword">while</span>(USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET); <span class="hljs-comment">// é¿å…æ•°æ®ç¼“å†²åŒºæ•°æ®è¦†ç›–</span><br>    <br>    <span class="hljs-keyword">return</span> ch;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><br>    u32 d;<br>    <br>    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);<br><br>    <span class="hljs-comment">// ä¸²å£1é€šä¿¡åˆå§‹åŒ–</span><br>    usart1_init(<span class="hljs-number">9600</span>);<br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–GPIOå¼•è„š</span><br>    GPIO_InitTypeDef GPIO_InitStructure;<br>    <br>    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;  <span class="hljs-comment">// è¾“å‡ºæ¨¡å¼ä¸ºæ¨æŒ½æ¨¡å¼</span><br>    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5;         <span class="hljs-comment">// ç¬¬5æ ¹å¼•è„š</span><br>    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;  <span class="hljs-comment">// 50MHzå‘Šè¯‰å“åº”</span><br>    <br>    GPIO_Init(GPIOB, &amp;GPIO_InitStructure);<br>    <br>    PBout(<span class="hljs-number">5</span>) = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">// è§£é™¤å†™è®¿é—®</span><br>    FLASH_UnlockBank1();<br><br>    <span class="hljs-comment">// æ¸…é™¤æ ‡å¿—ä½</span><br>    FLASH_ClearFlag(FLASH_FLAG_EOP | FLASH_FLAG_PGERR | FLASH_FLAG_WRPRTERR);<br>    <br>    <span class="hljs-comment">// æ“¦é™¤é¡µ4</span><br>    <span class="hljs-keyword">if</span>(FLASH_COMPLETE != FLASH_ErasePage(<span class="hljs-number">0x08001800</span>))<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Flash Erase Page 3 Failed!!\n&quot;</span>);<br>        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// å‘é¡µ3é¦–åœ°å€å†™å…¥ä¸€ä¸ª32ä½çš„æ•°æ®</span><br>    <span class="hljs-keyword">if</span>(FLASH_COMPLETE != FLASH_ProgramWord(<span class="hljs-number">0x08001800</span>, <span class="hljs-number">0x8723</span>))        <br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Flash Write Data to Page 3 Failed!!\n&quot;</span>);<br>        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <br>    <br>    <span class="hljs-comment">// æ·»åŠ å†™ä¿æŠ¤</span><br>    FLASH_LockBank1();<br>    <br>    <span class="hljs-comment">// è¯»å–é¡µ3çš„é¦–åœ°å€æ•°æ®ï¼Œè¯»å–4ä¸ªå­—èŠ‚å°±æ˜¯32Bitæ•°æ®</span><br>    d = *(<span class="hljs-keyword">volatile</span> <span class="hljs-type">uint32_t</span>*)<span class="hljs-number">0x08001800</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Flash Read Data From Page 3 is 0x%X!!\n&quot;</span>,d);<br>    <br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223409417.png" alt="image-20231213223409417" style="zoom:67%;"><h2 id="4-æ€è€ƒé¢˜"><a href="#4-æ€è€ƒé¢˜" class="headerlink" title="4.æ€è€ƒé¢˜"></a>4.æ€è€ƒé¢˜</h2><p>æ€è€ƒé¢˜1ï¼šæ“¦é™¤å®Œä¹‹åï¼Œæ‰‡åŒºé‡Œé¢æ‰€æœ‰çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç­”ï¼šæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ä¸º0xFFï¼Œæ‰€æœ‰bitä½éƒ½æ˜¯1ã€‚</p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223433935.png" alt="image-20231213223433935" style="zoom:67%;"><p>æ€è€ƒé¢˜2ï¼šå‡å¦‚è¯´ç°åœ¨å·²ç»æ“¦é™¤å®Œæ‰‡åŒºï¼Œå…ˆå†™å…¥äº†1ä¸ªå­—ï¼Œç„¶ååœ¨<strong>ä¸‹ä¸€ä¸ªåç§»åœ°å€</strong>å†æ¬¡å†™å…¥æ–°çš„å­—æ˜¯å¦åœ¨éœ€è¦æ“¦é™¤æ‰‡åŒºï¼Ÿ</p><p>ç­”æ¡ˆï¼šä¸éœ€è¦çš„ã€‚</p><p>æ€è€ƒé¢˜3ï¼šå‡å¦‚è¯´ç°åœ¨å·²ç»æ“¦é™¤å®Œæ‰‡åŒºï¼Œå…ˆå†™äº†1ä¸ªå­—ï¼Œç„¶ååœ¨<strong>åŒä¸€ä¸ªåœ°å€</strong>å†æ¬¡å†™å…¥æ–°çš„å­—æ˜¯å¦éœ€è¦æ“¦é™¤æ‰‡åŒºï¼Ÿ</p><p>ç­”æ¡ˆï¼šéœ€è¦è¿›è¡Œæ“¦é™¤ï¼</p><p>ä¾‹å­ï¼Œå·²ç»å†™å…¥æ•°æ®ä¸º0x12345678ï¼Œç„¶åå†å†™å…¥æ–°çš„æ•°æ®ä¸º0x1111111ï¼Œæœ€åå¾—åˆ°çš„æ•°æ®å±…ç„¶æ˜¯0x101010.</p><img src="/2023/12/13/stm32f103%E9%97%AA%E5%AD%98flash%E8%AF%BB%E5%86%99/image-20231213223448164.png" alt="image-20231213223448164" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>blkidäºŒè¿›åˆ¶æºç è§£æ</title>
    <link href="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="blkidäºŒè¿›åˆ¶æºç è§£æ"><a href="#blkidäºŒè¿›åˆ¶æºç è§£æ" class="headerlink" title="blkidäºŒè¿›åˆ¶æºç è§£æ"></a>blkidäºŒè¿›åˆ¶æºç è§£æ</h1><p>blkidç”¨äºæŸ¥çœ‹å—è®¾å¤‡UUIDã€Labelã€æŒ‚è½½ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ç­‰ä¿¡æ¯</p><p>blkidçš„æºç ä½äºï¼š<code>external\e2fsprogs\misc\blkid.c</code></p><p><strong>åœ¨å®‰å“voldæºç ä¸­ä¼šé€šè¿‡blkidå»é¢„è¯»å·çš„å…ƒæ•°æ®ä¿¡æ¯</strong></p><img src="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20231212220132527.png" alt="image-20231212220132527" style="zoom:50%;"><p>å¯ä»¥çœ‹åˆ°è¿™æ¡å‘½ä»¤å®é™…çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20231212221419697.png" alt="image-20231212221419697" style="zoom:67%;"><blockquote><p>ä»¥ä¸‹çš„æºç è§£æå°†åŸºäºè¿™æ¡å‘½ä»¤!</p></blockquote><h2 id="blkidäºŒè¿›åˆ¶ä¸»å…¥å£"><a href="#blkidäºŒè¿›åˆ¶ä¸»å…¥å£" class="headerlink" title="blkidäºŒè¿›åˆ¶ä¸»å…¥å£"></a>blkidäºŒè¿›åˆ¶ä¸»å…¥å£</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-keyword">while</span> ((c = getopt (argc, argv, <span class="hljs-string">&quot;c:f:ghlLo:s:t:w:v&quot;</span>)) != EOF)<br><span class="hljs-keyword">switch</span> (c) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;c&#x27;</span>:<br>read = optarg;<br><span class="hljs-keyword">if</span> (!write)<br>write = read;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>:<br>show[numtag++] = optarg;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-comment">// è¿™é‡Œåªæœ‰ä¸€ä¸ªè®¾å¤‡ï¼šå› æ­¤device[0] = &quot;/dev/block/vold/public:252,80&quot;</span><br><span class="hljs-keyword">while</span> (optind &lt; argc)<br>devices[numdev++] = argv[optind++];<br><br><span class="hljs-keyword">if</span> (lookup) &#123;<br><span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!numdev) &#123;<br><span class="hljs-comment">// ..</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; numdev; i++) &#123;  <span class="hljs-comment">/*è¿™è¾¹æˆ‘å°±æŒ‡æ˜äº†ä¸€ä¸ªå¤–ç½®å­˜å‚¨è®¾å¤‡public:252,80ï¼Œæ‰€ä»¥åªä¼šéå†ä¸€æ¬¡*/</span><br>blkid_dev dev = blkid_get_dev(cache, devices[i], BLKID_DEV_NORMAL);  <span class="hljs-comment">// (BLKID_DEV_CREATE | BLKID_DEV_VERIFY)</span><br><br><span class="hljs-keyword">if</span> (dev) &#123;<br>            <span class="hljs-comment">// æ‰“å°æˆ‘ä»¬-sæŒ‡æ˜çš„éœ€è¦showçš„å‚æ•°ï¼šTYPE,UUID,LABEL</span><br>print_tags(dev, show, numtag, output_format);<br>err = <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="è·å–è®¾å¤‡å±æ€§ä¿¡æ¯"><a href="#è·å–è®¾å¤‡å±æ€§ä¿¡æ¯" class="headerlink" title="è·å–è®¾å¤‡å±æ€§ä¿¡æ¯"></a>è·å–è®¾å¤‡å±æ€§ä¿¡æ¯</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">blkid_dev <span class="hljs-title function_">blkid_get_dev</span><span class="hljs-params">(blkid_cache cache, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *devname, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>blkid_dev dev = <span class="hljs-literal">NULL</span>, tmp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">p</span>, *<span class="hljs-title">pnext</span>;</span><br><br><span class="hljs-keyword">if</span> (!dev &amp;&amp; (flags &amp; BLKID_DEV_CREATE)) &#123;<br><span class="hljs-keyword">if</span> (access(devname, F_OK) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        dev = blkid_new_dev();<br>dev-&gt;bid_time = INT_MIN;<br>dev-&gt;bid_name = blkid_strdup(devname);<br>dev-&gt;bid_cache = cache;<br>        cache-&gt;bic_flags |= BLKID_BIC_FL_CHANGED;<br>&#125;<br><br><span class="hljs-keyword">if</span> (flags &amp; BLKID_DEV_VERIFY) &#123;<br>dev = blkid_verify(cache, dev);<br>&#125;<br><span class="hljs-keyword">return</span> dev;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡blkid_new_devå‡½æ•°åˆå§‹åŒ–blkid_devç»“æ„ä½“ï¼Œæœ€ç»ˆé€šè¿‡blkid_verifyæ ¡éªŒè¯¥è®¾å¤‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c">blkid_dev <span class="hljs-title function_">blkid_verify</span><span class="hljs-params">(blkid_cache cache, blkid_dev dev)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blkid_probe</span> <span class="hljs-title">probe</span>;</span><br>    <br><span class="hljs-keyword">if</span> (stat(dev-&gt;bid_name, &amp;st) &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br><br><br>    <span class="hljs-comment">// æ‰“å¼€è®¾å¤‡ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-keyword">if</span> ((probe.fd = open(dev-&gt;bid_name, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br><br>probe.cache = cache;<br>probe.dev = dev;<br>probe.sbbuf = <span class="hljs-number">0</span>;<br>probe.buf = <span class="hljs-number">0</span>;<br>probe.buf_max = <span class="hljs-number">0</span>;<br><br>type = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// éå†æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹(ä¸‹é¢æœ‰)</span><br><span class="hljs-keyword">for</span> (id = type_array; id-&gt;bim_type; id++) &#123;<br><span class="hljs-keyword">if</span> (dev-&gt;bid_type &amp;&amp; <span class="hljs-built_in">strcmp</span>(id-&gt;bim_type, dev-&gt;bid_type))<br><span class="hljs-keyword">continue</span>;<br><br>idx = id-&gt;bim_kboff + (id-&gt;bim_sboff &gt;&gt; <span class="hljs-number">10</span>);<br>buf = get_buffer(&amp;probe, (__u64) idx &lt;&lt; <span class="hljs-number">10</span>, <span class="hljs-number">1024</span>); <span class="hljs-comment">// æ‹¿åˆ°ä¸åŒæ–‡ä»¶ç³»ç»Ÿåœ¨ä¸åŒä½ç½®å­˜å‚¨çš„é­”æœ¯å­—</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(id-&gt;bim_magic, buf + (id-&gt;bim_sboff &amp; <span class="hljs-number">0x3ff</span>), id-&gt;bim_len))<br><span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// é­”æœ¯å­—æ ¡éªŒé€šè¿‡ï¼Œè¯´æ˜æ‰¾åˆ°äº†è¯¥è®¾å¤‡å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹é¢å°±æ˜¯æ­£å¼æ‹¿åˆ°é‚£äº›å±æ€§å€¼äº†:TYPE UUID LABEL</span><br><span class="hljs-keyword">if</span> ((id-&gt;bim_probe == <span class="hljs-literal">NULL</span>) ||<br>    (id-&gt;bim_probe(&amp;probe, id, buf) == <span class="hljs-number">0</span>)) &#123;<br>type = id-&gt;bim_type;<br><span class="hljs-keyword">goto</span> found_type;<br>&#125;<br>&#125;<br><br>found_type:<br><span class="hljs-keyword">if</span> (dev &amp;&amp; type) &#123;<br>dev-&gt;bid_devno = st.st_rdev;<br>dev-&gt;bid_time = time(<span class="hljs-number">0</span>);<br>dev-&gt;bid_flags |= BLKID_BID_FL_VERIFIED;<br>cache-&gt;bic_flags |= BLKID_BIC_FL_CHANGED;<br><br>blkid_set_tag(dev, <span class="hljs-string">&quot;TYPE&quot;</span>, type, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> dev;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>type_arrayå­˜å‚¨äº†æ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿå’Œå¯¹åº”å¤„ç†å‡½æ•°</li></ul><img src="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20231212223241899.png" alt="image-20231212223241899" style="zoom:67%;"><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°é­”æœ¯å­—æ ¡éªŒé€šè¿‡åä¼šå»è°ƒç”¨å¯¹åº”çš„probeå‡½æ•°å»æ‹¿åˆ°å±æ€§å€¼ï¼Œä»¥æˆ‘çš„å¤–ç½®SDå¡ä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹é­”æœ¯å­—æ ¡éªŒå’Œå¯¹åº”çš„å¤„ç†å‡½æ•°</p><ul><li>æˆ‘çš„SDå¡0x52å¼€å§‹çš„4ä¸ªå­—èŠ‚é­”æœ¯å­—ä¸ºï¼šFAT32</li></ul><img src="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20231212224912193.png" alt="image-20231212224912193" style="zoom: 67%;"><ul><li>æ­£å¥½ä¸é¢„è®¾æ•°ç»„ä¸­çš„èƒ½å¤Ÿå¯¹ä¸Š</li></ul><img src="/2023/12/12/blkid%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20231212225111226.png" alt="image-20231212225111226" style="zoom:80%;"><blockquote><p>ğŸ¤–è¿™é‡Œå…¶å®ä¹Ÿè§£ç­”äº†æˆ‘ä¸ªäººçš„ä¸€äº›ç–‘é—®ï¼š<strong>åˆ°åº•ä»€ä¹ˆæ˜¯vfatæ–‡ä»¶ç³»ç»Ÿï¼Œä»æºç è§’åº¦ç†è§£ï¼Œæ‰€æœ‰fatæ–‡ä»¶ç³»çš„éƒ½æ˜¯vfatæ–‡ä»¶ç³»ç»Ÿ</strong></p></blockquote><p>è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿå¤„ç†å‡½æ•°ï¼Œå³<strong>probe_fat</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æŠŠå‰é¢è¯»åˆ°çš„bufferä¼ è¿‡æ¥</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">probe_fat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> blkid_probe *probe, <span class="hljs-keyword">struct</span> blkid_magic *id __BLKID_ATTR((unused)),</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfat_super_block</span> *<span class="hljs-title">vs</span> =</span> (<span class="hljs-keyword">struct</span> vfat_super_block *) buf;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msdos_super_block</span> *<span class="hljs-title">ms</span> =</span> (<span class="hljs-keyword">struct</span> msdos_super_block *) buf;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfat_dir_entry</span> *<span class="hljs-title">dir</span>;</span><br><span class="hljs-type">char</span> serno[<span class="hljs-number">10</span>];<br><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *label = <span class="hljs-number">0</span>, *vol_label = <span class="hljs-number">0</span>, *tmp;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>*vol_serno;<br><span class="hljs-type">int</span> label_len = <span class="hljs-number">0</span>, maxloop = <span class="hljs-number">100</span>;<br>__u16 sector_size, dir_entries, reserved;<br>__u32 sect_count, fat_size, dir_size, cluster_count, fat_length;<br>__u32 buf_size, start_data_sect, next, root_start, root_dir_entries;<br><br><span class="hljs-comment">/* sector size check */</span><br>tmp = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)&amp;ms-&gt;ms_sector_size;<br>sector_size = tmp[<span class="hljs-number">0</span>] + (tmp[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>);<br><span class="hljs-keyword">if</span> (sector_size != <span class="hljs-number">0x200</span> &amp;&amp; sector_size != <span class="hljs-number">0x400</span> &amp;&amp;<br>    sector_size != <span class="hljs-number">0x800</span> &amp;&amp; sector_size != <span class="hljs-number">0x1000</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>tmp = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)&amp;ms-&gt;ms_dir_entries;<br>dir_entries = tmp[<span class="hljs-number">0</span>] + (tmp[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>);<br>reserved =  blkid_le16(ms-&gt;ms_reserved);<br>tmp = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)&amp;ms-&gt;ms_sectors;<br>sect_count = tmp[<span class="hljs-number">0</span>] + (tmp[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>);<br><span class="hljs-keyword">if</span> (sect_count == <span class="hljs-number">0</span>)<br>sect_count = blkid_le32(ms-&gt;ms_total_sect);<br><br>fat_length = blkid_le16(ms-&gt;ms_fat_length);<br><span class="hljs-keyword">if</span> (fat_length == <span class="hljs-number">0</span>)<br>fat_length = blkid_le32(vs-&gt;vs_fat32_length);<br><br>fat_size = fat_length * ms-&gt;ms_fats;<br>dir_size = ((dir_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> vfat_dir_entry)) +<br>(sector_size<span class="hljs-number">-1</span>)) / sector_size;<br><br>cluster_count = sect_count - (reserved + fat_size + dir_size);<br><span class="hljs-keyword">if</span> (ms-&gt;ms_cluster_size == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>cluster_count /= ms-&gt;ms_cluster_size;<br><br><span class="hljs-keyword">if</span> (cluster_count &gt; FAT32_MAX)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">if</span> (ms-&gt;ms_fat_length) &#123;<br><span class="hljs-comment">/* the label may be an attribute in the root directory */</span><br>root_start = (reserved + fat_size) * sector_size;<br>root_dir_entries = vs-&gt;vs_dir_entries[<span class="hljs-number">0</span>] +<br>(vs-&gt;vs_dir_entries[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>);<br><br>buf_size = root_dir_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> vfat_dir_entry);<br>dir = (<span class="hljs-keyword">struct</span> vfat_dir_entry *) get_buffer(probe, root_start,<br>   buf_size);<br><span class="hljs-keyword">if</span> (dir)<br>vol_label = search_fat_label(dir, root_dir_entries);<br><br><span class="hljs-keyword">if</span> (!vol_label || !<span class="hljs-built_in">memcmp</span>(vol_label, no_name, <span class="hljs-number">11</span>))<br>vol_label = ms-&gt;ms_label;<br>vol_serno = ms-&gt;ms_serno;<br><br>blkid_set_tag(probe-&gt;dev, <span class="hljs-string">&quot;SEC_TYPE&quot;</span>, <span class="hljs-string">&quot;msdos&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">&quot;msdos&quot;</span>));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Search the FAT32 root dir for the label attribute */</span><br>buf_size = vs-&gt;vs_cluster_size * sector_size;<br>start_data_sect = reserved + fat_size;<br><br>next = blkid_le32(vs-&gt;vs_root_cluster);<br><span class="hljs-keyword">while</span> (next &amp;&amp; --maxloop) &#123;<br>__u32 next_sect_off;<br>__u64 next_off, fat_entry_off;<br><span class="hljs-type">int</span> count;<br><br>next_sect_off = (next - <span class="hljs-number">2</span>) * vs-&gt;vs_cluster_size;<br>next_off = (__u64) (start_data_sect + next_sect_off) *<br>sector_size;<br><br>dir = (<span class="hljs-keyword">struct</span> vfat_dir_entry *)<br>get_buffer(probe, next_off, buf_size);<br><span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">break</span>;<br><br>count = buf_size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> vfat_dir_entry);<br><br>vol_label = search_fat_label(dir, count);<br><span class="hljs-keyword">if</span> (vol_label)<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-comment">/* get FAT entry */</span><br>fat_entry_off =<br>((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>) reserved *<br> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>) sector_size) +<br>(next * <span class="hljs-keyword">sizeof</span>(__u32));<br>buf = get_buffer(probe, fat_entry_off, buf_size);<br><span class="hljs-keyword">if</span> (buf == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-comment">/* set next cluster */</span><br>next = blkid_le32(*((__u32 *) buf) &amp; <span class="hljs-number">0x0fffffff</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!vol_label || !<span class="hljs-built_in">memcmp</span>(vol_label, no_name, <span class="hljs-number">11</span>))<br>vol_label = vs-&gt;vs_label;<br>vol_serno = vs-&gt;vs_serno;<br>&#125;<br><br><span class="hljs-keyword">if</span> (vol_label &amp;&amp; <span class="hljs-built_in">memcmp</span>(vol_label, no_name, <span class="hljs-number">11</span>)) &#123;<br><span class="hljs-keyword">if</span> ((label_len = figure_label_len(vol_label, <span class="hljs-number">11</span>)))<br>label = vol_label;<br>&#125;<br><br><span class="hljs-comment">/* We can&#x27;t just print them as %04X, because they are unaligned */</span><br><span class="hljs-built_in">sprintf</span>(serno, <span class="hljs-string">&quot;%02X%02X-%02X%02X&quot;</span>, vol_serno[<span class="hljs-number">3</span>], vol_serno[<span class="hljs-number">2</span>],<br>vol_serno[<span class="hljs-number">1</span>], vol_serno[<span class="hljs-number">0</span>]);<br><br>blkid_set_tag(probe-&gt;dev, <span class="hljs-string">&quot;LABEL&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) label, label_len);<br>blkid_set_tag(probe-&gt;dev, <span class="hljs-string">&quot;UUID&quot;</span>, serno, <span class="hljs-keyword">sizeof</span>(serno)<span class="hljs-number">-1</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>â˜ƒï¸<strong>ç»“è®ºï¼š</strong>è¯´ç™½äº†æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰å›ºå®šçš„ä½ç½®å»å­˜å‚¨è¿™äº›å±æ€§å€¼ï¼Œblkidä¹Ÿåªæ˜¯ä»ç£ç›˜é‡Œé¢è¯»å‡ºæ¥æ”¾åˆ°bufferé‡Œé¢ï¼Œäº¤ç”±å„è‡ªæ–‡ä»¶ç³»ç»Ÿå»å›ºå®šçš„ä½ç½®æ‹¿å‡ºæ¥è€Œå·²ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark</title>
    <link href="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/"/>
    <url>/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/</url>
    
    <content type="html"><![CDATA[<h1 id="HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark"><a href="#HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark" class="headerlink" title="HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark"></a>HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/jony_online/article/details/132296821">HDD&amp;SSD ç¡¬ç›˜è¯»å†™æµ‹è¯•ï¼šfio ä¸ CrystalDiskMark â€”â€” åœ¨ linux ä¸ windows ç¯å¢ƒ_å»å±±çš„é‚£è¾¹çœ‹æµ·å•Šçš„åšå®¢-CSDNåšå®¢</a></p></blockquote><h2 id="CrystalDiskMark-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#CrystalDiskMark-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="CrystalDiskMark æ˜¯ä»€ä¹ˆï¼Ÿ"></a>CrystalDiskMark æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å®˜ç½‘ï¼š<a href="https://crystalmark.info/en/">https://crystalmark.info/en/</a></p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/977c6e2af9db4b34bacb689449dc1fa3.png" alt="img" style="zoom:50%;"><p>å¤§åé¼é¼çš„ CrystalDiskMarkï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ CDM è½¯ä»¶ï¼Œæ“ä½œç®€å•å¥½ç”¨ï¼Œé¢œå€¼é«˜ã€‚è¿˜å¯ä»¥æ¢çš®è‚¤ç©ã€‚ä½†åœ¨åªèƒ½åœ¨ windows ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œä¸æ”¯æŒlinuxã€‚</p><h2 id="fioæ˜¯ä»€ä¹ˆ"><a href="#fioæ˜¯ä»€ä¹ˆ" class="headerlink" title="fioæ˜¯ä»€ä¹ˆ"></a>fioæ˜¯ä»€ä¹ˆ</h2><p>å®˜ç½‘ï¼š<a href="https://fio.readthedocs.io/en/latest/">https://fio.readthedocs.io/en/latest/</a></p><p>fio æ˜¯ Linuxä¸‹å¼€æºçš„ä¸€æ¬¾IOPSæµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨æ¥å¯¹ç£ç›˜è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œæ€§èƒ½éªŒè¯ã€‚ ç±»ä¼¼çš„å·¥å…·ï¼Œç®€å•çš„ä¾‹å¦‚æœ‰ ddã€hdparm è¿™äº›ï¼Œä½†ä¸ fio ç›¸æ¯”ï¼ŒåŠŸèƒ½ä¸Šéƒ½å¤ªç®€é™‹äº†ã€‚</p><p>å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt instal fio<br></code></pre></td></tr></table></figure><p>å¸¸ç”¨å‚æ•°ï¼š</p><p>ä»¥è¿™æ ·ä¸€ä¸ªæµ‹è¯•ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo fio -direct=1 -iodepth=1 -rw=randrw -ioengine=libaio -bs=4k -size=64M -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q1T1-RND4K64M<br></code></pre></td></tr></table></figure><ul><li>-direct æ˜¯å¦å¿½ç•¥ç¼“å­˜ï¼Œ</li><li>-iodepth è¯»å†™é˜Ÿåˆ—æ·±åº¦</li><li>-rw è¯»å†™æµ‹è¯•æ¨¡å¼ï¼Œrandrw éšæœºè¯»å†™ï¼Œreadwrite è¿ç»­è¯»å†™</li><li>-ioengine è¯»å†™æ–¹å¼ï¼šlibaioï¼šlinux å¼‚æ­¥è¯»å†™ï¼›</li><li>-bs è¯»å†™å—å¤§å°</li><li>-size è¯»å†™æ•°æ®æ€»é‡</li><li>-numjobs çº¿ç¨‹æ•°é‡</li><li>-runtime è¿è¡Œæ—¶é—´ï¼Œä¸ -size ä¸€èµ·ï¼Œæ»¡è¶³æ¡ä»¶æ—¶ï¼Œæµ‹è¯•é€€å‡º</li><li>-group_reporting èšåˆè¾“å‡ºæŠ¥å‘Šå½¢å¼</li><li>-filename è¯»å†™æµ‹è¯•æ–‡ä»¶ï¼›å¦‚æœè¯»æµ‹è¯•å¯ä»¥ç›´æ¥æŒ‡å®šIOè®¾å¤‡ä¾‹å¦‚ï¼›&#x2F;dev&#x2F;sda ; å†™æµ‹è¯•å¿…é¡»ä¸ºæ–‡ä»¶ï¼›</li><li>-name æµ‹è¯•æŠ¥å‘Šæ ‡é¢˜</li></ul><p>æ³¨æ„ï¼š</p><p>è¯»å†™æµ‹è¯•æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯ä»¥è¯»å†™çš„æ–‡ä»¶ï¼›æ­¤æ—¶éœ€è¦ä½¿ç”¨ dd ç”Ÿæˆä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/home/test.temp bs=4k count=100000<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-fio-æ¨¡æ‹Ÿ-CrystalDiskMark-çš„æµ‹è¯•"><a href="#ä½¿ç”¨-fio-æ¨¡æ‹Ÿ-CrystalDiskMark-çš„æµ‹è¯•" class="headerlink" title="ä½¿ç”¨ fio æ¨¡æ‹Ÿ CrystalDiskMark çš„æµ‹è¯•"></a>ä½¿ç”¨ fio æ¨¡æ‹Ÿ CrystalDiskMark çš„æµ‹è¯•</h2><p>é‚£ä¹ˆæˆ‘æƒ³åœ¨ Linux ä¸‹æµ‹è¯•ç¡¬ç›˜è¯»å†™æ€§èƒ½ï¼Œå¹¶ä¸”æƒ³å’Œä¹‹å‰åœ¨ windows ä¸‹ç”¨ CDM æµ‹è¯•çš„ç»“æœè¿›è¡Œæ¯”å¯¹ï¼Œå°±éœ€è¦ä½¿ç”¨ fio å¯¹ CDM çš„æµ‹è¯•é¡¹ç›®è¿›è¡Œæ¨¡æ‹Ÿï¼›</p><p>æµ‹è¯•é¡¹ç›®ï¼š</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/1c49676ef35f4236b40a613fe7d4fd23.png" alt="img" style="zoom:50%;"><h3 id="Q8T1-SEQ1Mï¼šå¤šé˜Ÿåˆ—è¿ç»­è¯»å†™"><a href="#Q8T1-SEQ1Mï¼šå¤šé˜Ÿåˆ—è¿ç»­è¯»å†™" class="headerlink" title="Q8T1-SEQ1Mï¼šå¤šé˜Ÿåˆ—è¿ç»­è¯»å†™"></a>Q8T1-SEQ1Mï¼šå¤šé˜Ÿåˆ—è¿ç»­è¯»å†™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo fio -iodepth=1 -iodepth=8 -rw=readwrite -ioengine=libaio -bs=1M -size=64M -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q8T1-SEQ1M64M<br> <br>sudo fio -iodepth=1 -iodepth=8 -rw=readwrite -ioengine=libaio -bs=1M -size=1G -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q8T1-SEQ1M1G<br></code></pre></td></tr></table></figure><h3 id="Q1T1-SEQ1Mï¼šå•é˜Ÿåˆ—è¿ç»­è¯»å†™"><a href="#Q1T1-SEQ1Mï¼šå•é˜Ÿåˆ—è¿ç»­è¯»å†™" class="headerlink" title="Q1T1-SEQ1Mï¼šå•é˜Ÿåˆ—è¿ç»­è¯»å†™"></a>Q1T1-SEQ1Mï¼šå•é˜Ÿåˆ—è¿ç»­è¯»å†™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo fio -iodepth=1 -iodepth=1 -rw=readwrite -ioengine=libaio -bs=1M -size=64M -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q1T1-SEQ1M64M<br> <br>sudo fio -iodepth=1 -iodepth=1 -rw=readwrite -ioengine=libaio -bs=1M -size=1G -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q1T1-SEQ1M1G<br></code></pre></td></tr></table></figure><h3 id="Q32T1-RND4Kï¼š4Kå¤šé˜Ÿåˆ—éšæœºè¯»å†™"><a href="#Q32T1-RND4Kï¼š4Kå¤šé˜Ÿåˆ—éšæœºè¯»å†™" class="headerlink" title="Q32T1-RND4Kï¼š4Kå¤šé˜Ÿåˆ—éšæœºè¯»å†™"></a>Q32T1-RND4Kï¼š4Kå¤šé˜Ÿåˆ—éšæœºè¯»å†™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo fio -iodepth=1 -iodepth=32 -rw=randrw -ioengine=libaio -bs=4k -size=64M -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q32T1-RND4K64M<br> <br>sudo fio -iodepth=1 -iodepth=32 -rw=randrw -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q32T1-RND4K1G<br></code></pre></td></tr></table></figure><h3 id="Q1T1-RND4Kï¼š4Kå•é˜Ÿåˆ—éšæœºè¯»å†™"><a href="#Q1T1-RND4Kï¼š4Kå•é˜Ÿåˆ—éšæœºè¯»å†™" class="headerlink" title="Q1T1-RND4Kï¼š4Kå•é˜Ÿåˆ—éšæœºè¯»å†™"></a>Q1T1-RND4Kï¼š4Kå•é˜Ÿåˆ—éšæœºè¯»å†™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo fio -iodepth=1 -iodepth=1 -rw=randrw -ioengine=libaio -bs=4k -size=64M -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q1T1-RND4K64M<br> <br>sudo fio -iodepth=1 -iodepth=1 -rw=randrw -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=60 -group_reporting -filename=/home/test.temp -name=Q1T1-RND4K1G<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><p>ä»¥ä¸Šæµ‹è¯•é¡¹ç›®ï¼Œfio å¯ä»¥é…ç½® -direct&#x3D;1 å±è”½ç¼“å­˜ï¼Œéå¸¸æ–¹ä¾¿åœ°æµ‹å¾—ç¡¬ç›˜çš„ç¼“å­˜å¤–è¯»å†™æ€§èƒ½ã€‚</p><p>CDM å¹¶æ²¡æœ‰è¿™æ ·ç›´æ¥çš„è®¾ç½®ï¼Œæ‰€ä»¥æµ‹è¯•ç»“æœæ˜¯åŒ…å«ç¼“å­˜å†…æ€§èƒ½çš„ã€‚å¯ä»¥é€šè¿‡å°† -size&#x3D;1G è®¾ç½®ä¸ºæ›´å¤§çš„è¯»å†™æ–‡ä»¶ï¼Œè€—å°½ç¼“å­˜ç©ºé—´ï¼Œä»¥åŠå¢åŠ  æµ‹è¯•è½®æ¬¡ï¼ˆé»˜è®¤æ˜¯5ï¼‰æ¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœã€‚</p><h3 id="æµ‹è¯•ç»“æœæ¯”è¾ƒ"><a href="#æµ‹è¯•ç»“æœæ¯”è¾ƒ" class="headerlink" title="æµ‹è¯•ç»“æœæ¯”è¾ƒ"></a>æµ‹è¯•ç»“æœæ¯”è¾ƒ</h3><p>windows ä¸­å¯¹ è¥¿æ•° SN550 çš„æµ‹è¯•ç»“æœï¼š</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/12bbee026824410591a07be8bffa6d8e.png" alt="img" style="zoom:50%;"><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/f440df0c764c45caad6af7c640b56957.png" alt="img" style="zoom:50%;"><p>linux ä¸­å¯¹ è¥¿æ•° SN550 çš„æµ‹è¯•ç»“æœï¼š</p><p>Q32T1-RND4K64M ä¸ä½¿ç”¨ç¼“å­˜</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/1957f495708b448f845e300e9ef8fa9d.png" alt="img" style="zoom: 50%;"><p> Q32T1-RND4K64M ä½¿ç”¨ç¼“å­˜</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/246b4bebb5184553850b76fa5904836c.png" alt="img" style="zoom:50%;"><p>Q8T1-SEQ1M64M ä½¿ç”¨ç¼“å­˜ï¼š</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/7550cd132c7642339fbf20ba3b26c089.png" alt="img" style="zoom:50%;"><p> Q8T1-SEQ1M64M ä¸ä½¿ç”¨ç¼“å­˜ï¼š</p><img src="/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/790072ea3e474eab825ba0b4420abd35.png" alt="img" style="zoom:50%;"><p>ç»“æœåˆ†æï¼š</p><p>ç¼“å­˜æ˜¯ä¸ªéå¸¸å¤æ‚çš„ä¸œè¥¿ï¼Œä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæœ‰äº› fio æµ‹è¯•åœ¨ç¼“å­˜å‚ä¸æ—¶å’ŒCDMçš„ç»“æœä¸€è‡´ï¼Œå¦å¤–ä¸€äº›å´æ˜¯æ— ç¼“å­˜å‚ä¸çš„ä¸CDMä¸€è‡´ã€‚åŸå› å¯èƒ½æ˜¯å¤šæ ·çš„ï¼Œç³»ç»Ÿä»»åŠ¡è°ƒåº¦çš„é—®é¢˜ï¼Œæ–‡ä»¶ç³»ç»ŸNTFSã€ext4ä¹‹é—´çš„å·®å¼‚ï¼Œç³»ç»Ÿç¼“å­˜è°ƒåº¦å·®å¼‚ç­‰ç­‰ã€‚ç›®å‰æ¥çœ‹æµ‹è¯•ç»“æœä»…ä¾›å‚è€ƒã€‚ä½†åŒæ—¶ï¼Œfio çš„å®åŠ›è¿˜æœªçœŸæ­£å¾—åˆ°å‘æŒ¥ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å­˜å‚¨å™¨ä»¶æ€§èƒ½æµ‹è¯•</title>
    <link href="/2023/12/11/%E5%AD%98%E5%82%A8%E5%99%A8%E4%BB%B6%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
    <url>/2023/12/11/%E5%AD%98%E5%82%A8%E5%99%A8%E4%BB%B6%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h1 id="å­˜å‚¨å™¨ä»¶æ€§èƒ½æµ‹è¯•"><a href="#å­˜å‚¨å™¨ä»¶æ€§èƒ½æµ‹è¯•" class="headerlink" title="å­˜å‚¨å™¨ä»¶æ€§èƒ½æµ‹è¯•"></a>å­˜å‚¨å™¨ä»¶æ€§èƒ½æµ‹è¯•</h1><ul><li><a href="https://anmuxixixi.github.io/2023/12/11/HDD%E5%92%8CSSD%E7%A1%AC%E7%9B%98%E8%AF%BB%E5%86%99%E6%B5%8B%E8%AF%95fio%E4%B8%8ECrystalDiskMark/">HDDå’ŒSSDç¡¬ç›˜è¯»å†™æµ‹è¯•fioä¸CrystalDiskMark</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>åå—æ£€æµ‹äºŒè¿›åˆ¶badblocksæºç åˆ†æ</title>
    <link href="/2023/12/09/%E5%9D%8F%E5%9D%97%E6%A3%80%E6%B5%8B%E4%BA%8C%E8%BF%9B%E5%88%B6badblocks%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/09/%E5%9D%8F%E5%9D%97%E6%A3%80%E6%B5%8B%E4%BA%8C%E8%BF%9B%E5%88%B6badblocks%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="åå—æ£€æµ‹äºŒè¿›åˆ¶badblocksæºç åˆ†æ"><a href="#åå—æ£€æµ‹äºŒè¿›åˆ¶badblocksæºç åˆ†æ" class="headerlink" title="åå—æ£€æµ‹äºŒè¿›åˆ¶badblocksæºç åˆ†æ"></a>åå—æ£€æµ‹äºŒè¿›åˆ¶badblocksæºç åˆ†æ</h1><p>åœ¨Linuxç»å¸¸ä½¿ç”¨badblockså»æ£€æŸ¥ç£ç›˜çš„åå—&#x2F;åé“ï¼Œå…¶æºç ä½äº<code>external\e2fsprogs\misc\badblocks.c</code></p><p>å¸¸è§çš„æ£€æŸ¥åé“çš„æ–¹å¼ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">badblocks -v /dev/sda1 &gt; badsectors.txt <br></code></pre></td></tr></table></figure><p>-vï¼šè¡¨ç¤ºå¼€å¯æ—¥å¿—æ¨¡å¼</p><blockquote><p>æ³¨ï¼šä»¥ä¸‹çš„æºç åˆ†æéƒ½åŸºäºä¸Šé¢çš„å‘½ä»¤è¿›è¡Œ</p></blockquote><h2 id="badblocksäºŒè¿›åˆ¶ä¸»å…¥å£"><a href="#badblocksäºŒè¿›åˆ¶ä¸»å…¥å£" class="headerlink" title="badblocksäºŒè¿›åˆ¶ä¸»å…¥å£"></a>badblocksäºŒè¿›åˆ¶ä¸»å…¥å£</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;    <br>    <span class="hljs-comment">// test_funcæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œé»˜è®¤æ˜¯roæ¨¡å¼</span><br>    test_func = test_ro;<br>    <span class="hljs-keyword">if</span> (argc &amp;&amp; *argv)<br>        program_name = *argv;<br>    <span class="hljs-keyword">while</span> ((c = getopt (argc, argv, <span class="hljs-string">&quot;b:d:e:fi:o:svwnc:p:h:t:BX&quot;</span>)) != EOF) &#123;<br><span class="hljs-keyword">switch</span> (c) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>:<br>v_flag++;<br><span class="hljs-keyword">break</span>;   <br>        &#125;<br>    &#125;<br>    device_name = argv[optind++];<br>    <span class="hljs-comment">// è·å–æœ€åä¸€ä¸ªå—çš„ç´¢å¼•</span><br>    errcode = ext2fs_get_device_size2(device_name, block_size, &amp;last_block); <span class="hljs-comment">// block_sizeè°ƒç”¨æ—¶ä¸æŒ‡æ˜ä¸º1024Byte(1Kb)</span><br>    first_block = <span class="hljs-number">0</span>;<br>    <br>    open_flag = O_LARGEFILE | (w_flag ? O_RDWR : O_RDONLY);<br>dev = open (device_name, open_flag);<br>    <br>    <span class="hljs-comment">// è¿™ä¸ªdo whileå¾ªç¯åªä¼šæ‰§è¡Œä¸€æ¬¡</span><br>    <span class="hljs-keyword">do</span> &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bb_count;<br><br>        <span class="hljs-comment">// è¿™è¾¹æ˜¯badblockså®ç°çš„æ ¸å¿ƒã€æ£€æµ‹åå—ã€‘</span><br>bb_count = test_func(dev, last_block, block_size, first_block, blocks_at_once);  <span class="hljs-comment">// blocks_at_onceè°ƒç”¨æ—¶ä¸æŒ‡æ˜é»˜è®¤64</span><br><span class="hljs-keyword">if</span> (bb_count)<br>passes_clean = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">else</span><br>++passes_clean;<br><br><span class="hljs-keyword">if</span> (v_flag)<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,_(<span class="hljs-string">&quot;Pass completed, %u bad blocks found. (%d/%d/%d errors)\n&quot;</span>),<br>bb_count, num_read_errors, num_write_errors, num_corruption_errors);<br><br>&#125; <span class="hljs-keyword">while</span> (passes_clean &lt; num_passes);<br><br>close (dev);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åªè¯»å†™æ£€æµ‹åé“"><a href="#åªè¯»å†™æ£€æµ‹åé“" class="headerlink" title="åªè¯»å†™æ£€æµ‹åé“"></a>åªè¯»å†™æ£€æµ‹åé“</h2><p>è¿™è¾¹çš„å†™æ³•å®åœ¨å·§å¦™ï¼Œä¸»è¦çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>æ¯æ¬¡è¯»å–64ä¸ªblockï¼Œå¦‚æœè¿”å›çš„æ•°é‡å°äº64ä¸ªblockï¼Œè¯´æ˜ä¸­é—´é‡åˆ°äº†åå—ï¼Œåˆ™ï¼š<ul><li>ä¸‹é¢æ¯æ¬¡é‡æ–°è¯»å–ä¸€ä¸ªblockã€æ€»å…±è¯»å–64æ¬¡ã€‘ï¼Œå¦‚æœè¯»ä¸åˆ°æ•°æ®ï¼Œåˆ™è¿™1ä¸ªblockå°±æ˜¯<strong>åå—</strong></li><li>å½“è¯»å–çš„æ•°é‡è¾¾åˆ°64æ—¶ï¼Œé‡æ–°æ¢å¤ä¸€æ¬¡æ€§è¯»å–64ä¸ªblockçš„èŠ‚å¥</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test_ro</span> <span class="hljs-params">(<span class="hljs-type">int</span> dev, <span class="hljs-type">blk_t</span> last_block,</span><br><span class="hljs-params">     <span class="hljs-type">int</span> block_size, <span class="hljs-type">blk_t</span> first_block,</span><br><span class="hljs-params">     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> blocks_at_once)</span><br>&#123;<br>    <span class="hljs-comment">// blkbufçš„é»˜è®¤å¤§å°ä¸º64K</span><br>    blkbuf = allocate_buffer(blocks_at_once * block_size);<br><br><span class="hljs-keyword">if</span> (v_flag) &#123;<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, _(<span class="hljs-string">&quot;Checking blocks %lu to %lu\n&quot;</span>),<br>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)first_block,<br>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)last_block - <span class="hljs-number">1</span>);<br>&#125;<br><br>try = blocks_at_once;<br>currently_testing = first_block;<br>num_blocks = last_block - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (!t_flag &amp;&amp; (s_flag || v_flag))<br><span class="hljs-built_in">fputs</span>(_(<span class="hljs-string">&quot;Checking for bad blocks (read-only test): &quot;</span>), <span class="hljs-built_in">stderr</span>);<br><span class="hljs-keyword">while</span> (currently_testing &lt; last_block)<br>&#123;<br>        <span class="hljs-comment">// æœ€å¤§æ”¯æŒçš„åå—æ•°é‡ä¸º INT_MAX/2</span><br><span class="hljs-keyword">if</span> (bb_count &gt;= max_bb) &#123;<br><span class="hljs-keyword">if</span> (s_flag || v_flag) &#123;<br><span class="hljs-built_in">fputs</span>(_(<span class="hljs-string">&quot;Too many bad blocks, aborting test\n&quot;</span>), <span class="hljs-built_in">stderr</span>);<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>        <span class="hljs-comment">// æœ€åä¸€æ¬¡è¯»å¯èƒ½ä¸æ»¡tryä¸ª</span><br><span class="hljs-keyword">if</span> (currently_testing + try &gt; last_block)<br>try = last_block - currently_testing;<br>        <br>        <span class="hljs-comment">// è°ƒç”¨do_readæ¥å£æµ‹è¯•[ä¸‹é¢æœ‰è§£æ]</span><br>got = do_read (dev, blkbuf, try, block_size, currently_testing);<br><br><span class="hljs-keyword">if</span> (got == <span class="hljs-number">0</span> &amp;&amp; try == <span class="hljs-number">1</span>)<br>bb_count += bb_output(currently_testing++, READ_ERROR);<br>currently_testing += got;<br><span class="hljs-keyword">if</span> (got != try) &#123;<br>try = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (recover_block == ~<span class="hljs-number">0U</span>)<br>recover_block = currently_testing - got + blocks_at_once;<br><span class="hljs-keyword">continue</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currently_testing == recover_block) &#123;<br>try = blocks_at_once;<br>recover_block = ~<span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (s_flag || v_flag)<br><span class="hljs-built_in">fputs</span>(_(done_string), <span class="hljs-built_in">stderr</span>);<br><br>fflush (<span class="hljs-built_in">stderr</span>);<br><br><span class="hljs-keyword">return</span> bb_count;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°è¯•è¯»tryä¸ªå¤§å°ä¸º1kçš„blockï¼Œè¿”å›æˆåŠŸè¯»å–çš„blockæ•°ç›®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_read</span> <span class="hljs-params">(<span class="hljs-type">int</span> dev, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * buffer, <span class="hljs-type">int</span> try, <span class="hljs-type">int</span> block_size,</span><br><span class="hljs-params">    <span class="hljs-type">blk_t</span> current_block)</span><br>&#123;<br><span class="hljs-type">long</span> got;<br><br>    <span class="hljs-comment">// devè¯»å†™æŒ‡é’ˆcurrent_block * block_size</span><br>ext2fs_llseek (dev, (<span class="hljs-type">ext2_loff_t</span>) current_block * block_size,SEEK_SET);<br><br>    <span class="hljs-comment">// ç³»ç»Ÿè°ƒç”¨readæ¥å£</span><br>got = read (dev, buffer, try * block_size);<br><br>got /= block_size;<br><br><span class="hljs-keyword">return</span> got;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>fuseæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ èµ„æ–™</title>
    <link href="/2023/12/04/fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/"/>
    <url>/2023/12/04/fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/</url>
    
    <content type="html"><![CDATA[<h1 id="fuseæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ èµ„æ–™"><a href="#fuseæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ èµ„æ–™" class="headerlink" title="fuseæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ èµ„æ–™"></a>fuseæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ èµ„æ–™</h1><ul><li><p><a href="https://fishpi.cn/article/1640420458343">è¯¦è§£ FUSE ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ</a></p></li><li><p><a href="https://www.jianshu.com/p/c2b77d0bbc43">FUSEæ¶æ„</a></p></li><li><p><a href="https://zhoubofsy.github.io/2017/01/13/linux/filesystem-userspace-usage/">FUSEä½¿ç”¨å®ä¾‹</a></p></li><li><p><a href="https://juejin.cn/post/7260746629396152379?searchId=20231205221857A49D19E7DB8503104AF8">æ·±å…¥åˆ†æAndroid 11 FUSEæ–‡ä»¶ç³»ç»Ÿ</a></p></li><li><p>âœ…<a href="https://developer.aliyun.com/article/1164554">åŸºäºFUSEçš„ç®€å•æ–‡ä»¶ç³»ç»Ÿ</a></p></li><li><p><a href="https://www.cnblogs.com/pengdonglin137/p/17893209.html">fuseæ­»é”æ¡ˆä¾‹</a></p></li><li><p><a href="https://github.com/wuzhouhui/fs_on_fuse">githubä¸Šå®ç°åŸºäºfuseçš„è‡ªå®šä¹‰æ–‡ä»¶ç³»ç»Ÿå…¨æºç </a></p></li><li><p><a href="https://juejin.cn/post/7206239276894748733">Android Fuseçš„paththroughæ–¹æ¡ˆ</a></p></li><li><p><a href="https://www.jianshu.com/p/9602b3b93528">Android Fuse USBæ–‡ä»¶ç³»ç»Ÿé—®é¢˜åˆ†æ</a></p></li><li><p>âœ…<a href="https://article.juejin.cn/post/7205928315588313146">å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿæ ¸å¿ƒåŸç†</a></p></li></ul><hr><h3 id="ä¸ºä»€ä¹ˆè¦æœ‰ntfs-3g"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰ntfs-3g" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰ntfs-3g"></a>ä¸ºä»€ä¹ˆè¦æœ‰ntfs-3g</h3><p>ntfsæ˜¯Windowsçš„æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨Linuxå¦‚æœè¦è¯»å–ntfsæ ¼å¼çš„Uç›˜å°±å¤±æ•ˆäº†ï¼Œæ‰€ä»¥æœ‰å¤§ç¥å¼€å‘äº†ä¸€ä¸ªntfs-3gæ–‡ä»¶ç³»ç»Ÿï¼Œè¯¥æ–‡ä»¶ç³»ç»ŸåŸºäºfuseæ¶æ„</p><img src="/2023/12/04/fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/webp.webp" alt="img" style="zoom:67%;"><p>ntfs-3gé‡Œé¢å…¶å®å°±æ˜¯ç›´æ¥å¯¹è£¸è®¾å¤‡å³ç±»ä¼¼&#x2F;dev&#x2F;sdbç›´æ¥è¯»å†™ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å°è£…ä¸€å±‚libfuseå‘¢ï¼Ÿå› ä¸ºread&#x2F;writeçš„ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šèµ°åˆ°å†…æ ¸VFSå±‚ï¼Œåœ¨è¿™é‡Œä¼šèµ°åˆ°fuseé©±åŠ¨ä¸­ï¼Œç”±fuseé©±åŠ¨è½¬å‘ç»™ä¸Šå±‚ç”¨æˆ·æ€çš„ntfs-3gã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶f2fs.hç®¡ç†çš„ä½å›¾å’Œ_Iå†…å­˜ä¿¡æ¯</title>
    <link href="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/"/>
    <url>/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶f2fs-hç®¡ç†çš„ä½å›¾å’Œ-Iå†…å­˜ä¿¡æ¯"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶f2fs-hç®¡ç†çš„ä½å›¾å’Œ-Iå†…å­˜ä¿¡æ¯" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶f2fs.hç®¡ç†çš„ä½å›¾å’Œ_Iå†…å­˜ä¿¡æ¯"></a>f2fsæ–‡ä»¶ç³»ç»Ÿå¤´æ–‡ä»¶f2fs.hç®¡ç†çš„ä½å›¾å’Œ_Iå†…å­˜ä¿¡æ¯</h1><h2 id="1-Iå†…å­˜ä¿¡æ¯"><a href="#1-Iå†…å­˜ä¿¡æ¯" class="headerlink" title="1._Iå†…å­˜ä¿¡æ¯"></a>1._Iå†…å­˜ä¿¡æ¯</h2><h3 id="SITå†…å­˜ç®¡ç†-SM-I"><a href="#SITå†…å­˜ç®¡ç†-SM-I" class="headerlink" title="SITå†…å­˜ç®¡ç†(SM_I)"></a>SITå†…å­˜ç®¡ç†(SM_I)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> f2fs_sm_info *<span class="hljs-title function_">SM_I</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> f2fs_sm_info *)(sbi-&gt;sm_info);<br>&#125;<br></code></pre></td></tr></table></figure><p>sbiç®¡ç†äº†SITåœ¨å†…å­˜ä¸­è¡¨ç°å½¢å¼ï¼šå³ç»“æ„ä½“f2fs_sm_info</p><blockquote><p>ä»¥ä¸‹å†…å®¹æ¥æºäºçŸ¥ä¹LZTï¼š<a href="https://zhuanlan.zhihu.com/p/637700821">https://zhuanlan.zhihu.com/p/637700821</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sm_info</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_info</span>;</span>      <span class="hljs-comment">/* whole segment information */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_segmap_info</span> *<span class="hljs-title">free_info</span>;</span> <span class="hljs-comment">/* free segment information */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> *<span class="hljs-title">dirty_info</span>;</span>  <span class="hljs-comment">/* dirty segment information */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg_array</span>;</span>   <span class="hljs-comment">/* active segment information */</span><br><br>    <span class="hljs-type">block_t</span> seg0_blkaddr;       <span class="hljs-comment">/* block address of 0&#x27;th segment */</span><br>    <span class="hljs-type">block_t</span> main_blkaddr;       <span class="hljs-comment">/* start block address of main area */</span><br>    <span class="hljs-type">block_t</span> ssa_blkaddr;        <span class="hljs-comment">/* start block address of SSA area */</span><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segment_count; <span class="hljs-comment">/* total # of segments */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> main_segments; <span class="hljs-comment">/* # of segments in main area */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> reserved_segments; <span class="hljs-comment">/* # of reserved segments */</span><br><br>    <span class="hljs-comment">/* a threshold to reclaim prefree segments */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rec_prefree_segments;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">sit_entry_set</span>;</span> <span class="hljs-comment">/* sit entry set list */</span><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ipu_policy;    <span class="hljs-comment">/* in-place-update policy */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_ipu_util;  <span class="hljs-comment">/* in-place-update threshold */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_fsync_blocks;  <span class="hljs-comment">/* threshold for fsync */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_hot_blocks;    <span class="hljs-comment">/* threshold for hot block allocation */</span><br><br>    <span class="hljs-comment">/* for flush command control */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flush_cmd_control</span> *<span class="hljs-title">fcc_info</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>f2fs_sm_infoæ˜¯å†…å­˜ä¸­ç®¡ç†segmentçš„æ€»ä½“ç»“æ„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾å¯ç”¨çš„blockä»¥åŠé«˜æ•ˆæ‰§è¡Œgcã€discardç­‰æ“ä½œã€‚</p><ul><li>sit_infoï¼šå¯¹åº”çš„æ˜¯ç›˜ä¸Šç»“æ„ï¼Œå°†å†…å­˜ä¸­ä¿®æ”¹çš„å†…å®¹å®šæœŸè½ç›˜ã€‚åŒæ—¶è¿˜æœ‰gcç›¸å…³çš„å†…å®¹ã€‚</li><li>free_infoï¼šè®°å½•Main Areaå„ä¸ªsegmentæ˜¯å¦è¢«ä½¿ç”¨ï¼Œåœ¨mountçš„æ—¶å€™éå†SITè¡¨ï¼Œå°†æ¯ä¸ªsegmentçš„ä½¿ç”¨çŠ¶æ€è®°å½•åœ¨è¯¥bitmapä¸Šã€‚</li><li>dirty_infoï¼šè„segmentçš„åŸºç¡€ä¿¡æ¯ï¼ŒåŒ…æ‹¬segmentæ‰€å±ç±»å‹ï¼Œä½¿ç”¨blockç»Ÿè®¡ç­‰ç­‰ã€‚åœ¨mountçš„æ—¶å€™ï¼Œéå†free_segmapæ‰¾åˆ°å·²ç»è¢«ä½¿ç”¨ä½†è¿˜æœ‰ç©ºé—²ç©ºé—´çš„segmentï¼Œè®°å½•åˆ°dirty_infoä¸­ã€‚</li><li>curseg_arrayï¼šè®°å½•å½“å‰æ­£åœ¨ä½¿ç”¨çš„segmentçš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬segnoã€journalã€seg_typeç­‰ç­‰ï¼Œæ¯ç§ç±»å‹çš„segmentå¯¹åº”ä¸€ä¸ªcurseg_infoä¿¡æ¯ã€‚</li><li>seg0_blkaddrï¼šä¸SuperBlockçš„ä»‹ç»ä¸€æ ·ï¼Œæ˜¯ç¬¬ä¸€ä¸ªsegmentçš„åœ°å€ã€‚</li><li>main_blkaddrï¼šMain Areaçš„å¼€å§‹åœ°å€ã€‚</li><li>ssa_blkaddrï¼šSSAåŒºåŸŸçš„å¼€å§‹åœ°å€ã€‚</li><li>segment_countï¼šå­˜å‚¨è®¾å¤‡çš„segmentæ•°é‡ã€‚</li><li>main_segmentsï¼šMain Areaçš„segmentæ•°é‡ã€‚</li><li>reserved_segmentsï¼šä¸ºgcæµç¨‹ä¿ç•™çš„segmentæ•°é‡ã€‚</li><li>rec_prefree_segmentsï¼šPREç±»å‹çš„segmentçš„é˜ˆå€¼ï¼Œä¸€èˆ¬æ˜¯Main Areaçš„5%ï¼Œå¦‚æœè¶…è¿‡4096ä¸ªï¼Œåˆ™æœ€å¤§åªèƒ½æ˜¯4096ã€‚å¦‚æœPREçš„segmentè¿‡å¤šï¼Œä¼šå¯¼è‡´ç³»ç»Ÿå†…å­˜ç´§å¼ ï¼Œéœ€è¦åŠæ—¶é‡Šæ”¾ã€‚</li><li>sit_entry_setï¼šsit_entryçš„é›†åˆï¼Œç”¨äºCPä¸‹åˆ·æµç¨‹ã€‚</li><li>ipu_policyï¼šIPUå†™æ–¹å¼çš„ç­–ç•¥ï¼ŒåŒ…æ‹¬FORCEã€SSRã€UTILã€FSYNCã€ASYNCç­‰ç­‰ã€‚</li><li>min_ipu_utilï¼šæœ€å°æ‰§è¡ŒIPUå†™ç­–ç•¥é˜ˆå€¼ï¼Œé»˜è®¤æ˜¯70ï¼Œè¡¨ç¤ºå½“blockä½¿ç”¨é‡è¶…è¿‡70%åï¼Œè½¬åŒ–æˆIPUæ¨¡å¼ã€‚</li><li>min_fsync_blocksï¼šé»˜è®¤æ˜¯8ï¼Œè¡¨ç¤ºinodeçš„è„æ•°æ®å°äº8ä¸ªblockï¼Œåœ¨fsyncçš„æ—¶å€™ï¼Œä¼˜å…ˆè€ƒè™‘IPUæ¨¡å¼ã€‚</li><li>min_hot_blocksï¼šé»˜è®¤æ˜¯16ï¼Œè¡¨ç¤ºæŸä¸ªinodeä¸­è„æ•°æ®è¶…è¿‡16ä¸ªblockï¼Œåˆ™å°†inodeè®¾ç½®æˆHOT_DATAç±»å‹ï¼ˆvfså±‚æœ‰ä¼˜åŒ–ï¼Ÿï¼Ÿï¼Ÿï¼‰ã€‚</li><li>fcc_infoï¼šå¯¹è®¾å¤‡æ‰§è¡Œflushå‘½ä»¤çš„ä»»åŠ¡ï¼Œå¯¹äºä¸èƒ½ä¿è¯cacheè½ç›˜çš„è®¾å¤‡ï¼Œè¿™ç§è®¾å¤‡ä¸€èˆ¬æä¾›flushå‘½ä»¤ï¼Œéœ€è¦æ–‡ä»¶ç³»ç»Ÿåœ¨é€‚å½“æ—¶å€™å°†cacheè½ç›˜ã€‚</li></ul><h3 id="NATå†…å­˜ç®¡ç†-NM-I"><a href="#NATå†…å­˜ç®¡ç†-NM-I" class="headerlink" title="NATå†…å­˜ç®¡ç†(NM_I)"></a>NATå†…å­˜ç®¡ç†(NM_I)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> f2fs_nm_info *<span class="hljs-title function_">NM_I</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> f2fs_nm_info *)(sbi-&gt;nm_info);<br>&#125;<br></code></pre></td></tr></table></figure><p>sbiç®¡ç†äº†NATåœ¨å†…å­˜ä¸­è¡¨ç°å½¢å¼ï¼šå³ç»“æ„ä½“f2fs_nm_info</p><blockquote><p>ä»¥ä¸‹å†…å®¹æ¥æºäºçŸ¥ä¹LZTï¼š<a href="https://zhuanlan.zhihu.com/p/638025789">https://zhuanlan.zhihu.com/p/638025789</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> &#123;</span><br>    <span class="hljs-type">block_t</span> nat_blkaddr;        <span class="hljs-comment">/* base disk address of NAT */</span><br>    <span class="hljs-type">nid_t</span> max_nid;          <span class="hljs-comment">/* maximum possible node ids */</span><br>    <span class="hljs-comment">// ä¸‹ä¸€ä¸ªå°†è¦è¢«æ‰«é¢çš„node idï¼Œç”¨äºè½®è¯¢NATåŒºåŸŸï¼ˆä¸ºäº†ç£¨æŸå‡è¡¡ï¼Ÿï¼‰</span><br>    <span class="hljs-type">nid_t</span> next_scan_nid;        <span class="hljs-comment">/* the next nid to be scanned */</span><br><br>    <span class="hljs-comment">/* NAT cache management */</span><br>    <span class="hljs-comment">// ç¼“å­˜éƒ¨åˆ†nat_entryï¼Œç”¨äºåŠ å¿«æŸ¥æ‰¾æ•ˆç‡ï¼Œé¿å…æ€»æ˜¯è¦ä»å­˜å‚¨ä»‹è´¨ä¸­è¯»å–</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span> <span class="hljs-title">nat_root</span>;</span><span class="hljs-comment">/* root of the nat entry cache */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">nat_entries</span>;</span>   <span class="hljs-comment">/* cached nat entry list (clean) */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nat_cnt[MAX_NAT_STATE]; <span class="hljs-comment">/* the # of cached nat entries */</span><br>    <span class="hljs-comment">// NATåŒºåŸŸæ‰€åŒ…å«çš„blockæ•°ç›®ï¼Œåœ¨mkfsçš„æ—¶å€™å·²ç»ç¡®å®š</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nat_blocks;    <span class="hljs-comment">/* # of nat blocks */</span><br><br>    <span class="hljs-comment">/* free node ids management */</span><br>    <span class="hljs-comment">// TODOï¼šé€šè¿‡çº¢é»‘æ ‘ç¼“å­˜free nidï¼Œä¸ºäº†åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦ï¼Ÿ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span> <span class="hljs-title">free_nid_root</span>;</span><span class="hljs-comment">/* root of the free_nid cache */</span><br>    <span class="hljs-comment">// TODOï¼šç¼“å­˜ä¸€äº›å·²ç»è¢«é‡Šæ”¾çš„node blockï¼Ÿ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">free_nid_list</span>;</span>     <span class="hljs-comment">/* list for free nids excluding preallocated nids */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nid_cnt[MAX_NID_STATE];    <span class="hljs-comment">/* the number of free node id */</span><br>    <span class="hljs-comment">// bitmap: è®°å½•dataåŒºåŸŸæ¯ä¸ªnodeæ˜¯å¦è¢«ä½¿ç”¨ï¼ˆæˆ–è€…è¯´æ¯ä¸ªnode idæ˜¯å¦è¢«å ç”¨ï¼‰</span><br>    <span class="hljs-comment">// æ³¨æ„ï¼šfree_nid_bitmapè¦é…åˆnat_block_bitmapä½¿ç”¨</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **free_nid_bitmap;<br>    <span class="hljs-comment">// è®°å½•å½“å‰å¯ç”¨çš„nat block</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *nat_block_bitmap;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *free_nid_count; <span class="hljs-comment">/* free nid count of NAT block */</span><br><br>    <span class="hljs-comment">/* for checkpoint */</span><br>    <span class="hljs-type">char</span> *nat_bitmap;       <span class="hljs-comment">/* NAT bitmap pointer */</span><br>    <span class="hljs-type">int</span> bitmap_size;        <span class="hljs-comment">/* bitmap size */</span><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nat_bits_blocks;   <span class="hljs-comment">/* # of nat bits blocks */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *nat_bits;    <span class="hljs-comment">/* NAT bits blocks */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *full_nat_bits;   <span class="hljs-comment">/* full NAT pages */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *empty_nat_bits;  <span class="hljs-comment">/* empty NAT pages */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>f2fs_nm_infoæ˜¯å†…å­˜ä¸­ç®¡ç†NATçš„æ€»ä½“ç»“æ„ã€‚å¯¹åº”nodeçš„ä¿®æ”¹ï¼Œä¼šè¢«ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç­‰åˆ°åˆé€‚æ—¶æœºæ‰ä¼šçœŸæ­£è½ç›˜ã€‚</p><ul><li>nat_blkaddrï¼šNATåŒºåŸŸçš„å¼€å§‹åœ°å€ã€‚</li><li>max_nidï¼šç³»ç»Ÿä¸­èƒ½ä½¿ç”¨çš„æœ€å¤§node idå·ã€‚</li><li>next_scan_nidï¼šä¸‹ä¸€ä¸ªå¾…æ‰«æçš„node idå·ã€‚</li><li>nat_rootï¼šé€šè¿‡çº¢é»‘æ ‘çš„æ–¹å¼ç¼“å­˜nat entryï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°æŸä¸ªnodeçš„ä¿¡æ¯ã€‚</li><li>nat_entriesï¼šç¼“å­˜æ­£åœ¨ä½¿ç”¨çš„nat_entryã€‚</li><li>nat_cntï¼šæ­£åœ¨ç¼“å­˜net_entryçš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬è„entryä¸ªæ•°ã€å¾…å›æ”¶çš„ä¸ªæ•°ç­‰ç­‰ã€‚</li><li>nat_blocksï¼šNATåŒºåŸŸæ‰€å ç”¨çš„blockæ•°é‡ã€‚</li><li>free_nid_bitmapï¼šè®°å½•æ¯ä¸ªnat_entryçš„ä½¿ç”¨æƒ…å†µã€‚</li><li>nat_block_bitmapï¼šè®°å½•æ¯ä¸ªnat_entry blockçš„ä½¿ç”¨æƒ…å†µã€‚</li><li>free_nid_countï¼šè®°å½•æ¯ä¸ªnat_blockç©ºé—²çš„nat entryæ•°é‡ã€‚</li><li>nat_bitmapï¼šè®°å½•nat_entryä½¿ç”¨çš„æ˜¯ä¸»åŒºè¿˜æ˜¯å¤‡åŒºã€‚</li><li>bitmap_sizeï¼šè®°å½•nat_bitmapçš„å¤§å°ã€‚</li><li>nat_bits_blocksï¼šå­˜æ”¾åœ¨CPåŒºåŸŸçš„nat_bitsæ‰€å ç”¨çš„blockæ•°ç›®ã€‚</li><li>nat_bitsï¼šå­˜æ”¾åœ¨CPåŒºåŸŸï¼ŒåŒ…æ‹¬cp_version + full_nat_bits + empty_nat_bitsä¸‰éƒ¨åˆ†ã€‚</li><li>full_nat_bitsï¼šè®°å½•NATåŒºåŸŸæŸä¸ªblockå¯ç”¨nat_entryå·²ç»ç”¨å®Œã€‚</li><li>empty_nat_bitsï¼šè®°å½•NATåŒºåŸŸæŸä¸ªblockè¿˜æ²¡æœ‰ä½¿ç”¨è¿‡nat_entryã€‚</li></ul><h3 id="è„Segmentç®¡ç†-DIRTY-I"><a href="#è„Segmentç®¡ç†-DIRTY-I" class="headerlink" title="è„Segmentç®¡ç†(DIRTY_I)"></a>è„Segmentç®¡ç†(DIRTY_I)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> dirty_seglist_info *<span class="hljs-title function_">DIRTY_I</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> dirty_seglist_info *)(SM_I(sbi)-&gt;dirty_info);<br>&#125;<br></code></pre></td></tr></table></figure><p>sbiç®¡ç†äº†segment info(å³ç»“æ„ä½“f2fs_sm_info)å¯¹åº”çš„å†…å­˜ä¿¡æ¯ï¼Œè€Œf2fs_sm_infoåˆç®¡ç†äº†è„segmentä¿¡æ¯dirty_seglist_info</p><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203221359946.png" alt="image-20231203221359946" style="zoom:67%;"><ul><li><p>v_opsä¸ºvictimé€‰æ‹©çš„é’©å­å‡½æ•°</p></li><li><p>dirty_segmentç”¨æ¥ç®¡ç†è„segmentçš„ä½å›¾ï¼Œæ€»å…±ç®¡ç†äº†6ç§ç±»å‹çš„è„Segment(HOT&#x2F;WARM&#x2F;COLD Ã— NODE&#x2F;DATA)å’Œ2ç§çŠ¶æ€çš„Segmentï¼ˆpre-freeå’Œdirtyï¼‰ï¼›æ¯ä¸ªä½å›¾çš„å¤§å°éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œéƒ½ç­‰äºmain_segmentsçš„æ•°é‡</p><ul><li><p>ä»¥ä¸‹ä¸º6ç§ç±»å‹çš„è„Segmentä½å›¾</p></li><li><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231127224936323.png" alt="image-20231127224936323" style="zoom:67%;"></li><li><p>ä½å›¾çš„åˆå§‹åŒ–ä½äºf2fsæ–‡ä»¶ç³»ç»Ÿæ—¶å¡«å……super blockæ—¶å»ºç«‹segmentç®¡ç†å™¨çš„æ—¶å€™è°ƒç”¨<code>build_dirty_segmap</code></p></li></ul></li></ul><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203222111509.png" alt="image-20231203222111509" style="zoom:67%;"><ul><li>nr_dirtyç®¡ç†äº†6ç§è„Segmentå’Œ2ç§çŠ¶æ€çš„è„Segmentçš„ä¸ªæ•°ã€‚</li></ul><h3 id="ç©ºé—²Segmentç®¡ç†-FREE-I"><a href="#ç©ºé—²Segmentç®¡ç†-FREE-I" class="headerlink" title="ç©ºé—²Segmentç®¡ç†(FREE_I)"></a>ç©ºé—²Segmentç®¡ç†(FREE_I)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> free_segmap_info *<span class="hljs-title function_">FREE_I</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> free_segmap_info *)(SM_I(sbi)-&gt;free_info);<br>&#125;<br></code></pre></td></tr></table></figure><p>sbiç®¡ç†äº†segment info(å³ç»“æ„ä½“f2fs_sm_info)å¯¹åº”çš„å†…å­˜ä¿¡æ¯ï¼Œè€Œf2fs_sm_infoåˆç®¡ç†äº†è„segmentä¿¡æ¯free_segmap_info</p><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203222634516.png" alt="image-20231203222634516" style="zoom:67%;"><h2 id="2-ä½å›¾ç®¡ç†"><a href="#2-ä½å›¾ç®¡ç†" class="headerlink" title="2.ä½å›¾ç®¡ç†"></a>2.ä½å›¾ç®¡ç†</h2><h3 id="è„Segmentä½å›¾-dirty-segment"><a href="#è„Segmentä½å›¾-dirty-segment" class="headerlink" title="è„Segmentä½å›¾(dirty_segment)"></a>è„Segmentä½å›¾(dirty_segment)</h3><ul><li><p>dirty_segmentç”¨æ¥ç®¡ç†è„segmentçš„ä½å›¾ï¼Œæ€»å…±ç®¡ç†äº†6ç§ç±»å‹çš„è„Segment(HOT&#x2F;WARM&#x2F;COLD Ã— NODE&#x2F;DATA)å’Œ2ç§çŠ¶æ€çš„Segmentï¼ˆpre-freeå’Œdirtyï¼‰ï¼›æ¯ä¸ªä½å›¾çš„å¤§å°éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œéƒ½ç­‰äºmain_segmentsçš„æ•°é‡</p><ul><li><p>ä»¥ä¸‹ä¸º6ç§ç±»å‹çš„è„Segmentä½å›¾</p></li><li><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231127224936323.png" alt="image-20231127224936323" style="zoom:67%;"></li><li><p>ä½å›¾çš„åˆå§‹åŒ–ä½äºf2fsæ–‡ä»¶ç³»ç»Ÿæ—¶å¡«å……super blockæ—¶å»ºç«‹segmentç®¡ç†å™¨çš„æ—¶å€™è°ƒç”¨<code>build_dirty_segmap</code></p></li></ul></li></ul><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203222111509.png" alt="image-20231203222111509" style="zoom:67%;"><h2 id="3-åŸºæ•°æ ‘æ˜ å°„"><a href="#3-åŸºæ•°æ ‘æ˜ å°„" class="headerlink" title="3.åŸºæ•°æ ‘æ˜ å°„"></a>3.åŸºæ•°æ ‘æ˜ å°„</h2><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203225436920.png" alt="image-20231203225436920" style="zoom:67%;"><h3 id="Nodeé¡µæ˜ å°„"><a href="#Nodeé¡µæ˜ å°„" class="headerlink" title="Nodeé¡µæ˜ å°„"></a>Nodeé¡µæ˜ å°„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> address_space *<span class="hljs-title function_">NODE_MAPPING</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> sbi-&gt;node_inode-&gt;i_mapping;<br>&#125;<br></code></pre></td></tr></table></figure><p>f2fsæ–‡ä»¶ç³»ç»Ÿçš„1å·å…ƒæ•°æ®node inodeç”¨ç®¡ç†æ‰€æœ‰ç¼“å­˜çš„node pageé¡µä¿¡æ¯</p><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203230542715.png" alt="image-20231203230542715" style="zoom: 67%;"><h3 id="å…ƒæ•°æ®æ˜ å°„"><a href="#å…ƒæ•°æ®æ˜ å°„" class="headerlink" title="å…ƒæ•°æ®æ˜ å°„"></a>å…ƒæ•°æ®æ˜ å°„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> address_space *<span class="hljs-title function_">META_MAPPING</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> sbi-&gt;meta_inode-&gt;i_mapping;<br>&#125;<br></code></pre></td></tr></table></figure><p>f2fsæ–‡ä»¶ç³»ç»Ÿçš„2å·å…ƒæ•°æ®mode inodeç”¨ç®¡ç†æ‰€æœ‰ç¼“å­˜çš„å…ƒæ•°æ®é¡µä¿¡æ¯</p><img src="/2023/12/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%B4%E6%96%87%E4%BB%B6f2fs-h%E7%AE%A1%E7%90%86%E7%9A%84%E4%BD%8D%E5%9B%BE%E5%92%8C-I%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF/image-20231203225928807.png" alt="image-20231203225928807" style="zoom: 67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿgcåƒåœ¾å›æ”¶</title>
    <link href="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    <url>/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿgcåƒåœ¾å›æ”¶"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿgcåƒåœ¾å›æ”¶" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿgcåƒåœ¾å›æ”¶"></a>f2fsæ–‡ä»¶ç³»ç»Ÿgcåƒåœ¾å›æ”¶</h1><h2 id="1-SSDåƒåœ¾å›æ”¶ç®€ä»‹"><a href="#1-SSDåƒåœ¾å›æ”¶ç®€ä»‹" class="headerlink" title="1.SSDåƒåœ¾å›æ”¶ç®€ä»‹"></a>1.SSDåƒåœ¾å›æ”¶ç®€ä»‹</h2><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/v2-887eb43aa793e4ddd190ffeb53a1f66b_r.jpg" alt="img" style="zoom:67%;"><p>å›¾ç‰‡æºè‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/639777178">https://zhuanlan.zhihu.com/p/639777178</a></p><h2 id="2-åƒåœ¾å›æ”¶æ€æƒ³åŠè®ºæ–‡æè¿°"><a href="#2-åƒåœ¾å›æ”¶æ€æƒ³åŠè®ºæ–‡æè¿°" class="headerlink" title="2.åƒåœ¾å›æ”¶æ€æƒ³åŠè®ºæ–‡æè¿°"></a>2.åƒåœ¾å›æ”¶æ€æƒ³åŠè®ºæ–‡æè¿°</h2><h3 id="2-1-åƒåœ¾å›æ”¶åŸºæœ¬æ€æƒ³"><a href="#2-1-åƒåœ¾å›æ”¶åŸºæœ¬æ€æƒ³" class="headerlink" title="2.1 åƒåœ¾å›æ”¶åŸºæœ¬æ€æƒ³"></a>2.1 åƒåœ¾å›æ”¶åŸºæœ¬æ€æƒ³</h3><p>æˆ‘ä»¬æŠŠF2FSçš„åƒåœ¾å›æ”¶æ¯”ä½œå·¥å‚å¤§è¿ç§»ï¼Œå‡è®¾åœ¨äº¬è‚¯å¾·åŸºé—¨åº—ï¼Œç”±äºç”Ÿæ„ä¸å¥½ï¼Œå‡†å¤‡è¿ç§»åˆ°ä¸Šæµ·å»ï¼Œé‚£ä¹ˆä½œä¸ºè€æ¿è‚¯å®šè¦åšä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p><ul><li>ã€ç›®æ ‡é€‰æ‹©ã€‘é€‰æ‹©å“ªäº›é—¨åº—è¦è¿èµ°ï¼Œåœ¨å—äº¬æœ‰è®¸å¤šçš„è‚¯å¾·åŸºï¼Œè‚¯å®šæ˜¯é€‰æ‹©äººæµé‡æœ€å°‘çš„è¿èµ°ï¼Œæ¯”å¦‚è¯´é›¨èŠ±å°åŒºçš„è‚¯å¾·åŸº</li><li>ã€æ•°æ®è¿ç§»ã€‘æ¸…ç‚¹ä¸€ä¸‹é›¨èŠ±å°åŒºæ€»å…±æœ‰å¤šå°‘å®¶é—¨åº—ï¼Œç„¶åå°†ä»–è¿ç§»åˆ°ä¸Šæµ·çš„é—¨åº—ä¸­å»</li><li>ã€åç»­æ¸…ç†ã€‘é›¨èŠ±å°åŒºçš„è‚¯å¾·åŸºé—¨åº—å·²ç»æ¬èµ°äº†ï¼Œæˆ‘ä»¬å¾—æŠŠé—¨é¢è£…ä¿®å•¥çš„ç»Ÿç»Ÿæ¸…ç†ä¸€éï¼Œè¿™æ ·æ‰ä¼šæœ‰å…¶ä»–å•†å®¶æ‹›å•†å…¥é©»</li></ul><h3 id="2-2-è®ºæ–‡æè¿°"><a href="#2-2-è®ºæ–‡æè¿°" class="headerlink" title="2.2 è®ºæ–‡æè¿°"></a>2.2 è®ºæ–‡æè¿°</h3><p>f2fsè®ºæ–‡æ˜¯è¿™ä¹ˆæè¿°åƒåœ¾å›æ”¶æœºåˆ¶çš„ï¼š</p><ol><li>Victim Selectionï¼šã€ç›®æ ‡é€‰æ‹©ã€‘</li></ol><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231130223739664.png" alt="image-20231130223739664" style="zoom: 67%;"><ol start="2"><li>Valid block identfication and migrationï¼šã€æ•°æ®è¿ç§»ã€‘</li></ol><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231130223754438.png" alt="image-20231130223754438" style="zoom: 67%;"><ol start="3"><li>Post-cleaning processï¼šã€åç»­æ¸…ç†ã€‘</li></ol><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231130223841049.png" alt="image-20231130223841049" style="zoom:67%;"><h2 id="3-åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†"><a href="#3-åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†" class="headerlink" title="3.åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†"></a>3.åƒåœ¾å›æ”¶åŸºç¡€çŸ¥è¯†</h2><h3 id="3-1-åƒåœ¾å›æ”¶åˆ†ç±»"><a href="#3-1-åƒåœ¾å›æ”¶åˆ†ç±»" class="headerlink" title="3.1 åƒåœ¾å›æ”¶åˆ†ç±»"></a>3.1 åƒåœ¾å›æ”¶åˆ†ç±»</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * BG_GC means the background cleaning job.</span><br><span class="hljs-comment"> * FG_GC means the on-demand cleaning job.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    BG_GC = <span class="hljs-number">0</span>,<br>    FG_GC,<br>&#125;;<br></code></pre></td></tr></table></figure><p>f2fsæ”¯æŒä¸¤ç§ç±»å‹çš„GCï¼Œåˆ†åˆ«æ˜¯åå°GCï¼ˆBG_GCï¼‰å’Œå‰å°GCï¼ˆFG_GCï¼‰ã€‚åå°GCä»¥çº¿ç¨‹åŒ–æ‰§è¡Œçš„æ–¹å¼è¿›è¡Œï¼Œåœ¨åå°ä»»åŠ¡ä¸­å®šæœŸæ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ç³»ç»Ÿï¼Œåœ¨ç³»ç»Ÿç©ºé—²ï¼ˆæ²¡æœ‰IOæ“ä½œï¼‰æ—¶æ‰§è¡Œï¼Œå¯è¢«éšæ—¶è¢«ç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸èƒ½ä¿è¯èƒ½å›æ”¶åˆ°ç©ºé—´ã€‚å‰å°GCæ˜¯åœ¨ç³»ç»Ÿç©ºé—´ç´§ç¼ºæ—¶ï¼Œä¸ºäº†ç¡®ä¿å›æ”¶åˆ°ç©ºé—´è€Œæ‰§è¡Œçš„é˜»å¡æ“ä½œï¼Œæœ€æ–°çš„å®ç°ä¸­ï¼Œå‰å°ç©ºé—´ä¹Ÿæ”¯æŒçº¿ç¨‹åŒ–æ‰§è¡Œï¼ˆå¦‚æœä½¿ç”¨GC_MERGEæŒ‚è½½é€‰é¡¹ï¼‰ã€‚</p><h3 id="3-2-GCç­–ç•¥"><a href="#3-2-GCç­–ç•¥" class="headerlink" title="3.2 GCç­–ç•¥"></a>3.2 GCç­–ç•¥</h3><h4 id="3-2-1-Greedyç®—æ³•"><a href="#3-2-1-Greedyç®—æ³•" class="headerlink" title="3.2.1 Greedyç®—æ³•"></a>3.2.1 Greedyç®—æ³•</h4><p>F2FS æ‰§è¡Œ foreground gc æ—¶é‡‡ç”¨ Greedy ç®—æ³•ã€‚</p><p>ä¸ºå®ç° Greedy ç®—æ³•ï¼ŒF2FS ç»´æŠ¤ä¸€å¼ è®°å½•æ¯ä¸€ä¸ª section ä¸­æœ‰æ•ˆ block æ•°çš„å…ƒæ•°æ®è¡¨ï¼Œæ‰§è¡Œ gc æ“ä½œæ—¶ï¼Œæ ¹æ®è¿™ä¸ªå…ƒæ•°æ®è¡¨æ‰¾å‡ºæœ‰æ•ˆ block æ•°æœ€å°‘çš„ n ä¸ª section ä½œä¸º victimã€‚</p><p>ç›´è§‚åœ°è¯´ï¼ŒGreedyç®—æ³•èƒ½ä½¿gcæ—¶è¿ç§»çš„æœ‰æ•ˆå—æ•°æœ€å°‘ï¼Œä»è€Œå¼€é”€æœ€å°ï¼Œæ‰€ä»¥ F2FS åœ¨ foreground gc æ—¶é‡‡ç”¨ Greedy ç®—æ³•ï¼Œæœ€å°åŒ–åº”ç”¨èƒ½æ„ŸçŸ¥çš„å»¶è¿Ÿã€‚</p><h4 id="3-2-2-Cost-Benefit-ç®—æ³•"><a href="#3-2-2-Cost-Benefit-ç®—æ³•" class="headerlink" title="3.2.2 Cost-Benefit ç®—æ³•"></a>3.2.2 Cost-Benefit ç®—æ³•</h4><p>F2FS åœ¨æ‰§è¡Œ background gc æ—¶é‡‡ç”¨ Cost-Benefit ç®—æ³•ï¼Œä¸»è¦æ€æƒ³æ˜¯è®¡ç®—å‡ºæ¯ä¸ª section çš„è¿ç§»å¼€é”€ï¼Œé€‰åœ¨å¼€é”€æœ€å°çš„ n ä¸ªsection ä½œä¸º victimï¼Œå¼€é”€çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<code>cost = (1âˆ’Î¼) / 2Î¼ âˆ— age</code>ï¼Œå…¶ä¸­ï¼š</p><ul><li>u ä»£è¡¨ valid block åœ¨è¯¥ section ä¸­çš„æ¯”ä¾‹ï¼Œage ä»£è¡¨è¯¥ section è·ç¦»æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ï¼›</li><li>1-u æ˜¯å¯¹è¿™ä¸ª section è¿›è¡Œ gc ä»¥åèƒ½å¤Ÿè·å¾— free block çš„æ•°é‡ï¼›</li><li>2u æ˜¯å¯¹è¿™ä¸ª section è¿›è¡Œ gc çš„å¼€é”€ï¼Œè¯»å– Valid blockï¼ˆ1ä¸ªuï¼‰ç„¶åå†™å…¥åˆ°æ–°çš„ section ï¼ˆå†1ä¸ªuï¼‰ï¼›</li></ul><p>æ‰€ä»¥ï¼ˆ1-uï¼‰&#x2F; 2u å¯ä»¥ç†è§£ä¸ºæŠ•å…¥äº§å‡ºæ¯”ã€‚</p><p>F2FS éœ€è¦åœ¨ç»´æŠ¤çš„å…ƒæ•°æ®è¡¨é‡Œï¼Œè®°å½•æ¯ä¸ª section æœ€åä¸€æ¬¡è¢«å†™å…¥çš„æ—¶é—´ï¼Œgc æ—¶é€‰æ‹©æ›´ä¹…æ²¡æœ‰è¢«ä¿®æ”¹çš„sectionï¼ˆå†·æ•°æ®ï¼‰ä½œä¸º victimã€‚</p><p>è¯¥ç­–ç•¥å°±æ˜¯é€‰æ‹©æŠ•å…¥äº§å‡ºæ¯”æ›´é«˜ï¼Œæœªä¿®æ”¹æ—¶é—´æ›´é•¿çš„ section è¿›è¡Œ gcï¼Œä¸¤è€…ç›¸ä¹˜æ•°å­—æ›´å¤§çš„ä¼˜å…ˆè¢« gcã€‚</p><h3 id="3-3-è„Segmentç»´æŠ¤çš„æ•°æ®ç»“æ„"><a href="#3-3-è„Segmentç»´æŠ¤çš„æ•°æ®ç»“æ„" class="headerlink" title="3.3 è„Segmentç»´æŠ¤çš„æ•°æ®ç»“æ„"></a>3.3 è„Segmentç»´æŠ¤çš„æ•°æ®ç»“æ„</h3><p><code>struct f2fs_sm_info</code> ä¸»è¦ç»´æŠ¤äº†æ–‡ä»¶ç³»ç»Ÿçš„è„segmentä¿¡æ¯ï¼ŒåŒ…æ‹¬ dirty å’Œ prefreeï¼Œå…·ä½“æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">victim_selection</span> *<span class="hljs-title">v_ops</span>;</span><span class="hljs-comment">/* victim selction operation */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *dirty_segmap[NR_DIRTY_TYPE];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *dirty_secmap;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">seglist_lock</span>;</span><span class="hljs-comment">/* lock for segment bitmaps */</span><br><span class="hljs-type">int</span> nr_dirty[NR_DIRTY_TYPE];<span class="hljs-comment">/* # of dirty segments */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *victim_secmap;<span class="hljs-comment">/* background GC victims */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>f2fsæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ç»“æ„ä½“dirty_seglist_infoç»´æŠ¤è„Segmentï¼Œå…¶ä¸­æœ‰2ä¸ªæ¯”è¾ƒé‡è¦çš„å˜é‡éœ€è¦ç•™æ„ï¼šdirty_segmapå’Œnr_dirtyï¼›</p><ul><li>dirty_segmapä¸­ç»´æŠ¤çš„æ˜¯è„Segmentçš„çŠ¶æ€ï¼ŒSegmentåˆ†ä¸ºNodeå’ŒDataä¸¤ç§ç±»å‹ï¼Œåˆåˆ†ä¸ºä¸‰ç§çŠ¶æ€ï¼šdirty-&gt;pre-free-&gt;free</li></ul><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231202203311290.png" alt="image-20231202203311290" style="zoom: 67%;"><p>åœ¨<a href="https://anmuxixixi.github.io/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/#3-1-%E7%A1%AE%E5%AE%9Avictim-sel-policy%E5%8F%82%E6%95%B0">ç¡®å®švictim_sel_policyå‚æ•°</a>æ–‡ç« ä¸­ï¼Œæˆ‘é˜è¿°äº†6ç§DIRTYçš„Node&#x2F;Data Segementï¼Œè¿™æ¬¡ä»‹ç»DIRTYå’ŒPREä¸¤ç§çŠ¶æ€ï¼ˆçŠ¶æ€ä¸åŒºåˆ†Data&#x2F;Nodeï¼‰</p><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231202204113251.png" alt="image-20231202204113251" style="zoom:67%;"><p>å½“ä¸€ä¸ªSegmentä¸­ä½¿ç”¨çš„å—valid_blocksä¸º0ï¼Œå¾…ä¸‹åˆ·çš„å—ä¸ºckpt_valid_blocksä¸º512æ—¶ï¼Œè¯´æ˜è¿™ä¸ªSegmentä¸­çš„blockå·²ç»è¿ç§»å®Œæˆç­‰å¾…æ¸…ç†ï¼Œæ­¤æ—¶çŠ¶æ€ä¸ºPRE-FREEï¼</p><ul><li>nr_dirtyä¸ºåˆ—è¡¨ï¼Œä¿å­˜äº†è„Segmentçš„ä¸ªæ•°ï¼Œä¾‹å¦‚nr_dirty[DIRTY_HOT_DATA]è¡¨ç¤ºçš„æ˜¯å½“å‰ç¯å¢ƒä¸­è„çš„HOT_DATAçš„Segmentçš„ä¸ªæ•°</li></ul><h2 id="4-ç¡¬å•ƒä»£ç "><a href="#4-ç¡¬å•ƒä»£ç " class="headerlink" title="4.ç¡¬å•ƒä»£ç "></a>4.ç¡¬å•ƒä»£ç </h2><p>ç†è§£äº†åƒåœ¾å›æ”¶çš„åŸºæœ¬æ€æƒ³ï¼Œæˆ‘ä»¬æŠŠåƒåœ¾å›æ”¶å®šä¹‰ä¸ºä¸‰æ­¥èµ°ï¼šã€ç›®æ ‡é€‰æ‹©ã€‘-&gt; ã€æ•°æ®è¿ç§»ã€‘-&gt; ã€åç»­æ¸…æµã€‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_gc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">bool</span> sync,</span><br><span class="hljs-params"><span class="hljs-type">bool</span> background, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno)</span><br>&#123;<br><span class="hljs-type">int</span> gc_type = sync ? FG_GC : BG_GC;<br><br>cpc.reason = __get_cp_reason(sbi);<br><br>ret = __get_victim(sbi, &amp;segno, gc_type);<br><br>seg_freed = do_garbage_collect(sbi, segno, &amp;gc_list, gc_type);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-1-ã€ç›®æ ‡é€‰æ‹©ã€‘"><a href="#4-1-ã€ç›®æ ‡é€‰æ‹©ã€‘" class="headerlink" title="4.1 ã€ç›®æ ‡é€‰æ‹©ã€‘"></a>4.1 ã€ç›®æ ‡é€‰æ‹©ã€‘</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __get_victim(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *victim,<br><span class="hljs-type">int</span> gc_type)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_i</span> =</span> SIT_I(sbi);<br>    <span class="hljs-type">int</span> ret;<br>ret = DIRTY_I(sbi)-&gt;v_ops-&gt;get_victim(sbi, victim, gc_type, NO_CHECK_TYPE, LFS, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231130225728130.png" alt="image-20231130225728130" style="zoom:67%;"><p>å¦‚ä½•é€‰æ‹©æˆ‘ä»¬è¦å›æ”¶çš„Victimã€æ³¨æ„ï¼ŒGCçš„åŸºæœ¬å•ä½ä¸ºSectionï¼Œä½†æ˜¯é€šå¸¸Section&#x3D;Segmentã€‘ï¼Œå‚è€ƒæˆ‘çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://anmuxixixi.github.io/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/#3-Victim%E9%80%89%E6%8B%A9">Victimé€‰æ‹©</a></p><h3 id="4-2-ã€æ•°æ®è¿ç§»ã€‘"><a href="#4-2-ã€æ•°æ®è¿ç§»ã€‘" class="headerlink" title="4.2 ã€æ•°æ®è¿ç§»ã€‘"></a>4.2 ã€æ•°æ®è¿ç§»ã€‘</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_garbage_collect</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> start_segno,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> gc_inode_list *gc_list, <span class="hljs-type">int</span> gc_type)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">sum_page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary_block</span> *<span class="hljs-title">sum</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> <span class="hljs-title">plug</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno = start_segno;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> end_segno = start_segno + sbi-&gt;segs_per_sec;<br><span class="hljs-type">int</span> seg_freed = <span class="hljs-number">0</span>, migrated = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> type = IS_DATASEG(get_seg_entry(sbi, segno)-&gt;type) ? SUM_TYPE_DATA : SUM_TYPE_NODE;<br><br><span class="hljs-keyword">for</span> (segno = start_segno; segno &lt; end_segno; segno++) &#123;<br>        <span class="hljs-comment">// æ‰¾åˆ°summary pageé¡µ</span><br>sum_page = find_get_page(META_MAPPING(sbi), GET_SUM_BLOCK(sbi, segno));<br>sum = page_address(sum_page);<br><br><span class="hljs-keyword">if</span> (type == SUM_TYPE_NODE)<br>submitted += gc_node_segment(sbi, sum-&gt;entries, segno, gc_type);<br><span class="hljs-keyword">else</span><br>submitted += gc_data_segment(sbi, sum-&gt;entries, gc_list, segno, gc_type);<br>&#125;<br><br><span class="hljs-keyword">return</span> seg_freed;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-1-nodeé¡µè¿ç§»"><a href="#4-2-1-nodeé¡µè¿ç§»" class="headerlink" title="4.2.1 nodeé¡µè¿ç§»"></a>4.2.1 nodeé¡µè¿ç§»</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">gc_node_segment</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno, <span class="hljs-type">int</span> gc_type)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> *<span class="hljs-title">entry</span>;</span><br><span class="hljs-type">block_t</span> start_addr;<br><span class="hljs-type">int</span> off;<br><span class="hljs-type">int</span> phase = <span class="hljs-number">0</span>;<br><span class="hljs-type">bool</span> fggc = (gc_type == FG_GC);<br><span class="hljs-type">int</span> submitted = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// è¿™é‡Œçš„usable_blks_in_segå°±æ˜¯ä¸€ä¸ªsegmentä¸­å«æœ‰çš„blockæ•°ç›®ï¼Œå›ºå®šä¸º512</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usable_blks_in_seg = f2fs_usable_blks_in_seg(sbi, segno);<br><br>start_addr = START_BLOCK(sbi, segno);<br><br>next_step:<br>entry = sum;<br><br><span class="hljs-keyword">for</span> (off = <span class="hljs-number">0</span>; off &lt; usable_blks_in_seg; off++, entry++) &#123;<br><span class="hljs-type">nid_t</span> nid = le32_to_cpu(entry-&gt;nid);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">node_page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_info</span> <span class="hljs-title">ni</span>;</span><br><br>        <span class="hljs-comment">// é¦–å…ˆåˆ¤æ–­è¿™ä¸ªblockåœ¨ä½å›¾ä¸­æ˜¯å¦ä¸º1</span><br><span class="hljs-keyword">if</span> (check_valid_map(sbi, segno, off) == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (phase == <span class="hljs-number">0</span>) &#123;<br>f2fs_ra_meta_pages(sbi, NAT_BLOCK_OFFSET(nid), <span class="hljs-number">1</span>, META_NAT, <span class="hljs-literal">true</span>);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (phase == <span class="hljs-number">1</span>) &#123;<br>f2fs_ra_node_page(sbi, nid);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-comment">/* phase == 2 */</span><br>node_page = f2fs_get_node_page(sbi, nid);<br><br>err = f2fs_move_node_page(node_page, gc_type);<br>&#125;<br><br><span class="hljs-keyword">if</span> (++phase &lt; <span class="hljs-number">3</span>)<br><span class="hljs-keyword">goto</span> next_step;<br><br><span class="hljs-keyword">return</span> submitted;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤æ¬¡é¢„è¯»ï¼Œåˆ†åˆ«æ˜¯METADATAåŒºåŸŸä¸­NATçš„é¡µé¢„è¯»ï¼Œå’Œnode pageçš„é¢„è¯»ï¼Œè¿™é‡Œè¦è¯´ä¸€ä¸‹é¢„è¯»çš„ç›®çš„ï¼š</p><ul><li><code>f2fs_ra_meta_pages(sbi, NAT_BLOCK_OFFSET(nid), 1, META_NAT, true)</code>ï¼šNAT_BLOCK_OFFSETé€šè¿‡nidå®šä½å±äºå“ªä¸€ä¸ªf2fs_nat_blockï¼Œç„¶åå°†å…¶åŠ è½½åˆ°Page Cacheä¸­ï¼Œæå‰é¢„è¯»çš„ç›®çš„åé¢è¦è¿ç§»node pageï¼Œé‚£ä¹ˆnidå’Œblkaddrçš„æ˜ å°„å…³ç³»è‚¯å®šéœ€è¦ä¿®æ”¹ã€‚ã€åœ¨**(f2fs_move_node_page -&gt; )write node page**æµç¨‹ä¸­ä¼šè°ƒç”¨set_node_addræ›´æ–°natä¸­å¯¹åº”çš„new_blkaddrã€‘ä¸‹é¢çš„æµç¨‹å¯ä»¥æ¸…é™¤çš„çœ‹åˆ°set_node_addræ—¶é¦–å…ˆä¼šå»cacheä¸­æ‰¾ï¼Œå½“ç„¶æ›´æ–°new_blkaddråä¹Ÿæ˜¯æ›´æ–°åˆ°page cacheä¸­ï¼Œè¦ç­‰åˆ°checkpointæµç¨‹æ‰ä¼šåˆ·å†™åˆ°cp journalæˆ–natä¸­ã€‚</li></ul><img src="/2023/11/30/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fgc%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/image-20231202211013776.png" alt="image-20231202211013776" style="zoom: 60%;"><ul><li><code>f2fs_ra_node_page(sbi, nid)</code>ï¼šæ ¹æ®nidè¯»å–node pageåŠ è½½åˆ°Page Cacheï¼Œæå‰é¢„è¯»çš„ç›®çš„æ˜¯åé¢ä¼šè°ƒç”¨f2fs_get_node_pageæ‹¿åˆ°è¿™ä¸ªé¡µç„¶åè¿›è¡Œmove pageã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_move_node_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *node_page, <span class="hljs-type">int</span> gc_type)</span><br>&#123;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (gc_type == FG_GC) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">writeback_control</span> <span class="hljs-title">wbc</span> =</span> &#123;<br>.sync_mode = WB_SYNC_ALL,<br>.nr_to_write = <span class="hljs-number">1</span>,<br>.for_reclaim = <span class="hljs-number">0</span>,<br>&#125;;<br><br>f2fs_wait_on_page_writeback(node_page, NODE, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br><br>set_page_dirty(node_page);<br><br><span class="hljs-keyword">if</span> (!clear_page_dirty_for_io(node_page)) &#123;<br>err = -EAGAIN;<br><span class="hljs-keyword">goto</span> out_page;<br>&#125;<br><br><span class="hljs-keyword">if</span> (__write_node_page(node_page, <span class="hljs-literal">false</span>, <span class="hljs-literal">NULL</span>,<br>&amp;wbc, <span class="hljs-literal">false</span>, FS_GC_NODE_IO, <span class="hljs-literal">NULL</span>)) &#123;<br>err = -EAGAIN;<br>unlock_page(node_page);<br>&#125;<br><span class="hljs-keyword">goto</span> release_page;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (!PageWriteback(node_page))<br>set_page_dirty(node_page);<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>å¦‚æœæ˜¯å‰å°GCï¼Œé‚£ä¹ˆä¼šç«‹å³è°ƒç”¨__write_node_pageæŠŠnode pageé¡µè¿ç§»åˆ°CURSEGä¸­çš„next_blkoffä¸­ã€å‚è€ƒæˆ‘çš„<a href="https://anmuxixixi.github.io/2023/11/28/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AF%B9%E4%BA%8Enode-page%E7%9A%84%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C/#%E5%86%99node-page">å†™node page</a>ã€‘</p></li><li><p>å¦‚æœæ˜¯åå°GCï¼Œåªéœ€è¦å°†node pageç½®ä¸ºè„ï¼Œç­‰å¾…å®šæœŸä¸‹åˆ·ã€‚</p></li></ul><h3 id="4-3-ã€åç»­æ¸…ç†ã€‘"><a href="#4-3-ã€åç»­æ¸…ç†ã€‘" class="headerlink" title="4.3 ã€åç»­æ¸…ç†ã€‘"></a>4.3 ã€åç»­æ¸…ç†ã€‘</h3><p>ä»f2fsçš„è®ºæ–‡é‡Œé¢å†™çš„å¾ˆæ¸…æ¥šï¼Œå½“victimé‡Œé¢çš„blockå…¨éƒ¨è¿ç§»å®Œæˆä»¥åï¼Œé‡Œé¢çš„å—ä¼šå˜æˆpre-freeçš„çŠ¶æ€ï¼Œå½“å®Œæˆcheckpointä»¥åæ‰ä¼šå˜æˆçœŸçš„freeçŠ¶æ€ï¼Œæ­¤æ—¶æ‰å¯ä»¥é‡æ–°åˆ†é…ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ</strong></p><blockquote><p>æˆ‘ä»¬çŸ¥é“åœ¨4.2 æ•°æ®ç« èŠ‚ä¸­ï¼Œåªæ˜¯æŠŠé¡µç§»åˆ°äº†CURSEGçš„ä½ç½®ï¼Œå®ƒå…¶å®è¿˜æ˜¯ä¿å­˜åœ¨ç¼“å­˜ä¸­ã€‚å‡è®¾å½“å‰è¿ç§»çš„æ˜¯Node Pageï¼Œé‡Œé¢ä¿å­˜äº†æ‰€æœ‰æ•°æ®å—çš„block addrï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜æ²¡æœ‰CPï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜è¿˜æ²¡çœŸæ­£è½ç›˜ï¼Œå¦‚æœåœ¨æ²¡è½ç›˜çš„æƒ…å†µä¸‹å……åˆ†åˆ†é…ç»™äº†å…¶ä»–çš„Node pageï¼Œé‚£å²‚ä¸æ˜¯æ‰€æœ‰çš„ç´¢å¼•éƒ½ä¹±å¥—äº†å—ï¼Ÿ</p></blockquote><p><strong>é ä»€ä¹ˆå»ç»´æŠ¤è¿™ç§è®¾è®¡ï¼Ÿ</strong></p><blockquote><p>ä»f2fs_clear_prefree_segmentsä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ˜¯é ä½å›¾prefree_mapç»´æŠ¤çš„prefreeçŠ¶æ€çš„block</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br>    f2fs_flush_nat_entries(sbi, cpc);<br><br>f2fs_flush_sit_entries(sbi, cpc);<br>    <br>    do_checkpoint(sbi, cpc);<br><br>    f2fs_clear_prefree_segments(sbi, cpc);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨f2fsçš„chekpointæµç¨‹ä¸­ï¼Œå®Œæˆäº†checkpointä¹‹åä¼šè°ƒç”¨f2fs_clear_prefree_segmentså»æ¸…ç†prefreeçŠ¶æ€çš„segment</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_clear_prefree_segments</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">discard_cmd_control</span> *<span class="hljs-title">dcc</span> =</span> SM_I(sbi)-&gt;dcc_info;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">head</span> =</span> &amp;dcc-&gt;entry_list;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">discard_entry</span> *<span class="hljs-title">entry</span>, *<span class="hljs-title">this</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> *<span class="hljs-title">dirty_i</span> =</span> DIRTY_I(sbi);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *prefree_map = dirty_i-&gt;dirty_segmap[PRE];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> start = <span class="hljs-number">0</span>, end = <span class="hljs-number">-1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> secno, start_segno;<br><span class="hljs-type">bool</span> force = (cpc-&gt;reason &amp; CP_DISCARD);<br><br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><span class="hljs-type">int</span> i;<br><br>start = find_next_bit(prefree_map, MAIN_SEGS(sbi), end + <span class="hljs-number">1</span>);<br>end = find_next_zero_bit(prefree_map, MAIN_SEGS(sbi), start + <span class="hljs-number">1</span>);<br><br><span class="hljs-keyword">for</span> (i = start; i &lt; end; i++) &#123;<br><span class="hljs-keyword">if</span> (test_and_clear_bit(i, prefree_map))<br>dirty_i-&gt;nr_dirty[PRE]--;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!f2fs_lfs_mode(sbi) || !__is_large_section(sbi)) &#123;<br>f2fs_issue_discard(sbi, START_BLOCK(sbi, start), (end - start) &lt;&lt; sbi-&gt;log_blocks_per_seg);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>    &#125;<br><br>wake_up_discard_thread(sbi, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæœ€åä¼šå”¤é†’discardçº¿ç¨‹å¼€å§‹æ¸…ç†ï¼Œæ­¤æ—¶ä¼šå»å‘å™¨ä»¶å±‚å‘é€TRIMå‘½ä»¤å¼€å§‹è¿›è¡Œæ“¦é™¤æ“ä½œã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿå°±åœ°æ›´æ–°ä¸å¼‚åœ°æ›´æ–°</title>
    <link href="/2023/11/28/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B0%B1%E5%9C%B0%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%BC%82%E5%9C%B0%E6%9B%B4%E6%96%B0/"/>
    <url>/2023/11/28/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B0%B1%E5%9C%B0%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%BC%82%E5%9C%B0%E6%9B%B4%E6%96%B0/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿå¯¹äºnode pageçš„è¯»å†™æ“ä½œ</title>
    <link href="/2023/11/28/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AF%B9%E4%BA%8Enode-page%E7%9A%84%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C/"/>
    <url>/2023/11/28/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AF%B9%E4%BA%8Enode-page%E7%9A%84%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿå¯¹äºnode-pageçš„è¯»å†™æ“ä½œ"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿå¯¹äºnode-pageçš„è¯»å†™æ“ä½œ" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿå¯¹äºnode pageçš„è¯»å†™æ“ä½œ"></a>f2fsæ–‡ä»¶ç³»ç»Ÿå¯¹äºnode pageçš„è¯»å†™æ“ä½œ</h1><h2 id="è¯»node-page"><a href="#è¯»node-page" class="headerlink" title="è¯»node page"></a>è¯»node page</h2><h2 id="å†™node-page"><a href="#å†™node-page" class="headerlink" title="å†™node page"></a>å†™node page</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_do_write_node_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nid, <span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> <span class="hljs-title">sum</span>;</span><br><br>set_summary(&amp;sum, nid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>do_write_page(&amp;sum, fio);<br><br>f2fs_update_iostat(fio-&gt;sbi, fio-&gt;io_type, F2FS_BLKSIZE);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-æ›´æ–°æ˜ å°„å…³ç³»f2fs-summary"><a href="#2-1-æ›´æ–°æ˜ å°„å…³ç³»f2fs-summary" class="headerlink" title="2.1 æ›´æ–°æ˜ å°„å…³ç³»f2fs_summary"></a>2.1 æ›´æ–°æ˜ å°„å…³ç³»f2fs_summary</h3><p>âœ…å› ä¸ºåªæœ‰data blockæ‰æœ‰å¯»æ‰¾ofs_in_nodeåå‘æ˜ å°„çš„æ„ä¹‰ã€å¤‡å¿˜ï¼šnode blockçš„i_addrå­˜æ”¾äº†æ¯ä¸€ä¸ªdata blockçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†data blockçš„åœ°å€æƒ³åå‘æ¨å¯¼åœ¨å“ªä¸€ä¸ªnode blockä¸­ï¼Œéœ€è¦ç”¨åˆ°f2fs_summaryã€‘ï¼Œæ‰€ä»¥æ›´æ–°node blockçš„æ—¶å€™ï¼Œofs_in_nodeå’Œversionç›´æ¥åˆå§‹åŒ–ä¸º0å³å¯!</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_summary</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-type">nid_t</span> nid,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ofs_in_node, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> version)</span><br>&#123;<br>sum-&gt;nid = cpu_to_le32(nid);<br>sum-&gt;ofs_in_node = cpu_to_le16(ofs_in_node);<br>sum-&gt;version = version;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-å¼€å§‹å†™é¡µ"><a href="#2-2-å¼€å§‹å†™é¡µ" class="headerlink" title="2.2 å¼€å§‹å†™é¡µ"></a>2.2 å¼€å§‹å†™é¡µ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_write_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span><br>&#123;<br><span class="hljs-type">int</span> type = __get_segment_type(fio);<br><br>f2fs_allocate_data_block(fio-&gt;sbi, fio-&gt;page, fio-&gt;old_blkaddr, &amp;fio-&gt;new_blkaddr, sum, type, fio);<br><br>f2fs_submit_page_write(fio);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-1-åˆ†é…æ–°çš„å—"><a href="#2-2-1-åˆ†é…æ–°çš„å—" class="headerlink" title="2.2.1 åˆ†é…æ–°çš„å—"></a>2.2.1 åˆ†é…æ–°çš„å—</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_allocate_data_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params"><span class="hljs-type">block_t</span> old_blkaddr, <span class="hljs-type">block_t</span> *new_blkaddr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-type">int</span> type,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_io_info *fio, <span class="hljs-type">bool</span> add_list)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_i</span> =</span> SIT_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><br>*new_blkaddr = NEXT_FREE_BLKADDR(sbi, curseg); <span class="hljs-comment">// è·å–æ–°çš„ç‰©ç†åœ°å€</span><br><br>__add_sum_entry(sbi, type, sum); <span class="hljs-comment">// å°†å½“å‰summaryæ›´æ–°åˆ°CURSEGä¸­</span><br><br>__refresh_next_blkoff(sbi, curseg); <span class="hljs-comment">// æ›´æ–°ä¸‹ä¸€æ¬¡å¯ä»¥ç”¨çš„ç‰©ç†åœ°å€</span><br><br><span class="hljs-comment">// ä¸‹é¢æ›´æ–°ä¸»è¦æ˜¯æ›´æ–°SITåŒºåŸŸçš„segmentä¿¡æ¯</span><br><br><span class="hljs-comment">// æ ¹æ®new_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºvalid(å€¼ä¸º1)ï¼Œè¡¨ç¤ºè¢«ç”¨æˆ·ä½¿ç”¨ï¼Œä¸å¯è¢«å…¶ä»–äººæ‰€ä½¿ç”¨</span><br>update_sit_entry(sbi, *new_blkaddr, <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// æ ¹æ®old_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºinvalid(å€¼ä¸º-1)ï¼Œè¡¨ç¤ºè¢«è¦†ç›–äº†ï¼Œç­‰å¾…GCå›æ”¶åé‡æ–°æŠ•å…¥ä½¿ç”¨</span><br><span class="hljs-keyword">if</span> (GET_SEGNO(sbi, old_blkaddr) != NULL_SEGNO)<br>update_sit_entry(sbi, old_blkaddr, <span class="hljs-number">-1</span>);<br><br><span class="hljs-comment">// å¦‚æœå½“å‰segmentæ²¡æœ‰ç©ºé—´è¿›è¡Œä¸‹ä¸€æ¬¡åˆ†é…äº†ï¼Œå°±åˆ†é…ä¸€ä¸ªæ–°çš„segmentç»™CURSEG</span><br><span class="hljs-keyword">if</span> (!__has_curseg_space(sbi, type))<br>sit_i-&gt;s_ops-&gt;allocate_segment(sbi, type, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// å°†segmentè®¾ç½®ä¸ºè„ï¼Œç­‰CPå†™å›ç£ç›˜</span><br>locate_dirty_segment(sbi, GET_SEGNO(sbi, old_blkaddr));<br>locate_dirty_segment(sbi, GET_SEGNO(sbi, *new_blkaddr    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-2-æäº¤å†™ioè¯·æ±‚"><a href="#2-2-2-æäº¤å†™ioè¯·æ±‚" class="headerlink" title="2.2.2 æäº¤å†™ioè¯·æ±‚"></a>2.2.2 æäº¤å†™ioè¯·æ±‚</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">f2fs_submit_page_write(fio);<br></code></pre></td></tr></table></figure><p>å…·ä½“æ€ä¹ˆä¸‹å‘bioï¼Œä¼šå¦å¤–å¼€ç« èŠ‚å†™ï¼[TODO: åœ¨è¿™é‡Œæ›´æ–°ä¸€ä¸‹bioçš„æ–‡ç« ç´¢å¼•]</p><h3 id="2-3-æ€»ç»“"><a href="#2-3-æ€»ç»“" class="headerlink" title="2.3 æ€»ç»“"></a>2.3 æ€»ç»“</h3><p>å†™nodeé¡µå…¶å®å¾ˆç®€å•ï¼š</p><ul><li>ã€æ›´æ–°ç´¢å¼•ã€‘åˆ†é…ä¸€ä¸ªf2fs_summaryï¼Œå†™å…¥nid</li><li>ã€æ‰¾åˆ°æ–°å—ã€‘æ‰¾åˆ°CURSEGæŒ‡å‘çš„ä¸‹ä¸€ä¸ªå¯ç”¨å—ï¼Œå°†fio-&gt;new_blkaddræ‰§è¡Œè¯¥å¯ç”¨å—</li><li>ã€æœªé›¨ç»¸ç¼ªã€‘ä¸ºäº†ä¸‹ä¸€æ¬¡å†™å…¥ä½œå‡†å¤‡ï¼Œåˆ¤æ–­ä¸€ä¸‹å½“å‰çš„CURSEGè¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼›æ²¡æœ‰çš„è¯å¾—åˆ†é…æ–°çš„å—</li><li>ã€ä¸‹å‘å†™ioã€‘ä¸‹å‘bioå†™å…¥çœŸæ­£è¦å†™å…¥çš„é¡µå†…å®¹</li></ul><h2 id="3-æ‰©å±•ï¼šå¦‚ä½•åˆ†é…ä¸€ä¸ªæ–°çš„å—"><a href="#3-æ‰©å±•ï¼šå¦‚ä½•åˆ†é…ä¸€ä¸ªæ–°çš„å—" class="headerlink" title="3.æ‰©å±•ï¼šå¦‚ä½•åˆ†é…ä¸€ä¸ªæ–°çš„å—"></a>3.æ‰©å±•ï¼šå¦‚ä½•åˆ†é…ä¸€ä¸ªæ–°çš„å—</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_allocate_data_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params"><span class="hljs-type">block_t</span> old_blkaddr, <span class="hljs-type">block_t</span> *new_blkaddr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-type">int</span> type,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_io_info *fio, <span class="hljs-type">bool</span> add_list)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_i</span> =</span> SIT_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><br>*new_blkaddr = NEXT_FREE_BLKADDR(sbi, curseg); <span class="hljs-comment">// è·å–æ–°çš„ç‰©ç†åœ°å€</span><br><br>__add_sum_entry(sbi, type, sum); <span class="hljs-comment">// å°†å½“å‰summaryæ›´æ–°åˆ°CURSEGä¸­</span><br><br>__refresh_next_blkoff(sbi, curseg); <span class="hljs-comment">// æ›´æ–°ä¸‹ä¸€æ¬¡å¯ä»¥ç”¨çš„ç‰©ç†åœ°å€</span><br><br><span class="hljs-comment">// ä¸‹é¢æ›´æ–°ä¸»è¦æ˜¯æ›´æ–°SITåŒºåŸŸçš„segmentä¿¡æ¯</span><br><br><span class="hljs-comment">// æ ¹æ®new_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºvalid(å€¼ä¸º1)ï¼Œè¡¨ç¤ºè¢«ç”¨æˆ·ä½¿ç”¨ï¼Œä¸å¯è¢«å…¶ä»–äººæ‰€ä½¿ç”¨</span><br>update_sit_entry(sbi, *new_blkaddr, <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// æ ¹æ®old_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºinvalid(å€¼ä¸º-1)ï¼Œè¡¨ç¤ºè¢«è¦†ç›–äº†ï¼Œç­‰å¾…GCå›æ”¶åé‡æ–°æŠ•å…¥ä½¿ç”¨</span><br><span class="hljs-keyword">if</span> (GET_SEGNO(sbi, old_blkaddr) != NULL_SEGNO)<br>update_sit_entry(sbi, old_blkaddr, <span class="hljs-number">-1</span>);<br><br><span class="hljs-comment">// å¦‚æœå½“å‰segmentæ²¡æœ‰ç©ºé—´è¿›è¡Œä¸‹ä¸€æ¬¡åˆ†é…äº†ï¼Œå°±åˆ†é…ä¸€ä¸ªæ–°çš„segmentç»™CURSEG</span><br><span class="hljs-keyword">if</span> (!__has_curseg_space(sbi, type))<br>sit_i-&gt;s_ops-&gt;allocate_segment(sbi, type, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// å°†segmentè®¾ç½®ä¸ºè„ï¼Œç­‰CPå†™å›ç£ç›˜</span><br>locate_dirty_segment(sbi, GET_SEGNO(sbi, old_blkaddr));<br>locate_dirty_segment(sbi, GET_SEGNO(sbi, *new_blkaddr    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-1-è·å–CURSEGä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„block"><a href="#3-1-è·å–CURSEGä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„block" class="headerlink" title="3.1 è·å–CURSEGä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„block"></a>3.1 è·å–CURSEGä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„block</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NEXT_FREE_BLKADDR(sbi, curseg)(START_BLOCK(sbi, (curseg)-&gt;segno) + (curseg)-&gt;next_blkoff)</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰äººä¼šæœ‰ç–‘é—®ï¼Œä¼šä¸ä¼šå½“å‰segmentå æ»¡äº†ï¼Œnext_blkoffæœ¨æœ‰äº†ï¼Œä¸å¯èƒ½ï¼ï¼ï¼å› ä¸ºæ•´ä¸ªæµç¨‹çš„æœ€åä¼šè°ƒç”¨__has_curseg_spaceï¼Œå¦‚æœä¸Šä¸€æ¬¡åˆ†é…çš„æ—¶å€™å æ»¡äº†ï¼Œä¼šé‡æ–°åˆ†é…æ–°çš„Segmentç»™CURSEGã€‚</p><h3 id="3-2-æ›´æ–°CURSEGä¸­çš„summaryä¿¡æ¯"><a href="#3-2-æ›´æ–°CURSEGä¸­çš„summaryä¿¡æ¯" class="headerlink" title="3.2 æ›´æ–°CURSEGä¸­çš„summaryä¿¡æ¯"></a>3.2 æ›´æ–°CURSEGä¸­çš„summaryä¿¡æ¯</h3><p>å› ä¸ºå‰é¢2.1èŠ‚æ›´æ–°äº†summaryä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ›´æ–°åˆ°CURSEGä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __add_sum_entry(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> type,<br><span class="hljs-keyword">struct</span> f2fs_summary *sum)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><span class="hljs-type">void</span> *addr = curseg-&gt;sum_blk;<br>addr += curseg-&gt;next_blkoff * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> f2fs_summary);<br><span class="hljs-built_in">memcpy</span>(addr, sum, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> f2fs_summary));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-æ›´æ–°CURSEGçš„next-blkoff"><a href="#3-3-æ›´æ–°CURSEGçš„next-blkoff" class="headerlink" title="3.3 æ›´æ–°CURSEGçš„next_blkoff"></a>3.3 æ›´æ–°CURSEGçš„next_blkoff</h3><p>å› ä¸ºå½“å‰çš„next_blkoffå·²è¢«æœ¬æ¬¡å ç”¨äº†ï¼Œæ‰€ä»¥æå‰åˆ†é…ä¸‹ä¸€ä¸ªå¯ç”¨çš„blockï¼Œè¿™é‡Œæœ‰2ç§æƒ…å†µâ€œ</p><ul><li>å¦‚æœåˆ†é…æ–¹å¼æ˜¯SSRï¼Œé‚£ä¹ˆéœ€è¦åŒæ—¶å¯»æ‰¾ckpt_valid_mapå’Œcur_valid_mapä¸­åŒæ—¶ä¸ä¸º0çš„ä½ç½®</li><li>å¦‚æœåˆ†é…æ–¹å¼æ˜¯LFSï¼Œé‚£ä¹ˆç›´æ¥+1å³å¯</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __refresh_next_blkoff(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> curseg_info *seg)<br>&#123;<br><span class="hljs-keyword">if</span> (seg-&gt;alloc_type == SSR)<br>__next_free_blkoff(sbi, seg, seg-&gt;next_blkoff + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">else</span><br>seg-&gt;next_blkoff++;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __next_free_blkoff(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,<br><span class="hljs-keyword">struct</span> curseg_info *seg, <span class="hljs-type">block_t</span> start)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seg_entry</span> *<span class="hljs-title">se</span> =</span> get_seg_entry(sbi, seg-&gt;segno);<br><span class="hljs-type">int</span> entries = SIT_VBLOCK_MAP_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *target_map = SIT_I(sbi)-&gt;tmp_map;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *ckpt_map = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)se-&gt;ckpt_valid_map;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *cur_map = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)se-&gt;cur_valid_map;<br><span class="hljs-type">int</span> i, pos;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; entries; i++)<br>target_map[i] = ckpt_map[i] | cur_map[i];<br><br>pos = __find_rev_next_zero_bit(target_map, sbi-&gt;blocks_per_seg, start);<br><br>seg-&gt;next_blkoff = pos;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-4-æ›´æ–°SITåŒºåŸŸçš„ä¿¡æ¯"><a href="#3-4-æ›´æ–°SITåŒºåŸŸçš„ä¿¡æ¯" class="headerlink" title="3.4 æ›´æ–°SITåŒºåŸŸçš„ä¿¡æ¯"></a>3.4 æ›´æ–°SITåŒºåŸŸçš„ä¿¡æ¯</h3><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªNode segmentä¸­çš„blockï¼Œè€ŒSITåŒºåŸŸç»´æŠ¤äº†æ¯ä¸€ä¸ªSegmentçš„ä¿¡æ¯ï¼Œå¦‚è¿™ä¸ªsegmentä½¿ç”¨äº†å¤šå°‘ä¸ªblockï¼Œå“ªå‡ ä¸ªblockä½¿ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ›´æ–°SITã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* del: ç†è§£æˆæŸ¥åˆ†çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æœ¬æ¬¡Segmentä¸­æœ‰delä¸ªå‘ç”Ÿäº†å˜åŒ–</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">update_sit_entry</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">block_t</span> blkaddr, <span class="hljs-type">int</span> del)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seg_entry</span> *<span class="hljs-title">se</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno, offset;<br><span class="hljs-type">long</span> <span class="hljs-type">int</span> new_vblocks;<br><span class="hljs-type">bool</span> exist;<br><br>segno = GET_SEGNO(sbi, blkaddr);<br><br>se = get_seg_entry(sbi, segno);<br>new_vblocks = se-&gt;valid_blocks + del;<br>offset = GET_BLKOFF_FROM_SEG0(sbi, blkaddr);<br><br>    <span class="hljs-comment">// æ›´æ–°seg_entryä¸­çš„æœ‰æ•ˆblockæ•°ç›®</span><br>se-&gt;valid_blocks = new_vblocks;<br><br><span class="hljs-keyword">if</span> (del &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// æ›´æ–°ä½å›¾</span><br>exist = f2fs_test_and_set_bit(offset, se-&gt;cur_valid_map);<br><br><span class="hljs-keyword">if</span> (!is_sbi_flag_set(sbi, SBI_CP_DISABLED)) &#123;<br>            <span class="hljs-comment">// è¿™é‡Œéœ€è¦è®¾ç½®ckpt_valid_mapä½å›¾</span><br><span class="hljs-keyword">if</span> (!f2fs_test_and_set_bit(offset, se-&gt;ckpt_valid_map))<br>se-&gt;ckpt_valid_blocks++;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœå°†offsetå¯¹åº”çš„blockæ ‡è®°ä¸ºæ— æ•ˆï¼Œåˆ™åœ¨ä½å›¾ä¸­è¿›è¡Œæ¸…ç†</span><br>exist = f2fs_test_and_clear_bit(offset, se-&gt;cur_valid_map);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-5-å½“å‰CURSEGæ˜¯å¦è¿˜æœ‰ç©ºé—´"><a href="#3-5-å½“å‰CURSEGæ˜¯å¦è¿˜æœ‰ç©ºé—´" class="headerlink" title="3.5 å½“å‰CURSEGæ˜¯å¦è¿˜æœ‰ç©ºé—´"></a>3.5 å½“å‰CURSEGæ˜¯å¦è¿˜æœ‰ç©ºé—´</h3><p>ä¸ºäº†ä¸‹ä¸€æ¬¡åˆ†é…æ—¶next_blkoffè¿˜æ˜¯æœ‰æ•ˆçš„ï¼Œéœ€è¦æå‰åˆ¤æ–­ä¸€ä¸‹CURSEGæ˜¯å¦è¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> __has_curseg_space(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,<br><span class="hljs-keyword">struct</span> curseg_info *curseg)<br>&#123;<br><span class="hljs-keyword">return</span> curseg-&gt;next_blkoff &lt; f2fs_usable_blks_in_seg(sbi,<br>curseg-&gt;segno);<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸç†å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­3.3ä¸­è·å–çš„next_blkoffæ˜¯ä¸æ˜¯åœ¨èŒƒå›´ä¹‹å†…ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿å‘½å¬å”¤17é»‘è‰²è¡ŒåŠ¨è§£é”æ··æ²Œè¡ŒåŠ¨</title>
    <link href="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/"/>
    <url>/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ä½¿å‘½å¬å”¤17é»‘è‰²è¡ŒåŠ¨è§£é”æ··æ²Œè¡ŒåŠ¨"><a href="#ä½¿å‘½å¬å”¤17é»‘è‰²è¡ŒåŠ¨è§£é”æ··æ²Œè¡ŒåŠ¨" class="headerlink" title="ä½¿å‘½å¬å”¤17é»‘è‰²è¡ŒåŠ¨è§£é”æ··æ²Œè¡ŒåŠ¨"></a>ä½¿å‘½å¬å”¤17é»‘è‰²è¡ŒåŠ¨è§£é”æ··æ²Œè¡ŒåŠ¨</h1><p>å‰æœŸæ²¡çœ‹æˆå°±å’Œæ”»ç•¥ï¼Œå¯¼è‡´æ²¡æœ‰æœé›†å®Œæ•´è¯æ®ï¼Œæ‰€ä»¥æ²¡æœ‰è§£é”ã€Šæ··æ²Œè¡ŒåŠ¨ã€‹</p><h2 id="è¯æ®æœé›†"><a href="#è¯æ®æœé›†" class="headerlink" title="è¯æ®æœé›†"></a>è¯æ®æœé›†</h2><h2 id="å¯†ç ç ´è§£"><a href="#å¯†ç ç ´è§£" class="headerlink" title="å¯†ç ç ´è§£"></a>å¯†ç ç ´è§£</h2><p>é”™è¿‡äº†ä¹‹åï¼Œè¦å›åˆ°ã€Šä¸œæŸæ—ç®€æŠ¥ã€‹ç« èŠ‚å»é‡æ–°æ£€è§†çº¿ç´¢</p><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221203072.png" alt="image-20231128221203072" style="zoom: 33%;"><ul><li>é€‰æ‹©æ··æ²Œè¡ŒåŠ¨</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221305743.png" alt="image-20231128221305743" style="zoom: 33%;"><ul><li>æ£€è§†è¯æ®</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221410168.png" alt="image-20231128221410168" style="zoom:33%;"><ul><li>æŠ¥çº¸çº¿ç´¢ï¼šæˆ‘çš„æ˜¯<strong>äºšç‰¹å…°å¤§</strong></li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221335098.png" alt="image-20231128221335098" style="zoom: 33%;"><ul><li>åŠ å¯†ä¿¡æ¯ï¼šçº¢è‰²çš„è§„å¾‹ä¸ºé—´éš”æ•°å­—å·®ä¸º1,2,3,â€¦ï¼Œæ‰€ä»¥çº¢è‰²ï¼Ÿä¸º41ï¼›è“è‰²çš„è§„å¾‹ä¸ºé—´éš”æ•°ç»„å·®ä¸º8ï¼Œæ‰€ä»¥è“è‰²ï¼Ÿä¸º78ï¼›ç»„åˆèµ·æ¥ä¸º4178</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221511272.png" alt="image-20231128221511272" style="zoom: 33%;"><ul><li>æ•°ä½ç”µå°ï¼šä¸Šé¢çš„åŠ å¯†ä¿¡æ¯å¯¹åº”ç”µå°ä¸ºå¥¥å…°å¤šï¼ŒæŠ¥çº¸ä¸Šäºšç‰¹å…°å¤§å¯¹åº”çš„æ•°å­—ä¸º1541</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221646934.png" alt="image-20231128221646934" style="zoom:33%;"><ul><li>å¼€å§‹ç ´è¯‘</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221751205.png" alt="image-20231128221751205" style="zoom:33%;"><ul><li>å¯†ç è¾“å…¥ï¼šæŠ¥çº¸ä¸Šçš„åŸå¸‚åœ¨æ•°ä½ç”µå°çš„æ•°å­—ï¼Œé€šè®¯åŸå¸‚ä¸ºè§£å¯†åçš„æ•°ç»„åœ¨æ•°ä½ç”µå°ä¸Šçš„åŸå¸‚ã€‚</li></ul><img src="/2023/11/28/%E4%BD%BF%E5%91%BD%E5%8F%AC%E5%94%A417%E9%BB%91%E8%89%B2%E8%A1%8C%E5%8A%A8%E8%A7%A3%E9%94%81%E6%B7%B7%E6%B2%8C%E8%A1%8C%E5%8A%A8/image-20231128221806688.png" alt="image-20231128221806688" style="zoom:33%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segment</title>
    <link href="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/"/>
    <url>/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segment"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segment" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segment"></a>f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segment</h1><h2 id="1-segmentåˆ†é…æ–¹å¼æ¦‚è¿°"><a href="#1-segmentåˆ†é…æ–¹å¼æ¦‚è¿°" class="headerlink" title="1.segmentåˆ†é…æ–¹å¼æ¦‚è¿°"></a>1.segmentåˆ†é…æ–¹å¼æ¦‚è¿°</h2><p>f2fsæ–‡ä»¶ç³»ç»Ÿåˆ†é…segmentçš„æ–¹å¼ä¸»è¦åˆ†ä¸ºLFSå’ŒSSR</p><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/webp.webp" alt="img" style="zoom: 50%;"><ul><li>LFS Allocï¼šæ‰¾åˆ°ä¸€ä¸ªFreeçš„Segmentï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªSegmentæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œé‡Œé¢çš„blockéƒ½æ˜¯å…¨æ–°æœªå†™å…¥å†…å®¹çš„</li><li>SSR Allocï¼ˆSlack Space Recyclingï¼‰ï¼šæ‰¾åˆ°ä¸€ä¸ªUsed Segmentï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªSegmenté‡Œé¢æœ‰ä¸€äº›Blockæ˜¯å·²ç»ä½¿ç”¨äº†çš„ï¼Œæˆ‘ä»¬å°†è¦å†™çš„å†…å®¹å†™å…¥åˆ°è¿™ä¸ªSegmentçš„æœªä½¿ç”¨çš„blockä¸­ã€‚è‡³äºé€‰æ‹©å“ªä¸€ä¸ªUsed Segmentï¼Œæ˜¯æœ‰é€‰æ‹©ç­–ç•¥çš„ã€‚</li></ul><h2 id="2-GCç­–ç•¥"><a href="#2-GCç­–ç•¥" class="headerlink" title="2.GCç­–ç•¥"></a>2.GCç­–ç•¥</h2><h3 id="2-1-Greedyç®—æ³•"><a href="#2-1-Greedyç®—æ³•" class="headerlink" title="2.1 Greedyç®—æ³•"></a>2.1 Greedyç®—æ³•</h3><p>F2FS æ‰§è¡Œ foreground gc æ—¶é‡‡ç”¨ Greedy ç®—æ³•ã€‚</p><p>ä¸ºå®ç° Greedy ç®—æ³•ï¼ŒF2FS ç»´æŠ¤ä¸€å¼ è®°å½•æ¯ä¸€ä¸ª section ä¸­æœ‰æ•ˆ block æ•°çš„å…ƒæ•°æ®è¡¨ï¼Œæ‰§è¡Œ gc æ“ä½œæ—¶ï¼Œæ ¹æ®è¿™ä¸ªå…ƒæ•°æ®è¡¨æ‰¾å‡ºæœ‰æ•ˆ block æ•°æœ€å°‘çš„ n ä¸ª section ä½œä¸º victimã€‚</p><p>ç›´è§‚åœ°è¯´ï¼ŒGreedyç®—æ³•èƒ½ä½¿gcæ—¶è¿ç§»çš„æœ‰æ•ˆå—æ•°æœ€å°‘ï¼Œä»è€Œå¼€é”€æœ€å°ï¼Œæ‰€ä»¥ F2FS åœ¨ foreground gc æ—¶é‡‡ç”¨ Greedy ç®—æ³•ï¼Œæœ€å°åŒ–åº”ç”¨èƒ½æ„ŸçŸ¥çš„å»¶è¿Ÿã€‚</p><h3 id="2-2-Cost-Benefit-ç®—æ³•"><a href="#2-2-Cost-Benefit-ç®—æ³•" class="headerlink" title="2.2 Cost-Benefit ç®—æ³•"></a>2.2 Cost-Benefit ç®—æ³•</h3><p>F2FS åœ¨æ‰§è¡Œ background gc æ—¶é‡‡ç”¨ Cost-Benefit ç®—æ³•ï¼Œä¸»è¦æ€æƒ³æ˜¯è®¡ç®—å‡ºæ¯ä¸ª section çš„è¿ç§»å¼€é”€ï¼Œé€‰åœ¨å¼€é”€æœ€å°çš„ n ä¸ªsection ä½œä¸º victimï¼Œå¼€é”€çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<code>cost = (1âˆ’Î¼) / 2Î¼ âˆ— age</code>ï¼Œå…¶ä¸­ï¼š</p><ul><li>u ä»£è¡¨ valid block åœ¨è¯¥ section ä¸­çš„æ¯”ä¾‹ï¼Œage ä»£è¡¨è¯¥ section è·ç¦»æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ï¼›</li><li>1-u æ˜¯å¯¹è¿™ä¸ª section è¿›è¡Œ gc ä»¥åèƒ½å¤Ÿè·å¾— free block çš„æ•°é‡ï¼›</li><li>2u æ˜¯å¯¹è¿™ä¸ª section è¿›è¡Œ gc çš„å¼€é”€ï¼Œè¯»å– Valid blockï¼ˆ1ä¸ªuï¼‰ç„¶åå†™å…¥åˆ°æ–°çš„ section ï¼ˆå†1ä¸ªuï¼‰ï¼›</li></ul><p>æ‰€ä»¥ï¼ˆ1-uï¼‰&#x2F; 2u å¯ä»¥ç†è§£ä¸ºæŠ•å…¥äº§å‡ºæ¯”ã€‚</p><p>F2FS éœ€è¦åœ¨ç»´æŠ¤çš„å…ƒæ•°æ®è¡¨é‡Œï¼Œè®°å½•æ¯ä¸ª section æœ€åä¸€æ¬¡è¢«å†™å…¥çš„æ—¶é—´ï¼Œgc æ—¶é€‰æ‹©æ›´ä¹…æ²¡æœ‰è¢«ä¿®æ”¹çš„sectionï¼ˆå†·æ•°æ®ï¼‰ä½œä¸º victimã€‚</p><p>è¯¥ç­–ç•¥å°±æ˜¯é€‰æ‹©æŠ•å…¥äº§å‡ºæ¯”æ›´é«˜ï¼Œæœªä¿®æ”¹æ—¶é—´æ›´é•¿çš„ section è¿›è¡Œ gcï¼Œä¸¤è€…ç›¸ä¹˜æ•°å­—æ›´å¤§çš„ä¼˜å…ˆè¢« gcã€‚</p><h2 id="3-Victimé€‰æ‹©"><a href="#3-Victimé€‰æ‹©" class="headerlink" title="3.Victimé€‰æ‹©"></a>3.Victimé€‰æ‹©</h2><p>f2fsæ–‡ä»¶ç³»ç»Ÿä¸­victimçš„é€‰æ‹©æ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰</p><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127222156495.png" alt="image-20231127222156495" style="zoom:67%;"><p>ğŸ†<strong>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯</strong>ï¼švictimå¯ä»¥æ˜¯sectionï¼Œä¹Ÿå¯ä»¥æ˜¯segment</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_victim_by_default</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *result, <span class="hljs-type">int</span> gc_type, <span class="hljs-type">int</span> type,</span><br><span class="hljs-params"><span class="hljs-type">char</span> alloc_mode, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> age)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> *<span class="hljs-title">dirty_i</span> =</span> DIRTY_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sm</span> =</span> SIT_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">victim_sel_policy</span> <span class="hljs-title">p</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> secno, last_victim;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> last_segment;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nsearched;<br><span class="hljs-type">bool</span> is_atgc;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>last_segment = MAIN_SECS(sbi) * sbi-&gt;segs_per_sec;<br><br>    <span class="hljs-comment">// ------------------------------ åŒºåŸŸ1ï¼šç¡®å®švictim_sel_policyå‚æ•° ------------------------------</span><br>    <br>p.alloc_mode = alloc_mode;<br>p.age = age;<br>p.age_threshold = sbi-&gt;am.age_threshold;<br><br>retry:<br>select_policy(sbi, gc_type, type, &amp;p);<br>p.min_segno = NULL_SEGNO;<br>p.oldest_age = <span class="hljs-number">0</span>;<br>p.min_cost = get_max_cost(sbi, &amp;p);<br><br>last_victim = sm-&gt;last_victim[p.gc_mode];<br><br>    <span class="hljs-comment">// ------------------------------ åŒºåŸŸ2ï¼šå¾ªç¯éå†æ‰€æœ‰çš„segment ------------------------------</span><br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cost, *dirty_bitmap;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> unit_no, segno;<br><br>dirty_bitmap = p.dirty_bitmap;<br>unit_no = find_next_bit(dirty_bitmap, last_segment / p.ofs_unit, p.offset / p.ofs_unit);<br>segno = unit_no * p.ofs_unit;<br><span class="hljs-keyword">if</span> (segno &gt;= last_segment) &#123;<br><span class="hljs-keyword">if</span> (sm-&gt;last_victim[p.gc_mode]) &#123;<br>last_segment = sm-&gt;last_victim[p.gc_mode];<br>sm-&gt;last_victim[p.gc_mode] = <span class="hljs-number">0</span>;<br>p.offset = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>p.offset = segno + p.ofs_unit;<br>nsearched++;<br><br><span class="hljs-comment">// ------------------------------ åŒºåŸŸ3ï¼šæ‰¾åˆ°costæœ€å°çš„segno ------------------------------</span><br>secno = GET_SEC_FROM_SEG(sbi, segno);<br><br>cost = get_gc_cost(sbi, segno, &amp;p);<br><br><span class="hljs-keyword">if</span> (p.min_cost &gt; cost) &#123;<br>p.min_segno = segno;<br>p.min_cost = cost;<br>&#125;<br>next:<br><span class="hljs-keyword">if</span> (nsearched &gt;= p.max_search) &#123;<br><span class="hljs-keyword">if</span> (!sm-&gt;last_victim[p.gc_mode] &amp;&amp; segno &lt;= last_victim)<br>sm-&gt;last_victim[p.gc_mode] = last_victim + p.ofs_unit;<br><span class="hljs-keyword">else</span><br>sm-&gt;last_victim[p.gc_mode] = segno + p.ofs_unit;<br>sm-&gt;last_victim[p.gc_mode] %=<br>(MAIN_SECS(sbi) * sbi-&gt;segs_per_sec);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// ------------------------------ åŒºåŸŸ4ï¼šæ‰¾åˆ°åèµ‹å€¼é€€å‡º ------------------------------</span><br><span class="hljs-keyword">if</span> (p.min_segno != NULL_SEGNO) &#123;<br>got_it:<br>*result = (p.min_segno / p.ofs_unit) * p.ofs_unit;<br>got_result:<br><span class="hljs-keyword">if</span> (p.alloc_mode == LFS) &#123;<br>secno = GET_SEC_FROM_SEG(sbi, p.min_segno);<br><span class="hljs-keyword">if</span> (gc_type == FG_GC) sbi-&gt;cur_victim_sec = secno;<br><span class="hljs-keyword">else</span> set_bit(secno, dirty_i-&gt;victim_secmap);<br>&#125;<br>ret = <span class="hljs-number">0</span>;<br><br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ç•¥é•¿ï¼Œåˆ†ç‰‡å¤„ç†ï¼š</p><ul><li>åŒºåŸŸ1ï¼šç¡®å®švictim_sel_policyå‚æ•°ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯select_policyå‡½æ•°</li><li>åŒºåŸŸ2ï¼šå¾ªç¯éå†segmentï¼Œéœ€è¦ä¸»è¦çš„æ˜¯é€€å‡ºæ¡ä»¶</li><li>åŒºåŸŸ3ï¼šæ ¹æ®select_policyä¸­ç¡®å®šçš„gc_modeï¼Œç»“åˆç¬¬äºŒèŠ‚çš„GCç­–ç•¥æ‰¾åˆ°æœ€å°åˆ†é…ä»£ä»·min_costå¯¹åº”çš„segment</li><li>åŒºåŸŸ4ï¼šèµ‹å€¼æ‰¾åˆ°çš„min_segno</li></ul><h3 id="3-1-ç¡®å®švictim-sel-policyå‚æ•°"><a href="#3-1-ç¡®å®švictim-sel-policyå‚æ•°" class="headerlink" title="3.1 ç¡®å®švictim_sel_policyå‚æ•°"></a>3.1 ç¡®å®švictim_sel_policyå‚æ•°</h3><p>ç¡®å®švictim_sel_policyå‚æ•°ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯select_policyå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">select_policy</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> gc_type,</span><br><span class="hljs-params"><span class="hljs-type">int</span> type, <span class="hljs-keyword">struct</span> victim_sel_policy *p)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> *<span class="hljs-title">dirty_i</span> =</span> DIRTY_I(sbi);<br><br><span class="hljs-keyword">if</span> (p-&gt;alloc_mode == SSR) &#123;<br>p-&gt;gc_mode = GC_GREEDY;<br>p-&gt;dirty_bitmap = dirty_i-&gt;dirty_segmap[type];<br>p-&gt;max_search = dirty_i-&gt;nr_dirty[type];<br>p-&gt;ofs_unit = <span class="hljs-number">1</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>p-&gt;gc_mode = select_gc_type(sbi, gc_type);<br>p-&gt;ofs_unit = sbi-&gt;segs_per_sec;<br><span class="hljs-keyword">if</span> (__is_large_section(sbi)) &#123;<br>p-&gt;dirty_bitmap = dirty_i-&gt;dirty_secmap;<br>p-&gt;max_search = count_bits(p-&gt;dirty_bitmap, <span class="hljs-number">0</span>, MAIN_SECS(sbi));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>p-&gt;dirty_bitmap = dirty_i-&gt;dirty_segmap[DIRTY];<br>p-&gt;max_search = dirty_i-&gt;nr_dirty[DIRTY];<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (test_opt(sbi, NOHEAP) &amp;&amp;<br>(type == CURSEG_HOT_DATA || IS_NODESEG(type)))<br>p-&gt;offset = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">else</span><br>p-&gt;offset = SIT_I(sbi)-&gt;last_victim[p-&gt;gc_mode];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§éœ€è¦åŒºåˆ†LFSå’ŒSSRï¼š</p><ul><li>LFSï¼šp-&gt;gc_modeé€šè¿‡select_gc_typeä¸€èˆ¬ä¸ºCost-Benefitï¼Œp-&gt;ofs_unitä¸ºä¸€ä¸ªSectionå«æœ‰çš„segment</li><li>SSRï¼šp-&gt;gc_modeä¸ºGC_GREEDYï¼Œp-&gt;ofs_unitä¸º1ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªSegmentï¼‰</li></ul><p>è¿™é‡Œéœ€è¦æ³¨æ„<strong>dirty_segmap</strong>ä½å›¾ï¼š</p><blockquote><p>dirty_seglist_infoç»“æ„ä½“ç»´æŠ¤äº†6ä¸ªä½å›¾ï¼ŒDIRTY HOT&#x2F;WARM&#x2F;COLD Ã— NODE&#x2F;DATAï¼Œå…¶ä¸­æ¯ä¸€ä¸ªä½å›¾çš„å¤§å°å‡ä¸ºSegmentçš„æ€»æ•°</p><ul><li>å½“è¿™ä¸ªSegmentä¸ºDirtyçš„æ—¶å€™ï¼Œå¯¹åº”çš„SegNoåœ¨ä½å›¾ä¸­çš„Bitä½ä¸º1</li><li>ä¸€ä¸ªç±»å‹æœ‰å¤šå°‘ä¸ªDirtyçš„Segmentï¼Œå…¶ç»´æŠ¤åœ¨nr_dirtyä¸­ï¼Œä¾‹å¦‚ä¸‹å›¾ä¸­æ‰€æœ‰çš„HOT DATAç±»å‹çš„Segmentä¸­æ€»å…±æœ‰3ä¸ªDirtyçš„ï¼Œé‚£ä¹ˆdirty_i-&gt;nr_dirty[DIRTY_HOT_DATA]&#x3D;3</li><li>ğŸ”´<strong>è‡ªç„¶æœ€å¤§çš„æœå¯»æ¬¡æ•°å¯¹åº”äºæœ‰å¤šå°‘ä¸ªè„çš„segment</strong></li></ul></blockquote><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127224936323.png" alt="image-20231127224936323" style="zoom:80%;"><h3 id="3-2-å¾ªç¯éå†æ‰€æœ‰çš„segment"><a href="#3-2-å¾ªç¯éå†æ‰€æœ‰çš„segment" class="headerlink" title="3.2 å¾ªç¯éå†æ‰€æœ‰çš„segment"></a>3.2 å¾ªç¯éå†æ‰€æœ‰çš„segment</h3><p>æ¯æ¬¡å¾ªç¯çš„æ—¶å€™ï¼Œé€šè¿‡<strong>find_next_bit</strong>æ‰¾åˆ°ä½å›¾ä¸­ä¸º1çš„ä½ç½®ï¼ˆå‡å¦‚æ²¡æ‰¾åˆ°ä¼šè¿”å›ä½å›¾çš„é•¿åº¦ï¼‰</p><p>å¾ªç¯éå†segmentï¼Œéœ€è¦ä¸»è¦çš„æ˜¯é€€å‡ºæ¡ä»¶ï¼Œé€€å‡ºæ¡ä»¶æœ‰2ä¸­å¯èƒ½æ€§ï¼š</p><ol><li>segno &gt;&#x3D; last_segmentä¸”sm-&gt;last_victim[p.gc_mode]ä¸º0</li><li>å¾ªç¯æ¬¡æ•°è¾¾åˆ°äº†p.max_searchï¼Œå³è¾¾åˆ°äº†dirty_i-&gt;nr_dirty[type]</li></ol><blockquote><p>è¿™é‡Œæœ‰ä¸€ç§ç‰¹æ®Šçš„æƒ…å†µï¼Œå½“åˆå§‹çš„last_victimä¸º4çš„æ—¶å€™ï¼Œå…ˆå‘å³å¯»æ‰¾åˆ°ç´¢å¼•7çš„Bitä½ä¸º1ï¼Œä¸‹ä¸€æ¬¡éå†çš„æ—¶å€™ä¼šå‘ç°è¿”å›çš„äº†ä½å›¾çš„é•¿åº¦ä¼šèµ°è¿›ifåˆ†æ”¯ï¼Œä½†æ­¤æ—¶ä¼šå°†offsetå’Œlast_victimé‡æ–°èµ‹å€¼ä¸º0åé‡å¤´å¼€å§‹éå†ã€‚</p><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127232637008.png" alt="image-20231127232637008" style="zoom: 67%;"></blockquote><ul><li><strong>æƒ…å†µ1ï¼šå‘æœ‰éå†åˆ°è¾¹ç•Œåé‡å¤´å¼€å§‹</strong></li></ul><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127232439084.png" alt="image-20231127232439084" style="zoom:67%;"><ul><li><strong>æƒ…å†µ2ï¼šæ­£å¸¸éå†å®Œæ­£å¥½è¾¾åˆ°max_searchåç»“æŸ</strong></li></ul><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127233012926.png" alt="image-20231127233012926" style="zoom:67%;"><h3 id="3-3-æ‰¾åˆ°æœ€å°ä»£ä»·çš„segment"><a href="#3-3-æ‰¾åˆ°æœ€å°ä»£ä»·çš„segment" class="headerlink" title="3.3 æ‰¾åˆ°æœ€å°ä»£ä»·çš„segment"></a>3.3 æ‰¾åˆ°æœ€å°ä»£ä»·çš„segment</h3><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127233247450.png" alt="image-20231127233247450" style="zoom:67%;"><h3 id="3-4-èµ‹å€¼åé€€å‡º"><a href="#3-4-èµ‹å€¼åé€€å‡º" class="headerlink" title="3.4 èµ‹å€¼åé€€å‡º"></a>3.4 èµ‹å€¼åé€€å‡º</h3><p>âœ…<strong>ä¸¤æ®µèµ‹å€¼ä»£ç å€¼å¾—æ³¨æ„ï¼š</strong></p><ul><li><strong>sm-&gt;last_victim[p.gc_mode]ï¼š</strong>éå†ç»“æŸåï¼Œæ ¹æ®segNoå’Œä¸Šä¸€æ¬¡æœç´¢çš„æœ€ç»ˆä½ç½®last_victimå–æœ€å¤§å€¼å + of_unitï¼Œå°†å…¶ä¿å­˜ä¸ºè¿™æ¬¡æœç´ çš„æœ€ç»ˆä½ç½®ï¼Œè¿™æ ·ä¸‹æ¬¡æœç´¢å°±å¯ä»¥ç›´æ¥ä»è¿™ä¸ªä½ç½®å¼€å§‹ã€è®°å¿†åŒ–æœç´¢ï¼ŒèŠ‚çœæ—¶é—´å¤æ‚åº¦ã€‘ã€‚</li><li><strong>*result &#x3D; (p.min_segno &#x2F; p.ofs_unit) * p.ofs_unit</strong>ï¼šå°†æ‰¾åˆ°çš„æœ€å°ä»£ä»·çš„segmentNoè¿”å›ã€‚<strong>è¿™é‡Œä¸ºä»€ä¹ˆå…ˆé™¤åä¹˜</strong>ï¼Œä¸»è¦æ˜¯é’ˆå¯¹victimä¸ºsectionçš„åœºæ™¯ã€è¿™é‡Œçš„resultè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªsectionä¸­çš„ç¬¬ä¸€ä¸ªsegnoï¼Œmin_segno&#x3D;9ï¼Œä¸€ä¸ªsectionæœ‰4ä¸ªsegmentï¼ˆå³ofs_unit&#x3D;4ï¼‰ï¼Œæœ€ç»ˆç»“æœä¸º(9&#x2F;4)*4&#x3D;8ï¼Œä¹Ÿå°±æ˜¯æ‰¾åˆ°äº†æœ€å°ä»£ä»·çš„é‚£ä¸ªsectionçš„èµ·å§‹segNoã€‘</li></ul><h2 id="4-ä»£ç è§’åº¦è§£æLFSå’ŒSSR"><a href="#4-ä»£ç è§’åº¦è§£æLFSå’ŒSSR" class="headerlink" title="4.ä»£ç è§’åº¦è§£æLFSå’ŒSSR"></a>4.ä»£ç è§’åº¦è§£æLFSå’ŒSSR</h2><p>f2fsæ–‡ä»¶ç³»ç»Ÿä¸­åˆ†é…segmentæ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰</p><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127221230546.png" alt="image-20231127221230546" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">allocate_segment_by_default</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">int</span> type, <span class="hljs-type">bool</span> force)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><br><span class="hljs-keyword">if</span> (force)<br>new_curseg(sbi, type, <span class="hljs-literal">true</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!is_set_ckpt_flags(sbi, CP_CRC_RECOVERY_FLAG) &amp;&amp;<br>curseg-&gt;seg_type == CURSEG_WARM_NODE)<br>new_curseg(sbi, type, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (curseg-&gt;alloc_type == LFS &amp;&amp;<br>is_next_segment_free(sbi, curseg, type) &amp;&amp;<br>likely(!is_sbi_flag_set(sbi, SBI_CP_DISABLED)))<br>new_curseg(sbi, type, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f2fs_need_SSR(sbi) &amp;&amp;<br>get_ssr_segment(sbi, type, SSR, <span class="hljs-number">0</span>))<br>change_curseg(sbi, type, <span class="hljs-literal">true</span>);<br><span class="hljs-keyword">else</span><br>new_curseg(sbi, type, <span class="hljs-literal">false</span>);<br><br>stat_inc_seg_type(sbi, curseg);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231127221624982.png" alt="image-20231127221624982" style="zoom:80%;"><h3 id="4-1-LFSåˆ†é…å‡½æ•°get-new-segment"><a href="#4-1-LFSåˆ†é…å‡½æ•°get-new-segment" class="headerlink" title="4.1 LFSåˆ†é…å‡½æ•°get_new_segment"></a>4.1 LFSåˆ†é…å‡½æ•°get_new_segment</h3><p>LFSåˆ†é…æ–°çš„Segmentçš„æ–¹å¼ä¸ºï¼š<code>new_curseg(sbi, type, false)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">new_curseg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> type, <span class="hljs-type">bool</span> new_sec)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> seg_type = curseg-&gt;seg_type;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno = curseg-&gt;segno;<br><span class="hljs-type">int</span> dir = ALLOC_LEFT;<br><br>    <span class="hljs-comment">// çœç•¥ä¸€äº›ç»†ææœ«èŠ‚çš„ä»£ç å’Œdiræ–¹å‘é€‰æ‹©</span><br>    <br>get_new_segment(sbi, &amp;segno, new_sec, dir);<br>curseg-&gt;next_segno = segno;<br>curseg-&gt;alloc_type = LFS;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å¯»æ‰¾åˆ°Free Segmentçš„ä¸»è¦å‡½æ•°ä¸º<strong>get_new_segment</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">get_new_segment</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *newseg, <span class="hljs-type">bool</span> new_sec, <span class="hljs-type">int</span> dir)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_segmap_info</span> *<span class="hljs-title">free_i</span> =</span> FREE_I(sbi);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno, secno, zoneno;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> total_zones = MAIN_SECS(sbi) / sbi-&gt;secs_per_zone;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hint = GET_SEC_FROM_SEG(sbi, *newseg);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_zoneno = GET_ZONE_FROM_SEG(sbi, *newseg);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left_start = hint;<br><span class="hljs-type">bool</span> init = <span class="hljs-literal">true</span>;<br><span class="hljs-type">int</span> go_left = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> i;<br><br>spin_lock(&amp;free_i-&gt;segmap_lock);<br><br><span class="hljs-keyword">if</span> (!new_sec &amp;&amp; ((*newseg + <span class="hljs-number">1</span>) % sbi-&gt;segs_per_sec)) &#123;<br>segno = find_next_zero_bit(free_i-&gt;free_segmap,<br>GET_SEG_FROM_SEC(sbi, hint + <span class="hljs-number">1</span>), *newseg + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (segno &lt; GET_SEG_FROM_SEC(sbi, hint + <span class="hljs-number">1</span>))<br><span class="hljs-keyword">goto</span> got_it;<br>&#125;<br>find_other_zone:<br>secno = find_next_zero_bit(free_i-&gt;free_secmap, MAIN_SECS(sbi), hint);<br><span class="hljs-keyword">if</span> (secno &gt;= MAIN_SECS(sbi)) &#123;<br><span class="hljs-keyword">if</span> (dir == ALLOC_RIGHT) &#123;<br>secno = find_next_zero_bit(free_i-&gt;free_secmap,<br>MAIN_SECS(sbi), <span class="hljs-number">0</span>);<br>f2fs_bug_on(sbi, secno &gt;= MAIN_SECS(sbi));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>go_left = <span class="hljs-number">1</span>;<br>left_start = hint - <span class="hljs-number">1</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (go_left == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> skip_left;<br><br><span class="hljs-keyword">while</span> (test_bit(left_start, free_i-&gt;free_secmap)) &#123;<br><span class="hljs-keyword">if</span> (left_start &gt; <span class="hljs-number">0</span>) &#123;<br>left_start--;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>left_start = find_next_zero_bit(free_i-&gt;free_secmap,<br>MAIN_SECS(sbi), <span class="hljs-number">0</span>);<br>f2fs_bug_on(sbi, left_start &gt;= MAIN_SECS(sbi));<br><span class="hljs-keyword">break</span>;<br>&#125;<br>secno = left_start;<br>skip_left:<br>segno = GET_SEG_FROM_SEC(sbi, secno);<br>zoneno = GET_ZONE_FROM_SEC(sbi, secno);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NR_CURSEG_TYPE; i++)<br><span class="hljs-keyword">if</span> (CURSEG_I(sbi, i)-&gt;zone == zoneno)<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">if</span> (i &lt; NR_CURSEG_TYPE) &#123;<br><span class="hljs-comment">/* zone is in user, try another */</span><br><span class="hljs-keyword">if</span> (go_left)<br>hint = zoneno * sbi-&gt;secs_per_zone - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zoneno + <span class="hljs-number">1</span> &gt;= total_zones)<br>hint = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">else</span><br>hint = (zoneno + <span class="hljs-number">1</span>) * sbi-&gt;secs_per_zone;<br>init = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">goto</span> find_other_zone;<br>&#125;<br>got_it:<br><span class="hljs-comment">/* set it as dirty segment in free segmap */</span><br>f2fs_bug_on(sbi, test_bit(segno, free_i-&gt;free_segmap));<br>__set_inuse(sbi, segno);<br>*newseg = segno;<br>spin_unlock(&amp;free_i-&gt;segmap_lock);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-SSRåˆ†é…å‡½æ•°get-ssr-segment"><a href="#4-2-SSRåˆ†é…å‡½æ•°get-ssr-segment" class="headerlink" title="4.2 SSRåˆ†é…å‡½æ•°get_ssr_segment"></a>4.2 SSRåˆ†é…å‡½æ•°get_ssr_segment</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_ssr_segment</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> type,</span><br><span class="hljs-params"><span class="hljs-type">int</span> alloc_mode, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> age)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">victim_selection</span> *<span class="hljs-title">v_ops</span> =</span> DIRTY_I(sbi)-&gt;v_ops;<br><span class="hljs-type">unsigned</span> segno = NULL_SEGNO;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> seg_type = curseg-&gt;seg_type;<br><span class="hljs-type">int</span> i, cnt;<br><span class="hljs-type">bool</span> reversed = <span class="hljs-literal">false</span>;<br><br>sanity_check_seg_type(sbi, seg_type);<br><br><span class="hljs-comment">/* f2fs_need_SSR() already forces to do this */</span><br><span class="hljs-keyword">if</span> (!v_ops-&gt;get_victim(sbi, &amp;segno, BG_GC, seg_type, alloc_mode, age)) &#123;<br>curseg-&gt;next_segno = segno;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå»è°ƒç”¨ç¬¬ä¸‰èŠ‚ä¸­çš„victimé€‰æ‹©ç®—æ³•æ‰¾åˆ°ä¸€ä¸ªcostæœ€å°çš„victim(segment)ï¼Œç„¶åå°†cursegæŒ‡å‘çš„ä¸‹ä¸€ä¸ªsegmentå³next_segnoèµ‹å€¼ä¸ºæ‰¾åˆ°çš„segno</p><img src="/2023/11/27/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E9%85%8Dsegment/image-20231202211805015.png" alt="image-20231202211805015" style="zoom:67%;"><p>éšåè¦æ”¹å˜å½“å‰segmentä¹Ÿå°±æ˜¯CURSEGçš„æŒ‡å‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">change_curseg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> type, <span class="hljs-type">bool</span> flush)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirty_seglist_info</span> *<span class="hljs-title">dirty_i</span> =</span> DIRTY_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> new_segno = curseg-&gt;next_segno;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary_block</span> *<span class="hljs-title">sum_node</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">sum_page</span>;</span><br><br>__set_test_and_inuse(sbi, new_segno);<br><br>reset_curseg(sbi, type, <span class="hljs-number">1</span>);  <span class="hljs-comment">// æ›´æ–°curseg-&gt;segnoä¸ºcurseg-&gt;next_segnoï¼Œä¹Ÿå°±æ˜¯é€šè¿‡get_Victimæ‰¾åˆ°çš„segment</span><br>curseg-&gt;alloc_type = SSR;<br>__next_free_blkoff(sbi, curseg, <span class="hljs-number">0</span>);<br><br>   <span class="hljs-comment">// ç›¸åº”çš„æ›´æ–°CURSEGå¯¹åº”çš„f2fs_summary_block</span><br>sum_page = f2fs_get_sum_page(sbi, new_segno);<br>sum_node = (<span class="hljs-keyword">struct</span> f2fs_summary_block *)page_address(sum_page);<br><span class="hljs-built_in">memcpy</span>(curseg-&gt;sum_blk, sum_node, SUM_ENTRY_SIZE);<br>f2fs_put_page(sum_page, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸ¯<strong>æ€»ç»“ï¼šSSRåˆ†é…çš„æ–¹å¼å°±æ˜¯ä»dirty segmentä¸­æ‰¾åˆ°ä¸€ä¸ªè¿ç§»ä»£ä»·æœ€å°çš„segmentï¼Œç„¶åå°†cursegæŒ‡å‘æ­¤segment</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå†…æ ¸æ•°æ®ç»“æ„ä¹‹Radix Tree</title>
    <link href="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/"/>
    <url>/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸æ•°æ®ç»“æ„ä¹‹Radix-Tree"><a href="#Linuxå†…æ ¸æ•°æ®ç»“æ„ä¹‹Radix-Tree" class="headerlink" title="Linuxå†…æ ¸æ•°æ®ç»“æ„ä¹‹Radix Tree"></a>Linuxå†…æ ¸æ•°æ®ç»“æ„ä¹‹Radix Tree</h1><blockquote><p>â›·ï¸è½¬è½½è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/533338300">https://zhuanlan.zhihu.com/p/533338300</a></p></blockquote><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h2><p>radix treeï¼Œåˆç§°åšåŸºæ•°æ ‘ï¼Œæ˜¯ä¸€ç§é€‚åˆäºæ„å»ºkeyä¸valueç›¸å…³è”çš„æ•°æ®ç»“æ„ã€‚åœ¨linuxå†…æ ¸ä¸­ï¼Œradix treeç”± include&#x2F;linux&#x2F;radix-tree.hå’Œlib&#x2F;radix-tree.cä¸¤ä¸ªæ–‡ä»¶å®ç°ã€‚</p><p>åœ¨linuxå†…æ ¸ä¸­pagecacheå°±æ˜¯ç”¨radix treeæ„å»ºçš„page indexä¸page ptr (æŒ‡å‘struct page)çš„å…³è”ã€‚è¯¦è§struct address_space ä¸­çš„page_treeã€‚è¿™é‡Œçš„(key,value)å¯¹ï¼Œ å°±æ˜¯(indexï¼Œ ptr)å¯¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span>*<span class="hljs-title">host</span>;</span><span class="hljs-comment">/* owner: inode, block_device */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span><span class="hljs-title">page_tree</span>;</span><br>        ...<br>&#125;<br></code></pre></td></tr></table></figure><p>radix treeä¸­çš„æ¯ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹æœ€å¤šæ‹¥æœ‰rä¸ªchildï¼Œr&#x3D;2^n (n&gt;&#x3D;1), è¿™é‡Œçš„nè¢«ç§°åšåŸºæ•°ã€‚ nä¸ªbitç§°ä½œä¸€ä¸ªbitç°‡ã€‚</p><p>åœ¨linuxå†…æ ¸çš„radix treeå®ç°ä»£ç ä¸­ï¼ŒåŸºæ•°æœ€ä¸ºæœ€å…³é”®çš„å‚æ•°è¢«å®šä¹‰æˆ6ï¼ˆRADIX_TREE_MAP_SHIFTï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªbitç°‡æ˜¯6ä¸ªbitã€‚æ‰€ä»¥linuxå†…æ ¸ä¸­radix treeçš„ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹æœ€å¤šå¯ä»¥æœ‰64ä¸ªchildã€‚</p><p>radix treeçš„æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨æœ€ä¸‹é¢ä¸€å±‚ï¼ˆå›¾ä¸­çº¢è‰²èŠ‚ç‚¹ï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½æ˜¯ä¸ºäº†æ„å»ºradix treeæ ‘è€Œåˆ›å»ºå‡ºæ¥çš„å†…éƒ¨èŠ‚ç‚¹ã€‚å¶å­èŠ‚ç‚¹åŒ…å«index-ptrå¯¹ä¸­çš„ptr itemï¼Œ ä¸‹å›¾ä¸­å°†ptrç”¨çº¢è‰²æ¥æ ‡è®°ä¸ºitemã€‚</p><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-7930d31f29a67d19368b67ae6ef01f9e_720w.webp" alt="img" style="zoom: 100%;"><p>å‡è®¾keyå€¼ç­‰äº0x840FF, å…¶äºŒè¿›åˆ¶æŒ‰ç…§6bitä¸€ç°‡å¯ä»¥å†™æˆï¼Œ000010-000100 -000011 -111111ï¼Œä»å·¦åˆ°å³çš„indexå€¼åˆ†åˆ«ä¸º2, 4, 3, 63ã€‚é‚£ä¹ˆæ ¹æ®keyå€¼0x840FFæ‰¾åˆ°valueçš„è¿‡ç¨‹å°±åªéœ€è¦4æ­¥ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼Œåœ¨æœ€ä¸Šå±‚çš„èŠ‚ç‚¹Aä¸­æ‰¾åˆ°indexä¸º2çš„slotï¼Œå…¶slot[2]æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒå±‚èŠ‚ç‚¹ä¸­çš„èŠ‚ç‚¹Bã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œåœ¨èŠ‚ç‚¹Bä¸­æ‰¾åˆ°indexä¸º4çš„slotï¼Œå…¶slot[4]æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸‰å±‚èŠ‚ç‚¹ä¸­çš„èŠ‚ç‚¹Cã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œåœ¨èŠ‚ç‚¹Cä¸­æ‰¾åˆ°indexä¸º3çš„slotï¼Œå…¶slot[3]æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸‰å±‚èŠ‚ç‚¹ä¸­çš„èŠ‚ç‚¹Dã€‚</p><p>ç¬¬å››æ­¥ï¼Œåœ¨èŠ‚ç‚¹Dä¸­æ‰¾åˆ°indexä¸º63çš„slotï¼Œå…¶slot[63]æŒ‡é’ˆæŒ‡å‘å¶å­èŠ‚ç‚¹item Eã€‚</p><h2 id="2-æ•°æ®ç»“æ„åˆè¯†"><a href="#2-æ•°æ®ç»“æ„åˆè¯†" class="headerlink" title="2.æ•°æ®ç»“æ„åˆè¯†"></a>2.æ•°æ®ç»“æ„åˆè¯†</h2><h3 id="struct-radix-tree-root"><a href="#struct-radix-tree-root" class="headerlink" title="struct radix_tree_root"></a>struct radix_tree_root</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* root tags are stored in gfp_mask, shifted by __GFP_BITS_SHIFT */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span> &#123;</span><br><span class="hljs-type">gfp_t</span>gfp_mask;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span>__<span class="hljs-title">rcu</span> *<span class="hljs-title">rnode</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¯ä¸€æ£µradix treeéƒ½å¿…é¡»æœ‰struct radix_tree_rootè¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚å…¶ä¸­</p><ul><li>gfp_maskï¼šbit 0-bit24 ç”¨åšå†…å­˜åˆ†é…çš„æ ‡è®°ï¼Œåœ¨åˆ†é…struct radix_tree_nodeç»“æ„æ—¶ï¼Œä¼ é€’ç»™å†…å­˜åˆ†é…å‡½æ•°kmem_cache_allocã€‚bit25-27ç”¨ä½œroot tagsã€‚tagçš„ä½œç”¨ä¸‹æ–‡å†ç»†è¯´ã€‚</li><li>rnodeï¼š rnodeç”¨æ¥æŒ‡å‘é¡¶å±‚çš„struct radix_tree_nodeï¼Œä¹Ÿå°±æ˜¯radix treeçš„ç¬¬ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹ï¼›å½“radix tree åªæœ‰ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¶å­èŠ‚ç‚¹çš„indexä¸º0æ—¶ï¼Œä¹Ÿå¯ä»¥å¯ä»¥ç›´æ¥æŒ‡å‘ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå³(indexï¼Œptr)å¯¹ä¸­çš„ptrã€‚</li></ul><h3 id="struct-radix-tree-node"><a href="#struct-radix-tree-node" class="headerlink" title="struct radix_tree_node"></a>struct radix_tree_node</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The radix_tree_node structure is never embedded in other data structures.</span><br><span class="hljs-comment"> * As a result, there&#x27;s no need to preserve the size.  Because the structure</span><br><span class="hljs-comment"> * is reachable via others, though, we need to preserve the original contents</span><br><span class="hljs-comment"> * for the kabi checker.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shift, <span class="hljs-comment">/* Bits remaining in each slot */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> offset<span class="hljs-comment">/* Slot offset in parent */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>count;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* Used when ascending tree */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">parent</span>;</span><br><span class="hljs-comment">/* For tree user */</span><br><span class="hljs-type">void</span> *private_data;<br>&#125;;<br><span class="hljs-comment">/* Used when freeing node */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span><span class="hljs-title">rcu_head</span>;</span><br>&#125;;<br><span class="hljs-comment">/* For tree user */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">private_list</span>;</span><br><span class="hljs-type">void</span> __rcu*slots[RADIX_TREE_MAP_SIZE];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>tags[RADIX_TREE_MAX_TAGS][RADIX_TREE_TAG_LONGS];<br>&#125;;<br></code></pre></td></tr></table></figure><p>struct radix_tree_nodeç»“æ„ä»£è¡¨radix treeçš„ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹ã€‚</p><ul><li>shiftï¼šä¸å½“å‰å†…éƒ¨èŠ‚ç‚¹åœ¨radix treeä¸­æ‰€å¤„çš„å±‚çº§ç›¸å…³ï¼Œæœ€ä½ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œshiftä¸º0ï¼Œå€’æ•°ç¬¬äºŒå±‚shiftä¸º6ã€‚ shiftä»ä½å¾€é«˜ï¼Œ é€å±‚é€’å¢6</li><li>offsetï¼šè¡¨ç¤ºä¸å½“å‰å†…éƒ¨èŠ‚ç‚¹ç›¸å…³è”çš„çˆ¶èŠ‚ç‚¹slotæ•°ç»„ä¸‹æ ‡</li><li>countï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åŒ…å«çš„childèŠ‚ç‚¹çš„ä¸ªæ•°ï¼ŒchildèŠ‚ç‚¹å¯ä»¥æ˜¯å†…éƒ¨èŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å¶å­èŠ‚ç‚¹ã€‚</li><li>parentï¼šæŒ‡å‘parent èŠ‚ç‚¹</li><li>tagsï¼šè¿™é‡Œçš„tagsæ˜¯äºŒç»´æ•°ç»„ï¼Œåœ¨64bitç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªæ•°ç»„çš„å®šä¹‰tag[3][1]ç›¸å½“äºä¸€ç»´æ•°ç»„</li><li>slotsï¼šæŒ‡é’ˆæ•°ç»„slot[64]ï¼Œ æ¯ä¸ªå…ƒç´ æŒ‡å‘ä¸€ä¸ªä¸‹ä¸€çº§çš„radix_tree_nodeç»“æ„ï¼Œæˆ–è€…æ˜¯å¶å­èŠ‚ç‚¹</li></ul><h2 id="3-radix-treeçš„å‡ ç§å½¢æ€"><a href="#3-radix-treeçš„å‡ ç§å½¢æ€" class="headerlink" title="3.radix treeçš„å‡ ç§å½¢æ€"></a>3.radix treeçš„å‡ ç§å½¢æ€</h2><h3 id="å½¢æ€1ï¼šç©ºæ ‘"><a href="#å½¢æ€1ï¼šç©ºæ ‘" class="headerlink" title="å½¢æ€1ï¼šç©ºæ ‘"></a>å½¢æ€1ï¼šç©ºæ ‘</h3><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-5c589cf83d7cedaf904f868a70d180da_720w.webp" alt="img" style="zoom: 100%;"><h3 id="å½¢æ€2ï¼šåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­ç»“ç‚¹"><a href="#å½¢æ€2ï¼šåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­ç»“ç‚¹" class="headerlink" title="å½¢æ€2ï¼šåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­ç»“ç‚¹"></a>å½¢æ€2ï¼šåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­ç»“ç‚¹</h3><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-ba5eb6f207a226081887c7538385946f_720w.webp" alt="img" style="zoom:100%;"><h3 id="å½¢æ€3ï¼šå±‚é«˜ä¸º1çš„æƒ…å½¢"><a href="#å½¢æ€3ï¼šå±‚é«˜ä¸º1çš„æƒ…å½¢" class="headerlink" title="å½¢æ€3ï¼šå±‚é«˜ä¸º1çš„æƒ…å½¢"></a>å½¢æ€3ï¼šå±‚é«˜ä¸º1çš„æƒ…å½¢</h3><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-f6d4715694b6319c8c382409e9661b71_720w.webp" alt="img" style="zoom:100%;"><h3 id="å½¢æ€4ï¼šå±‚é«˜ä¸º2çš„æƒ…å½¢"><a href="#å½¢æ€4ï¼šå±‚é«˜ä¸º2çš„æƒ…å½¢" class="headerlink" title="å½¢æ€4ï¼šå±‚é«˜ä¸º2çš„æƒ…å½¢"></a>å½¢æ€4ï¼šå±‚é«˜ä¸º2çš„æƒ…å½¢</h3><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-2d55465cd47c99ae29ada718c9f71872_720w.webp" alt="img" style="zoom:100%;"><h3 id="å½¢æ€5ï¼šå±‚é«˜ä¸º3çš„æƒ…å½¢"><a href="#å½¢æ€5ï¼šå±‚é«˜ä¸º3çš„æƒ…å½¢" class="headerlink" title="å½¢æ€5ï¼šå±‚é«˜ä¸º3çš„æƒ…å½¢"></a>å½¢æ€5ï¼šå±‚é«˜ä¸º3çš„æƒ…å½¢</h3><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-ced652319751af276ab00cb7cb73fc2c_720w.webp" alt="img" style="zoom:100%;"><h2 id="4-èŠ‚ç‚¹å†…å­˜ç®¡ç†"><a href="#4-èŠ‚ç‚¹å†…å­˜ç®¡ç†" class="headerlink" title="4.èŠ‚ç‚¹å†…å­˜ç®¡ç†"></a>4.èŠ‚ç‚¹å†…å­˜ç®¡ç†</h2><h3 id="èŠ‚ç‚¹å†…å­˜çš„åˆ†é…"><a href="#èŠ‚ç‚¹å†…å­˜çš„åˆ†é…" class="headerlink" title="èŠ‚ç‚¹å†…å­˜çš„åˆ†é…"></a>èŠ‚ç‚¹å†…å­˜çš„åˆ†é…</h3><p><strong>radix_tree_node_alloc</strong></p><p>åˆ†é…struct radix_tree_nodeå†…å­˜æ—¶ï¼Œradix_tree_node_allocä¼˜å…ˆé€‰æ‹©ä»å½“å‰cpuä¸Šçš„å†…å­˜æ± åˆ†é…å†…å­˜ã€‚å¦‚æœå†…å­˜æ± æ²¡æœ‰å†…å­˜äº†ï¼Œè¿™æ—¶æ‰ä¼šç›´æ¥è°ƒç”¨kmem_cache_allocå‡½æ•°ä»radix_tree_node_cachep slabåˆ†é…å†…å­˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This assumes that the caller has performed appropriate preallocation, and</span><br><span class="hljs-comment"> * that the caller has pinned this thread of control to the current CPU.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> radix_tree_node *<br><span class="hljs-title function_">radix_tree_node_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> radix_tree_root *root)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">ret</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">gfp_t</span> gfp_mask = root_gfp_mask(root);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Preload code isn&#x27;t irq safe and it doesn&#x27;t make sense to use</span><br><span class="hljs-comment"> * preloading during an interrupt anyway as all the allocations have</span><br><span class="hljs-comment"> * to be atomic. So just do normal allocation when in interrupt.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">/* ä¼˜å…ˆä»percpuçš„å†…å­˜æ± åˆ†é…å†…å­˜ */</span><br><span class="hljs-keyword">if</span> (!(gfp_mask &amp; __GFP_WAIT) &amp;&amp; !in_interrupt()) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_preload</span> *<span class="hljs-title">rtp</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Provided the caller has preloaded here, we will always</span><br><span class="hljs-comment"> * succeed in getting a node here (and never reach</span><br><span class="hljs-comment"> * kmem_cache_alloc)</span><br><span class="hljs-comment"> */</span><br>rtp = this_cpu_ptr(&amp;radix_tree_preloads);<br><span class="hljs-keyword">if</span> (rtp-&gt;nr) &#123;<br>ret = rtp-&gt;nodes;<br>rtp-&gt;nodes = ret-&gt;private_data;<br>ret-&gt;private_data = <span class="hljs-literal">NULL</span>;<br>rtp-&gt;nr--;<br>&#125;<br>&#125;<br>        <span class="hljs-comment">/*percpuçš„å†…å­˜æ± ä¸èƒ½æ»¡è¶³è¦æ±‚æ—¶ï¼Œæ‰ç›´æ¥ä»radix_tree_node_cachepè¿™ä¸ªslabç”³è¯·å†…å­˜ */</span><br><span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">NULL</span>)<br>ret = kmem_cache_alloc(radix_tree_node_cachep, gfp_mask);<br><br>BUG_ON(radix_tree_is_internal_node(ret));<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>radix_tree_preload_end</strong></p><p>åˆ†é…struct radix_tree_nodeå†…å­˜æ—¶ï¼Œradix_tree_node_allocä¼˜å…ˆé€‰æ‹©ä»å½“å‰cpuä¸Šçš„å†…å­˜æ± åˆ†é…å†…å­˜ã€‚å¦‚æœå†…å­˜æ± æ²¡æœ‰å†…å­˜äº†ï¼Œè¿™æ—¶æ‰ä¼šç›´æ¥è°ƒç”¨kmem_cache_allocå‡½æ•°ä»radix_tree_node_cachep slabåˆ†é…å†…å­˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This assumes that the caller has performed appropriate preallocation, and</span><br><span class="hljs-comment"> * that the caller has pinned this thread of control to the current CPU.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> radix_tree_node *<br><span class="hljs-title function_">radix_tree_node_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> radix_tree_root *root)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">ret</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">gfp_t</span> gfp_mask = root_gfp_mask(root);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Preload code isn&#x27;t irq safe and it doesn&#x27;t make sense to use</span><br><span class="hljs-comment"> * preloading during an interrupt anyway as all the allocations have</span><br><span class="hljs-comment"> * to be atomic. So just do normal allocation when in interrupt.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">/* ä¼˜å…ˆä»percpuçš„å†…å­˜æ± åˆ†é…å†…å­˜ */</span><br><span class="hljs-keyword">if</span> (!(gfp_mask &amp; __GFP_WAIT) &amp;&amp; !in_interrupt()) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_preload</span> *<span class="hljs-title">rtp</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Provided the caller has preloaded here, we will always</span><br><span class="hljs-comment"> * succeed in getting a node here (and never reach</span><br><span class="hljs-comment"> * kmem_cache_alloc)</span><br><span class="hljs-comment"> */</span><br>rtp = this_cpu_ptr(&amp;radix_tree_preloads);<br><span class="hljs-keyword">if</span> (rtp-&gt;nr) &#123;<br>ret = rtp-&gt;nodes;<br>rtp-&gt;nodes = ret-&gt;private_data;<br>ret-&gt;private_data = <span class="hljs-literal">NULL</span>;<br>rtp-&gt;nr--;<br>&#125;<br>&#125;<br>        <span class="hljs-comment">/*percpuçš„å†…å­˜æ± ä¸èƒ½æ»¡è¶³è¦æ±‚æ—¶ï¼Œæ‰ç›´æ¥ä»radix_tree_node_cachepè¿™ä¸ªslabç”³è¯·å†…å­˜ */</span><br><span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">NULL</span>)<br>ret = kmem_cache_alloc(radix_tree_node_cachep, gfp_mask);<br><br>BUG_ON(radix_tree_is_internal_node(ret));<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>radix_tree_load_root</strong></p><p>radix treeçš„å®ç°æ–‡ä»¶ä¸­å¾ˆå¤šé‡è¦çš„å‡½æ•°ï¼Œ æ¯”å¦‚__radix_tree_lookupã€__radix_tree_createç­‰å‡½æ•°ï¼Œå…¶å¼€å§‹éƒ¨åˆ†éƒ½è¦è°ƒç”¨radix_tree_load_rootã€‚é‚£ä¹ˆradix_tree_load_rootè¿™ä¸ªå‡½æ•°æ˜¯å¹²ä»€ä¹ˆå‘¢ï¼Ÿ åœ¨åˆ†æ__radix_tree_lookupä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦æŠŠradix_tree_load_rootå‡½æ•°å…ˆçœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-title function_">radix_tree_load_root</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> radix_tree_root *root,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> radix_tree_node **nodep, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *maxindex)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">node</span> =</span> rcu_dereference_raw(root-&gt;rnode);<br><br>*nodep = node;<br><br><span class="hljs-keyword">if</span> (likely(radix_tree_is_internal_node(node))) &#123;<br>node = entry_to_node(node);<br>*maxindex = node_maxindex(node);<br><span class="hljs-keyword">return</span> node-&gt;shift + RADIX_TREE_MAP_SHIFT;<br>&#125;<br><br>*maxindex = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°radix_tree_load_rootçš„å‚æ•°ï¼š</p><ul><li>rootï¼šæ ‡è¯†radix treeçš„root</li><li>nodepï¼šè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥è¿”å›radix treeçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€</li><li>maxindexï¼šè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥è¿”å›radix treeçš„å½“å‰èƒ½å®¹çº³çš„æœ€å¤§çš„indeå€¼</li></ul><p>å‡½æ•°è¿”å›å€¼ï¼š</p><ul><li>å¦‚æœradix treeç›®å‰æ˜¯ç©ºæ ‘ï¼ˆå½¢æ€1ï¼‰æˆ–è€…åªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­ç»“ç‚¹ï¼Œæ­¤æ—¶è¿”å›0</li><li>å…¶ä»–å½¢æ€ï¼Œè¿”å›å€¼ç­‰äºç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„shiftå€¼+6.</li></ul><p>å‡½æ•°radix_tree_load_rootï¼Œå…ˆå–å¾—struct radix_tree_rootçš„rnodeæŒ‡é’ˆã€‚å› ä¸ºä¸€æ£µradix treeæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªstruct radix_tree_rootç»“æ„ï¼Œè€ŒrnodeæŒ‡å‘radix tree çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡å®ƒæ‰èƒ½éå†æ•´æ£µradix treeã€‚</p><p>ä»å‰æ–‡radixçš„å½¢æ€ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“rnodeå¯ä»¥ç­‰äºNULLï¼Œ æ­¤æ—¶è¡¨ç¤ºä¸€æ£µç©ºæ ‘ï¼›rnodeä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å‘ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼› rnodeå¤§å¤šæ•°æƒ…å†µæ˜¯æŒ‡å‘ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹ã€‚rnode&#x3D;&#x3D;NULLå¾ˆå¥½åˆ¤æ–­ï¼Œé‚£ä¹ˆrnodeä¸ç­‰äºNULLæ—¶ï¼Œå¦‚ä½•åˆ¤æ–­å…¶æŒ‡å‘ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹è¿˜æ˜¯å¶å­èŠ‚ç‚¹å‘¢ï¼Ÿç›®å‰ç¨‹åºåˆ©ç”¨æŒ‡é’ˆçš„æœ€åä¸¤ä¸ªbitæ¥è¿›è¡Œåˆ¤æ–­ã€‚</p><p>radix_tree_is_internal_nodeç”¨æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸ºå†…éƒ¨èŠ‚ç‚¹ï¼Œè¿”å›å€¼ä¸ºtrueè¡¨ç¤ºptræŒ‡å‘çš„èŠ‚ç‚¹æ˜¯å†…éƒ¨èŠ‚ç‚¹ï¼Œfalseè¡¨ç¤ºpträ¸ºNULLå€¼æˆ–è€…æ˜¯å¶å­èŠ‚ç‚¹ã€‚è¿™é‡Œå‡å®šå¶å­èŠ‚ç‚¹çš„å†…å­˜åœ°å€è‡³å°‘æ˜¯æŒ‰ç…§4å­—èŠ‚å¯¹é½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œbit0~1éœ€è¦ä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> RADIX_TREE_ENTRY_MASK3UL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RADIX_TREE_INTERNAL_NODE1UL</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">radix_tree_is_internal_node</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr)</span><br>&#123;<br><span class="hljs-keyword">return</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr &amp; RADIX_TREE_ENTRY_MASK) ==<br>RADIX_TREE_INTERNAL_NODE;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°entry_to_nodeç”¨æ¥å®ç°å°†ptræŒ‡é’ˆçš„bit0~1æ©æ‰ï¼Œä¹Ÿå°±æ˜¯å°†ptrè½¬æ¢ä¸ºradix_tree_nodeç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> radix_tree_node *<span class="hljs-title function_">entry_to_node</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr &amp; ~RADIX_TREE_INTERNAL_NODE);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="èŠ‚ç‚¹æŸ¥æ‰¾è¿‡ç¨‹"><a href="#èŠ‚ç‚¹æŸ¥æ‰¾è¿‡ç¨‹" class="headerlink" title="èŠ‚ç‚¹æŸ¥æ‰¾è¿‡ç¨‹"></a>èŠ‚ç‚¹æŸ¥æ‰¾è¿‡ç¨‹</h3><p><strong>radix_tree_descend</strong></p><p>è¦æŸ¥æ‰¾indexå¯¹åº”çš„ptr itemï¼Œéœ€è¦ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹é€å±‚ä¸‹é™ï¼Œæœ€ç»ˆå¯»æ‰¾åˆ°radix treeçš„å¶å­èŠ‚ç‚¹ã€‚å·²çŸ¥éœ€è¦ç»ç”±æŸä¸€å±‚çº§çš„parentèŠ‚ç‚¹ï¼Œè¯¥å‡½æ•°è®¡ç®—ç»ç”±parentèŠ‚ç‚¹çš„å“ªä¸€ä¸ªslotæ‰èƒ½ç»§ç»­å¾€ä¸‹è¿›å±•ä¸€å±‚ã€‚</p><p>å‡½æ•°radix_tree_descendçš„å‚æ•°ï¼š</p><ul><li>parentï¼šè¾“å…¥å‚æ•°ï¼Œæ ‡è¯†radix treeçš„ä¸€ä¸ªä¸­é—´èŠ‚ç‚¹ï¼Œè¦æŸ¥æ‰¾indexå¯¹åº”çš„ptr itemï¼Œéœ€è¦ç»ç”±æ­¤èŠ‚ç‚¹</li><li>nodepï¼šè¾“å‡ºå‚æ•°ï¼Œè¦æŸ¥æ‰¾indexå¯¹åº”çš„ptr itemï¼Œéœ€è¦ç»ç”±parentèŠ‚ç‚¹çš„ä¸‹ä¸€çº§èŠ‚ç‚¹</li><li>indexï¼šè¾“å…¥å‚æ•°ï¼Œå¾…æŸ¥æ‰¾èŠ‚ç‚¹çš„index</li></ul><p>å‡½æ•°è¿”å›å€¼ï¼šç»ç”±å½“å‰parentèŠ‚ç‚¹çš„slot</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">radix_tree_descend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> radix_tree_node *parent,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> radix_tree_node **nodep, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset = (index &gt;&gt; parent-&gt;shift) &amp; RADIX_TREE_MAP_MASK;<br><span class="hljs-type">void</span> **entry = rcu_dereference_raw(parent-&gt;slots[offset]);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_RADIX_TREE_MULTIORDER</span><br><span class="hljs-keyword">if</span> (radix_tree_is_internal_node(entry)) &#123;<br><span class="hljs-keyword">if</span> (is_sibling_entry(parent, entry)) &#123;<br><span class="hljs-type">void</span> **sibentry = (<span class="hljs-type">void</span> **) entry_to_node(entry);<br>offset = get_slot_offset(parent, sibentry);<br>entry = rcu_dereference_raw(*sibentry);<br>&#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>*nodep = (<span class="hljs-type">void</span> *)entry;<br><span class="hljs-keyword">return</span> offset;<br>&#125;<br></code></pre></td></tr></table></figure><p>offset &#x3D; (index &gt;&gt; parent-&gt;shift) &amp; RADIX_TREE_MAP_MASKï¼› è¿™å¥è¯è®¡ç®—indexåœ¨å½“å‰å±‚çº§çš„6bit ç´¢å¼•ï¼Œ ä¹Ÿå°±æ˜¯åœ¨parentèŠ‚ç‚¹ä¸­çš„slotç¼–å·ã€‚parent-&gt;slots[offset]æŒ‡å‘ä¸‹ä¸€çº§ä¸­é—´èŠ‚ç‚¹æˆ–è€…å¶å­èŠ‚ç‚¹ã€‚</p><p><strong>__radix_tree_lookup</strong></p><p>å‡½æ•°__radix_tree_lookupæŸ¥æ‰¾radix treeä¸­ä¸indexå¯¹åº”çš„ptr itemã€‚</p><p>å‡½æ•°__radix_tree_lookupçš„å‚æ•°ï¼š</p><ul><li>rootï¼šè¾“å…¥å‚æ•°ï¼Œæ ‡è¯†radix treeçš„root</li><li>indexï¼šè¾“å…¥å‚æ•°ï¼Œå¾…æŸ¥æ‰¾èŠ‚ç‚¹çš„index</li><li>nodepï¼šè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥è¿”å›indexå¯¹åº”çš„ptr itemçš„parentèŠ‚ç‚¹</li><li>slotpï¼šè¾“å‡ºå‚æ•°ï¼Œç”¨æ¥è¿”å›indexå¯¹åº”çš„ptr itemå…³è”çš„slotçš„åœ°å€</li></ul><p>å‡½æ•°è¿”å›å€¼ï¼šindexå¯¹åº”çš„ptr item</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *__radix_tree_lookup-lookup an item in a radix tree</span><br><span class="hljs-comment"> *@root:radix tree root</span><br><span class="hljs-comment"> *@index:index key</span><br><span class="hljs-comment"> *@nodep:returns node</span><br><span class="hljs-comment"> *@slotp:returns slot</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Lookup and return the item at position @index in the radix</span><br><span class="hljs-comment"> *tree @root.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Until there is more than one item in the tree, no nodes are</span><br><span class="hljs-comment"> *allocated and @root-&gt;rnode is used as a direct slot instead of</span><br><span class="hljs-comment"> *pointing to a node, in which case *@nodep will be NULL.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *__radix_tree_lookup(<span class="hljs-keyword">struct</span> radix_tree_root *root, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index,<br>  <span class="hljs-keyword">struct</span> radix_tree_node **nodep, <span class="hljs-type">void</span> ***slotp)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">node</span>, *<span class="hljs-title">parent</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> maxindex;<br><span class="hljs-type">void</span> **slot;<br><br> restart:<br>parent = <span class="hljs-literal">NULL</span>;<br>slot = (<span class="hljs-type">void</span> **)&amp;root-&gt;rnode;<br>radix_tree_load_root(root, &amp;node, &amp;maxindex);<br><span class="hljs-keyword">if</span> (index &gt; maxindex)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">while</span> (radix_tree_is_internal_node(node)) &#123;<br><span class="hljs-type">unsigned</span> offset;<br><br><span class="hljs-keyword">if</span> (node == RADIX_TREE_RETRY)<br><span class="hljs-keyword">goto</span> restart;<br>parent = entry_to_node(node);<br>offset = radix_tree_descend(parent, &amp;node, index);<br>slot = parent-&gt;slots + offset;<br>&#125;<br><br><span class="hljs-keyword">if</span> (nodep)<br>*nodep = parent;<br><span class="hljs-keyword">if</span> (slotp)<br>*slotp = slot;<br><br><span class="hljs-keyword">return</span> node;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="èŠ‚ç‚¹æ’å…¥"><a href="#èŠ‚ç‚¹æ’å…¥" class="headerlink" title="èŠ‚ç‚¹æ’å…¥"></a>èŠ‚ç‚¹æ’å…¥</h3><p><strong>radix_tree_extend</strong></p><p>å‡½æ•°radix_tree_extendå®ç°radix treeçºµå‘çš„ç”Ÿé•¿ï¼Œä¹Ÿå°±æ˜¯è®©radix treeçš„é«˜åº¦å€¼å˜å¤§ã€‚å› ä¸ºæ¯å‡é«˜ä¸€å±‚ï¼Œradix treeçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„shiftå€¼éƒ½ä¼šé€’å¢6ï¼Œä»è€Œä½¿å¾—radix treeèƒ½å®¹çº³çš„æœ€å¤§indexæ‰©å¤§64å€ï¼Œæœ€ç»ˆå®ç°index &lt;&#x3D;( (1 &lt;&lt; shift) - 1)ã€‚</p><p>å‡½æ•°radix_tree_extendçš„å‚æ•°ï¼š</p><ul><li>rootï¼šè¾“å…¥å‚æ•°ï¼Œæ ‡è¯†radix treeçš„root</li><li>indexï¼šè¾“å…¥å‚æ•°ï¼Œå¾…æŸ¥æ‰¾èŠ‚ç‚¹çš„indexã€‚åœ¨radix treeä¸­è¦æœ‰è¶³å¤Ÿçš„é«˜åº¦èƒ½å¤Ÿå®¹çº³è¯¥index</li><li>shiftï¼šä¸å½“å‰radixtreeç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„shiftå€¼ç›¸å…³è”ï¼Œè¿™ä¸ªå€¼å†³å®šäº†æ ‘çš„é«˜åº¦ã€‚å¦‚æœradix treeä¸ºç©ºæ ‘ï¼ˆå½¢æ€1ï¼‰æˆ–è€…radix treeåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­èŠ‚ç‚¹(å½¢æ€2)ï¼Œåˆ™shift &#x3D; 0ï¼›å…¶ä»–çš„æƒ…å†µï¼Œshift &#x3D; ç¬¬ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„shiftå€¼+ 6</li></ul><p>radix treeæœ€å¤šèƒ½å¤Ÿå®¹çº³çš„indexçš„æœ€å¤§å€¼ï¼Œå–å†³äºradix treeç¬¬ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„shiftå€¼ã€‚ä¸åŒçš„shiftå€¼ï¼Œèƒ½å¤Ÿè¦†ç›–çš„indexæœ€å¤§å€¼å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>shift</th><th>indexçš„æœ€å¤§å€¼</th></tr></thead><tbody><tr><td>0</td><td>2^6 - 1</td></tr><tr><td>6</td><td>2^12 - 1</td></tr><tr><td>12</td><td>2^18 - 1</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>6*n</td><td>2^(shift+6) - 1</td></tr></tbody></table><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *Extend a radix tree so it can store key @index.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">radix_tree_extend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> radix_tree_root *root,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> shift)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">slot</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> maxshift;<br><span class="hljs-type">int</span> tag;<br><br><span class="hljs-comment">/* Figure out what the shift should be.  */</span><br>        <span class="hljs-comment">/* è¯¥whileå¾ªç¯ç”¨æ¥è®¡ç®—ï¼Œradix tree éœ€è¦ç”Ÿé•¿åˆ°çš„é«˜åº¦ */</span><br>maxshift = shift;<br><span class="hljs-keyword">while</span> (index &gt; shift_maxindex(maxshift))<br>maxshift += RADIX_TREE_MAP_SHIFT;<br><br>       <span class="hljs-comment">/* å¯¹äºç©ºæ ‘ï¼Œè·³è¿‡ä¸‹é¢çš„æ ‘çºµå‘ç”Ÿé•¿çš„è¿‡ç¨‹ */</span><br>slot = root-&gt;rnode;<br><span class="hljs-keyword">if</span> (!slot)<br><span class="hljs-keyword">goto</span> out;<br><br>        <span class="hljs-comment">/* ä¸‹é¢æ˜¯æ ‘çºµå‘ç”Ÿé•¿çš„è¿‡ç¨‹</span><br><span class="hljs-comment">           ç¨‹åºèµ°åˆ°è¿™é‡Œï¼Œ è¡¨ç¤ºroot-&gt;rnodeå·²ç»å­˜åœ¨ */</span><br><span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-comment">/* åˆ†é…ä¸€ä¸ªnode, è¯¥æ–°åˆ†é…çš„nodeå°†å…³è”åˆ°root-&gt;rnode</span><br><span class="hljs-comment">  ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–°åˆ†é…çš„nodeå°†æˆä¸ºæ ¹èŠ‚ç‚¹ï¼ŒåŸå…ˆçš„æ ¹èŠ‚ç‚¹åè€Œæˆä¸ºæ–°åˆ†</span><br><span class="hljs-comment">                  é…èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">node</span> =</span> radix_tree_node_alloc(root);<br><br><span class="hljs-keyword">if</span> (!node)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br><span class="hljs-comment">/* Propagate the aggregated tag info into the new root */</span><br><span class="hljs-keyword">for</span> (tag = <span class="hljs-number">0</span>; tag &lt; RADIX_TREE_MAX_TAGS; tag++) &#123;<br><span class="hljs-keyword">if</span> (root_tag_get(root, tag))<br>tag_set(node, tag, <span class="hljs-number">0</span>);<br>&#125;<br><br>BUG_ON(shift &gt; BITS_PER_LONG);<br>node-&gt;shift = shift;<br>node-&gt;offset = <span class="hljs-number">0</span>;<br>node-&gt;count = <span class="hljs-number">1</span>;<br>node-&gt;parent = <span class="hljs-literal">NULL</span>;<br><br>                <span class="hljs-comment">/* slotæ˜¯ä¹‹å‰çš„æ ¹èŠ‚ç‚¹ï¼Œ ç°åœ¨å˜æˆäº†nodeçš„å­èŠ‚ç‚¹ */</span><br><span class="hljs-keyword">if</span> (radix_tree_is_internal_node(slot))<br>entry_to_node(slot)-&gt;parent = node;<br>                <span class="hljs-comment">/* åŸå…ˆçš„æ ¹èŠ‚ç‚¹å…³è”åˆ°æ–°åˆ†é…èŠ‚ç‚¹çš„slot[0]ä¸Š */</span><br>node-&gt;slots[<span class="hljs-number">0</span>] = slot;<br>slot = node_to_entry(node);<br>rcu_assign_pointer(root-&gt;rnode, slot);<br>shift += RADIX_TREE_MAP_SHIFT;<br>&#125; <span class="hljs-keyword">while</span> (shift &lt;= maxshift);<br>out:<br>        <span class="hljs-comment">/* è¿™é‡Œæœ€åè¿”å›çš„æ—¶å€™ï¼Œmaxshiftè¿˜è¦åœ¨åŠ 6ï¼Œå› ä¸º__radix_tree_create</span><br><span class="hljs-comment">          å‡½æ•°åœ¨whileå¾ªç¯çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼Œå½“order=0ï¼Œä¸”shift=0ï¼Œ å¾ªç¯å°±ç»“æŸäº† */</span><br><span class="hljs-keyword">return</span> maxshift + RADIX_TREE_MAP_SHIFT;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€ƒè™‘åœºæ™¯1ï¼šradix_tree_extendå‡½æ•°æ‰§è¡Œå‰ï¼Œåªæœ‰ä¸€ä¸ªå¶å­èŠ‚ç‚¹</p><ul><li>è°ƒç”¨radix_tree_extendå‡½æ•°æ—¶ï¼Œindex &#x3D; 60ï¼Œshift &#x3D; 0</li><li>maxshift &#x3D; 0ï¼Œindex &#x3D; 60ï¼Œshift &#x3D;0ï¼Œwhile (index &gt; shift_maxindex(maxshift))æ¡ä»¶ä¸èƒ½æ»¡è¶³ï¼Œæ‰€ä»¥maxshift ä¸éœ€è¦é€’å¢äº†</li><li>root-&gt;rnode ä¸ç­‰äºNULLï¼Œslot &#x3D; root-&gt;rnodeã€‚å¼€å§‹æ‰§è¡Œdo{}whileå¾ªç¯,</li><li>åˆ†é…ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹node(å›¾ä¸­AèŠ‚ç‚¹)ï¼Œnode-&gt;shift &#x3D; 0, node-&gt;count &#x3D; 1ï¼Œnode-&gt;slot[0]&#x3D;item0ï¼Œ root-&gt;rnode &#x3D; node</li><li>è¿”å›å€¼æ˜¯ï¼ˆ0 + RADIX_TREE_MAP_SHIFTï¼‰&#x3D; 6</li></ul><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-979fe6a7d6d0381c1fa395bec719ad4e_720w.webp" alt="img" style="zoom:80%;"><p>è€ƒè™‘åœºæ™¯2ï¼šradix_tree_extendå‡½æ•°æ‰§è¡Œå‰ï¼Œå·²ç»æœ‰ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹A</p><ul><li>è°ƒç”¨radix_tree_extendå‡½æ•°æ—¶ï¼Œindex &#x3D; 64ï¼Œshift &#x3D; 6</li><li>maxshift &#x3D; 6ï¼Œindex &#x3D; 64, shift &#x3D; 6, while(index &gt; shift_maxindex(maxshift))æ¡ä»¶ä¸èƒ½æ»¡è¶³ï¼Œæ‰€ä»¥maxshift ä¸éœ€è¦é€’å¢äº†</li><li>root-&gt;rnode ä¸ç­‰äºNULLï¼Œslot &#x3D; root-&gt;rnodeï¼Œ å³slotæŒ‡å‘AèŠ‚ç‚¹ã€‚æ‰§è¡Œdo{}whileå¾ªç¯</li><li>åˆ†é…ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹node (å›¾ä¸­BèŠ‚ç‚¹)ï¼Œnode-&gt;shift &#x3D; 6, node-&gt;count &#x3D; 1, node-&gt;slot[0]&#x3D;item0ï¼Œ root-&gt;rnode &#x3D; nodeï¼› Açš„çˆ¶èŠ‚ç‚¹æŒ‡å‘Bï¼›</li><li>è¿”å›å€¼æ˜¯ï¼ˆmaxshift + RADIX_TREE_MAP_SHIFTï¼‰&#x3D; 12</li></ul><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-44a3bd4416f1139bfd6c04f0160f3871_720w.webp" alt="img" style="zoom:80%;"><p><strong>__radix_tree_create</strong></p><p>å‡½æ•°__radix_tree_createåœ¨ä¿æŒç°æœ‰é«˜åº¦çš„åŸºç¡€ä¸Šï¼Œåœ¨æŸ¥æ‰¾indexçš„è·¯å¾„ä¸Šæ·»åŠ ä¸­é—´èŠ‚ç‚¹ã€‚å…¶å®è¿™é‡Œæ‰€è¯´çš„ä¿æŒç°æœ‰é«˜åº¦å¹¶ä¸å‡†ç¡®ï¼Œæ¯”å¦‚å¯¹äºä¸€ä¸ªç©ºæ ‘ï¼Œåœ¨æŸ¥æ‰¾indexçš„è·¯å¾„ä¸Šæ·»åŠ ä¸­é—´èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œå®ç°äº†æ ‘é«˜åº¦çš„ç”Ÿé•¿ã€‚</p><p>å‡½æ•°radix_tree_extendçš„å‚æ•°ï¼š</p><ul><li>rootï¼šè¾“å…¥å‚æ•°ï¼Œæ ‡è¯†radix treeçš„root</li><li>indexï¼šè¾“å…¥å‚æ•°ï¼Œå¾…æŸ¥æ‰¾èŠ‚ç‚¹çš„index</li><li>orderï¼Œ è¿™æ˜¯åœ¨CONFIG_RADIX_TREE_MULTIORDERä½¿èƒ½æ—¶æ‰ä½¿ç”¨çš„å‚æ•°ï¼Œæ­£å¸¸æƒ…å†µä¸‹order &#x3D; 0</li><li>shiftï¼šä¸å½“å‰radixtreeç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„shiftå€¼ç›¸å…³è”ï¼Œè¿™ä¸ªå€¼å†³å®šäº†æ ‘çš„é«˜åº¦ã€‚å¦‚æœradix treeä¸ºç©ºæ ‘ï¼ˆå½¢æ€1ï¼‰æˆ–è€…radix treeåªæœ‰ä¸€ä¸ªindexä¸º0çš„å¶å­èŠ‚ç‚¹(å½¢æ€2)ï¼Œåˆ™shift &#x3D; 0ï¼›å…¶ä»–çš„æƒ…å†µï¼Œshift &#x3D; ç¬¬ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„shiftå€¼+ 6</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"> *__radix_tree_create-create a slot in a radix tree<br> *@root:radix tree root<br> *@index:index key<br> *@order:index occupies <span class="hljs-number">2</span>^order aligned slots<br> *@nodep:returns node<br> *@slotp:returns slot<br> *<br> *Create, <span class="hljs-keyword">if</span> necessary, and <span class="hljs-keyword">return</span> the node and slot <span class="hljs-keyword">for</span> an item<br> *at position @index in the radix tree @root.<br> *<br> *Until there is more than one item in the tree, no nodes are<br> *allocated and @root-&gt;rnode is used as a direct slot instead of<br> *pointing to a node, in which <span class="hljs-keyword">case</span> *@nodep will be <span class="hljs-literal">NULL</span>.<br> *<br> *Returns -ENOMEM, or <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> success.<br> */<br><span class="hljs-type">int</span> __radix_tree_create(<span class="hljs-keyword">struct</span> radix_tree_root *root, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index,<br><span class="hljs-type">unsigned</span> order, <span class="hljs-keyword">struct</span> radix_tree_node **nodep,<br><span class="hljs-type">void</span> ***slotp)<br>&#123;<br><span class="hljs-keyword">struct</span> radix_tree_node *node = <span class="hljs-literal">NULL</span>, *child;<br><span class="hljs-type">void</span> **slot = (<span class="hljs-type">void</span> **)&amp;root-&gt;rnode;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> maxindex;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> shift, offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> max = index | ((<span class="hljs-number">1UL</span> &lt;&lt; order) - <span class="hljs-number">1</span>);<br><br>       <span class="hljs-comment">/* radix_tree_load_rootå‡½æ•°è·å–root-&gt;rnode,  è·å–å½“å‰root-&gt;rnodeæ‰€èƒ½è¦†ç›–çš„æœ€å¤§çš„</span><br><span class="hljs-comment">          indexå€¼</span><br><span class="hljs-comment">          å¯¹äºè¿”å›å€¼shiftï¼šå¦‚æœradix treeä¸ºç©ºæ ‘(å½¢æ€1)æˆ–è€…radix treeåªæœ‰ä¸€ä¸ªindexä¸º0çš„</span><br><span class="hljs-comment">          å¶å­èŠ‚ç‚¹(å½¢æ€2),åˆ™shiftä¸º0ï¼›</span><br><span class="hljs-comment">          å…¶ä»–çš„æƒ…å†µï¼Œshiftä¸ºradix treeç¬¬ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„shiftå€¼+6  */</span><br>shift = radix_tree_load_root(root, &amp;child, &amp;maxindex);<br><br><span class="hljs-comment">/* Make sure the tree is high enough.  */</span><br>        <span class="hljs-comment">/* å¦‚æœè¦æŸ¥æ‰¾çš„indexå€¼æ¯”å½“å‰nodeæ‰€èƒ½è¦†ç›–çš„æœ€å¤§indexå€¼è¿˜è¦å¤§ï¼Œè¿™æ—¶éœ€è¦å®ç°radix </span><br><span class="hljs-comment">           treeé«˜åº¦çš„ç”Ÿé•¿, è¿™é¡¹ä»»åŠ¡ç”±radix_tree_extendå‡½æ•°å®Œæˆ</span><br><span class="hljs-comment">           radix_tree_extendå‡½æ•°è¿”å›æ—¶ï¼Œæˆ‘ä»¬æœŸæœ›radix tree å·²ç»æœ‰è¶³å¤Ÿçš„é«˜åº¦èƒ½å¤Ÿå®¹çº³</span><br><span class="hljs-comment">           è¾“å…¥å‚æ•°indexã€‚ä½†æ˜¯æœ‰ä¸€ç§ä¾‹å¤–ï¼Œå°±æ˜¯å½“root-&gt;rnodeä¸ºNULLæ—¶ï¼Œæ ‘çš„é«˜åº¦è¿˜ä¸èƒ½å¤Ÿ</span><br><span class="hljs-comment">           å®¹çº³è¾“å…¥å‚æ•°index */</span><br><span class="hljs-keyword">if</span> (max &gt; maxindex) &#123;<br><span class="hljs-type">int</span> error = radix_tree_extend(root, max, shift);<br><span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> error;<br>shift = error;<br>child = root-&gt;rnode;<br><span class="hljs-keyword">if</span> (order == shift)<br>shift += RADIX_TREE_MAP_SHIFT;<br>&#125;<br><br><span class="hljs-keyword">while</span> (shift &gt; order) &#123;<br>shift -= RADIX_TREE_MAP_SHIFT;<br>                <span class="hljs-comment">/* å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºNULLï¼Œè¡¨ç¤ºåˆ°è¾¾ä¸indexå¯¹åº”çš„itemè·¯å¾„ä¸Šä¸­é—´èŠ‚ç‚¹ç¼ºå¤±ï¼Œ</span><br><span class="hljs-comment">                   è¿™æ—¶éœ€è¦æŠŠä¸­é—´èŠ‚ç‚¹è¡¥ä¸Š */</span><br><span class="hljs-keyword">if</span> (child == <span class="hljs-literal">NULL</span>) &#123;<br><span class="hljs-comment">/* Have to add a child node.  */</span><br>child = radix_tree_node_alloc(root);<br><span class="hljs-keyword">if</span> (!child)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>child-&gt;shift = shift;<br>child-&gt;offset = offset;<br>child-&gt;parent = node;<br>rcu_assign_pointer(*slot, node_to_entry(child));<br><span class="hljs-keyword">if</span> (node)<br>node-&gt;count++;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!radix_tree_is_internal_node(child)) <span class="hljs-comment">/* åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œåœæ­¢ */</span><br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-comment">/* Go a level down */</span><br>                <span class="hljs-comment">/* å¾€æ ‘å¶æ–¹å‘ä¸‹é™ä¸€çº§ï¼Œè¿™é‡Œè°ƒç”¨radix_tree_descendæ‰¾åˆ°ä¸‹ä¸€çº§å†…éƒ¨èŠ‚ç‚¹ */</span><br>node = entry_to_node(child);<br>offset = radix_tree_descend(node, &amp;child, index);<br>slot = &amp;node-&gt;slots[offset];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_RADIX_TREE_MULTIORDER</span><br><span class="hljs-comment">/* Insert pointers to the canonical entry */</span><br><span class="hljs-keyword">if</span> (order &gt; shift) &#123;<br><span class="hljs-type">unsigned</span> i, n = <span class="hljs-number">1</span> &lt;&lt; (order - shift);<br>offset = offset &amp; ~(n - <span class="hljs-number">1</span>);<br>slot = &amp;node-&gt;slots[offset];<br>child = node_to_entry(slot);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br><span class="hljs-keyword">if</span> (slot[i])<br><span class="hljs-keyword">return</span> -EEXIST;<br>&#125;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; n; i++) &#123;<br>rcu_assign_pointer(slot[i], child);<br>node-&gt;count++;<br>&#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>         <span class="hljs-comment">/* å‡½æ•°è¿”å›æ—¶ï¼Œè¦å¡«å†™itemæ‰€åœ¨çš„çˆ¶å†…éƒ¨èŠ‚ç‚¹ï¼Œä»¥åŠä¸itemå¯¹åº”slotçš„åœ°å€ */</span><br><span class="hljs-keyword">if</span> (nodep)<br>*nodep = node;<br><span class="hljs-keyword">if</span> (slotp)<br>*slotp = slot;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€ƒè™‘åœºæ™¯1ï¼š__radix_tree_createå‡½æ•°æ‰§è¡Œå‰ï¼Œradix tree æ˜¯ä¸€ä¸ªç©ºæ ‘ï¼Œå¦‚ä¸‹å·¦å›¾ï¼› å‚æ•°index &#x3D; 63ï¼Œ order &#x3D; 0</p><ul><li>è°ƒç”¨radix_tree_load_rootå‡½æ•°å‰ï¼Œmax &#x3D; 63</li><li>è°ƒç”¨radix_tree_load_rootå‡½æ•°åï¼Œchild &#x3D; NULLï¼Œmaxindex &#x3D; 0, shift &#x3D; 0</li><li>max &gt; maxindex æ¡ä»¶æ»¡è¶³ï¼Œè°ƒç”¨radix_tree_extendå‡½æ•°; ç”±äºroot-&gt;rnode &#x3D;&#x3D;NULL, radix_tree_extendå‡½æ•°é‡Œé¢do while{}å¾ªç¯è¢«è·³è¿‡ï¼Œå‡½æ•°è¿”å›å€¼æ˜¯6</li><li>å›åˆ°__radix_tree_createå‡½æ•°ï¼Œshift &#x3D;6ï¼Œchild&#x3D;NULLï¼Œ å¼€å§‹æ‰§è¡Œwhileå¾ªç¯</li><li>shifté€’å‡åï¼Œshift&#x3D; 0ï¼Œç”±äºchild&#x3D;&#x3D;NULLï¼Œåˆ†é…ä¸€ä¸ªå†…éƒ¨èŠ‚ç‚¹childï¼ˆå›¾ä¸­AèŠ‚ç‚¹ï¼‰ï¼Œchild-&gt;shift &#x3D; 0, child-&gt;offset &#x3D; 0ï¼Œ child-&gt;parent &#x3D; NULLã€‚root-&gt;rnode &#x3D; child</li><li>å¾€æ ‘å¶æ–¹å‘ä¸‹é™ä¸€çº§ï¼Œè°ƒç”¨radix_tree_descendå,offset&#x3D;63ï¼Œchild &#x3D;NULL, slot &#x3D; &amp;root-&gt;rnode-&gt;slots[63]</li><li>nodep&#x3D;root-&gt;rnode,å³å›¾ä¸­AèŠ‚ç‚¹ï¼›slotp&#x3D;&amp;root-&gt;rnode-&gt;slots[63]ï¼Œå³AèŠ‚ç‚¹çš„slots[63]çš„åœ°å€</li></ul><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-003fd8d09948205b03761f50c3b73fed_720w.webp" alt="img" style="zoom:80%;"><p>è€ƒè™‘åœºæ™¯2ï¼š__radix_tree_createå‡½æ•°æ‰§è¡Œå‰ï¼Œradix tree å·²ç»æœ‰ä¸¤å±‚å†…éƒ¨èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å·¦å›¾ã€‚ å‚æ•°index &#x3D; 64ï¼Œ order &#x3D; 0</p><ul><li>è°ƒç”¨radix_tree_load_rootå‡½æ•°å‰ï¼Œmax &#x3D; 64</li><li>è°ƒç”¨radix_tree_load_rootå‡½æ•°åï¼Œchild &#x3D;BèŠ‚ç‚¹ï¼Œmaxindex &#x3D; 64*64-1, shift &#x3D; 12</li><li>max &gt; maxindex æ¡ä»¶ä¸æ»¡è¶³</li><li>å¼€å§‹æ‰§è¡Œwhileå¾ªç¯ï¼Œ shift&#x3D;12</li><li>shifté€’å‡åï¼Œshift&#x3D; 6ï¼Œç”±äºchildï¼&#x3D;NULLï¼Œéœ€è¦å¾€æ ‘å¶æ–¹å‘ä¸‹é™ä¸€çº§ã€‚node &#x3D; Bï¼Œè°ƒç”¨radix_tree_descendå, offset&#x3D;1ï¼Œchild &#x3D;NULL, slot &#x3D; &amp;root-&gt;rnode-&gt;slots[1]</li><li>å†æ¬¡å¾ªç¯ï¼Œshifté€’å‡åï¼Œshift&#x3D; 0ï¼Œ ç”±äºchild&#x3D;&#x3D;NULLï¼Œ åˆ†é…å†…éƒ¨èŠ‚ç‚¹C, C-&gt;shift &#x3D; 0, C-&gt;offset&#x3D; 1, C-&gt;parent &#x3D; B, B-&gt;slot[1] &#x3D; C</li><li>å¾€æ ‘å¶æ–¹å‘ä¸‹é™ä¸€çº§ã€‚node &#x3D; Cï¼Œè°ƒç”¨radix_tree_descendå, offset&#x3D;0ï¼Œchild &#x3D;NULL, slot &#x3D; &amp;C-&gt;-&gt;slots[0]</li></ul><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-31c0362e3f9dac199b884733f6086d42_r.jpg" alt="img" style="zoom:80%;"><p><strong>__radix_tree_insert</strong></p><p>å‡½æ•°__radix_tree_insertçš„å‚æ•°ï¼š</p><ul><li>rootï¼šè¾“å…¥å‚æ•°ï¼Œæ ‡è¯†radix treeçš„root</li><li>indexï¼šè¾“å…¥å‚æ•°ï¼Œå¾…æŸ¥æ‰¾èŠ‚ç‚¹çš„index</li><li>orderï¼Œ è¿™æ˜¯åœ¨CONFIG_RADIX_TREE_MULTIORDERä½¿èƒ½æ—¶æ‰ä½¿ç”¨çš„å‚æ•°ï¼Œæ­£å¸¸æƒ…å†µä¸‹order &#x3D; 0</li><li>itemï¼šä¸indexå…³è”çš„æŒ‡é’ˆï¼Œéœ€è¦æ’å…¥åˆ°radix treeçš„åˆé€‚ä½ç½®</li></ul><p>æœ‰äº†å‰æ–‡çš„å„ç§é“ºå«ï¼Œ__radix_tree_insertå‡½æ•°å°±å¾ˆç®€å•äº†ï¼Œ__radix_tree_createå‡½æ•°ä¹‹åï¼ŒnodeæŒ‡å‘äº†å¾…æ’å…¥æŒ‡é’ˆitemçš„çˆ¶èŠ‚ç‚¹ï¼Œslotæ˜¯itemæ’å…¥ä½ç½®çš„slotçš„åœ°å€ã€‚è°ƒç”¨rcu_assign_pointer(<em>slot, item)æ“ä½œç›¸å½“äº</em>slot &#x3D; itemã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *__radix_tree_insert    -    insert into a radix tree</span><br><span class="hljs-comment"> *@root:radix tree root</span><br><span class="hljs-comment"> *@index:index key</span><br><span class="hljs-comment"> *@order:key covers the 2^order indices around index</span><br><span class="hljs-comment"> *@item:item to insert</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Insert an item into the radix tree at position @index.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> __radix_tree_insert(<span class="hljs-keyword">struct</span> radix_tree_root *root, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index,<br><span class="hljs-type">unsigned</span> order, <span class="hljs-type">void</span> *item)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_node</span> *<span class="hljs-title">node</span>;</span><br><span class="hljs-type">void</span> **slot;<br><span class="hljs-type">int</span> error;<br><br>BUG_ON(radix_tree_is_internal_node(item));<br><br>         <span class="hljs-comment">/* è°ƒç”¨__radix_tree_createå‡½æ•°ï¼Œç”¨æ¥è·å–itemæ’å…¥çš„ä½ç½®ã€‚å‡½æ•°è¿”å›åï¼Œslotå˜é‡ä¿å­˜ç€itemæ’å…¥ä½ç½®çš„åœ°å€  */</span><br>error = __radix_tree_create(root, index, order, &amp;node, &amp;slot);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">return</span> error;<br><span class="hljs-keyword">if</span> (*slot != <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> -EEXIST;<br><br>         <span class="hljs-comment">/* å°†itemå¡«å†™åˆ°å¾…æ’å…¥ä½ç½® */</span><br>rcu_assign_pointer(*slot, item);<br><br><span class="hljs-keyword">if</span> (node) &#123;<br><span class="hljs-type">unsigned</span> offset = get_slot_offset(node, slot);<br>node-&gt;count++;<span class="hljs-comment">/* nodeä¸ºitemæ‰€å…³è”çš„çˆ¶èŠ‚ç‚¹ï¼Œ itemæ’å…¥ånodeçš„å­èŠ‚ç‚¹ä¸ªæ•°é€’å¢ */</span><br>BUG_ON(tag_get(node, <span class="hljs-number">0</span>, offset));<br>BUG_ON(tag_get(node, <span class="hljs-number">1</span>, offset));<br>BUG_ON(tag_get(node, <span class="hljs-number">2</span>, offset));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>BUG_ON(root_tags_get(root));<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL(__radix_tree_insert);<br></code></pre></td></tr></table></figure><img src="/2023/11/20/Linux%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BRadix-Tree/v2-818b4dcba36f5ef364e719b08840c665_r.jpg" alt="img" style="zoom:80%;"><ul><li>ä¸Šå·¦å›¾æ˜¯radix treeçš„åˆå§‹å½¢æ€ï¼šæ ‘é«˜ä¸¤å±‚ï¼Œæœ€å¤§èƒ½å®¹çº³çš„indexä¸º64*64-1ã€‚</li><li>è°ƒç”¨__radix_tree_createå‡½æ•°ï¼Œ å‡½æ•°å‚æ•°index&#x3D;64ï¼Œ order&#x3D;0ï¼›indexä¸º64äºŒè¿›åˆ¶è¡¨ç¤ºä¸º0000 0000-0100 0000ï¼ŒæŒ‰ç…§æ²¡6bitä¸ºä¸€ä¸ªç°‡æ¥è¡¨ç¤ºï¼Œåˆ™å˜æˆ 000001-000000ï¼Œ æ‰€ä»¥idnex64åœ¨radix treeåœ¨ç¬¬ä¸€å±‚ä¸­çš„offsetæ˜¯1ï¼Œ ç¬¬äºŒå±‚ä¸­çš„offsetæ˜¯0ã€‚ __radix_tree_createå‡½æ•°æŒ‡å‘åï¼Œradix treeå˜æˆäº†ä¸Šä¸­å›¾çš„å½¢æ€ï¼Œå³åœ¨ç¬¬äºŒå±‚æ·»åŠ äº†ä¸€ä¸ªä¸­é—´èŠ‚ç‚¹Cï¼ŒCå…³è”åˆ°BèŠ‚ç‚¹çš„offset&#x3D;1çš„slotä¸Šã€‚CèŠ‚ç‚¹çš„offsetä¸º0çš„slotä½ç½®æ˜¯index 64è¦æ’å…¥çš„ä½ç½®ã€‚</li><li>å°†index 64 çš„itemæ’å…¥åï¼Œå˜æˆäº†ä¸Šå³å›¾çš„å½¢çŠ¶ã€‚CèŠ‚ç‚¹çš„offsetä¸º0çš„slotä½ç½®ä¸Šæ’å…¥äº†item64ã€‚</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾</title>
    <link href="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/"/>
    <url>/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾"></a>f2fsæ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶æŸ¥æ‰¾</h1><h2 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.ç¯å¢ƒå‡†å¤‡"></a>1.ç¯å¢ƒå‡†å¤‡</h2><ul><li>åˆ›å»ºä¸€ä¸ª128Må¤§å°çš„é•œåƒf2fs.img</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/f2fs$ <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=f2fs.img bs=4k count=32768<br></code></pre></td></tr></table></figure><ul><li>æ ¼å¼åŒ–é•œåƒæˆf2fsæ–‡ä»¶ç³»ç»Ÿ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/f2fs$ mkfs.f2fs -l f2fs f2fs.img <br></code></pre></td></tr></table></figure><ul><li>æŒ‚è½½åˆ°root_dirç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/f2fs$ sudo mount -t f2fs f2fs.img root_dir/<br></code></pre></td></tr></table></figure><ul><li>æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹systemï¼Œæ–‡ä»¶hello.txtï¼ˆå¹¶å†™å…¥å†…å®¹amxixixiï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/f2fs/root_dir$ <span class="hljs-built_in">mkdir</span> system<br>amx@amxxxx:~/Desktop/f2fs/root_dir$ <br>amx@amxxxx:~/Desktop/f2fs/root_dir$ <span class="hljs-built_in">touch</span> hello.txt<br>amx@amxxxx:~/Desktop/f2fs/root_dir$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;amxixixi&quot;</span> &gt; hello.txt<br></code></pre></td></tr></table></figure><ul><li>åœ¨systemç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶PublicVolume.cpp</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/f2fs/root_dir/system$ <span class="hljs-built_in">touch</span> PublicVolume.cpp<br></code></pre></td></tr></table></figure><ul><li>æ•´ä½“çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114220202440.png" alt="image-20231114220202440" style="zoom:80%;"><h2 id="2-è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ"><a href="#2-è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ" class="headerlink" title="2.è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ"></a>2.è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ</h2><p>æŸ¥çœ‹æ ¹ç›®å½•çš„inodeå·ï¼š</p><ul><li><strong>æ³•1ï¼š</strong>dump.f2fs -d 1 f2fs.img</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114220531107.png" alt="image-20231114220531107" style="zoom: 67%;"><ul><li><strong>æ³•2ï¼š</strong>æŸ¥çœ‹f2fs_super_blockç»“æ„ä½“ï¼ˆroot_inoä½äº0x460ï¼‰</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114221513867.png" alt="image-20231114221513867" style="zoom: 67%;"><h2 id="3-æŸ¥æ‰¾æ–‡ä»¶"><a href="#3-æŸ¥æ‰¾æ–‡ä»¶" class="headerlink" title="3.æŸ¥æ‰¾æ–‡ä»¶"></a>3.æŸ¥æ‰¾æ–‡ä»¶</h2><h3 id="3-1-æŸ¥æ‰¾æ ¹ç›®å½•çš„node-block"><a href="#3-1-æŸ¥æ‰¾æ ¹ç›®å½•çš„node-block" class="headerlink" title="3.1 æŸ¥æ‰¾æ ¹ç›®å½•çš„node block"></a>3.1 æŸ¥æ‰¾æ ¹ç›®å½•çš„node block</h3><p>æˆ‘ä»¬é€šè¿‡natæŸ¥çœ‹ä¸€ä¸‹æ ¹ç›®å½•å¯¹åº”çš„blk addrï¼Œ</p><ul><li><strong>dump.f2fs -n 0~-1 f2fs.img</strong>ï¼šæŠŠnatçš„æ˜ å°„å…³ç³»dumpä¸‹æ¥</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114222207479.png" alt="image-20231114222207479" style="zoom:67%;"><p>å‘ç°æ ¹ç›®å½•ino&#x3D;3å¯¹åº”çš„blkaddrä¸º4097ï¼Œåˆ™çœŸæ­£çš„åœ°å€ä¸º4097 * 4096 &#x3D; 16,781,312 &#x3D; 0x1001000</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114222433646.png" alt="image-20231114222433646" style="zoom:67%;"><p>æ ¹èŠ‚ç‚¹çš„node blockå¿…ç„¶ä¸ºf2fs_inodeç±»å‹ï¼Œå¯¹åº”çš„ç»“æ„ä½“ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_inode</span> &#123;</span><br>__le16 i_mode;<span class="hljs-comment">/* file mode */</span><br>__u8 i_advise;<span class="hljs-comment">/* file hints */</span><br>__u8 i_inline;<span class="hljs-comment">/* file inline flags */</span><br>__le32 i_uid;<span class="hljs-comment">/* user ID */</span><br>__le32 i_gid;<span class="hljs-comment">/* group ID */</span><br>__le32 i_links;<span class="hljs-comment">/* links count */</span><br>__le64 i_size;<span class="hljs-comment">/* file size in bytes */</span><br>__le64 i_blocks;<span class="hljs-comment">/* file size in blocks */</span><br>__le64 i_atime;<span class="hljs-comment">/* access time */</span><br>__le64 i_ctime;<span class="hljs-comment">/* change time */</span><br>__le64 i_mtime;<span class="hljs-comment">/* modification time */</span><br>__le32 i_atime_nsec;<span class="hljs-comment">/* access time in nano scale */</span><br>__le32 i_ctime_nsec;<span class="hljs-comment">/* change time in nano scale */</span><br>__le32 i_mtime_nsec;<span class="hljs-comment">/* modification time in nano scale */</span><br>__le32 i_generation;<span class="hljs-comment">/* file version (for NFS) */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__le32 i_current_depth;<span class="hljs-comment">/* only for directory depth */</span><br>__le16 i_gc_failures;<span class="hljs-comment">/*</span><br><span class="hljs-comment"> * # of gc failures on pinned file.</span><br><span class="hljs-comment"> * only for regular files.</span><br><span class="hljs-comment"> */</span><br>&#125;;<br>__le32 i_xattr_nid;<span class="hljs-comment">/* nid to save xattr */</span><br>__le32 i_flags;<span class="hljs-comment">/* file attributes */</span><br>__le32 i_pino;<span class="hljs-comment">/* parent inode number */</span><br>__le32 i_namelen;<span class="hljs-comment">/* file name length */</span><br>__u8 i_name[F2FS_NAME_LEN];<span class="hljs-comment">/* file name for SPOR */</span><br>__u8 i_dir_level;<span class="hljs-comment">/* dentry_level for large dir */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_extent</span> <span class="hljs-title">i_ext</span>;</span><span class="hljs-comment">/* caching a largest extent */</span><br><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__le16 i_extra_isize;<span class="hljs-comment">/* extra inode attribute size */</span><br>__le16 i_inline_xattr_size;<span class="hljs-comment">/* inline xattr size, unit: 4 bytes */</span><br>__le32 i_projid;<span class="hljs-comment">/* project id */</span><br>__le32 i_inode_checksum;<span class="hljs-comment">/* inode meta checksum */</span><br>__le64 i_crtime;<span class="hljs-comment">/* creation time */</span><br>__le32 i_crtime_nsec;<span class="hljs-comment">/* creation time in nano scale */</span><br>__le64 i_compr_blocks;<span class="hljs-comment">/* # of compressed blocks */</span><br>__u8 i_compress_algrithm;<span class="hljs-comment">/* compress algrithm */</span><br>__u8 i_log_cluster_size;<span class="hljs-comment">/* log of cluster size */</span><br>__le16 i_padding;<span class="hljs-comment">/* padding */</span><br>__le32 i_extra_end[<span class="hljs-number">0</span>];<span class="hljs-comment">/* for attribute size calculation */</span><br>&#125; __attribute__((packed));<br>__le32 i_addr[DEF_ADDRS_PER_INODE];<span class="hljs-comment">/* Pointers to data blocks */</span><br>&#125;;<br>__le32 i_nid[<span class="hljs-number">5</span>];<span class="hljs-comment">/* direct(2), indirect(2),</span><br><span class="hljs-comment">double_indirect(1) node id */</span><br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“ä¸­i_addrå³ä¸ºå¯¹åº”çš„data blockçš„èµ·å§‹ä½ç½®ã€‚</p><ul><li>i_addr[0]ä½äº0x1001168ä½ç½®ï¼Œå…¶å€¼ä¸º0x1601</li><li>å¾—åˆ°çš„æœ‰æ•ˆä¿¡æ¯ä¸ºæ ¹ç›®å½•åªéœ€è¦ä¸€ä¸ªdata blockå°±å¯ä»¥å­˜æ”¾æ ¹ç›®å½•æ‰€æœ‰ä¿¡æ¯</li><li>å”¯ä¸€çš„ä¸€ä¸ªdata blockèµ·å§‹ä½ç½®ä¸ºï¼š0x1601 * 4096Byte &#x3D; 0x1601000</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114223000472.png" alt="image-20231114223000472" style="zoom:80%;"><h3 id="3-2-æ ¹ç›®å½•çš„data-blockæ‰¾åˆ°systemæ–‡ä»¶å¤¹"><a href="#3-2-æ ¹ç›®å½•çš„data-blockæ‰¾åˆ°systemæ–‡ä»¶å¤¹" class="headerlink" title="3.2 æ ¹ç›®å½•çš„data blockæ‰¾åˆ°systemæ–‡ä»¶å¤¹"></a>3.2 æ ¹ç›®å½•çš„data blockæ‰¾åˆ°systemæ–‡ä»¶å¤¹</h3><p>æˆ‘ä»¬çŸ¥é“è¿™ä¸ªdata blocké‡Œé¢å­˜æ”¾çš„å…¶å®éƒ½æ˜¯dentryï¼Œæ‰€ä»¥è¿™ä¸ªdata blockæ˜¯æ–‡ä»¶å¤¹å¯¹åº”çš„<strong>f2fs_dentry_block</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_dentry_block</span> &#123;</span><br><span class="hljs-comment">/* validity bitmap for directory entries in each block */</span><br>__u8 dentry_bitmap[SIZE_OF_DENTRY_BITMAP];<br>__u8 reserved[SIZE_OF_RESERVED];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_dir_entry</span> <span class="hljs-title">dentry</span>[<span class="hljs-title">NR_DENTRY_IN_BLOCK</span>];</span><br>__u8 filename[NR_DENTRY_IN_BLOCK][F2FS_SLOT_LEN];<br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ä¸€ä¸ªf2fs_dentry_blockå¯ä»¥å­˜æ”¾NR_DENTRY_IN_BLOCKï¼ˆ214ï¼‰ä¸ªç›®å½•é¡¹ï¼Œå¦‚æœè¶…è¿‡éœ€è¦æ‰©å±•data blockï¼Œä¸”éœ€è¦åœ¨å‰é¢çš„node blockä¸­é€šè¿‡i_addr[1]æŒ‡æ˜ä¸‹ä¸€ä¸ªdata blockçš„åœ°å€ã€‚</p><p>æ¯ä¸€ä¸ªç›®å½•é¡¹å¯¹åº”çš„ç»“æ„ä½“ä¸º<strong>f2fs_dir_entry</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_dir_entry</span> &#123;</span><br>__le32 hash_code;<span class="hljs-comment">/* hash code of file name */</span><br>__le32 ino;<span class="hljs-comment">/* inode number */</span><br>__le16 name_len;<span class="hljs-comment">/* lengh of file name */</span><br>__u8 file_type;<span class="hljs-comment">/* file type */</span><br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><blockquote><p>ç»“æ„ä½“f2fs_dir_entryå ç”¨11ä¸ªå­—èŠ‚</p></blockquote><p>å‰é¢çš„ç›®å½•é¡¹åˆ†åˆ«ä¸º<code>.</code> å’Œ<code> ..</code>ï¼Œsystemæ–‡ä»¶å¤¹å¯¹åº”çš„ç»“æ„ä½“ä¿¡æ¯ä¸º</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114223646727.png" alt="image-20231114223646727" style="zoom:80%;"><p>å¯ä»¥åˆ†æå‡ºå¦‚ä¸‹ç»“æœï¼š</p><ul><li>hashcodeä¸º0x27e420bb</li><li>inoä¸º0x04ã€å¯ä»¥è‡ªå·±é€šè¿‡ls -liæŸ¥çœ‹ï¼Œå‘ç°ç»“æœä¸€è‡´ã€‘</li><li>namelenä¸º0x06ã€systemæ€»å…±6ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯6ä¸ªå­—èŠ‚ï¼Œå‘ç°ç»“æœä¸€è‡´ã€‘</li><li>filetypeä¸º0x02</li></ul><h3 id="3-3-æŸ¥æ‰¾systemç›®å½•çš„node-block"><a href="#3-3-æŸ¥æ‰¾systemç›®å½•çš„node-block" class="headerlink" title="3.3 æŸ¥æ‰¾systemç›®å½•çš„node block"></a>3.3 æŸ¥æ‰¾systemç›®å½•çš„node block</h3><p>æˆ‘ä»¬çŸ¥é“äº†systemçš„inodeä¸º4ï¼Œå†å»dump_natæŸ¥çœ‹ä¸€ä¸‹ï¼Œ</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114222207479.png" alt="image-20231114222207479" style="zoom:67%;"><p>å‘ç°systemç›®å½•ino&#x3D;4å¯¹åº”çš„blkaddrä¸º4099ï¼Œåˆ™çœŸæ­£çš„åœ°å€ä¸º4099 * 4096 &#x3D; 16,789,504 &#x3D; 0x1003000</p><p>systemç›®å½•ä¸ºf2fs_inodeç±»å‹ï¼Œå…¶å…¶å®åœ°å€ä¸º0x1003000ï¼Œå¯¹åº”ç»“æ„ä½“<strong>f2fs_inode</strong></p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114225130883.png" alt="image-20231114225130883" style="zoom:67%;"><h4 id="3-3-1-systemç›®å½•ä¸­å†…è”ç›®å½•"><a href="#3-3-1-systemç›®å½•ä¸­å†…è”ç›®å½•" class="headerlink" title="3.3.1 systemç›®å½•ä¸­å†…è”ç›®å½•"></a>3.3.1 systemç›®å½•ä¸­å†…è”ç›®å½•</h4><p>å¯ä»¥å‘ç°f2fs_inodeç»“æ„ä½“çš„ç¬¬3ä¸ªå­—èŠ‚ä¸ºi_inlineï¼Œå…¶åŒ…å«äº†inline flagï¼Œå³å†…è”æ ‡å¿—ä½ï¼Œæˆ‘äº†è§£çš„æœ‰ä¸‹é¢è¿™å‡ ä¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_INLINE_XATTR0x01<span class="hljs-comment">/* file inline xattr flag */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_INLINE_DATA0x02<span class="hljs-comment">/* file inline data flag */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_INLINE_DENTRY0x04<span class="hljs-comment">/* file inline dentry flag */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_DATA_EXIST0x08<span class="hljs-comment">/* file inline data exist flag */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_INLINE_DOTS0x10<span class="hljs-comment">/* file having implicit dot dentries */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_EXTRA_ATTR0x20<span class="hljs-comment">/* file having extra attribute */</span></span><br></code></pre></td></tr></table></figure><p>åœ¨æœ¬æ–‡æ¡ˆä¾‹ä¸­ï¼Œsystemç›®å½•å¯¹åº”çš„Node blockï¼ˆf2fs_inodeï¼‰ä¸­i_inlineä¸º</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114230809363.png" alt="image-20231114230809363" style="zoom:67%;"><p>å…¶æ ‡å¿—ä½ä¸º0x5ï¼Œä¸<code>#define F2FS_INLINE_DENTRY0x04</code> ç›¸ä¸åä¸º1ï¼Œåˆ™å…¶ä¸­åŒ…å«äº†å†…è”ç›®å½•é¡¹</p><p>å†…è”ç›®å½•çš„å¤„ç†ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">* i_addr[0]ä¸ºä¿ç•™çš„ï¼ŒçœŸæ­£çš„inline data addrä¸ºi_addr[1]ã€å½“ç„¶å‰ææ˜¯i_inlineæ²¡æœ‰F2FS_EXTRA_ATTRã€‘<br>* æœ€ç»ˆçš„inline dentry block addrä¸º &amp;i_addr[1] + <br>INLINE_DENTRY_BITMAP_SIZE(node_blk) +<br>INLINE_RESERVED_SIZE(node_blk)<br><br>/* <span class="hljs-keyword">for</span> inline <span class="hljs-built_in">dir</span> */<br><span class="hljs-comment">#define NR_INLINE_DENTRY(node)(MAX_INLINE_DATA(node) * BITS_PER_BYTE / \</span><br>((SIZE_OF_DIR_ENTRY + F2FS_SLOT_LEN) * \<br>BITS_PER_BYTE + <span class="hljs-number">1</span>))<br><span class="hljs-comment">#define INLINE_DENTRY_BITMAP_SIZE(node)((NR_INLINE_DENTRY(node) + \</span><br>BITS_PER_BYTE - 1) / BITS_PER_BYTE)<br><span class="hljs-comment">#define INLINE_RESERVED_SIZE(node)(MAX_INLINE_DATA(node) - \</span><br>((SIZE_OF_DIR_ENTRY + F2FS_SLOT_LEN) * \<br>NR_INLINE_DENTRY(node) + \<br>INLINE_DENTRY_BITMAP_SIZE(node)))<br></code></pre></td></tr></table></figure><h3 id="3-4-æŸ¥æ‰¾PublicVolume-cppæ–‡ä»¶"><a href="#3-4-æŸ¥æ‰¾PublicVolume-cppæ–‡ä»¶" class="headerlink" title="3.4 æŸ¥æ‰¾PublicVolume.cppæ–‡ä»¶"></a>3.4 æŸ¥æ‰¾PublicVolume.cppæ–‡ä»¶</h3><p>è®¡ç®—å¾—ï¼š</p><ul><li>INLINE_DENTRY_BITMAP_SIZE(node_blk)&#x3D;23</li><li>INLINE_RESERVED_SIZE(node_blk)&#x3D;7</li><li>å› æ­¤inline data blockçš„èµ·å§‹ä½ç½®ä¸º&amp;i_addr[1] + 30ï¼Œå³ä¸º0x100318a</li></ul><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231115193022779.png" alt="image-20231115193022779" style="zoom:67%;"><p>å‰é¢2ä¸ªf2fs_dir_entryç»“æ„ä½“åˆ†åˆ«ä¸º.å’Œ..çš„ã€‚</p><p>è€Œå†…è”æ–‡ä»¶PublcVolume.cppçš„èµ·å§‹åœ°å€ä¸º0x10031a0ï¼š</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231114233113356.png" alt="image-20231114233113356" style="zoom:80%;"><p>å¯ä»¥åˆ†æå‡ºå¦‚ä¸‹ç»“æœï¼š</p><ul><li>hashcodeä¸º0xc9a6a599</li><li>inoä¸º0x06ã€å¯ä»¥è‡ªå·±é€šè¿‡ls -liæŸ¥çœ‹ï¼Œå‘ç°ç»“æœä¸€è‡´ã€‘</li><li>namelenä¸º0x06ã€PublicVolume.cppæ€»å…±16ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯16ä¸ªå­—èŠ‚ï¼Œå‘ç°ç»“æœä¸€è‡´ã€‘</li><li>filetypeä¸º0x01ã€è¡¨ç¤ºå¸¸è§„æ–‡ä»¶ï¼Œå‘ç°ç»“æœä¸€è‡´ã€‘</li></ul><h2 id="4-ä»£ç æµç¨‹"><a href="#4-ä»£ç æµç¨‹" class="headerlink" title="4.ä»£ç æµç¨‹"></a>4.ä»£ç æµç¨‹</h2><p>æˆ‘æ˜¯åœ¨fsck.f2fsçœ‹åˆ°äº†è¿™ä¸€å—çš„ä»£ç ï¼Œæ‰€ä»¥è‡ªå·±å†™äº†ä¸ªDemoéªŒè¯ä¸€ä¸‹ï¼Œæ‰æœ‰äº†æ­¤æ–‡ã€‚ä»£ç æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"># æ ¹ç›®å½•å¼€å§‹: fsck_chk_node_blk(sbi, <span class="hljs-literal">NULL</span>, sbi-&gt;root_ino_num, F2FS_FT_DIR, TYPE_INODE, &amp;blk_cnt, <span class="hljs-literal">NULL</span>);<br># æ‰¾åˆ°æ ¹ç›®å½•å¯¹åº”çš„Node blockï¼Œæ–‡ä»¶å¤¹å¯¹åº”f2fs_inode: ä»¥fsck_chk_inode_blk(sbi, nid, ftype, node_blk, blk_cnt, &amp;ni, child);<br># æ‰¾åˆ°i_addrä¸ºå¯¹åº”çš„data block: fsck_chk_data_blk(sbi,IS_CASEFOLDED(&amp;node_blk-&gt;i),blkaddr,...)<br># æ­¤data blockä¸ºdentry blockï¼Œå¤„ç†ç›®å½•é¡¹: __chk_dentries<br># å»ºç«‹ç›®å½•æ ‘ï¼Œå¼€å§‹æ ¡éªŒå­æ–‡ä»¶ã€é€æ­¥é€’å½’ï¼Œæ£€éªŒæ‰€æœ‰ã€‘: fsck_chk_node_blk(sbi,<span class="hljs-literal">NULL</span>, le32_to_cpu(dentry[i].ino), ftype, TYPE_INODE,...)<br></code></pre></td></tr></table></figure><p>node blockä¸º<strong>f2fs_inode</strong>ç±»å‹æ—¶å¤„ç†å†…è”æ•°æ®å’Œå†…è”æ–‡ä»¶å¤¹ä¸ºï¼š</p><img src="/2023/11/14/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231115000055194.png" alt="image-20231115000055194" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å­˜å‚¨ä»‹è´¨å¤‡å¿˜</title>
    <link href="/2023/11/12/%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E5%A4%87%E5%BF%98/"/>
    <url>/2023/11/12/%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<h1 id="å­˜å‚¨ä»‹è´¨å¤‡å¿˜"><a href="#å­˜å‚¨ä»‹è´¨å¤‡å¿˜" class="headerlink" title="å­˜å‚¨ä»‹è´¨å¤‡å¿˜"></a>å­˜å‚¨ä»‹è´¨å¤‡å¿˜</h1><p><strong>é—ªå­˜ï¼š</strong></p><ul><li><p>ã€è§†é¢‘ã€‘<a href="https://www.bilibili.com/video/BV1U94y1v7o5/?spm_id_from=333.337.search-card.all.click&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">æ‰‹æœºå­˜å‚¨æ•°æ®éƒ½é å®ƒï¼é—ªå­˜åˆ°åº•è¯´çš„æ˜¯ä»€ä¹ˆï¼Ÿ</a></p></li><li><p>ã€åšå®¢ã€‘<a href="https://blog.51cto.com/u_15077549/4295050">å­˜å‚¨è®¾å¤‡Flashå’ŒMTDã€SDã€TFã€MMCã€eMMCã€UFS</a></p></li></ul><p><strong>SDå¡ï¼š</strong></p><ul><li>ã€è§†é¢‘ã€‘<a href="https://www.bilibili.com/video/BV1t14y1H71v/?spm_id_from=333.999.0.0&vd_source=f509314d3ae36120a07762a088f1a038">é‡æ–°è®¤è¯†å­˜å‚¨å¡ â€” SDå¡</a></li></ul><p><u>ä¸‰æ˜Ÿ970EVO PLSU 2TBå›ºæ€ç¡¬ç›˜</u>ã€å›¾ç‰‡æ¥æºï¼šç¡¬ä»¶èŒ¶è°ˆã€‘</p><img src="/2023/11/12/%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E5%A4%87%E5%BF%98/image-20231220214636955.png" alt="image-20231220214636955" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“æ¨¡æ‹Ÿå™¨è™šæ‹ŸSDå¡</title>
    <link href="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/"/>
    <url>/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“æ¨¡æ‹Ÿå™¨è™šæ‹ŸSDå¡"><a href="#å®‰å“æ¨¡æ‹Ÿå™¨è™šæ‹ŸSDå¡" class="headerlink" title="å®‰å“æ¨¡æ‹Ÿå™¨è™šæ‹ŸSDå¡"></a>å®‰å“æ¨¡æ‹Ÿå™¨è™šæ‹ŸSDå¡</h1><blockquote><p>å®˜æ–¹æŒ‡å¯¼ï¼š<a href="https://developer.android.com/studio/command-line/mksdcard?hl=zh-cn">https://developer.android.com/studio/command-line/mksdcard?hl=zh-cn</a></p></blockquote><h2 id="1-æ‰¾åˆ°Android-SDK"><a href="#1-æ‰¾åˆ°Android-SDK" class="headerlink" title="1.æ‰¾åˆ°Android SDK"></a>1.æ‰¾åˆ°Android SDK</h2><p>æœ‰äº›æ—¶å€™çœŸçš„å¿˜è®°è‡ªå·±çš„Android SDKè£…åœ¨å“ªé‡Œäº†ï¼Œæˆ‘æ˜¯é€šè¿‡Android Studioæ‰¾åˆ°çš„ï¼</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109233418477.png" alt="image-20231109233418477" style="zoom: 60%;"><h2 id="2-åˆ›å»ºSDå¡é•œåƒ"><a href="#2-åˆ›å»ºSDå¡é•œåƒ" class="headerlink" title="2.åˆ›å»ºSDå¡é•œåƒ"></a>2.åˆ›å»ºSDå¡é•œåƒ</h2><p>æ‰¾åˆ°åˆšåˆšçš„Android SDKç›®å½•ï¼Œè¿›å…¥emulatorå­ç›®å½•ï¼Œå¼€å§‹åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\...\Android\Sdk\emulator&gt; mksdcard 1024M G:\CarSotrage\sdcard.img<br></code></pre></td></tr></table></figure><h2 id="3-å¯åŠ¨æ¨¡æ‹Ÿå™¨"><a href="#3-å¯åŠ¨æ¨¡æ‹Ÿå™¨" class="headerlink" title="3.å¯åŠ¨æ¨¡æ‹Ÿå™¨"></a>3.å¯åŠ¨æ¨¡æ‹Ÿå™¨</h2><p>ä¸çŸ¥é“è‡ªå·±çš„æ¨¡æ‹Ÿå™¨å«å•¥ï¼Œå¯ä»¥é€šè¿‡<code>emulator -list-avds</code>æŸ¥çœ‹</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109233802922.png" alt="image-20231109233802922" style="zoom:80%;"><p>å¯åŠ¨æ¨¡æ‹Ÿå™¨</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109233837265.png" alt="image-20231109233837265" style="zoom:80%;"><p>å¯åŠ¨å®Œæˆåï¼Œæ‹‰èµ·é€šçŸ¥æ ï¼Œå¹¶ä¸”å°†SDå¡ä½œä¸ºä¾¿æºè®¾å¤‡å³å¯ï¼</p><h2 id="4-å¾€æ¨¡æ‹ŸSDå¡ä¸­æ¨å…¥æ–‡ä»¶"><a href="#4-å¾€æ¨¡æ‹ŸSDå¡ä¸­æ¨å…¥æ–‡ä»¶" class="headerlink" title="4.å¾€æ¨¡æ‹ŸSDå¡ä¸­æ¨å…¥æ–‡ä»¶"></a>4.å¾€æ¨¡æ‹ŸSDå¡ä¸­æ¨å…¥æ–‡ä»¶</h2><h3 id="4-0-çœ‹ä¸€ä¸‹æ¨¡æ‹Ÿçš„SDå¡çš„å·æ ‡"><a href="#4-0-çœ‹ä¸€ä¸‹æ¨¡æ‹Ÿçš„SDå¡çš„å·æ ‡" class="headerlink" title="4.0 çœ‹ä¸€ä¸‹æ¨¡æ‹Ÿçš„SDå¡çš„å·æ ‡"></a>4.0 çœ‹ä¸€ä¸‹æ¨¡æ‹Ÿçš„SDå¡çš„å·æ ‡</h3><p>adb shellè¿›å»<strong>cd &#x2F;storage</strong></p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235716290.png" alt="image-20231109235716290" style="zoom:80%;"><h3 id="4-1-æ¨å…¥å›¾ç‰‡"><a href="#4-1-æ¨å…¥å›¾ç‰‡" class="headerlink" title="4.1 æ¨å…¥å›¾ç‰‡"></a>4.1 æ¨å…¥å›¾ç‰‡</h3><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109234817733.png" alt="image-20231109234817733" style="zoom:80%;"><p>æ‹‰ä¸‹é€šçŸ¥æ ï¼ŒæŸ¥çœ‹æ¨¡æ‹ŸSDå¡</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109234403637.png" alt="image-20231109234403637" style="zoom:80%;"><p>å›¾ç‰‡æ¨å…¥æˆåŠŸ</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235011754.png" alt="image-20231109235011754" style="zoom:67%;"><h3 id="4-2-æ¨å…¥æ–‡ä»¶"><a href="#4-2-æ¨å…¥æ–‡ä»¶" class="headerlink" title="4.2 æ¨å…¥æ–‡ä»¶"></a>4.2 æ¨å…¥æ–‡ä»¶</h3><p>åˆ›å»ºDocumentç›®å½•ï¼š</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235437422.png" alt="image-20231109235437422" style="zoom:80%;"><p>æ¨å…¥æ–‡ä»¶ï¼š</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235503904.png" alt="image-20231109235503904" style="zoom:80%;"><p>æ­£å¸¸æ‰“å¼€æ–‡ä»¶ï¼š</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235524949.png" alt="image-20231109235524949" style="zoom:80%;"><p>æ‰“å¼€åæ­£å¸¸é˜…è¯»ï¼š</p><img src="/2023/11/09/%E5%AE%89%E5%8D%93%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%99%9A%E6%8B%9FSD%E5%8D%A1/image-20231109235543175.png" alt="image-20231109235543175" style="zoom:80%;"><blockquote><p>èµ·å§‹ç›´æ¥æ¨åˆ°&#x2F;storage&#x2F;16FC-0C09ä¹Ÿè¡Œï¼Œåªä¸è¿‡ç°åœ¨å®‰å“æœ‰åˆ†åŒºå­˜å‚¨çš„æ¦‚å¿µï¼Œå°±ä¹ æƒ¯æ€§çš„æ”¾åˆ°äº†Documentsä¸‹é¢</p></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>vfatæ–‡ä»¶ç³»ç»Ÿç›®å½•å ç”¨å¤šä¸ªç°‡</title>
    <link href="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/"/>
    <url>/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/</url>
    
    <content type="html"><![CDATA[<h1 id="vfatæ–‡ä»¶ç³»ç»Ÿç›®å½•å ç”¨å¤šä¸ªç°‡"><a href="#vfatæ–‡ä»¶ç³»ç»Ÿç›®å½•å ç”¨å¤šä¸ªç°‡" class="headerlink" title="vfatæ–‡ä»¶ç³»ç»Ÿç›®å½•å ç”¨å¤šä¸ªç°‡"></a>vfatæ–‡ä»¶ç³»ç»Ÿç›®å½•å ç”¨å¤šä¸ªç°‡</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨è¯»fsck_msdosä»£ç çš„æ—¶å€™ï¼Œè¿™é‡Œå¾ˆè¿·æƒ‘ï¼Œ<code>readDosDirSection</code>è¿™ä¸ªæ˜¯ç”¨æ¥å»ºç«‹ç›®å½•æ ‘çš„ï¼Œåˆ°åº•åœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹do whileå¾ªç¯ä¼šè¯»å¤šä¸ªç°‡ï¼Œç„¶åå°†ç°‡é‡Œé¢æ‰€æœ‰çš„ç›®å½•é¡¹è¿›è¡Œå¤„ç†ï¼Œä»Šå¤©æ¢ç©¶ä¸€ä¸‹ï¼</p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231107225831715.png" alt="image-20231107225831715" style="zoom:67%;"><h2 id="ç¯å¢ƒæ„é€ "><a href="#ç¯å¢ƒæ„é€ " class="headerlink" title="ç¯å¢ƒæ„é€ "></a>ç¯å¢ƒæ„é€ </h2><p><strong>1ï¼‰åˆ›å»º128Mçš„vfat.img</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/vfat$ <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=vfat.img bs=4k count=32768<br>32768+0 records <span class="hljs-keyword">in</span><br>32768+0 records out<br>134217728 bytes (134 MB, 128 MiB) copied, 0.367814 s, 365 MB/s<br></code></pre></td></tr></table></figure><p><strong>2ï¼‰æ ¼å¼åŒ–ä¸ºvfatæ ¼å¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/vfat$ mkfs.vfat -F 32 vfat.img <br>mkfs.fat 4.1 (2017-01-24)<br></code></pre></td></tr></table></figure><p><strong>3ï¼‰è¿›è¡ŒæŒ‚è½½</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/vfat$ <span class="hljs-built_in">mkdir</span> root_dir<br>amx@amxxxx:~/Desktop/vfat$ sudo mount -t vfat vfat.img root_dir/<br></code></pre></td></tr></table></figure><p><strong>4ï¼‰è¿è¡Œè„šæœ¬ï¼Œåˆ›å»ºå¤šä¸ªæ–‡ä»¶</strong></p><p>é€šè¿‡<strong>bootblock</strong>ç»“æ„ä½“å¯ä»¥è¯»å‡º <strong>bpbSecPerClust</strong> å’Œ <strong>bpbBytesPerSec</strong></p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231107231225501.png" alt="image-20231107231225501" style="zoom:80%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">iosize = boot-&gt;bpbSecPerClust * boot-&gt;bpbBytesPerSec;<br>entries = iosize / <span class="hljs-number">32</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">* è¿™é‡Œæˆ‘çš„:</span><br><span class="hljs-comment">* boot-&gt;bpbSecPerClust = 1    boot-&gt;bpbBytesPerSec = 512</span><br><span class="hljs-comment">* å› æ­¤ entries = 512 / 32 = 16</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘è¿™é‡Œåªè¦åˆ›å»ºå¤§äº16ä¸ªæ–‡ä»¶ï¼Œç¼–å†™è„šæœ¬<code>touch_vfat.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>for i in &#123;1..20&#125;<br>do<br>    name=&#x27;hello&#x27;$i&#x27;.txt&#x27;<br>    sudo touch $name<br>done<br></code></pre></td></tr></table></figure><p>åˆ›å»ºæˆåŠŸï¼š</p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231107230945625.png" alt="image-20231107230945625" style="zoom:80%;"><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="æ‰¾åˆ°æ ¹ç›®å½•"><a href="#æ‰¾åˆ°æ ¹ç›®å½•" class="headerlink" title="æ‰¾åˆ°æ ¹ç›®å½•"></a>æ‰¾åˆ°æ ¹ç›®å½•</h3><p>æ ¹ç›®å½•å¼€å§‹åœ°å€ &#x3D; ((ä¿ç•™æ‰‡åŒºæ•°) + (æ¯ FAT æ‰‡åŒºæ•°) * (FAT æ•°)) * æ‰‡åŒºå­—èŠ‚æ•°<br>æ ¹ç›®å½•å¼€å§‹åœ°å€ &#x3D; (0x20 + 0x07E1 * 0x02) * 512 &#x3D; <strong>0x1FC400</strong> Bytes</p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231107234334629.png" alt="image-20231107234334629" style="zoom: 70%;"><p>å¯ä»¥çœ‹åˆ°systemç›®å½•èµ·å§‹ç°‡å·çš„é«˜16ä½ï¼ˆ0x14<del>0x15ï¼‰ä¸º00 00ï¼Œèµ·å§‹ç°‡å·çš„ä½16ä½ï¼ˆ0x1A</del>0x1Bï¼‰ä¸º03 00ï¼Œè½¬æ¢æˆå°ç«¯æ¨¡å¼åï¼Œèµ·å§‹ç°‡å·ä¸º0x03ã€‚</p><h3 id="æ‰¾åˆ°systemç›®å½•"><a href="#æ‰¾åˆ°systemç›®å½•" class="headerlink" title="æ‰¾åˆ°systemç›®å½•"></a>æ‰¾åˆ°systemç›®å½•</h3><p>å‰é¢æˆ‘ä»¬å‘ç°systemç›®å½•çš„èµ·å§‹ç›®å½•å·ä¸º03ï¼Œé‚£ä¹ˆsystemç›®å½•çš„èµ·å§‹åœ°å€ä¸ºï¼š</p><blockquote><p>æ–‡ä»¶åœ°å€ &#x3D; æ ¹ç›®å½•å¼€å§‹åœ°å€ + ((èµ·å§‹ç°‡å· - æ ¹ç›®å½•ç°‡å·(Root Cluster Number)) * æ¯ç°‡æ‰‡åŒºæ•°(Sectors Per Cluster) * æ‰‡åŒºå­—èŠ‚æ•°(Bytes Per Sector))</p></blockquote><p>æ–‡ä»¶åœ°å€ &#x3D; 0x1FC400 + (3 - 2) * 1 * 512 &#x3D; 0x1FC400  + 0x200 &#x3D; <strong>0x1FC600</strong> </p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231109223907034.png" alt="image-20231109223907034" style="zoom:80%;"><p>æˆ‘è¿™é‡Œçš„ä¸€ä¸ªç°‡ä¸º512å­—èŠ‚ï¼Œè‚¯å®šå®¹çº³ä¸ä¸‹æ‰€æœ‰çš„å­æ–‡ä»¶ï¼Œå› æ­¤è‚¯å®šä¼šåœ¨ä¸‹ä¸€ä¸ªç°‡é‡Œé¢ï¼Œæˆ‘ä»¬å»FATè¡¨çœ‹çœ‹systemæœ‰æ²¡æœ‰å½¢æˆç°‡é“¾ï¼</p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231109224227324.png" alt="image-20231109224227324" style="zoom:80%;"><p>å¯ä»¥å‘ç°systemç›®å½•å½¢æˆäº†ç°‡é“¾ <strong>3 -&gt; 5 -&gt;7 -&gt; EOF</strong>ï¼Œé‚£ä¹ˆ5å·ç°‡åº”è¯¥ä¹Ÿå­˜æ”¾çš„æ˜¯systemç›®å½•ä¸‹çš„å­æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯hello(x).txt</p><p>5å·ç°‡çš„åœ°å€ä¸º &#x3D;  0x1FC400 + (5 - 2) * 1 * 512 &#x3D; 0x1FC400  + 0x200 &#x3D; 0x1FCA00</p><img src="/2023/11/07/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E5%8D%A0%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%B0%87/image-20231109224516740.png" alt="image-20231109224516740" style="zoom:80%;"><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>ä¸€ä¸ªç›®å½•é¡¹ä¹Ÿä¼šå­˜åœ¨ç°‡é“¾ï¼Œå½“ä¸€ä¸ªç›®å½•ä¸‹é¢çš„å­ç›®å½•æˆ–è€…å­æ–‡ä»¶è¿‡å¤šï¼Œä¸€ä¸ªç°‡æ”¾ä¸ä¸‹ï¼Œé‚£ä¹ˆå°±ä¼šå½¢æˆç°‡é“¾ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä»FATè¡¨ä¸­çœ‹ç›®å½•çš„ç°‡é“¾ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linux ä¸‹æ ¼å¼åŒ– FAT32 åˆ†åŒºï¼Œåªæ˜¯ä¸€ä¸ª mkfs.vfat å°±è¡Œäº†å—ï¼Ÿ</title>
    <link href="/2023/11/07/Linux-%E4%B8%8B%E6%A0%BC%E5%BC%8F%E5%8C%96-FAT32-%E5%88%86%E5%8C%BA%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA-mkfs-vfat-%E5%B0%B1%E8%A1%8C%E4%BA%86%E5%90%97%EF%BC%9F/"/>
    <url>/2023/11/07/Linux-%E4%B8%8B%E6%A0%BC%E5%BC%8F%E5%8C%96-FAT32-%E5%88%86%E5%8C%BA%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA-mkfs-vfat-%E5%B0%B1%E8%A1%8C%E4%BA%86%E5%90%97%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="Linux-ä¸‹æ ¼å¼åŒ–-FAT32-åˆ†åŒºï¼Œåªæ˜¯ä¸€ä¸ª-mkfs-vfat-å°±è¡Œäº†å—ï¼Ÿ"><a href="#Linux-ä¸‹æ ¼å¼åŒ–-FAT32-åˆ†åŒºï¼Œåªæ˜¯ä¸€ä¸ª-mkfs-vfat-å°±è¡Œäº†å—ï¼Ÿ" class="headerlink" title="Linux ä¸‹æ ¼å¼åŒ– FAT32 åˆ†åŒºï¼Œåªæ˜¯ä¸€ä¸ª mkfs.vfat å°±è¡Œäº†å—ï¼Ÿ"></a>Linux ä¸‹æ ¼å¼åŒ– FAT32 åˆ†åŒºï¼Œåªæ˜¯ä¸€ä¸ª mkfs.vfat å°±è¡Œäº†å—ï¼Ÿ</h1><blockquote><p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒIcy_Ybkã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/Icy_Ybk/article/details/88619890">https://blog.csdn.net/Icy_Ybk/article/details/88619890</a></p></blockquote><h4 id="é—®é¢˜å‘ç°"><a href="#é—®é¢˜å‘ç°" class="headerlink" title="é—®é¢˜å‘ç°"></a>é—®é¢˜å‘ç°</h4><p>é¦–å…ˆä¸å¾—ä¸è¯´çš„æ˜¯ï¼Œå½“å¹´åœ¨æˆ‘ä¸äº†è§£å¦‚ä½•æ ¼å¼åŒ–ä¸€ä¸ªåˆ†åŒºåˆ° FAT32 ç±»å‹æ—¶ï¼Œæˆ‘é€‰æ‹©äº†ç™¾åº¦ï¼Œå½“æ—¶å¾—åˆ°çš„ç­”æ¡ˆæ˜¯ <code>mkfs.vfat device</code>ã€‚è™½ç„¶æƒŠå¥‡äºä¸ºä½•å¦‚æ­¤ç®€å•ï¼Œä½†å´æ²¡åšæ·±ç©¶ï¼Œåæ¥å­¦ä¼šäº†å¦‚ä½•çœ‹ infopageã€manpageï¼Œä¹Ÿæ²¡ä»”ç»†ç ”ç©¶è¿™é‡Œé¢çš„é—®é¢˜ã€‚</p><p>ç›´åˆ°ç°åœ¨ï¼Œåœ¨ç§ç§å¶ç„¶æƒ…å†µä¸‹ï¼Œæˆ‘æ°å¥½åœ¨ç ”ç©¶åˆ¶ä½œå¯åŠ¨ç›˜ä¸­å‡ºç°çš„é—®é¢˜ï¼Œæ°å¥½åœ¨ç ”ç©¶ windows bootsect.exe åŸç†ï¼Œæ°å¥½ç”¨ qemu æ¨¡æ‹Ÿäº†ä¸åŒçš„ç£ç›˜å»åœ¨è™šæ‹Ÿæœºé‡Œåšå®éªŒï¼Œåˆæ°å¥½åœ°æ³¨æ„åˆ°ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘æµ‹è¯•çš„æ˜¯ FAT32ï¼Œä¸ºä»€ä¹ˆæœ‰ä¸€éƒ¨åˆ†ç›˜ï¼Œå¼•å¯¼ä»£ç ä¸å…¶ä»–çš„ä¸ä¸€æ ·ï¼Ÿç»è¿‡è¯¦ç»†çš„åˆ†æï¼Œåæ¨å‡ºäº† bootsect.exe çš„ç›¸å…³æºç ï¼Œè¿™æ‰çŸ¥é“ï¼Œå…¶ä¸­æœ‰ä¸€éƒ¨åˆ†ï¼Œæ˜¯ FATï¼ˆå‡†ç¡®è¯´æ˜¯ FAT16ï¼‰ï¼Œè€Œé FAT32ã€‚</p><h4 id="çœŸå®ç­”æ¡ˆ"><a href="#çœŸå®ç­”æ¡ˆ" class="headerlink" title="çœŸå®ç­”æ¡ˆ"></a>çœŸå®ç­”æ¡ˆ</h4><p>ç»è¿‡æŸ¥çœ‹äº† <code>man mkfs.vfat</code>ï¼Œæˆ‘å‘ç°äº†å…¶ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªå‚æ•°ï¼š</p><blockquote><p>-F FAT-SIZE<br>    Specifies the type of file allocation tables used (12, 16 or 32 bit). If nothing is<br>    specified, mkfs.fat will automatically select between 12, 16 and 32 bit, whatever fits<br>    better for the filesystem size.</p></blockquote><p>-F å‚æ•°æŒ‡å®š FAT çš„ç±»å‹ï¼Œå¯é€‰çš„å€¼æœ‰ 12 ä½ã€16 ä½ä»¥åŠ 32 ä½ã€‚å½“æœªæŒ‡å®šæ—¶ï¼Œ<code>mkfs.fat</code> ä¼šè‡ªåŠ¨é€‰æ‹©å…¶ä¸­æœ€åˆé€‚çš„ã€‚</p><p>æ‰€ä»¥ï¼Œ<code>mkfs.vfat device</code> ä¸èƒ½ä¿è¯ä½ æ ¼å¼åŒ–å¾—åˆ°çš„åˆ†åŒºä¸€å®šæ˜¯ FAT32ï¼Œå®ƒä¼šè‡ªåŠ¨å†³å®šã€‚çœŸæ­£æœ‰æ•ˆçš„æ–¹æ¡ˆï¼Œåº”è¯¥æ˜¯ä½¿ç”¨ <code>mkfs.vfat -F 32 device</code> æ‰å¯ã€‚<br>ï¼ˆæ³¨ï¼šç”±äº FAT32 çš„è®¾å®šé™åˆ¶ï¼Œ<strong>ä¸æ”¯æŒå°äº 32MB çš„åˆ†åŒº</strong>ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç°‡æ•°è¾¾ä¸åˆ°è¦æ±‚ï¼Œåœ¨æŸäº›æƒ…å†µå¯èƒ½å¯¼è‡´ç³»ç»Ÿè¯†åˆ«å‡ºé”™ã€‚ï¼‰</p><h4 id="è¯¦ç»†æ¢ç©¶"><a href="#è¯¦ç»†æ¢ç©¶" class="headerlink" title="è¯¦ç»†æ¢ç©¶"></a>è¯¦ç»†æ¢ç©¶</h4><p>æˆ–è®¸è®© mkfs.vfat è‡ªå·±å†³å®šæœ€ä½³çš„æƒ…å†µå¹¶ä¸ç†æƒ³ï¼Œä½†ä¸ºä»€ä¹ˆæœ‰äº›æƒ…å†µä¸‹ï¼Œå°±æ˜¯ FAT32ï¼Œè€Œæœ‰äº›æƒ…å†µå´ä¸è¡Œï¼Ÿ</p><p>ç»è¿‡ç ”ç©¶å‘ç°ï¼Œåœ¨ dosfstools æºç çš„ mkfs.fat.c æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼š<code>establish_params</code> å’Œ <code>setup_tables</code>ã€‚</p><p>å‡½æ•° <code>establish_params</code> å¯¹å„ç§å‚æ•°ï¼Œæ¯”å¦‚æ¯ä¸ªæ‰‡åŒºçš„å­—èŠ‚æ•°ã€ä¸€ä¸ªç°‡æœ‰å¤šå°‘ä¸ªæ‰‡åŒºç­‰ï¼Œè¿›è¡Œäº†åˆå§‹è®¾å®šï¼Œè®¾å®šçš„æ¥æºåŒ…æ‹¬ç”¨æˆ·æŒ‡å®šå‚æ•°ã€åˆ†åŒºå¤§å°ç­‰ã€‚ç”±ä»£ç ä¸­çœ‹å‡ºæ¥ï¼Œåœ¨ç”¨æˆ·æœªé€šè¿‡ -F å‚æ•°æŒ‡å®šç±»å‹ï¼Œä¸”åˆ†åŒºçš„å¤§å°è¾¾åˆ°äº† 512MB æ—¶ï¼Œç¨‹åºè‡ªåŠ¨é‡‡ç”¨ FAT32 ç±»å‹ã€‚</p><p>è€Œåœ¨ <code>setup_tables</code> ä¸­çš„å†³å®šåˆ†åŒºç±»å‹éƒ¨åˆ†ï¼Œåˆ™æ˜¯æ ¹æ®ä¹‹å‰å‡½æ•°ä¸­è®¾ç½®çš„ç°‡å¤§å°ï¼Œä»¥åŠåˆ†åŒºçš„ä¿¡æ¯ï¼Œåˆ†åˆ«è®¡ç®—å‡ºä½¿ç”¨ FAT12ã€FAT16ã€FAT32 æ—¶ç°‡æ•°ç›®æ˜¯å¤šå°‘ã€‚åˆ¤æ–­å¾—åˆ°çš„ç°‡æ•°æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œä¹‹åçš„æ£€æŸ¥åŠå†³å®šã€‚å¦‚æœä¸æ˜¯ï¼Œåœ¨ä¸€ä¸ªç¡®å®šçš„ç°‡å¤§å°èŒƒå›´å†…ï¼ˆç”¨æˆ·æŒ‡å®šæˆ–è€…è‡ªåŠ¨åˆ¤æ–­ï¼‰ï¼Œå®ƒä¼šå°è¯•å¢åŠ ç°‡å¤§å°ï¼Œç›´åˆ°æ»¡è¶³è¦æ±‚ã€‚æœ€åï¼Œæ ¹æ®ä½•ç§æƒ…å†µä¸‹èƒ½å–å¾—æ›´å¤šçš„ç°‡æ•°ï¼Œé€‰æ‹©æ˜¯ä½¿ç”¨ FAT12 æˆ–è€… FAT16ã€‚</p><p>å¯è§ï¼Œ<code>mkfs.vfat</code> é™¤äº†åˆ¤æ–­åˆ†åŒºå¤§å°è¾¾åˆ° 512MB æ—¶æ‰ä½¿ç”¨ FAT32 ç±»å‹ï¼Œå°äºè¿™ä¸ªå€¼ï¼Œåˆ™åªåœ¨ FAT12 æˆ– FAT16 ä¹‹é—´é€‰æ‹©ï¼Œå°±è¿æºç ä¸­éƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªæ³¨é‡Šï¼š</p><blockquote><p>FAT32 is (not yet) choosen automatically</p></blockquote><p>å°±å®é™…çŠ¶å†µè€Œè¨€ï¼Œæˆ‘ä»¬çš„å­˜å‚¨ä»‹è´¨ä¸€èˆ¬å¹¶ä¸å°ï¼Œä¸å¤§å¯èƒ½ä½äº 512MBï¼Œæˆ–è®¸ä¸æŒ‡å®š -F å‚æ•°çš„ç­”æ¡ˆå¹¶éé”™è¯¯ï¼Œåªæ˜¯ä¸ä¸¥è°¨ï¼›è€Œå½“æˆ‘ä»¬è¿›è¡Œä¸€äº›ç ”ç©¶æ—¶ï¼Œæˆ–è€…æ°å¥½ç¢°ä¸Šå°äº 512MB çš„å­˜å‚¨ä»‹è´¨æ—¶ï¼Œé—®é¢˜æ‰å¾—ä»¥æ˜¾ç°ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ è·¯å¾„</title>
    <link href="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84/"/>
    <url>/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84/</url>
    
    <content type="html"><![CDATA[<ol><li><a href="https://anmuxixixi.github.io/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/">å¦‚ä½•åœ¨ext2æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾è‡ªå·±çš„æ–‡ä»¶</a></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/"/>
    <url>/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ç¬”è®°"><a href="#ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ç¬”è®°" class="headerlink" title="ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ç¬”è®°"></a>ext2æ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ç¬”è®°</h1><blockquote><p>å‚è€ƒï¼š<a href="https://www.bilibili.com/read/cv17345430/">https://www.bilibili.com/read/cv17345430/</a></p></blockquote><h2 id="1-å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿé•œåƒ"><a href="#1-å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿé•œåƒ" class="headerlink" title="1.å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿé•œåƒ"></a>1.å‡†å¤‡æ–‡ä»¶ç³»ç»Ÿé•œåƒ</h2><p><strong>1ï¼‰åˆ¶ä½œ128Kå¤§å°çš„é•œåƒæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2$ <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=ext2.img bs=1k count=128<br>128+0 records <span class="hljs-keyword">in</span><br>128+0 records out<br>131072 bytes (131 kB, 128 KiB) copied, 0.000203712 s, 643 MB/s<br></code></pre></td></tr></table></figure><p><strong>2ï¼‰æ ¼å¼åŒ–ä¸ºext2æ–‡ä»¶ç³»ç»Ÿæ ¼å¼</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2$ mkfs.ext2 ext2.img <br>mke2fs 1.44.5 (15-Dec-2018)<br>Discarding device blocks: <span class="hljs-keyword">done</span>                            <br>Creating filesystem with 128 1k blocks and 16 inodes<br><br>Allocating group tables: <span class="hljs-keyword">done</span>                            <br>Writing inode tables: <span class="hljs-keyword">done</span>                            <br>Writing superblocks and filesystem accounting information: <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>3ï¼‰æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2$ dumpe2fs ext2.img <br>dumpe2fs 1.44.5 (15-Dec-2018)<br>Filesystem volume name:   &lt;none&gt;<br>Last mounted on:          &lt;not available&gt;<br>Filesystem UUID:          f3e761bb-a73f-405b-9753-ebb9c66bff9f<br>Filesystem magic number:  0xEF53<br>Filesystem revision <span class="hljs-comment">#:    1 (dynamic)</span><br>Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file<br>Filesystem flags:         signed_directory_hash <br>Default mount options:    user_xattr acl<br>Filesystem state:         clean<br>Errors behavior:          Continue<br>Filesystem OS <span class="hljs-built_in">type</span>:       Linux<br>Inode count:              16<br>Block count:              128<br>Reserved block count:     6<br>Free blocks:              107<br>Free inodes:              5<br>First block:              1<br>Block size:               1024<br>Fragment size:            1024<br>Blocks per group:         8192<br>Fragments per group:      8192<br>Inodes per group:         16<br>Inode blocks per group:   2<br>Filesystem created:       Sun Nov  5 23:30:07 2023<br>Last mount time:          n/a<br>Last write time:          Sun Nov  5 23:30:07 2023<br>Mount count:              0<br>Maximum mount count:      -1<br>Last checked:             Sun Nov  5 23:30:07 2023<br>Check interval:           0 (&lt;none&gt;)<br>Reserved blocks uid:      0 (user root)<br>Reserved blocks gid:      0 (group root)<br>First inode:              11<br>Inode size:               128<br>Default directory <span class="hljs-built_in">hash</span>:   half_md4<br>Directory Hash Seed:      74e00af1-b33a-44a6-bc36-184f882b344b<br><br><br>Group 0: (Blocks 1-127)<br>  Primary superblock at 1, Group descriptors at 2-2<br>  Block bitmap at 3 (+2)<br>  Inode bitmap at 4 (+3)<br>  Inode table at 5-6 (+4)<br>  107 free blocks, 5 free inodes, 2 directories<br>  Free blocks: 21-127<br>  Free inodes: 12-16<br></code></pre></td></tr></table></figure><p><strong>4ï¼‰æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºæŒ‚è½½ç‚¹ç›®å½•</span><br>amx@amxxxx:~/Desktop/ext2$ <span class="hljs-built_in">mkdir</span> rootdir<br><br><span class="hljs-comment"># æŒ‚è½½</span><br>amx@amxxxx:~/Desktop/ext2$ sudo mount -t ext2 ext2.img rootdir/<br></code></pre></td></tr></table></figure><ul><li>ä¸‹é¢æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2/rootdir/hello$ sudo bash -c <span class="hljs-string">&#x27;echo china &gt; amx.txt&#x27;</span><br>amx@amxxxx:~/Desktop/ext2/rootdir/hello$ <span class="hljs-built_in">cat</span> amx.txt <br>china<br></code></pre></td></tr></table></figure><ul><li>ç°åœ¨çœ‹ä¸€ä¸‹ä»–ä»¬çš„inodeå·</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2/rootdir$ <span class="hljs-built_in">ls</span> -li<br>total 13<br>12 drwxr-xr-x 2 root root  1024 Nov  5 23:36 hello<br>11 drwx------ 2 root root 12288 Nov  5 23:30 lost+found<br><br>amx@amxxxx:~/Desktop/ext2/rootdir/hello$ <span class="hljs-built_in">ls</span> -li<br>total 1<br>13 -rw-r--r-- 1 root root 6 Nov  5 23:42 amx.txt<br></code></pre></td></tr></table></figure><blockquote><p>helloæ–‡ä»¶å¤¹çš„inodeå·ä¸º12ï¼Œamx.txtæ–‡ä»¶çš„inodeå·ä¸º13</p></blockquote><h2 id="2-è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ"><a href="#2-è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ" class="headerlink" title="2.è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ"></a>2.è§£ææ–‡ä»¶ç³»ç»Ÿé•œåƒ</h2><p><strong>1ï¼‰dumpæ–‡ä»¶ç³»ç»Ÿé•œåƒ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Desktop/ext2$ hexdump -C ext2.img    <br>00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00000400  10 00 00 00 80 00 00 00  06 00 00 00 6b 00 00 00  |............k...|<br>00000410  05 00 00 00 01 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000420  00 20 00 00 00 20 00 00  10 00 00 00 00 00 00 00  |. ... ..........|<br>00000430  20 b6 47 65 01 00 ff ff  53 ef 00 00 01 00 00 00  | .Ge....S.......|<br>00000440  ff b4 47 65 00 00 00 00  00 00 00 00 01 00 00 00  |..Ge............|<br>00000450  00 00 00 00 0b 00 00 00  80 00 00 00 38 00 00 00  |............8...|<br>00000460  02 00 00 00 03 00 00 00  f3 e7 61 bb a7 3f 40 5b  |..........a..?@[|<br>00000470  97 53 eb b9 c6 6b ff 9f  00 00 00 00 00 00 00 00  |.S...k..........|<br>00000480  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>000004e0  00 00 00 00 00 00 00 00  00 00 00 00 74 e0 0a f1  |............t...|<br>000004f0  b3 3a 44 a6 bc 36 18 4f  88 2b 34 4b 01 00 00 00  |.:D..6.O.+4K....|<br>00000500  0c 00 00 00 00 00 00 00  ff b4 47 65 00 00 00 00  |..........Ge....|<br>00000510  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00000560  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000570  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00000800  03 00 00 00 04 00 00 00  05 00 00 00 69 00 03 00  |............i...|<br>00000810  03 00 04 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000820  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>......<br>00001a60  00 00 00 00 7d 9b ef 10  00 00 00 00 00 00 00 00  |....&#125;...........|<br>00001a70  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00001c00  02 00 00 00 0c 00 01 02  2e 00 00 00 02 00 00 00  |................|<br>00001c10  0c 00 02 02 2e 2e 00 00  0b 00 00 00 14 00 0a 02  |................|<br>00001c20  6c 6f 73 74 2b 66 6f 75  6e 64 00 00 0c 00 00 00  |lost+found......|<br>00001c30  d4 03 05 02 68 65 6c 6c  6f 00 00 00 00 00 00 00  |....hello.......|<br>00001c40  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>......<br>*<br>00020000<br></code></pre></td></tr></table></figure><p>é•œåƒæ–‡ä»¶ä¸­ï¼ˆå‡ä¸º16è¿›åˆ¶æ˜¾ç¤ºï¼‰ </p><ul><li>00000000 å¼€å§‹çš„1kå¤§å° ä¿ç•™çš„å¼•å¯¼å— </li><li>å—1 00000400 å¼€å§‹çš„1kå¤§å° ä¿å­˜ç£ç›˜çš„è¶…çº§å— ï¼ˆdumpe2fsçš„éƒ¨åˆ†ä¿¡æ¯ä»è¿™é‡Œè·å¾—ï¼‰ </li><li>å—2 00000800 å¼€å§‹çš„1kå¤§å° ä¿å­˜å—ç»„æè¿°ç¬¦ ï¼ˆdumpe2fsçš„éƒ¨åˆ†ä¿¡æ¯ä»è¿™é‡Œè·å¾—ï¼‰ </li><li>å—3 00000c00 å¼€å§‹çš„1kå¤§å° ä¿å­˜å—ä½å›¾ </li><li>å—4 00001000 å¼€å§‹çš„1kå¤§å° ä¿å­˜ Inode ä½å›¾ </li><li>å—5 å—6 00001400 å¼€å§‹çš„2kå¤§å° ä¿å­˜ Inodeè¡¨</li><li>å‰©ä¸‹çš„ä¸ºæ•°æ®å—</li></ul><blockquote><p>å…¶åˆ†åˆ«å¯¹åº”äº†ext2æ–‡ä»¶ç³»ç»Ÿçš„å¸ƒå±€ç»“æ„ä½“</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">fs/ext2/ext2.h<br><br>ç£ç›˜è¶…çº§å—ï¼š<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ext2_super_block</span> &#123;</span><br>         __le32  s_inodes_count;         <span class="hljs-comment">/* Inodes count */</span><br>         __le32  s_blocks_count;         <span class="hljs-comment">/* Blocks count */</span><br>         __le32  s_r_blocks_count;       <span class="hljs-comment">/* Reserved blocks count */</span><br>         __le32  s_free_blocks_count;    <span class="hljs-comment">/* Free blocks count */</span><br>         __le32  s_free_inodes_count;    <span class="hljs-comment">/* Free inodes count */</span><br>         __le32  s_first_data_block;     <span class="hljs-comment">/* First Data Block */</span><br>         __le32  s_log_block_size;       <span class="hljs-comment">/* Block size */</span><br>         __le32  s_log_frag_size;        <span class="hljs-comment">/* Fragment size */</span><br>         __le32  s_blocks_per_group;     <span class="hljs-comment">/* # Blocks per group */</span><br>         __le32  s_frags_per_group;      <span class="hljs-comment">/* # Fragments per group */</span><br>         __le32  s_inodes_per_group;     <span class="hljs-comment">/* # Inodes per group */</span><br>  ...<br>&#125;<br><br>ç£ç›˜å—ç»„æè¿°ç¬¦ï¼š<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ext2_group_desc</span></span><br><span class="hljs-class">&#123;</span><br>        __le32  bg_block_bitmap;                <span class="hljs-comment">/* Blocks bitmap block */</span><br>        __le32  bg_inode_bitmap;                <span class="hljs-comment">/* Inodes bitmap block */</span><br>        __le32  bg_inode_table;         <span class="hljs-comment">/* Inodes table block */</span><br>        __le16  bg_free_blocks_count;   <span class="hljs-comment">/* Free blocks count */</span><br>        __le16  bg_free_inodes_count;   <span class="hljs-comment">/* Free inodes count */</span><br>        __le16  bg_used_dirs_count;     <span class="hljs-comment">/* Directories count */</span><br>        __le16  bg_pad;<br>        __le32  bg_reserved[<span class="hljs-number">3</span>];<br>&#125;;<br><br><br>ç£ç›˜inode:<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ext2_inode</span> &#123;</span><br>         __le16  i_mode;         <span class="hljs-comment">/* File mode */</span><br>         __le16  i_uid;          <span class="hljs-comment">/* Low 16 bits of Owner Uid */</span><br>         __le32  i_size;         <span class="hljs-comment">/* Size in bytes */</span><br>         __le32  i_atime;        <span class="hljs-comment">/* Access time */</span><br>         __le32  i_ctime;        <span class="hljs-comment">/* Creation time */</span><br>         __le32  i_mtime;        <span class="hljs-comment">/* Modification time */</span><br>         __le32  i_dtime;        <span class="hljs-comment">/* Deletion Time */</span><br>         __le16  i_gid;          <span class="hljs-comment">/* Low 16 bits of Group Id */</span><br>         __le16  i_links_count;  <span class="hljs-comment">/* Links count */</span><br>         __le32  i_blocks;       <span class="hljs-comment">/* Blocks count */</span><br>     ...<br>  __le32  i_block[EXT2_N_BLOCKS];<span class="hljs-comment">/* Pointers to blocks */</span><br> ...<br>&#125;;<br><br><br>ç£ç›˜ç›®å½•é¡¹ï¼š<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ext2_dir_entry_2</span> &#123;</span><br>        __le32  inode;                  <span class="hljs-comment">/* Inode number */</span><br>        __le16  rec_len;                <span class="hljs-comment">/* Directory entry length */</span><br>        __u8    name_len;               <span class="hljs-comment">/* Name length */</span><br>        __u8    file_type;<br>        <span class="hljs-type">char</span>    name[];                 <span class="hljs-comment">/* File name, up to EXT2_NAME_LEN */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="3-è·¯å¾„åæŸ¥æ‰¾"><a href="#3-è·¯å¾„åæŸ¥æ‰¾" class="headerlink" title="3.è·¯å¾„åæŸ¥æ‰¾"></a>3.è·¯å¾„åæŸ¥æ‰¾</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç»™æˆ‘æœ€ç›´è§‚ä¹Ÿæ˜¯æœ€å¤§çš„å¥½å¤„æ˜¯ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ä¸ªè·¯å¾„åæ¥è®¿é—®æ–‡ä»¶ï¼Œé‚£ä¹ˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç©¶ç«Ÿå¦‚ä½•æ¥æ‰¾åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„æ–‡ä»¶å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬è¯¦ç»†æ¥çœ‹ext2æ–‡ä»¶ç³»ç»Ÿå¦‚ä½•æŸ¥æ‰¾æŒ‡å®šçš„æ–‡ä»¶çš„ï¼Ÿ</p><p><strong>1ï¼‰æŸ¥æ‰¾æ ¹ç›®å½•</strong></p><p>ä¸‡äº‹å¼€å¤´éš¾ï¼Œå¯¹äºè®¿é—®ä¸€ä¸ªç›®å½•ä¸ŠæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå†…æ ¸è·¯å¾„åæŸ¥æ‰¾ä¼šåˆ¤æ–­å¹¶æ‰¾åˆ°æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨æ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™ï¼Œä¼šä»ç£ç›˜ä¸Šè¯»å–å¹¶åœ¨å†…å­˜æ„å»ºè¶…çº§å—å®ä¾‹ï¼Œç„¶åè¿›è¡Œçš„æœ€é‡è¦çš„ä¸€æ­¥æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„æ ¹inode: </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">fs/ext2/super.c<br>ext2_fill_super<br>-&gt;root = ext2_iget(sb, EXT2_ROOT_INO)   <span class="hljs-comment">//EXT2_ROOT_INOä¸º2ï¼Œç³»ç»Ÿå®šä¹‰å¥½çš„</span><br> -&gt;raw_inode = ext2_get_inode(inode-&gt;i_sb, ino, &amp;bh);  <span class="hljs-comment">//æ ¹æ®inodeå·æŸ¥æ‰¾ç£ç›˜inode</span><br>   æ ¸å¿ƒç®—æ³•å¦‚ä¸‹ï¼š<br>     -&gt;block_group = (ino - <span class="hljs-number">1</span>) / EXT2_INODES_PER_GROUP(sb)  <span class="hljs-comment">//è·å¾—å—ç»„ç¼–å·  (ino-1)/æ¯ä¸ªç»„å«æœ‰çš„inodeæ•°ç»„</span><br>      gdp = ext2_get_group_desc(sb, block_group, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">//è·å¾—å—ç»„æè¿°ç¬¦</span><br>      offset = ((ino - <span class="hljs-number">1</span>) % EXT2_INODES_PER_GROUP(sb)) * EXT2_INODE_SIZE(sb); <span class="hljs-comment">//è®¡ç®—å‡ºåœ¨ å—ç»„çš„  inodeè¡¨ä¸­çš„inodeåç§»</span><br>      block = le32_to_cpu(gdp-&gt;bg_inode_table) + (offset &gt;&gt; EXT2_BLOCK_SIZE_BITS(sb)); <span class="hljs-comment">//è®¡ç®—å‡ºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å—å·</span><br>      bh = sb_bread(sb, block))  <span class="hljs-comment">//ç»„åˆæˆsubmit_bh è¯»å–è¿™ä¸ªå—åˆ°bh</span><br>      *p = bh;  <span class="hljs-comment">//èµ‹å€¼bh  ç”¨äºè¿”å›</span><br>      offset &amp;= (EXT2_BLOCK_SIZE(sb) - <span class="hljs-number">1</span>);  <span class="hljs-comment">//è®¡ç®—å‡ºå—ä¸­åç§»</span><br>      <span class="hljs-keyword">return</span> (<span class="hljs-keyword">struct</span> ext2_inode *) (bh-&gt;b_data + offset);  <span class="hljs-comment">//è¿”å›inodeä¸­ä½ç½®</span><br></code></pre></td></tr></table></figure><p>ç®€è¿°ext2é€šè¿‡inodeå·æ‰¾åˆ°å¹¶è¯»å–ç£ç›˜inodeæ ¸å¿ƒç®—æ³•ï¼š</p><ol><li>æ ¹æ®inodeå·è®¡ç®—å‡ºæ‰€åœ¨çš„å—ç»„block_group</li><li>æ ¹æ®inodeå·è®¡ç®—å‡ºå—ç»„ä¸­çš„inodeè¡¨ä¸­çš„å­—èŠ‚åç§»offset</li><li>æ ¹æ®inodeå·è®¡ç®—å‡ºç£ç›˜inodeåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„å—å·block</li><li>æ ¹æ®å—å·block é€šè¿‡sb_breadè¯»å–ç¼“å†²åŒºå—åˆ°å†…å­˜</li><li>æ ¹æ®inodeè¡¨ä¸­çš„å­—èŠ‚åç§»offset è®¡ç®—å‡º ç£ç›˜inodeåœ¨å—ä¸­åç§»</li><li>é€šè¿‡è¯»å–çš„ç¼“å†²åŒºå’Œç£ç›˜inodeåœ¨å—ä¸­åç§» æœ€ç»ˆè¿”å›ç£ç›˜inodeç»“æ„</li></ol><blockquote><p>è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹æ€ä¹ˆè®¡ç®—å—å·ï¼šblock &#x3D; le32_to_cpu(gdp-&gt;bg_inode_table) + (offset &gt;&gt; EXT2_BLOCK_SIZE_BITS(sb));</p><ul><li>ä¸€ä¸ªå—çš„å¤§å°æ˜¯1024ï¼ˆä¸æ˜¯ä¸€å®šçš„ï¼‰ï¼Œæ˜¯ä»superblockè¯»å‡ºæ¥çš„</li><li>1024 &#x3D; 2 ^10ï¼Œå› æ­¤å¦‚æœè¦çœ‹æ˜¯åœ¨ç¬¬å‡ ä¸ªå—ï¼Œç›´æ¥å³ç§»10ä½å³å¯ï¼›æ¯”å¦‚è¯´åç§»é‡offsetä¸º1048å­—èŠ‚ï¼Œé‚£å°±åœ¨ç¬¬1ä¸ªå—ä¸­ï¼ˆä»0è®¡æ•°ï¼‰</li></ul><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106225532419.png" alt="image-20231106225532419" style="zoom:67%;"><ul><li>å…¶å®æˆ‘è§‰å¾—é™¤ä»¥1024æ›´å®¹æ˜“ç†è§£ä¸€ç‚¹</li></ul></blockquote><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs txt">â˜† æ ¹ç›®å½•inodeå·å›ºå®š: 2<br><br>å—ç»„ç¼–å·:   block_group = (ino - 1) / EXT2_INODES_PER_GROUP(sb)  = (2 - 1) / 16 = 0<br>inodeè¡¨ä¸­çš„æ ¹inodeåç§» : offset = ((ino - 1) % EXT2_INODES_PER_GROUP(sb)) * EXT2_INODE_SIZE(sb<br>                              = ( 1 % 16 ) * 128 = 128 = 0x80  (ç¬¬2ä¸ªinode  ä¹Ÿå°±æ˜¯0x480å¤„)<br>æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ ¹inodeæ‰€åœ¨å—å· : block = le32_to_cpu(gdp-&gt;bg_inode_table) + (offset &gt;&gt; EXT2_BLOCK_SIZE_BITS(sb))<br>                                = 5 + (128 &gt;&gt; 10) = 5<br>æ ¹inodeæ‰€åœ¨å—ä¸­åç§»ï¼šoffset &amp;= (EXT2_BLOCK_SIZE(sb) - 1) = 128 = 0x80<br><br>inodeä¸­ä½ç½® = bh-&gt;b_data + offset = æ‰€åœ¨å— + 0x80<br></code></pre></td></tr></table></figure><p>âœ… æ ¹inodeæ‰€åœ¨çš„é•œåƒæ–‡ä»¶ä¸­åç§»ä¸ºï¼š5 * 0x400 + 0x80 &#x3D; 0x1400 + 0x80 &#x3D; 0x1480</p><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106222848259.png" alt="image-20231106222848259" style="zoom:80%;"><ul><li><p>å¯¹ç…§ext2æ–‡ä»¶ç³»ç»Ÿç£ç›˜inodeç»“æ„ï¼Œå¯çŸ¥i_blockä¸ºç£ç›˜inodeç»“æ„çš„åç§»<strong>40 Byte</strong>å¤„ï¼Œå†…å®¹å³ä¸º0x07ï¼ˆext2é€šè¿‡i_blockæ¥æŸ¥æ‰¾æ–‡ä»¶åœ¨ç£ç›˜ä¸­çš„ä½ç½®ï¼‰ã€‚</p></li><li><p>äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œæ ¹ç›®å½•æ•°æ®å—çš„å—å· ä¸º0x7ï¼ˆé•œåƒä¸­å­—èŠ‚åç§»ä¸º 0x400 * 7&#x3D; 1c00ï¼‰ï¼Œè¿™ä¸ªæ•°æ®å—ä¸­ä¿å­˜çš„æ˜¯æ ¹ç›®å½•ä¸­åŒ…å«çš„æ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶çš„ç›®å½•é¡¹ï¼ˆæˆ‘ä»¬çŸ¥é“è¿™é‡Œä¸ºâ€.â€ã€â€..â€ã€â€dirâ€ã€â€lost+foundâ€å››ä¸ªç›®å½•é¡¹ï¼‰ã€‚</p></li></ul><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106223731775.png" alt="image-20231106223731775" style="zoom:80%;"><ul><li>æ ¹æ®ç›®å½•é¡¹ext2_dir_entry_2 ç»“æ„æˆ‘ä»¬å¯ä»¥æŸ¥è¯¢åˆ°æ–‡ä»¶åä¸ºhelloçš„ç›®å½•é¡¹ï¼Œä»è€Œè·å–helloç›®å½•çš„inodeå·ï¼Œä¸º0x0cï¼ˆå’Œæˆ‘ä»¬ä¹‹å‰é€šls -laiæ˜¾ç¤ºçš„helloç›®å½•inodeå·12æ˜¯ä¸€è‡´ï¼‰ã€‚</li></ul><p><strong>2ï¼‰æŸ¥æ‰¾helloç›®å½•</strong></p><p>å’Œä¸Šé¢æŸ¥è¯¢æ ¹inodeä¸€æ ·çš„åŸç†ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs txt">dirç›®å½•æ‰€åœ¨å—ç»„ç¼–å·: block_group = (ino - 1) / EXT2_INODES_PER_GROUP(sb)  = (12 - 1) / 16 = 0<br>dirç›®å½•æ‰€åœ¨inodeè¡¨ä¸­çš„inodeåç§» : offset = ((ino - 1) % EXT2_INODES_PER_GROUP(sb)) * EXT2_INODE_SIZE(sb<br>          = ( 11 % 16 ) * 128 = 1408ï¼ˆ0x580ï¼‰<br>æ–‡ä»¶ç³»ç»Ÿä¸­çš„dirç›®å½•çš„inodeæ‰€åœ¨å—å· : block = le32_to_cpu(gdp-&gt;bg_inode_table) + (offset &gt;&gt; EXT2_BLOCK_SIZE_BITS(sb))<br>       = 5 + (1408 &gt;&gt; 10) = 5 +1 =6<br>dirç›®å½•çš„inodeæ‰€åœ¨å—å·ä¸­åç§»ï¼šoffset &amp;= (EXT2_BLOCK_SIZE(sb) - 1) = 1408ï¼ˆ0x580ï¼‰&amp; (0x400 -1) =   0x180<br>inodeä¸­ä½ç½® = bh-&gt;b_data + offset = æ‰€åœ¨å— +  0x180<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼šdirç›®å½•inodeæ‰€åœ¨çš„é•œåƒæ–‡ä»¶ä¸­å­—èŠ‚åç§»ä¸ºï¼š6 * 0x400 + 0x180 &#x3D; 0x1800 + 0x180 &#x3D; 0x1980</p><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106224058971.png" alt="image-20231106224058971" style="zoom:80%;"><ul><li><p>å¯¹ç…§ext2æ–‡ä»¶ç³»ç»Ÿç£ç›˜inodeç»“æ„ï¼Œå¯çŸ¥i_blockä¸ºç£ç›˜inodeç»“æ„çš„åç§»40Bå¤„ï¼Œå†…å®¹å³ä¸º0x15ã€‚ </p></li><li><p>äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œdirç›®å½•æ•°æ®å—çš„å—å· ä¸º0x63ï¼ˆåç§»ä¸º 0x400 * 0x15&#x3D; 0x5400ï¼‰ï¼Œè¿™ä¸ªæ•°æ®å—ä¸­ä¿å­˜çš„æ˜¯helloç›®å½•ä¸­åŒ…å«çš„æ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶çš„ç›®å½•é¡¹ï¼ˆæˆ‘ä»¬çŸ¥é“è¿™é‡Œä¸ºâ€.â€ã€â€..â€ã€â€amx.txtâ€ä¸‰ä¸ªç›®å½•é¡¹ï¼‰ã€‚</p></li></ul><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106224235097.png" alt="image-20231106224235097" style="zoom:80%;"><ul><li><p>å¯¹ç…§ç›®å½•é¡¹ext2_dir_entry_2 ç»“æ„ï¼ŒæŸ¥æ‰¾æ–‡ä»¶åä¸ºamx.txtçš„inodeå·ï¼Œå³ä¸º0x0d(å’Œæˆ‘ä»¬ä¹‹å‰é€šls -laiæ˜¾ç¤ºçš„inodeå·13æ˜¯ä¸€è‡´ï¼‰ã€‚</p></li><li><p>äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œamx.txtæ–‡ä»¶çš„inodeå·ä¸º0x0dï¼ˆ13ï¼‰ã€‚</p></li></ul><p><strong>3ï¼‰æŸ¥æ‰¾amx.txt</strong></p><p>å’Œä¸Šé¢æŸ¥è¯¢æ ¹inodeä¸€æ ·çš„åŸç†ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š </p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs txt">amx.txtæ–‡ä»¶inodeæ‰€åœ¨å—ç»„ ç¼–å·: block_group = (ino - 1) / EXT2_INODES_PER_GROUP(sb)  = (13 - 1) / 16 = 0<br>amx.txtæ–‡ä»¶inodeåœ¨ inodeè¡¨ä¸­çš„inodeåç§» : offset = ((ino - 1) % EXT2_INODES_PER_GROUP(sb)) * EXT2_INODE_SIZE(sb<br>          = ( 12 % 16 ) * 128 = 1536ï¼ˆ0x600ï¼‰<br>æ–‡ä»¶ç³»ç»Ÿä¸­çš„amx.txtæ–‡ä»¶inodeæ‰€åœ¨å—å· : block = le32_to_cpu(gdp-&gt;bg_inode_table) + (offset &gt;&gt; EXT2_BLOCK_SIZE_BITS(sb))<br>       = 5 + (1536 &gt;&gt; 10) = 5 +1 =6<br>amx.txtæ–‡ä»¶inodeæ‰€åœ¨å—å·ä¸­åç§»ï¼šoffset &amp;= (EXT2_BLOCK_SIZE(sb) - 1) = 1408ï¼ˆ0x600ï¼‰&amp; (0x400 -1) =   0x200<br>    inodeä¸­ä½ç½® = bh-&gt;b_data + offset = æ‰€åœ¨å— +  0x200 <br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼šamx.txtæ–‡ä»¶inodeæ‰€åœ¨çš„é•œåƒæ–‡ä»¶ä¸­åç§»ä¸ºï¼š&#x3D; 6 * 0x400 + 0x200 &#x3D; 0x1800 + 0x200 &#x3D; 0x1a00 </p><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106224524268.png" alt="image-20231106224524268" style="zoom:80%;"><ul><li><p>å¯¹ç…§ext2æ–‡ä»¶ç³»ç»Ÿç£ç›˜inodeç»“æ„ï¼Œå¯çŸ¥i_blockä¸ºç£ç›˜inodeç»“æ„çš„åç§»<strong>40 Byte</strong>å¤„ï¼Œå†…å®¹å³ä¸º0x16ã€‚</p></li><li><p>äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œamx.txtæ–‡ä»¶æ•°æ®å—çš„å—å· ä¸º0x16ï¼ˆåç§»ä¸º0x16 * 0x400 &#x3D; 0x5800ï¼‰ã€‚</p></li></ul><img src="/2023/11/05/ext2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/image-20231106224641224.png" alt="image-20231106224641224" style="zoom:80%;"><ul><li>âœ… å’Œæˆ‘ä»¬å†™è¿›å»çš„å†…å®¹ä¸€æ ·ï¼Œéƒ½æ˜¯â€chinaâ€</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå‘½ä»¤æ‹¾é—-ä½¿ç”¨blktraceåˆ†æioæƒ…å†µ</title>
    <link href="/2023/10/30/Linux%E5%91%BD%E4%BB%A4%E6%8B%BE%E9%81%97-%E4%BD%BF%E7%94%A8blktrace%E5%88%86%E6%9E%90io%E6%83%85%E5%86%B5/"/>
    <url>/2023/10/30/Linux%E5%91%BD%E4%BB%A4%E6%8B%BE%E9%81%97-%E4%BD%BF%E7%94%A8blktrace%E5%88%86%E6%9E%90io%E6%83%85%E5%86%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå‘½ä»¤æ‹¾é—-ä½¿ç”¨blktraceåˆ†æioæƒ…å†µ"><a href="#Linuxå‘½ä»¤æ‹¾é—-ä½¿ç”¨blktraceåˆ†æioæƒ…å†µ" class="headerlink" title="Linuxå‘½ä»¤æ‹¾é—-ä½¿ç”¨blktraceåˆ†æioæƒ…å†µ"></a>Linuxå‘½ä»¤æ‹¾é—-ä½¿ç”¨blktraceåˆ†æioæƒ…å†µ</h1><blockquote><p>åŸåˆ›ï¼šæ‰“ç æ—¥è®°ï¼ˆå¾®ä¿¡å…¬ä¼—å·IDï¼šcodelogsï¼‰ï¼Œæ¬¢è¿åˆ†äº«ï¼Œè½¬è½½è¯·ä¿ç•™å‡ºå¤„ã€‚</p><p><a href="https://www.cnblogs.com/codelogs/p/16060775.html">https://www.cnblogs.com/codelogs/p/16060775.html</a></p></blockquote><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæƒ³æ£€æŸ¥ç£ç›˜I&#x2F;Oæƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨iostatã€iotopã€sarç­‰ï¼Œä½†è¿™äº›å‘½ä»¤åªèƒ½åšä¸€ä¸ªæ•´ä½“çš„äº†è§£ï¼Œæ²¡æ³•å…·ä½“åˆ°æŸä¸€æ¬¡ioçš„è¯¦ç»†æƒ…å†µï¼Œè€Œä»Šå¤©ä»‹ç»çš„blktraceå°±å¯ä»¥æ·±å…¥åˆ°Linux I&#x2F;Oæ ˆçš„æ–¹æ–¹é¢é¢ï¼ŒæŠŠä¸€åˆ‡éƒ½æå¾—æ˜æ˜ç™½ç™½çš„ï¼</p><h2 id="Linuxå†…æ ¸I-x2F-Oæ ˆ"><a href="#Linuxå†…æ ¸I-x2F-Oæ ˆ" class="headerlink" title="Linuxå†…æ ¸I&#x2F;Oæ ˆ"></a>Linuxå†…æ ¸I&#x2F;Oæ ˆ</h2><p>å…ˆäº†è§£ä¸‹Linuxå†…æ ¸I&#x2F;Oæ ˆï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¯¹ç½‘ç»œåè®®æ ˆæ¯”è¾ƒç†Ÿæ‚‰ï¼Œæ¯”å¦‚ç½‘ç»œåè®®åˆ†äº†5å±‚ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä½†å¯¹äºI&#x2F;Oæ ˆï¼Œåˆ™äº†è§£ç›¸å¯¹è¾ƒå°‘ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/10/30/Linux%E5%91%BD%E4%BB%A4%E6%8B%BE%E9%81%97-%E4%BD%BF%E7%94%A8blktrace%E5%88%86%E6%9E%90io%E6%83%85%E5%86%B5/2792815-20220326203847680-773190512.png" alt="Linux-storage-stack-diagram_v4.0" style="zoom:80%;"><p>Linuxå†…æ ¸I&#x2F;Oæ ˆå¤§æ¦‚åˆ†äº†6å±‚ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>æ–‡ä»¶ç³»ç»Ÿå±‚<br>æä¾›äº†openã€readã€writeç­‰æ–‡ä»¶æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå¹¶ä¸”Linuxæä¾›äº†æ–‡ä»¶ç³»ç»Ÿçš„ç»Ÿä¸€æŠ½è±¡vfsï¼Œä½¿å¾—Linuxä¸­å¯é€‚é…å„ç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚ext4ã€btrfsã€zfsã€fat32ã€ntfsç­‰ï¼Œè€Œæˆ‘ä»¬å¸¸è¯´çš„ç£ç›˜æ ¼å¼åŒ–ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨å®‰è£…æ–‡ä»¶ç³»ç»Ÿï¼Œé‡æ–°å†™å…¥ç›¸å…³æ–‡ä»¶ç³»ç»Ÿçš„åˆå§‹å…ƒæ•°æ®ä¿¡æ¯åˆ°ç£ç›˜ã€‚</li><li>å·ç®¡ç†å±‚<br>æ¯”å¦‚æˆ‘ä»¬å¸¸å¬åˆ°çš„<code>Device Mapper</code>ã€<code>LVM</code>ã€<code>soft raid</code>å°±å±äºè¿™ä¸€å±‚ï¼Œç”¨äºå°†å¤šä¸ªç£ç›˜åˆä¸ºä¸€ä¸ªï¼Œæˆ–å°†ä¸€ä¸ªç£ç›˜æ‹†åˆ†ä¸ºå¤šä¸ªã€‚</li><li>å—å­˜å‚¨å±‚<br>è¿™ä¸€å±‚ä¸»è¦å®ç°ioè°ƒåº¦é€»è¾‘ï¼Œæ¯”å¦‚å°†ä¸€ä¸ªå¤§ioè¯·æ±‚æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„ioè¯·æ±‚ï¼Œå°†ç›¸é‚»çš„ioè¯·æ±‚åˆå¹¶ï¼Œå®ç°å„ç§ioè°ƒåº¦ç®—æ³•ç­‰ï¼Œå¸¸è§ioè°ƒåº¦ç®—æ³•æœ‰CFQã€NOOPã€Deadlineã€ASã€‚</li><li>å­˜å‚¨é©±åŠ¨å±‚<br>æ¯ä¸€ä¸ªç¡¬ä»¶éƒ½éœ€è¦é©±åŠ¨ç¨‹åºï¼Œç¡¬ç›˜ä¹Ÿä¸ä¾‹å¤–ï¼Œå¦‚å¸¸å¬åˆ°çš„SCSIã€ACHIã€NVMEç­‰ï¼Œä¸”å¦‚&#x2F;dev&#x2F;sdaè¿™æ ·çš„è®¾å¤‡æŠ½è±¡æ–‡ä»¶ï¼Œä¹Ÿç”±è¿™ä¸€å±‚å®ç°ã€‚</li><li>ç¡¬ä»¶å±‚<br>ç¡¬ä»¶å±‚å°±æ˜¯å…·ä½“çš„ç¡¬ç›˜å®ç‰©äº†ï¼Œä½†æˆ‘ä»¬ç»å¸¸å¬åˆ°ATAã€SATAã€SCSIã€PCIeã€SASç­‰è¿™æ ·çš„åè¯ï¼Œè¿™æ˜¯ä¸åŒçš„ç¡¬ç›˜æ¥å£è§„èŒƒï¼Œå°±åƒæ‰‹æœºå……ç”µçº¿æœ‰Type-Aã€Type-Bã€Type-Cä¸€æ ·ã€‚</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è½¯ä¸­æ–­ç¬”è®°</title>
    <link href="/2023/10/30/%E8%BD%AF%E4%B8%AD%E6%96%AD%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/10/30/%E8%BD%AF%E4%B8%AD%E6%96%AD%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="è½¯ä¸­æ–­ç¬”è®°"><a href="#è½¯ä¸­æ–­ç¬”è®°" class="headerlink" title="è½¯ä¸­æ–­ç¬”è®°"></a>è½¯ä¸­æ–­ç¬”è®°</h1><h2 id="1-ä¸­æ–­æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-ä¸­æ–­æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.ä¸­æ–­æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1.ä¸­æ–­æ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote><p>å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/338075214%EF%BC%8C%E4%BD%9C%E8%80%85%EF%BC%9A%E5%B0%8F%E6%9E%97coding">https://zhuanlan.zhihu.com/p/338075214ï¼Œä½œè€…ï¼šå°æ—coding</a></p></blockquote><p>å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼Ÿåœ¨è®¡ç®—æœºä¸­ï¼Œä¸­æ–­æ˜¯ç³»ç»Ÿç”¨æ¥å“åº”ç¡¬ä»¶è®¾å¤‡è¯·æ±‚çš„ä¸€ç§æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿæ”¶åˆ°ç¡¬ä»¶çš„ä¸­æ–­è¯·æ±‚ï¼Œä¼šæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç„¶åè°ƒç”¨å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†ç¨‹åºæ¥å“åº”è¯·æ±‚ã€‚</p><p>è¿™æ ·çš„è§£é‡Šå¯èƒ½è¿‡äºå­¦æœ¯äº†ï¼Œå®¹æ˜“äº‘é‡Œé›¾é‡Œï¼Œæˆ‘å°±ä¸¾ä¸ªç”Ÿæ´»ä¸­å–å¤–å–çš„ä¾‹å­ã€‚</p><p>å°æ—ä¸­åˆæ¬å®Œç –ï¼Œè‚šå­é¥¿äº†ï¼Œç‚¹äº†ä»½ç™½åˆ‡é¸¡å¤–å–ï¼Œè¿™æ¬¡æˆ‘å¸¦é—ªäº†ï¼Œæ²¡æœ‰è¢«æŸå›¢å¤§æ•°æ®å¤§ç†Ÿã€‚è™½ç„¶å¹³å°ä¸Šä¼šæ˜¾ç¤ºé…é€è¿›åº¦ï¼Œä½†æ˜¯æˆ‘ä¹Ÿä¸èƒ½ä¸€ç›´å‚»å‚»åœ°ç›¯ç€å‘€ï¼Œæ—¶é—´å¾ˆå®è´µï¼Œå½“ç„¶å¾—å»å¹²åˆ«çš„äº‹æƒ…ï¼Œç­‰å¤–å–åˆ°äº†é…é€å‘˜ä¼šé€šè¿‡ã€Œç”µè¯ã€é€šçŸ¥æˆ‘ï¼Œç”µè¯å“äº†ï¼Œæˆ‘å°±ä¼šåœä¸‹æ‰‹ä¸­åœ°äº‹æƒ…ï¼Œå»æ‹¿å¤–å–ã€‚</p><p>è¿™é‡Œçš„æ‰“ç”µè¯ï¼Œå…¶å®å°±æ˜¯å¯¹åº”è®¡ç®—æœºé‡Œçš„ä¸­æ–­ï¼Œæ²¡æ¥åˆ°ç”µè¯çš„æ—¶å€™ï¼Œæˆ‘å¯ä»¥åšå…¶ä»–çš„äº‹æƒ…ï¼Œåªæœ‰æ¥åˆ°äº†ç”µè¯ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿä¸­æ–­ï¼Œæˆ‘æ‰ä¼šåœä¸‹å½“å‰çš„äº‹æƒ…ï¼Œå»è¿›è¡Œå¦ä¸€ä¸ªäº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯æ‹¿å¤–å–ã€‚</p><p>ä»è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸­æ–­æ˜¯ä¸€ç§å¼‚æ­¥çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</p><p>æ“ä½œç³»ç»Ÿæ”¶åˆ°äº†ä¸­æ–­è¯·æ±‚ï¼Œä¼šæ‰“æ–­å…¶ä»–è¿›ç¨‹çš„è¿è¡Œï¼Œæ‰€ä»¥<strong>ä¸­æ–­è¯·æ±‚çš„å“åº”ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œè¦å°½å¯èƒ½å¿«çš„æ‰§è¡Œå®Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹æ­£å¸¸è¿›ç¨‹è¿è¡Œè°ƒåº¦åœ°å½±å“ã€‚</strong></p><p>è€Œä¸”ï¼Œä¸­æ–­å¤„ç†ç¨‹åºåœ¨å“åº”ä¸­æ–­æ—¶ï¼Œå¯èƒ½è¿˜ä¼šã€Œä¸´æ—¶å…³é—­ä¸­æ–­ã€ï¼Œè¿™æ„å‘³ç€ï¼Œå¦‚æœå½“å‰ä¸­æ–­å¤„ç†ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œä¹‹å‰ï¼Œç³»ç»Ÿä¸­å…¶ä»–çš„ä¸­æ–­è¯·æ±‚éƒ½æ— æ³•è¢«å“åº”ï¼Œä¹Ÿå°±è¯´ä¸­æ–­æœ‰å¯èƒ½ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥ä¸­æ–­å¤„ç†ç¨‹åºè¦çŸ­ä¸”å¿«ã€‚</p><p>è¿˜æ˜¯å›åˆ°å¤–å–çš„ä¾‹å­ï¼Œå°æ—åˆ°äº†æ™šä¸Šåˆç‚¹èµ·äº†å¤–å–ï¼Œè¿™æ¬¡ä¸ºäº†çŠ’åŠ³è‡ªå·±ï¼Œå…±ç‚¹äº†ä¸¤ä»½å¤–å–ï¼Œä¸€ä»½å°é¾™è™¾å’Œä¸€ä»½å¥¶èŒ¶ï¼Œå¹¶ä¸”æ˜¯ç”±ä¸åŒåœ°é…é€å‘˜æ¥é…é€ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå½“ç¬¬ä¸€ä»½å¤–å–é€åˆ°æ—¶ï¼Œé…é€å‘˜ç»™æˆ‘æ‰“äº†é•¿é•¿çš„ç”µè¯ï¼Œè¯´äº†ä¸€äº›æ‚ä¸ƒæ‚å…«çš„äº‹æƒ…ï¼Œæ¯”å¦‚ç»™ä¸ªå¥½è¯„ç­‰ç­‰ï¼Œä½†å¦‚æœè¿™æ—¶å¦ä¸€ä½é…é€å‘˜ä¹Ÿæƒ³ç»™æˆ‘æ‰“ç”µè¯ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™æ—¶ç¬¬äºŒä½é…é€å‘˜å› ä¸ºæˆ‘åœ¨é€šè¯ä¸­ï¼ˆç›¸å½“äºå…³é—­äº†ä¸­æ–­å“åº”ï¼‰ï¼Œè‡ªç„¶å°±æ— æ³•æ‰“é€šæˆ‘çš„ç”µè¯ï¼Œä»–å¯èƒ½å°è¯•äº†å‡ æ¬¡åå°±èµ°æ‰äº†ï¼ˆç›¸å½“äºä¸¢å¤±äº†ä¸€æ¬¡ä¸­æ–­ï¼‰ã€‚</p><hr><p>ã€<strong>æ¥è‡ªæ­£ç‚¹åŸå­ç¬”è®°</strong>ã€‘æˆ‘ä»¬éƒ½çŸ¥é“ä¸­æ–­å¤„ç†å‡½æ•°ä¸€å®šè¦å¿«ç‚¹æ‰§è¡Œå®Œæ¯•ï¼Œè¶ŠçŸ­è¶Šå¥½ï¼Œä½†æ˜¯ç°å®å¾€å¾€æ˜¯æ®‹é…·çš„ï¼Œæœ‰äº›ä¸­æ–­å¤„ç†è¿‡ç¨‹å°±æ˜¯æ¯”è¾ƒè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¿…é¡»è¦å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œç¼©å°ä¸­æ–­å¤„ç†å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚æ¯”å¦‚ç”µå®¹è§¦æ‘¸å±é€šè¿‡ä¸­æ–­é€šçŸ¥ SOC æœ‰è§¦æ‘¸äº‹ä»¶å‘ç”Ÿï¼ŒSOC å“åº”ä¸­æ–­ï¼Œç„¶åé€šè¿‡ IIC æ¥å£è¯»å–è§¦æ‘¸åæ ‡å€¼å¹¶å°†å…¶ä¸ŠæŠ¥ç»™ç³»ç»Ÿã€‚ä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ IIC çš„é€Ÿåº¦æœ€é«˜ä¹Ÿåªæœ‰400Kbit&#x2F;Sï¼Œæ‰€ä»¥åœ¨ä¸­æ–­ä¸­é€šè¿‡ IIC è¯»å–æ•°æ®å°±ä¼šæµªè´¹æ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥å°†é€šè¿‡ IIC è¯»å–è§¦æ‘¸æ•°æ®çš„æ“ä½œæš‚åæ‰§è¡Œï¼Œä¸­æ–­å¤„ç†å‡½æ•°ä»…ä»…ç›¸åº”ä¸­æ–­ï¼Œç„¶åæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½å³å¯ã€‚è¿™ä¸ªæ—¶å€™ä¸­æ–­å¤„ç†è¿‡ç¨‹å°±åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>ä¸ŠåŠéƒ¨ï¼š<strong>ä¸ŠåŠéƒ¨å°±æ˜¯ä¸­æ–­å¤„ç†å‡½æ•°</strong>ï¼Œé‚£äº›å¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¿«ï¼Œä¸ä¼šå ç”¨å¾ˆé•¿æ—¶é—´çš„å¤„ç†å°±å¯ä»¥æ”¾åœ¨ä¸ŠåŠéƒ¨å®Œæˆã€‚</li><li>ä¸‹åŠéƒ¨ï¼šå¦‚æœä¸­æ–­å¤„ç†è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±å°†è¿™äº›æ¯”è¾ƒè€—æ—¶çš„ä»£ç æå‡ºæ¥ï¼Œäº¤ç»™ä¸‹åŠéƒ¨å»æ‰§è¡Œï¼Œè¿™æ ·ä¸­æ–­å¤„ç†å‡½æ•°å°±ä¼šå¿«è¿›å¿«å‡ºã€‚</li></ul><p>ğŸ†å› æ­¤ï¼ŒLinux å†…æ ¸å°†ä¸­æ–­åˆ†ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨çš„ä¸»è¦ç›®çš„å°±æ˜¯å®ç°ä¸­æ–­å¤„ç†å‡½æ•°çš„å¿«è¿›å¿«å‡ºï¼Œé‚£äº›å¯¹æ—¶é—´æ•æ„Ÿã€æ‰§è¡Œé€Ÿåº¦å¿«çš„æ“ä½œå¯ä»¥æ”¾åˆ°ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ŠåŠéƒ¨ã€‚å‰©ä¸‹çš„æ‰€æœ‰å·¥ä½œéƒ½å¯ä»¥æ”¾åˆ°ä¸‹åŠéƒ¨å»æ‰§è¡Œï¼Œæ¯”å¦‚åœ¨ä¸ŠåŠéƒ¨å°†æ•°æ®æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œå…³äºæ•°æ®çš„å…·ä½“å¤„ç†å°±å¯ä»¥æ”¾åˆ°ä¸‹åŠéƒ¨å»æ‰§è¡Œã€‚</p><h2 id="2-ä¸‹åŠéƒ¨æœºåˆ¶ä¸­çš„è½¯ä¸­æ–­"><a href="#2-ä¸‹åŠéƒ¨æœºåˆ¶ä¸­çš„è½¯ä¸­æ–­" class="headerlink" title="2.ä¸‹åŠéƒ¨æœºåˆ¶ä¸­çš„è½¯ä¸­æ–­"></a>2.ä¸‹åŠéƒ¨æœºåˆ¶ä¸­çš„è½¯ä¸­æ–­</h2><p>ç”±äºISRè¿è¡Œæ—¶é—´ä¸æ˜“è¿‡é•¿ï¼Œä¸”ä¸èƒ½ç¡çœ ï¼Œlinuxå°†ä¸­æ–­ä¸­çš„ä¸€éƒ¨åˆ†é€»è¾‘æ¨åæ‰§è¡Œï¼Œäºæ˜¯è¯ç”Ÿäº†è½¯ä¸­æ–­æœºåˆ¶ã€‚å®é™…ä¸Šå‡ºç°åœ¨å†…æ ¸ä»£ç ä¸­çš„æœ¯è¯­â€œè½¯ä¸­æ–­ï¼ˆsoftirqï¼‰â€å¸¸å¸¸è¡¨ç¤ºå¯å»¶è¿Ÿå‡½æ•°çš„æ‰€æœ‰ç§ç±»ï¼Œå³taskletã€softirqã€work queueéƒ½å¯ä»¥ç»Ÿç§°ä¸ºâ€œè½¯ä¸­æ–­â€ï¼Œä¸ºäº†ä¸äº§ç”Ÿæ··æ·†ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´åŠ å¹¿æ³›çš„ç»Ÿç§°ï¼šä¸­æ–­ä¸‹(åº•)åŠéƒ¨ã€‚</p><h3 id="2-1-è½¯ä¸­æ–­"><a href="#2-1-è½¯ä¸­æ–­" class="headerlink" title="2.1 è½¯ä¸­æ–­"></a>2.1 è½¯ä¸­æ–­</h3><blockquote><p>å†…å®¹å‡æ¥è‡ªäºæ­£ç‚¹åŸå­</p></blockquote><p>ä¸€å¼€å§‹ Linux å†…æ ¸æä¾›äº†â€œbottom halfâ€æœºåˆ¶æ¥å®ç°ä¸‹åŠéƒ¨ï¼Œç®€ç§°â€œBHâ€ã€‚åé¢å¼•å…¥äº†è½¯ä¸­æ–­å’Œ tasklet æ¥æ›¿ä»£â€œBHâ€æœºåˆ¶ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨è½¯ä¸­æ–­å’Œ tasklet æ¥æ›¿ä»£ BHï¼Œä» 2.5 ç‰ˆæœ¬çš„ Linuxå†…æ ¸å¼€å§‹ BH å·²ç»è¢«æŠ›å¼ƒäº†ã€‚Linux å†…æ ¸ä½¿ç”¨ç»“æ„ä½“ softirq_action è¡¨ç¤ºè½¯ä¸­æ–­ï¼Œ softirq_actionç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;interrupt.h ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">softirq_action</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">void</span> (*action)(<span class="hljs-keyword">struct</span> softirq_action *);<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ kernel&#x2F;softirq.c æ–‡ä»¶ä¸­ä¸€å…±å®šä¹‰äº† 10 ä¸ªè½¯ä¸­æ–­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">softirq_action</span> <span class="hljs-title">softirq_vec</span>[<span class="hljs-title">NR_SOFTIRQS</span>];</span><br></code></pre></td></tr></table></figure><p>NR_SOFTIRQS æ˜¯æšä¸¾ç±»å‹ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;interrupt.h ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span></span><br><span class="hljs-class">&#123;</span><br>    HI_SOFTIRQ=<span class="hljs-number">0</span>, <span class="hljs-comment">/* é«˜ä¼˜å…ˆçº§è½¯ä¸­æ–­ */</span><br>TIMER_SOFTIRQ, <span class="hljs-comment">/* å®šæ—¶å™¨è½¯ä¸­æ–­ */</span><br>NET_TX_SOFTIRQ, <span class="hljs-comment">/* ç½‘ç»œæ•°æ®å‘é€è½¯ä¸­æ–­ */</span><br>NET_RX_SOFTIRQ, <span class="hljs-comment">/* ç½‘ç»œæ•°æ®æ¥æ”¶è½¯ä¸­æ–­ */</span><br>BLOCK_SOFTIRQ, <br>    BLOCK_IOPOLL_SOFTIRQ, <br>    TASKLET_SOFTIRQ, <span class="hljs-comment">/* tasklet è½¯ä¸­æ–­ */</span><br>    SCHED_SOFTIRQ, <span class="hljs-comment">/* è°ƒåº¦è½¯ä¸­æ–­ */</span><br>HRTIMER_SOFTIRQ, <span class="hljs-comment">/* é«˜ç²¾åº¦å®šæ—¶å™¨è½¯ä¸­æ–­ */</span><br>RCU_SOFTIRQ, <span class="hljs-comment">/* RCU è½¯ä¸­æ–­ */</span><br>NR_SOFTIRQS<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œä¸€å…±æœ‰ 10 ä¸ªè½¯ä¸­æ–­ï¼Œå› æ­¤ NR_SOFTIRQS ä¸º 10ï¼Œå› æ­¤æ•°ç»„ softirq_vec æœ‰ 10 ä¸ªå…ƒç´ ã€‚softirq_action ç»“æ„ä½“ä¸­çš„ action æˆå‘˜å˜é‡å°±æ˜¯è½¯ä¸­æ–­çš„æœåŠ¡å‡½æ•°ï¼Œæ•°ç»„ softirq_vec æ˜¯ä¸ªå…¨å±€æ•°ç»„ï¼Œå› æ­¤æ‰€æœ‰çš„ CPU(å¯¹äº SMP ç³»ç»Ÿè€Œè¨€)éƒ½å¯ä»¥è®¿é—®åˆ°ï¼Œæ¯ä¸ª CPU éƒ½æœ‰è‡ªå·±çš„è§¦å‘å’Œæ§åˆ¶æœºåˆ¶ï¼Œå¹¶ä¸”åªæ‰§è¡Œè‡ªå·±æ‰€è§¦å‘çš„è½¯ä¸­æ–­ã€‚ä½†æ˜¯å„ä¸ª CPU æ‰€æ‰§è¡Œçš„è½¯ä¸­æ–­æœåŠ¡å‡½æ•°ç¡®æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯æ•°ç»„ softirq_vec ä¸­å®šä¹‰çš„ action å‡½æ•°ã€‚è¦ä½¿ç”¨è½¯ä¸­æ–­ï¼Œå¿…é¡»å…ˆä½¿ç”¨ open_softirq å‡½æ•°æ³¨å†Œå¯¹åº”çš„è½¯ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œ<strong>open_softirq</strong> å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">open_softirq</span><span class="hljs-params">(<span class="hljs-type">int</span> nr, <span class="hljs-type">void</span> (*action)(<span class="hljs-keyword">struct</span> softirq_action *))</span><br></code></pre></td></tr></table></figure><p>æ³¨å†Œå¥½è½¯ä¸­æ–­ä»¥åéœ€è¦é€šè¿‡ <strong>raise_softirq</strong> å‡½æ•°è§¦å‘ï¼Œraise_softirq å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">raise_softirq</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br></code></pre></td></tr></table></figure><p>è½¯ä¸­æ–­å¿…é¡»åœ¨ç¼–è¯‘çš„æ—¶å€™é™æ€æ³¨å†Œï¼Linux å†…æ ¸ä½¿ç”¨ softirq_init å‡½æ•°åˆå§‹åŒ–è½¯ä¸­æ–­ï¼Œsoftirq_init å‡½æ•°å®šä¹‰åœ¨ kernel&#x2F;softirq.c æ–‡ä»¶é‡Œé¢ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">softirq_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> cpu;<br><br>for_each_possible_cpu(cpu) &#123;<br>per_cpu(tasklet_vec, cpu).tail =<br>&amp;per_cpu(tasklet_vec, cpu).head;<br>per_cpu(tasklet_hi_vec, cpu).tail =<br>&amp;per_cpu(tasklet_hi_vec, cpu).head;<br>&#125;<br><br>open_softirq(TASKLET_SOFTIRQ, tasklet_action);<br>open_softirq(HI_SOFTIRQ, tasklet_hi_action);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¼“å†²åŒºçš„æ¦‚å¿µå’ŒåŸç†</title>
    <link href="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/"/>
    <url>/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¼“å†²åŒºçš„æ¦‚å¿µå’ŒåŸç†"><a href="#ç¼“å†²åŒºçš„æ¦‚å¿µå’ŒåŸç†" class="headerlink" title="ç¼“å†²åŒºçš„æ¦‚å¿µå’ŒåŸç†"></a>ç¼“å†²åŒºçš„æ¦‚å¿µå’ŒåŸç†</h1><blockquote><p><strong>å£°æ˜</strong>ï¼šæœ¬æ–‡å†…å®¹å‡è½¬è½½è‡ªä¸‹é¢2ç¯‡åšå®¢ï¼š</p><ul><li><a href="https://blog.csdn.net/weixin_51429254/article/details/127453147">https://blog.csdn.net/weixin_51429254/article/details/127453147</a></li><li><a href="https://codeantenna.com/a/DWEgSdNsKv">https://codeantenna.com/a/DWEgSdNsKv</a></li></ul></blockquote><h2 id="1-ç”¨æˆ·å±‚ç¼“å†²åŒº"><a href="#1-ç”¨æˆ·å±‚ç¼“å†²åŒº" class="headerlink" title="1.ç”¨æˆ·å±‚ç¼“å†²åŒº"></a>1.ç”¨æˆ·å±‚ç¼“å†²åŒº</h2><p>é€šè¿‡å¯¹è¯­è¨€çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“Cè¯­è¨€æä¾›äº†FILEç±»ï¼Œç”¨äºæè¿°æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œè¿›ç¨‹æ‰€æ‰“å¼€çš„æ¯ä¸ªæ–‡ä»¶ï¼Œéƒ½æœ‰ä¸€ä¸ªFILE*æŒ‡é’ˆä¸ä¹‹å¯¹åº”ï¼ŒæŒ‡å‘æè¿°è¿™ä¸ªæ–‡ä»¶å±æ€§ä¿¡æ¯çš„ç»“æ„ä½“ã€‚</p><p>åœ¨FILEç»“æ„ä½“ä¸­ï¼Œä¼šå­˜å‚¨æ–‡ä»¶æè¿°ç¬¦fdï¼Œä¹Ÿä¼šæœ‰æŒ‡å‘è¯¥æ–‡ä»¶å¯¹åº”çš„ç¼“å†²åŒºçš„æŒ‡é’ˆï¼ŒFILEçš„å®šä¹‰è§ä¸‹é¢ä»£ç ï¼Œå¯è§Cä¼šä¸ºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½ç”³è¯·ç¼“å†²åŒºï¼Œç”¨äºè¯¥æ–‡ä»¶çš„è¯»å†™ã€‚</p><p><strong>ç»“è®ºï¼šç¼“å†²åŒºå°±æ˜¯ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œæ¯ä¸€ä¸ªè¢«è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ç¼“å†²åŒºã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span>    <br>  <span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>    <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags    </span><br>    <br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>    <br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>    <br>  <span class="hljs-type">char</span>* _IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span>    <br>  <span class="hljs-type">char</span>* _IO_read_end;   <span class="hljs-comment">/* End of get area. */</span>    <br>  <span class="hljs-type">char</span>* _IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span>    <br>  <span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">/* Start of put area. */</span>    <br>  <span class="hljs-type">char</span>* _IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span>    <br>  <span class="hljs-type">char</span>* _IO_write_end;  <span class="hljs-comment">/* End of put area. */</span>    <br>  <span class="hljs-type">char</span>* _IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span>    <br>  <span class="hljs-type">char</span>* _IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span>    <br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span>    <br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span>    <br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span>    <br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span>    <br>    <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span>    <br>    <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span>    <br>    <br>  <span class="hljs-type">int</span> _fileno;    <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0    </span><br>  <span class="hljs-type">int</span> _blksize;    <br><span class="hljs-meta">#<span class="hljs-keyword">else</span>    </span><br>  <span class="hljs-type">int</span> _flags2;    <br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>    </span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span>    <br>    <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span>    </span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span>    <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;    <br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;    <br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];    <br>    <br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span>    <br>    <br>  _IO_lock_t *_lock;    <br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE    </span><br>&#125;;    <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ®æ­¤æ¨æ–­ï¼Œå½“è°ƒç”¨C&#x2F;C++çš„IOå‡½æ•°å‘å¤–éƒ¨è®¾å¤‡ï¼ˆç£ç›˜æ–‡ä»¶ï¼‰è¾“å‡ºæ•°æ®æ—¶ï¼Œæ•°æ®ä¼šè¢«å…ˆå†™å…¥ç›®æ ‡ç£ç›˜æ–‡ä»¶çš„ç¼“å†²åŒºï¼Œå½“ç¼“å†²åŒºçš„æ•°æ®ç§¯ç´¯åˆ°äº†ä¸€å®šçš„é‡æ—¶ï¼Œå†è°ƒç”¨ç³»ç»Ÿæ¥å£writeï¼Œå°†ç¼“å†²åŒºçš„æ•°æ®å†™æ“ä½œç³»ç»Ÿçš„å†…æ ¸ç¼“å†²åŒºï¼Œåœ¨åˆé€‚çš„æ—¶é—´ï¼Œå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®å°±ä¼šè¢«åˆ·æ–°åˆ°å¤–éƒ¨è®¾å¤‡ï¼Œå…·ä½“æµç¨‹å‚è€ƒä¸‹å›¾ã€‚è¿™æ ·ç›¸æ¯”äºæ¯æ¬¡è°ƒç”¨C&#x2F;C++çš„IOå‡½æ•°éƒ½ç›´æ¥ä½¿ç”¨ç³»ç»Ÿæ¥å£writeï¼Œæ•ˆç‡ä¼šæœ‰æ‰€æé«˜ã€‚</p><p>ä»å¤–éƒ¨è®¾å¤‡è¯»å–æ•°æ®æ—¶ï¼ŒC&#x2F;C++æ ‡å‡†åº“æä¾›çš„ç¼“å†²åŒºçš„å·¥ä½œåŸç†ä¸å‘å¤–éƒ¨è®¾å¤‡å†™æ•°æ®æ—¶ç±»ä¼¼ã€‚</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/5ce11a1ad0dc469ba4b6faa9468718a4.png" alt="img" style="zoom: 33%;"><h2 id="2-ç¼“å†²åŒºçš„ç®€å•æ¨¡æ‹Ÿå®ç°"><a href="#2-ç¼“å†²åŒºçš„ç®€å•æ¨¡æ‹Ÿå®ç°" class="headerlink" title="2.ç¼“å†²åŒºçš„ç®€å•æ¨¡æ‹Ÿå®ç°"></a>2.ç¼“å†²åŒºçš„ç®€å•æ¨¡æ‹Ÿå®ç°</h2><p>åªéœ€è¦åœ¨è‡ªå®šä¹‰çš„struct myFILEä¸­å®šä¹‰ä¸€æ®µç¼“å†²åŒºï¼Œåœ¨å†™æ–‡ä»¶æ—¶å…ˆå°†å†…å®¹å†™å…¥åˆ°ç¼“å†²åŒºä¸­ï¼Œåœ¨ç¼“å†²åŒºæ»¡ã€æ–‡ä»¶å…³é—­æˆ–ç”¨æˆ·å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒºæ—¶ï¼Œè°ƒç”¨ç³»ç»Ÿwriteå‡½æ•°åˆ·æ–°ç¼“å†²åŒºï¼Œå³å¯æ¨¡æ‹Ÿå®ç°ç®€å•çš„ç¼“å†²åŒºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NUM 10</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">myFile</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> fd;       <span class="hljs-comment">//æ–‡ä»¶æè¿°ç¬¦</span><br>    <span class="hljs-type">char</span> buffer[NUM]; <span class="hljs-comment">//ç¼“å†²åŒº </span><br>    <span class="hljs-type">int</span> end;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">myFile</span> <span class="hljs-title">MyFILE</span>;</span><br><br>MyFILE* <span class="hljs-title function_">fopen_</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mode)</span><br>&#123;<br>    assert(path);<br>    assert(mode);<br><br>    MyFILE* ret = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;w&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">//åªå†™ã€æ¸…ç©ºã€æ²¡æœ‰å°±åˆ›å»ºæ–‡ä»¶</span><br>        fd = open(path, O_WRONLY|O_CREAT|O_TRUNC, <span class="hljs-number">0666</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;r&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        fd = open(path, O_RDONLY);  <span class="hljs-comment">//åªå†™æ‰“å¼€</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;a&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        fd = open(path, O_WRONLY|O_CREAT|O_APPEND, <span class="hljs-number">0666</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;w+&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        fd = open(path, O_RDWR|O_CREAT|O_TRUNC, <span class="hljs-number">0666</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;r+&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        fd = open(path, O_RDWR);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">&quot;a+&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        fd = open(path, O_RDWR|O_CREAT|O_APPEND, <span class="hljs-number">0666</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mode error!\n&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span>(fd &gt;= <span class="hljs-number">0</span>)                                                                                                      <br>    &#123;<br>        ret = (MyFILE*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(MyFILE));<br>        <span class="hljs-built_in">memset</span>(ret, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(MyFILE));<br>        ret-&gt;fd = fd;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">//ç¼“å†²åŒºåˆ·æ–°å‡½æ•°</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">fflush_</span><span class="hljs-params">(MyFILE* pf)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> n = <span class="hljs-built_in">strlen</span>(pf-&gt;buffer);<br>    <span class="hljs-comment">//fprintf(stdout, &quot;%s\n&quot;, pf-&gt;buffer);</span><br>    write(pf-&gt;fd, pf-&gt;buffer, n);<br>    <span class="hljs-built_in">memset</span>(pf-&gt;buffer, <span class="hljs-number">0</span>, NUM);<br>    pf-&gt;end = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//æ–‡ä»¶å…³é—­å‡½æ•°</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">close_</span><span class="hljs-params">(MyFILE* pf)</span><br>&#123;<br>    fflush_(pf);<br>    close(pf-&gt;fd);<br>    <span class="hljs-built_in">free</span>(pf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fputs_</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* s, MyFILE* pf)</span><br>&#123;<br>    <span class="hljs-type">int</span> len = (<span class="hljs-type">int</span>)<span class="hljs-built_in">strlen</span>(s);   <span class="hljs-comment">//è¦å†™å…¥çš„å­—ç¬¦æ•°</span><br>    <span class="hljs-keyword">while</span>(pf-&gt;end + len &gt;= NUM)<br>    &#123;<br>        <span class="hljs-type">int</span> n = NUM - pf-&gt;end - <span class="hljs-number">1</span>;   <span class="hljs-comment">//å®é™…å¯ä»¥è¯»å–çš„å­—ç¬¦æ•°</span><br>        <span class="hljs-built_in">strncpy</span>(pf-&gt;buffer + pf-&gt;end, s, n);  <span class="hljs-comment">//å­—ç¬¦æ•°æ‹·è´åˆ°ç¼“å†²åŒº</span><br>        <span class="hljs-comment">//fprintf(stdout, &quot;%s\n&quot;, pf-&gt;buffer);</span><br>        fflush_(pf);   <span class="hljs-comment">//ç¼“å†²åŒºæ»¡ï¼Œå¼ºåˆ¶æ¸…ç†</span><br>        sleep(<span class="hljs-number">1</span>);<br>        len -= n;   <span class="hljs-comment">//è¿˜æ²¡æœ‰æ‹·è´çš„å­—ç¬¦æ•°</span><br>        s += n;<br>    &#125;<br><br><br>    <span class="hljs-built_in">strcpy</span>(pf-&gt;buffer, s);<br>    pf-&gt;end = len;<br><br>    <span class="hljs-keyword">if</span>(pf-&gt;end != <span class="hljs-number">0</span> &amp;&amp; (pf-&gt;fd == <span class="hljs-number">1</span> || pf-&gt;fd == <span class="hljs-number">2</span>))<br>    &#123;<br>        <span class="hljs-comment">//æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯(æ˜¾ç¤ºå±)é‡‡ç”¨è¡Œåˆ·æ–°ç­–ç•¥</span><br>        <span class="hljs-keyword">if</span>(s[<span class="hljs-built_in">strlen</span>(s) - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>        &#123;<br>            fflush_(pf);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    MyFILE* pf = fopen_(<span class="hljs-string">&quot;log.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br>    dup2(pf-&gt;fd, <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">//int fd = open(&quot;log2.txt&quot;, O_RDONLY);</span><br>    <span class="hljs-comment">//printf(&quot;%d\n&quot;, fd);</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* s1 = <span class="hljs-string">&quot;hello world, hello linux, hello everyone\n&quot;</span>;<br>    fputs_(s1, pf);<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* s2 = <span class="hljs-string">&quot;zhangHHHHHHHHHH\n&quot;</span>;<br>    fputs_(s2, pf);<br><br>    close_(pf);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-ç¼“å†²åŒºçš„åˆ·æ–°ç­–ç•¥"><a href="#3-ç¼“å†²åŒºçš„åˆ·æ–°ç­–ç•¥" class="headerlink" title="3.ç¼“å†²åŒºçš„åˆ·æ–°ç­–ç•¥"></a>3.ç¼“å†²åŒºçš„åˆ·æ–°ç­–ç•¥</h2><p>ç¼“å†²åŒºæœ‰ä¸‰ç§ç±»å‹å¯¹åº”ä¸‰ç§åˆ·æ–°ç¼“å†²åŒºçš„æ–¹å¼ï¼š</p><ol><li><strong>å…¨ç¼“å†²</strong><br>å½“å¡«æ»¡æ ‡å‡†I&#x2F;Oç¼“å­˜åæ‰è¿›è¡Œå®é™…I&#x2F;Oæ“ä½œï¼Œå¦‚å°†æ•°æ®ä»ç”¨æˆ·å±‚ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚å…¨ç¼“å†²çš„å…¸å‹ä»£è¡¨æ˜¯å¯¹ç£ç›˜æ–‡ä»¶çš„è¯»å†™</li><li><strong>è¡Œç¼“å†²</strong><br>å½“è¾“å…¥å’Œè¾“å‡ºä¸­é‡åˆ°æ¢è¡Œç¬¦æ—¶æ‰æ‰§è¡Œå®é™…I&#x2F;Oæ“ä½œï¼Œå…¸å‹ä»£è¡¨æ˜¯æ ‡å‡†è¾“å…¥stdinå’Œæ ‡å‡†è¾“å‡ºstdout</li><li><strong>æ— ç¼“å†²</strong><br>ä¸å¯¹æ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´æ¥è¿›è¡ŒI&#x2F;Oï¼Œå¦‚æ ‡å‡†é”™è¯¯stderrå°±æ˜¯æ— ç¼“å†²åˆ·æ–°</li></ol><p><strong>ç¼“å†²åŒºä½•æ—¶ä¼šè¢«åˆ·å‘¢&amp;åˆ·æ–°æ–¹æ³•ï¼š</strong></p><ol><li>è°ƒç”¨exit()è¿›ç¨‹ç»“æŸæ—¶ä¼šåˆ·æ–°ç¼“å†²åŒºï¼Œreturnä¼šè‡ªåŠ¨è°ƒç”¨exit()ï¼Œæ³¨æ„_exit()ä¸ä¼šåˆ·æ–°ç¼“å†²åŒº</li><li>å½“<strong>ç¼“å†²åŒºæ»¡äº†</strong>ä¹Ÿä¼šè¢«åˆ·æ–°å‡ºæ¥</li><li>å¯é€šè¿‡fflushå¼ºåˆ¶å°†ç¼“å†²æµä¸­çš„æ•°æ®å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒºä¸­</li><li>æµè¢«å…³é—­æ—¶ä¹Ÿä¼šè¢«åˆ·å‡ºæ¥ï¼Œå¦‚è°ƒç”¨fcloseå‡½æ•°</li><li>è¡Œç¼“å†²é‡è§<code>&#39;\n&#39;</code>ä¼šè¢«åˆ·æ–°å‡ºæ¥</li></ol><h2 id="4-å†…æ ¸ç¼“å†²åŒº"><a href="#4-å†…æ ¸ç¼“å†²åŒº" class="headerlink" title="4.å†…æ ¸ç¼“å†²åŒº"></a>4.å†…æ ¸ç¼“å†²åŒº</h2><p>å†…æ ¸å±‚ç¼“å†²åŒºä¸º<code>buffer</code>å’Œ<code>cache</code>ï¼Œå®ƒä»¬ä½äºå†…æ ¸ç©ºé—´ï¼Œè¢«æ‰€æœ‰è¿›ç¨‹å¯è§ã€‚bufferå’Œcacheæ˜¯å†…å­˜çš„ä¸åŒçš„ä½“ç°ï¼Œå®ƒä»¬æ­å»ºäº†CPUå’Œç£ç›˜å¿«é€Ÿäº¤äº’çš„æ¡¥æ¢</p><ul><li>bufferå­˜å‚¨æš‚æœªå†™å…¥åˆ°ç£ç›˜çš„æ•°æ®ï¼Œç§¯æ”’åˆ°ä¸€å®šé‡åå†™å…¥ç£ç›˜ï¼Œå¯ä»¥é™ä½å’Œç£ç›˜IOçš„é¢‘ç‡</li><li>cacheå®ç°æ•°æ®é¢„è¯»çš„åŠŸèƒ½ï¼šå¯ä»¥æš‚æ—¶å­˜å‚¨æ¥è‡ªç£ç›˜çš„æ•°æ®ï¼Œæé«˜è¿™éƒ¨åˆ†æ•°æ®é‡ç”¨æ€§ï¼Œä½¿å¾—OSæ— éœ€é¢‘ç¹è®¿é—®ç£ç›˜</li></ul><p><strong>è®¾ç½®å†…æ ¸ç¼“å†²åŒºçš„å¥½å¤„ï¼š</strong>å†…æ ¸ç¼“å†²åŒºæ•°æ®ä¸å†™å›ç£ç›˜ä¹Ÿèƒ½è¢«å…¶å®ƒè¿›ç¨‹è¯»å–ï¼Œåœ¨è¿™ç‚¹çš„ä½œç”¨ä¸Šå’Œç£ç›˜å­˜å‚¨æ–‡ä»¶æ— å¼‚ï¼Œç›´æ¥è¯»å–å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®ï¼Œå¸¦æ¥äº†è¯»å†™çš„é«˜æ•ˆæ€§</p><h2 id="5-é›¶æ‹·è´"><a href="#5-é›¶æ‹·è´" class="headerlink" title="5.é›¶æ‹·è´"></a>5.é›¶æ‹·è´</h2><blockquote><p>ä»¥ä¸‹å†…å®¹æ¥è‡ªï¼š<a href="https://xiaolincoding.com/os/8_network_system/zero_copy.html">å°æ—coding</a>ï¼Œä¾µæƒè”ç³»åˆ é™¤</p></blockquote><h3 id="5-1-ä¸ºä»€ä¹ˆè¦æœ‰DMAæŠ€æœ¯"><a href="#5-1-ä¸ºä»€ä¹ˆè¦æœ‰DMAæŠ€æœ¯" class="headerlink" title="5.1 ä¸ºä»€ä¹ˆè¦æœ‰DMAæŠ€æœ¯"></a>5.1 ä¸ºä»€ä¹ˆè¦æœ‰DMAæŠ€æœ¯</h3><p>åœ¨æ²¡æœ‰ DMA æŠ€æœ¯å‰ï¼ŒI&#x2F;O çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>CPU å‘å‡ºå¯¹åº”çš„æŒ‡ä»¤ç»™ç£ç›˜æ§åˆ¶å™¨ï¼Œç„¶åè¿”å›ï¼›</li><li>ç£ç›˜æ§åˆ¶å™¨æ”¶åˆ°æŒ‡ä»¤åï¼Œäºæ˜¯å°±å¼€å§‹å‡†å¤‡æ•°æ®ï¼Œä¼šæŠŠæ•°æ®æ”¾å…¥åˆ°ç£ç›˜æ§åˆ¶å™¨çš„å†…éƒ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ª<strong>ä¸­æ–­</strong>ï¼›</li><li>CPU æ”¶åˆ°ä¸­æ–­ä¿¡å·åï¼Œåœä¸‹æ‰‹å¤´çš„å·¥ä½œï¼Œæ¥ç€æŠŠç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡ä¸€ä¸ªå­—èŠ‚åœ°è¯»è¿›è‡ªå·±çš„å¯„å­˜å™¨ï¼Œç„¶åå†æŠŠå¯„å­˜å™¨é‡Œçš„æ•°æ®å†™å…¥åˆ°å†…å­˜ï¼Œè€Œåœ¨æ•°æ®ä¼ è¾“çš„æœŸé—´ CPU æ˜¯æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡çš„ã€‚</li></ul><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å‰¯å›¾ï¼š</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/I_O ä¸­æ–­.png" alt="img" style="zoom: 40%;"><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªæ•°æ®çš„ä¼ è¾“è¿‡ç¨‹ï¼Œéƒ½è¦éœ€è¦ CPU äº²è‡ªå‚ä¸æ¬è¿æ•°æ®çš„è¿‡ç¨‹ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ï¼ŒCPU æ˜¯ä¸èƒ½åšå…¶ä»–äº‹æƒ…çš„ã€‚</p><p>ç®€å•çš„æ¬è¿å‡ ä¸ªå­—ç¬¦æ•°æ®é‚£æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç”¨åƒå…†ç½‘å¡æˆ–è€…ç¡¬ç›˜ä¼ è¾“å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ç”¨ CPU æ¥æ¬è¿çš„è¯ï¼Œè‚¯å®šå¿™ä¸è¿‡æ¥ã€‚</p><p>è®¡ç®—æœºç§‘å­¦å®¶ä»¬å‘ç°äº†äº‹æƒ…çš„ä¸¥é‡æ€§åï¼Œäºæ˜¯å°±å‘æ˜äº† DMA æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯<strong>ç›´æ¥å†…å­˜è®¿é—®ï¼ˆDirect Memory Accessï¼‰</strong> æŠ€æœ¯ã€‚</p><p>ä»€ä¹ˆæ˜¯ DMA æŠ€æœ¯ï¼Ÿç®€å•ç†è§£å°±æ˜¯ï¼Œ<strong>åœ¨è¿›è¡Œ I&#x2F;O è®¾å¤‡å’Œå†…å­˜çš„æ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œæ•°æ®æ¬è¿çš„å·¥ä½œå…¨éƒ¨äº¤ç»™ DMA æ§åˆ¶å™¨ï¼Œè€Œ CPU ä¸å†å‚ä¸ä»»ä½•ä¸æ•°æ®æ¬è¿ç›¸å…³çš„äº‹æƒ…ï¼Œè¿™æ · CPU å°±å¯ä»¥å»å¤„ç†åˆ«çš„äº‹åŠ¡</strong>ã€‚</p><p>é‚£ä½¿ç”¨ DMA æ§åˆ¶å™¨è¿›è¡Œæ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹ã€‚</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/DRM I_O è¿‡ç¨‹.png" alt="img" style="zoom:40%;"><p>å…·ä½“è¿‡ç¨‹ï¼š</p><ul><li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ read æ–¹æ³•ï¼Œå‘æ“ä½œç³»ç»Ÿå‘å‡º I&#x2F;O è¯·æ±‚ï¼Œè¯·æ±‚è¯»å–æ•°æ®åˆ°è‡ªå·±çš„å†…å­˜ç¼“å†²åŒºä¸­ï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›</li><li>æ“ä½œç³»ç»Ÿæ”¶åˆ°è¯·æ±‚åï¼Œè¿›ä¸€æ­¥å°† I&#x2F;O è¯·æ±‚å‘é€ DMAï¼Œç„¶åè®© CPU æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼›</li><li>DMA è¿›ä¸€æ­¥å°† I&#x2F;O è¯·æ±‚å‘é€ç»™ç£ç›˜ï¼›</li><li>ç£ç›˜æ”¶åˆ° DMA çš„ I&#x2F;O è¯·æ±‚ï¼ŒæŠŠæ•°æ®ä»ç£ç›˜è¯»å–åˆ°ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºä¸­ï¼Œå½“ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºè¢«è¯»æ»¡åï¼Œå‘ DMA å‘èµ·ä¸­æ–­ä¿¡å·ï¼Œå‘ŠçŸ¥è‡ªå·±ç¼“å†²åŒºå·²æ»¡ï¼›</li><li><strong>DMA æ”¶åˆ°ç£ç›˜çš„ä¿¡å·ï¼Œå°†ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ä¸å ç”¨ CPUï¼ŒCPU å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡</strong>ï¼›</li><li>å½“ DMA è¯»å–äº†è¶³å¤Ÿå¤šçš„æ•°æ®ï¼Œå°±ä¼šå‘é€ä¸­æ–­ä¿¡å·ç»™ CPUï¼›</li><li>CPU æ”¶åˆ° DMA çš„ä¿¡å·ï¼ŒçŸ¥é“æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œäºæ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ï¼›</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œ <strong>CPU ä¸å†å‚ä¸ã€Œå°†æ•°æ®ä»ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ¬è¿åˆ°å†…æ ¸ç©ºé—´ã€çš„å·¥ä½œï¼Œè¿™éƒ¨åˆ†å·¥ä½œå…¨ç¨‹ç”± DMA å®Œæˆ</strong>ã€‚ä½†æ˜¯ CPU åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå› ä¸ºä¼ è¾“ä»€ä¹ˆæ•°æ®ï¼Œä»å“ªé‡Œä¼ è¾“åˆ°å“ªé‡Œï¼Œéƒ½éœ€è¦ CPU æ¥å‘Šè¯‰ DMA æ§åˆ¶å™¨ã€‚</p><p>æ—©æœŸ DMA åªå­˜åœ¨åœ¨ä¸»æ¿ä¸Šï¼Œå¦‚ä»Šç”±äº I&#x2F;O è®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œæ•°æ®ä¼ è¾“çš„éœ€æ±‚ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥æ¯ä¸ª I&#x2F;O è®¾å¤‡é‡Œé¢éƒ½æœ‰è‡ªå·±çš„ DMA æ§åˆ¶å™¨ã€‚</p><h3 id="4-2-ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æœ‰å¤šç³Ÿç³•ï¼Ÿ"><a href="#4-2-ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æœ‰å¤šç³Ÿç³•ï¼Ÿ" class="headerlink" title="4.2 ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æœ‰å¤šç³Ÿç³•ï¼Ÿ"></a>4.2 ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æœ‰å¤šç³Ÿç³•ï¼Ÿ</h3><p>å¦‚æœæœåŠ¡ç«¯è¦æä¾›æ–‡ä»¶ä¼ è¾“çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬èƒ½æƒ³åˆ°çš„æœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼šå°†ç£ç›˜ä¸Šçš„æ–‡ä»¶è¯»å–å‡ºæ¥ï¼Œç„¶åé€šè¿‡ç½‘ç»œåè®®å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p><p>ä¼ ç»Ÿ I&#x2F;O çš„å·¥ä½œæ–¹å¼æ˜¯ï¼Œæ•°æ®è¯»å–å’Œå†™å…¥æ˜¯ä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´æ¥å›å¤åˆ¶ï¼Œè€Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿå±‚é¢çš„ I&#x2F;O æ¥å£ä»ç£ç›˜è¯»å–æˆ–å†™å…¥ã€‚</p><p>ä»£ç é€šå¸¸å¦‚ä¸‹ï¼Œä¸€èˆ¬ä¼šéœ€è¦ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">read(file, tmp_buf, len);<br>write(socket, tmp_buf, len);<br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆç®€å•ï¼Œè™½ç„¶å°±ä¸¤è¡Œä»£ç ï¼Œä½†æ˜¯è¿™é‡Œé¢å‘ç”Ÿäº†ä¸å°‘çš„äº‹æƒ…ã€‚</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“.png" alt="img" style="zoom:50%;"><p>é¦–å…ˆï¼ŒæœŸé—´å…±<strong>å‘ç”Ÿäº† 4 æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼Œå› ä¸ºå‘ç”Ÿäº†ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€æ¬¡æ˜¯ <code>read()</code> ï¼Œä¸€æ¬¡æ˜¯ <code>write()</code>ï¼Œæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨éƒ½å¾—å…ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç­‰å†…æ ¸å®Œæˆä»»åŠ¡åï¼Œå†ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚</p><p>ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æˆæœ¬å¹¶ä¸å°ï¼Œä¸€æ¬¡åˆ‡æ¢éœ€è¦è€—æ—¶å‡ åçº³ç§’åˆ°å‡ å¾®ç§’ï¼Œè™½ç„¶æ—¶é—´çœ‹ä¸Šå»å¾ˆçŸ­ï¼Œä½†æ˜¯åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œè¿™ç±»æ—¶é—´å®¹æ˜“è¢«ç´¯ç§¯å’Œæ”¾å¤§ï¼Œä»è€Œå½±å“ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><p>å…¶æ¬¡ï¼Œè¿˜<strong>å‘ç”Ÿäº† 4 æ¬¡æ•°æ®æ‹·è´</strong>ï¼Œå…¶ä¸­ä¸¤æ¬¡æ˜¯ DMA çš„æ‹·è´ï¼Œå¦å¤–ä¸¤æ¬¡åˆ™æ˜¯é€šè¿‡ CPU æ‹·è´çš„ï¼Œä¸‹é¢è¯´ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ul><li><em>ç¬¬ä¸€æ¬¡æ‹·è´</em>ï¼ŒæŠŠç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªæ‹·è´çš„è¿‡ç¨‹æ˜¯é€šè¿‡ DMA æ¬è¿çš„ã€‚</li><li><em>ç¬¬äºŒæ¬¡æ‹·è´</em>ï¼ŒæŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œäºæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºå°±å¯ä»¥ä½¿ç”¨è¿™éƒ¨åˆ†æ•°æ®äº†ï¼Œè¿™ä¸ªæ‹·è´åˆ°è¿‡ç¨‹æ˜¯ç”± CPU å®Œæˆçš„ã€‚</li><li><em>ç¬¬ä¸‰æ¬¡æ‹·è´</em>ï¼ŒæŠŠåˆšæ‰æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œå†æ‹·è´åˆ°å†…æ ¸çš„ socket çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¾ç„¶è¿˜æ˜¯ç”± CPU æ¬è¿çš„ã€‚</li><li><em>ç¬¬å››æ¬¡æ‹·è´</em>ï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹åˆæ˜¯ç”± DMA æ¬è¿çš„ã€‚</li></ul><p>æˆ‘ä»¬å›è¿‡å¤´çœ‹è¿™ä¸ªæ–‡ä»¶ä¼ è¾“çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªæ˜¯æ¬è¿ä¸€ä»½æ•°æ®ï¼Œç»“æœå´æ¬è¿äº† 4 æ¬¡ï¼Œè¿‡å¤šçš„æ•°æ®æ‹·è´æ— ç–‘ä¼šæ¶ˆè€— CPU èµ„æºï¼Œå¤§å¤§é™ä½äº†ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>è¿™ç§ç®€å•åˆä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ï¼Œå­˜åœ¨å†—ä½™çš„ä¸Šæ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´ï¼Œåœ¨é«˜å¹¶å‘ç³»ç»Ÿé‡Œæ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œå¤šäº†å¾ˆå¤šä¸å¿…è¦çš„å¼€é”€ï¼Œä¼šä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>è¦æƒ³æé«˜æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Œå°±éœ€è¦å‡å°‘ã€Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€å’Œã€Œå†…å­˜æ‹·è´ã€çš„æ¬¡æ•°</strong>ã€‚</p><h3 id="4-3-å¦‚ä½•ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Ÿ"><a href="#4-3-å¦‚ä½•ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Ÿ" class="headerlink" title="4.3 å¦‚ä½•ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Ÿ"></a>4.3 å¦‚ä½•ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Ÿ</h3><blockquote><p>å…ˆæ¥çœ‹çœ‹ï¼Œå¦‚ä½•å‡å°‘ã€Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€çš„æ¬¡æ•°å‘¢ï¼Ÿ</p></blockquote><p>è¯»å–ç£ç›˜æ•°æ®çš„æ—¶å€™ï¼Œä¹‹æ‰€ä»¥è¦å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™æ˜¯å› ä¸ºç”¨æˆ·ç©ºé—´æ²¡æœ‰æƒé™æ“ä½œç£ç›˜æˆ–ç½‘å¡ï¼Œå†…æ ¸çš„æƒé™æœ€é«˜ï¼Œè¿™äº›æ“ä½œè®¾å¤‡çš„è¿‡ç¨‹éƒ½éœ€è¦äº¤ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ¥å®Œæˆï¼Œæ‰€ä»¥ä¸€èˆ¬è¦é€šè¿‡å†…æ ¸å»å®ŒæˆæŸäº›ä»»åŠ¡çš„æ—¶å€™ï¼Œå°±éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚</p><p>è€Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å¿…ç„¶ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šé¦–å…ˆä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå½“å†…æ ¸æ‰§è¡Œå®Œä»»åŠ¡åï¼Œå†åˆ‡æ¢å›ç”¨æˆ·æ€äº¤ç”±è¿›ç¨‹ä»£ç æ‰§è¡Œã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>è¦æƒ³å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æ¬¡æ•°ï¼Œå°±è¦å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°</strong>ã€‚</p><blockquote><p>å†æ¥çœ‹çœ‹ï¼Œå¦‚ä½•å‡å°‘ã€Œæ•°æ®æ‹·è´ã€çš„æ¬¡æ•°ï¼Ÿ</p></blockquote><p>åœ¨å‰é¢æˆ‘ä»¬çŸ¥é“äº†ï¼Œä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ä¼šå†ç» 4 æ¬¡æ•°æ®æ‹·è´ï¼Œè€Œä¸”è¿™é‡Œé¢ï¼Œã€Œä»å†…æ ¸çš„è¯»ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œå†ä»ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œæ‹·è´åˆ° socket çš„ç¼“å†²åŒºé‡Œã€ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚</p><p>å› ä¸ºæ–‡ä»¶ä¼ è¾“çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œåœ¨ç”¨æˆ·ç©ºé—´æˆ‘ä»¬å¹¶ä¸ä¼šå¯¹æ•°æ®ã€Œå†åŠ å·¥ã€ï¼Œæ‰€ä»¥æ•°æ®å®é™…ä¸Šå¯ä»¥ä¸ç”¨æ¬è¿åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤<strong>ç”¨æˆ·çš„ç¼“å†²åŒºæ˜¯æ²¡æœ‰å¿…è¦å­˜åœ¨çš„</strong>ã€‚</p><h3 id="4-4-å¦‚ä½•å®ç°é›¶æ‹·è´ï¼Ÿ"><a href="#4-4-å¦‚ä½•å®ç°é›¶æ‹·è´ï¼Ÿ" class="headerlink" title="4.4 å¦‚ä½•å®ç°é›¶æ‹·è´ï¼Ÿ"></a>4.4 å¦‚ä½•å®ç°é›¶æ‹·è´ï¼Ÿ</h3><ul><li>mmap + write</li><li>sendfile</li></ul><p>ä¸‹é¢å°±è°ˆä¸€è°ˆï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å‡å°‘ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€å’Œã€Œæ•°æ®æ‹·è´ã€çš„æ¬¡æ•°ã€‚</p><h4 id="4-4-1-mmap-write"><a href="#4-4-1-mmap-write" class="headerlink" title="4.4.1 mmap + write"></a>4.4.1 mmap + write</h4><p>åœ¨å‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œ<code>read()</code> ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œäºæ˜¯ä¸ºäº†å‡å°‘è¿™ä¸€æ­¥å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>mmap()</code> æ›¿æ¢ <code>read()</code> ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">buf = mmap(file, len);<br>write(sockfd, buf, len);<br></code></pre></td></tr></table></figure><p><code>mmap()</code> ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®ã€Œ<strong>æ˜ å°„</strong>ã€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„æ•°æ®æ‹·è´æ“ä½œã€‚</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/mmap %2B write é›¶æ‹·è´.png" alt="img" style="zoom: 50%;"><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åº”ç”¨è¿›ç¨‹è°ƒç”¨äº† <code>mmap()</code> åï¼ŒDMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºé‡Œã€‚æ¥ç€ï¼Œåº”ç”¨è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›</li><li>åº”ç”¨è¿›ç¨‹å†è°ƒç”¨ <code>write()</code>ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼›</li><li>æœ€åï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± DMA æ¬è¿çš„ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ <code>mmap()</code> æ¥ä»£æ›¿ <code>read()</code>ï¼Œ å¯ä»¥å‡å°‘ä¸€æ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹ã€‚</p><p>ä½†è¿™è¿˜ä¸æ˜¯æœ€ç†æƒ³çš„é›¶æ‹·è´ï¼Œå› ä¸ºä»ç„¶éœ€è¦é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œè€Œä¸”ä»ç„¶éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ 2 æ¬¡ã€‚</p><h4 id="4-4-2-sendfile"><a href="#4-4-2-sendfile" class="headerlink" title="4.4.2  sendfile"></a>4.4.2  sendfile</h4><p>åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨å‘é€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° <code>sendfile()</code>ï¼Œå‡½æ•°å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sendfile</span><span class="hljs-params">(<span class="hljs-type">int</span> out_fd, <span class="hljs-type">int</span> in_fd, <span class="hljs-type">off_t</span> *offset, <span class="hljs-type">size_t</span> count)</span>;<br></code></pre></td></tr></table></figure><p>å®ƒçš„å‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç›®çš„ç«¯å’Œæºç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåé¢ä¸¤ä¸ªå‚æ•°æ˜¯æºç«¯çš„åç§»é‡å’Œå¤åˆ¶æ•°æ®çš„é•¿åº¦ï¼Œè¿”å›å€¼æ˜¯å®é™…å¤åˆ¶æ•°æ®çš„é•¿åº¦ã€‚</p><p>é¦–å…ˆï¼Œå®ƒå¯ä»¥æ›¿ä»£å‰é¢çš„ <code>read()</code> å’Œ <code>write()</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±å‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚</p><p>å…¶æ¬¡ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œä¸å†æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œè¿™æ ·å°±åªæœ‰ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 3 æ¬¡æ•°æ®æ‹·è´ã€‚å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/senfile-3æ¬¡æ‹·è´.png" alt="img" style="zoom:50%;"><p>ä½†æ˜¯è¿™è¿˜ä¸æ˜¯çœŸæ­£çš„é›¶æ‹·è´æŠ€æœ¯ï¼Œå¦‚æœç½‘å¡æ”¯æŒ SG-DMAï¼ˆ<em>The Scatter-Gather Direct Memory Access</em>ï¼‰æŠ€æœ¯ï¼ˆå’Œæ™®é€šçš„ DMA æœ‰æ‰€ä¸åŒï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å‡å°‘é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºçš„è¿‡ç¨‹ã€‚</p><p>ä½ å¯ä»¥åœ¨ä½ çš„ Linux ç³»ç»Ÿé€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹ç½‘å¡æ˜¯å¦æ”¯æŒ scatter-gather ç‰¹æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">$ ethtool -k eth0 | grep scatter-gather<br>scatter-gather: on<br></code></pre></td></tr></table></figure><p>äºæ˜¯ï¼Œä» Linux å†…æ ¸ <code>2.4</code> ç‰ˆæœ¬å¼€å§‹èµ·ï¼Œå¯¹äºæ”¯æŒç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯çš„æƒ…å†µä¸‹ï¼Œ <code>sendfile()</code> ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å‘ç”Ÿäº†ç‚¹å˜åŒ–ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ DMA å°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºé‡Œï¼›</li><li>ç¬¬äºŒæ­¥ï¼Œç¼“å†²åŒºæè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¼ åˆ° socket ç¼“å†²åŒºï¼Œè¿™æ ·ç½‘å¡çš„ SG-DMA æ§åˆ¶å™¨å°±å¯ä»¥ç›´æ¥å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼›</li></ul><p>æ‰€ä»¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹‹ä¸­ï¼Œåªè¿›è¡Œäº† 2 æ¬¡æ•°æ®æ‹·è´ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/10/25/%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86/senfile-é›¶æ‹·è´.png" alt="img" style="zoom: 50%;"><p>è¿™å°±æ˜¯æ‰€è°“çš„<strong>é›¶æ‹·è´ï¼ˆZero-copyï¼‰æŠ€æœ¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨å†…å­˜å±‚é¢å»æ‹·è´æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨ç¨‹æ²¡æœ‰é€šè¿‡ CPU æ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ DMA æ¥è¿›è¡Œä¼ è¾“çš„ã€‚</strong>ã€‚</p><p>é›¶æ‹·è´æŠ€æœ¯çš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ç›¸æ¯”ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“çš„æ–¹å¼ï¼Œå‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œ<strong>åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„ä¼ è¾“ï¼Œè€Œä¸” 2 æ¬¡çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œéƒ½ä¸éœ€è¦é€šè¿‡ CPUï¼Œ2 æ¬¡éƒ½æ˜¯ç”± DMA æ¥æ¬è¿ã€‚</strong></p><p>æ‰€ä»¥ï¼Œæ€»ä½“æ¥çœ‹ï¼Œ<strong>é›¶æ‹·è´æŠ€æœ¯å¯ä»¥æŠŠæ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½æé«˜è‡³å°‘ä¸€å€ä»¥ä¸Š</strong>ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å†…æ ¸å¸¸ç”¨çš„bitæ“ä½œ</title>
    <link href="/2023/10/16/%E5%86%85%E6%A0%B8%E5%B8%B8%E7%94%A8%E7%9A%84bit%E6%93%8D%E4%BD%9C/"/>
    <url>/2023/10/16/%E5%86%85%E6%A0%B8%E5%B8%B8%E7%94%A8%E7%9A%84bit%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="å†…æ ¸å¸¸ç”¨çš„bitæ“ä½œ"><a href="#å†…æ ¸å¸¸ç”¨çš„bitæ“ä½œ" class="headerlink" title="å†…æ ¸å¸¸ç”¨çš„bitæ“ä½œ"></a>å†…æ ¸å¸¸ç”¨çš„bitæ“ä½œ</h1><h3 id="set-bit-x2F-clear-bit"><a href="#set-bit-x2F-clear-bit" class="headerlink" title="set_bit&#x2F;clear_bit"></a>set_bit&#x2F;clear_bit</h3><p>set_bit(nr,addr)å°†addrçš„ç¬¬nrä½ç½®1</p><p>clear_bit(nr,addr)</p><p>test_and_set_bit(nr,addr)å°†addrçš„ç¬¬nrä½ç½®1ï¼Œå¹¶è¿”å›åŸå§‹addrç¬¬nrä½çš„å€¼</p><p>test_and_clear_bit(nr,addr)</p><h3 id="é¡µé”"><a href="#é¡µé”" class="headerlink" title="é¡µé”"></a>é¡µé”</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">lock_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br>might_sleep();<br><span class="hljs-keyword">if</span> (!trylock_page(page))<br>__lock_page(page);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">trylock_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br>page = compound_head(page);<br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å¯ä»¥é”å®šè¿™ä¸ªpage.å¦‚æœæ²¡æœ‰å…¶ä»–è¿›ç¨‹ç”¨è¿™ä¸ªpageï¼Œåˆ™ç›´æ¥è®¾ç½®flagæ¥é”å®šè¿™ä¸ªpageï¼Œå¦åˆ™è°ƒç”¨__lock_page</span><br><span class="hljs-comment">// æ¥ç­‰å¾…è¿™ä¸ªé¡µé¢è¢«é‡Šæ”¾</span><br><span class="hljs-keyword">return</span> (likely(!test_and_set_bit_lock(PG_locked, &amp;page-&gt;flags)));<br>&#125;<br><br><span class="hljs-type">void</span> __lock_page(<span class="hljs-keyword">struct</span> page *__page)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> compound_head(__page);<br><span class="hljs-type">wait_queue_head_t</span> *q = page_waitqueue(page);<br>wait_on_page_bit_common(q, page, PG_locked, TASK_UNINTERRUPTIBLE,<br>EXCLUSIVE);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>bioå®ç°å¯¹ç£ç›˜è¯»å†™ï¼Œç”¨bio_add_pageä¸submit_bioçš„æ–¹å¼</title>
    <link href="/2023/10/16/bio%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%EF%BC%8C%E7%94%A8bio-add-page%E4%B8%8Esubmit-bio%E7%9A%84%E6%96%B9%E5%BC%8F/"/>
    <url>/2023/10/16/bio%E5%AE%9E%E7%8E%B0%E5%AF%B9%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%EF%BC%8C%E7%94%A8bio-add-page%E4%B8%8Esubmit-bio%E7%9A%84%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="bioå®ç°å¯¹ç£ç›˜è¯»å†™ï¼Œç”¨bio-add-pageä¸submit-bioçš„æ–¹å¼"><a href="#bioå®ç°å¯¹ç£ç›˜è¯»å†™ï¼Œç”¨bio-add-pageä¸submit-bioçš„æ–¹å¼" class="headerlink" title="bioå®ç°å¯¹ç£ç›˜è¯»å†™ï¼Œç”¨bio_add_pageä¸submit_bioçš„æ–¹å¼"></a>bioå®ç°å¯¹ç£ç›˜è¯»å†™ï¼Œç”¨bio_add_pageä¸submit_bioçš„æ–¹å¼</h1><p>åœ¨Linuxå†…æ ¸ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>struct bio</code>æ•°æ®ç»“æ„å’Œç›¸åº”çš„å‡½æ•°æ¥å®ç°å¯¹ç£ç›˜çš„è¯»å†™æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>bio_add_page()</code>å’Œ<code>submit_bio()</code>å‡½æ•°è¿›è¡Œç£ç›˜è¯»å†™çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><br><span class="hljs-comment">// è¯»æ“ä½œçš„å›è°ƒå‡½æ•°ï¼Œå¯åœ¨æ­¤å¤„è¿›è¡Œå¤„ç†</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_complete</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bio *bio, <span class="hljs-type">int</span> err)</span><br>&#123;<br>    <span class="hljs-comment">// å¤„ç†è¯»å–å®Œæˆåçš„é€»è¾‘</span><br>&#125;<br><br><span class="hljs-comment">// è¯»å†™æ•°æ®å‡½æ•°</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">disk_read_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> block_device *bdev, <span class="hljs-type">sector_t</span> start_sector, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sectors, <span class="hljs-type">int</span> is_write)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio</span> *<span class="hljs-title">bio</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> *<span class="hljs-title">q</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gendisk</span> *<span class="hljs-title">disk</span>;</span><br><br>    disk = bdev-&gt;bd_disk;<br>    q = disk-&gt;<span class="hljs-built_in">queue</span>;<br><br>    bio = bio_alloc(GFP_NOIO, BIO_MAX_PAGES);<br>    <span class="hljs-keyword">if</span> (!bio)<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br><br>    bio-&gt;bi_iter.bi_sector = start_sector;<br>    bio-&gt;bi_bdev = bdev;<br>    bio-&gt;bi_end_io = read_complete;<br><br>    <span class="hljs-keyword">while</span> (sectors &gt; <span class="hljs-number">0</span>) &#123;<br>        page = alloc_page(GFP_NOIO);<br>        <span class="hljs-keyword">if</span> (!page) &#123;<br>            bio_put(bio);<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-comment">// å°†é¡µæ·»åŠ åˆ° BIO ä¸­</span><br>        bio_add_page(bio, page, PAGE_SIZE, <span class="hljs-number">0</span>);<br><br>        sectors--;<br>        start_sector++;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (is_write)<br>        bio_set_op_attrs(bio, REQ_OP_WRITE, REQ_SYNC);<br>    <span class="hljs-keyword">else</span><br>         bio_set_op_attrs(bio, REQ_OP_READ, REQ_SYNC | REQ_META);<br><br>    <span class="hljs-comment">// æäº¤ BIO è¿›è¡Œè¯»æ“ä½œ</span><br>    submit_bio(READ_SYNC, bio);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿdo_writepagesæµç¨‹åˆ†æ</title>
    <link href="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <url>/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="æ–‡ä»¶ç³»ç»Ÿdo-writepagesæµç¨‹åˆ†æ"><a href="#æ–‡ä»¶ç³»ç»Ÿdo-writepagesæµç¨‹åˆ†æ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿdo_writepagesæµç¨‹åˆ†æ"></a>æ–‡ä»¶ç³»ç»Ÿdo_writepagesæµç¨‹åˆ†æ</h1><h2 id="å…¥å£å‡½æ•°do-writepages"><a href="#å…¥å£å‡½æ•°do-writepages" class="headerlink" title="å…¥å£å‡½æ•°do_writepages"></a>å…¥å£å‡½æ•°do_writepages</h2><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231015200520926.png" alt="image-20231015200520926" style="zoom:67%;"><p>å¯ä»¥çœ‹åˆ°ä¼šå…ˆåˆ¤æ–­mappingå¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æœ‰writepageså‡½æ•°ï¼Œ</p><ul><li>å¦‚æœæœ‰åˆ™è°ƒç”¨å„è‡ªæ–‡ä»¶ç³»ç»Ÿçš„writepageså‡½æ•°</li><li>å¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨å…¬å…±çš„æ¥å£generic_writepages</li></ul><h3 id="å…¬å…±å†™é¡µæ¥å£generic-writepages"><a href="#å…¬å…±å†™é¡µæ¥å£generic-writepages" class="headerlink" title="å…¬å…±å†™é¡µæ¥å£generic_writepages"></a>å…¬å…±å†™é¡µæ¥å£generic_writepages</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">generic_writepages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-keyword">struct</span> writeback_control *wbc)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_plug</span> <span class="hljs-title">plug</span>;</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">/* deal with chardevs and other special file */</span><br><span class="hljs-keyword">if</span> (!mapping-&gt;a_ops-&gt;writepage)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>blk_start_plug(&amp;plug);<br>ret = write_cache_pages(mapping, wbc, __writepage, mapping);<br>blk_finish_plug(&amp;plug);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å†™é¡µæ¥å£"><a href="#ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å†™é¡µæ¥å£" class="headerlink" title="ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å†™é¡µæ¥å£"></a>ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å†™é¡µæ¥å£</h3><h4 id="ext4æ–‡ä»¶ç³»ç»Ÿ"><a href="#ext4æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ext4æ–‡ä»¶ç³»ç»Ÿ"></a>ext4æ–‡ä»¶ç³»ç»Ÿ</h4><h4 id="f2fsæ–‡ä»¶ç³»ç»Ÿ"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿ"></a>f2fsæ–‡ä»¶ç³»ç»Ÿ</h4><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/u011649400/article/details/94589060">https://blog.csdn.net/u011649400/article/details/94589060</a></p></blockquote><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231015214705090.png" alt="image-20231015214705090" style="zoom:90%;"><p>f2fsæ–‡ä»¶ç³»ç»ŸåŒºåˆ†äº†nodeï¼Œdataï¼Œmetadataä¸åŒçš„æ¥å£</p><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231015200929261.png" alt="image-20231015200929261" style="zoom: 80%;"><p>ä»¥å†™æ•°æ®é¡µä¸ºä¾‹ï¼Œwritepageså¯¹åº”çš„æ¥å£ä¸ºf2fs_write_data_pages</p><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231015200852579.png" alt="image-20231015200852579" style="zoom:50%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_data_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> writeback_control *wbc)</span><br>&#123;<br>    <span class="hljs-comment">// é€šè¿‡mapping-&gt;hostæ‹¿åˆ°inode</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> mapping-&gt;host;<br><br><span class="hljs-keyword">return</span> __f2fs_write_data_pages(mapping, wbc,<br>F2FS_I(inode)-&gt;cp_task == current ?<br>FS_CP_DATA_IO : FS_DATA_IO);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __f2fs_write_data_pages(<span class="hljs-keyword">struct</span> address_space *mapping,<br><span class="hljs-keyword">struct</span> writeback_control *wbc,<br><span class="hljs-keyword">enum</span> iostat_type io_type)<br>&#123;<br>ret = f2fs_write_cache_pages(mapping, wbc, io_type); <span class="hljs-comment">// å–å‡ºéœ€è¦å›å†™çš„pageï¼Œç„¶åå†™å…¥</span><br>f2fs_remove_dirty_inode(inode); <span class="hljs-comment">// å†™å…¥åå°†inodeä»dirtyæ ‡å¿—æ¸…é™¤ï¼Œå³ä¸éœ€è¦å†å›å†™</span><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>f2fs_write_cache_pageså‡½æ•°</strong></p><p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä»inodeå¯¹åº”çš„mapping(radix treeçš„root)ä¸­ï¼Œå–å‡ºæ‰€æœ‰éœ€è¦å›å†™çš„pageï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œé€ä¸ªå†™å…¥åˆ°ç£ç›˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_cache_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> writeback_control *wbc,</span><br><span class="hljs-params"><span class="hljs-keyword">enum</span> iostat_type io_type)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pagevec</span> <span class="hljs-title">pvec</span>;</span><br><br>pagevec_init(&amp;pvec); <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªç”¨äºè£…è½½pageçš„æ•°ç»„ï¼Œæ•°ç»„å¤§å°æ˜¯15ä¸ªpage</span><br><br>retry:<br>done_index = index;<br><br><span class="hljs-keyword">while</span> (!done &amp;&amp; !retry &amp;&amp; (index &lt;= end)) &#123;<br><span class="hljs-comment">// ä»mappingä¸­å–å‡ºtagç±»å‹çš„15ä¸ªpageï¼Œè£…è½½åˆ°pvecä¸­</span><br>nr_pages = pagevec_lookup_range_tag(&amp;pvec, mapping, &amp;index, end, tag); <br><br><span class="hljs-comment">// å¾ªç¯å°†pvecä¸­çš„pageå–å‡ºï¼Œå›å†™åˆ°ç£ç›˜</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pvec.pages[i];<br>ret = f2fs_write_single_data_page(page, &amp;submitted, &amp;bio, &amp;last_block, wbc, io_type, <span class="hljs-number">0</span>);<br>&#125;<br>pagevec_release(&amp;pvec); <span class="hljs-comment">// é‡Šæ”¾æ‰pvec</span><br>cond_resched();<br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>f2fs_write_single_data_page</strong>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_single_data_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">int</span> *submitted,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> bio **bio,</span><br><span class="hljs-params"><span class="hljs-type">sector_t</span> *last_block,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> writeback_control *wbc,</span><br><span class="hljs-params"><span class="hljs-keyword">enum</span> iostat_type io_type,</span><br><span class="hljs-params"><span class="hljs-type">int</span> compr_blocks)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™ä¸ªæ•°æ®ç»“æ„åœ¨æ•´ä¸ªå†™æµç¨‹éå¸¸é‡è¦ï¼Œè®°å½•äº†å†™å…¥çš„ä¿¡æ¯</span><br><span class="hljs-comment">// å…³é”®å˜é‡æ˜¯ fio-&gt;old_blkaddr ä»¥åŠ fio-&gt;new_blkaddrè®°å½•æ—§åœ°å€å’Œæ–°åœ°å€</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_io_info</span> <span class="hljs-title">fio</span> =</span> &#123;<br>.sbi = sbi,<br>.ino = inode-&gt;i_ino,<br>.type = DATA,<br>.op = REQ_OP_WRITE,<br>.op_flags = wbc_to_write_flags(wbc),<br>.old_blkaddr = NULL_ADDR,<br>.page = page,<br>.encrypted_page = <span class="hljs-literal">NULL</span>,<br>.submitted = <span class="hljs-literal">false</span>,<br>.compr_blocks = compr_blocks,<br>.need_lock = LOCK_RETRY,<br>.io_type = io_type,<br>.io_wbc = wbc,<br>.bio = bio,<br>.last_block = last_block,<br>&#125;;<br>write:<br><span class="hljs-keyword">if</span> (S_ISDIR(inode-&gt;i_mode)) &#123; <span class="hljs-comment">// å¦‚æœæ˜¯ç›®å½•æ–‡ä»¶ï¼Œç›´æ¥å†™å…¥ä¸éœ€è¦ä¿®æ”¹</span><br>err = f2fs_do_write_data_page(&amp;fio);<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><br>err = -EAGAIN;<br><span class="hljs-keyword">if</span> (f2fs_has_inline_data(inode)) &#123; <span class="hljs-comment">// å†…è”æ–‡ä»¶ä½¿ç”¨å†…è”çš„å†™å…¥æ–¹å¼</span><br>err = f2fs_write_inline_data(inode, page);<br><span class="hljs-keyword">if</span> (!err)<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-keyword">if</span> (err == -EAGAIN) &#123; <span class="hljs-comment">// æ™®é€šæ–‡ä»¶åˆ™ä½¿ç”¨æ™®é€šçš„æ–¹å¼</span><br>err = f2fs_do_write_data_page(&amp;fio);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>f2fs_do_write_data_page</strong>å‡½æ•°</p><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®ç³»ç»Ÿçš„çŠ¶æ€é€‰æ‹©å°±åœ°æ›´æ–°æ•°æ®(inplace update)è¿˜æ˜¯å¼‚åœ°æ›´æ–°æ•°æ®(outplace update)ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç³»ç»Ÿåªä¼šåœ¨ç£ç›˜ç©ºé—´æ¯”è¾ƒæ»¡çš„æ—¶å€™é€‰æ‹©å°±åœ°æ›´æ–°ç­–ç•¥ï¼Œé¿å…è§¦å‘è¿‡å¤šçš„gcå½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»å¼‚åœ°æ›´æ–°çš„å†™æµç¨‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_do_write_data_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span> <span class="hljs-comment">// å‰é¢æåˆ°fioæ˜¯å†™æµç¨‹æœ€é‡è¦çš„æ•°æ®ç»“æ„</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> fio-&gt;page;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> page-&gt;mapping-&gt;host;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dnode_of_data</span> <span class="hljs-title">dn</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extent_info</span> <span class="hljs-title">ei</span> =</span> &#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">bool</span> ipu_force = <span class="hljs-literal">false</span>;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br>set_new_dnode(&amp;dn, inode, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// åˆå§‹åŒ–dnode</span><br>err = f2fs_get_dnode_of_data(&amp;dn, page-&gt;index, LOOKUP_NODE); <span class="hljs-comment">// æ ¹æ®æ–‡ä»¶åç§»page-&gt;indexè·å–ç‰©ç†åœ°å€</span><br><br>fio-&gt;old_blkaddr = dn.data_blkaddr; <span class="hljs-comment">// å°†æ—§çš„ç‰©ç†åœ°å€èµ‹å€¼ç»™fio-&gt;old_blkaddr</span><br><br><span class="hljs-keyword">if</span> (fio-&gt;old_blkaddr == NULL_ADDR) &#123; <span class="hljs-comment">// å‰é¢æåŠåˆ°f2fs_file_write_iterå·²ç»å°†ç‰©ç†åœ°å€è®¾ç½®ä¸ºNEW_ADDRæˆ–è€…å…·ä½“çš„blockå·ï¼Œå› æ­¤è¿™é‡Œè¡¨ç¤ºåœ¨å†™å…¥ç£ç›˜ä¹‹å‰ï¼Œç”¨æˆ·åˆå°†è¿™éƒ¨åˆ†æ•°æ®åˆ é™¤äº†ï¼Œæ‰€ä»¥æ²¡å¿…è¦å†™å…¥äº†</span><br>ClearPageUptodate(page);<br><span class="hljs-keyword">goto</span> out_writepage;<br>&#125;<br>got_it:<br><span class="hljs-keyword">if</span> (ipu_force || (is_valid_blkaddr(fio-&gt;old_blkaddr) &amp;&amp;<br>need_inplace_update(fio))) &#123; <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦å°±åœ°æ›´æ–°</span><br>err = encrypt_one_page(fio);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> out_writepage;<br><br>set_page_writeback(page);<br>ClearPageError(page);<br>f2fs_put_dnode(&amp;dn);<br><span class="hljs-keyword">if</span> (fio-&gt;need_lock == LOCK_REQ)<br>f2fs_unlock_op(fio-&gt;sbi);<br>err = f2fs_inplace_write_data(fio); <span class="hljs-comment">// ä½¿ç”¨å°±åœ°æ›´æ–°çš„æ–¹å¼å†™å…¥</span><br>trace_f2fs_do_write_data_page(fio-&gt;page, IPU);<br>set_inode_flag(inode, FI_UPDATE_WRITE);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br>err = encrypt_one_page(fio); <span class="hljs-comment">// å¦‚æœå¼€å¯ç³»ç»ŸåŠ å¯†ï¼Œä¼šå°†è¿™ä¸ªfio-&gt;pageå…ˆåŠ å¯†</span><br><br>set_page_writeback(page);<br>ClearPageError(page);<br><br>f2fs_outplace_write_data(&amp;dn, fio); <span class="hljs-comment">// æ‰§è¡Œå¼‚åœ°æ›´æ–°å‡½æ•°</span><br><br>set_inode_flag(inode, FI_APPEND_WRITE);<br><span class="hljs-keyword">if</span> (page-&gt;index == <span class="hljs-number">0</span>)<br>set_inode_flag(inode, FI_FIRST_BLOCK_WRITTEN);<br>out_writepage:<br>f2fs_put_dnode(&amp;dn);<br>out:<br><span class="hljs-keyword">if</span> (fio-&gt;need_lock == LOCK_REQ)<br>f2fs_unlock_op(fio-&gt;sbi);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>f2fs_outplace_write_data</strong>å‡½æ•°</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨ä½œå¼‚åœ°æ›´æ–°ï¼Œæ‰€è°“å¼‚åœ°æ›´æ–°å³ä¸åœ¨åŸå…ˆçš„ç‰©ç†åœ°å€æ›´æ–°æ•°æ®ï¼Œå› æ­¤åŒ…å«äº†å¦‚ä¸‹å››ä¸ªæ­¥éª¤:</p><ol><li>åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†åœ°å€</li><li>å°†æ•°æ®å†™å…¥æ–°çš„ç‰©ç†åœ°å€</li><li>å°†æ—§çš„ç‰©ç†åœ°å€æ— æ•ˆæ‰ï¼Œç„¶åç­‰GCå›æ”¶</li><li>æ›´æ–°é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»</li></ol><p>æœ¬å‡½æ•°å³å®Œæˆä»¥ä¸Šå››ä¸ªæ­¥éª¤:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_outplace_write_data</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dnode_of_data *dn,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sb_info</span> *<span class="hljs-title">sbi</span> =</span> fio-&gt;sbi;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> <span class="hljs-title">sum</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_info</span> <span class="hljs-title">ni</span>;</span><br><br>f2fs_get_node_info(sbi, dn-&gt;nid, &amp;ni);<br>set_summary(&amp;sum, dn-&gt;nid, dn-&gt;ofs_in_node, ni.version);<br><br>do_write_page(&amp;sum, fio); <span class="hljs-comment">// è¿™é‡Œå®Œæˆç¬¬1,2,3æ­¥éª¤</span><br>f2fs_update_data_blkaddr(dn, fio-&gt;new_blkaddr); <span class="hljs-comment">// è¿™é‡Œå®Œæˆç¬¬å››ä¸ªæ­¥éª¤ï¼Œé‡æ–°å»ºç«‹æ˜ å°„</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å¤šæ¬¡æåŠåˆ°struct dnode_of_data dnçš„ä½œç”¨æ˜¯æ ¹æ®æ–‡ä»¶inodeï¼Œæ‰¾åˆ°f2fs_inodeæˆ–è€…direct_nodeï¼Œç„¶åå†é€šè¿‡æ–‡ä»¶åç§»å¾—åˆ°ç‰©ç†åœ°å€ï¼Œå› æ­¤f2fs_update_data_blkaddrä¹Ÿæ˜¯é€šè¿‡dnode_of_dataå°†æ–°çš„ç‰©ç†åœ°å€æ›´æ–°åˆ°f2fs_inodeæˆ–è€…direct_nodeå¯¹åº”çš„ä½ç½®ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_update_data_blkaddr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dnode_of_data *dn, <span class="hljs-type">block_t</span> blkaddr)</span><br>&#123;<br>dn-&gt;data_blkaddr = blkaddr; <span class="hljs-comment">// è·å¾—æ–°çš„ç‰©ç†åœ°å€</span><br>f2fs_set_data_blkaddr(dn); <span class="hljs-comment">// æ›´æ–°åœ°å€åˆ°f2fs_inodeæˆ–è€…direct_node</span><br>f2fs_update_extent_cache(dn); <span class="hljs-comment">// æ›´æ–°cache</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_set_data_blkaddr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dnode_of_data *dn)</span><br>&#123;<br>f2fs_wait_on_page_writeback(dn-&gt;node_page, NODE, <span class="hljs-literal">true</span>); <span class="hljs-comment">// å› ä¸ºè¦æ›´æ–°nodeï¼Œæ‰€ä»¥è¦ä¿è¯å½“å‰çš„nodeæ˜¯æœ€æ–°çŠ¶æ€</span><br>__set_data_blkaddr(dn);<br><span class="hljs-keyword">if</span> (set_page_dirty(dn-&gt;node_page)) <span class="hljs-comment">// è®¾ç½®dirtyï¼Œå› ä¸ºæ›´æ–°åçš„åœ°å€è¦å›å†™åˆ°ç£ç›˜è®°å½•</span><br>dn-&gt;node_changed = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __set_data_blkaddr(<span class="hljs-keyword">struct</span> dnode_of_data *dn)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_node</span> *<span class="hljs-title">rn</span> =</span> F2FS_NODE(dn-&gt;node_page); <span class="hljs-comment">// æ ¹æ®node pageè½¬æ¢åˆ°å¯¹åº”çš„f2fs_node</span><br>__le32 *addr_array;<br><span class="hljs-type">int</span> base = <span class="hljs-number">0</span>;<br><br>addr_array = blkaddr_in_node(rn); <span class="hljs-comment">// è¿™ä¸ªç”¨äºè·å¾—f2fs_inode-&gt;i_addråœ°å€æˆ–è€…direct_node-&gt;addråœ°å€</span><br>addr_array[base + dn-&gt;ofs_in_node] = cpu_to_le32(dn-&gt;data_blkaddr); <span class="hljs-comment">// æ ¹æ®åç§»èµ‹å€¼æ›´æ–°</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> __le32 *<span class="hljs-title function_">blkaddr_in_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_node *node)</span><br>&#123;<br><span class="hljs-comment">// RAW_IS_INODEåˆ¤æ–­å½“å‰nodeæ˜¯å±äºf2fs_inodeè¿˜æ˜¯f2fs_nodeï¼Œç„¶åè¿”å›ç‰©ç†åœ°å€æ•°ç»„æŒ‡é’ˆ</span><br><span class="hljs-keyword">return</span> RAW_IS_INODE(node) ? node-&gt;i.i_addr : node-&gt;dn.addr;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>do_write_page</strong>å‡½æ•°</p><p>ä¸Šä¸€èŠ‚æåŠåˆ°å¼‚åœ°æ›´æ–°çš„1,2,3æ­¥éª¤éƒ½æ˜¯åœ¨è¿™é‡Œå®Œæˆï¼Œåˆ†åˆ«æ˜¯<code>f2fs_allocate_data_block</code>å‡½æ•°å®Œæˆæ–°ç‰©ç†åœ°å€çš„åˆ†é…ï¼Œä»¥åŠæ—§ç‰©ç†åœ°å€çš„å›æ”¶; <code>f2fs_submit_page_write</code>å‡½æ•°å®Œæˆæœ€åä¸€æ­¥ï¼Œå°†æ•°æ®æäº¤åˆ°ç£ç›˜ã€‚ä¸‹é¢è¿›è¡Œåˆ†æ:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_write_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span><br>&#123;<br><span class="hljs-type">int</span> type = __get_segment_type(fio); <span class="hljs-comment">// è·å–æ•°æ®ç±»å‹ï¼Œè¿™ä¸ªç±»å‹æŒ‡HOT/WARM/COLD X NODE/DATAçš„å…­ç§ç±»å‹</span><br><br>f2fs_allocate_data_block(fio-&gt;sbi, fio-&gt;page, fio-&gt;old_blkaddr,<br>&amp;fio-&gt;new_blkaddr, sum, type, fio, <span class="hljs-literal">true</span>); <span class="hljs-comment">// å®Œæˆå¼‚åœ°æ›´æ–°çš„1,2æ­¥</span><br><br>f2fs_submit_page_write(fio); <span class="hljs-comment">//å®Œæˆå¼‚åœ°æ›´æ–°çš„ç¬¬3æ­¥</span><br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>f2fs_allocate_data_block</code>å‡½æ•°é¦–å…ˆä¼šæ ¹æ®typeè·å¾—CURSEGã€‚ç„¶ååœ¨CURSEGåˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†å—ï¼Œç„¶åå°†æ—§çš„ç‰©ç†å—æ— æ•ˆæ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_allocate_data_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params"><span class="hljs-type">block_t</span> old_blkaddr, <span class="hljs-type">block_t</span> *new_blkaddr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_summary *sum, <span class="hljs-type">int</span> type,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> f2fs_io_info *fio, <span class="hljs-type">bool</span> add_list)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_i</span> =</span> SIT_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);<br><br>*new_blkaddr = NEXT_FREE_BLKADDR(sbi, curseg); <span class="hljs-comment">// è·å–æ–°çš„ç‰©ç†åœ°å€</span><br><br>__add_sum_entry(sbi, type, sum); <span class="hljs-comment">// å°†å½“å‰summaryæ›´æ–°åˆ°CURSEGä¸­</span><br><br>__refresh_next_blkoff(sbi, curseg); <span class="hljs-comment">// æ›´æ–°ä¸‹ä¸€æ¬¡å¯ä»¥ç”¨çš„ç‰©ç†åœ°å€</span><br><br><span class="hljs-comment">// ä¸‹é¢æ›´æ–°ä¸»è¦æ˜¯æ›´æ–°SITåŒºåŸŸçš„segmentä¿¡æ¯</span><br><br><span class="hljs-comment">// æ ¹æ®new_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºvalid(å€¼ä¸º1)ï¼Œè¡¨ç¤ºè¢«ç”¨æˆ·ä½¿ç”¨ï¼Œä¸å¯è¢«å…¶ä»–äººæ‰€ä½¿ç”¨</span><br>update_sit_entry(sbi, *new_blkaddr, <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// æ ¹æ®old_blkaddræ‰¾åˆ°å¯¹åº”çš„sit_entryï¼Œç„¶åæ›´æ–°çŠ¶æ€ä¸ºinvalid(å€¼ä¸º-1)ï¼Œè¡¨ç¤ºè¢«è¦†ç›–äº†ï¼Œç­‰å¾…GCå›æ”¶åé‡æ–°æŠ•å…¥ä½¿ç”¨</span><br><span class="hljs-keyword">if</span> (GET_SEGNO(sbi, old_blkaddr) != NULL_SEGNO)<br>update_sit_entry(sbi, old_blkaddr, <span class="hljs-number">-1</span>);<br><br><span class="hljs-comment">// å¦‚æœå½“å‰segmentæ²¡æœ‰ç©ºé—´è¿›è¡Œä¸‹ä¸€æ¬¡åˆ†é…äº†ï¼Œå°±åˆ†é…ä¸€ä¸ªæ–°çš„segmentç»™CURSEG</span><br><span class="hljs-keyword">if</span> (!__has_curseg_space(sbi, type))<br>sit_i-&gt;s_ops-&gt;allocate_segment(sbi, type, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// å°†segmentè®¾ç½®ä¸ºè„ï¼Œç­‰CPå†™å›ç£ç›˜</span><br>locate_dirty_segment(sbi, GET_SEGNO(sbi, old_blkaddr));<br>locate_dirty_segment(sbi, GET_SEGNO(sbi, *new_blkaddr));<br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>f2fs_submit_page_write</code>å®Œæˆæœ€åçš„æäº¤åˆ°ç£ç›˜çš„ä»»åŠ¡ï¼Œå…·ä½“æ­¥éª¤æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªbioï¼Œç„¶åå°†pageåŠ å…¥åˆ°bioä¸­ï¼Œå¦‚æœbioæ»¡äº†å°±æäº¤åˆ°ç£ç›˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_submit_page_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_io_info *fio)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sb_info</span> *<span class="hljs-title">sbi</span> =</span> fio-&gt;sbi;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">page_type</span> <span class="hljs-title">btype</span> =</span> PAGE_TYPE_OF_BIO(fio-&gt;type);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_bio_info</span> *<span class="hljs-title">io</span> =</span> sbi-&gt;write_io[btype] + fio-&gt;temp; <span class="hljs-comment">// è¿™ä¸ªæ˜¯F2FSç”¨äºä¸´æ—¶å­˜æ”¾bioçš„å˜é‡</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">bio_page</span>;</span><br><br>down_write(&amp;io-&gt;io_rwsem);<br>next:<br><span class="hljs-comment">// ç¬¬ä¸€æ­¥æ ¹æ®æ˜¯å¦æœ‰åŠ å¯†ï¼Œå°†bio_pageè®¾ç½®ä¸ºå¯¹åº”çš„page</span><br><span class="hljs-keyword">if</span> (fio-&gt;encrypted_page)<br>bio_page = fio-&gt;encrypted_page;<br><span class="hljs-keyword">else</span><br>bio_page = fio-&gt;page;<br><br>fio-&gt;submitted = <span class="hljs-literal">true</span>;<br><br>alloc_new:<br><span class="hljs-comment">// å¦‚æœbioæ˜¯nullï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„bio</span><br><span class="hljs-keyword">if</span> (io-&gt;bio == <span class="hljs-literal">NULL</span>) &#123;<br>io-&gt;bio = __bio_alloc(sbi, fio-&gt;new_blkaddr, fio-&gt;io_wbc,<br>BIO_MAX_PAGES, <span class="hljs-literal">false</span>,<br>fio-&gt;type, fio-&gt;temp); <span class="hljs-comment">// BIO_MAX_PAGESä¸€èˆ¬ç­‰äº256</span><br>io-&gt;fio = *fio;<br>&#125;<br><br><span class="hljs-comment">// å°†pageåŠ å…¥åˆ°bioä¸­ï¼Œå¦‚æœ  &lt; PAGE_SIZE è¡¨ç¤ºbioå·²ç»æ»¡äº†ï¼Œå› æ­¤å°±å…ˆå°†è¿™ä¸ªbioæäº¤ï¼Œç„¶åé‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„bio</span><br><span class="hljs-keyword">if</span> (bio_add_page(io-&gt;bio, bio_page, PAGE_SIZE, <span class="hljs-number">0</span>) &lt; PAGE_SIZE) &#123;<br>__submit_merged_bio(io); <span class="hljs-comment">// æäº¤bioï¼Œæœ€ç»ˆä¼šæ‰§è¡Œsubmit_bioå‡½æ•°</span><br><span class="hljs-keyword">goto</span> alloc_new;<br>&#125;<br>out:<br>up_write(&amp;io-&gt;io_rwsem);<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ï¼Œå½“bioè¿˜æ²¡æœ‰å¡«æ»¡pageçš„æ—¶å€™æ˜¯ä¸ä¼šè¢«æäº¤åˆ°ç£ç›˜çš„ï¼Œè¿™æ˜¯å› ä¸ºF2FSé€šè¿‡å¢å¤§bioçš„sizeæé«˜äº†å†™æ€§èƒ½ã€‚å› æ­¤ï¼Œåœ¨ç”¨æˆ·fsyncæˆ–è€…ç³»ç»Ÿwritebackçš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯è¿™äº›pageéƒ½å¯ä»¥åˆ·å†™åˆ°ç£ç›˜ï¼Œä¼šå¦‚f2fs_write_cache_pageså‡½æ•°æ‰€ä»‹ç»ä¸€æ ·ï¼Œé€šè¿‡f2fs_submit_merged_write_condå‡½æ•°æˆ–è€…å…¶ä»–å‡½æ•°å¼ºè¡Œæäº¤è¿™ä¸ªpageæœªæ»¡çš„bioã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿsync</title>
    <link href="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/"/>
    <url>/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/</url>
    
    <content type="html"><![CDATA[<h1 id="æ–‡ä»¶ç³»ç»Ÿsync"><a href="#æ–‡ä»¶ç³»ç»Ÿsync" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿsync"></a>æ–‡ä»¶ç³»ç»Ÿsync</h1><h2 id="1-syncç³»ç»Ÿè°ƒç”¨"><a href="#1-syncç³»ç»Ÿè°ƒç”¨" class="headerlink" title="1.syncç³»ç»Ÿè°ƒç”¨"></a>1.syncç³»ç»Ÿè°ƒç”¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE0(sync)<br>&#123;<br>ksys_sync();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">ksys_sync</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> nowait = <span class="hljs-number">0</span>, wait = <span class="hljs-number">1</span>;<br><br>wakeup_flusher_threads(WB_REASON_SYNC);<br>iterate_supers(sync_inodes_one_sb, <span class="hljs-literal">NULL</span>);<br>iterate_supers(sync_fs_one_sb, &amp;nowait);<br>iterate_supers(sync_fs_one_sb, &amp;wait);<br>iterate_bdevs(fdatawrite_one_bdev, <span class="hljs-literal">NULL</span>);<br>iterate_bdevs(fdatawait_one_bdev, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (unlikely(laptop_mode))<br>laptop_sync_completion();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-å”¤é†’åˆ·æ–°é˜Ÿåˆ—çº¿ç¨‹"><a href="#1-1-å”¤é†’åˆ·æ–°é˜Ÿåˆ—çº¿ç¨‹" class="headerlink" title="1.1 å”¤é†’åˆ·æ–°é˜Ÿåˆ—çº¿ç¨‹"></a>1.1 å”¤é†’åˆ·æ–°é˜Ÿåˆ—çº¿ç¨‹</h3><h3 id="1-2-åŒæ­¥ç³»ç»Ÿé‡æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿä¸‹é¢çš„æ–‡ä»¶"><a href="#1-2-åŒæ­¥ç³»ç»Ÿé‡æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿä¸‹é¢çš„æ–‡ä»¶" class="headerlink" title="1.2 åŒæ­¥ç³»ç»Ÿé‡æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿä¸‹é¢çš„æ–‡ä»¶"></a>1.2 åŒæ­¥ç³»ç»Ÿé‡æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿä¸‹é¢çš„æ–‡ä»¶</h3><h4 id="1-2-1-iterate-superséå†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—"><a href="#1-2-1-iterate-superséå†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—" class="headerlink" title="1.2.1 iterate_superséå†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—"></a>1.2.1 iterate_superséå†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">iterate_supers</span><span class="hljs-params">(<span class="hljs-type">void</span> (*f)(<span class="hljs-keyword">struct</span> super_block *, <span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span>, *<span class="hljs-title">p</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>list_for_each_entry(sb, &amp;super_blocks, s_list) &#123;<br><span class="hljs-keyword">if</span> (hlist_unhashed(&amp;sb-&gt;s_instances))<br><span class="hljs-keyword">continue</span>;<br>sb-&gt;s_count++;<br><span class="hljs-keyword">if</span> (sb-&gt;s_root &amp;&amp; (sb-&gt;s_flags &amp; SB_BORN))<br>f(sb, arg);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>list_for_each_entryéå†s_listï¼Œå¹¶ä¾æ¬¡è°ƒç”¨ä¼ è¿›æ¥çš„å‡½æ•°æŒ‡é’ˆï¼ˆsync_inodes_one_sbï¼Œsync_fs_one_sbç­‰ç­‰ï¼‰</p><ul><li>s_listæ˜¯super_blockä¸­çš„æˆå‘˜å˜é‡ï¼Œæ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—æ·»åŠ åˆ°å…¨å±€é“¾è¡¨s_listsä¸­</li></ul><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:75%;"><h4 id="1-2-2-sync-inodes-one-sb"><a href="#1-2-2-sync-inodes-one-sb" class="headerlink" title="1.2.2 sync_inodes_one_sb"></a>1.2.2 sync_inodes_one_sb</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sync_inodes_one_sb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *arg)</span><br>&#123;<br><span class="hljs-keyword">if</span> (!sb_rdonly(sb))<br>sync_inodes_sb(sb);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sync_inodes_sb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">backing_dev_info</span> *<span class="hljs-title">bdi</span> =</span> sb-&gt;s_bdi;<br>DEFINE_WB_COMPLETION(done, bdi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">wb_writeback_work</span> <span class="hljs-title">work</span> =</span> &#123;<br>.sb= sb,<br>.sync_mode= WB_SYNC_ALL,<br>.nr_pages= LONG_MAX,<br>.range_cyclic= <span class="hljs-number">0</span>,<br>.done= &amp;done,<br>.reason= WB_REASON_SYNC,<br>.for_sync= <span class="hljs-number">1</span>,<br>&#125;;<br><br><br>bdi_split_work_to_wbs(bdi, &amp;work, <span class="hljs-literal">false</span>);<br>wb_wait_for_completion(&amp;done);<br><br>wait_sb_inodes(sb);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">bdi_split_work_to_wbs</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> backing_dev_info *bdi,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> wb_writeback_work *base_work,</span><br><span class="hljs-params">  <span class="hljs-type">bool</span> skip_if_busy)</span><br>&#123;<br>might_sleep();<br><br><span class="hljs-keyword">if</span> (!skip_if_busy || !writeback_in_progress(&amp;bdi-&gt;wb)) &#123;<br>base_work-&gt;auto_free = <span class="hljs-number">0</span>;<br>wb_queue_work(&amp;bdi-&gt;wb, base_work);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªworkï¼Œæ’å…¥åˆ°bdiçš„å›å†™é˜Ÿåˆ—<strong>work_list</strong>ä¸­ï¼Œç­‰å¾…dworkçš„wb_workfnçº¿ç¨‹å°†å…¶åˆ·å†™åˆ°ç£ç›˜</p><h4 id="1-2-3"><a href="#1-2-3" class="headerlink" title="1.2.3"></a>1.2.3</h4><h4 id="fdatawrite-one-bdev"><a href="#fdatawrite-one-bdev" class="headerlink" title="fdatawrite_one_bdev"></a>fdatawrite_one_bdev</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">fdatawrite_one_bdev</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> block_device *bdev, <span class="hljs-type">void</span> *arg)</span><br>&#123;<br>filemap_fdatawrite(bdev-&gt;bd_inode-&gt;i_mapping);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">filemap_fdatawrite</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping)</span><br>&#123;<br><span class="hljs-keyword">return</span> __filemap_fdatawrite(mapping, WB_SYNC_ALL);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> __filemap_fdatawrite(<span class="hljs-keyword">struct</span> address_space *mapping,<br><span class="hljs-type">int</span> sync_mode)<br>&#123;<br><span class="hljs-keyword">return</span> __filemap_fdatawrite_range(mapping, <span class="hljs-number">0</span>, LLONG_MAX, sync_mode);<br>&#125;<br><br><span class="hljs-type">int</span> __filemap_fdatawrite_range(<span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-type">loff_t</span> start,<br><span class="hljs-type">loff_t</span> end, <span class="hljs-type">int</span> sync_mode)<br>&#123;<br><span class="hljs-type">int</span> ret;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">writeback_control</span> <span class="hljs-title">wbc</span> =</span> &#123;<br>.sync_mode = sync_mode,<br>.nr_to_write = LONG_MAX,<br>.range_start = start,<br>.range_end = end,<br>&#125;;<br><br>wbc_attach_fdatawrite_inode(&amp;wbc, mapping-&gt;host);<br>ret = do_writepages(mapping, &amp;wbc);<br>wbc_detach_inode(&amp;wbc);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨åˆ°äº†do_writepagesæ¥å£ã€å‚è€ƒï¼š<a href="https://anmuxixixi.github.io/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fdo-writepages%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">æ–‡ä»¶ç³»ç»Ÿdo_writepagesæµç¨‹åˆ†æ</a>ã€‘</p><h2 id="2-çŸ¥è¯†è¡¥å……"><a href="#2-çŸ¥è¯†è¡¥å……" class="headerlink" title="2.çŸ¥è¯†è¡¥å……"></a>2.çŸ¥è¯†è¡¥å……</h2><h3 id="2-1-bdiè„é¡µå›å†™æ¶‰åŠçš„æ•°æ®ç»“æ„ç®€ä»‹"><a href="#2-1-bdiè„é¡µå›å†™æ¶‰åŠçš„æ•°æ®ç»“æ„ç®€ä»‹" class="headerlink" title="2.1 bdiè„é¡µå›å†™æ¶‰åŠçš„æ•°æ®ç»“æ„ç®€ä»‹"></a>2.1 bdiè„é¡µå›å†™æ¶‰åŠçš„æ•°æ®ç»“æ„ç®€ä»‹</h3><blockquote><p>è½¬è½½è‡ªï¼š</p><ul><li><a href="https://blog.csdn.net/hu1610552336/article/details/115315770">https://blog.csdn.net/hu1610552336/article/details/115315770</a></li><li><a href="https://zhuanlan.zhihu.com/p/614053726">https://zhuanlan.zhihu.com/p/614053726</a></li></ul></blockquote><h4 id="2-1-1-backing-dev-info"><a href="#2-1-1-backing-dev-info" class="headerlink" title="2.1.1 backing_dev_info"></a>2.1.1 backing_dev_info</h4><p>æ¯ä¸ªå—è®¾å¤‡å¯¹åº”ä¸€ä¸ªè¯¥ç»“æ„ä½“struct block_device-&gt;bd_bdiï¼Œç”¨äºç®¡ç†è„é¡µä¿¡æ¯ï¼Œå›å†™ä»»åŠ¡ç­‰ã€‚</p><p>ğŸ†<strong>æ¯ä¸ªbacking_dev_infoéƒ½æŒ‚åœ¨bdi_listé“¾è¡¨ä¸‹é¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">backing_dev_info</span> &#123;</span><br><span class="hljs-comment">// ç®¡ç†æ‰€æœ‰çš„backing_dev_infoçš„é“¾è¡¨</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">bdi_list</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ra_pages;<span class="hljs-comment">/* max readahead in PAGE_SIZE units */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> io_pages;<span class="hljs-comment">/* max allowed IO size */</span><br>congested_fn *congested_fn; <span class="hljs-comment">/* Function pointer if device is md/dm */</span><br><span class="hljs-type">void</span> *congested_data;<span class="hljs-comment">/* Pointer to aux data for congested func */</span><br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span> <span class="hljs-title">refcnt</span>;</span><span class="hljs-comment">/* Reference counter for the structure */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> capabilities; <span class="hljs-comment">/* Device capabilities */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_ratio;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_ratio, max_prop_frac;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Sum of avg_write_bw of wbs with dirty inodes.  &gt; 0 if there are</span><br><span class="hljs-comment"> * any dirty wbs, which is depended upon by bdi_has_dirty().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">atomic_long_t</span> tot_write_bandwidth;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bdi_writeback</span> <span class="hljs-title">wb</span>;</span>  <span class="hljs-comment">/* the root writeback info for this bdi */</span><br><span class="hljs-comment">// ç®¡ç†bdi_writebackæˆå‘˜</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">wb_list</span>;</span> <span class="hljs-comment">/* list of all wbs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span> <span class="hljs-title">cgwb_tree</span>;</span> <span class="hljs-comment">/* radix tree of active cgroup wbs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">cgwb_congested_tree</span>;</span> <span class="hljs-comment">/* their congested states */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">cgwb_release_mutex</span>;</span>  <span class="hljs-comment">/* protect shutdown of wb structs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bdi_writeback_congested</span> *<span class="hljs-title">wb_congested</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">wait_queue_head_t</span> wb_waitq;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">owner</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_list</span> <span class="hljs-title">laptop_mode_wb_timer</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_FS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *<span class="hljs-title">debug_dir</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *<span class="hljs-title">debug_stats</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªå—è®¾å¤‡åœ¨é©±åŠ¨åˆå§‹åŒ–æ—¶ä¼šåˆ†é…ä¸€ä¸ªå—è®¾å¤‡ä¸“å±çš„è¿è¡Œé˜Ÿåˆ—struct request_queueï¼Œ<strong>request_queueæœ‰ä¸€ä¸ªæˆå‘˜struct backing_dev_info</strong> ï¼Œè¿™å°±æ˜¯ä¼ è¯´ä¸­çš„bdiæ•°æ®ç»“æ„ï¼Œæ˜¯è„é¡µå›å†™æ¯ä½“å§ã€‚è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œ<strong>æ¯ä¸ªå—è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„struct backing_dev_infoç»“æ„</strong>ã€‚</p><p>struct backing_dev_infoçš„æˆå‘˜struct bdi_writebackåœ¨å®é™…è„é¡µå›å†™ä»£ç ä¸­å‡ºç°é¢‘ç‡è¾ƒé«˜ï¼Œå®ƒçš„æˆå‘˜éƒ½æŒºå…³é”®çš„ï¼Œè¿™é‡Œå…ˆåªä»‹ç»struct delayed_work dworkï¼Œè¿™ä¸è„é¡µå›å†™è¿›ç¨‹æœ‰å…³ã€‚æ¯ä¸ªå—è®¾å¤‡çš„è„é¡µå›å†™å°±æ˜¯é struct delayed_work dworkæ’å…¥åˆ°bdiè„é¡µå›å†™é˜Ÿåˆ—ï¼Œç„¶åè„é¡µå›å†™è¿›ç¨‹å†ä»è¿™ä¸ªé˜Ÿåˆ—å–å‡ºdworkï¼Œé¡ºè—¤æ‘¸ç“œæ‰¾åˆ°å—è®¾å¤‡çš„struct backing_dev_infoï¼Œç„¶åæ‰èƒ½è¿›è¡Œå®é™…çš„è„é¡µå›å†™ã€‚</p><h4 id="2-1-2-wb-writeback-work"><a href="#2-1-2-wb-writeback-work" class="headerlink" title="2.1.2 wb_writeback_work"></a>2.1.2 wb_writeback_work</h4><p>ç”¨äºå›å†™ä»»åŠ¡æè¿°ï¼Œä¸€æ¬¡å›å†™è¯·æ±‚å°±åˆ›å»ºä¸€ä¸ªwb_writeback_work</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Passed into wb_writeback(), essentially a subset of writeback_control</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">wb_writeback_work</span> &#123;</span><br><span class="hljs-comment">// æœ¬æ¬¡å›å†™çš„é¡µæ•°é™åˆ¶</span><br><span class="hljs-type">long</span> nr_pages;<br><span class="hljs-comment">// å›å†™çš„æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span>;</span><br><span class="hljs-comment">// å›å†™çš„æ¨¡å¼</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">writeback_sync_modes</span> <span class="hljs-title">sync_mode</span>;</span><br><span class="hljs-comment">// tag-and-write æœºåˆ¶æ ‡è®°</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tagged_writepages:<span class="hljs-number">1</span>;<br><span class="hljs-comment">// å®šæœŸå›å†™æ ‡è®°</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> for_kupdate:<span class="hljs-number">1</span>;<br><span class="hljs-comment">// ç»§ç»­ä¸Šæ¬¡å¾ªç¯å›å†™æ ‡è®°</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> range_cyclic:<span class="hljs-number">1</span>;<br><span class="hljs-comment">// é˜ˆå€¼å›å†™æ ‡è®°</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> for_background:<span class="hljs-number">1</span>;<br><span class="hljs-comment">// sync ç³»ç»Ÿè°ƒç”¨æ ‡è®°</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> for_sync:<span class="hljs-number">1</span>;<span class="hljs-comment">/* sync(2) WB_SYNC_ALL writeback */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> auto_free:<span class="hljs-number">1</span>;<span class="hljs-comment">/* free on completion */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">wb_reason</span> <span class="hljs-title">reason</span>;</span><span class="hljs-comment">/* why was writeback initiated? */</span><br> <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><span class="hljs-comment">/* pending work list */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">wb_completion</span> *<span class="hljs-title">done</span>;</span><span class="hljs-comment">/* set if the caller waits */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åç»­é€šè¿‡ <code>include/linux/writeback.h</code> ä¸­çš„ <code>writeback_control</code> ç»“æ„ä½“å°è£…ï¼Œä¼ é€’ç»™åº•å±‚çš„ <code>writepages</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * A control structure which tells the writeback code what to do.  These are</span><br><span class="hljs-comment"> * always on the stack, and hence need no locking.  They are always initialised</span><br><span class="hljs-comment"> * in a manner such that unspecified fields are set to zero.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">writeback_control</span> &#123;</span><br><span class="hljs-type">long</span> nr_to_write;<span class="hljs-comment">/* Write this many pages, and decrement</span><br><span class="hljs-comment">   this for each page written */</span><br><span class="hljs-type">long</span> pages_skipped;<span class="hljs-comment">/* Pages which were not written */</span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For a_ops-&gt;writepages(): if start or end are non-zero then this is</span><br><span class="hljs-comment"> * a hint that the filesystem need only write out the pages inside that</span><br><span class="hljs-comment"> * byterange.  The byte at `end&#x27; is included in the writeout request.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">loff_t</span> range_start;<br><span class="hljs-type">loff_t</span> range_end;<br> <br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">writeback_sync_modes</span> <span class="hljs-title">sync_mode</span>;</span><br> <br><span class="hljs-type">unsigned</span> for_kupdate:<span class="hljs-number">1</span>;<span class="hljs-comment">/* A kupdate writeback */</span><br><span class="hljs-type">unsigned</span> for_background:<span class="hljs-number">1</span>;<span class="hljs-comment">/* A background writeback */</span><br><span class="hljs-type">unsigned</span> tagged_writepages:<span class="hljs-number">1</span>;<span class="hljs-comment">/* tag-and-write to avoid livelock */</span><br><span class="hljs-type">unsigned</span> for_reclaim:<span class="hljs-number">1</span>;<span class="hljs-comment">/* Invoked from the page allocator */</span><br><span class="hljs-type">unsigned</span> range_cyclic:<span class="hljs-number">1</span>;<span class="hljs-comment">/* range_start is cyclic */</span><br><span class="hljs-type">unsigned</span> for_sync:<span class="hljs-number">1</span>;<span class="hljs-comment">/* sync(2) WB_SYNC_ALL writeback */</span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When writeback IOs are bounced through async layers, only the</span><br><span class="hljs-comment"> * initial synchronous phase should be accounted towards inode</span><br><span class="hljs-comment"> * cgroup ownership arbitration to avoid confusion.  Later stages</span><br><span class="hljs-comment"> * can set the following flag to disable the accounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> no_cgroup_owner:<span class="hljs-number">1</span>;<br> <br><span class="hljs-type">unsigned</span> punt_to_cgroup:<span class="hljs-number">1</span>;<span class="hljs-comment">/* cgrp punting, see __REQ_CGROUP_PUNT */</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bdi_writeback</span> *<span class="hljs-title">wb</span>;</span><span class="hljs-comment">/* wb this writeback is issued under */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>;</span><span class="hljs-comment">/* inode being written out */</span><br> <br><span class="hljs-comment">/* foreign inode detection, see wbc_detach_inode() */</span><br><span class="hljs-type">int</span> wb_id;<span class="hljs-comment">/* current wb id */</span><br><span class="hljs-type">int</span> wb_lcand_id;<span class="hljs-comment">/* last foreign candidate wb id */</span><br><span class="hljs-type">int</span> wb_tcand_id;<span class="hljs-comment">/* this foreign candidate wb id */</span><br><span class="hljs-type">size_t</span> wb_bytes;<span class="hljs-comment">/* bytes written by current wb */</span><br><span class="hljs-type">size_t</span> wb_lcand_bytes;<span class="hljs-comment">/* bytes written by last candidate */</span><br><span class="hljs-type">size_t</span> wb_tcand_bytes;<span class="hljs-comment">/* bytes written by this candidate */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="2-1-3-bdi-writeback"><a href="#2-1-3-bdi-writeback" class="headerlink" title="2.1.3 bdi_writeback"></a>2.1.3 bdi_writeback</h4><p>ä¸»è¦ç”¨äºè®°å½•æœ¬å—è®¾å¤‡ä¸Šéœ€è¦å›å†™çš„è„é¡µï¼ŒåŒæ—¶è®¾ç½®å›å†™workã€‚æ¯æ¬¡æœ‰ä¸ªå›å†™ä»»åŠ¡å°±åˆ›å»ºä¸€ä¸ªwb_writeback_workï¼Œç®¡ç†åœ¨work_listé“¾è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bdi_writeback</span> &#123;</span><br>...<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">b_dirty</span>;</span>   <span class="hljs-comment">/* dirty inodes */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">b_io</span>;</span>      <span class="hljs-comment">/* parked for writeback */</span><br>...<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">delayed_work</span> <span class="hljs-title">dwork</span>;</span>  <span class="hljs-comment">/* work item used for writeback */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">work_list</span>;</span><br>...<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>b_dirtyï¼šç”¨æ¥å­˜æ”¾æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰çš„è„é¡µ</p></li><li><p>b_ioï¼šç”¨æ¥å­˜æ”¾å‡†å¤‡å†™å›åˆ°å­˜å‚¨è®¾å¤‡çš„<code>inode</code></p></li><li><p>dworkï¼šè´Ÿè´£æŠŠè„é¡µå†™å›åˆ°å­˜å‚¨è®¾å¤‡ã€‚ å¯¹åº”çš„å‡½æ•°æ˜¯<code>wb_workfn</code></p></li><li><p>work_listï¼šæ¯ä¸€ä¸ªå›å†™ä»»åŠ¡ä¸ºä¸€ä¸ªwork, ä¼šè¢«é“¾æ¥åˆ°è¿™ä¸ªé“¾è¡¨ä¸Šæ¥</p></li></ul><h4 id="2-1-4-å„ç»“æ„ä½“çš„å…³ç³»"><a href="#2-1-4-å„ç»“æ„ä½“çš„å…³ç³»" class="headerlink" title="2.1.4 å„ç»“æ„ä½“çš„å…³ç³»"></a>2.1.4 å„ç»“æ„ä½“çš„å…³ç³»</h4><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1N3ZWVOZWls,size_16,color_FFFFFF,t_70.jpeg" alt="img"><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:75%;"><ul><li><p><strong>ä¸€ä¸ªå—è®¾å¤‡</strong>å¯¹åº”å”¯ä¸€çš„ä¸€ä¸ªrequest_queueï¼Œä¸€ä¸ªrequest_queueåˆå¯¹åº”äº†ä¸€ä¸ªbacking_dev_info</p><ul><li><strong>æ‰€æœ‰å—è®¾å¤‡</strong>çš„backing_dev_infoé€šè¿‡å…¨å±€é“¾è¡¨bdi_listè¿›è¡Œç®¡ç†</li></ul></li><li><p>bdiå›å†™é˜Ÿåˆ—work_listï¼Œæ¯ä¸€ä¸ªå›å†™ä»»åŠ¡ä¸º<strong>wb_writeback_work</strong>ï¼ˆé€šå¸¸è¯´çš„ä¸€ä¸ªworkï¼‰ï¼Œé€šè¿‡é“¾è¡¨<strong>work_list</strong>ç®¡ç†</p></li><li><p>bdi_writebackå¯¹åº”äº†æœ¬å—è®¾å¤‡çš„å›å†™ä¿¡æ¯ï¼Œå®ƒæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ä¸ºdworkï¼Œå°†è¦å›å†™çš„è„é¡µæ·»åŠ åˆ°è„é¡µé“¾è¡¨work_listä¸­</p><ul><li>è„é¡µå›å†™çº¿ç¨‹ä¼šä»è„é¡µå›å†™é˜Ÿåˆ—work_listä¸­å–å‡ºdworkï¼Œç„¶åè°ƒç”¨å…¶è„é¡µå›å†™å‡½æ•°wb_workfnè¿›è¡Œè„é¡µå›å†™</li></ul></li><li><p>å¯å‚é˜…ï¼š<a href="https://blog.csdn.net/bin_linux96/article/details/121612699">https://blog.csdn.net/bin_linux96/article/details/121612699</a></p></li></ul><h3 id="2-2-bdiå›å†™æœºåˆ¶"><a href="#2-2-bdiå›å†™æœºåˆ¶" class="headerlink" title="2.2 bdiå›å†™æœºåˆ¶"></a>2.2 bdiå›å†™æœºåˆ¶</h3><p>bdi_writebackä¸­çš„æˆå‘˜å˜é‡dworkåœ¨åˆå§‹åŒ–å‡½æ•°<strong>wb_init</strong>æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶å™¨å’Œåˆ°æ—¶å¤„ç†å‡½æ•°<strong>wb_workfn</strong>ã€ä¹Ÿå°±æ˜¯è¯´æ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šåšä¸€æ¬¡bdiè„é¡µå›å†™ã€‘</p><p>wb_workfnä¸­ä¼šæ‰§è¡Œwb_do_writebackå›å†™è„é¡µï¼Œæœ€ç»ˆä¼šè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£<strong>do_writepages</strong></p><blockquote><p>å›¾ç‰‡æºè‡ªï¼š<a href="https://blog.csdn.net/bin_linux96/article/details/121612699">https://blog.csdn.net/bin_linux96/article/details/121612699</a></p></blockquote><img src="/2023/10/15/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fsync/a41f4a8da8c6b63a196491db581da635.png" alt="a41f4a8da8c6b63a196491db581da635.png" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>USBæ¥å£ä¸åè®®</title>
    <link href="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/"/>
    <url>/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="USBæ¥å£ä¸åè®®"><a href="#USBæ¥å£ä¸åè®®" class="headerlink" title="USBæ¥å£ä¸åè®®"></a>USBæ¥å£ä¸åè®®</h1><h2 id="1-USBä¼ è¾“åè®®"><a href="#1-USBä¼ è¾“åè®®" class="headerlink" title="1.USBä¼ è¾“åè®®"></a>1.USBä¼ è¾“åè®®</h2><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://post.smzdm.com/p/aqmdp2q2/">https://post.smzdm.com/p/aqmdp2q2/</a></p></blockquote><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/648dd0a361dac9878.png_e1080.jpg" alt="ä¸€æ–‡å¸¦ä½ çœ‹æ‡‚æ‰€æœ‰USBæ¥å£ç±»å‹ï¼ŒMicro-USBå’ŒUSB-Cå‚»å‚»åˆ†ä¸æ¸…ï¼Ÿ" style="zoom:80%;"><p>USB 3.0ç³»åˆ—ç»å†è¿‡ä¸¤æ¬¡é‡å‘½åï¼Œè®°ç€Genåé¢æ•°å­—è¶Šå¤§ï¼Œç‰ˆæœ¬è¶Šæ–°å°±å¯ä»¥äº†ã€‚ä½†åŒæ—¶ä½ ä¹Ÿè¦æé˜²åˆ«äººç”¨USB 3.2æ¥å¿½æ‚ ä½ ï¼š</p><p>æŠŠUSB 3.0è¯´æˆUSB 3.2 Gen1ï¼Œç¬¬ä¸€ååº”å¥½åƒæ˜¯3.2 Gen1è¦ç‰›ä¸€ç‚¹ï¼Œå…¶å®å°±æ˜¯ä¸€ç§ä¸œè¥¿ä¸åŒå«æ³•ã€‚</p><p>æŒ‰å¤§ç±»æ¥è¯´ï¼Œç›®å‰USBçš„ä¼ è¾“åè®®åˆ†ä¸ºUSB 2.0ã€USB 3.2ã€USB4ä¸‰å¤§ç±»ã€‚</p><ul><li>USB 1.0é€Ÿç‡å¤ªæ…¢ï¼Œæ—©å·²è¢«æ·˜æ±°</li><li>USB 2.0å¤„äºè¢«æ·˜æ±°çš„è¾¹ç¼˜ï¼Œéœ€æ³¨æ„çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰USB 2.0çš„ä¼ è¾“é€Ÿåº¦éƒ½æ˜¯480Mbpsï¼ŒUSB 2.0åˆåˆ†ä¸ºä½é€Ÿã€å…¨é€Ÿå’Œé«˜é€Ÿç‰ˆï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">ä½é€Ÿç‰ˆ1.5Mbpsï¼ˆå³1.5MB/8=192KB/sï¼‰<br>å…¨é€Ÿç‰ˆ12Mbpsï¼ˆå³12MB/8=1.5MB/sï¼‰<br>é«˜é€Ÿç‰ˆ480Mbpsï¼ˆå³480MB/8=60MB/s<br></code></pre></td></tr></table></figure><ul><li>ç±»ä¼¼ï¼ŒUSB 3.0ä¹Ÿæ‹¥æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯3.2 Gen1ã€3.2 Gen2Ã—1ã€3.2 Gen2Ã—2ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">USB3.2 Gen1 5Gbpsï¼ˆå³5GB/8=640MB/sï¼‰<br>USB3.2 Gen2Ã—1 10Gbpsï¼ˆå³10GB/8=1280MB/sï¼‰<br>USB3.2 Gen2Ã—2 20Gbpsï¼ˆå³20GB/8=2560MB/sï¼‰<br></code></pre></td></tr></table></figure><p>è¿™ä¸ç¦è®©äººæƒ³åˆ°é«˜é€šéªé¾™8 Gen1ã€8+ Gen1ã€8 Gen2è¿™äº›æ‹—å£çš„å‘½åã€‚</p><p>USB4ç›¸å½“äºUSB3.2+é›·ç”µ3çš„ç»„åˆï¼Œä¹Ÿå°±æ˜¯è¯´ä½ çš„è®¾å¤‡ä¸Šæœ‰USB4æ¥å£ï¼Œç†è®ºä¸Šå°±èƒ½å¤–æ¥é›·ç”µ3çš„è®¾å¤‡ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œæœ€æ–°çš„USB4ä»…æ”¯æŒType-Cï¼Œä¸”å‘½åéå¸¸äººæ€§åŒ–ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œç›´æ¥é‡‡ç”¨ä¼ è¾“é€Ÿç‡å¤§å°çš„æ–¹å¼å‘½åï¼Œè¿™æ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šåšåˆ°äº†ç»Ÿä¸€ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">USB4 20Gbpsï¼ˆå³20GB/8=2560MB/sï¼‰<br>USB4 40Gbpsï¼ˆå³40GB/8=5120MB/sï¼‰<br></code></pre></td></tr></table></figure><h2 id="2-é›·ç”µåè®®"><a href="#2-é›·ç”µåè®®" class="headerlink" title="2.é›·ç”µåè®®"></a>2.é›·ç”µåè®®</h2><blockquote><p>æ¨èè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV12R4y1C7Ec">https://www.bilibili.com/video/BV12R4y1C7Ec</a></p></blockquote><p>æˆ‘ä»¬å¸¸è¯´çš„é›·ç”µæ¥å£ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ä¼ è¾“åè®®ï¼Œå…¨ç¨‹è‹±æ–‡åå«åšThunderboltã€‚</p><p>ThunderboltæŠ€æœ¯èåˆPCI Expresså’ŒDisplayPortä¸¤ç§é€šä¿¡åè®®ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">PCI Expressç”¨äºæ•°æ®ä¼ è¾“ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„è¿›è¡Œä»»ä½•ç±»å‹è®¾å¤‡æ‰©å±•ã€‚<br><br>DisplayPortç”¨äºæ˜¾ç¤ºï¼Œèƒ½åŒæ­¥ä¼ è¾“1080pä¹ƒè‡³è¶…é«˜æ¸…è§†é¢‘å’Œæœ€å¤šå…«å£°é“éŸ³é¢‘ï¼Œå¹¶ä¸”ä¸¤æ¡é€šé“åœ¨ä¼ è¾“æ—¶éƒ½æœ‰è‡ªå·±å•ç‹¬çš„é€šé“ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•å¹²æ‰°ã€‚<br></code></pre></td></tr></table></figure><p>æ—©æœŸçš„é›·ç”µæ¥å£å¤–è§‚å’ŒåŸæœ‰Mini DisplayPortæ¥å£ç›¸åŒï¼ŒMini DPæ¥å£çš„æ˜¾ç¤ºå™¨ä»¥åŠMini DPè‡³HDMI&#x2F;DVI&#x2F;VGAç­‰æ¥å£çš„è½¬æ¥å¤´éƒ½å¯åœ¨é›·ç”µæ¥å£ä¸Šä½¿ç”¨ï¼Œè¿™ç§é›·ç”µæ¥å£åœ¨æ—©æœŸçš„Macä¸Šä½¿ç”¨ã€‚</p><p>è€Œé›·ç”µ3é‡‡ç”¨äº†é€šç”¨åº¦æ›´é«˜çš„Type-Cç‰©ç†æ¥å£ï¼Œæ‰€ä»¥æ›´å¹¿ä¸ºäººçŸ¥ã€‚ä½†å› ä¸ºæ”¯æŒé›·ç”µ3æ¥å£çš„è®¾å¤‡ä»·æ ¼éƒ½éå¸¸æ˜‚è´µï¼Œæ‰€ä»¥é›·ç”µ3å¹¶æ²¡æœ‰å¾—åˆ°æ™®åŠã€‚ç›´åˆ°è‹±ç‰¹å°”å®£å¸ƒå‘USBå¼€æ”¾é›·ç”µåè®®ï¼Œäºæ˜¯USB4çš„å‡ºç°å¸¦åŠ¨äº†é›·ç”µ3çš„æ™®åŠã€‚</p><p>é›·ç”µ4åˆ™æ˜¯ç›¸è¾ƒäºé›·ç”µ3æ›´å¼ºçš„æ¥å£åè®®ï¼Œé›·ç”µ4åè®®å¹¶æ²¡æœ‰å¼€æ”¾ï¼Œè¿™æ˜¯è‹±ç‰¹å°”ç•™çš„åº•ç‰Œã€‚é›·ç”µ4æ˜¯ç›®å‰åŠŸèƒ½æœ€å…¨çš„åè®®ï¼Œæ— è®ºæ˜¯ä¼ è¾“é€Ÿåº¦ã€è§†é¢‘æ‹“å±•è¿˜æ˜¯å……ç”µéƒ½æ˜¯é¡¶çº§çš„æ¥å£åè®®ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/648dd113403376764.png_e1080.jpg" alt="ä¸€æ–‡å¸¦ä½ çœ‹æ‡‚æ‰€æœ‰USBæ¥å£ç±»å‹ï¼ŒMicro-USBå’ŒUSB-Cå‚»å‚»åˆ†ä¸æ¸…ï¼Ÿ" style="zoom:80%;"><h2 id="3-USBæ¥å£"><a href="#3-USBæ¥å£" class="headerlink" title="3.USBæ¥å£"></a>3.USBæ¥å£</h2><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.sohu.com/a/513786088_121117077">https://www.sohu.com/a/513786088_121117077</a></p></blockquote><p><strong>1ã€USB Type-A</strong></p><p>USB Type-Aè¿™ç§æ¥å£æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ¥å£ï¼Œæ¯”å¦‚ç”µè„‘ã€é¼ æ ‡ã€é”®ç›˜ã€Uç›˜ç­‰ç­‰ï¼Œå…¶å¤–éƒ¨æ¥å£å‡é‡‡ç”¨è¿™ç§æ¥å£ã€‚ç›®å‰ï¼Œè¿™ç§æ¥å£å·²ç»ç”±USB 2.0å‘å±•åˆ°äº†USB 3.0ï¼Œä¼ è¾“é€Ÿç‡æ˜¯åŸæ¥çš„10å€ã€‚<strong>USB 3.0ä¸USB 2.0æœ€å¤§çš„å·®åˆ«å°±æ˜¯3.0çš„æ¥å£éƒ¨åˆ†ä¸ºè“è‰²ï¼Œè€Œ2.0çš„æ¥å£éƒ¨åˆ†ä¸ºé»‘è‰²ã€‚</strong></p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/4d2597090d6c45a39b10b818c5486666.jpeg" alt="img" style="zoom: 33%;"><p><strong>2ã€USB Type-B</strong></p><p>å¹³æ—¶ï¼Œè¿™ç§ç±»å‹çš„æ¥å£å¹¶ä¸æ˜¯å¾ˆå¸¸è§ï¼Œå› ä¸ºå®ƒä¸»è¦ç”¨äº<strong>å¤§å‹è®¾å¤‡</strong>å’Œ<strong>ä¸“ä¸šé¢†åŸŸ</strong>ã€‚æ¯”å¦‚æ‰“å°æœºã€ç§»åŠ¨ç¡¬ç›˜ã€æ‰«æä»ªã€æ˜¾ç¤ºå™¨ã€å¤§å‹çš„è¿æ¥å™¨ã€æ¸¸æˆç¡¬ä»¶æ¥å£ï¼›ä¸“ä¸šé¢†åŸŸçš„æœ‰å•ç‰‡æœºçš„è°ƒè¯•å·¥å…·Jlinkã€å®¤å†…å¤–çš„ç”µç¼†å¸ƒçº¿ç­‰ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/0dfdab3218944e388dbac45d4e25251d.jpeg" alt="img" style="zoom:33%;"><p><strong>3ã€USB Type-C</strong></p><p>Type-Cçš„æ¥å£æ˜¯ä¸€ç§å…¨æ–°çš„USBæ¥å£ä¸å½¢å¼ï¼Œåœ¨å›½äº§çš„Androidæ‰‹æœºä¸­è¾ƒä¸ºå¸¸ç”¨ã€‚è¿™ç§æ¥å£æ˜¯USB-IFäº2014å¹´8æœˆä»½å‘å¸ƒã€‚çœŸæ­£è§£å†³äº†å…¶ä»–ç±»å‹USBæ¥å£æœ‰50%å‡ ç‡æ’ä¸å‡†çš„é—®é¢˜ï¼Œå¯ä»¥å®ç°ä¸åˆ†æ­£åé¢ä½¿ç”¨ï¼Œç”¨æˆ·å¯ä»¥éšæ„æ’ã€‚é™¤æ­¤ä¹‹å¤–è¿™ç§æ¥å£æ”¯æŒæœ€æ–°çš„USB 3.1ä»¥åŠ100Wçš„ä¾›ç”µåŠŸç‡ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/b3af0d5c5a004fffb9aea237b3af9d4b.jpeg" alt="img" style="zoom:33%;"><p><strong>4ã€mini USB</strong></p><p>mini USBåœ¨å¸‚åœºçš„å­˜æ´»æ—¶é—´è¾ƒçŸ­ï¼Œå¯ä»¥åˆ†ä¸ºAå‹ã€Bå‹ã€ABå‹ç­‰ã€‚æ—©æœŸçš„è¯»å¡å™¨ã€æ•°ç ç›¸æœºã€ç§»åŠ¨ç¡¬ç›˜ã€MP3ã€MP4ç­‰ç”µå­äº§å“ä¼šé‡‡ç”¨è¿™ç§æ¥å£ã€‚ç°åœ¨ï¼Œå·²ç»å¾ˆå°‘èƒ½çœ‹åˆ°å®ƒçš„å­˜åœ¨äº†ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/ff76bd96b1d64dc189f6ea37686de78d.jpeg" alt="img" style="zoom:33%;"><p><strong>5ã€micro USB</strong></p><p>åœ¨USB Type-Cæ²¡æœ‰å¤§é‡æ™®åŠä¹‹å‰ï¼Œè¿™ç§æ¥å£çš„USBåŸºæœ¬ä¸Šæ˜¯å›½äº§æ‰‹æœºçš„æ ‡é…ï¼Œæ˜¯å…¶å……ç”µå’Œæ•°æ®ä¼ è¾“æ¥å£ã€‚è¿™ç§æ¥å£ç”±USB-IF(Implementers Forum)äº2007å¹´åˆ¶å®šï¼Œå†…éƒ¨ä¸º5é’ˆæ¥å£ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/u=834000812,3609546457&fm=253&fmt=auto&app=138&f=JPEG.jpeg" alt="img" style="zoom:67%;"><p><strong>6ã€Lightning</strong></p><p>ä¸¥æ ¼æ„ä¹‰è¿™ç§æ¥å£ä¸å±äºUSBä¸­ä¸€ç§ã€‚è¿™ç§æ¥å£æ˜¯<strong>2012</strong>å¹´è‹¹æœå…¬å¸åœ¨å‘å¸ƒ<strong>iPhone 5</strong>çš„æ—¶å€™æ¨å‡ºçš„ã€‚è¿™ç§æ¥å£ä¸USB Type-Cç±»ä¼¼æ²¡æœ‰æ­£åçš„åŒºåˆ†ï¼Œä½¿ç”¨èµ·æ¥éå¸¸çš„æ–¹ä¾¿ã€‚è¿™æ¥å£çš„ä¼ è¾“é€Ÿåº¦ä»…ä»…ä¸<strong>USB 2.0</strong>ä¸€æ ·çº¦ä¸º<strong>25MB&#x2F;s~35MB&#x2F;s</strong>ã€‚å¯èƒ½ç”±äºä¿æŠ¤è‹¹æœä¾›åº”å•†çš„åŸå› ï¼Œè‹¹æœå…¬å¸è¿Ÿè¿Ÿä¸è¿›è¡Œç¡¬ä»¶å‡çº§ã€‚</p><img src="/2023/10/09/USB%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%8D%8F%E8%AE%AE/f032b92647454be5adfbb858a324d5c9.jpeg" alt="img" style="zoom: 33%;">]]></content>
    
    
    <categories>
      
      <category>USBå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>USB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»ŸCURSEGå¤‡å¿˜</title>
    <link href="/2023/10/08/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FCURSEG%E5%A4%87%E5%BF%98/"/>
    <url>/2023/10/08/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FCURSEG%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»ŸCURSEGå¤‡å¿˜"><a href="#f2fsæ–‡ä»¶ç³»ç»ŸCURSEGå¤‡å¿˜" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»ŸCURSEGå¤‡å¿˜"></a>f2fsæ–‡ä»¶ç³»ç»ŸCURSEGå¤‡å¿˜</h1><blockquote><p>å†…å®¹å‡æ¥è‡ªäºä½œè€…<a href="https://blog.csdn.net/u011649400">HuberyPan</a></p><p>ğŸ®å›¾æ ‡çš„åœ°æ–¹ä»”ç»†é˜…è¯»ä¸€ä¸‹ï¼</p></blockquote><h2 id="1-f2fs-summaryçš„ä½œç”¨"><a href="#1-f2fs-summaryçš„ä½œç”¨" class="headerlink" title="1.f2fs_summaryçš„ä½œç”¨"></a>1.f2fs_summaryçš„ä½œç”¨</h2><p>æœ‰ä¸€äº›åœºåˆï¼Œéœ€è¦é€šè¿‡dataçš„ç‰©ç†åœ°å€æ‰¾åˆ°ä¿å­˜è¿™ä¸ªåœ°å€çš„nodeçš„ä¿¡æ¯ã€‚ä¾‹å¦‚GCçš„æ—¶å€™ï¼ŒF2FSä¼šæ‰¾åˆ°ä¸€ä¸ªsegmentè¿›è¡ŒGCï¼Œå°†æ•°æ®å—è¿ç§»åˆ°æ–°çš„segmentä¸­ã€‚æ­¤æ—¶ç³»ç»Ÿè¦æ ¹æ®segmenté‡Œé¢çš„blockçš„ç‰©ç†åœ°å€ï¼Œåè¿‡æ¥æ‰¾åˆ°nodeçš„ä¿¡æ¯ï¼Œç„¶åå°†æ–°çš„æ•°æ®å—ç‰©ç†åœ°å€é‡æ–°æ›´æ–°çš„nodeçš„å¯¹åº”ä½ç½®ã€‚</p><p>å› æ­¤SSAçš„<strong>ä¸»è¦</strong>ä½œç”¨æ˜¯<strong>æä¾›ç³»ç»Ÿé€šè¿‡æ•°æ®å—ç‰©ç†åœ°å€æ‰¾åˆ°æ‰€å±çš„nodeçš„ä¿¡æ¯çš„èƒ½åŠ›</strong>ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ†æ<code>f2fs_summary</code>çš„æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> &#123;</span><br>__le32 nid;<span class="hljs-comment">/* parent node id */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u8 reserved[<span class="hljs-number">3</span>];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u8 version;<span class="hljs-comment">/* node version number */</span><br>__le16 ofs_in_node;<span class="hljs-comment">/* block index in parent node */</span><br>&#125; __packed;<br>&#125;;<br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿä¸­æ¯ä¸€ä¸ª<strong>æ•°æ®å—</strong>çš„ç‰©ç†åœ°å€ï¼Œéƒ½å¯¹åº”äº†ä¸€ä¸ªf2fs_summaryï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡ç‰©ç†åœ°å€æ‰¾åˆ°å¯¹åº”çš„f2fs_summaryã€‚f2fs_summaryçš„nidå˜é‡è¡¨ç¤ºå½“å‰çš„æ•°æ®å—æ‰€å±çš„nodeçš„nidã€‚è€Œofs_in_nodeåˆ™è¡¨ç¤ºå½“å‰çš„æ•°æ®å—ä½äºè¿™ä¸ªnodeçš„ç¬¬å‡ ä¸ªblockï¼Œå³**f2fs_inode-&gt;i_addr[ofs_in_node]**æˆ–è€…direct_node-&gt;addr[ofs_in_node]ã€‚</p><h2 id="2-Checkpointåœ¨å…ƒæ•°æ®åŒºåŸŸçš„ç‰©ç†ç»“æ„"><a href="#2-Checkpointåœ¨å…ƒæ•°æ®åŒºåŸŸçš„ç‰©ç†ç»“æ„" class="headerlink" title="2.Checkpointåœ¨å…ƒæ•°æ®åŒºåŸŸçš„ç‰©ç†ç»“æ„"></a>2.Checkpointåœ¨å…ƒæ•°æ®åŒºåŸŸçš„ç‰©ç†ç»“æ„</h2><img src="/2023/10/08/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FCURSEG%E5%A4%87%E5%BF%98/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>æ ¹æ®ä¸Šè¿°çš„ç»“æ„å›¾ï¼ŒCheckpointåŒºåŸŸç”±å‡ ä¸ªéƒ¨åˆ†æ„æˆï¼Œåˆ†åˆ«æ˜¯checkpointå…ƒæ•°æ®åŒºåŸŸ(f2fs_checkpoint)ã€orphan nodeåŒºåŸŸã€active segmentsåŒºåŸŸã€‚åŒæ—¶active segmentsåŒºåŸŸåœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰ä¸åŒçš„å½¢å¼ï¼Œç›®çš„æ˜¯å‡å°‘IOçš„å†™å…¥ã€‚æ¥ä¸‹æ¥åˆ†åˆ«è®¨è®ºCheckpointä¸åŒçš„éƒ¨åˆ†ã€‚</p><h3 id="2-1-Checkpointå…ƒæ•°æ®åŒºåŸŸ"><a href="#2-1-Checkpointå…ƒæ•°æ®åŒºåŸŸ" class="headerlink" title="2.1 Checkpointå…ƒæ•°æ®åŒºåŸŸ"></a>2.1 Checkpointå…ƒæ•°æ®åŒºåŸŸ</h3><p>F2FSä½¿ç”¨æ•°æ®ç»“æ„f2fs_checkpointè¡¨ç¤ºCheckpointç»“æ„ï¼Œå®ƒä¿å­˜åœ¨ç£ç›˜ä¸­f2fs_super_blockä¹‹ååŒºåŸŸä¸­ï¼Œæ•°æ®ç»“æ„å¦‚ä¸‹ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯<strong>cur_node_segno</strong>ã€<strong>cur_node_blkoff</strong>ã€<strong>cur_data_segno</strong>ã€<strong>cur_data_blkoff</strong>è¿™å‡ ä¸ªå˜é‡ã€‚F2FSåˆ†ä¸ºäº†6ä¸ªlogåŒºåŸŸï¼Œåˆ†åˆ«å¯¹åº”<strong>hot node&#x2F;dataã€warm node&#x2F;dataã€cold node&#x2F;data</strong>ã€‚F2FSå¿…é¡»å®šæ—¶æ‰§è¡ŒCheckpointå»è®°å½•å½“å‰ç³»ç»Ÿçš„logåˆ†é…åˆ°å“ªä¸ªä½ç½®ï¼Œå¦åˆ™åœ¨ç³»ç»Ÿå®•æœºçš„æ—¶å€™ï¼Œä¼šå‡ºç°æ•°æ®ä¸¢å¤±ç­‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤cur_xxx_segnoä»¥åŠcur_xxx_blkoffè®°å½•äº†ä¸Šæ¬¡Checkpointæ—¶ï¼Œç³»ç»Ÿæ­£åœ¨ä½¿ç”¨çš„logçš„segment numberï¼Œä»¥åŠåˆ†é…åˆ°è¿™ä¸ªsegmentçš„å“ªä¸ªä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> &#123;</span><br>__le64 checkpoint_ver;<span class="hljs-comment">/* CPç‰ˆæœ¬ï¼Œç”¨äºæ¯”è¾ƒæ–°æ—§ç‰ˆæœ¬è¿›è¡Œæ¢å¤ */</span><br>__le64 user_block_count;<span class="hljs-comment">/* # of user blocks */</span><br>__le64 valid_block_count;<span class="hljs-comment">/* # of valid blocks in main area */</span><br>__le32 rsvd_segment_count;<span class="hljs-comment">/* # of reserved segments for gc */</span><br>__le32 overprov_segment_count;<span class="hljs-comment">/* # of overprovision segments */</span><br>__le32 free_segment_count;<span class="hljs-comment">/* # of free segments in main area */</span><br><br><span class="hljs-comment">/* information of current node segments */</span><br>__le32 cur_node_segno[MAX_ACTIVE_NODE_LOGS];<br>__le16 cur_node_blkoff[MAX_ACTIVE_NODE_LOGS];<br><span class="hljs-comment">/* information of current data segments */</span><br>__le32 cur_data_segno[MAX_ACTIVE_DATA_LOGS];<br>__le16 cur_data_blkoff[MAX_ACTIVE_DATA_LOGS];<br>__le32 ckpt_flags;<span class="hljs-comment">/* Flags : umount and journal_present */</span><br>__le32 cp_pack_total_block_count;<span class="hljs-comment">/* total # of one cp pack */</span><br>__le32 cp_pack_start_sum;<span class="hljs-comment">/* start block number of data summary */</span><br>__le32 valid_node_count;<span class="hljs-comment">/* Total number of valid nodes */</span><br>__le32 valid_inode_count;<span class="hljs-comment">/* Total number of valid inodes */</span><br>__le32 next_free_nid;<span class="hljs-comment">/* Next free node number */</span><br>__le32 sit_ver_bitmap_bytesize;<span class="hljs-comment">/* Default value 64 */</span><br>__le32 nat_ver_bitmap_bytesize; <span class="hljs-comment">/* Default value 256 */</span><br>__le32 checksum_offset;<span class="hljs-comment">/* checksum offset inside cp block */</span><br>__le64 elapsed_time;<span class="hljs-comment">/* mounted time */</span><br><span class="hljs-comment">/* allocation type of current segment */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> alloc_type[MAX_ACTIVE_LOGS];<br><br><span class="hljs-comment">/* SIT and NAT version bitmap */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sit_nat_version_bitmap[<span class="hljs-number">1</span>];<br>&#125; __packed;<br></code></pre></td></tr></table></figure><h3 id="2-2-Active-SegmentsåŒºåŸŸ"><a href="#2-2-Active-SegmentsåŒºåŸŸ" class="headerlink" title="2.2 Active SegmentsåŒºåŸŸ"></a>2.2 Active SegmentsåŒºåŸŸ</h3><h4 id="2-2-1-Active-Segmentsçš„å®šä¹‰"><a href="#2-2-1-Active-Segmentsçš„å®šä¹‰" class="headerlink" title="2.2.1 Active Segmentsçš„å®šä¹‰"></a>2.2.1 Active Segmentsçš„å®šä¹‰</h4><p>**Active Segmentsï¼Œåˆç§°current segment(CURSEG)**ï¼Œå³å½“å‰æ­£åœ¨ç”¨äºè¿›è¡Œæ•°æ®åˆ†é…çš„logå¯¹åº”çš„segmentï¼Œå¦‚ç”¨æˆ·éœ€è¦å†™å…¥8KBæ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä»active segmentsåˆ†é…ä¸¤ä¸ªblockæä¾›ç»™ç”¨æˆ·å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚F2FSä¸ºäº†æé«˜æ•°æ®åˆ†é…çš„æ•ˆç‡ï¼Œæ ¹æ®æ•°æ®çš„ç‰¹æ€§ï¼Œä¸€å…±å®šä¹‰äº†6ä¸ªactive segmentï¼Œè¿™6ä¸ªactive segmentså¯¹åº”äº†(how, warm, cold) X (node, data)çš„æ•°æ®ã€‚</p><h4 id="2-2-2-Active-Segmentä¸æ¢å¤ç›¸å…³çš„æ•°æ®ç»“æ„"><a href="#2-2-2-Active-Segmentä¸æ¢å¤ç›¸å…³çš„æ•°æ®ç»“æ„" class="headerlink" title="2.2.2 Active Segmentä¸æ¢å¤ç›¸å…³çš„æ•°æ®ç»“æ„"></a>2.2.2 Active Segmentä¸æ¢å¤ç›¸å…³çš„æ•°æ®ç»“æ„</h4><p>CPçš„ä¸»è¦ä»»åŠ¡æ˜¯ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§ï¼Œå› æ­¤CPçš„active segmentåŒºåŸŸçš„ä¸»è¦ä»»åŠ¡æ˜¯ç»´æŠ¤Active Segmentçš„åˆ†é…çŠ¶æ€ï¼Œä½¿ç³»ç»Ÿå®•æœºæ—¶å€™å¯ä»¥æ¢å¤æ­£å¸¸ã€‚ç»´æŠ¤active segmentéœ€è¦ç»´æŠ¤ä¸‰ç§ä¿¡æ¯ï¼Œåˆ†åˆ«æ˜¯f2fs_checkpointçš„ä¿¡æ¯ï¼Œä»¥åŠè¯¥segmentå¯¹åº”çš„journalå’Œsummaryçš„ä¿¡æ¯ã€‚</p><ul><li>f2fs_checkpointä¸­Active Segmentä¿¡æ¯ï¼šä»ä¸Šé¢ç»™å‡ºçš„f2fs_checkpointå®šä¹‰ï¼Œcur_node_segno[MAX_ACTIVE_NODE_LOGS]å’Œcur_data_segno[MAX_ACTIVE_DATA_LOGS]è¡¨ç¤ºnodeå’Œdataå½“å‰çš„Active Segmentçš„ç¼–å·(segment number, segno)ï¼Œç³»ç»Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªç¼–å·æ‰¾åˆ°å¯¹åº”çš„segmentã€‚MAX_ACTIVE_NODE_LOGSä»¥åŠMAX_ACTIVE_NODE_LOGSåˆ†åˆ«è¡¨ç¤ºdataå’Œnodeæœ‰å¤šå°‘ç§ç±»å‹ï¼ŒF2FSé»˜è®¤æƒ…å†µä¸‹éƒ½ç­‰äº3ï¼Œå³HOTã€WARMã€COLDç±»å‹æ•°æ®ã€‚cur_node_blkoff[MAX_ACTIVE_NODE_LOGS]ä»¥åŠcur_data_blkoff[MAX_ACTIVE_DATA_LOGS]åˆ™åˆ†åˆ«è¡¨ç¤ºå½“å‰active segmentåˆ†é…åˆ°å“ªä¸€ä¸ªblock(ä¸€ä¸ªsegmentåŒ…å«äº†512ä¸ªblock)ã€‚</li><li>Segmentå¯¹åº”çš„Journalä¿¡æ¯ï¼šJournalåœ¨ä¸¤å¤„åœ°æ–¹éƒ½æœ‰å‡ºç°ï¼Œåˆ†åˆ«æ˜¯CPåŒºåŸŸä»¥åŠSSAåŒºåŸŸã€‚ğŸ®<strong>CPåŒºåŸŸçš„journalä¸»è¦ç”¨æ¥ä¿å­˜active segmentçš„ä¿®æ”¹ä¿¡æ¯ï¼Œè€ŒSSAåŒºåŸŸçš„åˆ™æ˜¯æŒä¹…åŒ–ä¿å­˜çš„æ‰€æœ‰çš„segmentçš„journalä¿¡æ¯ã€‚</strong>å¦‚ç³»ç»Ÿåˆ†é…å‡ºä¸€ä¸ªblockç»™ç”¨æˆ·ï¼Œé‚£ä¹ˆå°±è¦å°†è¿™ä¸ªblockæ‰€åœ¨çš„segmentçš„bitmapä¸­æ ‡è®°ä¸ºå·²åˆ†é…ï¼Œé˜²æ­¢å…¶ä»–å†™è¯·æ±‚ä½¿ç”¨ã€‚åˆ†ä¸¤ä¸ªåŒºåŸŸå­˜æ”¾journalæ˜¯ä¸ºäº†å‡è½»é¢‘ç¹æ›´æ–°å¯¼è‡´çš„ç³»ç»Ÿæ€§èƒ½ä¸‹é™ã€‚ä¾‹å¦‚ï¼Œå½“ç³»ç»Ÿå†™å‹åŠ›å¾ˆå¤§çš„æ—¶å€™ï¼Œbitmapå°±ä¼šé¢‘ç¹è¢«æ›´æ–°ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™é¢‘ç¹å°†bitmapå†™å…¥SITï¼Œå°±ä¼šåŠ é‡å†™å‹åŠ›ã€‚å› æ­¤CPåŒºåŸŸçš„Journalçš„ä½œç”¨å°±æ˜¯ç»´æŠ¤è¿™äº›ç»å¸¸ä¿®æ”¹çš„æ•°æ®ï¼Œç­‰å¾…CPè¢«è§¦å‘çš„æ—¶å€™æ‰å›å†™åˆ°é—ªå­˜è®¾å¤‡ï¼Œä»è€Œå‡å°‘å†™å‹åŠ›ï¼Œæé«˜é—ªå­˜å¯¿å‘½ã€‚</li><li>Segmentå¯¹åº”çš„Summaryä¿¡æ¯ï¼šsummaryåŒæ ·åœ¨CPåŒºåŸŸå’ŒSSAåŒºåŸŸæœ‰å‡ºç°ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯é€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œè¿™ä¸ªæ˜ å°„å…³ç³»ä¼šä½¿ç”¨åˆ°GCæµç¨‹ä¸­ã€‚summaryä¸segmentæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œä¸€ä¸ªsummaryä¿å­˜äº†ä¸€ä¸ªsegmentæ‰€æœ‰çš„blockçš„ç‰©ç†åœ°å€å’Œé€»è¾‘åœ°å€çš„æ˜ å°„å…³ç³»ã€‚summaryä¿å­˜åœ¨CPåŒºåŸŸä¸­åŒæ ·æ˜¯å‡ºäºå‡å°‘IOçš„å†™å…¥ã€‚</li></ul><h3 id="2-3-Checkpointå†…å­˜ç®¡ç†ç»“æ„"><a href="#2-3-Checkpointå†…å­˜ç®¡ç†ç»“æ„" class="headerlink" title="2.3 Checkpointå†…å­˜ç®¡ç†ç»“æ„"></a>2.3 Checkpointå†…å­˜ç®¡ç†ç»“æ„</h3><p>Checkpointçš„å†…å­˜ç®¡ç†ç»“æ„æ˜¯struct f2fs_checkpointæœ¬èº«ï¼Œå› ä¸ºCheckpointä¸€èˆ¬åªåœ¨F2FSå¯åŠ¨çš„æ—¶å€™è¢«è¯»å–æ•°æ®ï¼Œç”¨äºæ•°æ®æ¢å¤ï¼Œè€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯è¢«å†™ï¼Œç”¨äºè®°å½•æ¢å¤ä¿¡æ¯ã€‚å› æ­¤ï¼ŒCheckpointä¸éœ€è¦è¿‡äºå¤æ‚çš„å†…å­˜ç®¡ç†ç»“æ„ï¼Œå› æ­¤ä½¿ç”¨struct f2fs_checkpointæœ¬èº«å³å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼ŒğŸ®<strong>active segmentsï¼Œå³F2FSçš„logï¼Œä¸»è¦ç”¨äºç³»ç»Ÿfree blockçš„åˆ†é…</strong>ï¼Œå› æ­¤éœ€è¦ç‰¹å®šçš„ç®¡ç†ç»“æ„struct curseg_infoè¿›è¡Œç®¡ç†ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">curseg_mutex</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary_block</span> *<span class="hljs-title">sum_blk</span>;</span><span class="hljs-comment">/* æ¯ä¸€ä¸ªsegmentå¯¹åº”ä¸€ä¸ªsummary block */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">journal_rwsem</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> *<span class="hljs-title">journal</span>;</span><span class="hljs-comment">/*æ¯ä¸€ä¸ªsegmentå¯¹åº”ä¸€ä¸ª info */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> alloc_type;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno;<span class="hljs-comment">/* å½“å‰segno */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> next_blkoff;<span class="hljs-comment">/* è®°å½•å½“å‰segmentç”¨äºåˆ†é…çš„ä¸‹ä¸€ä¸ªç»™blockå· */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> zone;<span class="hljs-comment">/* current zone number */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> next_segno;<span class="hljs-comment">/* å½“å‰segnoç”¨å®Œä»¥åï¼Œä¸‹ä¸ªå³å°†ç”¨æ¥åˆ†é…çš„segno */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»ç»“æ„åˆ†æå¯ä»¥ç›´åˆ°ï¼Œcurseg_infoè®°å½•å½“å‰çš„segmentçš„åˆ†é…ä¿¡æ¯ï¼Œå½“ç³»ç»Ÿå‡ºç°å®•æœºçš„æ—¶å€™ï¼Œå¯ä»¥ä»CPè®°å½•çš„curseg_infoæ¢å¤å½“ä¸Šä¸€æ¬¡CPç‚¹çš„çŠ¶æ€ã€‚</p><p>ğŸ® <strong>æ¯ä¸€ç§ç±»å‹çš„active segmentå°±å¯¹åº”ä¸€ä¸ªstruct curseg_infoç»“æ„</strong>ã€‚åœ¨F2FSä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥è¡¨ç¤º:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sm_info</span> &#123;</span><br>...<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg_array</span>;</span> <span class="hljs-comment">// é»˜è®¤æ˜¯åˆ†é…6ä¸ªcurseg_infoï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒç±»å‹</span><br>...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>struct f2fs_sm_info</code>æ˜¯SITçš„ç®¡ç†ç»“æ„ï¼Œå®ƒä¹Ÿç®¡ç†äº†CPæœ€ç»ˆçš„active segmentçš„ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªè·¨åŒºåŸŸçš„ç®¡ç†ç»“æ„ã€‚</p><h2 id="3-å…ƒæ•°æ®åŒºSSAåŒºåŸŸ"><a href="#3-å…ƒæ•°æ®åŒºSSAåŒºåŸŸ" class="headerlink" title="3.å…ƒæ•°æ®åŒºSSAåŒºåŸŸ"></a>3.å…ƒæ•°æ®åŒºSSAåŒºåŸŸ</h2><img src="/2023/10/08/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FCURSEG%E5%A4%87%E5%BF%98/2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><h3 id="3-1-SSAç‰©ç†å­˜æ”¾åŒºåŸŸç»“æ„"><a href="#3-1-SSAç‰©ç†å­˜æ”¾åŒºåŸŸç»“æ„" class="headerlink" title="3.1 SSAç‰©ç†å­˜æ”¾åŒºåŸŸç»“æ„"></a>3.1 SSAç‰©ç†å­˜æ”¾åŒºåŸŸç»“æ„</h3><p>SSAçš„åŸºæœ¬å­˜æ”¾å•å…ƒæ˜¯<code>struct f2fs_summary_block</code>ï¼Œå®ƒç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary_block</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> <span class="hljs-title">entries</span>[<span class="hljs-title">ENTRIES_IN_SUM</span>];</span> <span class="hljs-comment">// ENTRIES_IN_SUM = 512</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> <span class="hljs-title">journal</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">summary_footer</span> <span class="hljs-title">footer</span>;</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>ä¸summaryç›´æ¥ç›¸å…³çš„æ˜¯<code>struct f2fs_summary</code>ä»¥åŠ<code>struct summary_footer</code>ã€‚<code>ENTRIES_IN_SUM</code>çš„å€¼512ï¼Œå› æ­¤æ¯ä¸€ä¸ªentryå¯¹åº”ä¸€ä¸ªblockï¼Œè®°å½•äº†ä»ç‰©ç†åœ°å€åˆ°é€»è¾‘åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œentryçš„ç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> &#123;</span><br>__le32 nid;<span class="hljs-comment">/* parent node id */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u8 reserved[<span class="hljs-number">3</span>];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u8 version;<span class="hljs-comment">/* node version number */</span><br>__le16 ofs_in_node;<span class="hljs-comment">/* block index in parent node */</span><br>&#125; __packed;<br>&#125;;<br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>ç”¨äº†ä¸€ä¸ªunionç»“æ„è¿›è¡Œè¡¨ç¤ºï¼Œä½†æ˜¯æ ¸å¿ƒä¿¡æ¯æ˜¯nidã€versionä»¥åŠofs_in_nodeã€‚æ•°æ®çš„ç´¢å¼•æ˜¯é€šè¿‡nodeæ¥è¿›è¡Œï¼Œæ–‡ä»¶è®¿é—®æŸä¸€ä¸ªé¡µçš„æ•°æ®æ—¶ï¼Œéœ€è¦é¦–å…ˆæ ¹æ®é¡µçš„ç´¢å¼•ï¼Œæ‰¾åˆ°å¯¹åº”çš„nidä»¥åŠoffset(ä¸¤è€…æ„æˆé€»è¾‘åœ°å€)ï¼Œä»è€Œæ ¹æ®nidå¾—åˆ°node pageï¼Œå†æ ¹æ®offsetå¾—åˆ°äº†è¯¥é¡µçš„ç‰©ç†åœ°å€ï¼Œç„¶åä»ç£ç›˜ä¸­è¯»å–å‡ºæ¥ã€‚f2fs_summaryåˆ™æ˜¯è®°å½•ç‰©ç†åœ°å€åˆ°é€»è¾‘åœ°å€çš„æ˜ å°„ï¼Œå³æ ¹æ®ç‰©ç†åœ°å€æ‰¾åˆ°å¯¹åº”çš„nidä»¥åŠoffsetã€‚ä¾‹å¦‚ï¼Œç°åœ¨éœ€è¦æ ¹æ®ç‰©ç†åœ°å€ä¸º624çš„blockï¼Œæ‰¾åˆ°å¯¹åº”çš„nidä»¥åŠoffsetã€‚é‚£ä¹ˆç‰©ç†åœ°å€ä¸º624ï¼Œå¯ä»¥å¾—åˆ°è¯¥åœ°å€ä½äºç¬¬äºŒä¸ªsegmentï¼Œç„¶åå±äºç¬¬äºŒä¸ªsegmentçš„ç¬¬113ä¸ªblock(blockçš„ç¼–å€ä»0å¼€å§‹)ã€‚å› æ­¤æ ¹æ®å±äºç¬¬äºŒä¸ªsegmentçš„ä¿¡æ¯ï¼Œæ‰¾åˆ°ç¬¬äºŒä¸ªstruct f2fs_summary_blockï¼Œç„¶åæ ¹æ®åç§»é‡ä¸º113çš„ä¿¡æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„struct f2fs_summaryç»“æ„ï¼Œä»è€Œå¾—åˆ°nidä»¥åŠofs_in_nodeã€‚</p><p>struct summary_footerç»“æ„è®°å½•äº†æ ¡éªŒä¿¡æ¯ï¼Œä»¥åŠè¿™ä¸ªsummaryå¯¹åº”çš„segmentæ˜¯<strong>å±äºä¿å­˜dataæ•°æ®çš„segmentè¿˜æ˜¯nodeæ•°æ®çš„segment</strong>ã€‚</p><h3 id="3-2-SSAå†…å­˜ç®¡ç†ç»“æ„"><a href="#3-2-SSAå†…å­˜ç®¡ç†ç»“æ„" class="headerlink" title="3.2 SSAå†…å­˜ç®¡ç†ç»“æ„"></a>3.2 SSAå†…å­˜ç®¡ç†ç»“æ„</h3><p>SSAåœ¨å†…å­˜æ²¡æœ‰å•ç‹¬çš„ç®¡ç†ç»“æ„ï¼Œsummaryä»¥åŠjournalåœ¨å†…å­˜ä¸­ä¸»è¦å­˜åœ¨äº<code>CURSEG</code>ä¸­ï¼Œå¯ä»¥ä»Checkpointç»“æ„è¿™ä¸€ç« èŠ‚ï¼ˆç¬¬2èŠ‚ï¼‰æ‰¾åˆ°ç›¸å…³çš„æè¿°ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>linuxå†…æ ¸é“¾è¡¨</title>
    <link href="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/"/>
    <url>/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="linuxå†…æ ¸é“¾è¡¨"><a href="#linuxå†…æ ¸é“¾è¡¨" class="headerlink" title="linuxå†…æ ¸é“¾è¡¨"></a>linuxå†…æ ¸é“¾è¡¨</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/to_be_better_wen/article/details/127720433">https://blog.csdn.net/to_be_better_wen/article/details/127720433</a></p></blockquote><h2 id="ä¸€ã€Linuxå†…æ ¸é“¾è¡¨ç®€ä»‹"><a href="#ä¸€ã€Linuxå†…æ ¸é“¾è¡¨ç®€ä»‹" class="headerlink" title="ä¸€ã€Linuxå†…æ ¸é“¾è¡¨ç®€ä»‹"></a>ä¸€ã€Linuxå†…æ ¸é“¾è¡¨ç®€ä»‹</h2><p>Linuxå†…æ ¸ä¸­éœ€è¦ç»å¸¸ç”¨åˆ°åŒé“¾è¡¨ï¼Œè¯¥é“¾è¡¨åªæœ‰æŒ‡é’ˆåŸŸï¼Œæ²¡æœ‰æ•°æ®åŸŸã€‚åœ¨å¾ˆå¤šçš„æ•°æ®ç»“æ„ä¸­éƒ½ä¼šåµŒå…¥struct list_headç»“æ„ä½“å˜é‡ï¼Œå®ƒå¯ä»¥ä½¿ç»“æ„ä½“åŠ å…¥åˆ°ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ã€‚é“¾è¡¨çš„åˆå§‹åŒ–ï¼Œå¢åŠ ï¼Œåˆ é™¤ç­‰æ“ä½œçš„æ¥å£åœ¨linux-x.x.x&#x2F;include&#x2F;linux&#x2F;list.hé‡Œé¢ï¼Œå†…æ ¸é“¾è¡¨åœ¨å†…æ ¸ä¸­ä½¿ç”¨çš„æ˜¯å¦‚æ­¤å¹¿æ³›ï¼Œæ‰€ä»¥éœ€è¦æ·±åˆ»çš„ç†è§£ã€‚</p><h2 id="äºŒã€Linuxå†…æ ¸é“¾è¡¨ä½¿ç”¨ä»‹ç»"><a href="#äºŒã€Linuxå†…æ ¸é“¾è¡¨ä½¿ç”¨ä»‹ç»" class="headerlink" title="äºŒã€Linuxå†…æ ¸é“¾è¡¨ä½¿ç”¨ä»‹ç»"></a>äºŒã€Linuxå†…æ ¸é“¾è¡¨ä½¿ç”¨ä»‹ç»</h2><p><strong>1.åŸºæœ¬æ•°æ®ç»“æ„</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»ç»“æ„ä½“æˆå‘˜çœ‹ï¼Œå†…æ ¸é“¾è¡¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ²¡æœ‰æ•°æ®åŸŸï¼ŒnextæŒ‡å‘ä¸‹ä¸€ä¸ªé“¾è¡¨å…ƒç´ ï¼ŒprevæŒ‡å‘ä¸Šä¸€ä¸ªé“¾è¡¨å…ƒç´ ã€‚</p><p><strong>2. é“¾è¡¨çš„åˆå§‹åŒ–</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIST_HEAD_INIT(name) &#123; &amp;(name), &amp;(name) &#125;</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIST_HEAD(name) \</span><br><span class="hljs-meta">struct list_head name = LIST_HEAD_INIT(name)</span><br></code></pre></td></tr></table></figure><p>é“¾è¡¨å£°æ˜å’Œåˆå§‹åŒ–çš„é€šå¸¸ç”¨LIST_HEAD(name)å¤„ç†ã€‚LIST_HEADå®šä¹‰äº†ä¸€ä¸ªå˜é‡struct listå˜é‡nameï¼Œå¹¶ä¸”nameçš„nextå’ŒprevæŒ‡é’ˆéƒ½æŒ‡å‘nameçš„åœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/c8f72d6a3d554bc79ecb1d4076cd45ed.png" alt="img" style="zoom: 80%;"><p><strong>3.é“¾è¡¨å…ƒç´ æ·»åŠ </strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_add(<span class="hljs-keyword">struct</span> list_head *new,<br>      <span class="hljs-keyword">struct</span> list_head *prev,<br>      <span class="hljs-keyword">struct</span> list_head *next)<br>&#123;<br>next-&gt;prev = new;<br>new-&gt;next = next;<br>new-&gt;prev = prev;<br>prev-&gt;next = new;<br>&#125;<br> <br># å‘å¤´éƒ¨æ·»åŠ  (åœ¨é“¾è¡¨å¤´æŒ‡é’ˆå’Œé“¾è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ ä¹‹é—´æ’å…¥å…ƒç´ )<br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">list_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *new, <span class="hljs-keyword">struct</span> list_head *head)</span><br>&#123;<br>__list_add(new, head, head-&gt;next);<br>&#125;<br> <br># å‘å°¾éƒ¨æ·»åŠ  (åœ¨é“¾è¡¨æœ€åä¸€ä¸ªå…ƒç´ å’Œé“¾è¡¨å¤´æŒ‡é’ˆä¹‹é—´æ’å…¥å…ƒç´ )<br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">list_add_tail</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *new, <span class="hljs-keyword">struct</span> list_head *head)</span><br>&#123;<br>__list_add(new, head-&gt;prev, head);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/7acf68571d31469891f10361299dcf96.png" alt="img" style="zoom:67%;"><p>list_addå‡½æ•°å‘__list_addå‡½æ•°ä¼ å…¥çš„prevå’Œnextå‚æ•°åˆ†åˆ«æ˜¯headå’Œhead-&gt;nextï¼Œæ‰€ä»¥list_addå‡½æ•°æ˜¯åœ¨é“¾è¡¨å¤´æŒ‡é’ˆå’Œé“¾è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ ä¹‹é—´æ’å…¥newå…ƒç´ ã€‚</p><p>list_add_tailå‡½æ•°å‘__list_addå‡½æ•°ä¼ å…¥çš„prevå’ŒnextæŒ‡é’ˆåˆ†åˆ«æ˜¯head-&gt;prevå’Œheadï¼Œhead-&gt;prevå°±æ˜¯æŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥list_add_tailæ˜¯åœ¨é“¾è¡¨æœ€åä¸€ä¸ªå…ƒç´ å’Œé“¾è¡¨å¤´æŒ‡é’ˆä¹‹é—´æ’å…¥å…ƒç´ ã€‚</p><p><strong>4.é“¾è¡¨å…ƒç´ åˆ é™¤</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_del(<span class="hljs-keyword">struct</span> list_head * prev, <span class="hljs-keyword">struct</span> list_head * next)<br>&#123;<br>next-&gt;prev = prev;<br>prev-&gt;next = next;<br>&#125;<br> <br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_del_entry(<span class="hljs-keyword">struct</span> list_head *entry)<br>&#123;<br>__list_del(entry-&gt;prev, entry-&gt;next);<br>&#125;<br> <br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">list_del</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *entry)</span><br>&#123;<br>__list_del(entry-&gt;prev, entry-&gt;next);<br>entry-&gt;next = LIST_POISON1;<br>entry-&gt;prev = LIST_POISON2;<br>&#125;<br></code></pre></td></tr></table></figure><p> _list_delå‡½æ•°çš„ä½œç”¨æ˜¯åˆ é™¤prevå’ŒnextæŒ‡é’ˆæŒ‡å‘çš„å…ƒç´ ä¹‹é—´çš„å…ƒç´ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/0f24f204a2034c5cae94e9bb7e796635.png" alt="img" style="zoom:67%;"><p> __list_del_entryå‡½æ•°å‘__list_delå‡½æ•°ä¼ å…¥çš„çš„prevå’Œnextå‚æ•°åˆ†åˆ«æŒ‡å‘æ˜¯è¦åˆ é™¤å…ƒç´ çš„å‰ä¸€ä¸ªå…ƒç´ å’Œåä¸€ä¸ªå…ƒç´ ã€‚</p><p>list_delå‡½æ•°å’Œ__list_del_entryå‡½æ•°çš„åŒºåˆ«æ˜¯å°†åˆ é™¤å…ƒç´ çš„å‰å‘æŒ‡é’ˆå’Œåå‘æŒ‡é’ˆéƒ½æŒ‡å‘ä¸€ä¸ªéæ³•å€¼ï¼Œå¦‚å…ƒç´ ä»é“¾è¡¨ä¸­åˆ é™¤åä»ç„¶åé—®ï¼Œåˆ™ä¼šäº§ç”Ÿå†…å­˜é¡µé”™è¯¯ã€‚</p><p><strong>5.é“¾è¡¨çš„éå†</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each-iterate over a list</span><br><span class="hljs-comment"> * @pos:the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * @head:the head for your list.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each(pos, head) \</span><br><span class="hljs-meta">for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)</span><br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_prev-iterate over a list backwards</span><br><span class="hljs-comment"> * @pos:the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * @head:the head for your list.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_prev(pos, head) \</span><br><span class="hljs-meta">for (pos = (head)-&gt;prev; pos != (head); pos = pos-&gt;prev)</span><br> <br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_safe - iterate over a list safe against removal of list entry</span><br><span class="hljs-comment"> * @pos:the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * @n:another &amp;struct list_head to use as temporary storage</span><br><span class="hljs-comment"> * @head:the head for your list.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_safe(pos, n, head) \</span><br><span class="hljs-meta">for (pos = (head)-&gt;next, n = pos-&gt;next; pos != (head); \</span><br><span class="hljs-meta">pos = n, n = pos-&gt;next)</span><br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_prev_safe - iterate over a list backwards safe against removal of list entry</span><br><span class="hljs-comment"> * @pos:the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * @n:another &amp;struct list_head to use as temporary storage</span><br><span class="hljs-comment"> * @head:the head for your list.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_prev_safe(pos, n, head) \</span><br><span class="hljs-meta">for (pos = (head)-&gt;prev, n = pos-&gt;prev; \</span><br><span class="hljs-meta">     pos != (head); \</span><br><span class="hljs-meta">     pos = n, n = pos-&gt;prev)</span><br> <br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_entry-iterate over list of given type</span><br><span class="hljs-comment"> * @pos:the type * to use as a loop cursor.</span><br><span class="hljs-comment"> * @head:the head for your list.</span><br><span class="hljs-comment"> * @member:the name of the list_struct within the struct.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_entry(pos, head, member)\</span><br><span class="hljs-meta">for (pos = list_first_entry(head, typeof(*pos), member);\</span><br><span class="hljs-meta">     &amp;pos-&gt;member != (head);\</span><br><span class="hljs-meta">     pos = list_next_entry(pos, member))</span><br></code></pre></td></tr></table></figure><p>list_for_eachå‡½æ•°æ˜¯æŒ‰ç…§ä»å‰å¾€åçš„é¡ºåºéå†é“¾è¡¨ï¼Œé€šè¿‡ä¸æ–­æŒ‡å‘å…ƒç´ çš„nextå…ƒç´ ï¼Œç›´åˆ°å…ƒç´ çš„æŒ‡é’ˆå’Œé“¾è¡¨å¤´æŒ‡é’ˆåœ°å€ç›¸åŒï¼Œåˆ™è¡¨ç¤ºé“¾è¡¨éå†å®Œæˆã€‚</p><p>list_for_each_prevå‡½æ•°åˆ™æ˜¯ä»é“¾è¡¨çš„å°¾éƒ¨å…ƒç´ å‘å‰éå†ã€‚</p><p>list_for_each_safeå‡½æ•°å¼•å…¥äº†æŒ‡é’ˆnï¼Œç”¨äºå­˜å‚¨posçš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚å¼•å…¥æŒ‡é’ˆnå¯ä»¥æ–¹ä¾¿åœ¨éå†é“¾è¡¨çš„æ—¶å€™åˆ é™¤posæŒ‡å‘çš„å…ƒç´ ï¼Œè€Œä¸å½±å“éå†ã€‚list_for_eachæ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p>list_for_each_prev_safeå‡½æ•°å’Œlist_for_each_safeå‡½æ•°çš„åŒºåˆ«æ˜¯ä»åå¾€å‰éå†ã€‚</p><p>list_for_each_entryå‡½æ•°æ˜¯list_for_eachå’Œlist_entryçš„ç»“åˆï¼Œæœ‰posï¼Œheadï¼Œmemberä¸‰ä¸ªå‚æ•°ï¼Œposæ˜¯ä¸€ä¸ªä¸­é—´å˜é‡ï¼ŒæŒ‡å‘å½“å‰è®¿é—®çš„é“¾è¡¨å…ƒç´ ï¼ŒheadæŒ‡é“¾è¡¨å¤´ï¼ŒmemberæŒ‡posæŒ‡å‘çš„ç»“æ„ä½“ä¸­é“¾è¡¨æˆå‘˜å˜é‡çš„åç§°ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/b54ea1e8ca784b2bbdbaef085bc90c01.png" alt="img" style="zoom:80%;"><p><strong>6.æŸ¥æ‰¾é“¾è¡¨å…ƒç´ </strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_entry - get the struct for this entry</span><br><span class="hljs-comment"> * @ptr:the &amp;struct list_head pointer.</span><br><span class="hljs-comment"> * @type:the type of the struct this is embedded in.</span><br><span class="hljs-comment"> * @member:the name of the list_struct within the struct.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_entry(ptr, type, member) \</span><br><span class="hljs-meta">container_of(ptr, type, member)</span><br></code></pre></td></tr></table></figure><p>list_entryå®æœ‰ä¸‰ä¸ªå‚æ•°ptrï¼Œtypeï¼Œmemberã€‚ptræ˜¯æŒ‡æ•°æ®ç»“æ„ä¸­struct list_headå˜é‡æˆå‘˜çš„åœ°å€ï¼Œtypeæ˜¯æŒ‡æ•°æ®ç»“æ„çš„ç±»å‹ï¼Œmemberæ˜¯æŒ‡æ•°æ®ç»“æ„ä¸­struct list_headçš„å˜é‡åã€‚list_entryå®çš„ç»“æœæ˜¯ptræŒ‡å‘çš„typeç±»å‹çš„æ•°æ®ç»“æ„çš„å˜é‡åœ°å€ã€‚</p><img src="/2023/10/07/linux%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8/dd2eeb6f00484fa7a5eb243274df053a.png" alt="img" style="zoom: 80%;"><p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> &#123;</span><br>    ...<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">tasks</span>;</span><br>    ...<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¦‚æœè¦è·å–æŸä¸ªstruct task_structç±»å‹çš„å˜é‡çš„åœ°å€ï¼ŒptræŒ‡å‘è¯¥å˜é‡çš„tasksæŒ‡é’ˆå˜é‡çš„åœ°å€ï¼Œåˆ™å¯ä»¥è¿™ä¹ˆå†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">addr</span> =</span> list_entry(ptr, <span class="hljs-keyword">struct</span> task_struct, tasks);<br></code></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼šlist_for_eachå’Œlist_entryé…åˆä½¿ç”¨</p><p>list_for_eachå‡½æ•°ç”¨äºè·å–æ•°æ®ç»“æ„ä¸­struct list_headæˆå‘˜çš„åœ°å€ï¼Œlist_entryåˆ™æ˜¯é€šè¿‡struct list_headæˆå‘˜çš„åœ°å€è·å–åˆ°æ•°æ®ç»“æ„çš„åœ°å€ã€‚</p><p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">list_for_each(pos, &amp;<span class="hljs-built_in">list</span>)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">addr</span> =</span> list_entry(pos, <span class="hljs-keyword">struct</span> task_struct, tasks);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h2><p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/list.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/rculist.h&gt;</span></span><br> <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stu_info</span></span><br><span class="hljs-class">&#123;</span><br>   <span class="hljs-type">char</span>* name;<br>   <span class="hljs-type">int</span> age;<br>   <span class="hljs-type">void</span> (*print)(<span class="hljs-keyword">struct</span> stu_info *stu);<br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br>&#125;;<br> <br><span class="hljs-type">void</span> <span class="hljs-title function_">print_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> stu_info *stu)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;name = %s, age = %d\n&quot;</span>, stu-&gt;name, stu-&gt;age);<br>&#125;<br> <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stu_info</span> <span class="hljs-title">students</span>[8] =</span> &#123;<br>&#123;<span class="hljs-string">&quot;Zhao&quot;</span>, <span class="hljs-number">20</span>, print_info&#125;,<br>&#123;<span class="hljs-string">&quot;Qian&quot;</span>, <span class="hljs-number">21</span>, print_info&#125;,<br>&#123;<span class="hljs-string">&quot;Sun&quot;</span>, <span class="hljs-number">22</span>, print_info&#125;,<br>&#123;<span class="hljs-string">&quot;Li&quot;</span>, <span class="hljs-number">23</span>, print_info&#125;,<br>&#125;;<br> <br>LIST_HEAD(stu);<br> <br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">student_list_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">pos</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stu_info</span> *<span class="hljs-title">s</span>;</span><br> <br>list_add(&amp;students[<span class="hljs-number">0</span>].<span class="hljs-built_in">list</span>, &amp;stu);<br>list_add(&amp;students[<span class="hljs-number">1</span>].<span class="hljs-built_in">list</span>, &amp;stu);<br>list_add(&amp;students[<span class="hljs-number">2</span>].<span class="hljs-built_in">list</span>, &amp;stu);<br>list_add(&amp;students[<span class="hljs-number">3</span>].<span class="hljs-built_in">list</span>, &amp;stu);<br> <br>list_for_each(pos, &amp;stu)<br>&#123;<br>s = list_entry(pos, <span class="hljs-keyword">struct</span> stu_info, <span class="hljs-built_in">list</span>);<br>s-&gt;print(s);<br>&#125;<br><br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br> <br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">student_list_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>   printk(<span class="hljs-string">&quot;student_list_exit\n&quot;</span>);<br> <br>   <span class="hljs-keyword">return</span>;<br>&#125;<br> <br>module_init(student_list_init);<br>module_exit(student_list_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;Dual BSD/GPL&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">[<span class="hljs-number">19764.110000</span>] name = Li, age = <span class="hljs-number">23</span><br>[<span class="hljs-number">19764.120000</span>] name = Sun, age = <span class="hljs-number">22</span><br>[<span class="hljs-number">19764.120000</span>] name = Qian, age = <span class="hljs-number">21</span><br>[<span class="hljs-number">19764.130000</span>] name = Zhao, age = <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure><h2 id="å››-å¸¸ç”¨çš„2ä¸ªé“¾è¡¨éå†å‡½æ•°"><a href="#å››-å¸¸ç”¨çš„2ä¸ªé“¾è¡¨éå†å‡½æ•°" class="headerlink" title="å››.å¸¸ç”¨çš„2ä¸ªé“¾è¡¨éå†å‡½æ•°"></a>å››.å¸¸ç”¨çš„2ä¸ªé“¾è¡¨éå†å‡½æ•°</h2><h3 id="4-1-list-for-each-entry"><a href="#4-1-list-for-each-entry" class="headerlink" title="4.1 list_for_each_entry"></a>4.1 list_for_each_entry</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_entry    - iterate over list of given type</span><br><span class="hljs-comment"> * @pos:    the type * to use as a loop cursor.</span><br><span class="hljs-comment"> * @head:    the head for your list.</span><br><span class="hljs-comment"> * @member:    the name of the list_struct within the struct.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_entry(pos, head, member)                \</span><br><span class="hljs-meta">    for (pos = list_entry((head)-&gt;next, typeof(*pos), member);    \</span><br><span class="hljs-meta">         &amp;pos-&gt;member != (head);     \</span><br><span class="hljs-meta">         pos = list_entry(pos-&gt;member.next, typeof(*pos), member))</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå®çš„ä½œç”¨å°±æ˜¯æ ¹æ®list_headå¯¹é“¾è¡¨è¿›è¡Œéå†ã€‚</p><ul><li>pos ï¼šè¡¨ç¤ºæ¯ä¸€æ¬¡éå†æ˜¯è¿”å›çš„ç»“æ„ä½“å˜é‡çš„é¦–åœ°å€</li><li>head : è¡¨ç¤ºè¦éå†çš„é“¾è¡¨çš„å¤´éƒ¨</li><li>member ï¼šè¡¨ç¤ºè¯¥é“¾è¡¨åœ¨ç»“æ„ä½“ä¸­çš„æˆå‘˜åç§°</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/list.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usrList</span> &#123;</span> <br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-type">int</span> data; <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span> <br>&#125; USR_LIST_TYPE; <br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> <br>&#123; <br>    USR_LIST_TYPE msg, *pmsg; <br>    LIST_HEAD(msg_head);<br>    <span class="hljs-type">int</span> *ptr = &amp;msg.data;<br>    <span class="hljs-type">int</span> i; <span class="hljs-comment">/* insert the 10 msgs */</span> <br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123; <br>        pmsg = (USR_LIST_TYPE *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(USR_LIST_TYPE)); <br>        pmsg-&gt;index = i + <span class="hljs-number">1</span>; <br>        pmsg-&gt;data = (i + <span class="hljs-number">1</span>)*<span class="hljs-number">10</span>; <br>        list_add_tail(&amp;pmsg-&gt;<span class="hljs-built_in">list</span>, &amp;msg_head); <br>    &#125; <br><br>    <span class="hljs-comment">/* æ ¹æ®list éå† æ•´ä¸ªé“¾è¡¨ï¼Œå¹¶æ‰“å°ä¿¡æ¯ */</span> <br>    list_for_each_entry(pmsg, &amp;msg_head, <span class="hljs-built_in">list</span>)<br>    &#123; <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;msg index:%d data:%d\n&quot;</span>, pmsg-&gt;index, pmsg-&gt;data); <br>    &#125; <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-list-for-each-entry-safe"><a href="#4-2-list-for-each-entry-safe" class="headerlink" title="4.2 list_for_each_entry_safe"></a>4.2 list_for_each_entry_safe</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* list_for_each_entry_safe - iterate over list of given type safe against removal of list entry</span><br><span class="hljs-comment">* @pos:     the type * to use as a loop cursor.</span><br><span class="hljs-comment">* @n:          another type * to use as temporary storage</span><br><span class="hljs-comment">* @head:     the head for your list.</span><br><span class="hljs-comment">* @member:     the name of the list_struct within the struct.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> list_for_each_entry_safe(pos, n, head, member)               \</span><br><span class="hljs-meta">     for (pos = list_entry((head)-&gt;next, typeof(*pos), member),     \</span><br><span class="hljs-meta">          n = list_entry(pos-&gt;member.next, typeof(*pos), member);     \</span><br><span class="hljs-meta">          &amp;pos-&gt;member != (head);                         \</span><br><span class="hljs-meta">          pos = n, n = list_entry(n-&gt;member.next, typeof(*n), member))</span><br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œç”¨äºéå†ä¸€ä¸ªé“¾è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­å¯ä»¥å®‰å…¨åœ°åˆ é™¤å…ƒç´ ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªå®å®šä¹‰çš„åŠŸèƒ½æ˜¯ï¼š</p><ol><li>éå†é“¾è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œä»å¤´èŠ‚ç‚¹å¼€å§‹ï¼Œç›´åˆ°å°¾èŠ‚ç‚¹ç»“æŸã€‚</li><li>å¯¹äºæ¯ä¸ªå…ƒç´ ï¼Œä½¿ç”¨ç»™å®šçš„ç»“æ„ä½“æˆå‘˜å˜é‡åæ‰¾åˆ°å®ƒæ‰€å±çš„ç»“æ„ä½“å¯¹è±¡ï¼Œå¹¶ä¸”å°†è¯¥å¯¹è±¡çš„æŒ‡é’ˆèµ‹å€¼ç»™ç»™å®šçš„å˜é‡åã€‚</li><li>åœ¨éå†è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å®‰å…¨åœ°åˆ é™¤å½“å‰å…ƒç´ ï¼Œå› ä¸ºå®ƒåœ¨åˆ é™¤å‰ä¼šå…ˆä¿å­˜ä¸‹ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œä¿è¯ä¸ä¼šå½±å“éå†çš„æ­£ç¡®æ€§ã€‚</li></ol><p>ä¸‹é¢æ˜¯è¿™ä¸ªå®å®šä¹‰çš„è¯¦ç»†è§£é‡Šï¼š</p><ul><li>posï¼šç”¨äºä¿å­˜å½“å‰éå†åˆ°çš„å…ƒç´ çš„æŒ‡é’ˆã€‚</li><li>tmpï¼šç”¨äºä¿å­˜ä¸‹ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œä»¥ä¾¿åœ¨åˆ é™¤å½“å‰å…ƒç´ åç»§ç»­éå†ã€‚</li><li>headï¼šé“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚</li><li>memberï¼šé“¾è¡¨èŠ‚ç‚¹æ‰€åœ¨çš„ç»“æ„ä½“æˆå‘˜å˜é‡åã€‚</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•åˆ¤æ–­f2fsæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨å¤šè®¾å¤‡</title>
    <link href="/2023/10/04/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADf2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AE%BE%E5%A4%87/"/>
    <url>/2023/10/04/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADf2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AE%BE%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h1 id="å¦‚ä½•åˆ¤æ–­f2fsæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨å¤šè®¾å¤‡"><a href="#å¦‚ä½•åˆ¤æ–­f2fsæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨å¤šè®¾å¤‡" class="headerlink" title="å¦‚ä½•åˆ¤æ–­f2fsæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨å¤šè®¾å¤‡"></a>å¦‚ä½•åˆ¤æ–­f2fsæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦ä½¿ç”¨å¤šè®¾å¤‡</h1><p>åœ¨f2fsæ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨å‡½æ•°<strong>f2fs_is_multi_device</strong>è¿›è¡Œåˆ¤æ–­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">f2fs_is_multi_device</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> sbi-&gt;s_ndevs &gt; <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/10/04/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADf2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AE%BE%E5%A4%87/image-20231004234402946.png" alt="image-20231004234402946" style="zoom:50%;"><p>å…¶èµ‹å€¼çš„åœ°æ–¹ä¸º<strong>f2fs_scan_devices</strong>å‡½æ•°ã€‚</p><hr><p>åœ¨æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒ‚è½½çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨fill_superè¿™æ ·çš„å‡½æ•°ï¼Œå¯¹äºf2fsæ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œå…¶ä¼šè°ƒç”¨åˆ°f2fs_scan_deviceså‡½æ•°</p><img src="/2023/10/04/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADf2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AE%BE%E5%A4%87/image-20231004233549137.png" alt="image-20231004233549137" style="zoom: 67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> RDEV(i)(raw_super-&gt;devs[i])</span><br></code></pre></td></tr></table></figure><p>å°±æ˜¯å¯¹åº”f2fs_super_blockä¸­çš„devå­—æ®µï¼Œå…¶ä½äº0xca0ï¼š</p><img src="/2023/10/04/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%ADf2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AE%BE%E5%A4%87/image-20231004234151705.png" alt="image-20231004234151705" style="zoom:80%;"><p>å¦‚æœéƒ½æ˜¯0ã€å…·ä½“å¤šå°‘ä½éœ€è¦çœ‹f2fs_deviceç»“æ„ä½“å¤§å°ã€‘ï¼Œæˆ‘è¿™é‡Œå…¨æ˜¯0ï¼Œè¯´æ˜æ˜¯å•è®¾å¤‡</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘Cè¯­è¨€0é•¿åº¦æ•°ç»„(å¯å˜æ•°ç»„/æŸ”æ€§æ•°ç»„)è¯¦è§£</title>
    <link href="/2023/10/04/C%E8%AF%AD%E8%A8%800%E9%95%BF%E5%BA%A6%E6%95%B0%E7%BB%84-%E5%8F%AF%E5%8F%98%E6%95%B0%E7%BB%84-%E6%9F%94%E6%80%A7%E6%95%B0%E7%BB%84-%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/10/04/C%E8%AF%AD%E8%A8%800%E9%95%BF%E5%BA%A6%E6%95%B0%E7%BB%84-%E5%8F%AF%E5%8F%98%E6%95%B0%E7%BB%84-%E6%9F%94%E6%80%A7%E6%95%B0%E7%BB%84-%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.modb.pro/db/463637">https://www.modb.pro/db/463637</a></p></blockquote><h1 id="ã€è½¬è½½ã€‘Cè¯­è¨€0é•¿åº¦æ•°ç»„-å¯å˜æ•°ç»„-x2F-æŸ”æ€§æ•°ç»„-è¯¦è§£"><a href="#ã€è½¬è½½ã€‘Cè¯­è¨€0é•¿åº¦æ•°ç»„-å¯å˜æ•°ç»„-x2F-æŸ”æ€§æ•°ç»„-è¯¦è§£" class="headerlink" title="ã€è½¬è½½ã€‘Cè¯­è¨€0é•¿åº¦æ•°ç»„(å¯å˜æ•°ç»„&#x2F;æŸ”æ€§æ•°ç»„)è¯¦è§£"></a>ã€è½¬è½½ã€‘Cè¯­è¨€0é•¿åº¦æ•°ç»„(å¯å˜æ•°ç»„&#x2F;æŸ”æ€§æ•°ç»„)è¯¦è§£</h1><h2 id="é›¶é•¿åº¦æ•°ç»„æ¦‚å¿µ"><a href="#é›¶é•¿åº¦æ•°ç»„æ¦‚å¿µ" class="headerlink" title="é›¶é•¿åº¦æ•°ç»„æ¦‚å¿µ"></a>é›¶é•¿åº¦æ•°ç»„æ¦‚å¿µ</h2><p>ä¼—æ‰€å‘¨çŸ¥, GNU&#x2F;GCC åœ¨æ ‡å‡†çš„ C&#x2F;C++ åŸºç¡€ä¸Šåšäº†æœ‰å®ç”¨æ€§çš„æ‰©å±•, é›¶é•¿åº¦æ•°ç»„ï¼ˆArrays of Length Zeroï¼‰ å°±æ˜¯å…¶ä¸­ä¸€ä¸ªçŸ¥åçš„æ‰©å±•.</p><p>å¤šæ•°æƒ…å†µä¸‹, å…¶åº”ç”¨åœ¨å˜é•¿æ•°ç»„ä¸­, å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Packet</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> state;<br>    <span class="hljs-type">int</span> len;<br>    <span class="hljs-type">char</span> cData[<span class="hljs-number">0</span>]; <span class="hljs-comment">//è¿™é‡Œçš„0é•¿ç»“æ„ä½“å°±ä¸ºå˜é•¿ç»“æ„ä½“æä¾›äº†éå¸¸å¥½çš„æ”¯æŒ</span><br>    <span class="hljs-comment">// char cData[];  ä¹Ÿæ˜¯ä¸€æ ·çš„</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆå¯¹ 0é•¿åº¦æ•°ç»„ã€æˆ–è€…ç©ºé•¿åº¦æ•°ç»„ã€‘, ä¹Ÿå«æŸ”æ€§æ•°ç»„ åšä¸€ä¸ªè§£é‡Š ï¼š</p><ul><li>ç”¨é€” : é•¿åº¦ä¸º0çš„æ•°ç»„çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºäº†æ»¡è¶³éœ€è¦å˜é•¿åº¦çš„ç»“æ„ä½“</li><li>ç”¨æ³• : åœ¨ä¸€ä¸ªç»“æ„ä½“çš„æœ€å, ç”³æ˜ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„, å°±å¯ä»¥ä½¿å¾—è¿™ä¸ªç»“æ„ä½“æ˜¯å¯å˜é•¿çš„. å¯¹äºç¼–è¯‘å™¨æ¥è¯´, æ­¤æ—¶é•¿åº¦ä¸º0çš„æ•°ç»„å¹¶ä¸å ç”¨ç©ºé—´, å› ä¸ºæ•°ç»„åæœ¬èº«ä¸å ç©ºé—´, å®ƒåªæ˜¯ä¸€ä¸ªåç§»é‡, æ•°ç»„åè¿™ä¸ªç¬¦å·æœ¬èº«ä»£è¡¨äº†ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„åœ°å€å¸¸é‡</li></ul><p>(æ³¨æ„ : æ•°ç»„åæ°¸è¿œéƒ½ä¸ä¼šæ˜¯æŒ‡é’ˆ!), ä½†å¯¹äºè¿™ä¸ªæ•°ç»„çš„å¤§å°, æˆ‘ä»¬å¯ä»¥è¿›è¡ŒåŠ¨æ€åˆ†é…</p><p>æ³¨æ„ ï¼šå¦‚æœç»“æ„ä½“æ˜¯é€šè¿‡callocã€mallocæˆ– è€…newç­‰åŠ¨æ€åˆ†é…æ–¹å¼ç”Ÿæˆï¼Œåœ¨ä¸éœ€è¦æ—¶è¦é‡Šæ”¾ç›¸åº”çš„ç©ºé—´ã€‚</p><ul><li><p>ä¼˜ç‚¹ ï¼šæ¯”èµ·åœ¨ç»“æ„ä½“ä¸­å£°æ˜ä¸€ä¸ªæŒ‡é’ˆå˜é‡ã€å†è¿›è¡ŒåŠ¨æ€åˆ† é…çš„åŠæ³•ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡è¦é«˜ã€‚å› ä¸ºåœ¨è®¿é—®æ•°ç»„å†…å®¹æ—¶ï¼Œä¸éœ€è¦é—´æ¥è®¿é—®ï¼Œé¿å…äº†ä¸¤æ¬¡è®¿å­˜ã€‚</p></li><li><p>ç¼ºç‚¹ ï¼šåœ¨ç»“æ„ä½“ä¸­ï¼Œæ•°ç»„ä¸º0çš„æ•°ç»„å¿…é¡»åœ¨æœ€åå£°æ˜ï¼Œä½¿ ç”¨ä¸Šæœ‰ä¸€å®šé™åˆ¶ã€‚</p></li></ul><p>å¯¹äºç¼–è¯‘å™¨è€Œè¨€, æ•°ç»„åä»…ä»…æ˜¯ä¸€ä¸ªç¬¦å·, å®ƒä¸ä¼šå ç”¨ä»»ä½•ç©ºé—´, å®ƒåœ¨ç»“æ„ä½“ä¸­, åªæ˜¯ä»£è¡¨äº†ä¸€ä¸ªåç§»é‡, ä»£è¡¨ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„åœ°å€å¸¸é‡!</p><h2 id="0é•¿åº¦æ•°ç»„çš„ç”¨é€”"><a href="#0é•¿åº¦æ•°ç»„çš„ç”¨é€”" class="headerlink" title="0é•¿åº¦æ•°ç»„çš„ç”¨é€”"></a>0é•¿åº¦æ•°ç»„çš„ç”¨é€”</h2><p>æˆ‘ä»¬è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯, æˆ‘ä»¬åœ¨ç½‘ç»œé€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®ç¼“å†²åŒº, ç¼“å†²åŒºåŒ…æ‹¬ä¸€ä¸ªlenå­—æ®µå’Œdataå­—æ®µ, åˆ†åˆ«æ ‡è¯†æ•°æ®çš„é•¿åº¦å’Œä¼ è¾“çš„æ•°æ®, æˆ‘ä»¬å¸¸è§çš„æœ‰å‡ ç§è®¾è®¡æ€è·¯ï¼š</p><ul><li>å®šé•¿æ•°æ®ç¼“å†²åŒº, è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§å° MAX_LENGTH çš„æ•°æ®ç¼“å†²åŒº</li><li>è®¾ç½®ä¸€ä¸ªæŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆ, æ¯æ¬¡ä½¿ç”¨æ—¶, æŒ‰ç…§æ•°æ®çš„é•¿åº¦åŠ¨æ€çš„å¼€è¾Ÿæ•°æ®ç¼“å†²åŒºçš„ç©ºé—´</li></ul><p>æˆ‘ä»¬ä»å®é™…åœºæ™¯ä¸­åº”ç”¨çš„è®¾è®¡æ¥è€ƒè™‘ä»–ä»¬çš„ä¼˜åŠ£. ä¸»è¦è€ƒè™‘çš„æœ‰, ç¼“å†²åŒºç©ºé—´çš„å¼€è¾Ÿ, é‡Šæ”¾å’Œè®¿é—®ã€‚</p><h3 id="å®šé•¿åŒ…-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®"><a href="#å®šé•¿åŒ…-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®" class="headerlink" title="å®šé•¿åŒ…(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)"></a>å®šé•¿åŒ…(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)</h3><p>æ¯”å¦‚æˆ‘è¦å‘é€ 1024 å­—èŠ‚çš„æ•°æ®, å¦‚æœç”¨å®šé•¿åŒ…, å‡è®¾å®šé•¿åŒ…çš„é•¿åº¦ MAX_LENGTH ä¸º 2048, å°±ä¼šæµªè´¹ 1024 ä¸ªå­—èŠ‚çš„ç©ºé—´, ä¹Ÿä¼šé€ æˆä¸å¿…è¦çš„æµé‡æµªè´¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//  å®šé•¿ç¼“å†²åŒº</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">max_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    data[MAX_LENGTH];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>æ•°æ®ç»“æ„å¤§å°ï¼šè€ƒè™‘å¯¹é½, é‚£ä¹ˆæ•°æ®ç»“æ„çš„å¤§å° &gt;&#x3D; sizeof(int) + sizeof(char) * MAX_LENGTH</li></ul><p>ç”±äºè€ƒè™‘åˆ°æ•°æ®çš„æº¢å‡º, å˜é•¿æ•°æ®åŒ…ä¸­çš„ data æ•°ç»„é•¿åº¦ä¸€èˆ¬ä¼šè®¾ç½®å¾—è¶³å¤Ÿé•¿è¶³ä»¥å®¹çº³æœ€å¤§çš„æ•°æ®, å› æ­¤ max_buffer ä¸­çš„ data æ•°ç»„å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ²¡æœ‰å¡«æ»¡æ•°æ®, å› æ­¤é€ æˆäº†æµªè´¹</p><ul><li>æ•°æ®åŒ…çš„æ„é€ ï¼šå‡å¦‚æˆ‘ä»¬è¦å‘é€ CURR_LENGTH &#x3D; 1024 ä¸ªå­—èŠ‚, æˆ‘ä»¬å¦‚ä½•æ„é€ è¿™ä¸ªæ•°æ®åŒ…å‘¢ï¼›ä¸€èˆ¬æ¥è¯´, æˆ‘ä»¬ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ç¼“å†²åŒºæ•°æ®ç»“æ„ max_buffer çš„æŒ‡é’ˆï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">///  å¼€è¾Ÿ</span><br><span class="hljs-keyword">if</span> ((mbuffer = (<span class="hljs-keyword">struct</span> max_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> max_buffer))) != <span class="hljs-literal">NULL</span>)<br>&#123;<br>    mbuffer-&gt;len = CURR_LENGTH;<br>    <span class="hljs-built_in">memcpy</span>(mbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, mbuffer-&gt;len, mbuffer-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è®¿é—®ï¼šè¿™æ®µå†…å­˜è¦åˆ†ä¸¤éƒ¨åˆ†ä½¿ç”¨ï¼›å‰éƒ¨åˆ† 4 ä¸ªå­—èŠ‚ p-&gt;len, ä½œä¸ºåŒ…å¤´(å°±æ˜¯å¤šå‡ºæ¥çš„é‚£éƒ¨åˆ†)ï¼Œè¿™ä¸ªåŒ…å¤´æ˜¯ç”¨æ¥æè¿°ç´§æ¥ç€åŒ…å¤´åé¢çš„æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ï¼Œè¿™é‡Œæ˜¯ 1024, æ‰€ä»¥å‰å››ä¸ªå­—èŠ‚èµ‹å€¼ä¸º 1024 (æ—¢ç„¶æˆ‘ä»¬è¦æ„é€ ä¸å®šé•¿æ•°æ®åŒ…ï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ…åˆ°åº•æœ‰å¤šé•¿å‘¢ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±å¿…é¡»é€šè¿‡ä¸€ä¸ªå˜é‡æ¥è¡¨æ˜è¿™ä¸ªæ•°æ®åŒ…çš„é•¿åº¦ï¼Œè¿™å°±æ˜¯lençš„ä½œç”¨)ï¼›è€Œç´§æ¥å…¶åçš„å†…å­˜æ˜¯çœŸæ­£çš„æ•°æ®éƒ¨åˆ†, é€šè¿‡ p-&gt;data, æœ€å, è¿›è¡Œä¸€ä¸ª memcpy() å†…å­˜æ‹·è´, æŠŠè¦å‘é€çš„æ•°æ®å¡«å…¥åˆ°è¿™æ®µå†…å­˜å½“ä¸­</li><li>é‡Šæ”¾ï¼šé‚£ä¹ˆå½“ä½¿ç”¨å®Œæ¯•é‡Šæ”¾æ•°æ®çš„ç©ºé—´çš„æ—¶å€™, ç›´æ¥é‡Šæ”¾å°±å¯ä»¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/// é”€æ¯</span><br><span class="hljs-built_in">free</span>(mbuffer);<br>mbuffer = <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>ä½¿ç”¨å®šé•¿æ•°ç»„, ä½œä¸ºæ•°æ®ç¼“å†²åŒº, ä¸ºäº†é¿å…é€ æˆç¼“å†²åŒºæº¢å‡º, æ•°ç»„çš„å¤§å°ä¸€èˆ¬è®¾ä¸ºè¶³å¤Ÿçš„ç©ºé—´ MAX_LENGTH, è€Œå®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­, è¾¾åˆ° MAX_LENGTH é•¿åº¦çš„æ•°æ®å¾ˆå°‘, é‚£ä¹ˆå¤šæ•°æƒ…å†µä¸‹, ç¼“å†²åŒºçš„å¤§éƒ¨åˆ†ç©ºé—´éƒ½æ˜¯æµªè´¹æ‰çš„</li><li>ä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹å¾ˆç®€å•, æ•°æ®ç©ºé—´çš„å¼€è¾Ÿå’Œé‡Šæ”¾ç®€å•, æ— éœ€ç¨‹åºå‘˜è€ƒè™‘é¢å¤–çš„æ“ä½œ</li></ul><h3 id="æŒ‡é’ˆæ•°æ®åŒ…-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®"><a href="#æŒ‡é’ˆæ•°æ®åŒ…-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®" class="headerlink" title="æŒ‡é’ˆæ•°æ®åŒ…(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)"></a>æŒ‡é’ˆæ•°æ®åŒ…(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)</h3><p>å¦‚æœä½ å°†ä¸Šé¢çš„é•¿åº¦ä¸º MAX_LENGTH çš„å®šé•¿æ•°ç»„æ¢ä¸ºæŒ‡é’ˆ, æ¯æ¬¡ä½¿ç”¨æ—¶åŠ¨æ€çš„å¼€è¾Ÿ CURR_LENGTH å¤§å°çš„ç©ºé—´, é‚£ä¹ˆå°±é¿å…é€ æˆ MAX_LENGTH - CURR_LENGTH ç©ºé—´çš„æµªè´¹, åªæµªè´¹äº†ä¸€ä¸ªæŒ‡é’ˆåŸŸçš„ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">point_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    *data;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>æ•°æ®ç»“æ„å¤§å°ï¼šè€ƒè™‘å¯¹é½, é‚£ä¹ˆæ•°æ®ç»“æ„çš„å¤§å° &gt;&#x3D; sizeof(int) + sizeof(char *)</li><li>ç©ºé—´åˆ†é…ï¼šä½†æ˜¯ä¹Ÿé€ æˆäº†ä½¿ç”¨åœ¨åˆ†é…å†…å­˜æ—¶ï¼Œéœ€é‡‡ç”¨ä¸¤æ­¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// =====================</span><br> <span class="hljs-comment">// æŒ‡é’ˆæ•°ç»„  å ç”¨-å¼€è¾Ÿ-é”€æ¯</span><br> <span class="hljs-comment">// =====================</span><br> <span class="hljs-comment">///  å ç”¨</span><br> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the length of struct test3:%d\n&quot;</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> point_buffer));<br> <span class="hljs-comment">///  å¼€è¾Ÿ</span><br> <span class="hljs-keyword">if</span> ((pbuffer = (<span class="hljs-keyword">struct</span> point_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> point_buffer))) != <span class="hljs-literal">NULL</span>)<br> &#123;<br>     pbuffer-&gt;len = CURR_LENGTH;<br>     <span class="hljs-keyword">if</span> ((pbuffer-&gt;data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>) * CURR_LENGTH)) != <span class="hljs-literal">NULL</span>)<br>     &#123;<br>         <span class="hljs-built_in">memcpy</span>(pbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, pbuffer-&gt;len, pbuffer-&gt;data);<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆ, éœ€ä¸ºç»“æ„ä½“åˆ†é…ä¸€å—å†…å­˜ç©ºé—´ï¼›å…¶æ¬¡å†ä¸ºç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜ç©ºé—´ã€‚</p><p>è¿™æ ·ä¸¤æ¬¡åˆ†é…çš„å†…å­˜æ˜¯ä¸è¿ç»­çš„, éœ€è¦åˆ†åˆ«å¯¹å…¶è¿›è¡Œç®¡ç†. å½“ä½¿ç”¨é•¿åº¦ä¸ºçš„æ•°ç»„æ—¶, åˆ™æ˜¯é‡‡ç”¨ä¸€æ¬¡åˆ†é…çš„åŸåˆ™, ä¸€æ¬¡æ€§å°†æ‰€éœ€çš„å†…å­˜å…¨éƒ¨åˆ†é…ç»™å®ƒã€‚</p><ul><li>é‡Šæ”¾ï¼šç›¸å, é‡Šæ”¾æ—¶ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/// é”€æ¯</span><br><span class="hljs-built_in">free</span>(pbuffer-&gt;data);<br><span class="hljs-built_in">free</span>(pbuffer);<br>pbuffer = <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><ul><li><p>å°ç»“ï¼š</p></li><li><ul><li>ä½¿ç”¨æŒ‡é’ˆç»“æœä½œä¸ºç¼“å†²åŒº, åªå¤šä½¿ç”¨äº†ä¸€ä¸ªæŒ‡é’ˆå¤§å°çš„ç©ºé—´, æ— éœ€ä½¿ç”¨ MAX_LENGTH é•¿åº¦çš„æ•°ç»„, ä¸ä¼šé€ æˆç©ºé—´çš„å¤§é‡æµªè´¹</li><li>ä½†é‚£æ˜¯å¼€è¾Ÿç©ºé—´æ—¶, éœ€è¦é¢å¤–å¼€è¾Ÿæ•°æ®åŸŸçš„ç©ºé—´, æ–½æ”¾æ—¶å€™ä¹Ÿéœ€è¦æ˜¾ç¤ºé‡Šæ”¾æ•°æ®åŸŸçš„ç©ºé—´, ä½†æ˜¯å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­, å¾€å¾€åœ¨å‡½æ•°ä¸­å¼€è¾Ÿç©ºé—´, ç„¶åè¿”å›ç»™ä½¿ç”¨è€…æŒ‡å‘ struct point_buffer çš„æŒ‡é’ˆ, è¿™æ—¶å€™æˆ‘ä»¬å¹¶ä¸èƒ½å‡å®šä½¿ç”¨è€…äº†è§£æˆ‘ä»¬å¼€è¾Ÿçš„ç»†èŠ‚, å¹¶æŒ‰ç…§çº¦å®šçš„æ“ä½œé‡Šæ”¾ç©ºé—´, å› æ­¤ä½¿ç”¨èµ·æ¥å¤šæœ‰ä¸ä¾¿, ç”šè‡³é€ æˆå†…å­˜æ³„æ¼ã€‚</li></ul></li></ul><h3 id="å˜é•¿æ•°æ®ç¼“å†²åŒº-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®"><a href="#å˜é•¿æ•°æ®ç¼“å†²åŒº-å¼€è¾Ÿç©ºé—´-é‡Šæ”¾-è®¿é—®" class="headerlink" title="å˜é•¿æ•°æ®ç¼“å†²åŒº(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)"></a>å˜é•¿æ•°æ®ç¼“å†²åŒº(å¼€è¾Ÿç©ºé—´, é‡Šæ”¾, è®¿é—®)</h3><p>å®šé•¿æ•°ç»„ä½¿ç”¨æ–¹ä¾¿, ä½†æ˜¯å´æµªè´¹ç©ºé—´, æŒ‡é’ˆå½¢å¼åªå¤šä½¿ç”¨äº†ä¸€ä¸ªæŒ‡é’ˆçš„ç©ºé—´, ä¸ä¼šé€ æˆå¤§é‡ç©ºé—´åˆ†æµªè´¹, ä½†æ˜¯ä½¿ç”¨èµ·æ¥éœ€è¦å¤šæ¬¡åˆ†é…, å¤šæ¬¡é‡Šæ”¾, é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§å®ç°æ–¹å¼èƒ½å¤Ÿæ—¢ä¸æµªè´¹ç©ºé—´, åˆä½¿ç”¨æ–¹ä¾¿çš„å‘¢?</p><p>GNU C çš„0é•¿åº¦æ•°ç»„, ä¹Ÿå«å˜é•¿æ•°ç»„, æŸ”æ€§æ•°ç»„å°±æ˜¯è¿™æ ·ä¸€ä¸ªæ‰©å±•. å¯¹äº0é•¿æ•°ç»„çš„è¿™ä¸ªç‰¹ç‚¹ï¼Œå¾ˆå®¹æ˜“æ„é€ å‡ºå˜æˆç»“æ„ä½“ï¼Œå¦‚ç¼“å†²åŒºï¼Œæ•°æ®åŒ…ç­‰ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//  0é•¿åº¦æ•°ç»„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zero_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>æ•°æ®ç»“æ„å¤§å°ï¼šè¿™æ ·çš„å˜é•¿æ•°ç»„å¸¸ç”¨äºç½‘ç»œé€šä¿¡ä¸­æ„é€ ä¸å®šé•¿æ•°æ®åŒ…, ä¸ä¼šæµªè´¹ç©ºé—´æµªè´¹ç½‘ç»œæµé‡, å› ä¸ºchar data[0]; åªæ˜¯ä¸ªæ•°ç»„å, æ˜¯ä¸å ç”¨å­˜å‚¨ç©ºé—´çš„ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> zero_buffer) = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)<br></code></pre></td></tr></table></figure><ul><li>å¼€è¾Ÿç©ºé—´ï¼šé‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™, åªéœ€è¦å¼€è¾Ÿä¸€æ¬¡ç©ºé—´å³å¯</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">///  å¼€è¾Ÿ</span><br><span class="hljs-keyword">if</span> ((zbuffer = (<span class="hljs-keyword">struct</span> zero_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> zero_buffer) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>) * CURR_LENGTH)) != <span class="hljs-literal">NULL</span>)<br>&#123;<br>    zbuffer-&gt;len = CURR_LENGTH;<br>    <span class="hljs-built_in">memcpy</span>(zbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, zbuffer-&gt;len, zbuffer-&gt;data);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é‡Šæ”¾ç©ºé—´ï¼šé‡Šæ”¾ç©ºé—´ä¹Ÿæ˜¯ä¸€æ ·çš„, ä¸€æ¬¡é‡Šæ”¾å³å¯</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">///  é”€æ¯</span><br><span class="hljs-built_in">free</span>(zbuffer);<br>zbuffer = <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><ul><li>æ€»ç»“ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// zero_length_array.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_LENGTH      1024</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CURR_LENGTH      512</span><br><br><span class="hljs-comment">//  0é•¿åº¦æ•°ç»„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zero_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    data[<span class="hljs-number">0</span>];<br>&#125;__attribute((packed));<br><br><br><span class="hljs-comment">//  å®šé•¿æ•°ç»„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">max_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    data[MAX_LENGTH];<br>&#125;__attribute((packed));<br><br><br><span class="hljs-comment">//  æŒ‡é’ˆæ•°ç»„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">point_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span>     len;<br>    <span class="hljs-type">char</span>    *data;<br>&#125;__attribute((packed));<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zero_buffer</span>  *<span class="hljs-title">zbuffer</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">max_buffer</span>   *<span class="hljs-title">mbuffer</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">point_buffer</span> *<span class="hljs-title">pbuffer</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">// 0é•¿åº¦æ•°ç»„  å ç”¨-å¼€è¾Ÿ-é”€æ¯</span><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">///  å ç”¨</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the length of struct test1:%d\n&quot;</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> zero_buffer));<br>    <span class="hljs-comment">///  å¼€è¾Ÿ</span><br>    <span class="hljs-keyword">if</span> ((zbuffer = (<span class="hljs-keyword">struct</span> zero_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> zero_buffer) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>) * CURR_LENGTH)) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        zbuffer-&gt;len = CURR_LENGTH;<br>        <span class="hljs-built_in">memcpy</span>(zbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, zbuffer-&gt;len, zbuffer-&gt;data);<br>    &#125;<br>    <span class="hljs-comment">///  é”€æ¯</span><br>    <span class="hljs-built_in">free</span>(zbuffer);<br>    zbuffer = <span class="hljs-literal">NULL</span>;<br><br><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">// å®šé•¿æ•°ç»„  å ç”¨-å¼€è¾Ÿ-é”€æ¯</span><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">///  å ç”¨</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the length of struct test2:%d\n&quot;</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> max_buffer));<br>    <span class="hljs-comment">///  å¼€è¾Ÿ</span><br>    <span class="hljs-keyword">if</span> ((mbuffer = (<span class="hljs-keyword">struct</span> max_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> max_buffer))) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        mbuffer-&gt;len = CURR_LENGTH;<br>        <span class="hljs-built_in">memcpy</span>(mbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, mbuffer-&gt;len, mbuffer-&gt;data);<br>    &#125;<br>    <span class="hljs-comment">/// é”€æ¯</span><br>    <span class="hljs-built_in">free</span>(mbuffer);<br>    mbuffer = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">// æŒ‡é’ˆæ•°ç»„  å ç”¨-å¼€è¾Ÿ-é”€æ¯</span><br>    <span class="hljs-comment">// =====================</span><br>    <span class="hljs-comment">///  å ç”¨</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the length of struct test3:%d\n&quot;</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> point_buffer));<br>    <span class="hljs-comment">///  å¼€è¾Ÿ</span><br>    <span class="hljs-keyword">if</span> ((pbuffer = (<span class="hljs-keyword">struct</span> point_buffer *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> point_buffer))) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        pbuffer-&gt;len = CURR_LENGTH;<br>        <span class="hljs-keyword">if</span> ((pbuffer-&gt;data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>) * CURR_LENGTH)) != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">memcpy</span>(pbuffer-&gt;data, <span class="hljs-string">&quot;Hello World&quot;</span>, CURR_LENGTH);<br><br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d, %s\n&quot;</span>, pbuffer-&gt;len, pbuffer-&gt;data);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/// é”€æ¯</span><br>    <span class="hljs-built_in">free</span>(pbuffer-&gt;data);<br>    <span class="hljs-built_in">free</span>(pbuffer);<br>    pbuffer = <span class="hljs-literal">NULL</span>;<br><br><br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsä¸­natä¸sitä½å›¾ç®¡ç†</title>
    <link href="/2023/10/04/f2fs%E4%B8%ADnat%E4%B8%8Esit%E4%BD%8D%E5%9B%BE%E7%AE%A1%E7%90%86/"/>
    <url>/2023/10/04/f2fs%E4%B8%ADnat%E4%B8%8Esit%E4%BD%8D%E5%9B%BE%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsä¸­natä¸sitä½å›¾ç®¡ç†"><a href="#f2fsä¸­natä¸sitä½å›¾ç®¡ç†" class="headerlink" title="f2fsä¸­natä¸sitä½å›¾ç®¡ç†"></a>f2fsä¸­natä¸sitä½å›¾ç®¡ç†</h1><blockquote><p>éƒ¨åˆ†å‚è€ƒï¼š<a href="https://blog.csdn.net/wenj12/article/details/115414147">https://blog.csdn.net/wenj12/article/details/115414147</a></p></blockquote><h2 id="å…³äºNATå’ŒSITçš„æœ‰æ•ˆä½å›¾"><a href="#å…³äºNATå’ŒSITçš„æœ‰æ•ˆä½å›¾" class="headerlink" title="å…³äºNATå’ŒSITçš„æœ‰æ•ˆä½å›¾"></a>å…³äºNATå’ŒSITçš„æœ‰æ•ˆä½å›¾</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> &#123;</span> <span class="hljs-comment">//node manager ä¿¡æ¯</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-type">char</span> *nat_bitmap;<span class="hljs-comment">/* NAT bitmap pointer */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> &#123;</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-type">char</span> *sit_bitmap;<span class="hljs-comment">/* SIT bitmap pointer */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨<strong>sbi-&gt;f2fs_nm_info-&gt;nat_bitmap</strong>ä¸­æ˜¯NATçš„ä½å›¾ï¼Œ<strong>sbi-&gt;sit_info-&gt;sit_bitmap</strong>ä¸ºSITçš„ä½å›¾ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> &#123;</span><br>__le64 checkpoint_ver;<span class="hljs-comment">/* checkpoint block version number */</span><br>__le64 user_block_count;<span class="hljs-comment">/* # of user blocks */</span><br>__le64 valid_block_count;<span class="hljs-comment">/* # of valid blocks in main area */</span><br>__le32 rsvd_segment_count;<span class="hljs-comment">/* # of reserved segments for gc */</span><br>__le32 overprov_segment_count;<span class="hljs-comment">/* # of overprovision segments */</span><br>__le32 free_segment_count;<span class="hljs-comment">/* # of free segments in main area */</span><br><br><span class="hljs-comment">/* information of current node segments */</span><br>__le32 cur_node_segno[MAX_ACTIVE_NODE_LOGS];<br>__le16 cur_node_blkoff[MAX_ACTIVE_NODE_LOGS];<br><span class="hljs-comment">/* information of current data segments */</span><br>__le32 cur_data_segno[MAX_ACTIVE_DATA_LOGS];<br>__le16 cur_data_blkoff[MAX_ACTIVE_DATA_LOGS];<br>__le32 ckpt_flags;<span class="hljs-comment">/* Flags : umount and journal_present */</span><br>__le32 cp_pack_total_block_count;<span class="hljs-comment">/* total # of one cp pack */</span><br>__le32 cp_pack_start_sum;<span class="hljs-comment">/* start block number of data summary */</span><br>__le32 valid_node_count;<span class="hljs-comment">/* Total number of valid nodes */</span><br>__le32 valid_inode_count;<span class="hljs-comment">/* Total number of valid inodes */</span><br>__le32 next_free_nid;<span class="hljs-comment">/* Next free node number */</span><br>__le32 sit_ver_bitmap_bytesize;<span class="hljs-comment">/* Default value 64 */</span><br>__le32 nat_ver_bitmap_bytesize; <span class="hljs-comment">/* Default value 256 */</span><br>__le32 checksum_offset;<span class="hljs-comment">/* checksumæ ¡éªŒå’Œ offset inside cp block */</span><br>__le64 elapsed_time;<span class="hljs-comment">/* mounted time */</span><br><span class="hljs-comment">/* allocation type of current segment */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> alloc_type[MAX_ACTIVE_LOGS];<br><br><span class="hljs-comment">/* SIT and NAT version bitmap */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sit_nat_version_bitmap[];  <span class="hljs-comment">// å¯å˜æ•°ç»„/æŸ”æ€§æ•°ç»„</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>ä½å›¾åœ¨ç£ç›˜ä¸Šæ˜¯å­˜å‚¨åœ¨f2fs_checkpointé‡Œçš„sit_nat_version_bitmapï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ç¡®å®šckptçš„sit_nat_version_bitmapä¸­ï¼Œnatå’Œsitä½å›¾çš„ä½ç½®</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *__bitmap_ptr(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">int</span> flag)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> *<span class="hljs-title">ckpt</span> =</span> F2FS_CKPT(sbi);<br><span class="hljs-type">int</span> offset = (flag == NAT_BITMAP) ?<br>le32_to_cpu(ckpt-&gt;sit_ver_bitmap_bytesize) : <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> &amp;ckpt-&gt;sit_nat_version_bitmap + offset;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±ä¸Šè¿°å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œsitå’ŒNATä½å›¾åœ¨sit_nat_version_bitmapä¸­æ˜¯ç´§æŒ¨ç€ï¼Œå…¶ä¸­sitåœ¨å‰éƒ¨åˆ†ï¼Œnatåœ¨åéƒ¨åˆ†ã€‚</p><h2 id="ä½å›¾å¤§å°ä¸cp-payload"><a href="#ä½å›¾å¤§å°ä¸cp-payload" class="headerlink" title="ä½å›¾å¤§å°ä¸cp_payload"></a>ä½å›¾å¤§å°ä¸cp_payload</h2><h3 id="ä½å›¾å¤§å°"><a href="#ä½å›¾å¤§å°" class="headerlink" title="ä½å›¾å¤§å°"></a>ä½å›¾å¤§å°</h3><p>ä»f2fs_checkpointç»“æ„ä½“å®šä¹‰å¯ä»¥æ‰¾åˆ°ä½å›¾çš„å¤§å°ï¼Œsit_ver_bitmap_bytesizeä½äº0x20009cï¼Œnat_ver_bitmap_bytesizeä½äº0x2000a0ï¼›</p><img src="/2023/10/04/f2fs%E4%B8%ADnat%E4%B8%8Esit%E4%BD%8D%E5%9B%BE%E7%AE%A1%E7%90%86/image-20231004224145996.png" alt="image-20231004224145996" style="zoom: 50%;"><p>âœ…<strong>è¿™2ä¸ªæ•°å€¼åœ¨æˆ‘ä»¬æ ¼å¼åŒ–ç£ç›˜mkfs.f2fsçš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// external\f2fs-tools\mkfs\f2fs_format.c</span><br><br>set_cp(sit_ver_bitmap_bytesize, ((get_sb(segment_count_sit) / <span class="hljs-number">2</span>) &lt;&lt; get_sb(log_blocks_per_seg)) / <span class="hljs-number">8</span>);<br><br>set_cp(nat_ver_bitmap_bytesize, ((get_sb(segment_count_nat) / <span class="hljs-number">2</span>) &lt;&lt; get_sb(log_blocks_per_seg)) / <span class="hljs-number">8</span>);<br></code></pre></td></tr></table></figure><p>sitçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ã€natçš„è®¡ç®—åŒç†ã€‘ï¼š</p><ul><li><p>è·å–f2fs_super_blockä¸­çš„segment_count_sitå€¼ï¼ˆçœ‹çœ‹sitæ€»å…±å äº†å‡ ä¸ªsegmentï¼‰ï¼Œç„¶åé™¤ä»¥2ã€å› ä¸ºsitåŒºåŸŸæ˜¯ä¸»å¤‡çš„ã€‘</p></li><li><p>è·å–f2fs_super_blockä¸­çš„log_blocks_per_segå€¼ï¼ˆæŸ¥çœ‹ä¸€ä¸ªsegmentæœ‰å‡ ä¸ªblockï¼Œå½“ç„¶è¿™é‡Œå–äº†åº•ä¸º2çš„å¯¹æ•°ï¼‰</p></li><li><p>æˆ‘ä»¬é€šè¿‡ <strong>&lt;&lt;</strong> ä½è¿ç®—å°±å¯ä»¥ç®—å‡ºä¸€ä¸ªsitåŒºåŸŸæ€»å…±æœ‰å¤šå°‘ä¸ªblock</p></li><li><p>è®¡ç®—å‡ºæ¥çš„å€¼é™¤ä»¥8ï¼Œå› ä¸ºf2fs_checkpointç»“æ„ä½“å˜é‡sit_nat_version_bitmapä¸º<strong>unsigned char</strong>ç±»å‹ï¼ˆå°±æ˜¯8ä½ï¼‰</p></li></ul><blockquote><p>è¿™é‡Œå¯èƒ½æœ‰ç‚¹å°å°å¿˜è®°sitå’Œnatçš„<a href="https://anmuxixixi.github.io/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/">ä¸»å¤‡æœºåˆ¶</a>äº†ï¼š</p><img src="/2023/10/04/f2fs%E4%B8%ADnat%E4%B8%8Esit%E4%BD%8D%E5%9B%BE%E7%AE%A1%E7%90%86/e70cb7105d434b019d36cf0992dd232f.jpeg" alt="img" style="zoom: 67%;"></blockquote><h3 id="cp-payload"><a href="#cp-payload" class="headerlink" title="cp_payload"></a>cp_payload</h3><p>é¦–å…ˆè§£é‡Šä¸€ä¸‹cp_payloadè¿™ä¸ªå­—æ®µï¼Œç”±äºåœ¨f2fsçš„cp packä¸­çš„ç¬¬ä¸€ä¸ªå—æœ¬æ¥åº”è¯¥æ”¾ç½®f2fs_checkpointè¿™ä¸ªæ•°æ®ç»“æ„çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°è¿™ä¸ªæ•°æ®ç»“æ„çš„å¤§å°ä¸å¤Ÿä¸€ä¸ªblockï¼Œä¹Ÿå°±æ˜¯è¿˜æœ‰å‰©ä½™çš„ç©ºé—´ï¼Œæ‰€ä»¥å½“sit&#x2F;nat version bitmapæ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªbitmapæ˜¯éœ€è¦é¢å¤–çš„ç©ºé—´æ¥ä¿å­˜çš„ï¼Œæ‰€ä»¥cp_payloadè®°å½•çš„å°±æ˜¯è¿™ä¸ªé¢å¤–çš„ç©ºé—´çš„å—çš„æ•°é‡ã€‚</p><img src="/2023/10/04/f2fs%E4%B8%ADnat%E4%B8%8Esit%E4%BD%8D%E5%9B%BE%E7%AE%A1%E7%90%86/image-20231004225233756.png" alt="image-20231004225233756" style="zoom:80%;"><blockquote><p>å›¾ç‰‡æºè‡ªçŸ¥ä¹LZTï¼š<a href="https://zhuanlan.zhihu.com/p/639115192">https://zhuanlan.zhihu.com/p/639115192</a></p></blockquote><h3 id="ä½å›¾ç®¡ç†ä¸ä¸»å¤‡æœºåˆ¶"><a href="#ä½å›¾ç®¡ç†ä¸ä¸»å¤‡æœºåˆ¶" class="headerlink" title="ä½å›¾ç®¡ç†ä¸ä¸»å¤‡æœºåˆ¶"></a>ä½å›¾ç®¡ç†ä¸ä¸»å¤‡æœºåˆ¶</h3><p>å½“æˆ‘ä»¬éœ€è¦é€šè¿‡nidè·å–nodeçš„åœ°å€æ—¶ï¼Œå¯èƒ½ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼šã€è¯¦è§-&gt;sitå’Œnatçš„<a href="https://anmuxixixi.github.io/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/">ä¸»å¤‡æœºåˆ¶</a>ã€‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">pgoff_t</span> <span class="hljs-title function_">current_nat_addr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">nid_t</span> start)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> *<span class="hljs-title">nm_i</span> =</span> NM_I(sbi);<br><span class="hljs-type">pgoff_t</span> block_off;<br><span class="hljs-type">pgoff_t</span> block_addr;<br><br>    <span class="hljs-comment">// è®¡ç®—åç§»é‡</span><br>block_off = NAT_BLOCK_OFFSET(start);<br><br>    <span class="hljs-comment">// è®¡ç®—åœ¨ä¸»åŒºä¸­çš„åç§»é‡</span><br>block_addr = (<span class="hljs-type">pgoff_t</span>)(nm_i-&gt;nat_blkaddr +<br>(block_off &lt;&lt; <span class="hljs-number">1</span>) -<br>(block_off &amp; (sbi-&gt;blocks_per_seg - <span class="hljs-number">1</span>)));<br><br>    <span class="hljs-comment">// nat_bitmapæŒ‡æ˜æ˜¯åœ¨ä¸»åŒºè¿˜æ˜¯å¤‡åŒº</span><br>    <span class="hljs-comment">// å¦‚æœåœ¨å¤‡åŒºï¼Œè¿˜è¦åŠ ä¸Šblocks_per_seg</span><br><span class="hljs-keyword">if</span> (f2fs_test_bit(block_off, nm_i-&gt;nat_bitmap))<br>block_addr += sbi-&gt;blocks_per_seg;<br><br><span class="hljs-keyword">return</span> block_addr;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é€šè¿‡f2fs_test_bitæ¥åˆ¤æ–­nidå¯¹åº”çš„node blockæ˜¯åœ¨natçš„ä¸»åŒºè¿˜æ˜¯å¤‡åŒºä¸­ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//addræ˜¯char(8bit)ç±»å‹æ•°ç»„çš„ä½å›¾ï¼Œnrä¸ºåç§»é‡ï¼Œå¾—åˆ°nrå¤„çš„ä½å›¾çŠ¶å†µ</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_test_bit</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr, <span class="hljs-type">char</span> *addr)</span><br>&#123;<br><span class="hljs-type">int</span> mask;<br><br>addr += (nr &gt;&gt; <span class="hljs-number">3</span>);<span class="hljs-comment">//æ‰¾åˆ°nrå±äºå“ªä¸ªå­—èŠ‚</span><br>mask = <span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">7</span> - (nr &amp; <span class="hljs-number">0x07</span>));<span class="hljs-comment">//nr &amp; 0x07å°±æ˜¯nr%8ï¼Œ7-ä»–=ä»åé¢æ•°çš„ç¬¬å‡ ä½ï¼Œç„¶åå°†1å·¦ç§»è¿™äº›ä½å°±å¾—åˆ°äº†nrå¤„mask</span><br><span class="hljs-keyword">return</span> mask &amp; *addr;<span class="hljs-comment">//æ‹¿ç€maskä¸è¯¥å­—èŠ‚å¤„åšä¸ï¼Œå°±å¾—åˆ°äº†è¯¥ä½çš„çŠ¶å†µ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨f2fs_checkpointåŒºåŸŸä¸­çš„<strong>sit_nat_version_bitmap</strong>å‘ç°è¯¥ä½ä¸º1ï¼Œè¯´æ˜å½“å‰è¿˜åœ¨checkpointåŒºåŸŸè¿˜<strong>æ²¡æœ‰ä¸‹åˆ·</strong>ï¼Œæ‰€ä»¥<strong>éœ€è¦å–å¤‡åŒºä¸­</strong>çš„ã€‚å½“è¿›è¡Œcheckpointæ“ä½œçš„æ—¶å€™ï¼Œä¼šä¸‹åˆ·åˆ°natåŒºåŸŸï¼ŒåŒæ—¶ä½å›¾ä¸­å¯¹åº”çš„ä½ä¸ºè¢«æ¸…ç†ã€‚é‚£ä¹ˆï¼Œä¸‹æ¬¡å†æ¬¡è®¿é—®nidå¯¹åº”çš„node blockåœ°å€æ—¶ï¼Œåœ¨page cacheæ‰¾ä¸åˆ°ï¼Œåœ¨cpåŒºåŸŸçš„nat journalæ‰¾ä¸åˆ°ï¼Œæœ€ç»ˆå›å»natåŒºåŸŸæ‰¾ï¼Œè€ŒcpåŒºåŸŸä½å›¾å·²ç»æ¸…ç†è¿‡äº†ï¼Œæ‰€ä»¥åœ¨ä¸»åŒºå°±å¯ä»¥äº†ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>checkpointç‰ˆæœ¬å·å¦‚ä½•å˜æ¢</title>
    <link href="/2023/10/02/checkpoint%E7%89%88%E6%9C%AC%E5%8F%B7%E5%A6%82%E4%BD%95%E5%8F%98%E6%8D%A2/"/>
    <url>/2023/10/02/checkpoint%E7%89%88%E6%9C%AC%E5%8F%B7%E5%A6%82%E4%BD%95%E5%8F%98%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="checkpointç‰ˆæœ¬å·å¦‚ä½•å˜æ¢"><a href="#checkpointç‰ˆæœ¬å·å¦‚ä½•å˜æ¢" class="headerlink" title="checkpointç‰ˆæœ¬å·å¦‚ä½•å˜æ¢"></a>checkpointç‰ˆæœ¬å·å¦‚ä½•å˜æ¢</h1><p>f2fsæ–‡ä»¶ç³»ç»Ÿçš„ç‰ˆæœ¬å¦‚ä½•å˜åŒ–èµ·å§‹è¿˜æ˜¯ä¸€ä¸ªæŒºæœ‰æ„æ€çš„é—®é¢˜ï¼Œè‡ªå·±æ¯æ¬¡æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿåï¼Œå‘ç°checkpointæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼Œæ„Ÿè§‰å°±å¾ˆåƒä¸€ä¸ªéšæœºæ•°ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œä¸€æ¬¡cpåï¼Œç‰ˆæœ¬å·å¦‚ä½•å˜åŒ–å‘¢ï¼Œç°åœ¨å°±ä¸€èµ·ç ”ç©¶ä¸€ä¸‹ã€‚</p><h2 id="1-åˆå§‹åŒ–checkpoint-version"><a href="#1-åˆå§‹åŒ–checkpoint-version" class="headerlink" title="1.åˆå§‹åŒ–checkpoint version"></a>1.åˆå§‹åŒ–checkpoint version</h2><p>æˆ‘ä»¬åˆå§‹åŒ–ç£ç›˜çš„æ–‡ä»¶ç³»ç»Ÿæ—¶å¸¸å¸¸ç”¨åˆ°mkfså‘½ä»¤ï¼Œæ ¼å¼åŒ–f2fsæ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šç”¨åˆ°f2fs-toolsä¸­çš„mkfs.f2fsï¼Œå…¶å¯¹åº”çš„æºç æ–‡ä»¶åœ¨Androidä¸­ä¹ŸåŒ…å«äº†ï¼Œè·¯å¾„ï¼š</p><p><strong>external\f2fs-tools\mkfs</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_check_point_pack</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* 1. cp page 1 of checkpoint pack 1 */</span><br>srand((c.fake_seed) ? <span class="hljs-number">0</span> : time(<span class="hljs-literal">NULL</span>));<br>cp-&gt;checkpoint_ver = cpu_to_le64(rand() | <span class="hljs-number">0x1</span>);<br>    <br>    <span class="hljs-comment">/* cp page 1 of check point pack 2</span><br><span class="hljs-comment"> * Initialize other checkpoint pack with version zero</span><br><span class="hljs-comment">     */</span><br>cp-&gt;checkpoint_ver = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>cp pack1çš„checkpoint versionæ˜¯éšæœºæ•°</li><li>cp pack2çš„checkpoint versionæ˜¯0</li></ul><h2 id="2-ä¸€æ¬¡checkpointåï¼Œç‰ˆæœ¬å·çš„å˜åŒ–"><a href="#2-ä¸€æ¬¡checkpointåï¼Œç‰ˆæœ¬å·çš„å˜åŒ–" class="headerlink" title="2.ä¸€æ¬¡checkpointåï¼Œç‰ˆæœ¬å·çš„å˜åŒ–"></a>2.ä¸€æ¬¡checkpointåï¼Œç‰ˆæœ¬å·çš„å˜åŒ–</h2><p>æºç ï¼šLinux 5.10.8</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> *<span class="hljs-title">ckpt</span> =</span> F2FS_CKPT(sbi);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> ckpt_ver;<br>    <br>    ckpt_ver = cur_cp_version(ckpt);<br>ckpt-&gt;checkpoint_ver = cpu_to_le64(++ckpt_ver);  <span class="hljs-comment">// å°†ckpy_version++</span><br><br>    err = do_checkpoint(sbi, cpc);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br>    start_blk = __start_cp_next_addr(sbi);  <span class="hljs-comment">// start_blkè¡¨ç¤ºçš„æ˜¯å¤‡ä»½cp packçš„èµ·å§‹åœ°å€</span><br> <br>    f2fs_update_meta_page(sbi, ckpt, start_blk++);  <span class="hljs-comment">// å¾€cp packçš„cp page1ä¸­å»å†™ã€æ³¨æ„è¿™é‡Œåªæ˜¯å†™å…¥åˆ°page cacheä¸­ï¼Œè¿˜æ²¡æœ‰è½ç›˜ã€‘</span><br>    <br>    <span class="hljs-comment">/* barrier and flush checkpoint cp pack 2 page if it can */</span><br>commit_checkpoint(sbi, ckpt, start_blk);<br>f2fs_wait_on_all_pages(sbi, F2FS_WB_CP_DATA);<br>    <br>    __set_cp_next_pack(sbi);  <span class="hljs-comment">// å½“å‰cp packåˆ·ç›˜å¥½äº†ï¼Œå°†å¤‡ä»½cpè½¬æ­£</span><br>&#125;<br><br><span class="hljs-comment">// -------------------------------------------------------------------------</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">block_t</span> __start_cp_next_addr(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)<br>&#123;<br><span class="hljs-type">block_t</span> start_addr = le32_to_cpu(F2FS_RAW_SUPER(sbi)-&gt;cp_blkaddr);<br><br><span class="hljs-keyword">if</span> (sbi-&gt;cur_cp_pack == <span class="hljs-number">1</span>)<br>start_addr += sbi-&gt;blocks_per_seg;<br><span class="hljs-keyword">return</span> start_addr;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __set_cp_next_pack(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)<br>&#123;<br>sbi-&gt;cur_cp_pack = (sbi-&gt;cur_cp_pack == <span class="hljs-number">1</span>) ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>âœ…<strong>ä¸€å¥è¯æ€»ç»“</strong>ï¼šè¿›è¡Œä¸€æ¬¡checkpointï¼Œå…¶ç‰ˆæœ¬å·+1</p><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="f2fs-update-meta-pageå‡½æ•°"><a href="#f2fs-update-meta-pageå‡½æ•°" class="headerlink" title="f2fs_update_meta_pageå‡½æ•°"></a>f2fs_update_meta_pageå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_update_meta_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">void</span> *src, <span class="hljs-type">block_t</span> blk_addr)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> f2fs_grab_meta_page(sbi, blk_addr);<br><br><span class="hljs-built_in">memcpy</span>(page_address(page), src, PAGE_SIZE);<br>set_page_dirty(page);<br>f2fs_put_page(page, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†srcæ‹·è´åˆ°pageå¯¹åº”çš„ä½ç½®ï¼Œç„¶åè®¾ç½®è¯¥é¡µä¸ºè„é¡µï¼Œæ¥ç€å°†è¿™ä¸ªé¡µå†™å…¥åˆ°page cacheä¸­</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿçš„write checkpointæµç¨‹åˆ†æ</title>
    <link href="/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <url>/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿçš„write-checkpointæµç¨‹åˆ†æ"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿçš„write-checkpointæµç¨‹åˆ†æ" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿçš„write checkpointæµç¨‹åˆ†æ"></a>f2fsæ–‡ä»¶ç³»ç»Ÿçš„write checkpointæµç¨‹åˆ†æ</h1><p>f2fsæ–‡ä»¶ç³»ç»Ÿåœ¨2ä¸ªåœ°æ–¹éƒ½æœ‰è¿™éƒ¨åˆ†çš„ä»£ç ï¼Œä¸€ä¸ªæ˜¯åŸç”ŸLinuxä»£ç ï¼Œä¸€ä¸ªæ˜¯f2fs-toolså·¥å…·ä¸­çš„ä»£ç ã€‚2ä»½ä»£ç é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ä»£ç ç¼–å†™æ–¹å¼ä¸åŒï¼Œæˆ‘æ¨èå…ˆf2fs-toolsä¸­çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†é€»è¾‘ä»£ç æ›´åŠ æ˜“æ‡‚ï¼Œæ²¡æœ‰æ¶‰åŠæ‰“åˆ°ç¼“å­˜é¡µçš„æ“ä½œã€‚</p><h2 id="1-f2fs-toolsä¸­çš„write-checkpoint"><a href="#1-f2fs-toolsä¸­çš„write-checkpoint" class="headerlink" title="1.f2fs-toolsä¸­çš„write checkpoint"></a>1.f2fs-toolsä¸­çš„write checkpoint</h2><p>è¿™éƒ¨åˆ†æºç æ¥è‡ªäºAndroid 12æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// external\f2fs-tools\fsck\mount.c</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_checkpoints</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-comment">/* copy valid checkpoint to its mirror position */</span><br>duplicate_checkpoint(sbi);<br><br><span class="hljs-comment">/* repair checkpoint at CP #0 position */</span><br>sbi-&gt;cur_cp = <span class="hljs-number">1</span>;<br>write_checkpoint(sbi);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>duplicate_checkpointï¼šå°†cp pack1å’Œcp pack2ä¸­çš„å†…å®¹è¿›è¡Œå¤‡ä»½ï¼Œä¿æŒä¸€è‡´</li><li>sbi-&gt;cur_cp&#x3D;1ï¼šæ—¢ç„¶2ä»½cp packå·²ç»ä¸€è‡´ï¼Œå¾€å“ªä¸€ä¸ªå†™éƒ½è¡Œï¼Œé‚£ä¹ˆç›´æ¥å®šä¹‰å½“å‰è¦å†™çš„cp packä¸ºcp pack1</li><li>write_checkpoinï¼šå‘cp pack1å†™checkpoint</li></ul><h3 id="1-1-å¤‡ä»½cp-pack"><a href="#1-1-å¤‡ä»½cp-pack" class="headerlink" title="1.1 å¤‡ä»½cp pack"></a>1.1 å¤‡ä»½cp pack</h3><p>è¿™é‡Œé¦–å…ˆäº†è§£ä¸€ä¸‹å•ŠCheckpointçš„å¸ƒå±€ã€ä¸»å¤‡æœºåˆ¶ã€‘ï¼š</p><img src="/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/5-1696222445978-1.png" alt="5" style="zoom:80%;"><ul><li>checkpointåŒºåŸŸç”±2ä¸ªcp packç»„æˆï¼Œåˆ†åˆ«ä¸ºcp pack1å’Œcp pack2ï¼Œæ¯ä¸€ä¸ªcp packçš„å¤§å°éƒ½æ˜¯1ä¸ªsegment</li><li>æ¯ä¸€ä¸ªcp packå¤´å°¾éƒ½æœ‰ä¸€ä¸ªcp pageé¡µï¼ˆå¯¹åº”f2fs_checkpointç»“æ„ä½“ï¼‰ï¼Œä¸€èˆ¬2ä¸ªcp pageè¢«ç§°ä¸ºcp page1ã€cp page2æˆ–cp header pageã€cp footer pageã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">duplicate_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_super_block</span> *<span class="hljs-title">sb</span> =</span> F2FS_RAW_SUPER(sbi);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> dst, src;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seg_size = <span class="hljs-number">1</span> &lt;&lt; get_sb(log_blocks_per_seg);<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (sbi-&gt;cp_backuped)<br><span class="hljs-keyword">return</span>;<br><br>buf = <span class="hljs-built_in">malloc</span>(F2FS_BLKSIZE * seg_size);<br><br>    <span class="hljs-comment">// src: å½“å‰è¢«ä½¿ç”¨çš„cp pack</span><br>    <span class="hljs-comment">// dst: å°†å½“å‰ä½¿ç”¨çš„cp packæ‹·è´å¤‡ä»½åˆ°å¦å¤–ä¸€ä¸ªcp pcak</span><br><span class="hljs-keyword">if</span> (sbi-&gt;cur_cp == <span class="hljs-number">1</span>) &#123;        <span class="hljs-comment">// å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ªcp pack</span><br>src = get_sb(cp_blkaddr);<br>dst = src + seg_size;<br>&#125; <span class="hljs-keyword">else</span> &#123;                       <span class="hljs-comment">// å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯ç¬¬äºŒä¸ªcp pack</span><br>dst = get_sb(cp_blkaddr);<br>src = dst + seg_size;<br>&#125;<br><br>ret = dev_read(buf, src &lt;&lt; F2FS_BLKSIZE_BITS, seg_size &lt;&lt; F2FS_BLKSIZE_BITS);<br><br>ret = dev_write(buf, dst &lt;&lt; F2FS_BLKSIZE_BITS,seg_size &lt;&lt; F2FS_BLKSIZE_BITS);<br><br><span class="hljs-built_in">free</span>(buf);<br><br>ret = f2fs_fsync_device();<br>ASSERT(ret &gt;= <span class="hljs-number">0</span>);<br><br>sbi-&gt;cp_backuped = <span class="hljs-number">1</span>;<br><br>MSG(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;Info: Duplicate valid checkpoint to mirror position %llu -&gt; %llu\n&quot;</span>, src, dst);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-å†™checkpoint"><a href="#1-2-å†™checkpoint" class="headerlink" title="1.2 å†™checkpoint"></a>1.2 å†™checkpoint</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">write_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> *<span class="hljs-title">cp</span> =</span> F2FS_CKPT(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_super_block</span> *<span class="hljs-title">sb</span> =</span> F2FS_RAW_SUPER(sbi);<br><span class="hljs-type">block_t</span> orphan_blks = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> cp_blk_no;<br>u32 flags = CP_UMOUNT_FLAG;<br><span class="hljs-type">int</span> i, ret;<br><span class="hljs-type">u_int32_t</span> crc = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (is_set_ckpt_flags(cp, CP_ORPHAN_PRESENT_FLAG)) &#123;<br>orphan_blks = __start_sum_addr(sbi) - <span class="hljs-number">1</span>;<br>flags |= CP_ORPHAN_PRESENT_FLAG;<br>&#125;<br><br><br>    set_cp(checksum_offset, CP_CHKSUM_OFFSET);  <span class="hljs-comment">// #define CP_CHKSUM_OFFSET4092</span><br><br>set_cp(cp_pack_total_block_count, <span class="hljs-number">8</span> + orphan_blks + get_sb(cp_payload));<br><br>flags = update_nat_bits_flags(sb, cp, flags);<br>set_cp(ckpt_flags, flags);<br><br>crc = f2fs_checkpoint_chksum(cp); <span class="hljs-comment">// è®¡ç®—checkpointçš„crcå€¼</span><br>*((__le32 *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)cp + get_cp(checksum_offset))) = cpu_to_le32(crc);  <span class="hljs-comment">// cpåç§»4092å­—èŠ‚çš„ä½ç½®ï¼Œä¿®æ”¹crcå€¼</span><br><br>    <span class="hljs-comment">// è·å–åˆ°çš„cp packçš„èµ·å§‹åœ°å€</span><br>cp_blk_no = get_sb(cp_blkaddr);<br><span class="hljs-keyword">if</span> (sbi-&gt;cur_cp == <span class="hljs-number">2</span>)<br>cp_blk_no += <span class="hljs-number">1</span> &lt;&lt; get_sb(log_blocks_per_seg);<br><br><span class="hljs-comment">// å†™cp pack1çš„cp page1ï¼Œå› ä¸ºcp page1ä¸º1ä¸ªblockï¼Œå†™å®Œåç›´æ¥++</span><br>ret = dev_write_block(cp, cp_blk_no++);<br><br><span class="hljs-comment">/* skip payload */</span><br>cp_blk_no += get_sb(cp_payload);<br><span class="hljs-comment">/* skip orphan blocks */</span><br>cp_blk_no += orphan_blks;<br><br><span class="hljs-comment">/* update summary blocks having nullified journal entries */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NO_CHECK_TYPE; i++) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, i);<br>u64 ssa_blk;<br><br>ret = dev_write_block(curseg-&gt;sum_blk, cp_blk_no++);<br>ASSERT(ret &gt;= <span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span> (!(get_sb(feature) &amp; cpu_to_le32(F2FS_FEATURE_RO))) &#123;<br><span class="hljs-comment">/* update original SSA too */</span><br>ssa_blk = GET_SUM_BLKADDR(sbi, curseg-&gt;segno);<br>ret = dev_write_block(curseg-&gt;sum_blk, ssa_blk);<br>ASSERT(ret &gt;= <span class="hljs-number">0</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/* Write nat bits */</span><br><span class="hljs-keyword">if</span> (flags &amp; CP_NAT_BITS_FLAG)<br>write_nat_bits(sbi, sb, cp, sbi-&gt;cur_cp);<br><br><span class="hljs-comment">/* in case of sudden power off */</span><br>ret = f2fs_fsync_device();<br><br><span class="hljs-comment">// å†™cp packçš„cp page2ï¼Œå…¶å®è¿™é‡Œæ²¡å¿…è¦cp_blk_noäº†</span><br>ret = dev_write_block(cp, cp_blk_no++);<br>    <br>ret = f2fs_fsync_device();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæµç¨‹èµ·æ‰‹å°±æ˜¯åœ¨å¡«å……ä¸‹é¢è¿™å¼ å›¾ä¸­æ¯ä¸ªåŒºåŸŸï¼š</p><img src="/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/5-1696222445978-1.png" alt="5" style="zoom:80%;"><p>å€¼å¾—æ³¨æ„çš„æ˜¯å†™2ä¸ªcp pageé¡µï¼Œcp page1å’Œcp page2ï¼š</p><img src="/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231002131029196.png" alt="image-20231002131029196" style="zoom:67%;"><img src="/2023/10/02/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84write-checkpoint%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20231002131016847.png" alt="image-20231002131016847" style="zoom: 67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">dev_write_block</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf, __u64 blk_addr)</span><br>&#123;<br>    <span class="hljs-comment">// #define F2FS_BLKSIZE 4096 æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªé¡µå¯¹åº”4096å­—èŠ‚ï¼Œä¹Ÿå³f2fsä¸­ä¸€ä¸ªblockå¤§å°ä¸º4096å­—èŠ‚</span><br><span class="hljs-keyword">return</span> dev_write(buf, blk_addr &lt;&lt; F2FS_BLKSIZE_BITS, F2FS_BLKSIZE);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-Linuxæºç ä¸­çš„write-checkpoint"><a href="#2-Linuxæºç ä¸­çš„write-checkpoint" class="headerlink" title="2.Linuxæºç ä¸­çš„write checkpoint"></a>2.Linuxæºç ä¸­çš„write checkpoint</h2><p>è¿™éƒ¨åˆ†æºç æ¥è‡ªäºLinux 5.10.8æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> *<span class="hljs-title">ckpt</span> =</span> F2FS_CKPT(sbi);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> ckpt_ver;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br>err = block_operations(sbi);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> out;<br><br>f2fs_flush_merged_writes(sbi);<br><br>ckpt_ver = cur_cp_version(ckpt);<br>ckpt-&gt;checkpoint_ver = cpu_to_le64(++ckpt_ver);<br><br>err = f2fs_flush_nat_entries(sbi, cpc);<br><br>f2fs_flush_sit_entries(sbi, cpc);<br><br>f2fs_save_inmem_curseg(sbi);<br><br>err = do_checkpoint(sbi, cpc);<br><br>f2fs_restore_inmem_curseg(sbi);<br>stop:<br>unblock_operations(sbi);<br>stat_inc_cp_count(sbi-&gt;stat_info);<br><br>f2fs_update_time(sbi, CP_TIME);<br>trace_f2fs_write_checkpoint(sbi-&gt;sb, cpc-&gt;reason, <span class="hljs-string">&quot;finish checkpoint&quot;</span>);<br>out:<br><span class="hljs-keyword">if</span> (cpc-&gt;reason != CP_RESIZE)<br>mutex_unlock(&amp;sbi-&gt;cp_mutex);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-NATè„æ•°æ®å›å†™"><a href="#2-1-NATè„æ•°æ®å›å†™" class="headerlink" title="2.1 NATè„æ•°æ®å›å†™"></a>2.1 NATè„æ•°æ®å›å†™</h3><blockquote><p>éƒ¨åˆ†å‚è€ƒè‡ªï¼š<a href="https://github.com/RiweiPan/F2FS-NOTES/blob/master/F2FS-Data-Recovery/Checkpoint%E6%B5%81%E7%A8%8B.md">https://github.com/RiweiPan/F2FS-NOTES/blob/master/F2FS-Data-Recovery/Checkpoint%E6%B5%81%E7%A8%8B.md</a></p></blockquote><p><code>f2fs_flush_nat_entries</code> å’Œ <code>f2fs_flush_sit_entries</code> çš„ä½œç”¨æ˜¯å°†æš‚å­˜åœ¨ramçš„nat entryåˆsit entryéƒ½å›å†™åˆ°Journalæˆ–ç£ç›˜å½“ä¸­:</p><h4 id="2-1-1-f2fs-flush-nat-entrieså‡½æ•°"><a href="#2-1-1-f2fs-flush-nat-entrieså‡½æ•°" class="headerlink" title="2.1.1 f2fs_flush_nat_entrieså‡½æ•°"></a>2.1.1 f2fs_flush_nat_entrieså‡½æ•°</h4><p>âœ…ä¿®æ”¹nodeçš„ä¿¡æ¯ä¼šå¯¹å¯¹åº”çš„<code>nat_entry</code>è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶<code>nat_entry</code>ä¼šè¢«è®¾ç½®ä¸ºè„ï¼ŒåŠ å…¥åˆ°<code>nm_i-&gt;nat_set_root</code>çš„radix treeä¸­ã€‚Checkpointä¼šå¯¹è„çš„<code>nat_entry</code>è¿›è¡Œå›å†™ï¼Œå®Œæˆå…ƒæ•°æ®çš„æ›´æ–°ã€‚</p><p>é¦–å…ˆå£°æ˜äº†ä¸€ä¸ªlistå˜é‡<code>LIST_HEAD(sets)</code>ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªwhileå¾ªç¯ï¼Œå°†<code>nat_entry_set</code>æŒ‰ä¸€ä¸ªsetä¸ºå•ä½ï¼Œå¯¹è„çš„<code>nat_entry</code>è¿›è¡Œæå–ï¼Œæ¯æ¬¡æå–SETVEC_SIZEä¸ªï¼Œç„¶åä¿å­˜åˆ°<code>setvec[SETVEC_SIZE]</code>ä¸­ï¼Œç„¶åå¯¹<code>setvec</code>ä¸­çš„æ¯ä¸€ä¸ª<code>nat_entry_set</code>ï¼ŒæŒ‰ç…§ä¸€å®šæ¡ä»¶åŠ å…¥åˆ°<code>LIST_HEAD(sets)</code>çš„é“¾è¡¨ä¸­ã€‚æœ€åé’ˆå¯¹<code>LIST_HEAD(sets)</code>çš„<code>nat_entry_set</code>ï¼Œæ‰§è¡Œ<code>__flush_nat_entry_set</code>å‡½æ•°ï¼Œå¯¹è„æ•°æ®è¿›è¡Œå›å†™ã€‚<code>__flush_nat_entry_set</code>æœ‰ä¸¤ç§å›å†™æ–¹æ³•ï¼Œç¬¬ä¸€ç§æ˜¯å†™å…¥åˆ°cursegçš„journalä¸­ï¼Œç¬¬äºŒç§æ˜¯ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„nat blockï¼Œå›å†™åˆ°ç£ç›˜ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_flush_nat_entries</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> *<span class="hljs-title">nm_i</span> =</span> NM_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, CURSEG_HOT_DATA);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> *<span class="hljs-title">journal</span> =</span> curseg-&gt;journal;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_entry_set</span> *<span class="hljs-title">setvec</span>[<span class="hljs-title">SETVEC_SIZE</span>];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_entry_set</span> *<span class="hljs-title">set</span>, *<span class="hljs-title">tmp</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> found;<br><span class="hljs-type">nid_t</span> set_idx = <span class="hljs-number">0</span>;<br>LIST_HEAD(sets);<br><br><span class="hljs-keyword">if</span> (!nm_i-&gt;dirty_nat_cnt)<br><span class="hljs-keyword">return</span>;<br><br>down_write(&amp;nm_i-&gt;nat_tree_lock);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * __gang_lookup_nat_set è¿™ä¸ªå‡½æ•°å°±æ˜¯ä»radix treeè¯»å–set_idxå¼€å§‹ï¼Œ</span><br><span class="hljs-comment"> * è¿ç»­è¯»å–SETVEC_SIZEè¿™ä¹ˆå¤šä¸ªnat_entry_setï¼Œä¿å­˜åœ¨setvecä¸­</span><br><span class="hljs-comment"> * ç„¶åæŒ‰ç…§ä¸€å®šæ¡ä»¶ï¼Œé€šè¿‡__adjust_nat_entry_setå‡½æ•°åŠ å…¥åˆ°LIST_HEAD(sets)é“¾è¡¨ä¸­</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-keyword">while</span> ((found = __gang_lookup_nat_set(nm_i,<br>set_idx, SETVEC_SIZE, setvec))) &#123;<br><span class="hljs-type">unsigned</span> idx;<br>set_idx = setvec[found - <span class="hljs-number">1</span>]-&gt;<span class="hljs-built_in">set</span> + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>; idx &lt; found; idx++)<br>__adjust_nat_entry_set(setvec[idx], &amp;sets,<br>MAX_NAT_JENTRIES(journal));<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * flush dirty nats in nat entry set</span><br><span class="hljs-comment"> * éå†è¿™ä¸ªlistæ‰€æœ‰çš„nat_entry_setï¼Œç„¶åå†™å…¥åˆ°curseg-&gt;journalä¸­</span><br><span class="hljs-comment"> * */</span><br>list_for_each_entry_safe(<span class="hljs-built_in">set</span>, tmp, &amp;sets, set_list)<br>__flush_nat_entry_set(sbi, <span class="hljs-built_in">set</span>, cpc);<br><br>up_write(&amp;nm_i-&gt;nat_tree_lock);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__flush_nat_entry_set</code>æœ‰ä¸¤ç§å›å†™çš„æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯å†™å…¥åˆ°cursegçš„journalä¸­ï¼Œç¬¬äºŒç§æ˜¯å›å†™åˆ°nat blockä¸­ã€‚</p><p>ç¬¬ä¸€ç§å†™å…¥æ–¹å¼é€šå¸¸æ˜¯ç”±äºcursegæœ‰è¶³å¤Ÿçš„journalçš„æƒ…å†µä¸‹çš„å†™å…¥ï¼Œé¦–å…ˆéå†<code>nat_entry_set</code>ä¸­çš„æ‰€æœ‰<code>nat_entry</code>ï¼Œç„¶åæ ¹æ®nidæ‰¾åˆ°curseg-&gt;journalä¸­å¯¹åº”çš„nat_entryçš„ä½ç½®ï¼Œè·Ÿç€å°†è¢«éå†çš„<code>nat_entry</code>çš„å€¼èµ‹äºˆç»™curseg-&gt;journalçš„<code>nat_entry</code>ï¼Œé€šè¿‡<code>raw_nat_from_node_info</code>å®Œæˆcursegçš„nat_entryçš„æ›´æ–°ã€‚</p><p>ç¬¬äºŒç§å†™å…¥æ–¹å¼åœ¨cursegæ²¡æœ‰è¶³å¤Ÿçš„journalçš„æ—¶å€™è§¦å‘ï¼Œé¦–å…ˆæ ¹æ®nidæ‰¾åˆ°NATåŒºåŸŸçš„å¯¹åº”çš„<code>f2fs_nat_block</code>ï¼Œç„¶åé€šè¿‡<code>get_next_nat_page</code>è¯»å–å‡ºæ¥ï¼Œç„¶åé€šè¿‡<code>raw_nat_from_node_info</code>è¿›è¡Œæ›´æ–°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __flush_nat_entry_set(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,<br><span class="hljs-keyword">struct</span> nat_entry_set *<span class="hljs-built_in">set</span>, <span class="hljs-keyword">struct</span> cp_control *cpc)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, CURSEG_HOT_DATA);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> *<span class="hljs-title">journal</span> =</span> curseg-&gt;journal;<br><span class="hljs-type">nid_t</span> start_nid = <span class="hljs-built_in">set</span>-&gt;<span class="hljs-built_in">set</span> * NAT_ENTRY_PER_BLOCK; <span class="hljs-comment">// æ ¹æ®set numberæ‰¾åˆ°å¯¹åº”f2fs_nat_block</span><br><span class="hljs-type">bool</span> to_journal = <span class="hljs-literal">true</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_block</span> *<span class="hljs-title">nat_blk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_entry</span> *<span class="hljs-title">ne</span>, *<span class="hljs-title">cur</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * there are two steps to flush nat entries:</span><br><span class="hljs-comment"> * #1, flush nat entries to journal in current hot data summary block.</span><br><span class="hljs-comment"> * #2, flush nat entries to nat page.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (enabled_nat_bits(sbi, cpc) ||<br>!__has_cursum_space(journal, <span class="hljs-built_in">set</span>-&gt;entry_cnt, NAT_JOURNAL)) <span class="hljs-comment">//å½“cursegçš„journalç©ºé—´ä¸å¤Ÿäº†ï¼Œå°±åˆ·å†™åˆ°ç£ç›˜ä¸­</span><br>to_journal = <span class="hljs-literal">false</span>;<br><br><span class="hljs-keyword">if</span> (to_journal) &#123;<br>down_write(&amp;curseg-&gt;journal_rwsem);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>page = get_next_nat_page(sbi, start_nid); <span class="hljs-comment">/* æ ¹æ®nidæ‰¾åˆ°ç®¡ç†è¿™ä¸ªnidçš„f2fs_nat_block */</span><br>nat_blk = page_address(page);<br>f2fs_bug_on(sbi, !nat_blk);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * flush dirty nats in nat entry set</span><br><span class="hljs-comment"> * éå†æ‰€æœ‰è„çš„nat_entry</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * nat_entryåªå­˜åœ¨äºå†…å­˜å½“ä¸­ï¼Œå…·ä½“åœ¨ç£ç›˜ä¿å­˜çš„æ˜¯f2fs_entry_block</span><br><span class="hljs-comment"> * */</span><br>list_for_each_entry_safe(ne, cur, &amp;<span class="hljs-built_in">set</span>-&gt;entry_list, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> *<span class="hljs-title">raw_ne</span>;</span><br><span class="hljs-type">nid_t</span> nid = nat_get_nid(ne);<br><span class="hljs-type">int</span> offset;<br><br>f2fs_bug_on(sbi, nat_get_blkaddr(ne) == NEW_ADDR);<br><br><span class="hljs-keyword">if</span> (to_journal) &#123;<br><span class="hljs-comment">// æœç´¢å½“å‰çš„journalä¸­nidæ‰€åœ¨çš„ä½ç½®</span><br>offset = f2fs_lookup_journal_in_cursum(journal,<br>NAT_JOURNAL, nid, <span class="hljs-number">1</span>);<br>f2fs_bug_on(sbi, offset &lt; <span class="hljs-number">0</span>);<br>raw_ne = &amp;nat_in_journal(journal, offset); <span class="hljs-comment">// ä»journalä¸­å–å‡ºf2fs_nat_entryçš„ä¿¡æ¯</span><br>nid_in_journal(journal, offset) = cpu_to_le32(nid); <span class="hljs-comment">// æ›´æ–°journalçš„nid</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>raw_ne = &amp;nat_blk-&gt;entries[nid - start_nid]; <span class="hljs-comment">/* æ‹¿åˆ°nidå¯¹åº”çš„nat_entryåœ°å€ï¼Œä¸‹é¢å¼€å§‹å¡«æ•°æ® */</span><br>&#125;<br>raw_nat_from_node_info(raw_ne, &amp;ne-&gt;ni); <span class="hljs-comment">// å°†node infoçš„ä¿¡æ¯æ›´æ–°åˆ°journalä¸­åè€…ç£ç›˜ä¸­</span><br>nat_reset_flag(ne); <span class="hljs-comment">// æ¸…é™¤éœ€è¦CPçš„æ ‡å¿—</span><br>__clear_nat_cache_dirty(NM_I(sbi), <span class="hljs-built_in">set</span>, ne); <span class="hljs-comment">// ä»dirty listæ¸…é™¤å¤„ç†åçš„entry</span><br><span class="hljs-keyword">if</span> (nat_get_blkaddr(ne) == NULL_ADDR) &#123; <span class="hljs-comment">// å¦‚æœå¯¹åº”nidå·²ç»æ˜¯è¢«æ— æ•ˆåŒ–äº†ï¼Œåˆ™é‡Šæ”¾</span><br>add_free_nid(sbi, nid, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>spin_lock(&amp;NM_I(sbi)-&gt;nid_list_lock);<br>update_free_nid_bitmap(sbi, nid, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// æ›´æ–°å¯ç”¨çš„natçš„bitmap</span><br>spin_unlock(&amp;NM_I(sbi)-&gt;nid_list_lock);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (to_journal) &#123;<br>up_write(&amp;curseg-&gt;journal_rwsem);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>__update_nat_bits(sbi, start_nid, page);<br>f2fs_put_page(page, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/* Allow dirty nats by node block allocation in write_begin */</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">set</span>-&gt;entry_cnt) &#123;<br>radix_tree_delete(&amp;NM_I(sbi)-&gt;nat_set_root, <span class="hljs-built_in">set</span>-&gt;<span class="hljs-built_in">set</span>);<br>kmem_cache_free(nat_entry_set_slab, <span class="hljs-built_in">set</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“checkpoint=disableå¦‚ä½•ä¼ é€’åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“checkpoint-x3D-disableå¦‚ä½•ä¼ é€’åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿ"><a href="#å®‰å“checkpoint-x3D-disableå¦‚ä½•ä¼ é€’åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å®‰å“checkpoint&#x3D;disableå¦‚ä½•ä¼ é€’åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿ"></a>å®‰å“checkpoint&#x3D;disableå¦‚ä½•ä¼ é€’åˆ°f2fsæ–‡ä»¶ç³»ç»Ÿ</h1><h2 id="1-è§£ææŒ‚è½½å‚æ•°å¹¶å¤„ç†"><a href="#1-è§£ææŒ‚è½½å‚æ•°å¹¶å¤„ç†" class="headerlink" title="1.è§£ææŒ‚è½½å‚æ•°å¹¶å¤„ç†"></a>1.è§£ææŒ‚è½½å‚æ•°å¹¶å¤„ç†</h2><p>å½“æˆ‘ä»¬æŒ‚è½½f2fsæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°<strong>f2fs_mount</strong>ï¼Œåé¢çš„è°ƒç”¨æ ˆä¾æ¬¡ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">f2fs_mount<br>    -&gt; mount_bdev<br>    -&gt; f2fs_fill_super <br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_fill_super</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> silent)</span><br>&#123;<br>    default_options(sbi);<br>options = kstrdup((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)data, GFP_KERNEL);<br>err = parse_options(sb, options, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// è§£ææŒ‚è½½å‚æ•°</span><br>    <br>    <span class="hljs-comment">// ...</span><br>    <br>reset_checkpoint:<br><br><span class="hljs-keyword">if</span> (test_opt(sbi, DISABLE_CHECKPOINT)) &#123;<br>err = f2fs_disable_checkpoint(sbi);   <span class="hljs-comment">// å¤„ç†disableå‚æ•°#</span><br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> sync_free_meta;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_set_ckpt_flags(sbi, CP_DISABLED_FLAG)) &#123;<br>f2fs_enable_checkpoint(sbi);<br>&#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-è§£ææŒ‚è½½å‚æ•°"><a href="#1-1-è§£ææŒ‚è½½å‚æ•°" class="headerlink" title="1.1 è§£ææŒ‚è½½å‚æ•°"></a>1.1 è§£ææŒ‚è½½å‚æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">match_table_t</span> f2fs_tokens = &#123;<br><span class="hljs-comment">// ...</span><br>&#123;Opt_checkpoint_disable, <span class="hljs-string">&quot;checkpoint=disable&quot;</span>&#125;,<br>&#123;Opt_checkpoint_disable_cap, <span class="hljs-string">&quot;checkpoint=disable:%u&quot;</span>&#125;,<br>&#123;Opt_checkpoint_disable_cap_perc, <span class="hljs-string">&quot;checkpoint=disable:%u%%&quot;</span>&#125;,<br><span class="hljs-comment">// ...</span><br>&#123;Opt_err, <span class="hljs-literal">NULL</span>&#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parse_options</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">char</span> *options, <span class="hljs-type">bool</span> is_remount)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> ((p = strsep(&amp;options, <span class="hljs-string">&quot;,&quot;</span>)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-type">int</span> token;<br><span class="hljs-keyword">if</span> (!*p)<br><span class="hljs-keyword">continue</span>;<br><br>args[<span class="hljs-number">0</span>].to = args[<span class="hljs-number">0</span>].from = <span class="hljs-literal">NULL</span>;<br>token = match_token(p, f2fs_tokens, args);<br><br><span class="hljs-keyword">switch</span> (token) &#123;<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">case</span> Opt_checkpoint_disable:<br>                set_opt(sbi, DISABLE_CHECKPOINT);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œä»ç”¨æˆ·æ€ä¼ é€’ä¸‹æ¥çš„å‚æ•°æœ€ç»ˆå°±å¹²äº†ä¸€ä»¶äº‹ï¼š<strong>set_opt(sbi, DISABLE_CHECKPOINT)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_OPTION(sbi)((sbi)-&gt;mount_opt)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_opt(sbi, option)(F2FS_OPTION(sbi).opt &amp;= ~F2FS_MOUNT_##option)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_opt(sbi, option)(F2FS_OPTION(sbi).opt |= F2FS_MOUNT_##option)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> test_opt(sbi, option)(F2FS_OPTION(sbi).opt &amp; F2FS_MOUNT_##option)</span><br></code></pre></td></tr></table></figure><p>âœ…ä¸€å¥è¯æ€»ç»“ï¼šcheckpoint&#x3D;disableçš„æœ€ç»ˆå½±å“ä¸ºsbiçš„mount_optå­—æ®µä¼šå¤šä¸€ä¸ªé€‰é¡¹ï¼š<strong>F2FS_MOUNT_DISABLE_CHECKPOINT</strong></p><h3 id="1-2-å¤„ç†DISABLE-CHECKPOINT"><a href="#1-2-å¤„ç†DISABLE-CHECKPOINT" class="headerlink" title="1.2 å¤„ç†DISABLE_CHECKPOINT"></a>1.2 å¤„ç†DISABLE_CHECKPOINT</h3><p>åœ¨f2fs_fill_superé‡Œé¢è®¾ç½®äº†è¯¥DISABLE_CHECKPOINTï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šèµ°è¿›å»åˆ¤æ–­</p><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231006233308177.png" alt="image-20231006233308177" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_disable_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> s_flags = sbi-&gt;sb-&gt;s_flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cp_control</span> <span class="hljs-title">cpc</span>;</span><br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> ret;<br><span class="hljs-type">block_t</span> unusable;<br><br>    <span class="hljs-comment">// æ³¨æ„: checkpoint=disableæ˜¯ä¸å…è®¸è¿è¡Œåœ¨åªè¯»çš„f2fsæ–‡ä»¶ç³»ç»Ÿä¸­</span><br><span class="hljs-keyword">if</span> (s_flags &amp; SB_RDONLY) &#123;<br>f2fs_err(sbi, <span class="hljs-string">&quot;checkpoint=disable on readonly fs&quot;</span>);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>sbi-&gt;sb-&gt;s_flags |= SB_ACTIVE;<br><br>ret = sync_filesystem(sbi-&gt;sb);  <span class="hljs-comment">// è¿™é‡Œä¼šsyncä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œäº†ä¸€æ¬¡checkpoint</span><br><br>unusable = f2fs_get_unusable_blocks(sbi);<br><br>down_write(&amp;sbi-&gt;gc_lock);<br>cpc.reason = CP_PAUSE;   <span class="hljs-comment">// è®¾ç½®cpcçš„åŸå› ä¸ºCP_PAUSE</span><br>set_sbi_flag(sbi, SBI_CP_DISABLED);<br>err = f2fs_write_checkpoint(sbi, &amp;cpc);<br><br>spin_lock(&amp;sbi-&gt;stat_lock);<br>sbi-&gt;unusable_block_count = unusable;<br>spin_unlock(&amp;sbi-&gt;stat_lock);<br><br>out_unlock:<br>up_write(&amp;sbi-&gt;gc_lock);<br>restore_flag:<br>sbi-&gt;sb-&gt;s_flags = s_flags;<span class="hljs-comment">/* Restore SB_RDONLY status */</span><br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¾ç½®å®Œäº†<code>cpc.reason = CP_PAUSE</code>ï¼Œå¹¶ä¸”è®¾ç½®sbiçš„æ ‡å¿—ä¸º<code>SBI_CP_DISABLED</code>ï¼Œç´§æ¥ç€ä¼šè°ƒç”¨ä¸€æ¬¡checkpoint</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_write_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> cp_control *cpc)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (unlikely(is_sbi_flag_set(sbi, SBI_CP_DISABLED))) &#123;<br><span class="hljs-keyword">if</span> (cpc-&gt;reason != CP_PAUSE)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>f2fs_warn(sbi, <span class="hljs-string">&quot;Start checkpoint disabled!&quot;</span>);<br>&#125;<br>    <br>    <span class="hljs-comment">// ä¸‹é¢å°±æ˜¯ä¸€æ¬¡æ­£å¸¸çš„cpæ“ä½œäº†</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-ä»¥åçš„checkpointå½±å“æ˜¯å•¥"><a href="#1-3-ä»¥åçš„checkpointå½±å“æ˜¯å•¥" class="headerlink" title="1.3 ä»¥åçš„checkpointå½±å“æ˜¯å•¥"></a>1.3 ä»¥åçš„checkpointå½±å“æ˜¯å•¥</h3><p>å½“æŒ‚è½½å®Œæˆæ—¶å®Œæˆäº†ä¸€æ¬¡checkpointåï¼Œä¸‹æ¬¡å½“ç”¨æˆ·æ€è°ƒç”¨syncæˆ–è€…å‘¨æœŸè¿›è¡Œcpçš„æ—¶å€™ï¼Œæœ€ç»ˆåˆä¼šè°ƒç”¨åˆ°<strong>f2fs_write_checkpoint</strong></p><p>æ ¹æ®ä¸Šé¢å‘ç°ï¼Œå› ä¸ºæ˜¯syncè¿‡æ¥çš„cpï¼Œæˆ–è€…å‘¨æœŸæ€§çš„cpï¼Œé‚£ä¹ˆcpc-&gt;reasonè‚¯å®šæ˜¯æ²¡æœ‰è®¾ç½®CP_PAUSEçš„ï¼Œé‚£ä¹ˆèµ°åˆ°ifåˆ†æ”¯é‡Œé¢å°±ä¼šreturn 0ï¼Œåé¢æ­£å¸¸çš„cpæµç¨‹å°±ä¸ä¼šèµ°ã€‚</p><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231006235204172.png" alt="image-20231006235204172" style="zoom: 67%;"><p>âœ…ä¸€å¥è¯æ€»ç»“ï¼šè®¾ç½®äº†checkpoint&#x3D;disableåï¼Œé™¤äº†æŒ‚è½½æ—¶å€™èƒ½å¤Ÿå®Œæˆä¸€æ¬¡æ­£å¸¸çš„cpï¼Œåé¢çš„æ¯ä¸€æ¬¡cpéƒ½ä¼šå¤±æ•ˆ</p><h2 id="2-ç”¨æˆ·æºå¸¦äº†checkpoint-x3D-enableé‡æ–°æŒ‚è½½"><a href="#2-ç”¨æˆ·æºå¸¦äº†checkpoint-x3D-enableé‡æ–°æŒ‚è½½" class="headerlink" title="2.ç”¨æˆ·æºå¸¦äº†checkpoint&#x3D;enableé‡æ–°æŒ‚è½½"></a>2.ç”¨æˆ·æºå¸¦äº†checkpoint&#x3D;enableé‡æ–°æŒ‚è½½</h2><p>ä¾‹å¦‚åœ¨Androidä¸­ï¼Œlauncherå¯åŠ¨å®Œæˆåä¼šå›è°ƒcp_commitChangesï¼Œæ­¤æ—¶ä¼šæºå¸¦<strong>checkpoint&#x3D;enable</strong>é‡æ–°æŒ‚è½½ä¸€æ¬¡</p><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231006235540325.png" alt="image-20231006235540325" style="zoom: 60%;"><p>æ³¨æ„è¿™é‡Œæœ‰MS_REMOUNTæ ‡å¿—ï¼Œä¼šé‡æ–°æŒ‚è½½f2fsæ–‡ä»¶ç³»ç»Ÿ</p><p>åœ¨å†…æ ¸æ€è°ƒç”¨do_remountå‡½æ•°ï¼Œè°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">do_remount<br>    -&gt; f2fs_remount<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_remount</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">int</span> *flags, <span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-type">bool</span> disable_checkpoint = test_opt(sbi, DISABLE_CHECKPOINT);  <span class="hljs-comment">// 1.1èŠ‚ä¸­è®¾ç½®äº†DISABLE_CHECKPOINTï¼Œæ‰€ä»¥disable_checkpoint=true</span><br>    <span class="hljs-type">bool</span> checkpoint_changed;<br>    <br>err = parse_options(sb, data, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// è§2.1 è§£æé‡æŒ‚è½½å‚æ•°</span><br><br>    <span class="hljs-comment">// è§2.2 æ¸…é™¤çš„åç»­æ“ä½œ</span><br>checkpoint_changed = disable_checkpoint != test_opt(sbi, DISABLE_CHECKPOINT);<br>    <br>    <span class="hljs-keyword">if</span> (checkpoint_changed) &#123;<br><span class="hljs-keyword">if</span> (test_opt(sbi, DISABLE_CHECKPOINT)) &#123;<br>err = f2fs_disable_checkpoint(sbi);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> restore_gc;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>f2fs_enable_checkpoint(sbi);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-è§£æé‡æŒ‚è½½å‚æ•°"><a href="#2-1-è§£æé‡æŒ‚è½½å‚æ•°" class="headerlink" title="2.1 è§£æé‡æŒ‚è½½å‚æ•°"></a>2.1 è§£æé‡æŒ‚è½½å‚æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">match_table_t</span> f2fs_tokens = &#123;<br><span class="hljs-comment">// ...</span><br>&#123;Opt_checkpoint_enable, <span class="hljs-string">&quot;checkpoint=enable&quot;</span>&#125;,<br><span class="hljs-comment">// ...</span><br>&#123;Opt_err, <span class="hljs-literal">NULL</span>&#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parse_options</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">char</span> *options, <span class="hljs-type">bool</span> is_remount)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> ((p = strsep(&amp;options, <span class="hljs-string">&quot;,&quot;</span>)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-type">int</span> token;<br><span class="hljs-keyword">if</span> (!*p)<br><span class="hljs-keyword">continue</span>;<br><br>args[<span class="hljs-number">0</span>].to = args[<span class="hljs-number">0</span>].from = <span class="hljs-literal">NULL</span>;<br>token = match_token(p, f2fs_tokens, args);<br><br><span class="hljs-keyword">switch</span> (token) &#123;<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">case</span> Opt_checkpoint_enable:<br>                clear_opt(sbi, DISABLE_CHECKPOINT);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œä»ç”¨æˆ·æ€ä¼ é€’ä¸‹æ¥çš„å‚æ•°æœ€ç»ˆå°±å¹²äº†ä¸€ä»¶äº‹ï¼š<strong>clear_opt(sbi, DISABLE_CHECKPOINT);</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> F2FS_OPTION(sbi)((sbi)-&gt;mount_opt)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_opt(sbi, option)(F2FS_OPTION(sbi).opt &amp;= ~F2FS_MOUNT_##option)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_opt(sbi, option)(F2FS_OPTION(sbi).opt |= F2FS_MOUNT_##option)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> test_opt(sbi, option)(F2FS_OPTION(sbi).opt &amp; F2FS_MOUNT_##option)</span><br></code></pre></td></tr></table></figure><p>âœ…ä¸€å¥è¯æ€»ç»“ï¼šcheckpoint&#x3D;enableçš„æœ€ç»ˆå½±å“ä¸ºsbiçš„mount_optå­—æ®µä¼šæ¸…é™¤é€‰é¡¹ï¼š<strong>F2FS_MOUNT_DISABLE_CHECKPOINT</strong></p><h3 id="2-2-æ¸…é™¤çš„åç»­æ“ä½œ"><a href="#2-2-æ¸…é™¤çš„åç»­æ“ä½œ" class="headerlink" title="2.2 æ¸…é™¤çš„åç»­æ“ä½œ"></a>2.2 æ¸…é™¤çš„åç»­æ“ä½œ</h3><p>å¯ä»¥å‘ç°ï¼Œcheckpoint_changedå˜é‡åº”è¯¥ä¸ºtrueï¼Œå› ä¸ºåˆå§‹åŒ–æ—¶<strong>disale_checkpoint&#x3D;true</strong>(ä¸Šé¢æœ‰åˆ†æ)ï¼Œæ­¤æ—¶å·²ç»è¢«æ¸…é™¤äº†DISABLE_CHECKPOINTï¼Œæ‰€ä»¥ä¸¤è¾¹ä¸ç­‰</p><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231007000550469.png" alt="image-20231007000550469" style="zoom:80%;"><p>å¯¹åº”åœ¨f2fs_remountä¸­checkpoint_changedä¸ºtrueï¼Œå°±ä¼šèµ°<strong>f2fs_enable_checkpoint</strong></p><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231007000858315.png" alt="image-20231007000858315" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_enable_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br>clear_sbi_flag(sbi, SBI_CP_DISABLED);<br>set_sbi_flag(sbi, SBI_IS_DIRTY);<br>f2fs_sync_fs(sbi-&gt;sb, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>clear_sbi_flagï¼šæ¸…é™¤1.2èŠ‚ä¸­è®¾ç½®çš„SBI_CP_DISABLEDï¼Œè¿™æ ·f2fs_write_checkpointçš„ç¬¬ä¸€ä¸ªifåˆ†æ”¯å°±ä¸ä¼šè¢«return 0æ‹¦æˆªäº†</li><li>set_sbi_flagï¼šè®¾ç½®SBI_IS_DIRTY</li><li>f2fs_sync_fsï¼šè°ƒç”¨syncï¼Œæœ€ç»ˆä¼šèµ°åˆ°cpæµç¨‹é‡Œé¢ã€é‚£ä¹ˆdisbale-&gt;enableè¿™æ®µæ—¶é—´çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šåˆ·ç›˜ã€‘</li></ul><img src="/2023/09/19/%E5%AE%89%E5%8D%93checkpoint-disable%E5%A6%82%E4%BD%95%E4%BC%A0%E9%80%92%E5%88%B0f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20231007001522443.png" alt="image-20231007001522443" style="zoom:80%;"><h2 id="å¤‡å¿˜1ï¼šf2fsçš„checkpointæ—¶æœº"><a href="#å¤‡å¿˜1ï¼šf2fsçš„checkpointæ—¶æœº" class="headerlink" title="å¤‡å¿˜1ï¼šf2fsçš„checkpointæ—¶æœº"></a>å¤‡å¿˜1ï¼šf2fsçš„checkpointæ—¶æœº</h2><p>CPæ˜¯ä¸€ä¸ªå¼€é”€å¾ˆå¤§çš„æ“ä½œï¼Œå› æ­¤åˆç†é€‰å–CPæ—¶æœºï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°æé«˜æ€§èƒ½ã€‚CPçš„è§¦å‘æ—¶æœºæœ‰:</p><blockquote><p>å‰å°GC(FG_GC)<br>FASTBOOT<br>UMOUNT<br>DISCARD<br>RECOVERY<br>TRIM<br><strong>å‘¨æœŸè¿›è¡Œ</strong></p></blockquote><p>å› æ­¤F2FSæœ‰å‡ ä¸ªå®è¡¨ç¤ºCPçš„è§¦å‘åŸå› ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span>CP_UMOUNT0x00000001</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>CP_FASTBOOT0x00000002</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>CP_SYNC0x00000004</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>CP_RECOVERY0x00000008</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>CP_DISCARD0x00000010</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CP_TRIMMED0x00000020</span><br></code></pre></td></tr></table></figure><p>âœ…CPæ‰§è¡Œå‘¨æœŸæŸ¥çœ‹ï¼š<strong>cat &#x2F;dev&#x2F;sys&#x2F;fs&#x2F;by-name&#x2F;userdata&#x2F;cp_interval</strong></p><h2 id="å¤‡å¿˜2ï¼šä»€ä¹ˆæƒ…å†µä¸‹æ•°æ®éœ€è¦å†™å›ç£ç›˜"><a href="#å¤‡å¿˜2ï¼šä»€ä¹ˆæƒ…å†µä¸‹æ•°æ®éœ€è¦å†™å›ç£ç›˜" class="headerlink" title="å¤‡å¿˜2ï¼šä»€ä¹ˆæƒ…å†µä¸‹æ•°æ®éœ€è¦å†™å›ç£ç›˜"></a>å¤‡å¿˜2ï¼šä»€ä¹ˆæƒ…å†µä¸‹æ•°æ®éœ€è¦å†™å›ç£ç›˜</h2><blockquote><p><a href="https://blog.csdn.net/guoyong10721073/article/details/8718288">https://blog.csdn.net/guoyong10721073/article/details/8718288</a></p></blockquote><p>åœ¨å†…å­˜ä¸­ç§¯ç´¯èµ·æ¥çš„è„é¡µæœ€ç»ˆå¿…é¡»è¢«å†™å›ç£ç›˜ã€‚åœ¨ä»¥ä¸‹3ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œè„é¡µè¢«å†™å›ç£ç›˜ï¼š</p><p>1ï¼‰<strong>å½“ç©ºé—²å†…å­˜ä½äºä¸€ä¸ªç‰¹å®šçš„é˜ˆå€¼æ—¶</strong>ï¼Œå†…æ ¸å¿…é¡»å°†è„é¡µå†™å›ç£ç›˜ä»¥ä¾¿é‡Šæ”¾å†…å­˜ï¼Œå› ä¸ºåªæœ‰å¹²å‡€å†…å­˜æ‰å¯ä»¥è¢«å›æ”¶ã€‚å½“å†…å­˜å¹²å‡€åï¼Œå†…æ ¸å°±å¯ä»¥ä»ç¼“å­˜æ¸…ç†æ•°æ®ï¼Œç„¶åæ”¶ç¼©ç¼“å­˜ï¼Œæœ€ç»ˆé‡Šæ”¾å‡ºæ›´å¤šçš„å†…å­˜ã€‚</p><p>2ï¼‰å½“è„é¡µåœ¨å†…å­˜ä¸­<strong>é©»ç•™çš„æ—¶é—´</strong>è¶…è¿‡äº†ä¸€ä¸ªç»™å®šçš„<strong>é˜ˆå€¼</strong>æ—¶ï¼Œå†…æ ¸å¿…é¡»å°†è¶…æ—¶çš„è„é¡µå†™å›ç£ç›˜ï¼Œä»¥ç¡®ä¿è„é¡µä¸ä¼šæ— é™æœŸåœ°é©»ç•™åœ¨å†…å­˜ä¸­ã€‚</p><p>3ï¼‰å½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨<strong>sync</strong>å’Œ<strong>fsync</strong>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šæŒ‰è¦æ±‚æ‰§è¡Œå†™å›æ“ä½œã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘é¾™èœ¥ç™½çš®ä¹¦ç²¾é€‰ï¼šåŸºäº SM4 ç®—æ³•çš„æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰å®è·µ</title>
    <link href="/2023/09/19/%E9%BE%99%E8%9C%A5%E7%99%BD%E7%9A%AE%E4%B9%A6%E7%B2%BE%E9%80%89%EF%BC%9A%E5%9F%BA%E4%BA%8E-SM4-%E7%AE%97%E6%B3%95%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%EF%BC%88fscrypt%EF%BC%89%E5%AE%9E%E8%B7%B5/"/>
    <url>/2023/09/19/%E9%BE%99%E8%9C%A5%E7%99%BD%E7%9A%AE%E4%B9%A6%E7%B2%BE%E9%80%89%EF%BC%9A%E5%9F%BA%E4%BA%8E-SM4-%E7%AE%97%E6%B3%95%E7%9A%84%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%EF%BC%88fscrypt%EF%BC%89%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€è½¬è½½ã€‘é¾™èœ¥ç™½çš®ä¹¦ç²¾é€‰ï¼šåŸºäº-SM4-ç®—æ³•çš„æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰å®è·µ"><a href="#ã€è½¬è½½ã€‘é¾™èœ¥ç™½çš®ä¹¦ç²¾é€‰ï¼šåŸºäº-SM4-ç®—æ³•çš„æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰å®è·µ" class="headerlink" title="ã€è½¬è½½ã€‘é¾™èœ¥ç™½çš®ä¹¦ç²¾é€‰ï¼šåŸºäº SM4 ç®—æ³•çš„æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰å®è·µ"></a>ã€è½¬è½½ã€‘é¾™èœ¥ç™½çš®ä¹¦ç²¾é€‰ï¼šåŸºäº SM4 ç®—æ³•çš„æ–‡ä»¶åŠ å¯†ï¼ˆfscryptï¼‰å®è·µ</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/weixin_60347558/article/details/129886294?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_60347558/article/details/129886294?spm=1001.2014.3001.5506</a></p></blockquote><h2 id="1-fscrypt-ç®€ä»‹"><a href="#1-fscrypt-ç®€ä»‹" class="headerlink" title="1.fscrypt ç®€ä»‹"></a>1.fscrypt ç®€ä»‹</h2><p>å†…æ ¸ä¸­çš„ fscrypt æ˜¯ä¸€ä¸ªåº“ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¥æ”¯æŒæ–‡ä»¶å’Œç›®å½•çš„é€æ˜åŠ å¯†ã€‚</p><p>ä¸ dm-crypt ä¸åŒï¼Œfscrypt åœ¨æ–‡ä»¶ç³»ç»Ÿçº§åˆ«è€Œä¸æ˜¯å—è®¾å¤‡çº§åˆ«è¿è¡Œã€‚è¿™å…è®¸å®ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥åŠ å¯†ä¸åŒçš„æ–‡ä»¶ï¼Œå¹¶åœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸Šæ‹¥æœ‰æœªåŠ å¯†çš„æ–‡ä»¶ã€‚è¿™å¯¹äºå¤šç”¨æˆ·ç³»ç»Ÿéå¸¸æœ‰ç”¨ï¼Œåœ¨è¯¥ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç”¨æˆ·çš„é™æ€æ•°æ®éƒ½éœ€è¦ä¸å…¶ä»–ç”¨æˆ·è¿›è¡ŒåŠ å¯†éš”ç¦»ã€‚é™¤äº†æ–‡ä»¶åï¼Œfscrypt ä¸åŠ å¯†æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ã€‚</p><p>ä¸ä½œä¸ºæ ˆå¼æ–‡ä»¶ç³»ç»Ÿçš„ eCryptfs ä¸åŒï¼Œfscrypt æ˜¯ç›´æ¥é›†æˆåˆ°æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç›®å‰æ”¯æŒ fscrypt çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ ext4ã€F2FS å’Œ UBIFSã€‚fscrypt å…è®¸è¯»å–å’Œå†™å…¥åŠ å¯†æ–‡ä»¶ï¼Œè€Œæ— éœ€åœ¨é¡µé¢ç¼“å­˜ä¸­åŒæ—¶ç¼“å­˜è§£å¯†å’ŒåŠ å¯†é¡µé¢ï¼Œä»è€Œå°†ä½¿ç”¨çš„å†…å­˜å‡ ä¹å‡åŠå¹¶ä½¿å…¶ä¸æœªåŠ å¯†æ–‡ä»¶ä¿æŒä¸€è‡´ã€‚åŒæ ·ï¼Œéœ€è¦ä¸€åŠçš„ dentry å’Œ inodeã€‚eCryptfs è¿˜å°†åŠ å¯†æ–‡ä»¶åé™åˆ¶ä¸º 143 å­—èŠ‚ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå…¼å®¹æ€§é—®é¢˜ï¼›fscrypt å…è®¸å®Œæ•´çš„ 255 ä¸ªå­—èŠ‚ (NAME_MAX)é•¿åº¦çš„æ–‡ä»¶åã€‚æœ€åï¼Œä¸ eCryptfs ä¸åŒï¼Œfscrypt API å¯ä»¥ç”±éç‰¹æƒç”¨æˆ·ä½¿ç”¨ï¼Œè€Œæ— éœ€ä¾èµ–å…¶å®ƒä»»ä½•ç»„ä»¶ã€‚</p><p>fscrypt ä¸æ”¯æŒå°±åœ°åŠ å¯†æ–‡ä»¶ã€‚ç›¸åï¼Œå®ƒæ”¯æŒå°†ç©ºç›®å½•æ ‡è®°ä¸ºå·²åŠ å¯†ã€‚ç„¶åï¼Œåœ¨ç”¨æˆ·ç©ºé—´æä¾›å¯†é’¥åï¼Œåœ¨è¯¥ç›®å½•æ ‘ä¸­åˆ›å»ºçš„æ‰€æœ‰å¸¸è§„æ–‡ä»¶ã€ç›®å½•å’Œç¬¦å·é“¾æ¥éƒ½å°†è¢«é€æ˜åœ°åŠ å¯†ã€‚</p><h2 id="2-æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•"><a href="#2-æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•" class="headerlink" title="2.æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•"></a>2.æ”¯æŒçš„åŠ å¯†æ¨¡å¼å’Œç”¨æ³•</h2><p>fscrypt å…è®¸ä¸ºæ–‡ä»¶å†…å®¹æŒ‡å®šä¸€ç§åŠ å¯†æ¨¡å¼ï¼Œä¸ºæ–‡ä»¶åæŒ‡å®šä¸€ç§åŠ å¯†æ¨¡å¼ã€‚ä¸åŒçš„ç›®å½•æ ‘å…è®¸ä½¿ç”¨ä¸åŒçš„åŠ å¯†æ–¹å¼ã€‚ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§åŠ å¯†æ–¹å¼å¯¹ï¼š</p><ul><li>AES-256-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-256-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶å</li><li>AES-128-CBC ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-128-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶å</li><li>Adiantum ç®—æ³•åŒæ—¶ç”¨äºåŠ å¯†æ–‡ä»¶å†…å®¹å’Œæ–‡ä»¶å</li><li>AES-256-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒAES-256-HCTR2 ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶åï¼ˆä»…é™ v2 ç­–ç•¥ï¼‰</li><li>SM4-XTS ç®—æ³•ç”¨äºåŠ å¯†å†…å®¹ï¼ŒSM4-CTS-CBC ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶åï¼ˆä»…é™ v2 ç­–ç•¥ï¼‰</li></ul><p>AES-128-CBC ä»…ä¸ºå…·æœ‰ä¸æ”¯æŒ XTS æ¨¡å¼çš„åŠ é€Ÿå™¨çš„ä½åŠŸè€—åµŒå…¥å¼è®¾å¤‡ä½¿ç”¨ã€‚è¦ä½¿ç”¨ AES-128-CBCï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_ESSIV å’Œ CONFIG_CRYPTO_SHA256ï¼ˆæˆ–å…¶ä»– SHA-256 å®ç°ï¼‰ä»¥ä¾¿ä½¿ç”¨ ESSIVã€‚</p><p>Adiantum æ˜¯ä¸€ç§åŸºäºæµå¯†ç çš„æ¨¡å¼ï¼Œå³ä½¿åœ¨æ²¡æœ‰ä¸“ç”¨åŠ å¯†æŒ‡ä»¤çš„ CPU ä¸Šä¹Ÿå¾ˆå¿«ã€‚ä¸ XTS ä¸åŒï¼Œå®ƒä¹Ÿæ˜¯çœŸæ­£çš„å®½å—æ¨¡å¼ã€‚è¦ä½¿ç”¨ Adiantumï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_ADIANTUMã€‚æ­¤å¤–ï¼Œåº”å¯ç”¨ ChaCha å’Œ NHPoly1305 çš„å¿«é€Ÿå®ç°ï¼Œä¾‹å¦‚ ARM æ¶æ„ä¸Šçš„ CONFIG_CRYPTO_CHACHA20_NEON å’Œ CONFIG_CRYPTO_NHPOLY1305_NEONã€‚</p><p>AES-256-HCTR2 æ˜¯å¦ä¸€ç§çœŸæ­£çš„å®½å—åŠ å¯†æ¨¡å¼ï¼Œæ—¨åœ¨ç”¨äºå…·æœ‰ä¸“ç”¨åŠ å¯†æŒ‡ä»¤çš„ CPUã€‚AES-256-HCTR2 å…·æœ‰æ˜æ–‡ä¸­çš„ä½ç¿»è½¬ä¼šæ›´æ”¹æ•´ä¸ªå¯†æ–‡çš„å±æ€§ã€‚ç”±äºåˆå§‹åŒ–å‘é‡åœ¨ç›®å½•ä¸­é‡å¤ä½¿ç”¨ï¼Œå› æ­¤æ­¤å±æ€§ä½¿å…¶æˆä¸º<strong>æ–‡ä»¶ååŠ å¯†çš„ç†æƒ³é€‰æ‹©</strong>ã€‚è¦ä½¿ç”¨ AES-256-HCTR2ï¼Œå¿…é¡»å¯ç”¨ CONFIG_CRYPTO_HCTR2ã€‚æ­¤å¤–ï¼Œåº”å¯ç”¨ XCTR å’Œ POLYVAL çš„å¿«é€Ÿå®ç°ï¼Œä¾‹å¦‚ ç”¨äº ARM64 çš„ CRYPTO_POLYVAL_ARM64_CE å’Œ CRYPTO_AES_ARM64_CE_BLKã€‚</p><p><strong>æœ€åæ˜¯ SM4 ç®—æ³•ï¼Œç›®å‰ä»…åœ¨ fscrypt v2 ç­–ç•¥ä¸­å¯ç”¨ã€‚</strong></p><h2 id="3-ä½¿ç”¨-SM4-ç®—æ³•åŠ å¯†æ–‡ä»¶"><a href="#3-ä½¿ç”¨-SM4-ç®—æ³•åŠ å¯†æ–‡ä»¶" class="headerlink" title="3.ä½¿ç”¨ SM4 ç®—æ³•åŠ å¯†æ–‡ä»¶"></a>3.ä½¿ç”¨ SM4 ç®—æ³•åŠ å¯†æ–‡ä»¶</h2><blockquote><p>ğŸŸ¢ <strong>å‡†å¤‡å·¥ä½œ</strong></p></blockquote><p>fscrypt ä¾èµ–å†…æ ¸é…ç½® CONFIG_FS_ENCRYPTION&#x3D;yï¼Œè¿™é‡Œæ“ä½œç³»ç»Ÿé€‰æ‹©ä½¿ç”¨ ANCK 5.10 å†…æ ¸çš„ Anolis OSï¼Œå…¶æ¬¡ï¼Œéœ€è¦æ”¯æŒ fscrypt ç‰¹æ€§çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™é‡Œä»¥ ext4 ä¸ºä¾‹ï¼Œå½“ç„¶ï¼ŒF2FS æˆ–è€… UBIFS ä¹Ÿå¯ä»¥ã€‚</p><p>ç”¨æˆ·ç©ºé—´æ˜¯é€šè¿‡ fscrypt API è·Ÿå†…æ ¸å®Œæˆäº¤äº’çš„ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ fscryptctl æˆ–è€… fscrypt å·¥å…·æ¥ä¸‹è¾¾åŠ å¯†ç­–ç•¥ã€‚</p><p>æœ¬èŠ‚å†…å®¹ä»¥ fscryptctlï¼ˆ<a href="https://github.com/google/fscryptctl%EF%BC%89">https://github.com/google/fscryptctlï¼‰</a> å·¥å…·ä¸ºä¾‹æ¥æ¼”ç¤ºï¼Œç›®å‰è¿™æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å·¥å…·ï¼Œéœ€è¦æ‰‹å·¥å®‰è£…ï¼ŒæŒ‰å¦‚ä¸‹å¸¸è§„æµç¨‹å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/google/fscryptctl.git<br><span class="hljs-built_in">cd</span> fscryptctl<br>make<br>make install<br></code></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œé€‰æ‹©ä¸€å—æœªç”¨åˆ°çš„ç£ç›˜æ ¼å¼åŒ–ä¸ºæ”¯æŒ fscrypt çš„æ–‡ä»¶ç³»ç»Ÿ ext4ï¼Œå¹¶æŒ‚è½½ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkfs.ext4 -O encrypt /dev/vda3<br>mount /dev/vda3 /mnt<br></code></pre></td></tr></table></figure><blockquote><p>ğŸŸ¢ <strong>é€æ˜åŠ å¯†æ–‡ä»¶</strong></p></blockquote><p>fscrypt æ‰€ç”¨çš„åŠ è§£å¯†é’¥æ˜¯å…³è”åœ¨è¶…çº§å—ä¸Šçš„ï¼Œè¿è¡Œæ—¶æ˜¯è·ŸæŒ‚è½½ç‚¹ç›¸å…³è”çš„ï¼Œæ·»åŠ åˆ é™¤å¯†é’¥éƒ½æ˜¯é’ˆå¯¹æŒ‚è½½ç‚¹çš„æ“ä½œï¼Œä»¥ä¸‹å¯¹å¯†é’¥æ“ä½œçš„å‘½ä»¤éƒ½ä¼šå¸¦ä¸ŠæŒ‚è½½ç‚¹ã€‚</p><p>æŒ‰å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºè®¾ç½®åŠ å¯†ç­–ç•¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç”Ÿæˆå¯†é’¥æ–‡ä»¶ï¼Œå®é™…ç¯å¢ƒä¸­åº”ç”¨ä½¿ç”¨æ›´å¤æ‚çš„å¯†é’¥</span><br>&gt; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;1234567812345678&#x27;</span> &gt; /tmp/keyfile<br> <br><span class="hljs-comment"># æ·»åŠ è¯¥å¯†é’¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œè¿”å›å¯†é’¥IDï¼Œä¹‹åå¯¹å¯†é’¥çš„æ“ä½œéƒ½ä½¿ç”¨è¿™ä¸ªIDæ¥ç´¢å¼•</span><br>&gt; fscryptctl add_key /mnt &lt; /tmp/keyfile<br>23086a13ed81fd75ca5fe9b8f2ff25c7<br> <br><span class="hljs-comment"># æŸ¥çœ‹å¯†é’¥çŠ¶æ€ï¼ˆä¸æ˜¯å¿…éœ€ï¼‰</span><br>&gt; fscryptctl key_status 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt<br>Present (user_count=1, added_by_self)<br> <br><span class="hljs-comment"># åˆ›å»ºåŠ å¯†ç›®å½• endirï¼Œå¹¶è®¾ç½®åŠ å¯†ç­–ç•¥</span><br><span class="hljs-comment"># ä½¿ç”¨ä¹‹å‰æ·»åŠ çš„å¯†é’¥å’Œ SM4 ç®—æ³•æ¥åŠ å¯†è¯¥ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•</span><br>&gt; <span class="hljs-built_in">mkdir</span> /mnt/endir<br>&gt; fscryptctl set_policy --contents=SM4-XTS \<br>        --filenames=SM4-CTS 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt/endir<br> <br><span class="hljs-comment"># æŸ¥çœ‹ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆï¼ˆä¸æ˜¯å¿…éœ€ï¼‰</span><br>&gt; fscryptctl get_policy /mnt/endir<br>Encryption policy <span class="hljs-keyword">for</span> /mnt/endir:<br>    Policy version: 2<br>    Master key identifier: 23086a13ed81fd75ca5fe9b8f2ff25c7<br>    Contents encryption mode: SM4-XTS<br>    Filenames encryption mode: SM4-CTS<br>    Flags: PAD_32<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œendir å·²ç»æ˜¯æ”¯æŒé€æ˜åŠ è§£å¯†çš„ä¸€ä¸ªç›®å½•ï¼Œå¯ä»¥åƒæ­£å¸¸ç›®å½•ä¸€æ ·åˆ›å»ºåˆ é™¤æ–‡ä»¶ï¼Œåœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œä¸€äº›å¸¸è§„çš„æ–‡ä»¶æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°ä¸æ™®é€šç›®å½•æ²¡æœ‰åŒºåˆ«ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; <span class="hljs-built_in">mkdir</span> /mnt/endir/foo<br>&gt; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;hello&#x27;</span> &gt; /mnt/endir/foo/hello<br> <br>&gt; <span class="hljs-built_in">cp</span> -v /usr/include/curl/* endir<br>&gt; tree /mnt/endir<br>/mnt/endir<br>â”œâ”€â”€ curl.h<br>â”œâ”€â”€ easy.h<br>â”œâ”€â”€ foo<br>â”‚   â””â”€â”€ hello<br>â””â”€â”€ websockets.h<br></code></pre></td></tr></table></figure><blockquote><p>ğŸŸ¢ <strong>é”å®šåŠ å¯†ç›®å½•</strong></p></blockquote><p>ä¹‹æ‰€ä»¥èƒ½åƒæ™®é€šç›®å½•ä¸€æ ·æ“ä½œï¼Œæ˜¯å› ä¸ºå¯†é’¥å·²ç»è¢«æ·»åŠ åˆ°äº†æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¥ä¸‹æ¥åˆ é™¤å¯†é’¥åï¼Œå°±èƒ½çœ‹åˆ°ç›®å½•è¢«é”å®šï¼Œé‡Œé¢çš„æ‰€æœ‰è·¯å¾„å’Œå†…å®¹éƒ½æ˜¯åŠ å¯†çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç§»é™¤å¯†é’¥</span><br>&gt; fscryptctl remove_key 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt<br> <br>&gt; fscryptctl key_status 23086a13ed81fd75ca5fe9b8f2ff25c7 /mnt<br>Absent<br> <br><span class="hljs-comment"># å¤„äºåŠ å¯†çŠ¶æ€çš„ç›®å½•æ ‘</span><br>&gt; tree /mnt/endir<br>/mnt/endir<br>â”œâ”€â”€ 1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw<br>â”œâ”€â”€ LvYw6Jl0a1jImKKOFPjtpG3hEDxjjuM6YIYqcMeXaWdzKUdaX0YCNQ<br>â”œâ”€â”€ QBBz8_qGE4MJY6YVzfqVUkr6YeCSqtoQmbvG04BsR0lAr2oLwO0b2g<br>â”‚   â””â”€â”€ wOYdFlMRACjeBa-eSo3LuO4sE55q1YuFv-S_lVU-n498jdMjAt06JA<br>â””â”€â”€ zoiobWxVG2DLjg8uMXfsVP11159zqQUjozJ8gmt1zyjayJlZ4awOhA<br> <br><span class="hljs-comment"># ç›®å½•è¢«é”å®šï¼Œæ— æ³•è¿›è¡Œå¸¸è§„æ–‡ä»¶æ“ä½œï¼Œå³ä¾¿æ‹”ç›˜ï¼Œä¹Ÿä¸èƒ½å¾—åˆ°æ˜æ–‡å†…å®¹</span><br>&gt; <span class="hljs-built_in">cat</span> /mnt/endir/1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw<br><span class="hljs-built_in">cat</span>: /mnt/endir/1H2e0BbS4MGZKAKEu6NVXniaYMWIrWDwbyzX6EVEWEN8tfWcWNgDyw: Required key not available<br>&gt; <span class="hljs-built_in">mkdir</span> /mnt/endir/hello<br><span class="hljs-built_in">mkdir</span>: cannot create directory â€˜/mnt/endir/helloâ€™: Required key not available<br></code></pre></td></tr></table></figure><blockquote><p>ğŸŸ¢ <strong>å†æ¬¡è§£é”åŠ å¯†ç›®å½•</strong></p></blockquote><p>è¦è§£é”ç›®å½•ä¹Ÿå¾ˆç®€å•ï¼Œé‡æ–°æ·»åŠ å¯†é’¥å³å¯ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šæœç´¢åˆ°æ­£ç¡®çš„å¯†é’¥å¹¶è§£é”ç›¸åº”ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; fscryptctl add_key /mnt &lt; /tmp/keyfile<br>23086a13ed81fd75ca5fe9b8f2ff25c7<br> <br><span class="hljs-comment"># æ·»åŠ å¯†é’¥åæ–‡ä»¶å†…å®¹å¯æ­£å¸¸è®¿é—®</span><br>&gt; <span class="hljs-built_in">cat</span> /mnt/endir/foo/hello<br>hello<br></code></pre></td></tr></table></figure><h2 id="4-åè®°"><a href="#4-åè®°" class="headerlink" title="4.åè®°"></a>4.åè®°</h2><p>fscryptctl æ˜¯ä¸€ä¸ªç›¸å¯¹åŸç”Ÿçš„å·¥å…·ï¼Œæ›´æ¥è¿‘å†…æ ¸ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¯¥å·¥å…·å‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œä½¿ç”¨ä¸­éœ€è¦è®°ä½å¾ˆé•¿ä¸€ä¸²å¯†é’¥ IDï¼Œç”¨æˆ·ä½“éªŒå¹¶ä¸å¥½ã€‚</p><p>å®é™…ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ fscrypt å·¥å…·æ¥å®ŒæˆåŠ å¯†ç­–ç•¥æ“ä½œï¼Œè¯¥å·¥å…·ç”± Google å¼€å‘ï¼Œç”¨ Go è¯­è¨€å†™æˆï¼Œé€šè¿‡åœ¨ç”¨æˆ·å±‚é¢ç»´æŠ¤äº†ä¸€äº›å…ƒæ•°æ®æ¥ç®€åŒ–ç”¨æˆ·æ“ä½œï¼Œå‘½ä»¤æ›´æ˜“äºç†è§£ï¼Œä¹Ÿæ›´æ¥è¿‘ç”¨æˆ·ã€‚</p><p>å•†å¯†è½¯ä»¶æ ˆ SIG ä¸»é¡µï¼š</p><p><a href="https://openanolis.cn/sig/crypto">https://openanolis.cn/sig/crypto</a></p><p>é™„ï¼šå•†ç”¨å¯†ç æŠ€æœ¯æœ€ä½³å®è·µç™½çš®ä¹¦</p><p><a href="https://openanolis.cn/shangmi">https://openanolis.cn/shangmi</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>android::baseå¯¹åº”çš„WriteStringToFileå’ŒReadFileToString</title>
    <link href="/2023/09/19/android-base%E5%AF%B9%E5%BA%94%E7%9A%84WriteStringToFile%E5%92%8CReadFileToString/"/>
    <url>/2023/09/19/android-base%E5%AF%B9%E5%BA%94%E7%9A%84WriteStringToFile%E5%92%8CReadFileToString/</url>
    
    <content type="html"><![CDATA[<h1 id="android-baseå¯¹åº”çš„WriteStringToFileå’ŒReadFileToString"><a href="#android-baseå¯¹åº”çš„WriteStringToFileå’ŒReadFileToString" class="headerlink" title="android::baseå¯¹åº”çš„WriteStringToFileå’ŒReadFileToString"></a>android::baseå¯¹åº”çš„WriteStringToFileå’ŒReadFileToString</h1><h2 id="1-android-baseå¯¹åº”å‘½åç©ºé—´çš„è·¯å¾„"><a href="#1-android-baseå¯¹åº”å‘½åç©ºé—´çš„è·¯å¾„" class="headerlink" title="1.android::baseå¯¹åº”å‘½åç©ºé—´çš„è·¯å¾„"></a>1.android::baseå¯¹åº”å‘½åç©ºé—´çš„è·¯å¾„</h2><p>android::baseå¯¹åº”çš„å‘½åç©ºé—´ä½äºï¼š<strong>system\libbase\file.cpp</strong></p><img src="/2023/09/19/android-base%E5%AF%B9%E5%BA%94%E7%9A%84WriteStringToFile%E5%92%8CReadFileToString/image-20230919225124870.png" alt="image-20230919225124870" style="zoom:67%;"><p>é‡Œé¢çš„å‡½æ•°æœ‰ï¼š</p><ul><li>ReadFdToString</li><li>WriteStringToFd</li><li>CleanUpAfterFailedWrite</li><li>WriteStringToFile</li><li>ReadFully</li><li>ReadFullyAtOffset</li><li>WriteFully</li><li>RemoveFileIfExists</li><li>GetExecutablePath</li><li>GetExecutableDirectory</li><li>Basename</li><li>Dirname</li></ul><h2 id="2-ReadFileToStringå‡½æ•°"><a href="#2-ReadFileToStringå‡½æ•°" class="headerlink" title="2.ReadFileToStringå‡½æ•°"></a>2.ReadFileToStringå‡½æ•°</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ReadFileToString</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path, std::string* content, <span class="hljs-type">bool</span> follow_symlinks)</span> </span>&#123;<br>  content-&gt;<span class="hljs-built_in">clear</span>();<br><br>  <span class="hljs-type">int</span> flags = O_RDONLY | O_CLOEXEC | O_BINARY | (follow_symlinks ? <span class="hljs-number">0</span> : O_NOFOLLOW);<br>  android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(TEMP_FAILURE_RETRY(open(path.c_str(), flags)))</span></span>;<br>  <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReadFdToString</span>(fd, content);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ReadFdToString</span><span class="hljs-params">(borrowed_fd fd, std::string* content)</span> </span>&#123;<br>  content-&gt;<span class="hljs-built_in">clear</span>();<br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> sb;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fstat</span>(fd.<span class="hljs-built_in">get</span>(), &amp;sb) != <span class="hljs-number">-1</span> &amp;&amp; sb.st_size &gt; <span class="hljs-number">0</span>) &#123;<br>    content-&gt;<span class="hljs-built_in">reserve</span>(sb.st_size);<br>  &#125;<br><br>  <span class="hljs-type">char</span> buf[BUFSIZ] __attribute__((__uninitialized__));<br>  <span class="hljs-type">ssize_t</span> n;<br>  <span class="hljs-keyword">while</span> ((n = <span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">read</span>(fd.<span class="hljs-built_in">get</span>(), &amp;buf[<span class="hljs-number">0</span>], <span class="hljs-built_in">sizeof</span>(buf)))) &gt; <span class="hljs-number">0</span>) &#123;<br>    content-&gt;<span class="hljs-built_in">append</span>(buf, n);<br>  &#125;<br>  <span class="hljs-keyword">return</span> (n == <span class="hljs-number">0</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-WriteStringToFileå‡½æ•°"><a href="#3-WriteStringToFileå‡½æ•°" class="headerlink" title="3.WriteStringToFileå‡½æ•°"></a>3.WriteStringToFileå‡½æ•°</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">WriteStringToFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; content, <span class="hljs-type">const</span> std::string&amp; path,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">bool</span> follow_symlinks)</span> </span>&#123;<br>  <span class="hljs-type">int</span> flags = O_WRONLY | O_CREAT | O_TRUNC | O_CLOEXEC | O_BINARY |<br>              (follow_symlinks ? <span class="hljs-number">0</span> : O_NOFOLLOW);<br>  android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(TEMP_FAILURE_RETRY(open(path.c_str(), flags, <span class="hljs-number">0666</span>)))</span></span>;<br>  <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">WriteStringToFd</span>(content, fd) || <span class="hljs-built_in">CleanUpAfterFailedWrite</span>(path);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">WriteStringToFd</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; content, borrowed_fd fd)</span> </span>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* p = content.<span class="hljs-built_in">data</span>();<br>  <span class="hljs-type">size_t</span> left = content.<span class="hljs-built_in">size</span>();<br>  <span class="hljs-keyword">while</span> (left &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-type">ssize_t</span> n = <span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">write</span>(fd.<span class="hljs-built_in">get</span>(), p, left));<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">-1</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    p += n;<br>    left -= n;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å…¶æºå¸¦äº†<strong>O_CREAT</strong>å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™å¦‚æœä¸å­˜åœ¨ä¼šå»ä¸»åŠ¨åˆ›å»ºã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç»“æ„ä½“ä½åŸŸ</title>
    <link href="/2023/09/11/%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F/"/>
    <url>/2023/09/11/%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="ç»“æ„ä½“ä½åŸŸ"><a href="#ç»“æ„ä½“ä½åŸŸ" class="headerlink" title="ç»“æ„ä½“ä½åŸŸ"></a>ç»“æ„ä½“ä½åŸŸ</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.cnblogs.com/bigrabbit/archive/2012/09/20/2695543.html">https://www.cnblogs.com/bigrabbit/archive/2012/09/20/2695543.html</a></p></blockquote><p>æœ‰äº›ä¿¡æ¯åœ¨å­˜å‚¨æ—¶ï¼Œå¹¶ä¸éœ€è¦å ç”¨ä¸€ä¸ªå®Œæ•´çš„å­—èŠ‚ï¼Œ è€Œåªéœ€å å‡ ä¸ªæˆ–ä¸€ä¸ªäºŒè¿›åˆ¶ä½ã€‚ä¾‹å¦‚åœ¨å­˜æ”¾ä¸€ä¸ªå¼€å…³é‡æ—¶ï¼Œåªæœ‰0å’Œ1 ä¸¤ç§çŠ¶æ€ï¼Œ ç”¨ä¸€ä½äºŒè¿›ä½å³å¯ã€‚ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå¹¶ä½¿å¤„ç†ç®€ä¾¿ï¼ŒCè¯­è¨€åˆæä¾›äº†ä¸€ç§æ•°æ®ç»“æ„ï¼Œç§°ä¸ºâ€œä½åŸŸâ€æˆ–â€œä½æ®µâ€ã€‚æ‰€è°“â€œä½åŸŸâ€æ˜¯æŠŠä¸€ä¸ªå­—èŠ‚ä¸­çš„äºŒè¿›ä½åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„åŒºåŸŸï¼Œ å¹¶è¯´æ˜æ¯ä¸ªåŒºåŸŸçš„ä½æ•°ã€‚æ¯ä¸ªåŸŸæœ‰ä¸€ä¸ªåŸŸåï¼Œå…è®¸åœ¨ç¨‹åºä¸­æŒ‰åŸŸåè¿›è¡Œæ“ä½œã€‚ è¿™æ ·å°±å¯ä»¥æŠŠå‡ ä¸ªä¸åŒçš„å¯¹è±¡ç”¨ä¸€ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶ä½åŸŸæ¥è¡¨ç¤ºã€‚</p><h2 id="ä½åŸŸçš„å®šä¹‰"><a href="#ä½åŸŸçš„å®šä¹‰" class="headerlink" title="ä½åŸŸçš„å®šä¹‰"></a>ä½åŸŸçš„å®šä¹‰</h2><p>ä½åŸŸçš„å®šä¹‰å’Œä½åŸŸå˜é‡çš„è¯´æ˜ä½åŸŸå®šä¹‰ä¸ç»“æ„å®šä¹‰ç›¸ä»¿ï¼Œå…¶å½¢å¼ä¸ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> ä½åŸŸç»“æ„å </span><br><span class="hljs-class">&#123;</span><br>ä½åŸŸåˆ—è¡¨<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ä½åŸŸåˆ—è¡¨çš„å½¢å¼ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ç±»å‹è¯´æ˜ç¬¦ ä½åŸŸåï¼šä½åŸŸé•¿åº¦<br></code></pre></td></tr></table></figure><p>ä½åŸŸå˜é‡çš„è¯´æ˜ä¸ç»“æ„å˜é‡è¯´æ˜çš„æ–¹å¼ç›¸åŒã€‚ å¯é‡‡ç”¨å…ˆå®šä¹‰åè¯´æ˜ï¼ŒåŒæ—¶å®šä¹‰è¯´æ˜æˆ–è€…ç›´æ¥è¯´æ˜è¿™ä¸‰ç§æ–¹å¼ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bs</span></span><br><span class="hljs-class">&#123;</span><br>ã€€ã€€<span class="hljs-type">int</span> a:<span class="hljs-number">8</span>;<br>ã€€ã€€<span class="hljs-type">int</span> b:<span class="hljs-number">2</span>;<br>ã€€ã€€<span class="hljs-type">int</span> c:<span class="hljs-number">6</span>;<br>&#125;data; <br></code></pre></td></tr></table></figure><p>è¯´æ˜dataä¸ºbså˜é‡ï¼Œå…±å ä¸¤ä¸ªå­—èŠ‚ã€‚å…¶ä¸­ä½åŸŸaå 8ä½ï¼Œä½åŸŸbå 2ä½ï¼Œä½åŸŸcå 6ä½ã€‚å¯¹äºä½åŸŸçš„å®šä¹‰å°šæœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š</p><ol><li><strong>ä¸€ä¸ªä½åŸŸå¿…é¡»å­˜å‚¨åœ¨åŒä¸€ä¸ªå­—èŠ‚ä¸­ï¼Œä¸èƒ½è·¨ä¸¤ä¸ªå­—èŠ‚</strong>ã€‚å¦‚ä¸€ä¸ªå­—èŠ‚æ‰€å‰©ç©ºé—´ä¸å¤Ÿå­˜æ”¾å¦ä¸€ä½åŸŸæ—¶ï¼Œåº”ä»ä¸‹ä¸€å•å…ƒèµ·å­˜æ”¾è¯¥ä½åŸŸã€‚ä¹Ÿå¯ä»¥æœ‰æ„ä½¿æŸä½åŸŸä»ä¸‹ä¸€å•å…ƒå¼€å§‹ã€‚ä¾‹å¦‚ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bs</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">unsigned</span> a:<span class="hljs-number">4</span><br>    <span class="hljs-type">unsigned</span> b:<span class="hljs-number">5</span> <span class="hljs-comment">/*ä»ä¸‹ä¸€å•å…ƒå¼€å§‹å­˜æ”¾*/</span><br>    <span class="hljs-type">unsigned</span> c:<span class="hljs-number">4</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li><p>ç”±äºä½åŸŸä¸å…è®¸è·¨ä¸¤ä¸ªå­—èŠ‚ï¼Œå› æ­¤<strong>ä½åŸŸçš„é•¿åº¦ä¸èƒ½å¤§äºä¸€ä¸ªå­—èŠ‚çš„é•¿åº¦</strong>ã€‚</p></li><li><p><strong>ä½åŸŸå¯ä»¥æ— ä½åŸŸå</strong>ï¼Œè¿™æ—¶å®ƒåªç”¨æ¥ä½œå¡«å……æˆ–è°ƒæ•´ä½ç½®ã€‚æ— åçš„ä½åŸŸæ˜¯ä¸èƒ½ä½¿ç”¨çš„ã€‚ä¾‹å¦‚ï¼š</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">k</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> a:<span class="hljs-number">1</span><br>    <span class="hljs-type">int</span> :<span class="hljs-number">2</span> <span class="hljs-comment">/*æ— ä½åŸŸåï¼Œè¯¥2ä½ä¸èƒ½ä½¿ç”¨*/</span><br>    <span class="hljs-type">int</span> b:<span class="hljs-number">3</span><br>    <span class="hljs-type">int</span> c:<span class="hljs-number">2</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="ä½åŸŸçš„ä½¿ç”¨"><a href="#ä½åŸŸçš„ä½¿ç”¨" class="headerlink" title="ä½åŸŸçš„ä½¿ç”¨"></a>ä½åŸŸçš„ä½¿ç”¨</h2><p>ä¸‹é¢ä¾‹å­æ˜¯å‚åŠ ä¸€ä¸ªå…¬å¸ï¼ˆç™½é¢†ç§‘æŠ€-é’å²›ï¼‰çš„ç¬”è¯•é‡åˆ°çš„ï¼Œå½“æ—¶åšé”™äº†ï¼Œä¸ºäº†æ€•å¿˜äº†ï¼Œèµ¶ç´§å†™ä¸‹æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory.h&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> a:<span class="hljs-number">5</span>;<br>    <span class="hljs-type">int</span> b:<span class="hljs-number">3</span>;<br>&#125;;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> str[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;0134324324afsadfsdlfjlsdjfl&quot;</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span> <span class="hljs-title">d</span>;</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;d, str, <span class="hljs-keyword">sizeof</span>(A));<br>    <span class="hljs-built_in">cout</span> &lt;&lt; d.a &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; d.b &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨32ä½x86æœºå™¨ä¸Šè¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">-16<br>1<br></code></pre></td></tr></table></figure><p>è§£æï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿å¯¹ç»“æ„ä½“å†…å…ƒç´ çš„è®¿é—®å’Œç®¡ç†ï¼Œå½“ç»“æ„ä½“å†…çš„å…ƒç´ é•¿åº¦éƒ½å°äºå¤„ç†å™¨çš„ä½æ•°çš„æ—¶å€™ï¼Œä¾¿ä»¥ç»“æ„ä½“é‡Œé¢æœ€é•¿çš„å…ƒç´ ä¸ºå¯¹å…¶å•ä½ï¼Œå³ç»“æ„ä½“çš„é•¿åº¦ä¸€å®šæ˜¯æœ€é•¿çš„æ•°æ®å…ƒç´ çš„æ•´æ•°å€ï¼›å¦‚æœæœ‰ç»“æ„ä½“å†…å­˜é•¿åº¦å¤§äºå¤„ç†å™¨ä½æ•°çš„å…ƒç´ ï¼Œé‚£ä¹ˆå°±ä»¥å¤„ç†å™¨çš„ä½æ•°ä¸ºå¯¹é½å•å…ƒã€‚ç”±äºæ˜¯32ä½å¤„ç†å™¨ï¼Œè€Œä¸”ç»“æ„ä½“ä¸­aå’Œbå…ƒç´ ç±»å‹å‡ä¸ºintï¼ˆä¹Ÿæ˜¯4ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥ç»“æ„ä½“çš„Aå ç”¨å†…å­˜ä¸º4ä¸ªå­—èŠ‚ã€‚</p><p>ä¸Šä¾‹ç¨‹åºä¸­å®šä¹‰äº†ä½åŸŸç»“æ„Aï¼Œä¸¤ä¸ªä¸ªä½åŸŸä¸ºaï¼ˆå ç”¨5ä½ï¼‰ï¼Œbï¼ˆå ç”¨3ä½ï¼‰ï¼Œæ‰€ä»¥aå’Œbæ€»å…±å ç”¨äº†ç»“æ„Aä¸€ä¸ªå­—èŠ‚ï¼ˆä½ä½çš„ä¸€ä¸ªå­—èŠ‚ï¼‰ã€‚</p><p>å½“ç¨‹åºè¿è¡Œåˆ°14è¡Œæ—¶ï¼Œdå†…å­˜åˆ†é…æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">é«˜ä½ <span class="hljs-number">00110100</span> <span class="hljs-number">00110011</span>   <span class="hljs-number">00110001</span>    <span class="hljs-number">00110000</span> ä½ä½  [ASCII]<br>      <span class="hljs-string">&#x27;4&#x27;</span>       <span class="hljs-string">&#x27;3&#x27;</span>       <span class="hljs-string">&#x27;1&#x27;</span>          <span class="hljs-string">&#x27;0&#x27;</span>  <br>å…¶ä¸­d.aå’Œd.bå ç”¨dä½ä½ä¸€ä¸ªå­—èŠ‚ï¼ˆ<span class="hljs-number">00110000</span>ï¼‰,d.a : <span class="hljs-number">10000</span>, d.b : <span class="hljs-number">001</span><br></code></pre></td></tr></table></figure><blockquote><p>ğŸ”´ å…³äºç¬¦å·æ‰©å±•è§ï¼š<a href="http://blog.chinaunix.net/uid-13746440-id-4244281.html">http://blog.chinaunix.net/uid-13746440-id-4244281.html</a> </p><p><strong>æ‰©å±•çš„åŸåˆ™æ˜¯ï¼š</strong></p><p><strong>1.æœ‰ç¬¦å·çš„æ•°æ®ç±»å‹ï¼Œåœ¨å‘é«˜ç²¾åº¦æ‰©å±•æ—¶ï¼Œæ€»æ˜¯å¸¦ç¬¦å·æ‰©å±•</strong></p><p><strong>2.æ— ç¬¦å·çš„æ•°æ®ç±»å‹ï¼Œåœ¨å‘é«˜ç²¾åº¦æ‰©å±•æ—¶ï¼Œæ€»æ˜¯æ— ç¬¦å·æ‰©å±•</strong></p></blockquote><p>d.aå†…å­˜ä¸­äºŒè¿›åˆ¶è¡¨ç¤ºä¸º10000ï¼Œç”±äºd.aä¸ºæœ‰ç¬¦å·çš„æ•´å‹å˜é‡ï¼Œè¾“å‡ºæ—¶è¦å¯¹ç¬¦å·ä½è¿›è¡Œæ‰©å±•ï¼Œæ‰€ä»¥ç»“æœä¸º-16ï¼ˆäºŒè¿›åˆ¶11111111111111111111111111110000ï¼‰</p><p>d.bå†…å­˜ä¸­äºŒè¿›åˆ¶è¡¨ç¤ºä¸º001ï¼Œç”±äºd.bä¸ºæœ‰ç¬¦å·çš„æ•´å‹å˜é‡ï¼Œè¾“å‡ºæ—¶è¦å¯¹ç¬¦å·ä½è¿›è¡Œæ‰©å±•ï¼Œæ‰€ä»¥ç»“æœä¸º1ï¼ˆäºŒè¿›åˆ¶ä¸º00000000000000000000000000000001ï¼‰</p><blockquote><p>è®¡ç®—æœºå†…éƒ¨ä½¿ç”¨è¡¥ç è¡¨ç¤ºæ•°å­—ï¼š</p><ul><li>æ­£æ•°çš„è¡¥ç &#x3D;åŸç </li><li>è´Ÿæ•°çš„è¡¥ç &#x3D;ç¬¦å·ä½ä¸åŠ¨ + ï¼ˆæ‰€æœ‰ä½å–ååæœ«ä½+1ï¼‰</li></ul></blockquote><h2 id="ä½åŸŸçš„å¯¹é½"><a href="#ä½åŸŸçš„å¯¹é½" class="headerlink" title="ä½åŸŸçš„å¯¹é½"></a>ä½åŸŸçš„å¯¹é½</h2><p>å¦‚æœç»“æ„ä½“ä¸­å«æœ‰ä½åŸŸ(bit-field)ï¼Œé‚£ä¹ˆVCä¸­å‡†åˆ™æ˜¯ï¼š</p><ol><li><p>å¦‚æœç›¸é‚»ä½åŸŸå­—æ®µçš„ç±»å‹ç›¸åŒï¼Œä¸”å…¶ä½å®½ä¹‹å’Œå°äºç±»å‹çš„sizeofå¤§å°ï¼Œåˆ™åé¢çš„å­—æ®µå°†ç´§é‚»å‰ä¸€ä¸ªå­—æ®µå­˜å‚¨ï¼Œç›´åˆ°ä¸èƒ½å®¹çº³ä¸ºæ­¢ï¼›</p></li><li><p>å¦‚æœç›¸é‚»ä½åŸŸå­—æ®µçš„ç±»å‹ç›¸åŒï¼Œä½†å…¶ä½å®½ä¹‹å’Œå¤§äºç±»å‹çš„sizeofå¤§å°ï¼Œåˆ™åé¢çš„å­—æ®µå°†ä»æ–°çš„å­˜å‚¨å•å…ƒå¼€å§‹ï¼Œå…¶åç§»é‡ä¸ºå…¶ç±»å‹å¤§å°çš„æ•´æ•°å€ï¼›</p></li><li><p>å¦‚æœç›¸é‚»çš„ä½åŸŸå­—æ®µçš„ç±»å‹ä¸åŒï¼Œåˆ™å„ç¼–è¯‘å™¨çš„å…·ä½“å®ç°æœ‰å·®å¼‚ï¼ŒVC6é‡‡å–ä¸å‹ç¼©æ–¹å¼ï¼ˆä¸åŒä½åŸŸå­—æ®µå­˜æ”¾åœ¨ä¸åŒçš„ä½åŸŸç±»å‹å­—èŠ‚ä¸­ï¼‰ï¼ŒDev-C++å’ŒGCCéƒ½é‡‡å–å‹ç¼©æ–¹å¼ï¼›</p></li></ol><p>ç³»ç»Ÿä¼šå…ˆä¸ºç»“æ„ä½“æˆå‘˜æŒ‰ç…§å¯¹é½æ–¹å¼åˆ†é…ç©ºé—´å’Œå¡«å¡ï¼ˆpaddingï¼‰,ç„¶åå¯¹å˜é‡è¿›è¡Œä½åŸŸæ“ä½œã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>std::lock_guardå¼•èµ·çš„æ€è€ƒ</title>
    <link href="/2023/09/06/std-lock-guard%E5%BC%95%E8%B5%B7%E7%9A%84%E6%80%9D%E8%80%83/"/>
    <url>/2023/09/06/std-lock-guard%E5%BC%95%E8%B5%B7%E7%9A%84%E6%80%9D%E8%80%83/</url>
    
    <content type="html"><![CDATA[<h1 id="std-lock-guardå¼•èµ·çš„æ€è€ƒ"><a href="#std-lock-guardå¼•èµ·çš„æ€è€ƒ" class="headerlink" title="std::lock_guardå¼•èµ·çš„æ€è€ƒ"></a>std::lock_guardå¼•èµ·çš„æ€è€ƒ</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.jianshu.com/p/681f553fa4ab">https://www.jianshu.com/p/681f553fa4ab</a></p></blockquote><h2 id="std-lock-guard-ç®€ä»‹"><a href="#std-lock-guard-ç®€ä»‹" class="headerlink" title="std::lock_guard ç®€ä»‹"></a>std::lock_guard ç®€ä»‹</h2><p>è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªäº’æ–¥é‡çš„åŒ…è£…ç±»ï¼Œç”¨æ¥<strong>æä¾›è‡ªåŠ¨ä¸ºäº’æ–¥é‡ä¸Šé”å’Œè§£é”</strong>çš„åŠŸèƒ½ï¼Œç®€åŒ–äº†å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br>std::mutex kMutex;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">function</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// æ„é€ æ—¶è‡ªåŠ¨åŠ é”</span><br>  std::<span class="hljs-built_in">lock_guard</span>&lt;std::mutex&gt; (kMutex);<br>  <br>  <span class="hljs-comment">// ç¦»å¼€å±€éƒ¨ä½œç”¨åŸŸï¼Œææ„å‡½æ•°è‡ªåŠ¨å®Œæˆè§£é”åŠŸèƒ½</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨æ³•éå¸¸ç®€å•ï¼Œåªéœ€åœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‡½æ•°å¼€å§‹å¤„åŠ ä¸Šä¸€è¡Œä»£ç å³å¯ï¼Œå…¶ä»–çš„éƒ½åœ¨è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¸­è‡ªåŠ¨å®Œæˆã€‚</p><p>å¦‚ä½•è‡ªåŠ¨å®Œæˆï¼Ÿå…¶å® Just so so â€¦</p><h2 id="å®ç°-my-lock-guard"><a href="#å®ç°-my-lock-guard" class="headerlink" title="å®ç° my_lock_guard"></a>å®ç° my_lock_guard</h2><p>è¿™æ˜¯è‡ªå·±å®ç°çš„ä¸€ä¸ª <code>lock_guard</code>ï¼Œå°±æ˜¯åœ¨<strong>æ„é€ å’Œææ„ä¸­å®ŒæˆåŠ é”å’Œè§£é”</strong>çš„æ“ä½œï¼Œä¹‹æ‰€ä»¥ä¼šè‡ªåŠ¨å®Œæˆï¼Œæ˜¯å› ä¸º<strong>ç¦»å¼€å‡½æ•°ä½œç”¨åŸŸä¼šå¯¼è‡´å±€éƒ¨å˜é‡ææ„å‡½æ•°è¢«è°ƒç”¨</strong>ï¼Œè€Œæˆ‘ä»¬åˆæ˜¯æ‰‹åŠ¨æ„é€ äº† <code>lock_guard</code>ï¼Œå› æ­¤è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯è‡ªåŠ¨è¢«è°ƒç”¨çš„ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">namespace</span> myspace &#123;<br>    <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">my_lock_guard</span> &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-comment">// åœ¨ std::mutex çš„å®šä¹‰ä¸­ï¼Œä¸‹é¢ä¸¤ä¸ªå‡½æ•°è¢«åˆ é™¤äº†</span><br>        <span class="hljs-comment">// mutex(const mutex&amp;) = delete;</span><br>        <span class="hljs-comment">// mutex&amp; operator=(const mutex&amp;) = delete;</span><br>        <span class="hljs-comment">// å› æ­¤è¿™é‡Œå¿…é¡»ä¼ é€’å¼•ç”¨</span><br>        <span class="hljs-built_in">my_lock_guard</span>(T&amp; mutex) :<span class="hljs-built_in">mutex_</span>(mutex)&#123;<br>            <span class="hljs-comment">// æ„é€ åŠ é”</span><br>            mutex_.<span class="hljs-built_in">lock</span>();<br>        &#125;<br><br>        ~<span class="hljs-built_in">my_lock_guard</span>() &#123;<br>            <span class="hljs-comment">// ææ„è§£é”</span><br>            mutex_.<span class="hljs-built_in">unlock</span>();<br>        &#125;<br>    <span class="hljs-keyword">private</span>:<br>        <span class="hljs-comment">// ä¸å¯èµ‹å€¼ï¼Œä¸å¯æ‹·è´</span><br>        <span class="hljs-built_in">my_lock_guard</span>(my_lock_guard <span class="hljs-type">const</span>&amp;);<br>        my_lock_guard&amp; <span class="hljs-keyword">operator</span>=(my_lock_guard <span class="hljs-type">const</span>&amp;);<br>    <span class="hljs-keyword">private</span>:<br>        T&amp; mutex_;<br>    &#125;;<br><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªç±»å®˜æ–¹å®šä¹‰æ˜¯<strong>ä¸å¯ä»¥èµ‹å€¼å’Œæ‹·è´</strong>ï¼Œå› æ­¤éœ€è¦ç§æœ‰åŒ– <code>operator =</code> å’Œ <code>copy</code> è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-std-mutex-ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-std-mutex-ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ std::mutex ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ std::mutex ï¼Ÿ</h2><p>å¦‚æœä½ ç»†å¿ƒå¯ä»¥å‘ç°ï¼Œä¸ç®¡æ˜¯ <code>std::lock_guard</code>ï¼Œè¿˜æ˜¯<code>my_lock_guard</code>ï¼Œéƒ½ä½¿ç”¨äº†ä¸€ä¸ª <code>std::mutex</code> ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„ <code>lock_guard</code> åªæ˜¯ä¸€ä¸ªåŒ…è£…ç±»ï¼Œè€Œå®é™…çš„åŠ é”å’Œè§£é”çš„æ“ä½œéƒ½è¿˜æ˜¯ <code>std::mutex</code> å®Œæˆçš„ï¼Œé‚£ä»€ä¹ˆæ˜¯ <code>std::mutex</code> å‘¢ï¼Ÿ</p><p><code>std::mutex</code> å…¶å®æ˜¯ä¸€ä¸ª<strong>ç”¨äºä¿æŠ¤å…±äº«æ•°æ®ä¸ä¼šåŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„ç±»</strong>ï¼Œå®ƒå«åš<strong>äº’æ–¥é‡</strong>ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€æŠŠé”ï¼Œå®ƒçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><br>std::mutex kMutex;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">function</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">//åŠ é”</span><br>  kMutex.<span class="hljs-built_in">lock</span>();<br>  <span class="hljs-comment">//kMutex.try_lock();</span><br><br>  <span class="hljs-comment">//do something that is thread safe...</span><br>  <br>  <span class="hljs-comment">// ç¦»å¼€ä½œç”¨åŸŸè§£é”</span><br>  kMutex.<span class="hljs-built_in">unlock</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢éƒ½æåˆ°äº†<strong>é”</strong>è¿™ä¸ªæ¦‚å¿µï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯é”ï¼Œæœ‰å•¥ç”¨å¤„ï¼Ÿ</p><h2 id="ä»€ä¹ˆæ˜¯é”ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é”ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é”ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é”ï¼Ÿ</h2><p><strong>é”æ˜¯ç”¨æ¥ä¿æŠ¤å…±äº«èµ„æºï¼ˆå˜é‡æˆ–è€…ä»£ç ï¼‰ä¸è¢«å¹¶å‘è®¿é—®çš„ä¸€ç§æ–¹æ³•</strong>ï¼Œå®ƒåªæ˜¯æ–¹æ³•ï¼Œå®é™…çš„å®ç°å°±æ˜¯ <code>std::mutex</code> ç­‰ç­‰çš„ç±»äº†ã€‚</p><p>å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼š</p><ol><li>å½“å‰çº¿ç¨‹è®¿é—®ä¸€ä¸ªå˜é‡ä¹‹å‰ï¼Œå°†è¿™ä¸ªå˜é‡æ”¾åˆ°ç›’å­é‡Œé”ä½ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹æ‹¿ç€é’¥åŒ™ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœæœ‰å…¶ä»–çš„çº¿ç¨‹ä¹Ÿè¦è®¿é—®è¿™ä¸ªå˜é‡ï¼Œåˆ™å¿…é¡»ç­‰å¾…å½“å‰çº¿ç¨‹å°†ç›’å­è§£é”ä¹‹åæ‰èƒ½è®¿é—®ï¼Œä¹‹åå…¶ä»–çº¿ç¨‹åœ¨è®¿é—®è¿™ä¸ªå˜é‡ä¹‹å‰ä¹Ÿå°†ä¼šå†æ¬¡é”ä½è¿™ä¸ªå˜é‡ã€‚</li><li>å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œåï¼Œå°±å°†è¯¥ç›’å­è§£é”ï¼Œè¿™æ ·å…¶ä»–çš„çº¿ç¨‹å°±å¯ä»¥æ‹¿åˆ°ç›’å­çš„é’¥åŒ™ï¼Œå¹¶å†æ¬¡åŠ é”è®¿é—®è¿™ä¸ªå˜é‡äº†ã€‚</li></ol><p>è¿™æ ·å°±<strong>ä¿è¯äº†åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æº</strong>ï¼Œè§£å†³äº†ç®€å•çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><p>ä»€ä¹ˆï¼Œä½ è¿˜æ²¡æœ‰é‡åˆ°è¿‡çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿä¸‹é¢å¼€å§‹æˆ‘çš„è¡¨æ¼”â€¦</p><h2 id="ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨çš„ä¾‹å­"><a href="#ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨çš„ä¾‹å­"></a>ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨çš„ä¾‹å­</h2><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<strong>ä¸»çº¿ç¨‹å¼€å¯äº† 2 ä¸ªå­çº¿ç¨‹</strong>ï¼Œæ¯ä¸ªå­çº¿ç¨‹éƒ½ä¿®æ”¹<strong>å…±äº«çš„å…¨å±€å˜é‡</strong> <code>kData</code>ï¼Œå¦‚æœæ²¡æœ‰å¢åŠ å¿…è¦çš„é”æœºåˆ¶ï¼Œé‚£ä¹ˆæ¯ä¸ªå­çº¿ç¨‹æ‰“å°å‡ºçš„ <code>kData</code> å°±å¯èƒ½ä¼šå‡ºé”™ã€‚</p><p>è¿™é‡Œä½¿ç”¨äº† 3 ç§ä¸åŒçš„åŠ é”æ–¹æ³•æ¥è§£å†³ï¼š</p><ol><li>ä½¿ç”¨ <code>std::lock_guard</code></li><li>ä½¿ç”¨ <code>std::mutex</code> å®ç°åŸç”Ÿçš„åŠ é”</li><li>ä½¿ç”¨è‡ªå·±çš„ <code>myspace::my_lock_guard</code></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-comment">// ä¸¤ä¸ªå­çº¿ç¨‹å…±äº«çš„å…¨å±€å˜é‡</span><br><span class="hljs-type">int</span> kData = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// std::mutex æä¾›äº†ä¸€ç§é˜²æ­¢å…±äº«æ•°æ®è¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®çš„ç®€å•åŒæ­¥æ–¹æ³•</span><br><span class="hljs-comment">// è°ƒç”¨çº¿ç¨‹å¯ä»¥é€šè¿‡ lock å’Œ try_lock æ¥è·å–äº’æ–¥é‡ï¼Œä½¿ç”¨ unlock() é‡Šæ”¾äº’æ–¥é‡</span><br>std::mutex kMutex;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡çš„åŒ…è£…ç±»ï¼Œç”¨æ¥è‡ªåŠ¨ç®¡ç†äº’æ–¥é‡çš„è·å–å’Œé‡Šæ”¾</span><br>    <span class="hljs-comment">// std::lock_guard&lt;std::mutex&gt; lock(kMutex);</span><br>    <br>    <span class="hljs-comment">// 2.åŸç”ŸåŠ é”</span><br>    <span class="hljs-comment">// kMutex.lock();</span><br><br>    <span class="hljs-comment">// 3.è‡ªå·±å®ç°çš„ std::mutex çš„åŒ…è£…ç±»</span><br>    <span class="hljs-function">myspace::my_lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(kMutex)</span></span>;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-comment">// æ‰“å°å½“å‰çº¿ç¨‹çš„ id : kData</span><br>        std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() <br>                  &lt;&lt; <span class="hljs-string">&quot;:&quot;</span> &lt;&lt; kData++ &lt;&lt; std::endl;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. åŸç”Ÿè§£é”  </span><br>    <span class="hljs-comment">//kMutex.unlock();</span><br>    <br>    <span class="hljs-comment">// ç¦»å¼€å±€éƒ¨ä½œç”¨åŸŸï¼Œå±€éƒ¨é”è§£é”ï¼Œé‡Šæ”¾äº’æ–¥é‡</span><br>    <br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// æ‰“å°å½“å‰å‡½æ•°å</span><br>    std::cout &lt;&lt; __FUNCTION__ &lt;&lt; <span class="hljs-string">&quot;:&quot;</span> &lt;&lt; kData &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">// å¼€å¯ä¸¤ä¸ªçº¿ç¨‹</span><br>    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;<br>    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;<br><br>    <span class="hljs-comment">// ä¸»çº¿ç¨‹ç­‰å¾…è¿™ä¸¤ä¸ªçº¿ç¨‹å®Œæˆæ“ä½œä¹‹åå†é€€å‡º</span><br>    t1.<span class="hljs-built_in">join</span>();<br>    t2.<span class="hljs-built_in">join</span>();<br><br>    <span class="hljs-comment">// é˜²æ­¢ç«‹åˆ»é€€å‡º</span><br>    <span class="hljs-built_in">getchar</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>C++ç‹¬ç«‹å¤§æ‹¬å·</title>
    <link href="/2023/09/06/C-%E7%8B%AC%E7%AB%8B%E5%A4%A7%E6%8B%AC%E5%8F%B7/"/>
    <url>/2023/09/06/C-%E7%8B%AC%E7%AB%8B%E5%A4%A7%E6%8B%AC%E5%8F%B7/</url>
    
    <content type="html"><![CDATA[<h1 id="C-ç‹¬ç«‹å¤§æ‹¬å·"><a href="#C-ç‹¬ç«‹å¤§æ‹¬å·" class="headerlink" title="C++ç‹¬ç«‹å¤§æ‹¬å·"></a>C++ç‹¬ç«‹å¤§æ‹¬å·</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/qq_41861406/article/details/124664297">https://blog.csdn.net/qq_41861406/article/details/124664297</a></p></blockquote><p>c++ è¯­è¨€ä¸­ã€‚{}ä¸€èˆ¬æ˜¯åœ¨å‡½æ•°ã€ç±»ä¹‹ä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨é˜…è¯»ä»£ç è¿‡ç¨‹ä¸­å‘ç°ä¸€ç§å¥‡æ€ªçš„ç°è±¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br> <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// Some unrelated code</span><br>        <br>&#123;<br><span class="hljs-comment">// Some other code</span><br><span class="hljs-comment">// ... </span><br>&#125;<br><br>     <span class="hljs-comment">// Somce unrelated code</span><br> <span class="hljs-comment">// ...</span><br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­æœ‰ä¸€ä¸ªå¤šä½™çš„å¤§æ‹¬å·ï¼Œä½†æ˜¯ä¸çŸ¥é“æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Œå› ä¸ºä»–ä¸å’Œå‰é¢æˆ–åé¢çš„ä»»ä½•ä»£ç æœ‰å…³ã€‚</p><p><strong>è§£é‡Š</strong></p><p>è¿™ä¸ªå¤šä½™çš„å¤§æ‹¬å·æä¾›äº†ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸã€‚ åŠ å…¥è¿™ä¸ªå¤šä½™å¤§æ‹¬å·çš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p><ol><li>å¯ä»¥æ›´å¹²å‡€çš„å£°æ˜æ–°å˜é‡</li><li>å¯ä»¥æ›´å¿«çš„é‡Šæ”¾èµ„æº<ul><li>å› ä¸ºC++æœ‰ææ„å™¨ï¼Œå½“ç¦»å¼€ä½œç”¨åŸŸçš„æ—¶å€™ï¼Œå¤šä½™çš„å¤§æ‹¬å·å¯ä»¥ä½¿èµ„æº(files, mutexes, whatever)è‡ªåŠ¨é‡Šæ”¾ã€‚è¿™ä½¿ä»£ç å˜å¾—æ›´å¹²å‡€ã€‚è¿™å°±æ„å‘³ç€ç¨‹åºå¯ä»¥å ç”¨ä¸€äº›å…±äº«èµ„æºæ›´çŸ­çš„æ—¶é—´ã€‚æ‹¥æœ‰è‡ªåŠ¨å‚¨å­˜çš„å˜é‡åœ¨ç¦»å¼€ä½œç”¨åŸŸåä¼šè‡ªåŠ¨é”€æ¯ï¼Œå¤šä½™çš„å¤§æ‹¬å·å¯ä»¥ä½¿å®ƒæ¯”æ²¡æœ‰æ—¶æ›´æ—©çš„è¢«é”€æ¯ã€‚</li></ul></li><li>é™åˆ¶å˜é‡çš„ä½œç”¨åŸŸ</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>C++å¹¶å‘å¤šçº¿ç¨‹åŸºç¡€</title>
    <link href="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="C-å¹¶å‘å¤šçº¿ç¨‹åŸºç¡€"><a href="#C-å¹¶å‘å¤šçº¿ç¨‹åŸºç¡€" class="headerlink" title="C++å¹¶å‘å¤šçº¿ç¨‹åŸºç¡€"></a>C++å¹¶å‘å¤šçº¿ç¨‹åŸºç¡€</h1><blockquote><p>åŸæ–‡ï¼š<a href="https://blog.csdn.net/weixin_42636062/category_11292803.html">https://blog.csdn.net/weixin_42636062/category_11292803.html</a></p></blockquote><h2 id="1-çº¿ç¨‹å¯åŠ¨ã€ç»“æŸã€åˆ›å»ºçº¿ç¨‹å¤šå‘ã€joinï¼Œdetach"><a href="#1-çº¿ç¨‹å¯åŠ¨ã€ç»“æŸã€åˆ›å»ºçº¿ç¨‹å¤šå‘ã€joinï¼Œdetach" class="headerlink" title="1.çº¿ç¨‹å¯åŠ¨ã€ç»“æŸã€åˆ›å»ºçº¿ç¨‹å¤šå‘ã€joinï¼Œdetach"></a>1.çº¿ç¨‹å¯åŠ¨ã€ç»“æŸã€åˆ›å»ºçº¿ç¨‹å¤šå‘ã€joinï¼Œdetach</h2><h3 id="1-1-èŒƒä¾‹æ¼”ç¤ºçº¿ç¨‹è¿è¡Œçš„å¼€å§‹å’Œç»“æŸ"><a href="#1-1-èŒƒä¾‹æ¼”ç¤ºçº¿ç¨‹è¿è¡Œçš„å¼€å§‹å’Œç»“æŸ" class="headerlink" title="1.1 èŒƒä¾‹æ¼”ç¤ºçº¿ç¨‹è¿è¡Œçš„å¼€å§‹å’Œç»“æŸ"></a>1.1 èŒƒä¾‹æ¼”ç¤ºçº¿ç¨‹è¿è¡Œçš„å¼€å§‹å’Œç»“æŸ</h3><p>1ï¼‰ç¨‹åºè¿è¡Œèµ·æ¥ï¼Œç”Ÿæˆä¸€ä¸ªè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ‰€å±çš„ä¸»çº¿ç¨‹å¼€å§‹è‡ªåŠ¨è¿è¡Œ</p><p>2ï¼‰ä¸»çº¿ç¨‹ä»mainï¼ˆï¼‰å¼€å§‹æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ï¼Œä¹Ÿéœ€è¦ä»ä¸€ä¸ªå‡½æ•°å¼€å§‹è¿è¡Œï¼ˆåˆå§‹å‡½æ•°ï¼‰ï¼Œä¸€æ—¦è¿™ä¸ªå‡½æ•°è¿è¡Œå®Œæ¯•ï¼Œå°±ä»£è¡¨ç€æˆ‘ä»¬è¿™ä¸ªçº¿ç¨‹è¿è¡Œå®Œæ¯•</p><p>3ï¼‰æ•´ä¸ªè¿›ç¨‹æ˜¯å¦å®Œæ¯•çš„æ ‡å¿—æ˜¯ ä¸»çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œï¼Œå¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†ï¼Œå°±ä»£è¡¨æ•´ä¸ªè¿›ç¨‹æ‰§è¡Œå®Œæ¯•äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœå…¶ä»–å­çº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆè¿™äº›å­çº¿ç¨‹ä¹Ÿä¼šè¢«æ“ä½œç³»ç»Ÿå¼ºè¡Œç»ˆæ­¢ã€‚</p><p> æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼Œå¦‚æœå¤§å®¶æƒ³ä¿æŒçº¿ç¨‹ï¼ˆè‡ªå·±ç”¨ä»£ç åˆ›å»ºçš„ï¼‰è¿è¡ŒçŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆå¤§å®¶è¦è®©ä¸»çº¿ç¨‹ä¸€ç›´ä¿æŒè¿è¡Œï¼Œä¸è¦è®©ä¸»çº¿ç¨‹è¿è¡Œå®Œæ¯•ï¼ˆè¿™æ¡è§„å¾‹ä¹Ÿæœ‰ä¾‹å¤–ï¼Œåç»­ä¼šè§£é‡Šè¿™ç§ä¾‹å¤–ï¼ˆå°±æ˜¯1.3 detachï¼‰ï¼Œå¤§å®¶ç›®å‰å…ˆè¿™æ ·ç†è§£å’Œè®°å¿†ï¼‰</p><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/3da72dfb46be496a8d9def6a8ce10af8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p><strong>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼š</strong></p><p>1ï¼‰åŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶ <code>#include &lt;thread&gt;</code></p><p>2ï¼‰åˆå§‹å‡½æ•°è¦å†™</p><p>3ï¼‰ mainä¸­å¼€å§‹å†™ä»£ç </p><p>æ³¨æ„ï¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œç›¸å½“äºä¸¤ä¸ªç¨‹åºçš„æ‰§è¡Œæœ‰ä¸¤æ¡çº¿åœ¨åŒæ—¶èµ°ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ªäº‹æƒ…ï¼Œå³ä½¿ä¸€æ¡çº¿è¢«å µä½äº†ï¼Œå¦å¤–ä¸€æ¡çº¿è¿˜æ˜¯å¯ä»¥è¿è¡Œï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-comment">//è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ä¹Ÿè¦ä»ä¸€ä¸ªå‡½æ•°ï¼ˆåˆå§‹å‡½æ•°ï¼‰å¼€å§‹è¿è¡Œ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myprint</span><span class="hljs-params">()</span> </span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†1&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†2&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†3&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">//a)åŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶ #include &lt;thread&gt;</span><br><br><span class="hljs-comment">//b)åˆå§‹å‡½æ•°è¦å†™ ä¾‹å¦‚ä¸Šé¢çš„void myprint()ï¼›</span><br><br><span class="hljs-comment">//c) mainä¸­å¼€å§‹å†™ä»£ç </span><br><span class="hljs-function">thread <span class="hljs-title">mytobj</span><span class="hljs-params">(myprint)</span></span>;  <span class="hljs-comment">//ï¼ˆ1ï¼‰åˆ›å»ºäº†çº¿ç¨‹ï¼Œçº¿ç¨‹æ‰§è¡Œèµ·ç‚¹ï¼ˆå…¥å£ï¼‰myprintï¼ˆï¼‰ï¼› ï¼ˆ2ï¼‰myprintå¼€å§‹æ‰§è¡Œ</span><br>    <br>    <span class="hljs-comment">//é˜»å¡ä¸»çº¿ç¨‹å¹¶ç­‰å¾…myprintå­çº¿ç¨‹æ‰§è¡Œå®Œ</span><br>mytobj.<span class="hljs-built_in">join</span>(); <span class="hljs-comment">//ä¸»çº¿ç¨‹é˜»å¡åˆ°è¿™é‡Œï¼Œç­‰å¾…myprint()æ‰§è¡Œå®Œï¼Œå½“å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè¿™ä¸ªjoinï¼ˆï¼‰å°±æ‰§è¡Œå®Œæ¯•ï¼Œä¸»çº¿ç¨‹å°±ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span><br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><br><span class="hljs-comment">//å¤§å®¶å¿…é¡»æ˜ç¡®ä¸€ç‚¹ï¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œç›¸å½“äºä¸¤ä¸ªç¨‹åºçš„æ‰§è¡Œæœ‰ä¸¤æ¡çº¿åœ¨åŒæ—¶èµ°ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ªäº‹æƒ…ï¼Œå³ä½¿ä¸€æ¡çº¿è¢«å µä½äº†ï¼Œå¦å¤–ä¸€æ¡çº¿è¿˜æ˜¯å¯ä»¥è¿è¡Œï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/0780dced36d94719bfad44ba7d758b91.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><h4 id="1-1-1-therad"><a href="#1-1-1-therad" class="headerlink" title="1.1.1 therad"></a>1.1.1 therad</h4><p>æ¦‚å¿µï¼šthreadæ˜¯ä¸ªæ ‡å‡†åº“é‡Œçš„ç±»ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">thread <span class="hljs-title">mytobj</span><span class="hljs-params">(myprint)</span></span>;<span class="hljs-comment">//ï¼ˆ1ï¼‰åˆ›å»ºäº†çº¿ç¨‹ï¼Œçº¿ç¨‹æ‰§è¡Œèµ·ç‚¹ï¼ˆå…¥å£ï¼‰myprintï¼ˆï¼‰ï¼› ï¼ˆ2ï¼‰myprintå¼€å§‹æ‰§è¡Œ</span><br></code></pre></td></tr></table></figure><h4 id="1-1-2-join"><a href="#1-1-2-join" class="headerlink" title="1.1.2 join"></a>1.1.2 join</h4><p>æ¦‚å¿µï¼šjoinï¼ˆï¼‰ï¼šåŠ å…¥&#x2F;æ±‡åˆï¼Œè¯´ç™½äº†å°±æ˜¯é˜»å¡ï¼Œé˜»å¡ä¸»çº¿ç¨‹ï¼Œè®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ç„¶åå­çº¿ç¨‹å’Œä¸»çº¿ç¨‹æ±‡åˆï¼Œç„¶åä¸»çº¿ç¨‹å†å¾€ä¸‹èµ°ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œä½†å­ç¨‹åºæ²¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™ç§ç¨‹åºå‘˜æ˜¯ä¸åˆæ ¼çš„ï¼Œç¨‹åºä¹Ÿæ˜¯ä¸ç¨³å®šçš„ã€‚</p><p> ä¸€ä¸ªä¹¦å†™è‰¯å¥½çš„ç¨‹åºï¼Œåº”è¯¥æ˜¯ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œè‡ªå·±æ‰èƒ½æœ€ç»ˆé€€å‡ºã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//é˜»å¡ä¸»çº¿ç¨‹å¹¶ç­‰å¾…myprintå­çº¿ç¨‹æ‰§è¡Œå®Œ</span><br>mytobj.<span class="hljs-built_in">join</span>();  <span class="hljs-comment">//ä¸»çº¿ç¨‹é˜»å¡åˆ°è¿™é‡Œï¼Œç­‰å¾…myprint()æ‰§è¡Œå®Œï¼Œå½“å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè¿™ä¸ªjoinï¼ˆï¼‰å°±æ‰§è¡Œå®Œæ¯•ï¼Œä¸»çº¿ç¨‹å°±ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span><br></code></pre></td></tr></table></figure><h4 id="1-1-3-detach"><a href="#1-1-3-detach" class="headerlink" title="1.1.3 detach"></a>1.1.3 detach</h4><p>1ï¼‰æ¦‚å¿µï¼šä¼ ç»Ÿå¤šçº¿ç¨‹ç¨‹åºä¸»çº¿ç¨‹è¦ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åè‡ªå·±å†æœ€åé€€å‡ºã€‚</p><p>2ï¼‰detachï¼šåˆ†ç¦»ï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹ä¸å’Œå­çº¿ç¨‹æ±‡åˆäº†ï¼Œä½ ä¸»çº¿ç¨‹æ‰§è¡Œä½ çš„ï¼Œæˆ‘å­çº¿ç¨‹æ‰§è¡Œæˆ‘çš„ï¼Œä½ ä¸»çº¿ç¨‹ä¹Ÿä¸å¿…ç­‰æˆ‘å­çº¿ç¨‹è¿è¡Œå®Œæ¯•ï¼Œä½ å¯ä»¥å…ˆæ‰§è¡Œç»“æŸï¼Œè¿™å¹¶ä¸å½±å“æˆ‘å­çº¿ç¨‹çš„æ‰§è¡Œã€‚</p><blockquote><p>ï¼ˆä¸‹é¢ä¸ºä»€ä¹ˆçš„è§£é‡Šè¯´æ˜ï¼šä½†æ˜¯è€å¸ˆè¿˜æ˜¯æ¨èå®é™…é¡¹ç›®ä¸è¦è¿™æ ·ï¼Œè®©å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å†è¯´ï¼Œæƒå½“æ¦‚å¿µè®°ï¼‰</p></blockquote><p>3ï¼‰ä¸ºä»€ä¹ˆå¼•å…¥detachï¼šæˆ‘ä»¬åˆ›å»ºäº†å¾ˆå¤šå­çº¿ç¨‹ï¼Œè®©ä¸»çº¿ç¨‹é€ä¸ªç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œè¿™ç§ç¼–ç¨‹æ–¹æ³•ä¸å¥½ï¼Œæ‰€ä»¥å¼•å…¥detachï¼ˆï¼‰ï¼›ä¸€æ—¦detachï¼ˆï¼‰ä¹‹åï¼Œä¸è¿™ä¸ªä¸»çº¿ç¨‹å…³è”çš„threadå¯¹è±¡å°±ä¼šå¤±å»ä¸è¿™ä¸ªä¸»çº¿ç¨‹çš„å…³è”ï¼Œæ­¤æ—¶è¿™ä¸ªå­çº¿ç¨‹å°±ä¼šé©»ç•™åœ¨åå°è¿è¡Œï¼ˆä¸»çº¿ç¨‹è·Ÿå­çº¿ç¨‹å¤±å»è”ç³»ï¼‰ï¼›è¿™ä¸ªå­çº¿ç¨‹å°±ç›¸å½“äºè¢«c++è¿è¡Œæ—¶åº“æ¥ç®¡ï¼Œå½“è¿™ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œç”±è¿è¡Œæ—¶åº“è´Ÿè´£æ¸…ç†è¯¥çº¿ç¨‹ç›¸å…³çš„èµ„æºï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰ã€‚</p><p>4ï¼‰æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†detachï¼ˆï¼‰ã€‚å°±ä¸èƒ½å†ä½¿ç”¨joinï¼ˆï¼‰</p><p>ä¾‹å­é‡Œé¢ detachï¼ˆï¼‰ä½¿çº¿ç¨‹myprintå¤±å»æˆ‘ä»¬è‡ªå·±çš„æ§åˆ¶</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-comment">//è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ä¹Ÿè¦ä»ä¸€ä¸ªå‡½æ•°ï¼ˆåˆå§‹å‡½æ•°ï¼‰å¼€å§‹è¿è¡Œ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myprint</span><span class="hljs-params">()</span> </span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†1&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†2&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†3&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br><span class="hljs-function">thread <span class="hljs-title">mytobj</span><span class="hljs-params">(myprint)</span></span>;  <span class="hljs-comment">//ï¼ˆ1ï¼‰åˆ›å»ºäº†çº¿ç¨‹ï¼Œçº¿ç¨‹æ‰§è¡Œèµ·ç‚¹ï¼ˆå…¥å£ï¼‰myprintï¼ˆï¼‰ï¼› ï¼ˆ2ï¼‰myprintå¼€å§‹æ‰§è¡Œ</span><br>    mytobj.<span class="hljs-built_in">detach</span>();  <span class="hljs-comment">//ä¸€æ—¦è°ƒç”¨äº†detachï¼ˆï¼‰ã€‚å°±ä¸èƒ½å†ä½¿ç”¨joinï¼ˆï¼‰</span><br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º1&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º2&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º3&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º4&quot;</span> &lt;&lt; endl;<br><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjYzNjA2Mg==,size_16,color_FFFFFF,t_70#pic_center.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/42db6f4ca3b14d01aa167cfda19d482a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¦‚æœä¸»çº¿ç¨‹çš„æœ€åä¸€æ­¥è¿è¡Œå®Œäº†ï¼Œå°±é€€å‡ºäº†ï¼Œå…¶ä»–å­çº¿ç¨‹å°±è¾“å‡ºä¸æ¥äº†</p><h4 id="1-1-4-joinable"><a href="#1-1-4-joinable" class="headerlink" title="1.1.4 joinable"></a>1.1.4 joinable</h4><p>æ¦‚å¿µï¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥æˆåŠŸä½¿ç”¨joinï¼ˆï¼‰æˆ–è€…detachï¼ˆï¼‰ã€‚è¿”å›trueï¼ˆå¯ä»¥ä½¿ç”¨joinï¼ˆï¼‰æˆ–è€…detachï¼ˆï¼‰ï¼‰æˆ–è€…falseï¼ˆä¸å¯ä»¥ä½¿ç”¨ï¼‰</p><p><strong>å³ï¼Œä½¿ç”¨äº†joinï¼ˆï¼‰å°±ä¸å¯ä»¥å†detachï¼ˆï¼‰ï¼Œä½¿ç”¨äº†detachï¼ˆï¼‰å°±ä¸å¯ä»¥å†joinï¼ˆï¼‰ï¼›</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-comment">//è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹ä¹Ÿè¦ä»ä¸€ä¸ªå‡½æ•°ï¼ˆåˆå§‹å‡½æ•°ï¼‰å¼€å§‹è¿è¡Œ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myprint</span><span class="hljs-params">()</span> </span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br><span class="hljs-function">thread <span class="hljs-title">mytobj</span><span class="hljs-params">(myprint)</span></span>;  <span class="hljs-comment">//ï¼ˆ1ï¼‰åˆ›å»ºäº†çº¿ç¨‹ï¼Œçº¿ç¨‹æ‰§è¡Œèµ·ç‚¹ï¼ˆå…¥å£ï¼‰myprintï¼ˆï¼‰ï¼› ï¼ˆ2ï¼‰myprintå¼€å§‹æ‰§è¡Œ</span><br><span class="hljs-keyword">if</span>(mytobj.<span class="hljs-built_in">joinable</span>())&#123;      <span class="hljs-comment">//è¿™é‡Œè¾“å‡º1.joinable() == true</span><br>cout&lt;&lt;<span class="hljs-string">&quot;1.joinable() == true&quot;</span>&lt;&lt;endl;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>cout&lt;&lt;<span class="hljs-string">&quot;1.joinable() == false&quot;</span>&lt;&lt;endl;<br>&#125;<br>    mytobj.<span class="hljs-built_in">detach</span>();  <span class="hljs-comment">//ä¸€æ—¦è°ƒç”¨äº†detachï¼ˆï¼‰ã€‚å°±ä¸èƒ½å†ä½¿ç”¨joinï¼ˆï¼‰</span><br>    <span class="hljs-keyword">if</span>(mytobj.<span class="hljs-built_in">joinable</span>())&#123;   <span class="hljs-comment">//è¿™é‡Œè¾“å‡º2.joinable() == false</span><br>cout&lt;&lt;<span class="hljs-string">&quot;2.joinable() == true&quot;</span>&lt;&lt;endl;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>cout&lt;&lt;<span class="hljs-string">&quot;2.joinable() == false&quot;</span>&lt;&lt;endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-å…¶ä»–åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•"><a href="#1-2-å…¶ä»–åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•" class="headerlink" title="1.2 å…¶ä»–åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•"></a>1.2 å…¶ä»–åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•</h3><h4 id="1-2-1-ç”¨ç±»ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹"><a href="#1-2-1-ç”¨ç±»ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹" class="headerlink" title="1.2.1 ç”¨ç±»ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹"></a>1.2.1 ç”¨ç±»ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TA</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">()</span> <span class="hljs-comment">//ä¸èƒ½å¸¦å‚æ•°ï¼Œé‡è½½äº†()</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">//2.1 ç”¨ç±»å¯¹è±¡ï¼ˆå¯è°ƒç”¨å¯¹è±¡ï¼‰ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹</span><br>TA ta;<br><span class="hljs-function">thread <span class="hljs-title">mytobj3</span><span class="hljs-params">(ta)</span></span>; <span class="hljs-comment">//taå¯è°ƒç”¨å¯¹è±¡</span><br>mytobj3.<span class="hljs-built_in">join</span>();    <span class="hljs-comment">//ç­‰å­çº¿ç¨‹æ‰§è¡Œç»“æŸ</span><br><br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/ca2a0f32f53c4949814faba1537ec0fb.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TA</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-type">int</span> &amp;m_i;<br><span class="hljs-built_in">TA</span>(<span class="hljs-type">int</span> &amp;i) :<span class="hljs-built_in">m_i</span>(i) &#123;<br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;;<br>    <span class="hljs-built_in">TA</span>(<span class="hljs-type">const</span> TA &amp; ta) :<span class="hljs-built_in">m_i</span>(ta.m_i) &#123;  <span class="hljs-comment">//å› ä¸ºæ˜¯å¤åˆ¶çš„ï¼Œæ‰€ä»¥è°ƒç”¨äº†æ‹·è´æ„é€ </span><br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()æ‹·è´æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;;<br>    ~<span class="hljs-built_in">TA</span>()&#123;<br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()ææ„å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">()</span> <span class="hljs-comment">//ä¸èƒ½å¸¦å‚æ•°ï¼Œé‡è½½äº†()</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;m_içš„å€¼ä¸º&quot;</span> &lt;&lt;m_i&lt;&lt; endl;<br><br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">//2.1 ç”¨ç±»å¯¹è±¡ï¼ˆå¯è°ƒç”¨å¯¹è±¡ï¼‰ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹</span><br><span class="hljs-type">int</span> myi = <span class="hljs-number">0</span>;<br><span class="hljs-function">TA <span class="hljs-title">ta</span><span class="hljs-params">(myi)</span></span>;<br><span class="hljs-function">thread <span class="hljs-title">mytobj3</span><span class="hljs-params">(ta)</span></span>; <span class="hljs-comment">//taå¯è°ƒç”¨å¯¹è±¡</span><br>mytobj3.<span class="hljs-built_in">detach</span>();    <br><br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjYzNjA2Mg==,size_16,color_FFFFFF,t_70#pic_center-1693751275417-11.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/a9bcaa852dd64183ba5b0764f2ade151.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>åˆ†æï¼š</p><p>1ï¼‰myiä¸ºå±€éƒ¨å˜é‡ï¼Œå¼•ç”¨è¿‡å»å¦‚æœä¸»çº¿ç¨‹è¿è¡Œå®Œï¼Œé‚£myiå°±è¢«é”€æ¯äº†</p><p>2ï¼‰ä¸ºä»€ä¹ˆä¼šæœ‰æ‹·è´æ„é€ ï¼Ÿå› ä¸ºè¿™ä¸ªå¯¹è±¡å®é™…ä¸Šæ˜¯è¢«å¤åˆ¶åˆ°çº¿ç¨‹ä¸­å»çš„</p><p>3ï¼‰ä¸ºä»€ä¹ˆææ„ä¸¤æ¬¡ï¼Ÿä¾‹å­1é‡Œé‚£ä¸ªç¬¬ä¸€æ¬¡æ˜¯å¤åˆ¶çš„é‚£ä¸ªtaçš„ææ„ï¼Œç¬¬äºŒæ¬¡æ˜¯taçš„ææ„ï¼Œä¾‹å­2é‡Œé‚£ä¸ªæ˜¯taçš„ææ„</p><blockquote><p>åˆ†æï¼š</p><p>1ï¼‰myiä¸ºå±€éƒ¨å˜é‡ï¼Œå¼•ç”¨è¿‡å»å¦‚æœä¸»çº¿ç¨‹è¿è¡Œå®Œï¼Œé‚£myiå°±è¢«é”€æ¯äº†</p><p>2ï¼‰ä¸ºä»€ä¹ˆä¼šæœ‰æ‹·è´æ„é€ ï¼Ÿå› ä¸ºè¿™ä¸ªå¯¹è±¡å®é™…ä¸Šæ˜¯è¢«å¤åˆ¶åˆ°çº¿ç¨‹ä¸­å»çš„</p><p>3ï¼‰ä¸ºä»€ä¹ˆææ„ä¸¤æ¬¡ï¼Ÿä¾‹å­1é‡Œé‚£ä¸ªç¬¬ä¸€æ¬¡æ˜¯å¤åˆ¶çš„é‚£ä¸ªtaçš„ææ„ï¼Œç¬¬äºŒæ¬¡æ˜¯taçš„ææ„ï¼Œä¾‹å­2é‡Œé‚£ä¸ªæ˜¯taçš„ææ„</p></blockquote><p>å¯ä»¥ç”¨joinï¼ˆï¼‰çœ‹çœ‹æ­£å¸¸çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TA</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-type">int</span> &amp;m_i;<br><span class="hljs-built_in">TA</span>(<span class="hljs-type">int</span> &amp;i) :<span class="hljs-built_in">m_i</span>(i) &#123;<br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;;<br>    <span class="hljs-built_in">TA</span>(<span class="hljs-type">const</span> TA &amp; ta) :<span class="hljs-built_in">m_i</span>(ta.m_i) &#123;  <span class="hljs-comment">//å› ä¸ºæ˜¯å¤åˆ¶çš„ï¼Œæ‰€ä»¥è°ƒç”¨äº†æ‹·è´æ„é€ </span><br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()æ‹·è´æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;;<br>    ~<span class="hljs-built_in">TA</span>()&#123;<br>        cout&lt;&lt;<span class="hljs-string">&quot;TA()ææ„å‡½æ•°è¢«æ‰§è¡Œ&quot;</span>&lt;&lt;endl;<br>    &#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">()</span> <span class="hljs-comment">//ä¸èƒ½å¸¦å‚æ•°ï¼Œé‡è½½äº†()</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;m_içš„å€¼ä¸º&quot;</span> &lt;&lt;m_i&lt;&lt; endl;<br><br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•äº†&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-comment">//2.1 ç”¨ç±»å¯¹è±¡ï¼ˆå¯è°ƒç”¨å¯¹è±¡ï¼‰ï¼Œä»¥åŠä¸€ä¸ªé—®é¢˜èŒƒä¾‹</span><br><span class="hljs-type">int</span> myi = <span class="hljs-number">0</span>;<br><span class="hljs-function">TA <span class="hljs-title">ta</span><span class="hljs-params">(myi)</span></span>;<br><span class="hljs-function">thread <span class="hljs-title">mytobj3</span><span class="hljs-params">(ta)</span></span>; <span class="hljs-comment">//taå¯è°ƒç”¨å¯¹è±¡</span><br>mytobj3.<span class="hljs-built_in">join</span>();    <br><br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjYzNjA2Mg==,size_16,color_FFFFFF,t_70#pic_center-1693751311705-16.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><h4 id="1-2-2-ç”¨lambda"><a href="#1-2-2-ç”¨lambda" class="headerlink" title="1.2.2 ç”¨lambda"></a>1.2.2 ç”¨lambda</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span><br><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">auto</span> mylamthread = [] &#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œäº†&quot;</span> &lt;&lt; endl;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;æˆ‘çš„çº¿ç¨‹æ‰§è¡Œç»“æŸäº†&quot;</span> &lt;&lt; endl;<br>&#125;;<br><br><span class="hljs-function">thread <span class="hljs-title">mytobj4</span><span class="hljs-params">(mylamthread)</span></span>;<br>mytobj4.<span class="hljs-built_in">join</span>();<br><br>cout &lt;&lt; <span class="hljs-string">&quot;ä¸»çº¿ç¨‹æ”¶å°¾ï¼Œæœ€ç»ˆä¸»çº¿ç¨‹æ­£å¸¸é€€å‡º&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/09/03/C-%E5%B9%B6%E5%8F%91%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/3fc19ace7a88487d97337223fdef3ca3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘æ¢ä¸ªè§’åº¦ç†è§£Androidçš„AIDLåŸç†</title>
    <link href="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/"/>
    <url>/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€è½¬è½½ã€‘æ¢ä¸ªè§’åº¦ç†è§£Androidçš„AIDLåŸç†"><a href="#ã€è½¬è½½ã€‘æ¢ä¸ªè§’åº¦ç†è§£Androidçš„AIDLåŸç†" class="headerlink" title="ã€è½¬è½½ã€‘æ¢ä¸ªè§’åº¦ç†è§£Androidçš„AIDLåŸç†"></a>ã€è½¬è½½ã€‘æ¢ä¸ªè§’åº¦ç†è§£Androidçš„AIDLåŸç†</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.jianshu.com/p/5de1718454f8">https://www.jianshu.com/p/5de1718454f8</a></p></blockquote><h2 id="æœ¬æ–‡æ€è·¯"><a href="#æœ¬æ–‡æ€è·¯" class="headerlink" title="æœ¬æ–‡æ€è·¯"></a>æœ¬æ–‡æ€è·¯</h2><p>æœ¬ç¯‡æ–‡ç« ç¬”è€…è°ˆè®ºçš„æ˜¯androidä½¿ç”¨AIDLè¿›è¡Œè¿›ç¨‹é—´<a href="https://so.csdn.net/so/search?q=%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86&spm=1001.2101.3001.7020">é€šä¿¡åŸç†</a>ï¼Œä½†æœ¬æ–‡ä¸æ‰“ç®—ä¸€ä¸Šæ¥å°±ä»‹ç»å¦‚ä½•ä½¿ç”¨AIDLï¼Œæœ¬æ–‡ä¼šå…ˆå‡è®¾Androidæ²¡æœ‰æä¾›AIDLæˆ‘ä»¬åº”è¯¥å¦‚ä½•â€œç”¨è‡ªå·±çš„æ–¹å¼â€å®ç°IPC,ä»‹ç»å®Œè¿™ä¸€ç‚¹ä¹‹åï¼Œæœ¬æ–‡å†å¯¹æ¯”AIDLè¿™ç§æ–¹å¼å®ç°IPCï¼Œå¹¶å°è¯•ç†è§£AIDLèƒŒåä»£ç ä¹‹é—´çš„å…³ç³»ã€‚ä¸‹æ–‡å›¾ç‰‡æ˜¯æœ¬æ–‡â€œç”¨è‡ªå·±çš„æ–¹å¼â€å®ç°IPCçš„æ¡ˆä¾‹äº¤äº’å›¾ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/f9d2a6c4d4fdec395eabf302ff80ec47.png" alt="640?wx_fmt=png" style="zoom:80%;"><p>è“è‰²éƒ¨åˆ†çš„LibraryServerå’ŒClientæ˜¯æœ¬æ–‡æ¡ˆä¾‹ä¸­ä¸¤ä¸ªä¸åŒçš„APP,å…¶ä¸­LibraryServerèƒ½å¤Ÿæä¾›å·¦è¾¹ç»¿è‰²éƒ¨åˆ†çš„â€œBookCheckServiceâ€æœåŠ¡ï¼ˆåŒ…å«getBookInfoã€getBookListï¼‰ï¼Œä¸ºäº†èƒ½å¤Ÿæ‹¥æœ‰æä¾›è¿œç¨‹æœåŠ¡çš„èƒ½åŠ›LibraryServeråŒæ—¶è¿˜â€œæ‹›è˜â€äº†Binderè¿™ç§å…·æœ‰è¿œç¨‹äº¤äº’èƒ½åŠ›çš„å¯¹è±¡ï¼Œäºæ˜¯LibraryServeré€šè¿‡â€œBookCheckServiceâ€+â€Binderâ€è¿™å¯¹ç»„åˆå°±æ‹¥æœ‰æä¾›è¿œç¨‹æœåŠ¡çš„èƒ½åŠ›äº†ã€‚è€ŒClientä¹Ÿæ˜¯â€œæ‹›è˜â€äº†Binderï¼Œä¼å›¾é€šè¿‡Binderæ¥ä½¿ç”¨è¿œç¨‹æœåŠ¡ã€‚â€œé»„è‰²éƒ¨åˆ†â€åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå…¶å®è¿™åªæ˜¯ç¬”è€…å¯¹Binderæœºåˆ¶åœ¨åº•å±‚é€šä¿¡è¿›è¡Œçš„æç®€çš„æè¿°ï¼Œå®é™…ä¸ŠBinderæœºåˆ¶åœ¨åº•å±‚é€šä¿¡ååˆ†å¤æ‚ï¼Œç¬”è€…æ‰“ç®—æ”¾åœ¨å…¶å®ƒç¯‡ç« è®¨è®ºï¼›â€œé»„è‰²â€éƒ¨åˆ†ç®€å•åœ°è§£é‡Šäº†è¿œç¨‹æœåŠ¡LibraryServerå…¶å®æ˜¯å°†å®ƒè‡ªå·±çš„Binderçš„å¥æŸ„æ³¨å†Œåœ¨å†…æ ¸ï¼ŒClientå®é™…ä¸Šæ‹¿åˆ°çš„åªæ˜¯LibraryServerçš„Binderçš„å¥æŸ„ï¼Œé€šè¿‡å†…æ ¸çš„Binderæ˜ å°„ï¼Œå†ä¸è¿œç¨‹æœåŠ¡äº¤äº’ã€‚</p><h2 id="Demoå…³é”®ä»£ç åˆ†æ"><a href="#Demoå…³é”®ä»£ç åˆ†æ" class="headerlink" title="Demoå…³é”®ä»£ç åˆ†æ"></a>Demoå…³é”®ä»£ç åˆ†æ</h2><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/ddc2004c818be797cad61375e7548642.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>ä¸Šæ–‡æ˜¯Client  APPè¿è¡Œåçš„æ˜¾ç¤ºæ•ˆæœï¼ŒåŠŸèƒ½å¾ˆç®€å•ï¼Œä¸‹é¢å¯¹ä¸»è¦ä»£ç è¿›è¡Œè¯´æ˜ï¼š</p><h3 id="Clientç«¯ä»£ç "><a href="#Clientç«¯ä»£ç " class="headerlink" title="Clientç«¯ä»£ç "></a>Clientç«¯ä»£ç </h3><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/44f549497215f70d3d6df4a727d26453.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/76fd7c1d276d0e83d66b72cd77832c3a.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>ä¸‹é¢è¿™ä¸ªå‡½æ•°æ˜¯è¯·æ±‚â€œæŸ¥è¯¢å›¾ä¹¦ä¿¡æ¯â€è¿œç¨‹æœåŠ¡çš„å®ç°é€»è¾‘</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/7d2262f9a5beab91f92f8dd05d10319d.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>åŒæ ·è¯·æ±‚â€œè·å–å›¾ä¹¦åˆ—è¡¨â€è¿œç¨‹æœåŠ¡çš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/383cdc4da40ae23b7072284ac633d4ac.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><h3 id="è¿œç¨‹ç«¯LibraryServer-ä»£ç "><a href="#è¿œç¨‹ç«¯LibraryServer-ä»£ç " class="headerlink" title="è¿œç¨‹ç«¯LibraryServer ä»£ç "></a>è¿œç¨‹ç«¯LibraryServer ä»£ç </h3><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/0563a66fd5a4994ee826735ef3d48e30.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/9865ec2e305a8fd7d0d214c09825c8c2.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/288ed2bb1bc64eb503e30949e3b6cbdf.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><h2 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h2><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/6386a9f7d671f670b91e3bbeda91ec1c.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><h2 id="AIDLå®ç°IPC"><a href="#AIDLå®ç°IPC" class="headerlink" title="AIDLå®ç°IPC"></a>AIDLå®ç°IPC</h2><p>ä¸Šæ–‡æåˆ°çš„æ˜¯ä½¿ç”¨â€œè‡ªå·±çš„æ–¹å¼â€å®ç°IPC,ä¸‹æ–‡ä»‹ç»åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨AIDLé€šä¿¡çš„ï¼Œå…³äºå¦‚ä½•åœ¨AndroidStudioåˆ›å»ºAIDLæ–‡ä»¶ï¼Œè¿™é‡Œç¬”è€…ä¸å†ç»†è¯´ï¼Œä¸æ¸…æ¥šçš„æœ‹å‹å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="http://www.jianshu.com/p/d1fac6ccee98%EF%BC%8C%E4%B8%8B%E5%9B%BE%E4%B8%BA%E4%BD%BF%E7%94%A8AIDL%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%A6%82%E4%B8%8B">http://www.jianshu.com/p/d1fac6ccee98ï¼Œä¸‹å›¾ä¸ºä½¿ç”¨AIDLè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼Œå¦‚ä¸‹</a></p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/1fdf4a758743305dfd5b51ed1910460c.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><blockquote><p>æ³¨æ„ï¼šStubç»§æ‰¿äº†Binderï¼Œå¹¶ä¸”å®ç°äº†AIDLç”Ÿæˆçš„æ¥å£BookCheckService</p></blockquote><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/d6361afa94761d25a7b0a6eab191661c.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><blockquote><p>æ³¨æ„ï¼šProxyæ˜¯Stubä¸­çš„ç±»ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬èƒ½çœ‹åˆ°Stub.Proxyè¿™ç§è¡¨ç¤º</p></blockquote><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/dffd09c9418dff635e987bc8bf556676.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><blockquote><p>æ³¨æ„ï¼šProxyä¸­çš„remoteå°±æ˜¯Binderä¸­ä¼ é€’å‡ºæ¥çš„Stubå¯¹è±¡</p></blockquote><p>ä¸Šå›¾æ˜¯ç¬”è€…ä½¿ç”¨AIDLè‡ªåŠ¨æˆçš„BooKCheckService.javaæ–‡ä»¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„UMLæ¥æè¿°å„ä¸ªç±»ä¹‹é—´çš„è”ç³»ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/b42d286e23ae18ecc4bbaaaaeca41db8.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä»¥ä¸‹å…³é”®ä»£ç ï¼š</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/93f879f72ec17c9ef57d9e9578687bf8.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>å†æ¥çœ‹çœ‹Proxyç±»ä¸­çš„ç»†èŠ‚ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/08/27/%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%90%86%E8%A7%A3Android%E7%9A%84AIDL%E5%8E%9F%E7%90%86/1a9c493a79260cbbe28a90ef32d28bb9.jpeg" alt="640?wx_fmt=png" style="zoom:80%;"><p>åˆ°æ­¤å¯ä»¥çœ‹åˆ°AIDLå®ç°IPCä¸ä¸Šæ–‡æˆ‘ä»¬ä»¥â€œä»¥è‡ªå·±çš„æ–¹å¼â€å®ç°IPCæœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯AIDLè¯­è¨€ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆç›¸å…³çš„ç±»ï¼Œç®€åŒ–æˆ‘ä»¬çš„ç¼–ç å·¥ä½œã€‚</p><h2 id="æ¡ˆä¾‹æºç "><a href="#æ¡ˆä¾‹æºç " class="headerlink" title="æ¡ˆä¾‹æºç "></a>æ¡ˆä¾‹æºç </h2><p><a href="https://github.com/ZhongXiaoHong/AIDLExample">https://github.com/ZhongXiaoHong/AIDLExample</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“context.getSystemServiceåŸç†è§£æ</title>
    <link href="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“context-getSystemServiceåŸç†è§£æ"><a href="#å®‰å“context-getSystemServiceåŸç†è§£æ" class="headerlink" title="å®‰å“context.getSystemServiceåŸç†è§£æ"></a>å®‰å“context.getSystemServiceåŸç†è§£æ</h1><p>å¾ˆå¤šçš„ä»£ç é‡Œé¢éƒ½ä¼šè°ƒç”¨context.getSystemServiceæ¥è·å–ç³»ç»ŸæœåŠ¡ï¼Œä¾‹å¦‚</p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827211203679.png" alt="image-20230827211203679" style="zoom: 50%;"><p>è¿™é‡Œä¼šä¼ å…¥StorageManagerçš„Classå¯¹è±¡ã€‚</p><p><strong>å…ˆçœ‹è¿™å¼ å›¾ï¼Œç”»çš„æ¯”è¾ƒæ¸…æ™°ï¼Œçœ‹çš„æ—¶å€™ä¼šæ¸…æ™°ä¸€ç‚¹ã€‚</strong></p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/c3e563f5c6584600a67a4483876d0395tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp" alt="context.getSystemServiceåŸç†-1 (1).png" style="zoom:80%;"><h2 id="1-SystemServiceRegistryç³»ç»ŸæœåŠ¡æ³¨å†Œä¸­å¿ƒ"><a href="#1-SystemServiceRegistryç³»ç»ŸæœåŠ¡æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="1.SystemServiceRegistryç³»ç»ŸæœåŠ¡æ³¨å†Œä¸­å¿ƒ"></a>1.SystemServiceRegistryç³»ç»ŸæœåŠ¡æ³¨å†Œä¸­å¿ƒ</h2><p>è¿™ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒä¸å…·ä½“çš„æœåŠ¡å®ä¾‹æ— å…³</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\core\java\android\app\SystemServiceRegistry.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemServiceRegistry</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;Class&lt;?&gt;, String&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;String, ServiceFetcher&lt;?&gt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; SYSTEM_SERVICE_CLASS_NAMES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;();<br>    <br>    <span class="hljs-comment">// é™æ€ä»£ç å—ï¼Œå½“JVMåŠ è½½SystemServiceRegistryçš„Classå¯¹è±¡æ—¶ï¼Œä¼šå»è°ƒç”¨é™æ€ä»£ç å—ï¼Œæ³¨å†Œå„ç±»æœåŠ¡</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        registerService(Context.STORAGE_SERVICE, StorageManager.class, <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachedServiceFetcher</span>&lt;StorageManager&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> StorageManager <span class="hljs-title function_">createService</span><span class="hljs-params">(ContextImpl ctx)</span> <span class="hljs-keyword">throws</span> ServiceNotFoundException &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageManager</span>(ctx, ctx.mMainThread.getHandler().getLooper());<br>                &#125;&#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-registerServiceæ³¨å†ŒæœåŠ¡"><a href="#1-1-registerServiceæ³¨å†ŒæœåŠ¡" class="headerlink" title="1.1 registerServiceæ³¨å†ŒæœåŠ¡"></a>1.1 registerServiceæ³¨å†ŒæœåŠ¡</h3><p>æ³¨å†ŒæœåŠ¡çš„æ—¶å€™å°±æ˜¯å¾€ä¸‰ä¸ªHashMapï¼ˆSYSTEM_SERVICE_NAMESã€SYSTEM_SERVICE_FETCHERSã€SYSTEM_SERVICE_CLASS_NAMESï¼‰ä¸­å†™å…¥å¯¹åº”çš„kvå€¼ï¼Œè¿™æ ·å¤–éƒ¨éœ€è¦è·å–çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡HashMapè·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerService</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String serviceName,</span><br><span class="hljs-params">                                        <span class="hljs-meta">@NonNull</span> Class&lt;T&gt; serviceClass, <span class="hljs-meta">@NonNull</span> ServiceFetcher&lt;T&gt; serviceFetcher)</span> &#123;<br>    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);<br>    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);<br>    SYSTEM_SERVICE_CLASS_NAMES.put(serviceName, serviceClass.getSimpleName());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-åˆ›å»ºCachedServiceFetcher"><a href="#1-2-åˆ›å»ºCachedServiceFetcher" class="headerlink" title="1.2 åˆ›å»ºCachedServiceFetcher"></a>1.2 åˆ›å»ºCachedServiceFetcher</h3><p>æ³¨æ„ï¼šåœ¨é™æ€ä»£ç å—æ³¨å†ŒæœåŠ¡çš„æ—¶å€™æœ‰éƒ¨åˆ†åˆ›å»ºçš„æ˜¯StaticServiceFetcherï¼Œæœ‰éƒ¨åˆ†æ˜¯åˆ›å»ºCachedServiceFetcher</p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827212939821.png" alt="image-20230827212939821" style="zoom: 50%;"><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827212955723.png" alt="image-20230827212955723" style="zoom: 50%;"><p>ä¸¤è€…å‡ç»§æ‰¿è‡ª<strong>ServicveFetcher</strong></p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/aa7b55dda2e541588b2cbb6d439d4f97tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp" alt="image.png" style="zoom: 80%;"><ul><li>CachedServiceFetcherï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ä»å¯¹åº”çš„contextImplå¯¹è±¡çš„ç¼“å­˜æ± ä¸­è·å–æœåŠ¡å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ–°åˆ›å»ºä¸€ä¸ª</li><li>StaticServiceFetcher ä¸ä¼šé’ˆå¯¹æ¯ä¸ªcontextImplåšç¼“å­˜ï¼Œç›´æ¥åœ¨å½“å‰è¿›ç¨‹ä¸­ï¼Œç¼“å­˜ä¸€ä¸ªå¯¹è±¡ã€‚ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li></ul><p><strong>æœ¬æ–‡æš‚æ—¶åªè®°å½•CacheServiceFetcher</strong></p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/b6628dc65f484200855da834774853e6tplv-k3u1fbpfcp-zoom-in-crop-mark1512000.webp" alt="context.getSystemServiceåŸç†-3 (3).png"><p>è¿™é‡Œçš„ç¼“å­˜æœºåˆ¶å¾ˆæœ‰æ„æ€ï¼Œä¹Ÿæ–¹ä¾¿ä»¥åè‡ªå·±ä¼˜åŒ–ä»£ç æ—¶å¯ä»¥å‚è€ƒï¼Œæ•…è¿›è¡Œè®°å½•</p><blockquote><ol><li>åœ¨ContextImplä¸­ç»´æŠ¤äº†ä¸€ä¸ªæ•°ç»„ï¼Œå…¶è®°å½•äº†å·²ç»è¢«ç¼“å­˜çš„ç³»ç»ŸæœåŠ¡ã€contextImplåªæ˜¯ç»´æŠ¤ç¼“å­˜é˜Ÿåˆ—ï¼Œæ“ä½œç¼“å­˜é˜Ÿåˆ—æ˜¯åœ¨CachedServiceFetcherä¸­ã€‘</li><li>å½“æˆ‘ä»¬è°ƒç”¨getServiceçš„æ—¶å€™ï¼Œå…ˆå»ç¼“å­˜é˜Ÿåˆ—ä¸­è·å–ï¼›å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰åˆ™åˆ›å»ºååŠ å…¥ç¼“å­˜é˜Ÿåˆ—</li></ol></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedServiceFetcher</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServiceFetcher</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mCacheIndex;<br><br>    CachedServiceFetcher() &#123;<br>        <span class="hljs-comment">// æœåŠ¡å¯¹è±¡åœ¨ç¼“å­˜ä¸­çš„ç´¢å¼•</span><br>        mCacheIndex = sServiceCacheSize++;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> T <span class="hljs-title function_">getService</span><span class="hljs-params">(ContextImpl ctx)</span> &#123;<br>        <span class="hljs-comment">// è·å–ContextImplä¸­ä½ çš„cacheå’Œgates</span><br>        <span class="hljs-comment">// cacheå­˜æ”¾æœåŠ¡çš„ç¼“å­˜</span><br>        <span class="hljs-comment">// gateå­˜æ”¾åˆå§‹åŒ–åçš„æœåŠ¡</span><br>        <span class="hljs-keyword">final</span> Object[] cache = ctx.mServiceCache;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] gates = ctx.mServiceInitializationStateArray;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-type">T</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">doInitialize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">synchronized</span> (cache) &#123;<br>                <span class="hljs-comment">// é¦–å…ˆå°è¯•ä»æœåŠ¡ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœæ‰¾åˆ°å°±ç›´æ¥è¿”å›ã€‚</span><br>                <span class="hljs-type">T</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> (T) cache[mCacheIndex];<br>                <br>                <span class="hljs-comment">// æŸ¥è¯¢æœåŠ¡ç¼“å­˜æ—¶æœ‰ä¸¤ç§æƒ…å†µå¯ä»¥ç›´æ¥è¿”å›ï¼š</span><br>                <span class="hljs-comment">// 1. service != null è¡¨ç¤ºè¯¥ç±»æœåŠ¡å·²ç»è¢«åˆ›å»ºå¹¶ä¿å­˜åœ¨æœåŠ¡ç¼“å­˜é‡Œï¼Œç›´æ¥è¿”å›æœåŠ¡å®ä¾‹å³å¯ï¼›</span><br>                <span class="hljs-comment">// 2. service == null &amp;&amp; gets[mCacheIndex] == ContextImpl.STATE_NOT_FOUND</span><br>                <span class="hljs-keyword">if</span> (service != <span class="hljs-literal">null</span>) &#123;<br>                    ret = service;<br>                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// exit the for (;;)</span><br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (gates[mCacheIndex] == ContextImpl.STATE_READY<br>                        || gates[mCacheIndex] == ContextImpl.STATE_NOT_FOUND) &#123;<br>                    gates[mCacheIndex] = ContextImpl.STATE_UNINITIALIZED;<br>                &#125;<br><br>                <span class="hljs-comment">// æœåŠ¡æ²¡æœ‰åˆå§‹åŒ–</span><br>                <span class="hljs-keyword">if</span> (gates[mCacheIndex] == ContextImpl.STATE_UNINITIALIZED) &#123;<br>                    doInitialize = <span class="hljs-literal">true</span>;<br>                    gates[mCacheIndex] = ContextImpl.STATE_INITIALIZING;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// æœåŠ¡åˆå§‹åŒ–åå°†æœåŠ¡æ”¾å…¥ç¼“å­˜é˜Ÿåˆ—ä¸­</span><br>            <span class="hljs-keyword">if</span> (doInitialize) &#123;<br>                <span class="hljs-type">T</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-meta">@ServiceInitializationState</span> <span class="hljs-type">int</span> <span class="hljs-variable">newState</span> <span class="hljs-operator">=</span> ContextImpl.STATE_NOT_FOUND;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    service = createService(ctx);<br>                    newState = ContextImpl.STATE_READY;<br>                &#125; <span class="hljs-keyword">catch</span> (ServiceNotFoundException e) &#123;<br>                    onServiceNotFound(e);<br><br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-keyword">synchronized</span> (cache) &#123;<br>                        cache[mCacheIndex] = service;<br>                        gates[mCacheIndex] = newState;<br>                        cache.notifyAll();<br>                    &#125;<br>                &#125;<br>                ret = service;<br>                <span class="hljs-keyword">break</span>; <span class="hljs-comment">// exit the for (;;)</span><br>            &#125;<br><br>            <span class="hljs-comment">// ç”±äºå¯èƒ½å¤šä¸ªåœ°æ–¹è°ƒç”¨getServiceï¼Œæ‰€ä»¥è¦æ·é”</span><br>            <span class="hljs-keyword">synchronized</span> (cache) &#123;<br>                <span class="hljs-comment">// å½“å‰æ²¡æœ‰æœåŠ¡å®ä¾‹å¹¶ä¸”å·²ç»æœ‰çº¿ç¨‹æ­£åœ¨åˆ›å»ºæœåŠ¡å®ä¾‹æ—¶ï¼Œç­‰å¾…ã€‚</span><br>                <span class="hljs-keyword">while</span> (gates[mCacheIndex] &lt; ContextImpl.STATE_READY) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        interrupted |= Thread.interrupted();<br>                        cache.wait();<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        Slog.w(TAG, <span class="hljs-string">&quot;getService() interrupted&quot;</span>);<br>                        interrupted = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (interrupted) &#123;<br>            Thread.currentThread().interrupt();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">createService</span><span class="hljs-params">(ContextImpl ctx)</span> <span class="hljs-keyword">throws</span> ServiceNotFoundException;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-æ³¨æ„ï¼šSystemServiceRegistryæ³¨å†Œçš„æ˜¯æœåŠ¡çš„Managerä¸æ˜¯ManagerService"><a href="#1-3-æ³¨æ„ï¼šSystemServiceRegistryæ³¨å†Œçš„æ˜¯æœåŠ¡çš„Managerä¸æ˜¯ManagerService" class="headerlink" title="1.3 æ³¨æ„ï¼šSystemServiceRegistryæ³¨å†Œçš„æ˜¯æœåŠ¡çš„Managerä¸æ˜¯ManagerService"></a>1.3 æ³¨æ„ï¼šSystemServiceRegistryæ³¨å†Œçš„æ˜¯æœåŠ¡çš„Managerä¸æ˜¯ManagerService</h3><h2 id="2-è·å–å„ç±»æœåŠ¡Managerçš„Classå¯¹è±¡"><a href="#2-è·å–å„ç±»æœåŠ¡Managerçš„Classå¯¹è±¡" class="headerlink" title="2.è·å–å„ç±»æœåŠ¡Managerçš„Classå¯¹è±¡"></a>2.è·å–å„ç±»æœåŠ¡Managerçš„Classå¯¹è±¡</h2><p>å½“æˆ‘ä»¬è°ƒç”¨context.getSystemServiceçš„æ—¶å€™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\core\java\android\content\Context.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> &lt;T&gt; T <span class="hljs-title function_">getSystemService</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Class&lt;T&gt; serviceClass)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> getSystemServiceName(serviceClass);<br>    <span class="hljs-keyword">return</span> serviceName != <span class="hljs-literal">null</span> ? (T)getSystemService(serviceName) : <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-å…ˆè·å–SystemServiceName"><a href="#2-1-å…ˆè·å–SystemServiceName" class="headerlink" title="2.1 å…ˆè·å–SystemServiceName"></a>2.1 å…ˆè·å–SystemServiceName</h3><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827211657141.png" alt="image-20230827211657141" style="zoom:67%;"><blockquote><p>å‘ç°æ˜¯ä¸ªæŠ½è±¡å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ç°ç±»ä¸­å¯¹äºæŠ½è±¡å‡½æ•°çš„å®ç°</p></blockquote><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827211821602.png" alt="image-20230827211821602" style="zoom:50%;"><p>ä¸‹é¢å°±è¦è°ƒç”¨SystemServiceRegistryçš„getSystemServiceNameæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSystemServiceName</span><span class="hljs-params">(Class&lt;?&gt; serviceClass)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> SYSTEM_SERVICE_NAMES.get(serviceClass);<br>    <span class="hljs-keyword">return</span> serviceName;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ç¬¬ä¸€èŠ‚ä¸­çš„SystemServiceRegistryä¸­SYSTEM_SERVICE_NAMESä¸­è·å–StorageManager.classå¯¹åº”çš„serviceName</p><h3 id="2-2-å†å»è·å–ç³»ç»ŸæœåŠ¡Manager"><a href="#2-2-å†å»è·å–ç³»ç»ŸæœåŠ¡Manager" class="headerlink" title="2.2 å†å»è·å–ç³»ç»ŸæœåŠ¡Manager"></a>2.2 å†å»è·å–ç³»ç»ŸæœåŠ¡Manager</h3><p>å¦‚æœSystemServiceRegistryä¿å­˜äº†serviceNameï¼Œåˆ™å†è°ƒç”¨getSystemService</p><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827220638943.png" alt="image-20230827220638943" style="zoom: 67%;"><blockquote><p>å‘ç°æ˜¯ä¸ªæŠ½è±¡å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ç°ç±»ä¸­å¯¹äºæŠ½è±¡å‡½æ•°çš„å®ç°</p></blockquote><img src="/2023/08/27/%E5%AE%89%E5%8D%93context-getSystemService%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20230827220752441.png" alt="image-20230827220752441" style="zoom:50%;"><p>ä¸‹é¢å°±è¦è°ƒç”¨SystemServiceRegistryçš„getSystemServiceNameæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getSystemService</span><span class="hljs-params">(ContextImpl ctx, String name)</span> &#123;<br>    <span class="hljs-comment">// è·å–SYSTEM_SERVICE_FETCHERSä¿å­˜çš„æœåŠ¡</span><br>    <span class="hljs-keyword">final</span> ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);<br>    <span class="hljs-comment">// å¦‚æœæ˜¯CachedServiceFetcherè°ƒç”¨å…¶getServiceæ–¹æ³•[åœ¨1.2ä¸­åˆ†æäº†ï¼Œè·å–ç¼“å­˜ä¸­æœåŠ¡çš„Manager]</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> fetcher.getService(ctx);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-ä¸€å¥è¯æ€»ç»“"><a href="#3-ä¸€å¥è¯æ€»ç»“" class="headerlink" title="3.ä¸€å¥è¯æ€»ç»“"></a>3.ä¸€å¥è¯æ€»ç»“</h2><p>context.getSystemService<strong>è·å–çš„æ˜¯åˆ›å»ºçš„é‚£ä¸ªMangerå¯¹è±¡ï¼Œè€Œä¸æ˜¯MangerServiceå¯¹è±¡</strong>ã€‚ä¾‹å¦‚context.getSystemService(StorageManager.class)è·å–åˆ°çš„æ˜¯StorageManagerå¯¹è±¡ã€‚<strong>æ•´ä¸ªè¿‡ç¨‹å®Œå…¨ä¸æ¶‰åŠStorageManagerServiceï¼Œåªä¸è™šæ‹Ÿæœºä¸­çš„StorageMangerçš„Classå¯¹è±¡æœ‰å…³ã€‚</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è‡ªå·±å®ç°Androidçš„SystemService</title>
    <link href="/2023/08/27/%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0Android%E7%9A%84SystemService/"/>
    <url>/2023/08/27/%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0Android%E7%9A%84SystemService/</url>
    
    <content type="html"><![CDATA[<h1 id="è‡ªå·±å®ç°Androidçš„SystemService"><a href="#è‡ªå·±å®ç°Androidçš„SystemService" class="headerlink" title="è‡ªå·±å®ç°Androidçš„SystemService"></a>è‡ªå·±å®ç°Androidçš„SystemService</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://segmentfault.com/a/1190000039997577#item-2">https://segmentfault.com/a/1190000039997577#item-2</a></p></blockquote><p>åœ¨androidå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæœ‰å„å¼å„æ ·çš„æœåŠ¡ï¼Œå¦‚ä½•ç¼–å†™è‡ªå·±çš„æœåŠ¡å‘¢ï¼Ÿ</p><img src="/2023/08/27/%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0Android%E7%9A%84SystemService/1460000039997580.png" alt="img" style="zoom:80%;"><h2 id="1-ç¼–å†™AIDLæ–‡ä»¶"><a href="#1-ç¼–å†™AIDLæ–‡ä»¶" class="headerlink" title="1.ç¼–å†™AIDLæ–‡ä»¶"></a>1.ç¼–å†™AIDLæ–‡ä»¶</h2><p>æ–°å»º frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;hardware&#x2F;wuxiaolong&#x2F;IWuXiaolongManager.aidlï¼Œå†…å®¹å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> android.hardware.wuxiaolong;<br><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IWuXiaolongManager</span> &#123;<br>    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-Context-å®šä¹‰å˜é‡"><a href="#2-Context-å®šä¹‰å˜é‡" class="headerlink" title="2.Context å®šä¹‰å˜é‡"></a>2.Context å®šä¹‰å˜é‡</h2><p>åœ¨ Context é‡Œå®šä¹‰ä¸€ä¸ªä»£è¡¨ wuxiaolong æœåŠ¡çš„å­—ç¬¦ä¸²ï¼šframeworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;content&#x2F;Context.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WUXIAOLONG_SERVICE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;wuxiaolong&quot;</span>;<br></code></pre></td></tr></table></figure><h2 id="3-ç¼–å†™ç³»ç»ŸæœåŠ¡"><a href="#3-ç¼–å†™ç³»ç»ŸæœåŠ¡" class="headerlink" title="3.ç¼–å†™ç³»ç»ŸæœåŠ¡"></a>3.ç¼–å†™ç³»ç»ŸæœåŠ¡</h2><p>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;wuxiaolong&#x2F;WuXiaolongManagerService.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.android.server.wuxiaolong;<br><br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.hardware.wuxiaolong.IWuXiaolongManager;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WuXiaolongManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWuXiaolongManager</span>.Stub &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Context mContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WuXiaolongManagerService</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        mContext = context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;WuXiaolong..&quot;</span>;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ³¨å†Œç³»ç»ŸæœåŠ¡"><a href="#4-æ³¨å†Œç³»ç»ŸæœåŠ¡" class="headerlink" title="4.æ³¨å†Œç³»ç»ŸæœåŠ¡"></a>4.æ³¨å†Œç³»ç»ŸæœåŠ¡</h2><p>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.android.server.wuxiaolong.WuXiaolongManagerService;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// éƒ¨åˆ†ä»£ç çœç•¥...</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        android.util.Log.d(<span class="hljs-string">&quot;wxl&quot;</span>,<span class="hljs-string">&quot;SystemServer WuXiaolongManagerService&quot;</span>);<br>        ServiceManager.addService(Context.WUXIAOLONG_SERVICE, <span class="hljs-keyword">new</span> <span class="hljs-title class_">WuXiaolongManagerService</span>(context));<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        reportWtf(<span class="hljs-string">&quot;starting WuXiaolongManagerService&quot;</span>, e);<br>    &#125;<br>    <span class="hljs-comment">// éƒ¨åˆ†ä»£ç çœç•¥...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-ç¼–å†™-Manager-ç±»"><a href="#5-ç¼–å†™-Manager-ç±»" class="headerlink" title="5.ç¼–å†™ Manager ç±»"></a>5.ç¼–å†™ Manager ç±»</h2><p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;hardware&#x2F;wuxiaolong&#x2F;WuXiaolongManager.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> android.hardware.wuxiaolong;<br><br><span class="hljs-keyword">import</span> android.os.IBinder;<br><span class="hljs-keyword">import</span> android.os.ServiceManager;<br><span class="hljs-keyword">import</span> android.hardware.wuxiaolong.IWuXiaolongManager;<br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.os.RemoteException;<br><span class="hljs-keyword">import</span> android.compat.annotation.UnsupportedAppUsage;<br><span class="hljs-keyword">import</span> android.annotation.Nullable;<br><span class="hljs-keyword">import</span> android.os.ServiceManager.ServiceNotFoundException;<br><span class="hljs-keyword">import</span> android.annotation.SystemService;<br><br><span class="hljs-meta">@SystemService(Context.WUXIAOLONG_SERVICE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WuXiaolongManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WuXiaolongManager sInstance;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IWuXiaolongManager mService;<br>    <span class="hljs-keyword">private</span> Context mContext;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WuXiaolongManager</span><span class="hljs-params">(IWuXiaolongManager iWuXiaolongManager)</span> &#123;<br>        mService = iWuXiaolongManager;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets an instance of the WuXiaolong manager.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> The WuXiaolong manager instance.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@hide</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@UnsupportedAppUsage</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WuXiaolongManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        android.util.Log.d(<span class="hljs-string">&quot;wxl&quot;</span>, <span class="hljs-string">&quot;WuXiaolongManager getInstance&quot;</span>);<br>        <span class="hljs-keyword">synchronized</span> (WuXiaolongManager.class) &#123;<br>            <span class="hljs-keyword">if</span> (sInstance == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">IBinder</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> ServiceManager.getServiceOrThrow(Context.WUXIAOLONG_SERVICE);<br>                    sInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WuXiaolongManager</span>(IWuXiaolongManager.Stub<br>                            .asInterface(ServiceManager.getServiceOrThrow(Context.WUXIAOLONG_SERVICE)));<br>                &#125; <span class="hljs-keyword">catch</span> (ServiceNotFoundException e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);<br>                &#125;<br><br>            &#125;<br>            <span class="hljs-keyword">return</span> sInstance;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        android.util.Log.d(<span class="hljs-string">&quot;wxl&quot;</span>, <span class="hljs-string">&quot;WuXiaolongManager getName&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> mService.getName();<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-æ³¨å†Œ-Manager"><a href="#6-æ³¨å†Œ-Manager" class="headerlink" title="6.æ³¨å†Œ Manager"></a>6.æ³¨å†Œ Manager</h2><p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;app&#x2F;SystemServiceRegistry.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> android.hardware.wuxiaolong.WuXiaolongManager;<br><span class="hljs-keyword">static</span> &#123;<br>    registerService(Context.WUXIAOLONG_SERVICE, WuXiaolongManager.class,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachedServiceFetcher</span>&lt;WuXiaolongManager&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> WuXiaolongManager <span class="hljs-title function_">createService</span><span class="hljs-params">(ContextImpl ctx)</span><br>                        <span class="hljs-keyword">throws</span> ServiceNotFoundException &#123;<br>                    android.util.Log.d(<span class="hljs-string">&quot;wxl&quot;</span>,<span class="hljs-string">&quot;SystemServiceRegistry registerService&quot;</span>);<br>                    <span class="hljs-keyword">return</span> WuXiaolongManager.getInstance();<br>                &#125;&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-åº”ç”¨è°ƒç”¨"><a href="#7-åº”ç”¨è°ƒç”¨" class="headerlink" title="7.åº”ç”¨è°ƒç”¨"></a>7.åº”ç”¨è°ƒç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WuXiaolongManager</span> <span class="hljs-variable">mWuXiaolongManager</span> <span class="hljs-operator">=</span> (WuXiaolongManager)mContext.getSystemService(Context.WUXIAOLONG_SERVICE);<br>android.util.Log.d(<span class="hljs-string">&quot;wxl&quot;</span>,<span class="hljs-string">&quot;Name=&quot;</span>+ mWuXiaolongManager.getName());<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaçš„Classå¯¹è±¡</title>
    <link href="/2023/08/27/Java%E7%9A%84Class%E5%AF%B9%E8%B1%A1/"/>
    <url>/2023/08/27/Java%E7%9A%84Class%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaçš„Classå¯¹è±¡"><a href="#Javaçš„Classå¯¹è±¡" class="headerlink" title="Javaçš„Classå¯¹è±¡"></a>Javaçš„Classå¯¹è±¡</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.jianshu.com/p/7ef502580df3">https://www.jianshu.com/p/7ef502580df3</a></p></blockquote><h2 id="0-Javaçš„é™æ€ä»£ç æ®µå’Œæ„é€ ä»£ç æ®µ"><a href="#0-Javaçš„é™æ€ä»£ç æ®µå’Œæ„é€ ä»£ç æ®µ" class="headerlink" title="0.Javaçš„é™æ€ä»£ç æ®µå’Œæ„é€ ä»£ç æ®µ"></a>0.Javaçš„é™æ€ä»£ç æ®µå’Œæ„é€ ä»£ç æ®µ</h2><ul><li>é™æ€ä»£ç æ®µ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span>&#123;<br>    <span class="hljs-comment">// é™æ€ä»£ç å—</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é™æ€ä»£ç å—æ˜¯ç»™ç±»åˆå§‹åŒ–çš„ã€‚åœ¨ç±»åŠ è½½çš„åˆå§‹åŒ–é˜¶æ®µæ—¶å€™å°±è¢«è°ƒç”¨ï¼Œå¹¶ä¸”åªæ‰§è¡Œä¸€æ¬¡</p><ul><li>æ„é€ ä»£ç æ®µ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-comment">//æ„é€ ä»£ç å—</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ ä»£ç å—æ˜¯ç»™å¯¹è±¡åˆå§‹åŒ–çš„ã€‚æ¯ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚</p><p><strong>å¯¹äºä¸€ä¸ªç±»è€Œè¨€ï¼ŒæŒ‰ç…§å¦‚ä¸‹é¡ºåºæ‰§è¡Œï¼š</strong></p><p>1ã€æ‰§è¡Œé™æ€ä»£ç å—<br>2ã€æ‰§è¡Œæ„é€ ä»£ç å—<br>3ã€æ‰§è¡Œæ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloWorld</span><span class="hljs-params">()</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;this is no param constrcut&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">static</span> &#123;<br> System.out.println(<span class="hljs-string">&quot;this is static section&quot;</span>);<br>&#125;<br><br>&#123;<br> System.out.println(<span class="hljs-string">&quot;this is construct section&quot;</span>);<br>&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> &#123;<br><span class="hljs-type">HelloWorld</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelloWorld</span>();<br>       System.out.println(<span class="hljs-string">&quot;Hello World!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/27/Java%E7%9A%84Class%E5%AF%B9%E8%B1%A1/image-20230827195138399.png" alt="image-20230827195138399" style="zoom: 100%;"><h2 id="1-Classå¯¹è±¡"><a href="#1-Classå¯¹è±¡" class="headerlink" title="1.Classå¯¹è±¡"></a>1.Classå¯¹è±¡</h2><p>åœ¨Javaä¸­æœ‰ä¸¤ç§å¯¹è±¡ï¼šClasså¯¹è±¡å’Œå®ä¾‹å¯¹è±¡ï¼Œå®ä¾‹å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹ï¼Œé€šå¸¸æ˜¯é€šè¿‡<code>new</code>å…³é”®å­—æ„å»ºçš„ã€‚Classå¯¹è±¡æ˜¯JVMç”Ÿæˆç”¨æ¥ä¿å­˜å¯¹è±¡çš„ç±»çš„ä¿¡æ¯çš„ã€‚Javaç¨‹åºæ‰§è¡Œä¹‹å‰éœ€è¦ç»è¿‡ç¼–è¯‘ã€åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–è¿™å‡ ä¸ªé˜¶æ®µï¼Œç¼–è¯‘é˜¶æ®µä¼šå°†æºç æ–‡ä»¶ç¼–è¯‘ä¸º<code>.class</code>å­—èŠ‚ç æ–‡ä»¶ï¼Œç¼–è¯‘å™¨åŒæ—¶ä¼šåœ¨<code>.class</code>æ–‡ä»¶ä¸­ç”ŸæˆClasså¯¹è±¡ï¼ŒåŠ è½½é˜¶æ®µé€šè¿‡JVMå†…éƒ¨çš„ç±»åŠ è½½æœºåˆ¶ï¼Œå°†Classå¯¹è±¡åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨åˆ›å»ºå®ä¾‹å¯¹è±¡ä¹‹å‰ï¼ŒJVMä¼šå…ˆæ£€æŸ¥Classå¯¹è±¡æ˜¯å¦åœ¨å†…å­˜ä¸­å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åŠ è½½Classå¯¹è±¡ï¼Œç„¶åå†åˆ›å»ºå¯¹è±¡å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥æ ¹æ®Classå¯¹è±¡åˆ›å»ºå¯¹è±¡å®ä¾‹ã€‚JVMä¸­åªæœ‰ä¸€ä¸ªClasså¯¹è±¡ï¼Œä½†å¯ä»¥æ ¹æ®Classå¯¹è±¡ç”Ÿæˆå¤šä¸ªå¯¹è±¡å®ä¾‹ã€‚</p><h2 id="2-Classå¯¹è±¡çš„è·å¾—"><a href="#2-Classå¯¹è±¡çš„è·å¾—" class="headerlink" title="2.Classå¯¹è±¡çš„è·å¾—"></a>2.Classå¯¹è±¡çš„è·å¾—</h2><h3 id="2-1-ç±»å-class"><a href="#2-1-ç±»å-class" class="headerlink" title="2.1 ç±»å.class"></a>2.1 ç±»å.class</h3><p>å½“æ‰§è¡Œç±»å<code>.class</code>æ—¶ï¼ŒJVMä¼šå…ˆæ£€æŸ¥Classå¯¹è±¡æ˜¯å¦è£…å…¥å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰è£…å…¥å†…å­˜ï¼Œåˆ™å°†Classå¯¹è±¡è£…å…¥å†…å­˜ï¼Œç„¶åè¿”å›Classå¯¹è±¡ï¼Œå¦‚æœè£…å…¥å†…å­˜ï¼Œåˆ™ç›´æ¥è¿”å›Classå¯¹è±¡ã€‚åœ¨åŠ è½½Classå¯¹è±¡åï¼Œä¸ä¼šå¯¹Classå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run static initialization block.&quot;</span>);<br>    &#125;<br>    <br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run nonstatic initialization block.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassTest</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Test.class;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœä¸ºï¼šç©ºã€ä»€ä¹ˆéƒ½ä¸æ‰“å°ã€‘</p><h3 id="2-2-Class-forName"><a href="#2-2-Class-forName" class="headerlink" title="2.2 Class.forName()"></a>2.2 Class.forName()</h3><p>å½“æ‰§è¡Œ<code>Class.forName()</code>æ—¶ï¼ŒJVMä¹Ÿä¼šå…ˆæ£€æŸ¥Classå¯¹è±¡æ˜¯å¦è£…å…¥å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰è£…å…¥å†…å­˜ï¼Œåˆ™å°†Classå¯¹è±¡è£…å…¥å†…å­˜ï¼Œç„¶åè¿”å›Classå¯¹è±¡ï¼Œå¦‚æœè£…å…¥å†…å­˜ï¼Œåˆ™ç›´æ¥è¿”å›Classå¯¹è±¡ã€‚<strong>åœ¨åŠ è½½Classå¯¹è±¡åï¼Œä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œå³æ‰§è¡Œç±»çš„é™æ€ä»£ç å—</strong>ã€‚forName()æ–¹æ³•ä¸­çš„å‚æ•°æ˜¯ç±»åå­—ç¬¦ä¸²ï¼Œç±»åå­—ç¬¦ä¸² &#x3D; åŒ…å + ç±»åã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tyan.test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run static initialization block.&quot;</span>);<br>    &#125;<br>    <br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run nonstatic initialization block.&quot;</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">package</span> com.tyan.test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassTest</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.tyan.test.Test&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><img src="/2023/08/27/Java%E7%9A%84Class%E5%AF%B9%E8%B1%A1/image-20230827193927854.png" alt="image-20230827193927854" style="zoom:80%;"><h3 id="2-3-getClass"><a href="#2-3-getClass" class="headerlink" title="2.3 getClass"></a>2.3 getClass</h3><p><code>getClass()</code>æ–¹æ³•çš„æ–¹æ³•æ˜¯åœ¨é€šè¿‡çš„ç±»çš„å®ä¾‹è°ƒç”¨çš„ï¼Œå³å·²ç»åˆ›å»ºäº†ç±»çš„å®ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run static initialization block.&quot;</span>);<br>    &#125;<br>    <br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Run nonstatic initialization block.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassTest</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Test</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> t.getClass();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><img src="/2023/08/27/Java%E7%9A%84Class%E5%AF%B9%E8%B1%A1/image-20230827194008908.png" alt="image-20230827194008908" style="zoom:80%;"><h2 id="3-Classç±»çš„å¸¸ç”¨æ–¹æ³•"><a href="#3-Classç±»çš„å¸¸ç”¨æ–¹æ³•" class="headerlink" title="3.Classç±»çš„å¸¸ç”¨æ–¹æ³•"></a>3.Classç±»çš„å¸¸ç”¨æ–¹æ³•</h2><ul><li>getName()</li></ul><p>ä¸€ä¸ªClasså¯¹è±¡æè¿°äº†ä¸€ä¸ªç‰¹å®šç±»çš„å±æ€§ï¼ŒClassç±»ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•getNameä»¥Stringçš„å½¢å¼è¿”å›æ­¤Classå¯¹è±¡æ‰€è¡¨ç¤ºçš„å®ä½“ï¼ˆç±»ã€æ¥å£ã€æ•°ç»„ç±»ã€åŸºæœ¬ç±»å‹æˆ–voidåç§°ã€‚</p><ul><li>newInstance()</li></ul><p>Classè¿˜æœ‰ä¸€ä¸ªæœ‰ç”¨çš„æ–¹æ³•å¯ä»¥ä¸ºç±»åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªæ–¹æ³•å«åšnewInstance()ã€‚ä¾‹å¦‚ï¼š<code>x.getClass.newInstance()</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåŒ<code>x</code>ä¸€æ ·ç±»å‹çš„æ–°å®ä¾‹ã€‚<code>newInstance()</code>æ–¹æ³•è°ƒç”¨é»˜è®¤æ„é€ å™¨ï¼ˆæ— å‚æ•°æ„é€ å™¨ï¼‰åˆå§‹åŒ–æ–°å»ºå¯¹è±¡ã€‚</p><ul><li>getClassLoader()</li></ul><p>è¿”å›è¯¥ç±»çš„ç±»åŠ è½½å™¨ã€‚</p><ul><li>getComponentType()</li></ul><p>è¿”å›è¡¨ç¤ºæ•°ç»„ç»„ä»¶ç±»å‹çš„Classã€‚</p><ul><li>getSuperclass()</li></ul><p>è¿”å›è¡¨ç¤ºæ­¤ Class æ‰€è¡¨ç¤ºçš„å®ä½“ï¼ˆç±»ã€æ¥å£ã€åŸºæœ¬ç±»å‹æˆ– voidï¼‰çš„è¶…ç±»çš„Classã€‚</p><ul><li>isArray()</li></ul><p>åˆ¤å®šæ­¤ Class å¯¹è±¡æ˜¯å¦è¡¨ç¤ºä¸€ä¸ªæ•°ç»„ç±»ã€‚</p><h2 id="4-åå°„"><a href="#4-åå°„" class="headerlink" title="4.åå°„"></a>4.åå°„</h2><p>JAVAåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸ºjavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Androidå­˜å‚¨åŸŸæœåŠ¡å¯åŠ¨</title>
    <link href="/2023/08/24/Android%E5%AD%98%E5%82%A8%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/"/>
    <url>/2023/08/24/Android%E5%AD%98%E5%82%A8%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Androidå­˜å‚¨åŸŸæœåŠ¡å¯åŠ¨"><a href="#Androidå­˜å‚¨åŸŸæœåŠ¡å¯åŠ¨" class="headerlink" title="Androidå­˜å‚¨åŸŸæœåŠ¡å¯åŠ¨"></a>Androidå­˜å‚¨åŸŸæœåŠ¡å¯åŠ¨</h1><blockquote><p>éƒ¨åˆ†å‚è€ƒè‡ªï¼š<a href="https://blog.csdn.net/geshifei/article/details/131184012">https://blog.csdn.net/geshifei/article/details/131184012</a></p></blockquote><h2 id="1-å­˜å‚¨ç›¸å…³Service"><a href="#1-å­˜å‚¨ç›¸å…³Service" class="headerlink" title="1.å­˜å‚¨ç›¸å…³Service"></a>1.å­˜å‚¨ç›¸å…³Service</h2><h3 id="1-1-serviceä»‹ç»"><a href="#1-1-serviceä»‹ç»" class="headerlink" title="1.1 serviceä»‹ç»"></a>1.1 serviceä»‹ç»</h3><p>å­˜å‚¨æœ‰3ä¸ªå…³é”®serviceï¼šmountã€voldã€storagedï¼Œé€šè¿‡<code>adb shell &quot;service list&quot;</code>å¯ä»¥çœ‹åˆ°ã€‚</p><table><thead><tr><th>æœåŠ¡å</th><th>ä»£ç è·¯å¾„</th></tr></thead><tbody><tr><td>mount service</td><td>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;StorageManagerService.java</td></tr><tr><td>vold service</td><td>system&#x2F;vold ç›®å½•</td></tr><tr><td>storaged service</td><td>system&#x2F;core&#x2F;storaged ç›®å½•</td></tr></tbody></table><ul><li>mount serviceè´Ÿè´£mountå’Œumountå­˜å‚¨è®¾å¤‡æˆ–å­˜å‚¨å·ï¼Œæä¾›æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®æ¥å£ã€‚å®ƒçš„mountã€umountè¯·æ±‚ä¸‹å‘ç»™nativeå±‚çš„voldå¤„ç†ã€‚</li><li>vold (Volume Daemon)ä½äºframeworkå’Œkernelä¹‹é—´ï¼Œç®¡ç†å­˜å‚¨å·çš„ç”Ÿå‘½å‘¨æœŸã€å¤„ç†mount serviceçš„mountå’Œumountè¯·æ±‚ï¼Œä»¥åŠæä¾›å­˜å‚¨å·çš„ç®¡ç†æ¥å£ã€‚å…¶ä¸»è¦åŠŸèƒ½ä¸ºï¼š<ul><li>ç›‘å¬å†…æ ¸çš„å­˜å‚¨è®¾å¤‡ueventäº‹ä»¶ï¼Œå¹¶ä¸ŠæŠ¥ç»™mount serviceã€‚</li><li>å¤„ç†mount serviceä¸‹å‘çš„mountã€umountè¯·æ±‚ã€‚</li></ul></li><li>storagedæ˜¯ä¸€ä¸ªdeamonè¿›ç¨‹ï¼Œæä¾›å­˜å‚¨ç›¸å…³çš„ç»Ÿè®¡æ•°æ®ï¼ˆç£ç›˜ä½¿ç”¨ä¿¡æ¯ã€åº”ç”¨ioä¿¡æ¯ã€å­˜å‚¨å¯¿å‘½ä¿¡æ¯ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡å‘åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿç»„ä»¶æä¾› API æ¥å£ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿç›‘æ§å’Œç®¡ç†å­˜å‚¨èµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚</li></ul><h3 id="1-2-serviceä¹‹é—´çš„å…³ç³»"><a href="#1-2-serviceä¹‹é—´çš„å…³ç³»" class="headerlink" title="1.2 serviceä¹‹é—´çš„å…³ç³»"></a>1.2 serviceä¹‹é—´çš„å…³ç³»</h3><p>mountã€voldã€storagedä¹‹é—´çš„å±‚æ¬¡å…³ç³»å¦‚ä¸‹ï¼š</p><img src="/2023/08/24/Android%E5%AD%98%E5%82%A8%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/69175f9d8ce84cc58ab121e2a3ba7468.png" alt="img"><p> å›¾ä¸­æ ‡å·è¯´æ˜ï¼š</p><p><strong>â‘ ï¼šlooperçº¿ç¨‹ç›‘å¬ACTION_USER_ADDEDå’ŒACTION_USER_REMOVEDæ¶ˆæ¯ã€‚</strong></p><p>StorageManagerService::StorageManagerService â€“&gt; mContext.registerReceiver(mUserReceiver, userFilter, null, mHandler)æ³¨å†Œäº†BroadcastReceiver ï¼Œæ¥æ”¶ACTION_USER_ADDEDå’ŒACTION_USER_REMOVEDç±»å‹çš„ IntentFilter å¹¿æ’­æ¶ˆæ¯ï¼Œ å‚æ•°mHandleæ‰€ä»£è¡¨çš„çº¿ç¨‹ä¸Šæ‰§è¡Œ BroadcastReceiverã€‚</p><p>åœ¨StorageManagerServiceæ–¹æ³•ä¸­ï¼ŒmHandler &#x3D; new StorageManagerServiceHandler(hthread.getLooper())ï¼Œæ‰€ä»¥Handler ä»£è¡¨çš„çº¿ç¨‹æ˜¯looperçº¿ç¨‹ã€‚</p><p>mount serviceæ”¶åˆ°ACTION_USER_ADDEDå’ŒACTION_USER_REMOVEDåï¼Œä¼šåšmountæˆ–è€…unmountæ“ä½œã€‚</p><p><strong>â‘¡ï¼šmount serviceè®¾ç½®ä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬voldçŠ¶æ€ã€‚</strong></p><p>StorageManagerService::connectVold â€“&gt; mVold &#x3D; IVold.Stub.asInterface(binder)è·å–vold serviceçš„Binderå¯¹è±¡ï¼Œæ¥ç€mount serviceé€šè¿‡mVold.setListener(mListener)è®¾ç½®ç›‘å¬å™¨ç›‘å¬voldçŠ¶æ€å˜åŒ–ï¼Œç›‘å¬å™¨å›è°ƒæ–¹æ³•åœ¨StorageManagerServiceçš„åŒ¿åå†…éƒ¨ç±»ä¸­ï¼ˆè§private final IVoldListener mListener &#x3D; new IVoldListener.Stub()å¤„çš„åŒ¿åç±»ï¼‰ã€‚ä¸€æ—¦voldçŠ¶æ€å˜åŒ–ï¼Œå°±ä¼šæ‰§è¡Œç›‘å¬å™¨å›è°ƒæ–¹æ³•ï¼Œè§â‘¤ã€‚</p><p><strong>â‘¢ï¼šmount serviceè·å–storagedçš„binderå¯¹è±¡ï¼Œéœ€è¦çš„æ—¶å€™æ‰§è¡Œstoragedä¸­çš„æ–¹æ³•ã€‚</strong></p><p>StorageManagerService::connectStoraged â€“&gt; mStoraged &#x3D; IStoraged.Stub.asInterface(binder)è·å–storaged serviceçš„Binderå¯¹è±¡ã€‚mount serviceæ¥æ”¶åˆ°ç›¸å…³äº‹ä»¶åï¼Œæ¯”å¦‚unlock userï¼Œremove userç­‰ï¼Œæ‰§è¡Œstoragedä¸­çš„å‡½æ•°mStoraged.onUserStarted(userId)ï¼ŒmStoraged.onUserStopped(userId)ç­‰ã€‚</p><p><strong>â‘£ï¼šVoldNativeServiceæ‰§è¡ŒVolumeManagerä¸­çš„æ–¹æ³•ã€‚</strong></p><p>VoldNativeServiceé€šè¿‡ç±»ä¼¼äºtranslate(VolumeManager::Instance()-&gt;XXXæ‰§è¡ŒVolumeManagerä¸­çš„æ–¹æ³•ã€‚æ¯”å¦‚VoldNativeService::onUserAdded â€“&gt; translate(VolumeManager::Instance()-&gt;onUserAdded(userId, userSerial))ï¼Œæ‰§è¡Œçš„æ˜¯VolumeManager::onUserAddedã€‚</p><p><strong>â‘¤ï¼šVolumeManagerä¸ŠæŠ¥å­˜å‚¨è®¾å¤‡äº‹ä»¶ç»™mount serviceã€‚</strong></p><p>ç”¨æˆ·addæˆ–åˆ é™¤ï¼Œéœ€è¦mountæˆ–è€…umountæ‰emulated storageï¼›çƒ­æ’æ‹”å­˜å‚¨è®¾å¤‡ï¼Œkernelä¼šä¸ŠæŠ¥ueventäº‹ä»¶ï¼Œè¿™äº›éƒ½ä¼šå¼•èµ·voldçŠ¶æ€å˜åŒ–ï¼Œæ­¤æ—¶mount serviceåœ¨â‘¡ä¸­è®¾ç½®çš„ç›‘å¬å™¨å°±ç›‘å¬åˆ°è¿™äº›äº‹ä»¶ï¼Œæ‰§è¡Œå¯¹åº”çš„ç›‘å¬å™¨å›è°ƒæ–¹æ³•ã€‚</p><p><strong>â‘¥ï¼šNetlinkManageråˆå§‹åŒ–socketï¼Œç”¨äºæ¥æ”¶kernelçš„ueventäº‹ä»¶ã€‚</strong></p><p>system&#x2F;vold&#x2F;main.cppä¸­é€šè¿‡nm &#x3D; NetlinkManager::Instance()å®ä¾‹åŒ–äº†ä¸€ä¸ªNetlinkManagerï¼Œç”¨äºæ¥æ”¶kernelçš„ueventäº‹ä»¶ã€‚</p><p><strong>â‘¦ï¼šVolumeManageræ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ‰§è¡Œmountç­‰æ“ä½œã€‚</strong></p><p>VolumeManageré€šè¿‡VolumeManagerç±»æ‰§è¡Œkernelçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚VolumeManager::mountAppFuse â€“&gt; android::vold::MountAppFuse â€“&gt; RunCommand â€“&gt; mountç­‰ã€‚</p><h2 id="2-å„æœåŠ¡å¯åŠ¨"><a href="#2-å„æœåŠ¡å¯åŠ¨" class="headerlink" title="2.å„æœåŠ¡å¯åŠ¨"></a>2.å„æœåŠ¡å¯åŠ¨</h2><h3 id="2-1-mount-service-SMS-å¯åŠ¨"><a href="#2-1-mount-service-SMS-å¯åŠ¨" class="headerlink" title="2.1 mount service(SMS)å¯åŠ¨"></a>2.1 mount service(SMS)å¯åŠ¨</h3><p>mount serviceä¸å…¶ä»–æœåŠ¡ä¸€æ ·ï¼Œæ˜¯ç”±SystemServeræ‹‰èµ·çš„ï¼š</p><p>SystemServer.run -&gt; startOtherServices</p><img src="/2023/08/24/Android%E5%AD%98%E5%82%A8%E5%9F%9F%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/image-20230824235423489.png" alt="image-20230824235423489" style="zoom:56%;"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">STORAGE_MANAGER_SERVICE_CLASS</span> <span class="hljs-operator">=</span><br>    <span class="hljs-string">&quot;com.android.server.StorageManagerService$Lifecycle&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">STORAGE_STATS_SERVICE_CLASS</span> <span class="hljs-operator">=</span><br>    <span class="hljs-string">&quot;com.android.server.usage.StorageStatsService$Lifecycle&quot;</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;<br>    t.traceBegin(<span class="hljs-string">&quot;startOtherServices&quot;</span>);<br>    <br>    <span class="hljs-type">IStorageManager</span> <span class="hljs-variable">storageManager</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <br>    <span class="hljs-keyword">if</span> (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;0&quot;</span>.equals(SystemProperties.get(<span class="hljs-string">&quot;system_init.startmountservice&quot;</span>))) &#123;<br>            t.traceBegin(<span class="hljs-string">&quot;StartStorageManagerService&quot;</span>);<br>            mSystemServiceManager.startService(STORAGE_MANAGER_SERVICE_CLASS);<br>            storageManager = IStorageManager.Stub.asInterface(ServiceManager.getService(<span class="hljs-string">&quot;mount&quot;</span>));<br>            t.traceEnd();<br><br>            t.traceBegin(<span class="hljs-string">&quot;StartStorageStatsService&quot;</span>);<br>            mSystemServiceManager.startService(STORAGE_STATS_SERVICE_CLASS);<br>            t.traceEnd();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨SystemServiceManagerå¯åŠ¨æœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> SystemService <span class="hljs-title function_">startService</span><span class="hljs-params">(String className)</span> &#123;<br><span class="hljs-comment">// é€šè¿‡Javaåå°„æœºåˆ¶æ‹¿åˆ°æœåŠ¡çš„ç±»(loadClassFromLoaderä¼šé€šè¿‡Class.forNameè·å–Class)</span><br>    <span class="hljs-comment">// Class.forNameè¦æ±‚JVMæŸ¥æ‰¾å¹¶åŠ è½½æŒ‡å®šçš„ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´JVMä¼šæ‰§è¡Œè¯¥ç±»çš„é™æ€ä»£ç æ®µ</span><br>    <span class="hljs-keyword">final</span> Class&lt;SystemService&gt; serviceClass = loadClassFromLoader(className,<span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>    <span class="hljs-keyword">return</span> startService(serviceClass);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨é‡è½½çš„startServiceï¼Œä¼ å…¥çš„æ˜¯Classç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è¿™è¾¹çš„æ³›å‹æ˜¯SystemService</span><br><span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span>&gt; T <span class="hljs-title function_">startService</span><span class="hljs-params">(Class&lt;T&gt; serviceClass)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> serviceClass.getName();   <span class="hljs-comment">// é€šè¿‡åå°„è·å–ç±»å</span><br>        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="hljs-string">&quot;StartService &quot;</span> + name);<br><br>        <span class="hljs-keyword">final</span> T service;<br>        Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);  <span class="hljs-comment">// è·å–æ„é€ å™¨</span><br>        service = constructor.newInstance(mContext);  <span class="hljs-comment">// åˆ›å»ºå®ä¾‹</span><br>        startService(service);   <span class="hljs-comment">// ä¼ å…¥æ³›å‹SystemService</span><br>        <span class="hljs-keyword">return</span> service;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡è°ƒç”¨é‡è½½çš„startService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startService</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> SystemService service)</span> &#123;<br>    mServices.add(service); <span class="hljs-comment">// mServiceså­˜æ”¾äº†æ‰€æœ‰çš„æœåŠ¡ï¼Œç”¨äºç”¨æˆ·å¯åŠ¨æ—¶çš„onUseræ–¹æ³•å»é€šçŸ¥å„æœåŠ¡æ‰§è¡Œç›¸åº”çš„å¤šç”¨æˆ·æ“ä½œ</span><br>    service.onStart();  <span class="hljs-comment">// è°ƒç”¨æœåŠ¡çš„onStartæ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ç»§ç»­åˆ†æå…·ä½“serviceçš„onStartæ–¹æ³•</p><h4 id="2-1-1-StorageManagerService-Lifecycleå¯åŠ¨"><a href="#2-1-1-StorageManagerService-Lifecycleå¯åŠ¨" class="headerlink" title="2.1.1 StorageManagerService$Lifecycleå¯åŠ¨"></a>2.1.1 StorageManagerService$Lifecycleå¯åŠ¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lifecycle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span> &#123;<br>    <span class="hljs-keyword">private</span> StorageManagerService mStorageManagerService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Lifecycle</span><span class="hljs-params">(Context context)</span> &#123;<br>        <span class="hljs-built_in">super</span>(context);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> &#123;<br>        mStorageManagerService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageManagerService</span>(getContext());<br>        publishBinderService(<span class="hljs-string">&quot;mount&quot;</span>, mStorageManagerService);<br>        mStorageManagerService.start();  <span class="hljs-comment">// è°ƒç”¨StorageManagerServiceçš„startæ–¹æ³•</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li><strong>åˆ›å»ºStorageManagerServiceå®ä¾‹</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">StorageManagerService</span><span class="hljs-params">(Context context)</span> &#123;<br>    sSelf = <span class="hljs-built_in">this</span>;<br>    mVoldAppDataIsolationEnabled = SystemProperties.getBoolean(<br>        ANDROID_VOLD_APP_DATA_ISOLATION_ENABLED_PROPERTY, <span class="hljs-literal">false</span>);<br>    mContext = context;<br>    mResolver = mContext.getContentResolver();<br>    mCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callbacks</span>(FgThread.get().getLooper());<br>    mLockPatternUtils = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LockPatternUtils</span>(mContext);<br><br>    <span class="hljs-type">HandlerThread</span> <span class="hljs-variable">hthread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(TAG);<br>    hthread.start();<br>    mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageManagerServiceHandler</span>(hthread.getLooper());<br><br>    <span class="hljs-comment">// Add OBB Action Handler to StorageManagerService thread.</span><br>    mObbActionHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObbActionHandler</span>(IoThread.get().getLooper());<br><br>    mStorageSessionController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageSessionController</span>(mContext);<br><br>    mInstaller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Installer</span>(mContext);<br>    mInstaller.onStart();<br><br>    <span class="hljs-comment">// Initialize the last-fstrim tracking if necessary</span><br>    <span class="hljs-type">File</span> <span class="hljs-variable">dataDir</span> <span class="hljs-operator">=</span> Environment.getDataDirectory();<br>    <span class="hljs-type">File</span> <span class="hljs-variable">systemDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(dataDir, <span class="hljs-string">&quot;system&quot;</span>);<br>    mLastMaintenanceFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(systemDir, LAST_FSTRIM_FILE);<br>    <span class="hljs-keyword">if</span> (!mLastMaintenanceFile.exists()) &#123;<br>        <span class="hljs-comment">// Not setting mLastMaintenance here means that we will force an</span><br>        <span class="hljs-comment">// fstrim during reboot following the OTA that installs this code.</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            (<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(mLastMaintenanceFile)).close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            Slog.e(TAG, <span class="hljs-string">&quot;Unable to create fstrim record &quot;</span> + mLastMaintenanceFile.getPath());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mLastMaintenance = mLastMaintenanceFile.lastModified();<br>    &#125;<br><br>    mSettingsFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicFile</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(Environment.getDataSystemDirectory(), <span class="hljs-string">&quot;storage.xml&quot;</span>), <span class="hljs-string">&quot;storage-settings&quot;</span>);<br><br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        readSettingsLocked();<br>    &#125;<br><br>    LocalServices.addService(StorageManagerInternal.class, mStorageManagerInternal);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">userFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>();<br>    userFilter.addAction(Intent.ACTION_USER_ADDED);<br>    userFilter.addAction(Intent.ACTION_USER_REMOVED);<br>    mContext.registerReceiver(mUserReceiver, userFilter, <span class="hljs-literal">null</span>, mHandler);<br><br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        addInternalVolumeLocked();<br>    &#125;<br><br>    <span class="hljs-comment">// Add ourself to the Watchdog monitors if enabled.</span><br>    <span class="hljs-keyword">if</span> (WATCHDOG_ENABLE) &#123;<br>        Watchdog.getInstance().addMonitor(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    mIsAutomotive = context.getPackageManager().hasSystemFeature(<br>        PackageManager.FEATURE_AUTOMOTIVE);<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><ol start="2"><li><strong>StorageManagerServiceçš„startæ–¹æ³•å¦‚ä¸‹</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>    connectStoraged();<br>    connectVold();<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨SMSä¸­ä¼šæ‹¿åˆ°storagedå’ŒvoldæœåŠ¡ï¼š</p><ul><li><strong>è·å–storagedæœåŠ¡</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectStoraged</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> ServiceManager.getService(<span class="hljs-string">&quot;storaged&quot;</span>);<br>    mStoraged = IStoraged.Stub.asInterface(binder);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>è·å–voldæœåŠ¡</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectVold</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> ServiceManager.getService(<span class="hljs-string">&quot;vold&quot;</span>);<br>    mVold = IVold.Stub.asInterface(binder);<br>    mVold.setListener(mListener);  <span class="hljs-comment">// ç›‘å¬voldçš„äº‹ä»¶</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-1-2-StorageStatsService-Lifecycleå¯åŠ¨"><a href="#2-1-2-StorageStatsService-Lifecycleå¯åŠ¨" class="headerlink" title="2.1.2 StorageStatsService$Lifecycleå¯åŠ¨"></a>2.1.2 StorageStatsService$Lifecycleå¯åŠ¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lifecycle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span> &#123;<br>    <span class="hljs-keyword">private</span> StorageStatsService mService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> &#123;<br>        mService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageStatsService</span>(getContext());<br>        publishBinderService(Context.STORAGE_STATS_SERVICE, mService);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºStorageStatsServiceæœåŠ¡å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">StorageStatsService</span><span class="hljs-params">(Context context)</span> &#123;<br>    mContext = Preconditions.checkNotNull(context);<br>    mAppOps = Preconditions.checkNotNull(context.getSystemService(AppOpsManager.class));<br>    mUser = Preconditions.checkNotNull(context.getSystemService(UserManager.class));<br>    mPackage = Preconditions.checkNotNull(context.getPackageManager());<br>    mStorage = Preconditions.checkNotNull(context.getSystemService(StorageManager.class));<br>    mCacheQuotas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;();<br><br>    mInstaller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Installer</span>(context);<br>    mInstaller.onStart();<br>    invalidateMounts();<br><br>    mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">H</span>(IoThread.get().getLooper());<br>    mHandler.sendEmptyMessage(H.MSG_LOAD_CACHED_QUOTAS_FROM_FILE);<br><br>    mStorage.registerListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageEventListener</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVolumeStateChanged</span><span class="hljs-params">(VolumeInfo vol, <span class="hljs-type">int</span> oldState, <span class="hljs-type">int</span> newState)</span> &#123;<br>            <span class="hljs-keyword">switch</span> (vol.type) &#123;<br>                <span class="hljs-keyword">case</span> VolumeInfo.TYPE_PUBLIC:<br>                <span class="hljs-keyword">case</span> VolumeInfo.TYPE_PRIVATE:<br>                <span class="hljs-keyword">case</span> VolumeInfo.TYPE_EMULATED:<br>                    <span class="hljs-keyword">if</span> (newState == VolumeInfo.STATE_MOUNTED) &#123;<br>                        invalidateMounts();<br>                    &#125;<br>            &#125;<br>        &#125;<br>    &#125;);<br><br>    LocalManagerRegistry.addManager(StorageStatsManagerLocal.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalService</span>());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-voldå¯åŠ¨"><a href="#2-2-voldå¯åŠ¨" class="headerlink" title="2.2 voldå¯åŠ¨"></a>2.2 voldå¯åŠ¨</h3><h3 id="2-3-storagedå¯åŠ¨"><a href="#2-3-storagedå¯åŠ¨" class="headerlink" title="2.3 storagedå¯åŠ¨"></a>2.3 storagedå¯åŠ¨</h3><p>å®‰å“å®˜ç½‘å¯¹äºstoragedçš„æè¿°ï¼š<a href="https://source.android.com/docs/core/tests/debug/storaged?hl=zh-cn">https://source.android.com/docs/core/tests/debug/storaged?hl=zh-cn</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è§£å†³wandering treeé—®é¢˜</title>
    <link href="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/"/>
    <url>/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è§£å†³wandering-treeé—®é¢˜"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è§£å†³wandering-treeé—®é¢˜" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è§£å†³wandering treeé—®é¢˜"></a>f2fsæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•è§£å†³wandering treeé—®é¢˜</h1><h2 id="nand-flashå¼‚åœ°æ›´æ–°ç‰¹æ€§"><a href="#nand-flashå¼‚åœ°æ›´æ–°ç‰¹æ€§" class="headerlink" title="nand flashå¼‚åœ°æ›´æ–°ç‰¹æ€§"></a>nand flashå¼‚åœ°æ›´æ–°ç‰¹æ€§</h2><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/ulmpx3903i.png" alt="NAND Flashå¸ƒå±€ç¤ºæ„å›¾" style="zoom:75%;"><ul><li>è¯»å†™çš„æ“ä½œå¯¹è±¡æ˜¯page</li><li>æ“¦é™¤çš„å¯¹è±¡æ˜¯block</li><li>æ¯ä¸ªblockåœ¨å†™å…¥å‰éœ€è¦å…ˆæ“¦é™¤ï¼ˆErase-Before-Writeï¼‰</li></ul><p>Flashè¿˜æœ‰ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼š<strong>Flashä¸æ”¯æŒæ›´æ–°æ“ä½œ</strong>ï¼Œä¸¥æ ¼è¯´åº”è¯¥æ˜¯ä¸æ”¯æŒåŸå€æ›´æ–°ã€‚ å¦‚æœæˆ‘ä»¬å·²ç»å¾€æŸä¸ªpageä¸­å†™å…¥äº†æ•°æ®ï¼Œæƒ³ä¿®æ”¹è¿™ä¸ªpageä¸­çš„å†…å®¹ï¼Œåªèƒ½é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ï¼š</p><ol><li>å…ˆæŠŠæœ¬pageæ‰€å±blockçš„æ•°æ®å…¨éƒ¨è¯»å‡ºæ¥ï¼Œæ¯”å¦‚å…ˆè¯»åˆ°å†…å­˜DRAM</li><li>ç„¶åä¿®æ”¹å¯¹åº”pageçš„å†…å®¹</li><li>æ¥ä¸‹æ¥æ“¦é™¤æ•´ä¸ªblock</li><li>æœ€åæŠŠä¿®æ”¹åçš„blockæ•°æ®å›å†™åˆ°Flash</li></ol><p>è¿™æ ·çš„<strong>æœ¬åœ°æ›´æ–°</strong>çš„æ“ä½œå…¶å®ä¼šæœ‰2ä¸ªé—®é¢˜ï¼š</p><ul><li>å¯¹äºFlashä¼šåŠ å‰§ç£¨æŸï¼Œå½±å“å¯¿å‘½</li><li>è¯»å‡ºä¸€ä¸ªæ•´å—çš„æ“¦é™¤å—ï¼Œæ“¦é™¤å®ƒï¼Œå†å›å†™æ›´æ–°çš„æ•°æ®ï¼Œæ‰€èŠ±æ—¶é—´æ¯”å•ç‹¬åœ¨å…¶å®ƒå·²ç»æ“¦é™¤äº†çš„æ“¦é™¤å—æ›´æ–°æ•°æ®é•¿100å€ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºä¸€ä¸ªå°çš„æ›´æ–°ï¼Œåœ¨æœ¬åœ°æ›´æ–°æ¯”å¼‚åœ°æ›´æ–°æ›´æ–°æ—¶é—´é•¿100å€ã€‚</li></ul><hr><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/image-20230822214001394.png" alt="image-20230822214001394" style="zoom:67%;"><p>å½“æˆ‘ä»¬éœ€è¦æ›´æ–°ä¸€ä¸ªé¡µçš„æ—¶å€™ï¼Œåœ¨ä¸€ä¸ªæ–°çš„å—ä¸Šæ‰¾åˆ°ç©ºé—²é¡µï¼Œç„¶åå†™å…¥ï¼ŒåŸæ¥çš„é¡µæ ‡å¿—ä¸ºæ— æ•ˆé¡µï¼Œç­‰å¾…åƒåœ¾å›æ”¶å°†å…¶å›æ”¶ã€‚è¿™ç§é¡µæ›´æ–°ä¸åœ¨æœ¬åœ°å—ï¼Œè€Œåœ¨å¼‚åœ°å—çš„ç‰¹æ€§ï¼Œç§°ä¸º<strong>å¼‚åœ°æ›´æ–°</strong>ç‰¹æ€§ã€‚</p><p><strong>è¿™è¾¹ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹äºä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“å¼‚åœ°æ›´æ–°åå—çš„åœ°å€æ˜¯å“ªé‡Œï¼Ÿ</strong></p><p>è¿™ä¹Ÿå°±éœ€è¦è®°å½•é€»è¾‘é¡µå’Œç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œè¿™éƒ¨åˆ†ç”±Flash Trabslation Layer (FTL)å®Œæˆã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿè®¿é—®çš„éƒ½æ˜¯å—çš„é€»è¾‘åœ°å€ï¼Œæˆ‘ä»¬åœ¨SSDä¸­ç»´æŠ¤ä¸€å¼ FTLè¡¨ï¼Œå¼‚åœ°æ›´æ–°ä¹‹ååªéœ€è¦æ›´æ–°FTLä¸­ï¼Œé€»è¾‘åœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€å³å¯ã€‚</p><p>ä¾‹å¦‚ï¼šå½“å‰æœ‰ä¸€å¼ FTLè¡¨ï¼Œé‡Œé¢å¯¹åº”äº†å—çš„æ˜ å°„å…³ç³»ï¼Œé€»è¾‘åœ°å€ä¸º147çš„å—ï¼ŒçœŸå®ç‰©ç†å—åœ°å€ä¸º0x19087</p><table><thead><tr><th>é€»è¾‘åœ°å€</th><th>ç‰©ç†åœ°å€</th></tr></thead><tbody><tr><td>6</td><td>0x42712</td></tr><tr><td>147</td><td>0x19087</td></tr><tr><td>51</td><td>0x22893</td></tr></tbody></table><p>æ­¤æ—¶æˆ‘ä»¬å¼‚åœ°æ›´æ–°äº†0x19087ï¼Œæ”¹æˆäº†0x51209ã€‚å¯¹äºä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶è®¿é—®çš„ä¾ç„¶æ˜¯é€»è¾‘åœ°å€ï¼Œå› æ­¤å®ƒæ˜¯ä¸æ„ŸçŸ¥çš„ã€‚</p><p>å› æ­¤<strong>å½“å‰Nand Flashå¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿä¸»è¦æœ‰3ç§å½¢å¼</strong>ï¼š<a href="https://www.jsjkx.com/CN/article/openArticlePDF.jsp?id=738">ã€Šä¸€ç§åŸºäºçƒ­æ•°æ®è¯†åˆ«æŠ€æœ¯çš„UBIFSä¼˜åŒ–æ–¹æ¡ˆã€‹</a></p><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/image-20230822214933086.png" alt="image-20230822214933086" style="zoom: 67%;"><ol><li>ä½¿ç”¨<strong>ä¼ ç»Ÿç£ç›˜æ–‡ä»¶ç³»ç»Ÿ+è®¾å¤‡ç«¯FTL</strong>ç®¡ç†Nand Flashä¸­çš„æ–‡ä»¶ï¼Œå°†Nand Flashè®¾å¤‡å½“åšç£ç›˜ä½¿ç”¨ã€‚å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæœ‰ï¼šext3&#x2F;ext4æ–‡ä»¶ç³»ç»Ÿ</li><li>åŒæ ·<strong>ä¾é è®¾å¤‡ç«¯FTL</strong>æ¥ç®¡ç†Nand Flashï¼Œä½†æ˜¯è¿™ç§æ–‡ä»¶ç³»ç»Ÿ<strong>ä¸“é—¨é’ˆå¯¹é—ªå­˜ç‰¹æ€§è®¾è®¡</strong>ã€‚å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæœ‰ï¼šf2fsæ–‡ä»¶ç³»ç»Ÿ&#x2F;ReconFSæ–‡ä»¶ç³»ç»Ÿ</li><li>å¯ä»¥<strong>ç›´æ¥æ“ä½œNand Flashè®¾å¤‡çš„ç‰©ç†åœ°å€å†…å®¹</strong>ï¼Œä¸éœ€è¦è®¾å¤‡ç«¯FTLæ”¯æŒã€‚å¸¸è§çš„æœ‰ï¼šUBIFSã€JFFS2å’ŒYAFFS2æ–‡ä»¶ç³»ç»Ÿ</li></ol><h2 id="f2fsè§£å†³wandering-treeé—®é¢˜"><a href="#f2fsè§£å†³wandering-treeé—®é¢˜" class="headerlink" title="f2fsè§£å†³wandering treeé—®é¢˜"></a>f2fsè§£å†³wandering treeé—®é¢˜</h2><h3 id="ä»€ä¹ˆæ˜¯wandering-treeé—®é¢˜"><a href="#ä»€ä¹ˆæ˜¯wandering-treeé—®é¢˜" class="headerlink" title="ä»€ä¹ˆæ˜¯wandering  treeé—®é¢˜"></a>ä»€ä¹ˆæ˜¯wandering  treeé—®é¢˜</h3><p>æˆ‘ä»¬æ¥çœ‹è®ºæ–‡ï¼š<a href="https://www.researchgate.net/publication/289490302_Avoidance_techniques_for_Snowball_effect_of_Wandering_Tree_in_Flash_Memory_based_File_Systems">ã€ŠAvoidance techniques for Snowball effect of  Wandering Tree in Flash Memory based File Systemsã€‹</a></p><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/image-20230822221751530.png" alt="image-20230822221751530" style="zoom:67%;"><p>ä¸€ä¸ªå¤§æ–‡ä»¶å¸¸å¸¸æ—¶ä¸€ä¸ªinodeè¡¨ç¤ºä¸äº†çš„ï¼Œå¸¸å¸¸éœ€è¦å¤šçº§nodeè¡¨ç¤ºï¼Œä¾‹å¦‚è¿™é‡Œçš„inodeï¼Œæœ‰indirect blockå’Œdouble indirect blockã€‚å‡è®¾æˆ‘ä»¬è¦æ›´æ–°Pointer128æŒ‡å‘çš„æ•°æ®å—393:</p><ul><li>é¦–å…ˆè¦æ›´æ–°Indirect Blockä¸­Pointer 128æŒ‡å‘çš„å€¼ï¼Œå› ä¸ºå¼‚åœ°æ›´æ–°çš„ç¼˜æ•…ï¼Œ393æ•°æ®å—å¯¹åº”çš„é¡µä¼šæ‰¾åˆ°ä¸€ä¸ªæ–°çš„æ•°æ®å—æ‰¾åˆ°ç©ºé—²é¡µå†™å…¥</li><li>æ›´æ–°Double Indirect Blockä¸­Pointer 2æŒ‡å‘çš„å€¼ï¼Œå› ä¸ºå¼‚åœ°æ›´æ–°çš„ç¼˜æ•…ï¼ŒIndirect Blockä¸­Pointer 128å­˜æ”¾çš„æ•°æ®å—åœ°å€å€¼ä¿®æ”¹äº†ï¼Œè¿™ä¸ªå—è¦å¼‚åœ°æ›´æ–°</li><li>â€¦.</li><li>ä¾æ¬¡ç±»æ¨ï¼Œä¸€ç›´è¦æ›´æ–°åˆ°Inodeè¿™ä¸ªå—çš„å€¼ï¼Œå› ä¸ºPointer 12çš„æŒ‡å‘éœ€è¦ä¿®æ”¹</li></ul><p>è¿™æ ·å°±å¯¼è‡´äº†<strong>æ»šé›ªçƒæ•ˆåº”</strong>ï¼ˆæœ‰äº›æ–‡ç« ä¹Ÿå«åš<strong>é›ªå´©æ•ˆåº”</strong>ï¼‰ï¼Œä¹Ÿå°±æ˜¯Wandering Treeé—®é¢˜ã€‚å½“ä¸€ä¸ªæ•°æ®å—æ›´æ–°æ—¶ï¼Œç”±äºNand Flashå¼‚åœ°æ›´æ–°ç‰¹æ€§ï¼Œä¼šå±‚å±‚é€’å½’æ›´æ–°åˆ°æ›´èŠ‚ç‚¹ï¼Œåƒé›ªå´©ä¸€æ ·ï¼Œç‰µä¸€å‘åŠ¨å…¨èº«ã€‚</p><h3 id="å¦‚ä½•è§£å†³wandering-tree"><a href="#å¦‚ä½•è§£å†³wandering-tree" class="headerlink" title="å¦‚ä½•è§£å†³wandering tree"></a>å¦‚ä½•è§£å†³wandering tree</h3><p>ã€Šæ“ä½œç³»ç»Ÿå¯¼è®ºã€‹çš„ä½œè€…æˆç§°åœ¨æ¶æ„è®¾è®¡é‡Œé¢æ²¡æœ‰ä»€ä¹ˆæ˜¯åŠ ä¸€å±‚ä¸­é—´å±‚è§£å†³ä¸äº†çš„ï¼Œå“ˆå“ˆå“ˆå“ˆğŸ˜¯</p><p>åœ¨f2fsæ–‡ä»¶ç³»ç»Ÿä¸­å…¶å®ä¹Ÿæ˜¯å¼•ç”¨äº†ä¸­é—´å±‚æ€æƒ³ï¼Œä¸FTLæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚æ…¢æ…¢ä½“ä¼šã€‚F2FSåœ¨å…ƒæ•°æ®åŒºåŸŸå¼•å…¥äº†NAT(node address table)åŒºåŸŸï¼Œå…¶æŒ‡æ˜äº†nidä¸çœŸå®block addressçš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹dump_natã€å‘½ä»¤d<strong>ump.f2fs -n 0~-1 xxx</strong> ã€‘æ¥çœ‹ä¸€ä¸‹ï¼š</p><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/image-20230719235441702.png" alt="image-20230719235441702" style="zoom:67%;"><p>nidä¸º4çš„node blockï¼ˆä¹Ÿå°±æ˜¯ç¬¬4ä¸ªè¢«ä½¿ç”¨çš„node blockï¼‰å…¶å¯¹åº”çš„ç‰©ç†å—åœ°å€blkaddrä¸º4612ã€‚</p><p>è¿™æ ·å¯¹äºä¸Šé¢å¦‚æœåœ¨indirect node blockå’Œdouble indirect node blockéƒ½æ˜¯å­˜æ”¾çš„æ˜¯ä¸‹ä¸€çº§node blockçš„é€»è¾‘åœ°å€ï¼ˆä¹Ÿå°±æ˜¯nidå€¼ï¼‰ï¼Œè¿™æ ·å¦‚æœæˆ‘ä»¬æ›´æ–°äº†393æ•°æ®å—ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦å±‚å±‚é€’å½’çš„å»ä¸ªæ›´æ–°äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´ç»†æœ€åä¸€çº§ç›´æ¥æŒ‡å‘æ•°æ®å—çš„é‚£ä¸ªnode blockï¼Œè¿›è¡Œå¼‚åœ°æ›´æ–°ï¼Œæ­¤æ—¶å†å»NATä¸­æ‰¾åˆ°å¯¹åº”çš„nidæ›´æ–°å®ƒå¯¹åº”çš„bldaddrå³å¯ï¼Œä¸­é—´å±‚å±‚çš„é€»è¾‘æ˜ å°„å…³ç³»ä¿æŒä¸å˜ã€‚</p><img src="/2023/08/22/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3wandering-tree%E9%97%AE%E9%A2%98/image-20230822224132981.png" alt="image-20230822224132981" style="zoom: 67%;"><h3 id="æœ‰äº†FTLï¼Œä¸ºä»€ä¹ˆè¿˜è¦NAT"><a href="#æœ‰äº†FTLï¼Œä¸ºä»€ä¹ˆè¿˜è¦NAT" class="headerlink" title="æœ‰äº†FTLï¼Œä¸ºä»€ä¹ˆè¿˜è¦NAT"></a>æœ‰äº†FTLï¼Œä¸ºä»€ä¹ˆè¿˜è¦NAT</h3><p>ä¸‹é¢éƒ½æ˜¯æˆ‘æœ¬äººçš„ç†è§£ï¼šåœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢é’ˆå¯¹Nand Flashè¿›è¡Œè®¾è®¡ï¼Œæå‰è§„é¿Wandering Treeé—®é¢˜ï¼Œè¿™æ ·å¯¹äºFTLæ¥è¯´å‹åŠ›å°±è¯´å‡å°å¾ˆå¤šï¼Œå› ä¸ºFTLè¿˜è¦è´Ÿè´£åƒåœ¾å›æ”¶ï¼Œç£¨æŸå‡è¡¡ç­‰ç­‰ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿç›®å½•æ ‘ç»“æ„</title>
    <link href="/2023/08/21/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E6%A0%91%E7%BB%93%E6%9E%84/"/>
    <url>/2023/08/21/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E6%A0%91%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿnode blockç›¸å…³æ¦‚å¿µ</title>
    <link href="/2023/08/21/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fnode-block%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
    <url>/2023/08/21/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fnode-block%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿnode-blockç›¸å…³æ¦‚å¿µ"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿnode-blockç›¸å…³æ¦‚å¿µ" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿnode blockç›¸å…³æ¦‚å¿µ"></a>f2fsæ–‡ä»¶ç³»ç»Ÿnode blockç›¸å…³æ¦‚å¿µ</h1><h2 id="1-inodeã€dnodeã€indnodeåŒºåˆ«"><a href="#1-inodeã€dnodeã€indnodeåŒºåˆ«" class="headerlink" title="1.inodeã€dnodeã€indnodeåŒºåˆ«"></a>1.inodeã€dnodeã€indnodeåŒºåˆ«</h2><p>æˆ‘ä»¬çŸ¥é“node blockçš„æ•°æ®ç»“æ„å½¢å¼ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_node</span> &#123;</span><br><span class="hljs-comment">/* can be one of three types: inode, direct, and indirect types */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_inode</span> <span class="hljs-title">i</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">direct_node</span> <span class="hljs-title">dn</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">indirect_node</span> <span class="hljs-title">in</span>;</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_footer</span> <span class="hljs-title">footer</span>;</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_footer</span> &#123;</span><br>__le32 nid;<span class="hljs-comment">/* node id */</span><br>__le32 ino;<span class="hljs-comment">/* inode number */</span><br>__le32 flag;<span class="hljs-comment">/* include cold/fsync/dentry marks and offset */</span><br>__le64 cp_ver;<span class="hljs-comment">/* checkpoint version */</span><br>__le32 next_blkaddr;<span class="hljs-comment">/* next node page block address */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>åœ¨f2fsæ–‡ä»¶ç³»ç»Ÿä¸­node blockå¯ä»¥åˆ†ä¸º<code>f2fs_inodeã€direct_nodeå’Œindirect_node</code></p><h3 id="1-1-inode"><a href="#1-1-inode" class="headerlink" title="1.1 inode"></a>1.1 inode</h3><p>f2fs_inodeå³ä¸ºå¾ˆå¤šæ–‡ç« é‡Œé¢å¸¸è¯´çš„inodeï¼Œä¹Ÿæ˜¯f2fså†…æ ¸ä»£ç é‡Œé¢å¾ˆå¤šåœ°æ–¹çš„åˆ¤æ–­å½¢å¼æ‰€ä»£è¡¨çš„æ•°æ®ç»“æ„ï¼š</p><img src="/2023/08/21/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fnode-block%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/image-20230821225135550.png" alt="image-20230821225135550" style="zoom: 67%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">IS_INODE</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_node</span> *<span class="hljs-title">p</span> =</span> F2FS_NODE(page);  <span class="hljs-comment">// å°†node pageè½¬æ¢æˆf2fs_nodeç»“æ„</span><br><span class="hljs-keyword">return</span> RAW_IS_INODE(p);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RAW_IS_INODE(p)((p)-&gt;footer.nid == (p)-&gt;footer.ino)</span><br></code></pre></td></tr></table></figure><p><strong>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“f2fs_nodeå°¾éƒ¨æœ‰ä¸€ä¸ªnode_footerç»“æ„ï¼Œå½“node_footerä¸­nidå’Œinoç›¸å½“ï¼Œåˆ™è®¤ä¸ºå½“å‰ç»“æ„ä¸ºinodeç»“æ„</strong></p><h3 id="1-2-dnode"><a href="#1-2-dnode" class="headerlink" title="1.2 dnode"></a>1.2 dnode</h3><p><strong>direct_node</strong>å³ä¸ºå¾ˆå¤šæ–‡ç« ä¸­æ‰€è¯´çš„<strong>dnode block</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">direct_node</span> &#123;</span><br>__le32 addr[DEF_ADDRS_PER_BLOCK];<span class="hljs-comment">/* array of data block address */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><h3 id="1-3-indnode"><a href="#1-3-indnode" class="headerlink" title="1.3 indnode"></a>1.3 indnode</h3><p>indirect_nodeå³ä¸ºå¾ˆå¤šæ–‡ç« ä¸­æ‰€è¯´çš„indnodeï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">indirect_node</span> &#123;</span><br>__le32 nid[NIDS_PER_BLOCK];<span class="hljs-comment">/* array of data block address */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><h2 id="2-node-pageç›¸å…³ç†è§£"><a href="#2-node-pageç›¸å…³ç†è§£" class="headerlink" title="2.node pageç›¸å…³ç†è§£"></a>2.node pageç›¸å…³ç†è§£</h2><h3 id="2-1-node-pageæ˜¯ä»€ä¹ˆ"><a href="#2-1-node-pageæ˜¯ä»€ä¹ˆ" class="headerlink" title="2.1 node pageæ˜¯ä»€ä¹ˆ"></a>2.1 node pageæ˜¯ä»€ä¹ˆ</h3><p>node blockå¯¹åº”çš„æ˜¯ç£ç›˜ä¸Šå¯¹åº”çš„ç»“æ„ï¼Œè€ŒçœŸå®å­˜åœ¨äºå†…å­˜ä¸­ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯ç¼“å­˜Page Cacheä¸­çš„åº”è¯¥æ˜¯é¡µã€‚</p><p><strong>f2fs_get_node_page</strong>å‡½æ•°ä¼šå°†4Kçš„node blockè½¬æ¢æˆ4Kçš„node pageã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">f2fs_get_node_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">pgoff_t</span> nid)</span><br>&#123;<br><span class="hljs-keyword">return</span> __get_node_page(sbi, nid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">get_node_page</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sb_info</span> *<span class="hljs-title">sbi</span>, <span class="hljs-title">pgoff_t</span> <span class="hljs-title">nid</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">parent</span>, <span class="hljs-title">int</span> <span class="hljs-title">start</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">// ä»ç¼“å­˜ä¸­è·å–</span><br>page = f2fs_grab_cache_page(NODE_MAPPING(sbi), nid, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-comment">// å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°</span><br>    <span class="hljs-comment">// åˆ™æ„é€ bioï¼Œç„¶åä»ç£ç›˜ä¸­è¯»å–inodeå¯¹åº”çš„blockï¼Œå°†blockæ•°æ®æ”¾åˆ°åˆšåˆšåˆ›å»ºçš„page</span><br>    err = read_node_page(page, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-node-pageå¯¹åº”çš„address-space"><a href="#2-2-node-pageå¯¹åº”çš„address-space" class="headerlink" title="2.2 node pageå¯¹åº”çš„address_space"></a>2.2 node pageå¯¹åº”çš„address_space</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> address_space *<span class="hljs-title function_">NODE_MAPPING</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span><br>&#123;<br><span class="hljs-keyword">return</span> sbi-&gt;node_inode-&gt;i_mapping;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ‰€æœ‰çš„node pageéƒ½æ˜¯æŒ‚åœ¨sbi-&gt;node_inodeä¸Šã€‚f2fs_sb_infoçš„node_inodeä¸Šé¢æ˜¯ï¼ˆæŒ‚è½½äº†f2fsæ–‡ä»¶ç³»ç»Ÿç›®å½•çš„ï¼‰æ–‡ä»¶å¯¹åº”çš„ç¼“å­˜Page Caheã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointæœºåˆ¶å­¦ä¹ è·¯çº¿</title>
    <link href="/2023/08/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"/>
    <url>/2023/08/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointæœºåˆ¶å­¦ä¹ è·¯çº¿"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointæœºåˆ¶å­¦ä¹ è·¯çº¿" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointæœºåˆ¶å­¦ä¹ è·¯çº¿"></a>f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointæœºåˆ¶å­¦ä¹ è·¯çº¿</h1><p><strong>1.å…ˆå­¦ä¹ Mysqlçš„checkpointæœºåˆ¶</strong></p><ul><li><p>âœ‰ï¸ä¹¦ç±ï¼š<strong>ã€ŠMysqlæŠ€æœ¯å†…å¹•ï¼šInnoDBå­˜å‚¨å¼•æ“ã€‹</strong></p></li><li><p><a href="https://xiaolincoding.com/mysql/log/"> MySQL æ—¥å¿—ï¼šundo logã€redo logã€binlog æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</a></p></li><li><p><a href="https://maimai.cn/article/detail?fid=1750463379&efid=7-na06qVPhj9rdjyPJdmng">æ¢å¤æ•°æ®é¡µ</a></p></li><li><p><a href="https://www.cnblogs.com/chenpingzhao/p/5107480.html">ã€mysqlã€‘å…³äºcheckpointæœºåˆ¶</a></p></li></ul><blockquote><p><strong>ä¸€å¥è¯æ¦‚æ‹¬</strong>ï¼šmysqlçš„checkpointåšçš„äº‹æƒ…ï¼šå°†ç¼“å­˜æ± ä¸­çš„è„æ•°æ®åˆ·å†™åˆ°ç£ç›˜ï¼Œæ›´æ–°redo logä¸­çš„checkpointä¿¡æ¯ã€‚</p></blockquote><img src="/2023/08/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/image-20230816233304276.png" alt="image-20230816233304276" style="zoom: 67%;"><img src="/2023/08/16/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/image-20230816233339173.png" alt="image-20230816233339173" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“SMSä¸Voldé€šä¿¡æœºåˆ¶</title>
    <link href="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“SMSä¸Voldé€šä¿¡æœºåˆ¶"><a href="#å®‰å“SMSä¸Voldé€šä¿¡æœºåˆ¶" class="headerlink" title="å®‰å“SMSä¸Voldé€šä¿¡æœºåˆ¶"></a>å®‰å“SMSä¸Voldé€šä¿¡æœºåˆ¶</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/geshifei/article/details/130005917?spm=1001.2014.3001.5506">https://blog.csdn.net/geshifei/article/details/130005917?spm=1001.2014.3001.5506</a></p></blockquote><h2 id="1-é—®é¢˜"><a href="#1-é—®é¢˜" class="headerlink" title="1.é—®é¢˜"></a>1.é—®é¢˜</h2><p><strong>åœ¨å®‰å“æºç é‡Œé¢ï¼ŒStorageManagerServiceæœ‰å¾ˆå¤šåœ°æ–¹è°ƒç”¨äº†voldçš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯Frameworks(SMS)è°ƒç”¨äº†è®¸å¤šNative(vold)çš„æ–¹æ³•ã€‚</strong></p><blockquote><p>ä»¥ä¸‹ä¾¿æ˜¯SMSè°ƒç”¨Voldçš„mountæ–¹æ³•</p></blockquote><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813211308190.png" alt="image-20230813211308190" style="zoom:50%;"><h2 id="2-SMSä¸Voldé€šä¿¡"><a href="#2-SMSä¸Voldé€šä¿¡" class="headerlink" title="2.SMSä¸Voldé€šä¿¡"></a>2.SMSä¸Voldé€šä¿¡</h2><p>åœ¨æ¶æ„å±‚é¢ï¼Œæˆ‘ä»¬é€‰æ‹©ä»ä¸Šå¾€ä¸‹çœ‹~</p><h3 id="2-1-SMSçš„mVoldå˜é‡"><a href="#2-1-SMSçš„mVoldå˜é‡" class="headerlink" title="2.1 SMSçš„mVoldå˜é‡"></a>2.1 SMSçš„mVoldå˜é‡</h3><p>æ—¢ç„¶åœ¨SMSä¸­éƒ½æ˜¯é€šè¿‡mVoldå˜é‡è¿æ¥äº†Voldå’ŒSMSï¼Œçœ‹ä¸€ä¸‹ä»–çš„åˆå§‹åŒ–è¿‡ç¨‹</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813211650941.png" alt="image-20230813211650941" style="zoom: 50%;"><p>1968è¡Œè·å–vold serviceçš„IBinderå¯¹è±¡ã€‚ä¸€ä¸ªServiceåœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªIBinderå¯¹è±¡ï¼Œå…¶ä»–è¿›ç¨‹å¯ä»¥é€šè¿‡è¿™ä¸ªIBinderå¯¹è±¡ä¸Serviceé€šä¿¡ã€‚å› æ­¤ï¼ŒgetService()æ–¹æ³•è¿”å›çš„æ˜¯æœåŠ¡çš„IBinderå¯¹è±¡ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å®ƒä¸æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚å…·ä½“æ¥è¯´ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨æœåŠ¡çš„IBinderå¯¹è±¡æ¥è°ƒç”¨æœåŠ¡æä¾›çš„æ¥å£æ–¹æ³•ã€‚</p><p>1985è¡Œæ ¹æ®IBinderæ‰¾åˆ°aidlå®šä¹‰çš„mVoldï¼ˆæ˜¯ä¸€ä¸ªinterfaceï¼‰ï¼Œæ‰¾åˆ°mVoldåï¼Œå°±å¯ä»¥è°ƒç”¨ä»–å®ç°çš„æ–¹æ³•äº†ï¼Œæ¯”å¦‚mVold.mountã€‚æ€»ç»“å°±æ˜¯ï¼Œæ‰¾åˆ°äº†vold serviceå°±èƒ½æ‰¾åˆ°å…·ä½“çš„å‡½æ•°å®ç°äº†ï¼Œæ‰€ä»¥ç°åœ¨çš„é—®é¢˜æ˜¯vold serviceåœ¨å“ªã€æ˜¯ä»€ä¹ˆï¼Ÿ</p><hr><p>å¯ä»¥å‘ç°ï¼Œåœ¨SMSå¯åŠ¨çš„æ—¶å€™å°±è°ƒç”¨äº†connectVoldæ–¹æ³•</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813211806529.png" alt="image-20230813211806529" style="zoom:50%;"><h3 id="2-2-voldçš„aidlæ¥å£å®šä¹‰"><a href="#2-2-voldçš„aidlæ¥å£å®šä¹‰" class="headerlink" title="2.2 voldçš„aidlæ¥å£å®šä¹‰"></a>2.2 voldçš„aidlæ¥å£å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// system\vold\binder\android\os\IVold.aidl</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IVold</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setListener</span><span class="hljs-params">(IVoldListener listener)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">abortFuse</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitor</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserAdded</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> userSerial)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserRemoved</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserStarted</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserStopped</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAppIds</span><span class="hljs-params">(in <span class="hljs-meta">@utf8InCpp</span> String[] packageNames, in <span class="hljs-type">int</span>[] appIds)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSandboxIds</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] appIds, in <span class="hljs-meta">@utf8InCpp</span> String[] sandboxIds)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSecureKeyguardStateChanged</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isShowing)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-meta">@utf8InCpp</span> String diskId, <span class="hljs-type">int</span> partitionType, <span class="hljs-type">int</span> ratio)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">forgetPartition</span><span class="hljs-params">(<span class="hljs-meta">@utf8InCpp</span> String partGuid, <span class="hljs-meta">@utf8InCpp</span> String fsUuid)</span>;<br> <span class="hljs-comment">// ...   </span><br>&#125;<br></code></pre></td></tr></table></figure><p> è¿™æ˜¯ä¸ªaidlæ–‡ä»¶ï¼ŒAndroid Interface Definition Language,å³Androidæ¥å£å®šä¹‰è¯­è¨€ï¼Œaidlæ–‡ä»¶ä¸­ä¼šå®šä¹‰å¾ˆå¤šå‡½æ•°ï¼Œç”¨äºå¤šè¿›ç¨‹é—´è¿œç¨‹è°ƒç”¨ã€‚</p><p>aidlæ–‡ä»¶ç¼–è¯‘åï¼Œç”Ÿæˆ.javaæ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆä¸€ä¸ªStubå†…éƒ¨ç±»ã€‚æˆ‘ä»¬å¯ä»¥åœ¨androidç¼–è¯‘çš„outç›®å½•æœç´¢IVold$Stub.javaï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥æœç´¢IVold$Stub.classï¼Œåç¼–è¯‘classåå¾—åˆ°IVold$Stub.javaï¼ŒIVold$Stub.javaæ–‡ä»¶éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼šã€æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥æ˜¯IVold.Stubï¼Œå¯èƒ½åç¼–è¯‘çš„æ—¶å€™é”™äº†ï¼Œåç¼–è¯‘æˆäº†IVold$Stubã€‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IVold$Stub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Binder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IVold</span> &#123;<br>    â€¦â€¦<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRANSACTION_mount</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mount</span><span class="hljs-params">(String var1, <span class="hljs-type">int</span> var2, <span class="hljs-type">int</span> var3, IVoldMountCallback var4)</span> <span class="hljs-keyword">throws</span> RemoteException;<br> <br>    â€¦â€¦<br> <br>   <span class="hljs-keyword">public</span> IVold$Stub() &#123;<br>      <span class="hljs-built_in">this</span>.attachInterface(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;android.os.IVold&quot;</span>);<br>   &#125;<br> <br>   <span class="hljs-comment">//è¿™é‡Œæ˜¯å…³é”®</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IVold <span class="hljs-title function_">asInterface</span><span class="hljs-params">(IBinder obj)</span> &#123;<br>      <span class="hljs-keyword">if</span>(obj == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-type">IInterface</span> <span class="hljs-variable">iin</span> <span class="hljs-operator">=</span> obj.queryLocalInterface(<span class="hljs-string">&quot;android.os.IVold&quot;</span>);<br>         <span class="hljs-keyword">return</span> (IVold)(iin != <span class="hljs-literal">null</span> &amp;&amp; iin <span class="hljs-keyword">instanceof</span> IVold?(IVold)iin:<span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj));<br>      &#125;<br>   &#125;<br> <br>   <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">asBinder</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>   &#125;<br>    â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>public abstract class IVold$Stub extends Binder implements IVold</code>å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡ç±»IVold$Stubï¼Œè¯¥æŠ½è±¡ç±»ç»§æ‰¿è‡ªBinderç±»ï¼ŒåŒæ—¶å®ç°äº†IVoldæ¥å£ã€‚å®ƒçš„å®šä¹‰ä¸­åŒ…å«äº†æŠ½è±¡æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°éœ€è¦åœ¨è¯¥ç±»çš„å­ç±»ä¸­å®Œæˆ</li><li>ä»IVold$Stubå¯çŸ¥ï¼ŒStubæ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ã€‚Stubç±»ä¼šæ ¹æ®AIDLæ–‡ä»¶ä¸­å®šä¹‰çš„æ¥å£è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶å®ç°è¯¥æ¥å£çš„æ–¹æ³•ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªé™æ€çš„asInterface()æ–¹æ³•å’Œä¸€ä¸ªé»˜è®¤çš„æ„é€ æ–¹æ³•ã€‚**åœ¨å®¢æˆ·ç«¯é€šè¿‡bindService()æ–¹æ³•ç»‘å®šæœåŠ¡æ—¶ï¼Œä¼šé€šè¿‡getService()æ–¹æ³•è·å–åˆ°ä¸€ä¸ªBinderå¯¹è±¡ï¼Œé€šè¿‡asInterface()æ–¹æ³•å°†å…¶è½¬æ¢ä¸ºæœåŠ¡ç«¯å®ç°çš„IMyService<u>æ¥å£</u>**ã€‚åœ¨æœåŠ¡ç«¯ï¼ŒBinderå¯¹è±¡ä¼šé€šè¿‡Stubç±»çš„onTransact()æ–¹æ³•æ¥å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ã€‚</li></ul><p>ä¸¾ä¾‹æ¥è¯´ï¼ŒAç»‘å®šäº†æœåŠ¡ç«¯Bçš„serviceï¼Œé‚£ä¹ˆAå¯ä»¥é€šè¿‡ä¸‹é¢æ–¹æ³•æ‰§è¡ŒBä¸­çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> IVold mVold;<br><span class="hljs-comment">//æ ¹æ®binderæ‰¾åˆ°å¯¹åº”çš„aidl interface</span><br>mVold = IVold.Stub.asInterface(Binder-x)<br><span class="hljs-comment">//æ‰§è¡ŒæœåŠ¡ç«¯æ–¹æ³•</span><br>mVold.mount()<br></code></pre></td></tr></table></figure><h3 id="2-3-vold-serviceæ˜¯ä»€ä¹ˆ"><a href="#2-3-vold-serviceæ˜¯ä»€ä¹ˆ" class="headerlink" title="2.3 vold serviceæ˜¯ä»€ä¹ˆ"></a>2.3 vold serviceæ˜¯ä»€ä¹ˆ</h3><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/1ddbc525e73c4e868f14f74b7ef1af4d.png" alt="img" style="zoom: 67%;"><p>å¯ä»¥çœ‹åˆ°VoldNativeService.hæ–‡ä»¶ä¸­å®šä¹‰äº†VoldNativeServiceç±»ã€‚è¿™ä¸ªç±»æœ‰å¾ˆå¤šå‡½æ•°å®šä¹‰ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹getServiceNameæ–¹æ³•ã€‚VoldNativeService.getServiceNameè¿”å›çš„å°±æ˜¯â€œvoldâ€ï¼Œæ‰€ä»¥VoldNativeServiceç±»ä¸­çš„å‡½æ•°å°±æ˜¯aidlæ¥å£ä¸­å„ä¸ªå‡½æ•°çš„å…·ä½“å®ç°ã€‚æ¯”å¦‚mVold.mountçš„å…·ä½“å®ç°å°±æ˜¯VoldNativeService::mountï¼ˆè§VoldNativeService.cppï¼‰ã€‚</p><h2 id="3-voldè¿›ç¨‹çš„å¯åŠ¨å’Œvold-serviceçš„æ³¨å†Œ"><a href="#3-voldè¿›ç¨‹çš„å¯åŠ¨å’Œvold-serviceçš„æ³¨å†Œ" class="headerlink" title="3.voldè¿›ç¨‹çš„å¯åŠ¨å’Œvold serviceçš„æ³¨å†Œ"></a>3.voldè¿›ç¨‹çš„å¯åŠ¨å’Œvold serviceçš„æ³¨å†Œ</h2><p>voldçš„æºå¤´åœ¨ &#x2F;etc&#x2F;init&#x2F;hw&#x2F;init.rcï¼Œç³»ç»Ÿå¼€æœºåä¼šæ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå¯åŠ¨voldè¿›ç¨‹ã€‚</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813212449709.png" alt="image-20230813212449709" style="zoom: 67%;"><p>å½“å¯åŠ¨voldæœåŠ¡çš„æ—¶å€™ï¼Œä¼šèµ°åˆ°&#x2F;system&#x2F;vold&#x2F;main.cppä¸­çš„mainå‡½æ•°ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-built_in">ATRACE_BEGIN</span>(<span class="hljs-string">&quot;VoldNativeService::start&quot;</span>);<br>    <span class="hljs-keyword">if</span> (android::vold::VoldNativeService::<span class="hljs-built_in">start</span>() != android::OK) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Unable to start VoldNativeService&quot;</span>;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">ATRACE_END</span>();<br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>VoldNativeService::start()å¯åŠ¨VoldNativeServiceï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°ServiceManagerä¸­ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">VoldNativeService::start</span><span class="hljs-params">()</span> </span>&#123;<br>    IPCThreadState::<span class="hljs-built_in">self</span>()-&gt;<span class="hljs-built_in">disableBackgroundScheduling</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">status_t</span> ret = BinderService&lt;VoldNativeService&gt;::<span class="hljs-built_in">publish</span>();<br>    <span class="hljs-keyword">if</span> (ret != android::OK) &#123;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-function">sp&lt;ProcessState&gt; <span class="hljs-title">ps</span><span class="hljs-params">(ProcessState::self())</span></span>;<br>    ps-&gt;<span class="hljs-built_in">startThreadPool</span>();<br>    ps-&gt;<span class="hljs-built_in">giveThreadPoolName</span>();<br>    <span class="hljs-keyword">return</span> android::OK;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>BinderService&lt;VoldNativeService&gt;::publish()</code>æ‰§è¡Œå…·ä½“çš„æ³¨å†Œæ“ä½œã€‚</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813212813803.png" alt="image-20230813212813803" style="zoom: 50%;"><p>æ ¹æ®33è¡Œtypename SERVICEåŠ VoldNativeService::start()ä¸­122è¡Œ<code>BinderService&lt;VoldNativeService&gt;::publish()</code>ï¼Œå¯ä»¥çŸ¥é“SERVICEå°±æ˜¯VoldNativeServiceï¼Œæ‰€ä»¥SERVICE::getServiceName()å°±æ˜¯VoldNativeService::getServiceName()ã€‚é€šè¿‡ç¬¬äºŒèŠ‚ç¬¬3æ®µã€vold serviceæ˜¯ä»€ä¹ˆã€‘å¯çŸ¥getServiceName()å°†è¿”å›å­—ç¬¦ä¸²â€œvoldâ€ã€‚æ€»ç»“å°±æ˜¯ï¼ŒVoldNativeServiceä»¥â€œvoldâ€åç§°æ³¨å†Œåˆ°ServiceManagerä¸­ï¼ŒVoldNativeServiceç±»ä¸­å®ç°äº†å¾ˆå¤šå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å°±æ˜¯è·¨è¿›ç¨‹è°ƒç”¨çš„å…·ä½“å‡½æ•°ï¼Œæ¯”å¦‚mVold.mountã€‚</p><h2 id="4-mVold-mountæ˜¯ä»€ä¹ˆ"><a href="#4-mVold-mountæ˜¯ä»€ä¹ˆ" class="headerlink" title="4.mVold.mountæ˜¯ä»€ä¹ˆ"></a>4.mVold.mountæ˜¯ä»€ä¹ˆ</h2><p>åœ¨SMSä¸­é€šè¿‡ServiceManager.getService(â€œvoldâ€)è·å–vold serviceå…³è”çš„binderï¼Œä¹Ÿå°±æ˜¯VoldNativeServiceäº†ã€‚å¹¶ä¸”é€šè¿‡mVold &#x3D; IVold.Stub.asInterface(binder)è·å–binderå¯¹è±¡å…³è”çš„aidlæ¥å£ï¼Œæ‰€ä»¥mVold.mountå°±æ˜¯VoldNativeServiceä¸­mountå‡½æ•°ã€‚</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813213258027.png" alt="image-20230813213258027" style="zoom: 50%;"><h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5.æ€»ç»“"></a>5.æ€»ç»“</h2><img src="/2023/08/13/%E5%AE%89%E5%8D%93SMS%E4%B8%8EVold%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6/image-20230813214444039.png" alt="image-20230813214444039" style="zoom:80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“aidlé€šä¿¡</title>
    <link href="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/"/>
    <url>/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“aidlé€šä¿¡"><a href="#å®‰å“aidlé€šä¿¡" class="headerlink" title="å®‰å“aidlé€šä¿¡"></a>å®‰å“aidlé€šä¿¡</h1><h2 id="1-AIDLç®€è¿°"><a href="#1-AIDLç®€è¿°" class="headerlink" title="1.AIDLç®€è¿°"></a>1.AIDLç®€è¿°</h2><p>AIDL:Android Interface Definition Language,å³Androidæ¥å£å®šä¹‰è¯­è¨€ï¼Œç”¨äºç”ŸæˆAndroidä¸åŒè¿›ç¨‹é—´è¿›è¡Œè¿›ç¨‹é€šä¿¡(IPC)çš„ä»£ç ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªè¿›ç¨‹æ˜¯æ— æ³•è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜çš„ã€‚å¦‚æœæŸäº›æƒ…å†µä¸‹ä»ç„¶éœ€è¦è·¨è¿›ç¨‹è®¿é—®å†…å­˜æ•°æ®ï¼Œè¿™æ—¶å€™Androidç³»ç»Ÿå°±è¦å°†å…¶å¯¹è±¡åˆ†è§£æˆèƒ½å¤Ÿè¯†åˆ«çš„åŸæ•°æ®ï¼Œç¼–å†™è¿™ä¸€ç»„æ“ä½œçš„ä»£ç æ˜¯ä¸€é¡¹ç¹ççš„å·¥ä½œï¼Œä½†æ˜¯AIDLå¯¹åº•å±‚è¿›è¡Œäº†æŠ½è±¡çš„å°è£…ï¼Œç®€åŒ–äº†è·¨è¿›ç¨‹æ“ä½œã€‚</p><p>AIDL IPCæœºåˆ¶æ˜¯é¢å‘æ¥å£çš„ï¼ŒåƒCOMæˆ–Corbaä¸€æ ·ï¼Œä½†æ˜¯æ›´åŠ è½»é‡çº§ã€‚å®ƒæ˜¯ä½¿ç”¨ä»£ç†ç±»åœ¨å®¢æˆ·ç«¯å’Œå®ç°ç«¯ä¼ é€’æ•°æ®ã€‚</p><p>åœ¨Androidä¸­è·¨è¿›ç¨‹æ“ä½œçš„æ–¹å¼ä¸æ­¢ä¸€ç§ï¼Œå››å¤§ç»„ä»¶ä¸­ContentProviderå¤©ç”Ÿå°±æ˜¯ä¸ºè·¨è¿›ç¨‹æ“ä½œè€Œå­˜åœ¨çš„ï¼Œä½†æ˜¯ContentProvideræ‰€è°“çš„è·¨è¿›ç¨‹æ“ä½œæ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸ä¸€å®šæ˜¯å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œå¦‚é€šè®¯å½•æ•°æ®æ—¶å­˜æ”¾åœ¨Sqliteæ•°æ®åº“ä¸­çš„ã€‚AIDLæ”¯æŒçš„è·¨è¿›ç¨‹æ“ä½œçš„æ•°æ®æ˜¯è¦å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ï¼ŒAIDLåº•å±‚å®é™…ä¸Šä¹Ÿæ˜¯ä½¿ç”¨çš„Binderè¿›è¡Œçš„è·¨è¿›ç¨‹æ“ä½œã€‚</p><h2 id="2-AIDLä½¿ç”¨"><a href="#2-AIDLä½¿ç”¨" class="headerlink" title="2.AIDLä½¿ç”¨"></a>2.AIDLä½¿ç”¨</h2><h3 id="2-1-æœåŠ¡ç«¯ä»£ç "><a href="#2-1-æœåŠ¡ç«¯ä»£ç " class="headerlink" title="2.1 æœåŠ¡ç«¯ä»£ç "></a>2.1 æœåŠ¡ç«¯ä»£ç </h3><ol><li>åˆ›å»ºUserå®ä½“ç±»ã€æ³¨æ„ï¼šå¦‚æœAIDLæ–‡ä»¶ä¸­ä½¿ç”¨åˆ°äº†å®ä½“ç±»å¯¹è±¡ï¼Œéœ€è¦è¿›è¡Œåºåˆ—åŒ–Parcelableã€‘</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">public</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">User</span><span class="hljs-params">(Parcel in)</span> &#123;<br>        id = in.readInt();<br>        name = in.readString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Creator</span>&lt;User&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createFromParcel</span><span class="hljs-params">(Parcel in)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(in);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> User[] newArray(<span class="hljs-type">int</span> size) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>[size];<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">describeContents</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToParcel</span><span class="hljs-params">(Parcel parcel, <span class="hljs-type">int</span> i)</span> &#123;<br>        parcel.writeInt(id);<br>        parcel.writeString(name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å…ˆåˆ›å»ºAIDLæ–‡ä»¶ï¼Œå³å‡»ç›´æ¥ç”Ÿæˆ</li></ol><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/1.png" style="zoom:80%;"><p>å®šä¹‰<code>User.aidl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// User.aidl</span><br><span class="hljs-keyword">package</span> com.amx.aidlservice;<br><br><span class="hljs-comment">// Declare any non-default types here with import statements</span><br><br>parcelable User;<br></code></pre></td></tr></table></figure><p>å®šä¹‰<code>UserManager.aidl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// UserManager.aidl</span><br><span class="hljs-keyword">package</span> com.amx.aidlservice;<br><br><span class="hljs-keyword">import</span> com.amx.aidlservice.User;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserManager</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(in User user)</span>;<br>    List&lt;User&gt; <span class="hljs-title function_">getUserList</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šéœ€è¦å¯¼åŒ…ï¼Œå¼•å…¥Userå¯¹è±¡</p></blockquote><ol start="3"><li>åˆ›å»ºæœåŠ¡UserService</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> &#123;<br><br>    <span class="hljs-keyword">private</span> UserManagerImpl mUserManager;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;<br>        mUserManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserManagerImpl</span>();<br>        <span class="hljs-keyword">return</span> mUserManager;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManagerImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UserManager</span>.Stub&#123;<br><br>        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>            users.add(user);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUserList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>            <span class="hljs-keyword">return</span> users;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨æœåŠ¡ä¸­ï¼Œå®ç°UserManagerImplï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºIBinderå¯¹è±¡è¿”å›ç»™onBindæ–¹æ³•</p></blockquote><ol start="4"><li>åœ¨æ¸…å•æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œ</li></ol><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/2.png" style="zoom:80%;"><h3 id="2-2-å®¢æˆ·ç«¯ä»£ç "><a href="#2-2-å®¢æˆ·ç«¯ä»£ç " class="headerlink" title="2.2 å®¢æˆ·ç«¯ä»£ç "></a>2.2 å®¢æˆ·ç«¯ä»£ç </h3><ol><li>å°†aidlæ–‡ä»¶å’Œå®ä½“ç±»å¯¹è±¡åŸå°ä¸åŠ¨çš„æ‹·è´è¿‡æ¥ã€åŒ…æ‹¬åŒ…ã€‘</li></ol><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/3.png" style="zoom:80%;"><ol start="2"><li>è°ƒç”¨æœåŠ¡ç«¯æœåŠ¡è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Button mAddUserBtn;<br>    <span class="hljs-keyword">private</span> Button mQueryUserBtn;<br>    <span class="hljs-keyword">private</span> TextView mUserCount;<br>    <span class="hljs-keyword">private</span> UserManager mUserManager;<br>    <span class="hljs-keyword">private</span> UserConnection mUserConnection;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mIsBind;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        i = <span class="hljs-number">1</span>;<br>        doBindService();<br>        initView();<br>        setListener();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBindService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>        intent.setAction(<span class="hljs-string">&quot;com.amx.aidlservice.THIRD_PART&quot;</span>);<br>        intent.addCategory(Intent.CATEGORY_DEFAULT);<br>        intent.setPackage(<span class="hljs-string">&quot;com.amx.aidlservice&quot;</span>);<br><br>        mUserConnection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserConnection</span>();<br>        mIsBind = bindService(intent, mUserConnection, BIND_AUTO_CREATE);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServiceConnection</span>&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName componentName, IBinder iBinder)</span> &#123;<br>            mUserManager = UserManager.Stub.asInterface(iBinder);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceDisconnected</span><span class="hljs-params">(ComponentName componentName)</span> &#123;<br>            mUserManager = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-meta">@SuppressLint(&quot;SetTextI18n&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setListener</span><span class="hljs-params">()</span> &#123;<br>        mAddUserBtn.setOnClickListener(view -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                mUserManager.addUser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(i,<span class="hljs-string">&quot;å®‰æ…•å˜»&quot;</span> + i++ ));<br>                Toast.makeText(<span class="hljs-built_in">this</span>,<span class="hljs-string">&quot;æ·»åŠ ç”¨æˆ·&quot;</span> + <span class="hljs-string">&quot;å®‰æ…•å˜»&quot;</span> + (i) ,Toast.LENGTH_SHORT).show();<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br>        mQueryUserBtn.setOnClickListener(view -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                mUserCount.setText(<span class="hljs-string">&quot;å½“å‰ç”¨æˆ·æ•°é‡: &quot;</span>+ mUserManager.getUserList().size());;<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initView</span><span class="hljs-params">()</span> &#123;<br>        mAddUserBtn = findViewById(R.id.addUserBtn);<br>        mQueryUserBtn = findViewById(R.id.queryUserBtn);<br>        mUserCount = findViewById(R.id.countTv);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        <span class="hljs-keyword">if</span>(mIsBind &amp;&amp; mUserConnection != <span class="hljs-literal">null</span>)&#123;<br>            unbindService(mUserConnection);<br>            mIsBind = <span class="hljs-literal">false</span>;<br>            mUserConnection = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>åœ¨å®¢æˆ·ç«¯æˆ‘ä»¬é€šè¿‡bindServiceæ‹¿åˆ°ç³»ç»ŸæœåŠ¡ç«¯çš„IBinderå¯¹è±¡ï¼ˆmUserManagerï¼‰ï¼Œç„¶åå°±åƒåŒè¿›ç¨‹è°ƒç”¨è‡ªèº«æ–¹æ³•ä¸€æ ·è°ƒç”¨å®ƒåœ¨æœåŠ¡ç«¯é‡å†™çš„æ–¹æ³•</p></blockquote><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/4.png" style="zoom:80%;"><p>æˆ‘ä»¬æ·»åŠ ç”¨æˆ·åï¼ŒæŸ¥è¯¢ç”¨æˆ·æ•°é‡åä¼šå˜å¤š</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/5.png" style="zoom:80%;"><h2 id="3-AIDLåŸç†"><a href="#3-AIDLåŸç†" class="headerlink" title="3.AIDLåŸç†"></a>3.AIDLåŸç†</h2><p>é¦–å…ˆæˆ‘ä»¬ä»å®¢æˆ·ç«¯æ‹¿åˆ°IBinderå¯¹è±¡å¼€å§‹</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/6.png" style="zoom: 67%;"><p>æˆ‘ä»¬å‘ç°åˆ°äº†AIDLç”Ÿæˆçš„UserMangerä¸­</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/7.png" style="zoom: 67%;"><p>ä¼šç”Ÿæˆä¸€ä¸ªProxyå¯¹è±¡ï¼Œè¿™ä¸ªä¹Ÿç›¸å½“äºæˆ‘ä»¬çš„æ¥å£å¯¹è±¡mUserManager</p><p>ç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº†mUserMangerå¯¹è±¡ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨å®¢æˆ·ç«¯è°ƒç”¨å®ƒçš„æ–¹æ³•</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/8.png" style="zoom: 67%;"><p>é‚£ä¹ˆå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†Proxyçš„addUseræ–¹æ³•</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/9.png" style="zoom: 67%;"><p>æˆ‘ä»¬å‘ç°å®ƒé€šè¿‡<code>transact</code>æ–¹æ³•å»è®¿é—®äº†æœåŠ¡ç«¯ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬èµ°åˆ°äº†Binderæœºåˆ¶é‡Œé¢ï¼Œç”±Binderæœºåˆ¶é€šè¿‡<code>onTransac</code>tæ‰¾åˆ°æˆ‘ä»¬çš„æœåŠ¡ç«¯</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/10.png" style="zoom: 67%;"><p>è€Œè¿™ä¸ªthiså°±æ˜¯æˆ‘ä»¬æœåŠ¡ç«¯åœ¨Serviceåˆ›å»ºçš„å­ç±»UserManegerImplï¼Œå› ä¸ºUserManegerImplç»§æ‰¿äº†AIDLç”Ÿæˆçš„UserManegeræ¥å£ä¸­çš„Stubã€åœ¨æºç ä¸­æ˜¯ä¸€ä¸ªé™æ€æŠ½è±¡ç±»ã€‘</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/11.png" style="zoom: 67%;"><p>è€ŒStubä¸­çš„æ²¡æœ‰å®ç°this.addUseræ–¹æ³•</p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/12.png" style="zoom: 67%;"><p>è€ŒçœŸæ­£å®ç°çš„æ˜¯æˆ‘ä»¬è‡ªå·±çš„å­ç±»UserMangerImplé‡å†™åçš„addUseræ–¹æ³•</p><p><strong>åˆ°è¿™é‡Œæˆ‘ä»¬å…¨éƒ¨æ¸…æ¥šäº†ï¼Œåœ¨å®¢æˆ·ç«¯è°ƒç”¨çš„addUseræ–¹æ³•ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº†æœåŠ¡ç«¯é‡å†™çš„addUseræ–¹æ³•</strong></p><img src="/2023/08/13/%E5%AE%89%E5%8D%93aidl%E9%80%9A%E4%BF%A1/13.png" style="zoom:80%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“tombstoneæœºåˆ¶</title>
    <link href="/2023/08/10/%E5%AE%89%E5%8D%93tombstone%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/08/10/%E5%AE%89%E5%8D%93tombstone%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“tombstoneæœºåˆ¶"><a href="#å®‰å“tombstoneæœºåˆ¶" class="headerlink" title="å®‰å“tombstoneæœºåˆ¶"></a>å®‰å“tombstoneæœºåˆ¶</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/weixin_36389889/article/details/128814353">https://blog.csdn.net/weixin_36389889/article/details/128814353</a></p></blockquote><h2 id="1-tombstoneå®šä¹‰"><a href="#1-tombstoneå®šä¹‰" class="headerlink" title="1.tombstoneå®šä¹‰"></a>1.tombstoneå®šä¹‰</h2><p>å¢“ç¢‘ã€‚å½“ä¸€ä¸ªåŠ¨æ€åº“ï¼ˆnative ç¨‹åºï¼‰å¼€å§‹æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šæ³¨å†Œä¸€äº›è¿æ¥åˆ° debuggerd çš„ signal handlersï¼Œå½“ç³»ç»Ÿ crash çš„æ—¶å€™ï¼Œä¼šä¿å­˜ä¸€ä¸ª tombstone æ–‡ä»¶åˆ°&#x2F;data&#x2F;tombstonesç›®å½•ä¸‹ï¼ˆLogcatä¸­ä¹Ÿä¼šæœ‰ç›¸åº”çš„ä¿¡æ¯ï¼‰ï¼Œæ–‡ä»¶çš„ç¡®å°±åƒå¢“ç¢‘ä¸€æ ·è®°å½•äº†æ­»äº¡äº†çš„è¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼ˆä¾‹å¦‚è¿›ç¨‹çš„è¿›ç¨‹å·ï¼Œçº¿ç¨‹å·ï¼‰ï¼Œæ­»äº¡çš„åœ°å€ï¼ˆåœ¨å“ªä¸ªåœ°å€ä¸Šå‘ç”Ÿäº† Crashï¼‰ï¼Œæ­»äº¡æ—¶çš„ç°åœºæ˜¯ä»€ä¹ˆæ ·çš„ï¼ˆè®°å½•äº†ä¸€ç³»åˆ—çš„å †æ ˆè°ƒç”¨ä¿¡æ¯ï¼‰ç­‰ç­‰ã€‚ </p><h2 id="2-tombstoneæ—¥å¿—åˆ†æå®šä½"><a href="#2-tombstoneæ—¥å¿—åˆ†æå®šä½" class="headerlink" title="2.tombstoneæ—¥å¿—åˆ†æå®šä½"></a>2.tombstoneæ—¥å¿—åˆ†æå®šä½</h2><p>Tomestoneæ ·ä¾‹ï¼ˆå·²éšå»æ•æ„Ÿä¿¡æ¯ï¼‰ï¼š</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c#">*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***<br>Build fingerprint: <span class="hljs-string">&#x27;xxx&#x27;</span><br>Revision: <span class="hljs-string">&#x27;0&#x27;</span><br>ABI: <span class="hljs-string">&#x27;arm64&#x27;</span><br>Timestamp: <span class="hljs-number">2023</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span> <span class="hljs-number">02</span>:<span class="hljs-number">27</span>:<span class="hljs-number">42.367624270</span>+<span class="hljs-number">0800</span><br>Process uptime: <span class="hljs-number">19</span>s<br>Cmdline: /vendor/bin/android.hardware.automotive.evs@<span class="hljs-number">1.0</span>-ais<br>pid: <span class="hljs-number">504</span>, tid: <span class="hljs-number">504</span>, name: evs@<span class="hljs-number">1.0</span>-ais  &gt;&gt;&gt; /vendor/bin/android.hardware.automotive.evs@<span class="hljs-number">1.0</span>-ais &lt;&lt;&lt;<br>uid: <span class="hljs-number">1000</span><br>signal <span class="hljs-number">11</span> (SIGSEGV), code <span class="hljs-number">1</span> (SEGV_MAPERR), fault addr <span class="hljs-number">0x702f3421d4</span><br>    x0  <span class="hljs-number">00000000f</span>fffffea  x1  <span class="hljs-number">0000000000000080</span>  x2  <span class="hljs-number">0000007f</span>d0ccb200  x3  <span class="hljs-number">0000000000000080</span><br>    x4  <span class="hljs-number">000000000000000</span>c  x5  <span class="hljs-number">00000000f</span>ffffff8  x6  <span class="hljs-number">0000000000000017</span>  x7  <span class="hljs-number">0000000000000438</span><br>    x8  <span class="hljs-number">000000702f</span>33b010  x9  <span class="hljs-number">00000000000071</span>c4  x10 <span class="hljs-number">0000000000000780</span>  x11 <span class="hljs-number">0000000000000002</span><br>    x12 <span class="hljs-number">0000007f</span>d0ccb5e8  x13 <span class="hljs-number">00000070</span>abb2af8c  x14 <span class="hljs-number">0000007f</span>d0ccb548  x15 <span class="hljs-number">0000007f</span>d0ccb438<br>    x16 <span class="hljs-number">00000070</span>ab8642b0  x17 <span class="hljs-number">00000070</span>ab8619d4  x18 <span class="hljs-number">0000007138</span>dec000  x19 <span class="hljs-number">0000007f</span>d0ccb200<br>    x20 <span class="hljs-number">000000702f</span>33b000  x21 <span class="hljs-number">0000007137</span>ecc000  x22 <span class="hljs-number">000000702f</span>340c34  x23 <span class="hljs-number">00000000000001f</span>b<br>    x24 b400007137aa1560  x25 b400007137aa87b0  x26 <span class="hljs-number">0000000000000000</span>  x27 <span class="hljs-number">0000007137</span>ecc000<br>    x28 <span class="hljs-number">0000000000000000</span>  x29 <span class="hljs-number">0000007f</span>d0ccb190<br>    lr  <span class="hljs-number">00000070</span>ab7f8ddc  sp  <span class="hljs-number">0000007f</span>d0cca680  pc  <span class="hljs-number">00000070</span>ab861bf4  pst <span class="hljs-number">0000000060000000</span><br>backtrace:<br>      <span class="hljs-meta">#00 pc 0000000000002bf4  /vendor/lib64/libqdMetaData.so (getMetaDataVa+544) (BuildId: 5f8f611fe24daad279605726e2140611)</span><br>      <span class="hljs-meta">#01 pc 0000000000006dd8  /vendor/lib64/libgrallocutils.so (gralloc::GetCustomDimensions(private_handle_t*, int*, int*)+76) (BuildId: 95f208c6056517672d1fa2c0ce46c9a4)</span><br>      <span class="hljs-meta">#02 pc 000000000000d870  /vendor/lib64/hw/android.hardware.graphics.mapper@4.0-impl-qti-display.so (vendor::qti::hardware::display::mapperextensions::V1_1::implementation::QtiMapperExtensions::getCustomDimensions(void*, std::__1::function&lt;void (vendor::qti::hardware::display::mapperextensions::V1_0::Error, int, int)&gt;)+104) (BuildId: 496c1d7446fe4c37158d156b97488608)</span><br>      <span class="hljs-meta">#03 pc 0000000000017024  /vendor/lib64/vendor.qti.hardware.display.mapperextensions@1.1.so (vendor::qti::hardware::display::mapperextensions::V1_1::BsQtiMapperExtensions::getCustomDimensions(void*, std::__1::function&lt;void (vendor::qti::hardware::display::mapperextensions::V1_0::Error, int, int)&gt;)+152) (BuildId: 86b03cacb633046f5001ffbd4d19c6a6)</span><br>      <span class="hljs-meta">#04 pc 00000000000104ec  /vendor/lib64/egl/eglSubDriverAndroid.so (BuildId: 5b97660bec7ac290203b0cbf9d44710a)</span><br>      <span class="hljs-meta">#05 pc 00000000000122fc  /vendor/lib64/egl/eglSubDriverAndroid.so (BuildId: 5b97660bec7ac290203b0cbf9d44710a)</span><br>      <span class="hljs-meta">#06 pc 0000000000013fb4  /vendor/lib64/egl/eglSubDriverAndroid.so (BuildId: 5b97660bec7ac290203b0cbf9d44710a)</span><br>      <span class="hljs-meta">#07 pc 00000000002bebd0  /vendor/lib64/egl/libGLESv2_adreno.so (BuildId: b5a32c58a407e9d5153c7ed114659e3f)</span><br>      <span class="hljs-meta">#08 pc 00000000001c3fd8  /vendor/lib64/egl/libGLESv2_adreno.so (BuildId: b5a32c58a407e9d5153c7ed114659e3f)</span><br>      <span class="hljs-meta">#09 pc 00000000001c5870  /vendor/lib64/egl/libGLESv2_adreno.so (BuildId: b5a32c58a407e9d5153c7ed114659e3f)</span><br>      <span class="hljs-meta">#10 pc 00000000002077d4  /vendor/lib64/egl/libGLESv2_adreno.so (BuildId: b5a32c58a407e9d5153c7ed114659e3f)</span><br>      <span class="hljs-meta">#11 pc 0000000000011258  /vendor/bin/android.hardware.automotive.evs@1.0-ais (GlWrapper::renderImageToScreen()+80) (BuildId: 22b5c23192874a857be557ff2bacc8e8)</span><br>      <span class="hljs-meta">#12 pc 0000000000022638  /vendor/bin/android.hardware.automotive.evs@1.0-ais (android::hardware::automotive::evs::V1_0::implementation::EvsGlDisplay::returnTargetBufferForDisplay(android::hardware::automotive::evs::V1_0::BufferDesc const&amp;)+204) (BuildId: 22b5c23192874a857be557ff2bacc8e8)</span><br>      <span class="hljs-meta">#13 pc 000000000002d598  /apex/com.android.vndk.v31/lib64/android.hardware.automotive.evs@1.0.so (android::hardware::automotive::evs::V1_0::BnHwEvsDisplay::_hidl_returnTargetBufferForDisplay(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel const&amp;, android::hardware::Parcel*, std::__1::function&lt;void (android::hardware::Parcel&amp;)&gt;)+220) (BuildId: e989defcc1a8408c61f50ee43d898657)</span><br>      <span class="hljs-meta">#14 pc 000000000002da30  /apex/com.android.vndk.v31/lib64/android.hardware.automotive.evs@1.0.so (android::hardware::automotive::evs::V1_0::BnHwEvsDisplay::onTransact(unsigned int, android::hardware::Parcel const&amp;, android::hardware::Parcel*, unsigned int, std::__1::function&lt;void (android::hardware::Parcel&amp;)&gt;)+404) (BuildId: e989defcc1a8408c61f50ee43d898657)</span><br>      <span class="hljs-meta">#15 pc 00000000000768a4  /apex/com.android.vndk.v31/lib64/libhidlbase.so (android::hardware::BHwBinder::transact(unsigned int, android::hardware::Parcel const&amp;, android::hardware::Parcel*, unsigned int, std::__1::function&lt;void (android::hardware::Parcel&amp;)&gt;)+92) (BuildId: 1c806a0c7106677e8355f6be1abbdb9b)</span><br>      <span class="hljs-meta">#16 pc 0000000000074eb8  /apex/com.android.vndk.v31/lib64/libhidlbase.so (android::hardware::IPCThreadState::getAndExecuteCommand()+1104) (BuildId: 1c806a0c7106677e8355f6be1abbdb9b)</span><br>      <span class="hljs-meta">#17 pc 0000000000074988  /apex/com.android.vndk.v31/lib64/libhidlbase.so (android::hardware::IPCThreadState::joinThreadPool(bool)+96) (BuildId: 1c806a0c7106677e8355f6be1abbdb9b)</span><br>      <span class="hljs-meta">#18 pc 00000000000121d0  /vendor/bin/android.hardware.automotive.evs@1.0-ais (main+576) (BuildId: 22b5c23192874a857be557ff2bacc8e8)</span><br>      <span class="hljs-meta">#19 pc 00000000000822d4  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+96) (BuildId: a01cf07b6a9f32a66547d7774501375f)</span><br>...<br>...<br>...<br></code></pre></td></tr></table></figure><ul><li>å‘ç”Ÿnative crashçš„æ—¶é—´ï¼Œæœ‰äº†è¿™ä¸ªæ—¶é—´å¯ä»¥å¯¹ç…§logcatçš„æ—¥å¿—ï¼Œæ‰¾åˆ°å‡†ç¡®çš„crashä½ç½®ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Timestamp: 2023-01-29 02:27:42.367624270+0800<br></code></pre></td></tr></table></figure><ul><li>å‡ºé”™çš„åŠ¨æ€åº“ä¸ºï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Cmdline: /vendor/bin/android.hardware.automotive.evs@1.0-ais<br></code></pre></td></tr></table></figure><ul><li>ç„¶åï¼Œçœ‹backtraceï¼Œé¡¾åæ€ä¹‰ï¼Œå‡ºé”™æ ˆã€‚ä»ä¸Šåˆ°ä¸‹å°±æ˜¯è°ƒç”¨æ ˆçš„é€†åºï¼Œå¯ä»¥çœ‹åˆ°èµ˜è¿°åˆ°<a href="mailto:&#101;&#x76;&#x73;&#64;&#49;&#46;&#x30;&#45;&#x61;&#x69;&#x73;">&#101;&#x76;&#x73;&#64;&#49;&#46;&#x30;&#45;&#x61;&#x69;&#x73;</a>è¿™ä¸ªåŠ¨æ€åº“çš„GlWrapper::renderImageToScreen()å‡½æ•°ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#11 pc 0000000000011258  /vendor/bin/android.hardware.automotive.evs@1.0-ais (GlWrapper::renderImageToScreen()+80) (BuildId: 22b5c23192874a857be557ff2bacc8e8)</span><br></code></pre></td></tr></table></figure><p>èŒƒå›´å¾ˆå°äº†å§ï¼Œä½†ä»ä¸å¤Ÿï¼Œæˆ‘ä»¬æƒ³å®šä½åˆ°å…·ä½“å“ªä¸€è¡Œï¼Œåé¢+80å¹¶ä¸æ˜¯è¡Œæ•°ï¼Œæˆ‘ä»¬åªå…³æ³¨pcåé¢çš„åœ°å€0000000000011258ã€‚é‚£ä¹ˆå°±å¼€å§‹ä½¿ç”¨addr2lineå·¥å…·ã€‚addr2lineå·¥å…·åœ¨linuxæ˜¯å°±æœ‰ï¼Œæ‰€ä»¥åœ¨çœŸæœºä¸ŠæŠŠ&#x2F;vendor&#x2F;bin&#x2F;<a href="mailto:&#97;&#110;&#x64;&#x72;&#x6f;&#x69;&#100;&#x2e;&#104;&#97;&#x72;&#100;&#119;&#97;&#114;&#101;&#x2e;&#97;&#117;&#x74;&#x6f;&#109;&#111;&#x74;&#x69;&#x76;&#101;&#46;&#x65;&#118;&#x73;&#x40;&#49;&#x2e;&#x30;&#x2d;&#97;&#x69;&#115;">&#97;&#110;&#x64;&#x72;&#x6f;&#x69;&#100;&#x2e;&#104;&#97;&#x72;&#100;&#119;&#97;&#114;&#101;&#x2e;&#97;&#117;&#x74;&#x6f;&#109;&#111;&#x74;&#x69;&#x76;&#101;&#46;&#x65;&#118;&#x73;&#x40;&#49;&#x2e;&#x30;&#x2d;&#97;&#x69;&#115;</a>æ‹‰å‡ºæ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb pull /vendor/bin/android.hardware.automotive.evs@1.0-ais<br></code></pre></td></tr></table></figure><p>ç„¶åæ”¾åˆ°linuxç³»ç»Ÿä¸Šï¼Œæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">addr2line 0000000000011258 -e android.hardware.automotive.evs@1.0-ais -f -C -s<br></code></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">GlWrapper::renderImageToScreen()<br>??:?<br></code></pre></td></tr></table></figure><p>è¯´æ˜ç¼–è¯‘æ—¶ç¬¦å·è¡¨è¢«ä¼˜åŒ–æ‰äº†ï¼Œé‚£ä¹ˆé‡æ–°ç¼–è¯‘è¿™ä¸ªåŠ¨æ€åº“ï¼Œç„¶åå†outç›®å½•ä¸‹æ‰¾ç”Ÿæˆçš„å¸¦ç¬¦å·è¡¨çš„æ–‡ä»¶ï¼Œè·¯å¾„ç±»ä¼¼ï¼š<code>out/target/product/xxx/symbols/vendor/bin</code></p><p>å…³é”®å°±æ˜¯<strong>symbols</strong>è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯æœªè¢«ä¼˜åŒ–ç¬¦å·è¡¨çš„æ–‡ä»¶ã€‚</p><p>åœ¨è¿™ä¸‹é¢æ‰§è¡ŒåŒæ ·çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">addr2line 0000000000011258 -e android.hardware.automotive.evs@1.0-ais -f -C -s<br></code></pre></td></tr></table></figure><p>è·å¾—ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">GlWrapper::<span class="hljs-built_in">renderImageToScreen</span>()<br>GlWrapper.cpp:<span class="hljs-number">441</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€Androidã€‘å¦‚ä½•åˆ†æ ANR æ—¥å¿—</title>
    <link href="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/"/>
    <url>/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€Androidã€‘å¦‚ä½•åˆ†æ-ANR-æ—¥å¿—"><a href="#ã€Androidã€‘å¦‚ä½•åˆ†æ-ANR-æ—¥å¿—" class="headerlink" title="ã€Androidã€‘å¦‚ä½•åˆ†æ ANR æ—¥å¿—"></a>ã€Androidã€‘å¦‚ä½•åˆ†æ ANR æ—¥å¿—</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/yang553566463/article/details/125335624">https://blog.csdn.net/yang553566463/article/details/125335624</a></p></blockquote><h2 id="å¯¼è‡´ANRçš„åŸå› "><a href="#å¯¼è‡´ANRçš„åŸå› " class="headerlink" title="å¯¼è‡´ANRçš„åŸå› "></a>å¯¼è‡´ANRçš„åŸå› </h2><p><strong>åº”ç”¨å±‚å¯¼è‡´çš„ANRï¼ˆè€—æ—¶æ“ä½œï¼‰</strong>ã€</p><ul><li>ä¸»çº¿ç¨‹è€—æ—¶é•¿</li><li>ä¸»çº¿ç¨‹æ–¹æ³•æ‰§è¡Œäº†æ­»å¾ªç¯</li><li>ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹é‡Šæ”¾é”æ—¶é—´è¿‡é•¿</li><li>åº”ç”¨å†…å­˜ç´§å¼ ï¼Œå½“ä¸€ä¸ªåº”ç”¨é•¿æœŸå¤„äºå†…å­˜ç´§å¼ çŠ¶æ€ï¼Œä¼šå¯¼è‡´é¢‘ç¹å†…å­˜äº¤æ¢ï¼Œè¿›è€Œå¯¼è‡´åº”ç”¨çš„ä¸€äº›æ“ä½œè¶…æ—¶</li></ul><p><strong>ç³»ç»Ÿå±‚å¯¼è‡´çš„ANR</strong></p><ul><li>CPUè¢«æŠ¢å ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå‰å°åœ¨ç©æ¸¸æˆï¼Œå¯èƒ½ä¼šå¯¼è‡´ä½ çš„åå°å¹¿æ’­è¢«æŠ¢å CPU</li><li>ç³»ç»ŸæœåŠ¡æ— æ³•åŠæ—¶å“åº”ï¼šæ¯”å¦‚è·å–ç³»ç»Ÿè”ç³»äººç­‰ï¼Œç³»ç»Ÿçš„æœåŠ¡éƒ½æ˜¯Binderæœºåˆ¶ï¼ŒæœåŠ¡èƒ½åŠ›ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæœ‰å¯èƒ½ç³»ç»ŸæœåŠ¡é•¿æ—¶é—´ä¸å“åº”å¯¼è‡´ANR</li><li>å…¶ä»–åº”ç”¨å ç”¨çš„å¤§é‡å†…å­˜</li></ul><h2 id="å¯¼å‡ºå¹¶æŸ¥çœ‹ANRæ—¥å¿—"><a href="#å¯¼å‡ºå¹¶æŸ¥çœ‹ANRæ—¥å¿—" class="headerlink" title="å¯¼å‡ºå¹¶æŸ¥çœ‹ANRæ—¥å¿—"></a>å¯¼å‡ºå¹¶æŸ¥çœ‹ANRæ—¥å¿—</h2><p><strong>æ–¹æ³•ä¸€</strong></p><p>å½“ç³»ç»Ÿå‡ºç° ANR æ—¶ï¼Œè®¾å¤‡ä¼šè‡ªåŠ¨å°† ANR æ—¥å¿—è¾“å‡ºåˆ° <code>/data/anr/</code> ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/8eedb9c9d48a49a4ac5adf3c6c2b495e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¯¹äºè¿™äº›æ–‡ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥åŒå‡»åœ¨ <a href="https://so.csdn.net/so/search?q=Android&spm=1001.2101.3001.7020">Android</a> Studio ä¸Šæ‰“å¼€å³å¯ã€‚</p><p><strong>æ–¹æ³•äºŒ</strong></p><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><blockquote><p>adb bugreport D:\mybug\bugrep.zip</p></blockquote><p>å¯ä»¥å¯¼å‡ºè®¾å¤‡æ‰€æœ‰ bug æ—¥å¿—ï¼Œæ‰§è¡Œå‘½ä»¤åï¼Œåœ¨æŒ‡å®šæ–‡ä»¶å¤¹å†…å¾—åˆ°ä¸€ä¸ª zip æ–‡ä»¶ï¼Œå°†æ–‡ä»¶è§£å‹åæ‰“å¼€ï¼Œæ–‡ä»¶ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/5a6ef7aa45dd499d85e6e3ba29389908.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å…¶ä¸­ï¼Œè®¾å¤‡çš„ anr æ—¥å¿—ä¼šä¿å­˜åœ¨è¯¥è·¯å¾„ä¸‹ï¼š<code>D:\mybug\bugrep\FS\data\anr</code>ï¼Œå¦‚å›¾ï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/14f45c0d8a754cc782f1cb203121b7d3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¦å¤–ï¼Œè¯¥æ–‡ä»¶ <code>D:\mybug\bugrep\bugreport-device.200216.002-2022-06-16-15-30-10.txt</code> å†…ä¹Ÿæœ‰æœ‰ anr æ—¥å¿—çš„æ‰“å°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å…³é”®è¯æœç´¢è¯¥æ–‡ä»¶çš„ä¸€äº›å¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚ï¼š</p><blockquote><p>â€œmainâ€ prio&#x3D;ï¼šæœç´¢ anr ç›¸å…³ä¿¡æ¯ã€åº”ç”¨å±‚å¯¼è‡´çš„ANRä¸€èˆ¬æ˜¯ä¸»çº¿ç¨‹è€—æ—¶é•¿ã€‘</p><p>beginning of crashï¼šæœç´¢ crash ç›¸å…³ä¿¡æ¯</p><p>CPU usage fromï¼šæœç´¢ cpu ä½¿ç”¨ä¿¡æ¯</p></blockquote><h2 id="å¦‚ä½•åˆ†æANRæ—¥å¿—"><a href="#å¦‚ä½•åˆ†æANRæ—¥å¿—" class="headerlink" title="å¦‚ä½•åˆ†æANRæ—¥å¿—"></a>å¦‚ä½•åˆ†æANRæ—¥å¿—</h2><p>ä¸€ä¸ª ANR æ—¥å¿—ï¼Œä¼šåŒ…å«å½“å‰è®¾å¤‡ä¸­æ‰€æœ‰è¿›ç¨‹çš„ä½¿ç”¨æƒ…å†µï¼Œæ¯ä¸ªè¿›ç¨‹å¼€å¤´éƒ½ä¼š</p><p>ä»¥ <code>----- pid 16808 at date -----</code> æ¥å¼€å¤´ï¼Œ</p><p>ä»¥ <code>----- end 16808 -----</code> æ¥ç»“å°¾ï¼Œ</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">----- pid 16808 at 2022-06-16 16:56:04 -----<br>Cmd line: com.example.demoproject<br>...<br>...<br>...<br>----- end 16808 -----<br></code></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæ¯ä¸ªè¿›ç¨‹æ—¥å¿—ä¸­éƒ½ä¼šæœ‰ä¸€äº›è¿›ç¨‹<strong>å†…å­˜ç›¸å…³</strong>çš„ä¿¡æ¯ï¼Œå¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">----- pid 16808 at 2022-06-16 16:56:04 -----<br>Cmd line: com.example.demoproject<br>...<br>...<br>Total number of allocations 59378 // è¿›ç¨‹åˆ›å»ºåˆ°ç°åœ¨ä¸€å…±åˆ›å»ºäº†å¤šå°‘å¯¹è±¡<br>Total bytes allocated 8815KB // è¿›ç¨‹åˆ›å»ºåˆ°ç°åœ¨ä¸€å…±ç”³è¯·äº†å¤šå°‘å†…å­˜<br>Total bytes freed 6847KB // è¿›ç¨‹åˆ›å»ºåˆ°ç°åœ¨ä¸€å…±é‡Šæ”¾äº†å¤šå°‘å†…å­˜<br>Free memory 23MB // ç©ºé—²å†…å­˜ï¼ˆå¯ç”¨å†…å­˜ï¼‰<br>Free memory until GC 23MB // GCå‰çš„ç©ºé—²å†…å­˜<br>Free memory until OOME 190MB // OOMä¹‹å‰çš„å¯ç”¨å†…å­˜ï¼Œå½“è¿™ä¸ªå€¼å¾ˆå°çš„æ—¶å€™ï¼Œå·²ç»å¤„äºå†…å­˜ç´§å¼ çŠ¶æ€ï¼Œåº”ç”¨å¯èƒ½å ç”¨äº†è¿‡å¤šçš„å†…å­˜<br>Total memory 25MB // å½“å‰æ€»å†…å­˜ï¼ˆå·²ç”¨+å¯ç”¨ï¼‰<br>Max memory 192MB // è¿›ç¨‹æœ€å¤šèƒ½ç”³è¯·çš„å†…å­˜ <br>...<br>----- end 16808 -----<br></code></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæ¯ä¸ªè¿›ç¨‹æ—¥å¿—ä¸­éƒ½ä¼šæœ‰è¿›ç¨‹å †æ ˆä¿¡æ¯ï¼Œå †æ ˆä¿¡æ¯éå¸¸é‡è¦ï¼Œå®ƒå±•ç¤ºäº†å‘ç”Ÿ ANR çš„è¿›ç¨‹å½“å‰çš„<strong>æ‰€æœ‰çº¿ç¨‹</strong>çŠ¶æ€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">----- pid 16808 at 2022-06-16 16:56:04 -----<br>... <br><span class="hljs-built_in">suspend</span> all histogram:  Sum: 114us 99% C.I. 2us-27us Avg: 12.666us Max: 27us<br>DALVIK THREADS (14):<br><span class="hljs-string">&quot;Signal Catcher&quot;</span> daemon prio=5 tid=7 Runnable<br>  | group=<span class="hljs-string">&quot;system&quot;</span> sCount=0 dsCount=0 flags=0 obj=0x182c0298 self=0x7914b9c000<br>  | sysTid=16819 <span class="hljs-built_in">nice</span>=0 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x791a98fd50<br>  | state=R schedstat=( 28572293 3522448 11 ) utm=1 stm=1 core=0 HZ=100<br>  | stack=0x791a899000-0x791a89b000 stackSize=991KB<br>  | held mutexes= <span class="hljs-string">&quot;mutator lock&quot;</span>(shared held)<br>  native: <span class="hljs-comment">#00 pc 00000000004108e8  /apex/com.android.runtime/lib64/libart.so (art::DumpNativeStack(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;, int, BacktraceMap*, char const*, art::ArtMethod*, void*, bool)+140)</span><br>  native: <span class="hljs-comment">#01 pc 00000000004f8040  /apex/com.android.runtime/lib64/libart.so (art::Thread::DumpStack(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;, bool, BacktraceMap*, bool) const+512)</span><br>  native: <span class="hljs-comment">#02 pc 000000000051297c  /apex/com.android.runtime/lib64/libart.so (art::DumpCheckpoint::Run(art::Thread*)+828)</span><br>  native: <span class="hljs-comment">#03 pc 000000000050b7a0  /apex/com.android.runtime/lib64/libart.so (art::ThreadList::RunCheckpoint(art::Closure*, art::Closure*)+456)</span><br>  native: <span class="hljs-comment">#04 pc 000000000050ac84  /apex/com.android.runtime/lib64/libart.so (art::ThreadList::Dump(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;, bool)+1964)</span><br>  native: <span class="hljs-comment">#05 pc 000000000050a364  /apex/com.android.runtime/lib64/libart.so (art::ThreadList::DumpForSigQuit(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;)+844)</span><br>  native: <span class="hljs-comment">#06 pc 00000000004c5778  /apex/com.android.runtime/lib64/libart.so (art::Runtime::DumpForSigQuit(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;)+200)</span><br>  native: <span class="hljs-comment">#07 pc 00000000004d9bb0  /apex/com.android.runtime/lib64/libart.so (art::SignalCatcher::HandleSigQuit()+1352)</span><br>  native: <span class="hljs-comment">#08 pc 00000000004d8c5c  /apex/com.android.runtime/lib64/libart.so (art::SignalCatcher::Run(void*)+252)</span><br>  native: <span class="hljs-comment">#09 pc 00000000000e68a0  /apex/com.android.runtime/lib64/bionic/libc.so (__pthread_start(void*)+36)</span><br>  native: <span class="hljs-comment">#10 pc 0000000000084b6c  /apex/com.android.runtime/lib64/bionic/libc.so (__start_thread+64)</span><br>  (no managed stack frames)<br><br><span class="hljs-string">&quot;main&quot;</span> prio=5 tid=1 Blocked<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 flags=1 obj=0x72e0ee78 self=0x79aafbcc00<br>  | sysTid=16808 <span class="hljs-built_in">nice</span>=-10 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x79ac524ed0<br>  | state=S schedstat=( 1140726262 41301458 368 ) utm=94 stm=20 core=0 HZ=100<br>  | stack=0x7fe35ed000-0x7fe35ef000 stackSize=8192KB<br>  | held mutexes=<br>  at com.example.demoproject.view.MainActivity.doSomething(MainActivity.kt:51)<br>  - waiting to lock &lt;0x02250ad8&gt; (a com.example.demoproject.view.MainActivity) held by thread 18<br>  at com.example.demoproject.view.MainActivity.click2(MainActivity.kt:36)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at androidx.appcompat.app.AppCompatViewInflater<span class="hljs-variable">$DeclaredOnClickListener</span>.onClick(AppCompatViewInflater.java:441)<br>  at android.view.View.performClick(View.java:7259)<br>  at com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1194)<br>  at android.view.View.performClickInternal(View.java:7236)<br>  at android.view.View.access<span class="hljs-variable">$3600</span>(View.java:801)<br>  at android.view.View<span class="hljs-variable">$PerformClick</span>.run(View.java:27896)<br>  at android.os.Handler.handleCallback(Handler.java:883)<br>  at android.os.Handler.dispatchMessage(Handler.java:100)<br>  at android.os.Looper.loop(Looper.java:214)<br>  at android.app.ActivityThread.main(ActivityThread.java:7397)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at com.android.internal.os.RuntimeInit<span class="hljs-variable">$MethodAndArgsCaller</span>.run(RuntimeInit.java:492)<br>  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:935)   <br>      <br><span class="hljs-string">&quot;Jit thread pool worker thread 0&quot;</span> daemon prio=5 tid=2 Native<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 flags=1 obj=0x182c0220 self=0x7919600000<br>  | sysTid=16814 <span class="hljs-built_in">nice</span>=0 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x791aa94d40<br>  | state=S schedstat=( 44810570 11604064 76 ) utm=4 stm=0 core=0 HZ=100<br>  | stack=0x791a996000-0x791a998000 stackSize=1023KB<br>  | held mutexes=<br>  kernel: (couldn<span class="hljs-string">&#x27;t read /proc/self/task/16814/stack)</span><br><span class="hljs-string">  native: #00 pc 000000000008033c  /apex/com.android.runtime/lib64/bionic/libc.so (syscall+28)</span><br><span class="hljs-string">  native: #01 pc 000000000014b1f4  /apex/com.android.runtime/lib64/libart.so (art::ConditionVariable::WaitHoldingLocks(art::Thread*)+148)</span><br><span class="hljs-string">  native: #02 pc 00000000005143dc  /apex/com.android.runtime/lib64/libart.so (art::ThreadPool::GetTask(art::Thread*)+256)</span><br><span class="hljs-string">  native: #03 pc 0000000000513768  /apex/com.android.runtime/lib64/libart.so (art::ThreadPoolWorker::Run()+144)</span><br><span class="hljs-string">  native: #04 pc 0000000000513228  /apex/com.android.runtime/lib64/libart.so (art::ThreadPoolWorker::Callback(void*)+148)</span><br><span class="hljs-string">  native: #05 pc 00000000000e68a0  /apex/com.android.runtime/lib64/bionic/libc.so (__pthread_start(void*)+36)</span><br><span class="hljs-string">  native: #06 pc 0000000000084b6c  /apex/com.android.runtime/lib64/bionic/libc.so (__start_thread+64)</span><br><span class="hljs-string">  (no managed stack frames)</span><br><span class="hljs-string">...</span><br><span class="hljs-string">----- end 16808 -----</span><br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šæˆªå›¾ä¸­ï¼Œæœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ Signal Catcher çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ main çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ Jit thread pool worker thread 0ï¼Œä»–ä»¬çš„çº¿ç¨‹çŠ¶æ€åˆ†åˆ«æ˜¯ Runnable ã€ blocked å’Œ native çŠ¶æ€ã€‚</p><p>è€Œåœ¨ Java ä¸­ï¼Œçº¿ç¨‹çŠ¶æ€æœ‰6ç§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>NEW - åˆ›å»ºçŠ¶æ€</li><li>RUNNABLE - å°±ç»ªæˆ–è¿è¡ŒçŠ¶æ€</li><li>BLOCKED - é˜»å¡çŠ¶æ€</li><li>WATING - ç­‰å¾…çŠ¶æ€</li><li>TIMED_WAITING - å®šæ—¶ç­‰å¾…çŠ¶æ€</li><li>TERMINATED - ç»ˆæ­¢çŠ¶æ€</li></ul><p>é‚£ä¹ˆï¼Œä¸Šè¿°æ—¥å¿—ä¸­çš„ <code>native</code> çŠ¶æ€æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å…¶å®è¯¥çŠ¶æ€æ˜¯ <code>cpp</code> ä»£ç ä¸­å®šä¹‰çš„çº¿ç¨‹çŠ¶æ€ï¼Œä»–è·Ÿ <code>java</code> å®šä¹‰çš„çº¿ç¨‹çŠ¶æ€å…³ç³»å¦‚ä¸‹ï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/21420c32c57e447bad14cb690bbf254c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/image-20230810214928410.png" alt="image-20230810214928410" style="zoom: 67%;"><p>ç”±ä¸Šå¯çŸ¥ï¼Œnative çŠ¶æ€å¯¹åº”çš„ java çº¿ç¨‹çŠ¶æ€æ˜¯ runnable çŠ¶æ€ã€‚</p><p>å †æ ˆä¿¡æ¯æ˜¯æˆ‘ä»¬åˆ†æANRçš„ç¬¬ä¸€ä¸ªé‡è¦çš„ä¿¡æ¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼š</p><ul><li>ä¸»çº¿ç¨‹å¤„äº BLOCK &#x2F; WAITING &#x2F; TIMEWAITING çŠ¶æ€ï¼ŒåŸºæœ¬ä¸Šæ˜¯å‡½æ•°é˜»å¡å¯¼è‡´çš„ anr</li><li>è‹¥ä¸»çº¿ç¨‹æ— å¼‚å¸¸ï¼Œåˆ™åº”è¯¥æ’æŸ¥ CPU è´Ÿè½½å’Œå†…å­˜ç¯å¢ƒç­‰å…¶ä»–å› ç´ </li></ul><p>å¦å¤–ï¼Œåœ¨ anr æ—¥å¿—ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å¸¸è§å‚æ•°ï¼Œä»–ä»¬çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>groupï¼šçº¿ç¨‹æ‰€å¤„çš„çº¿ç¨‹ç»„</li><li>sCountï¼šçº¿ç¨‹è¢«æ­£å¸¸æŒ‚èµ·çš„æ¬¡æ•°</li><li>dsCountï¼šçº¿ç¨‹å› è°ƒè¯•è€ŒæŒ‚èµ·æ¬¡æ•°</li><li>niceï¼šçº¿ç¨‹çš„è°ƒåº¦ä¼˜å…ˆçº§</li><li>utmï¼šçº¿ç¨‹åœ¨ç”¨æˆ·æ€ä¸­è°ƒåº¦æ—¶é—´å€¼</li><li>stmï¼šçº¿ç¨‹åœ¨å†…æ ¸æ€ä¸­çš„è°ƒåº¦æ—¶é—´å€¼</li><li>coreï¼šæœ€åæ‰§è¡Œè¿™ä¸ªçº¿ç¨‹çš„CPUæ ¸åºå·</li></ul><h2 id="ANRæ¡ˆä¾‹åˆ†æ"><a href="#ANRæ¡ˆä¾‹åˆ†æ" class="headerlink" title="ANRæ¡ˆä¾‹åˆ†æ"></a>ANRæ¡ˆä¾‹åˆ†æ</h2><h3 id="æ¡ˆä¾‹ä¸€-ã€Slepping-anr"><a href="#æ¡ˆä¾‹ä¸€-ã€Slepping-anr" class="headerlink" title="æ¡ˆä¾‹ä¸€ ã€Slepping anr"></a>æ¡ˆä¾‹ä¸€ ã€Slepping anr</h3><p>MainActivity ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : AppCompatActivity() &#123;<br>    <br>    override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)<br>        setContentView(R.layout.activity_main)<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç‚¹å‡»ç¡çœ  10s</span><br><span class="hljs-comment">     */</span><br>    fun <span class="hljs-title function_">clickToSleep</span><span class="hljs-params">(view: View)</span> &#123;<br>        Thread.sleep(<span class="hljs-number">10_000</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç‚¹å‡»æŒ‰é’®ç¡çœ  10s åï¼Œæˆ‘ä»¬å·¦æ»‘æˆ–è€…ç‚¹å‡»è¿”å›é”®é€€å‡º MainActivityï¼ˆç”±äºä¸»çº¿ç¨‹æ­£åœ¨ç¡çœ ï¼Œæ‰€ä»¥æ­¤æ—¶æ˜¯æ— æ³•é€€å‡ºæˆåŠŸçš„ï¼‰ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç³»ç»Ÿå°†ä¼šå¼¹å‡º ANR å¼¹çª—ã€‚</p><p>æˆ‘ä»¬å¯¼å‡º ANR æ—¥å¿—å¹¶æ‰“å¼€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;main&quot;</span> prio=5 tid=1 Sleeping<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 flags=1 obj=0x72e0ee78 self=0x79aafbcc00<br>  | sysTid=16356 <span class="hljs-built_in">nice</span>=-10 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x79ac524ed0<br>  | state=S schedstat=( 1075827038 33414740 291 ) utm=93 stm=14 core=2 HZ=100<br>  | stack=0x7fe35ed000-0x7fe35ef000 stackSize=8192KB<br>  | held mutexes=<br>  at java.lang.Thread.<span class="hljs-built_in">sleep</span>(Native method)<br>  - sleeping on &lt;0x04fbafa5&gt; (a java.lang.Object)<br>  at java.lang.Thread.<span class="hljs-built_in">sleep</span>(Thread.java:440)<br>  - locked &lt;0x04fbafa5&gt; (a java.lang.Object)<br>  at java.lang.Thread.<span class="hljs-built_in">sleep</span>(Thread.java:356)<br>  at com.example.demoproject.view.MainActivity.clickToSleep(MainActivity.kt:57)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at androidx.appcompat.app.AppCompatViewInflater<span class="hljs-variable">$DeclaredOnClickListener</span>.onClick(AppCompatViewInflater.java:441)<br>  at android.view.View.performClick(View.java:7259)<br>  at com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1194)<br>  at android.view.View.performClickInternal(View.java:7236)<br>  at android.view.View.access<span class="hljs-variable">$3600</span>(View.java:801)<br>  at android.view.View<span class="hljs-variable">$PerformClick</span>.run(View.java:27896)<br>  at android.os.Handler.handleCallback(Handler.java:883)<br>  at android.os.Handler.dispatchMessage(Handler.java:100)<br>  at android.os.Looper.loop(Looper.java:214)<br>  at android.app.ActivityThread.main(ActivityThread.java:7397)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at com.android.internal.os.RuntimeInit<span class="hljs-variable">$MethodAndArgsCaller</span>.run(RuntimeInit.java:492)<br>  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:935)<br></code></pre></td></tr></table></figure><p>ä»å †æ ˆä¿¡æ¯ä¸­ä¹Ÿå¾ˆå®¹æ˜“å‘ç°ï¼Œåœ¨æ‰§è¡Œåˆ° <code>MainActivity.clickToSleep</code> æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹è¿›è¡Œäº†ç¡çœ ï¼Œæœ€ç»ˆå¯¼è‡´ anrã€‚</p><h3 id="æ¡ˆä¾‹äºŒã€Blocked-anr"><a href="#æ¡ˆä¾‹äºŒã€Blocked-anr" class="headerlink" title="æ¡ˆä¾‹äºŒã€Blocked anr"></a>æ¡ˆä¾‹äºŒã€Blocked anr</h3><p>MainActivity ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : AppCompatActivity() &#123;<br><br>    override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)<br>        setContentView(R.layout.activity_main)<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç‚¹å‡»æŒ‰é’®1 - åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹å¹¶æŒæœ‰å½“å‰ Activity å¯¹è±¡é”ç„¶åå¼€å§‹ç¡çœ  10s</span><br><span class="hljs-comment">     */</span><br>    fun <span class="hljs-title function_">click1</span><span class="hljs-params">(view: View)</span> &#123;<br>        testBlockThread()<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç‚¹å‡»æŒ‰é’®2 - åœ¨ä¸»çº¿ç¨‹ä¸­å°è¯•è·å– Activity å¯¹è±¡é”å¹¶æ‰“å° log</span><br><span class="hljs-comment">     */</span><br>    fun <span class="hljs-title function_">click2</span><span class="hljs-params">(view: View)</span> &#123;<br>        doSomething()<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">testBlockThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">val</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> Thread &#123;<br>            <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) &#123;<br>                Log.i(<span class="hljs-string">&quot;testLog&quot;</span>, <span class="hljs-string">&quot;å¼€å§‹ç¡çœ  10s.. å½“å‰çº¿ç¨‹åç§°=$&#123;Thread.currentThread().name&#125; çº¿ç¨‹id=$&#123;Thread.currentThread().id&#125;&quot;</span>)<br>                Thread.sleep(<span class="hljs-number">10_000</span>)<br>            &#125;<br>        &#125;<br>        thread.name = <span class="hljs-string">&quot;MyTestBlockThread&quot;</span><br>        thread.start()<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>) &#123;<br>            Log.i(<span class="hljs-string">&quot;testLog&quot;</span>, <span class="hljs-string">&quot;doSomething.. å½“å‰çº¿ç¨‹åç§°=$&#123;Thread.currentThread().name&#125; çº¿ç¨‹id=$&#123;Thread.currentThread().id&#125;&quot;</span>)<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å½“é¦–å…ˆç‚¹å‡»æŒ‰é’®1æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹ MyTestBlockThread å¹¶æŒæœ‰å½“å‰ Activity å¯¹è±¡é”ç„¶åå¼€å§‹ç¡çœ  10sï¼Œç„¶åç»§ç»­ç‚¹å‡»æŒ‰é’®2ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹å°†ä¼šå°è¯•è·å– Activity å¯¹è±¡é”å¹¶æ‰§è¡Œï¼Œç”±äºé”æ­£åœ¨è¢«å­çº¿ç¨‹ MyTestBlockThread æŒæœ‰ï¼Œå› æ­¤ï¼Œä¸»çº¿ç¨‹å°†ä¼šä¸€ç›´è¢« block ç›´åˆ°å­çº¿ç¨‹é‡Šæ”¾é”ã€‚</p><p>åœ¨ä¸»çº¿ç¨‹è¢« block æœŸé—´ï¼Œæˆ‘ä»¬å·¦æ»‘æˆ–è€…ç‚¹å‡»è¿”å›é”®é€€å‡º MainActivityï¼ˆç”±äºä¸»çº¿ç¨‹æ­£åœ¨è¢« blockï¼Œæ‰€ä»¥æ­¤æ—¶æ˜¯æ— æ³•é€€å‡ºæˆåŠŸçš„ï¼‰ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç³»ç»Ÿå°†ä¼šå¼¹å‡º ANR å¼¹çª—ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å¯¼å‡º ANR æ—¥å¿—å¹¶æ‰“å¼€ï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/1f89d376cdb446b7a1241b74794f7f22.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¯ä»¥å‘ç°ï¼Œè¿™é‡Œæœ‰ä¸€è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">- waiting to lock &lt;0x02250ad8&gt; (a com.example.demoproject.view.MainActivity) held by thread 18<br></code></pre></td></tr></table></figure><p>å…¶å«ä¹‰å°±æ˜¯ï¼Œä¸»çº¿ç¨‹æ­£åœ¨è¢« blockï¼Œ å…¶æ­£åœ¨ç­‰å¾… çº¿ç¨‹18 é‡Šæ”¾é”ï¼Œæœ€ç»ˆå› æ­¤å¯¼è‡´å‡ºç°äº† ANRã€‚</p><p>é‚£ä¹ˆï¼Œè¿™ä¸ª çº¿ç¨‹18 æ˜¯è°å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹ anr æ—¥å¿—ï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/2b81b3c4963e4167b5d6305e3bdfa5d2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>åœ¨è¿™é‡Œï¼Œå‘ç°è¿™ä¸€è¡Œæ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;MyTestBlockThread&quot;</span> prio=5 tid=18 Sleeping<br></code></pre></td></tr></table></figure><p>å…¶å«ä¹‰å°±æ˜¯ï¼šçº¿ç¨‹ <code>MyTestBlockThread</code> æ­£åœ¨ <code>Sleeping</code>ï¼Œå®ƒçš„ <code>prio=5 tid=18</code>ã€‚</p><h3 id="æ¡ˆä¾‹ä¸‰ã€è€—æ—¶æˆ–æ­»å¾ªç¯æ–¹æ³•"><a href="#æ¡ˆä¾‹ä¸‰ã€è€—æ—¶æˆ–æ­»å¾ªç¯æ–¹æ³•" class="headerlink" title="æ¡ˆä¾‹ä¸‰ã€è€—æ—¶æˆ–æ­»å¾ªç¯æ–¹æ³•"></a>æ¡ˆä¾‹ä¸‰ã€è€—æ—¶æˆ–æ­»å¾ªç¯æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : AppCompatActivity() &#123;<br><br>    override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)<br>        setContentView(R.layout.activity_main)<br>    &#125;<br>    <br>    fun <span class="hljs-title function_">click</span><span class="hljs-params">(view: View)</span> &#123;<br>        doSomething()<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            Log.i(<span class="hljs-string">&quot;testLog&quot;</span>, <span class="hljs-string">&quot;doSomething.. å½“å‰çº¿ç¨‹åç§°=$&#123;Thread.currentThread().name&#125; çº¿ç¨‹id=$&#123;Thread.currentThread().id&#125;&quot;</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œä¼šåœ¨ä¸»çº¿ç¨‹é€šè¿‡ä¸€ä¸ªæ­»å¾ªç¯ä¸æ–­æ‰“å° logï¼Œå› æ­¤ doSomething() æ–¹æ³•æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªè€—æ—¶æ–¹æ³•ï¼Œç‚¹å‡»æŒ‰é’®åï¼Œæˆ‘ä»¬å·¦æ»‘æˆ–è€…ç‚¹å‡»è¿”å›é”®é€€å‡º MainActivityï¼ˆç”±äºä¸»çº¿ç¨‹æ­£åœ¨å¿™ç¢Œä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶æ˜¯æ— æ³•é€€å‡ºæˆåŠŸçš„ï¼‰ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç³»ç»Ÿå°†ä¼šå¼¹å‡º ANR å¼¹çª—ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å¯¼å‡º ANR æ—¥å¿—å¹¶æ‰“å¼€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">----- pid 13231 at 2022-06-17 14:23:41 -----<br>Cmd line: com.example.demoproject<br>...<br><span class="hljs-string">&quot;main&quot;</span> prio=5 tid=1 Runnable<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=0 dsCount=0 flags=0 obj=0x72b20e78 self=0x77fe5a6c00<br>  | sysTid=13231 <span class="hljs-built_in">nice</span>=-10 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x77ffb0eed0<br>  | state=R schedstat=( 31694533124 58819622 723 ) utm=1310 stm=1859 core=5 HZ=100<br>  | stack=0x7fdc2b7000-0x7fdc2b9000 stackSize=8192KB<br>  | held mutexes= <span class="hljs-string">&quot;mutator lock&quot;</span>(shared held)<br>  native: <span class="hljs-comment">#00 pc 00000000004108e8  /apex/com.android.runtime/lib64/libart.so (art::DumpNativeStack(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;, int, BacktraceMap*, char const*, art::ArtMethod*, void*, bool)+140)</span><br>  native: <span class="hljs-comment">#01 pc 00000000004f8040  /apex/com.android.runtime/lib64/libart.so (art::Thread::DumpStack(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt;&gt;&amp;, bool, BacktraceMap*, bool) const+512)</span><br>  native: <span class="hljs-comment">#02 pc 000000000051297c  /apex/com.android.runtime/lib64/libart.so (art::DumpCheckpoint::Run(art::Thread*)+828)</span><br>  native: <span class="hljs-comment">#03 pc 00000000004f8d4c  /apex/com.android.runtime/lib64/libart.so (art::Thread::RunCheckpointFunction()+176)</span><br>  native: <span class="hljs-comment">#04 pc 00000000003713fc  /apex/com.android.runtime/lib64/libart.so (art::(anonymous namespace)::CheckJNI::ReleaseStringCharsInternal(char const*, _JNIEnv*, _jstring*, void const*, bool, bool)+1356)</span><br>  native: <span class="hljs-comment">#05 pc 00000000001507cc  /system/lib64/libandroid_runtime.so (android::android_util_Log_println_native(_JNIEnv*, _jobject*, int, int, _jstring*, _jstring*)+232)</span><br>  at android.util.Log.println_native(Native method)<br>  at android.util.Log.i(Log.java:176)<br>  at com.example.demoproject.view.MainActivity.doSomething(MainActivity.kt:52)<br>  at com.example.demoproject.view.MainActivity.click2(MainActivity.kt:36)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at androidx.appcompat.app.AppCompatViewInflater<span class="hljs-variable">$DeclaredOnClickListener</span>.onClick(AppCompatViewInflater.java:441)<br>  at android.view.View.performClick(View.java:7259)<br>  at com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1194)<br>  at android.view.View.performClickInternal(View.java:7236)<br>  at android.view.View.access<span class="hljs-variable">$3600</span>(View.java:801)<br>  at android.view.View<span class="hljs-variable">$PerformClick</span>.run(View.java:27896)<br>  at android.os.Handler.handleCallback(Handler.java:883)<br>  at android.os.Handler.dispatchMessage(Handler.java:100)<br>  at android.os.Looper.loop(Looper.java:214)<br>  at android.app.ActivityThread.main(ActivityThread.java:7397)<br>  at java.lang.reflect.Method.invoke(Native method)<br>  at com.android.internal.os.RuntimeInit<span class="hljs-variable">$MethodAndArgsCaller</span>.run(RuntimeInit.java:492)<br>  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:935)<br>...<br>----- end 16808 -----<br></code></pre></td></tr></table></figure><p>å‘ç°ä¸»çº¿ç¨‹æ­£å¤„äº <code>Runnable</code> çŠ¶æ€ï¼Œå¹¶ä¸æ˜¯å¤„äºç©ºé—²çŠ¶æ€ï¼Œå †æ ˆä¿¡æ¯ä¸­æœ‰ä¸€è¡Œå…³é”®æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">at com.example.demoproject.view.MainActivity.doSomething(MainActivity.kt:52)<br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹å››ã€æ­£å¸¸æƒ…å†µ"><a href="#æ¡ˆä¾‹å››ã€æ­£å¸¸æƒ…å†µ" class="headerlink" title="æ¡ˆä¾‹å››ã€æ­£å¸¸æƒ…å†µ"></a>æ¡ˆä¾‹å››ã€æ­£å¸¸æƒ…å†µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&quot;main&quot;</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Native<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x72e0ee78</span> self=<span class="hljs-number">0x79aafbcc00</span><br>  | sysTid=<span class="hljs-number">1496</span> nice=-<span class="hljs-number">2</span> cgrp=<span class="hljs-keyword">default</span> sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0x79ac524ed0</span><br>  | state=S schedstat=( <span class="hljs-number">50585681414</span> <span class="hljs-number">30364690662</span> <span class="hljs-number">64096</span> ) utm=<span class="hljs-number">3092</span> stm=<span class="hljs-number">1966</span> core=<span class="hljs-number">2</span> HZ=<span class="hljs-number">100</span><br>  | stack=<span class="hljs-number">0x7fe35ed000</span>-<span class="hljs-number">0x7fe35ef000</span> stackSize=8192KB<br>  | held mutexes=<br>  kernel: (couldn<span class="hljs-string">&#x27;t read /proc/self/task/1496/stack)</span><br><span class="hljs-string">  native: #00 pc 00000000000d0f58  /apex/com.android.runtime/lib64/bionic/libc.so (__epoll_pwait+8)</span><br><span class="hljs-string">  native: #01 pc 00000000000180bc  /system/lib64/libutils.so (android::Looper::pollInner(int)+144)</span><br><span class="hljs-string">  native: #02 pc 0000000000017f8c  /system/lib64/libutils.so (android::Looper::pollOnce(int, int*, int*, void**)+56)</span><br><span class="hljs-string">  native: #03 pc 000000000013b8f4  /system/lib64/libandroid_runtime.so (android::android_os_MessageQueue_nativePollOnce(_JNIEnv*, _jobject*, long, int)+44)</span><br><span class="hljs-string">  at android.os.MessageQueue.nativePollOnce(Native method)</span><br><span class="hljs-string">  at android.os.MessageQueue.next(MessageQueue.java:336)</span><br><span class="hljs-string">  at android.os.Looper.loop(Looper.java:174)</span><br><span class="hljs-string">  at com.android.server.SystemServer.run(SystemServer.java:546)</span><br><span class="hljs-string">  at com.android.server.SystemServer.main(SystemServer.java:354)</span><br><span class="hljs-string">  at java.lang.reflect.Method.invoke(Native method)</span><br><span class="hljs-string">  at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)</span><br><span class="hljs-string">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:913)</span><br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸»çº¿ç¨‹å †æ ˆå°±æ˜¯ä¸€ä¸ªå¾ˆæ­£å¸¸çš„ç©ºé—²å †æ ˆï¼Œè¡¨æ˜ä¸»çº¿ç¨‹æ­£åœ¨ç­‰å¾…æ–°çš„æ¶ˆæ¯ã€‚å¦‚æœANRæ—¥å¿—é‡Œä¸»çº¿ç¨‹æ˜¯è¿™æ ·ä¸€ä¸ªçŠ¶æ€ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ä¸ªåŸå› å¯¼è‡´ anrï¼š</p><ul><li>è¯¥ anr æ˜¯ cpu èµ„æºæŠ¢å æˆ–å†…å­˜ç´§å¼ ç­‰å…¶ä»–å› ç´ å¼•èµ·</li><li>è¿™ä»½ anr æ—¥å¿—æŠ“å–çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹å·²ç»æ¢å¤æ­£å¸¸</li></ul><h3 id="æ¡ˆä¾‹äº”ã€CPUè¢«å…¶ä»–åº”ç”¨æŠ¢å "><a href="#æ¡ˆä¾‹äº”ã€CPUè¢«å…¶ä»–åº”ç”¨æŠ¢å " class="headerlink" title="æ¡ˆä¾‹äº”ã€CPUè¢«å…¶ä»–åº”ç”¨æŠ¢å "></a>æ¡ˆä¾‹äº”ã€CPUè¢«å…¶ä»–åº”ç”¨æŠ¢å </h3><p>å½“ anr æ—¥å¿—ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ä¿¡æ¯ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¾—çœ‹ cpu ä¿¡æ¯äº†ï¼Œ</p><p>è¿™ä¸ªæ—¥å¿—ä¸€èˆ¬åœ¨ <code>bugreport.txt</code> æ–‡ä»¶ä¸­å¯ä»¥æŸ¥çœ‹ï¼Œå…·ä½“æ€ä¹ˆå¯¼å‡º <code>bugreport.txt</code> æ–‡ä»¶å¯è§æœ¬æ–‡çš„ã€Šå¯¼å‡ºå¹¶æŸ¥çœ‹ ANR æ—¥å¿—ã€‹é‚£é‡Œçš„æ­¥éª¤</p><p>å–å‡º cpu ä¿¡æ¯æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">-------------------------------------------------------------------------------<br>DUMP OF SERVICE CRITICAL cpuinfo:<br>Load: <span class="hljs-number">5.28</span> / <span class="hljs-number">5.71</span> / <span class="hljs-number">5.58</span><br>CPU usage from 275243ms to 190078ms <span class="hljs-title function_">ago</span> <span class="hljs-params">(<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">16</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span>:<span class="hljs-number">36.158</span> to <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">16</span> <span class="hljs-number">15</span>:<span class="hljs-number">27</span>:<span class="hljs-number">01.323</span>)</span>:<br>  <span class="hljs-number">51</span>% <span class="hljs-number">695</span>/audioserver: <span class="hljs-number">35</span>% user + <span class="hljs-number">15</span>% kernel / faults: <span class="hljs-number">3071</span> minor<br>  <span class="hljs-number">17</span>% <span class="hljs-number">1496</span>/system_server: <span class="hljs-number">9</span>% user + <span class="hljs-number">8</span>% kernel / faults: <span class="hljs-number">43598</span> minor<br>  <span class="hljs-number">14</span>% <span class="hljs-number">2077</span>/VosRXThread: <span class="hljs-number">0</span>% user + <span class="hljs-number">14</span>% kernel<br>  <span class="hljs-number">3.1</span>% <span class="hljs-number">666</span>/android.hardware.sensors@<span class="hljs-number">1.0</span>-service: <span class="hljs-number">0.8</span>% user + <span class="hljs-number">2.3</span>% kernel / faults: <span class="hljs-number">170</span> minor<br>  <span class="hljs-number">3.1</span>% <span class="hljs-number">642</span>/android.hardware.audio@<span class="hljs-number">2.0</span>-service: <span class="hljs-number">0.2</span>% user + <span class="hljs-number">2.8</span>% kernel / faults: <span class="hljs-number">2</span> minor<br>  ...................................çœç•¥ N è¡Œ...........................................<br><span class="hljs-number">21</span>% TOTAL: <span class="hljs-number">6.4</span>% user + <span class="hljs-number">10</span>% kernel + <span class="hljs-number">0.1</span>% iowait + <span class="hljs-number">2.4</span>% irq + <span class="hljs-number">1.4</span>% softirq<br>--------- <span class="hljs-number">0.</span>007s was the duration of dumpsys cpuinfo, ending at: <span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">16</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">11</span><br>-------------------------------------------------------------------------------<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¥å¿—æ€ä¹ˆåˆ†æå‘¢ï¼Ÿå®ƒçš„è¿™ä¸ªéƒ¨åˆ†çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>1ã€Load: 5.28 &#x2F; 5.71 &#x2F; 5.58 &#x2F;&#x2F; ä»£è¡¨äº†è®¾å¤‡åœ¨ 1ã€5ã€15 åˆ†é’Ÿå†… æ­£åœ¨ä½¿ç”¨å’Œç­‰å¾…ä½¿ç”¨CPU çš„æ´»åŠ¨è¿›ç¨‹çš„å¹³å‡æ•°<br>2ã€CPU usage from 275243ms to 190078ms ago (2022-06-16 15:25:36.158 to 2022-06-16 15:27:01.323) &#x2F;&#x2F; è¡¨æ˜è´Ÿè½½ä¿¡æ¯æŠ“å–æ˜¯åœ¨ 275243ms ~ 190078msä¹‹é—´çš„ï¼Œä¸”æ—¶é—´ç‚¹æ˜¯ä» 2022-06-16 15:25:36.158 å¼€å§‹<br>3ã€ä¸­é—´æ‰“å°ç™¾åˆ†æ¯”çš„éƒ¨åˆ† &#x2F;&#x2F; å„ä¸ªè¿›ç¨‹å ç”¨çš„CPUçš„è¯¦ç»†æƒ…å†µ<br>4ã€æœ€åä¸€è¡Œ &#x2F;&#x2F; å„ä¸ªè¿›ç¨‹åˆè®¡å ç”¨çš„CPUä¿¡æ¯ã€‚</p></blockquote><p>è¿˜æœ‰ä¸€äº›åè¯å’Œå«ä¹‰å¦‚ä¸‹ï¼š</p><blockquote><p>1ã€user: ç”¨æˆ·æ€<br>2ã€kernel: å†…æ ¸æ€<br>3ã€faults: å†…å­˜ç¼ºé¡µï¼Œminor â€”â€” è½»å¾®çš„ï¼Œmajor â€”â€” é‡åº¦ï¼Œéœ€è¦ä»ç£ç›˜æ‹¿æ•°æ®<br>4ã€iowait: IO ç­‰å¾…å æ¯”ï¼Œå¦‚æœå æ¯”å¾ˆé«˜ï¼Œæ„å‘³ç€æœ‰å¾ˆå¤§å¯èƒ½æ˜¯ioè€—æ—¶å¯¼è‡´ANR<br>5ã€irq: ç¡¬ä¸­æ–­ï¼Œ<br>6ã€softirq: è½¯ä¸­æ–­</p></blockquote><p>æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>å¦‚æœ iowait å æ¯”å¾ˆé«˜ï¼Œæ„å‘³ç€æœ‰å¾ˆå¤§å¯èƒ½æ˜¯ io è€—æ—¶å¯¼è‡´çš„ ANRï¼Œå…·ä½“è¿›ä¸€æ­¥æŸ¥çœ‹æœ‰æ²¡æœ‰è¿›ç¨‹ faults major æ¯”è¾ƒå¤š</li><li>å•è¿›ç¨‹ CPU çš„è´Ÿè½½å¹¶ä¸æ˜¯ä»¥100%ä¸ºä¸Šé™ï¼Œè€Œæ˜¯æœ‰å‡ ä¸ªæ ¸å°±æœ‰ç™¾åˆ†ä¹‹å‡ ç™¾ï¼Œå¦‚ 4 æ ¸ï¼Œé‚£ä¹ˆä¸Šé™ä¸º400%</li></ul><p>äº†è§£äº†å¦‚ä½•çœ‹ cpu æ—¥å¿—åï¼Œæˆ‘ä»¬å†å›åˆ°å…·ä½“çš„æ—¥å¿—ä¸­æŸ¥çœ‹ï¼Œ</p><p>å‘ç°å¦‚ä¸Šæ’åœ¨ç¬¬ä¸€ä½çš„è¿›ç¨‹ audioserver å³ä¸ºç³»ç»Ÿä¸­å ç”¨ cpu æœ€é«˜çš„è¿›ç¨‹ï¼Œè¾¾åˆ° 51%ï¼Œè¿™å±äºæ­£å¸¸çš„ cpu å ç”¨èŒƒå›´ï¼Œå› æ­¤ï¼Œæ­¤æ—¥å¿—ä¸­å¹¶æ²¡æœ‰å‘ç°å¯¼è‡´ anr çš„æœ‰æ•ˆæ—¥å¿—ã€‚</p><p>å¦‚æœå‘ç°æ’åœ¨ç¬¬ä¸€ä½çš„è¿›ç¨‹å ç”¨äº†æé«˜çš„ cpu èµ„æºï¼Œé‚£ä¹ˆå°±ææœ‰å¯èƒ½æ˜¯è¿™ä¸ªè¿›ç¨‹å¯¼è‡´çš„ anr ã€‚</p><h3 id="æ¡ˆä¾‹å…­ã€ç³»ç»ŸæœåŠ¡è¶…æ—¶"><a href="#æ¡ˆä¾‹å…­ã€ç³»ç»ŸæœåŠ¡è¶…æ—¶" class="headerlink" title="æ¡ˆä¾‹å…­ã€ç³»ç»ŸæœåŠ¡è¶…æ—¶"></a>æ¡ˆä¾‹å…­ã€ç³»ç»ŸæœåŠ¡è¶…æ—¶</h3><p>å¦‚æœç³»ç»ŸæœåŠ¡è¶…æ—¶ï¼Œæ—¥å¿—ä¸­ä¸€èˆ¬ä¼šåŒ…å« <code>BinderProxy.transactNative</code> å…³é”®å­—ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/08/10/%E3%80%90Android%E3%80%91%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90-ANR-%E6%97%A5%E5%BF%97/7e8b011e4d1b43fe89b4acf97070fcad.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>ä»å †æ ˆå¯ä»¥çœ‹å‡º getActiveNetworkInfo æ–¹æ³•å‘ç”Ÿäº† ANRã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç³»ç»Ÿçš„æœåŠ¡éƒ½æ˜¯ Binder æœºåˆ¶ï¼ŒBinder ä¸€å…±æœ‰16ä¸ªçº¿ç¨‹ï¼ŒæœåŠ¡èƒ½åŠ›ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ç³»ç»ŸæœåŠ¡é•¿æ—¶é—´ä¸å“åº”å¯¼è‡´ANRã€‚</p><p>å¦‚æœå…¶ä»–åº”ç”¨å ç”¨äº† Binder çº¿ç¨‹ï¼Œé‚£ä¹ˆå½“å‰åº”ç”¨åªèƒ½ç­‰å¾…ï¼Œå¯è¿›ä¸€æ­¥æœç´¢ blockUntilThreadAvailable å…³é”®å­—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">at android.os.Binder.blockUntilThreadAvailable(Native method)<br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰å‘ç°æŸä¸ªçº¿ç¨‹çš„å †æ ˆåŒ…å«æ­¤å­—æ ·ï¼Œå¯è¿›ä¸€æ­¥çœ‹å…¶å †æ ˆç¡®å®šå…¶è°ƒç”¨äº†ä»€ä¹ˆç³»ç»ŸæœåŠ¡ã€‚</p><p>æ­¤ç±» ANR å±äºç³»ç»Ÿç¯å¢ƒçš„é—®é¢˜ï¼Œå¦‚æœæŸç±»å‹æœºå™¨ä¸Šé¢‘ç¹å‘ç”Ÿæ­¤é—®é¢˜ï¼Œåº”ç”¨å±‚å¯ä»¥è€ƒè™‘è§„é¿ç­–ç•¥ã€‚</p><h3 id="æ¡ˆä¾‹ä¸ƒã€å†…å­˜ç´§å¼ "><a href="#æ¡ˆä¾‹ä¸ƒã€å†…å­˜ç´§å¼ " class="headerlink" title="æ¡ˆä¾‹ä¸ƒã€å†…å­˜ç´§å¼ "></a>æ¡ˆä¾‹ä¸ƒã€å†…å­˜ç´§å¼ </h3><p>å¦‚æœæ—¥å¿—ä¸­ CPU å’Œå †æ ˆéƒ½æ­£å¸¸ï¼Œä»æ—§å‘ç”Ÿäº† ANRï¼Œé‚£ä¹ˆå¯ä»¥è¿›ä¸€æ­¥è€ƒè™‘æ˜¯å¦æ˜¯å†…å­˜ç´§å¼ å¯¼è‡´çš„ anrã€‚</p><p>åœ¨ <code>bugreport.txt</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡å¦‚ä¸‹å…³é”®å­— <code>am_meminfo</code> æœç´¢æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">06-16 02:14:42.014  1000  1496  1575 I am_meminfo: [1163550720,172752896,7536640,272494592,512559104]<br></code></pre></td></tr></table></figure><p>æ•°ç»„ä¸­çš„äº”ä¸ªå€¼åˆ†åˆ«æŒ‡çš„æ˜¯</p><ul><li>Cached</li><li>Free</li><li>Zram</li><li>Kernel</li><li>Native</li></ul><p>å…¶ä¸­ Cached + Free ä»£è¡¨å½“å‰æ•´ä¸ªæ‰‹æœºçš„ å¯ç”¨å†…å­˜ï¼Œå¦‚æœå€¼å¾ˆå°ï¼Œé‚£å°±æ„å‘³ç€å¤„äºå†…å­˜ç´§å¼ çŠ¶æ€ã€‚</p><p>ä¸€èˆ¬ä½å†…å­˜çš„åˆ¤å®šé˜ˆå€¼ä¸ºï¼š4G å†…å­˜æ‰‹æœºä»¥ä¸‹é˜€å€¼ï¼š350MBï¼Œä»¥ä¸Šé˜€å€¼åˆ™ä¸ºï¼š450MB</p><p>å¦å¤–ï¼Œå¦‚æœé€šè¿‡å…³é”®å­— am_meminfo æœç´¢ä¸å‡ºä»»ä½•æ—¥å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ onTrimMemory æœç´¢ï¼Œå¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">10-31 22:37:33.458 20733 20733 E Runtime : onTrimMemory level:80,pid:com.xxx.xxx:Launcher0<br></code></pre></td></tr></table></figure><p>å®ƒä¹Ÿå¯ä»¥ä½œä¸ºå†…å­˜ç´§å¼ çš„ä¸€ä¸ªå‚è€ƒåˆ¤æ–­ï¼Œå¯è§ï¼Œè¿™é‡Œçš„ <code>level ä¸º 80</code> ï¼Œæˆ‘ä»¬çœ‹çœ‹ Android ä¸­æ˜¯æ€ä¹ˆå®šä¹‰è¿™ä¸ª level çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹æ¥è¿‘åå° LRU åˆ—è¡¨çš„æœ«å°¾ï¼Œå¦‚æœæ²¡æœ‰å¾ˆå¿«æ‰¾åˆ°æ›´å¤šå†…å­˜ï¼Œè¿›ç¨‹å°†è¢«æ€æ­»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_COMPLETE</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹åœ¨åå° LRU åˆ—è¡¨çš„ä¸­é—´ï¼›é‡Šæ”¾å†…å­˜å¯ä»¥å¸®åŠ©ç³»ç»Ÿä¿æŒåˆ—è¡¨ä¸­ç¨åè¿è¡Œçš„å…¶ä»–è¿›ç¨‹ï¼Œä»¥è·å¾—æ›´å¥½çš„æ•´ä½“æ€§èƒ½</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_MODERATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹å·²è¿›å…¥ LRU åˆ—è¡¨ã€‚è¿™æ˜¯ä¸€ä¸ªæ¸…ç†èµ„æºçš„å¥½æœºä¼šï¼Œå¦‚æœç”¨æˆ·è¿”å›åº”ç”¨ç¨‹åºï¼Œè¿™äº›èµ„æºå¯ä»¥é«˜æ•ˆå¿«é€Ÿåœ°é‡æ–°æ„å»º</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_BACKGROUND</span> <span class="hljs-operator">=</span> <span class="hljs-number">40</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹å·²æ˜¾ç¤ºç”¨æˆ·ç•Œé¢ï¼Œç°åœ¨ä¸å†æ˜¾ç¤ºã€‚æ­¤æ—¶åº”é‡Šæ”¾ UI çš„å¤§é‡åˆ†é…ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å†…å­˜</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_UI_HIDDEN</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¯¥è¿›ç¨‹ä¸æ˜¯å¯æ¶ˆè€—çš„åå°è¿›ç¨‹ï¼Œä½†è®¾å¤‡è¿è¡Œçš„å†…å­˜æä½ï¼Œå³å°†æ— æ³•ä¿æŒä»»ä½•åå°è¿›ç¨‹è¿è¡Œã€‚æ‚¨æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åº”å°½å¯èƒ½å¤šåœ°é‡Šæ”¾éå…³é”®èµ„æºï¼Œä»¥å…è®¸è¯¥å†…å­˜åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚åœ¨æ­¤ä¹‹åå°†å‘ç”Ÿçš„ä¸‹ä¸€ä»¶äº‹æ˜¯è°ƒç”¨ onLowMemory() ä»¥æŠ¥å‘Šåœ¨åå°æ ¹æœ¬æ— æ³•ä¿ç•™ä»»ä½•å†…å®¹ï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå¼€å§‹æ˜¾ç€å½±å“ç”¨æˆ·</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_RUNNING_CRITICAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹ä¸æ˜¯å¯æ¶ˆè€—çš„åå°è¿›ç¨‹ï¼Œä½†è®¾å¤‡å†…å­˜ä¸è¶³ã€‚æ‚¨æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åº”è¯¥é‡Šæ”¾ä¸éœ€è¦çš„èµ„æºï¼Œä»¥å…è®¸åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨è¯¥å†…å­˜</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_RUNNING_LOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿›ç¨‹ä¸æ˜¯å¯æ¶ˆè€—çš„åå°è¿›ç¨‹ï¼Œä½†è®¾å¤‡è¿è¡Œçš„å†…å­˜é€‚ä¸­ã€‚æ‚¨æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å¯èƒ½å¸Œæœ›é‡Šæ”¾ä¸€äº›ä¸éœ€è¦çš„èµ„æºä»¥ä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRIM_MEMORY_RUNNING_MODERATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“Watchdogæœºåˆ¶ä»¥åŠé—®é¢˜åˆ†æ</title>
    <link href="/2023/08/10/%E5%AE%89%E5%8D%93Watchdog%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <url>/2023/08/10/%E5%AE%89%E5%8D%93Watchdog%E6%9C%BA%E5%88%B6%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“Watchdogæœºåˆ¶ä»¥åŠé—®é¢˜åˆ†æ"><a href="#å®‰å“Watchdogæœºåˆ¶ä»¥åŠé—®é¢˜åˆ†æ" class="headerlink" title="å®‰å“Watchdogæœºåˆ¶ä»¥åŠé—®é¢˜åˆ†æ"></a>å®‰å“Watchdogæœºåˆ¶ä»¥åŠé—®é¢˜åˆ†æ</h1><p><strong>è½¬è½½é“¾æ¥ï¼š<a href="http://duanqz.github.io/2015-10-12-Watchdog-Analysis#section-1">http://duanqz.github.io/2015-10-12-Watchdog-Analysis#section-1</a></strong></p><h2 id="1-æ¦‚è§ˆ"><a href="#1-æ¦‚è§ˆ" class="headerlink" title="1.æ¦‚è§ˆ"></a>1.æ¦‚è§ˆ</h2><p><code>Watchdog</code>çš„ä¸­æ–‡çš„â€œçœ‹é—¨ç‹—â€ï¼Œæœ‰ä¿æŠ¤çš„æ„æ€ã€‚æœ€æ—©å¼•å…¥Watchdogæ˜¯åœ¨å•ç‰‡æœºç³»ç»Ÿä¸­ï¼Œç”±äºå•ç‰‡æœºçš„å·¥ä½œç¯å¢ƒå®¹æ˜“å—åˆ°å¤–ç•Œç£åœºçš„å¹²æ‰°ï¼Œå¯¼è‡´ç¨‹åºâ€œè·‘é£â€ï¼Œé€ æˆæ•´ä¸ªç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼Œå› æ­¤ï¼Œå¼•å…¥äº†ä¸€ä¸ªâ€œçœ‹é—¨ç‹—â€ï¼Œå¯¹å•ç‰‡æœºçš„è¿è¡ŒçŠ¶æ€è¿›è¡Œå®æ—¶ç›‘æµ‹ï¼Œé’ˆå¯¹è¿è¡Œæ•…éšœåšä¸€äº›ä¿æŠ¤å¤„ç†ï¼Œè­¬å¦‚è®©ç³»ç»Ÿé‡å¯ã€‚è¿™ç§Watchdogå±äºç¡¬ä»¶å±‚é¢ï¼Œå¿…é¡»æœ‰ç¡¬ä»¶ç”µè·¯çš„æ”¯æŒã€‚</p><p>Linuxä¹Ÿå¼•å…¥äº†Watchdogï¼Œåœ¨Linuxå†…æ ¸ä¸‹ï¼Œå½“Watchdogå¯åŠ¨åï¼Œä¾¿è®¾å®šäº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰å¯¹&#x2F;dev&#x2F;Watchdogè¿›è¡Œå†™æ“ä½œï¼Œåˆ™ä¼šå¯¼è‡´ç³»ç»Ÿé‡å¯ã€‚é€šè¿‡å®šæ—¶å™¨å®ç°çš„Watchdogå±äºè½¯ä»¶å±‚é¢ã€‚</p><p>Androidè®¾è®¡äº†ä¸€ä¸ªè½¯ä»¶å±‚é¢Watchdogï¼Œç”¨äºä¿æŠ¤ä¸€äº›é‡è¦çš„ç³»ç»ŸæœåŠ¡ï¼Œå½“å‡ºç°æ•…éšœæ—¶ï¼Œé€šå¸¸ä¼šè®©Androidç³»ç»Ÿé‡å¯ã€‚ç”±äºè¿™ç§æœºåˆ¶çš„å­˜åœ¨ï¼Œå°±ç»å¸¸ä¼šå‡ºç°ä¸€äº›system_serverè¿›ç¨‹è¢«Watchdogæ€æ‰è€Œå‘ç”Ÿæ‰‹æœºé‡å¯çš„é—®é¢˜ã€‚</p><p>æœ¬æ–‡æœŸæœ›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</p><blockquote><ol><li>Watchdogæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿè¿™æ¶‰åŠåˆ°Watchdogçš„å·¥ä½œæœºåˆ¶ã€‚</li><li>é‡åˆ°Watchdogçš„é—®é¢˜è¯¥æ€ä¹ˆåŠï¼Ÿè¿™æ¶‰åŠåˆ°åˆ†æWatchdogé—®é¢˜çš„æƒ¯ç”¨æ–¹æ³•ã€‚</li></ol></blockquote><h2 id="2-Watchdogæœºåˆ¶"><a href="#2-Watchdogæœºåˆ¶" class="headerlink" title="2.Watchdogæœºåˆ¶"></a>2.Watchdogæœºåˆ¶</h2><p>æˆ‘ä»¬ä»¥<a href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/Watchdog.java">frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;Watchdog.java</a>ä¸ºè“æœ¬ï¼Œåˆ†æWatchdogçš„å®ç°é€»è¾‘ã€‚ä¸ºäº†æè¿°æ–¹ä¾¿ï¼ŒActivityManagerServiceï¼Œ PackageManagerServiceï¼Œ WindowManagerServiceä¼šåˆ†åˆ«ç®€ç§°ä¸ºAMS, PKMS, WMSã€‚</p><h3 id="2-1-Watchdogçš„åˆå§‹åŒ–"><a href="#2-1-Watchdogçš„åˆå§‹åŒ–" class="headerlink" title="2.1 Watchdogçš„åˆå§‹åŒ–"></a>2.1 Watchdogçš„åˆå§‹åŒ–</h3><p>Androidçš„Watchdogæ˜¯ä¸€ä¸ªå•ä¾‹çº¿ç¨‹ï¼Œåœ¨System Serveræ—¶å°±ä¼šåˆå§‹åŒ–Watchdogã€‚Watchdogåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šæ„å»ºå¾ˆå¤š<strong>HandlerChecker</strong>ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>Monitor Checker</strong>ï¼Œç”¨äºæ£€æŸ¥æ˜¯Monitorå¯¹è±¡å¯èƒ½å‘ç”Ÿçš„æ­»é”, AMS, PKMS, WMSç­‰æ ¸å¿ƒçš„ç³»ç»ŸæœåŠ¡éƒ½æ˜¯Monitorå¯¹è±¡ã€‚</li><li><strong>Looper Checker</strong>ï¼Œç”¨äºæ£€æŸ¥çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦é•¿æ—¶é—´å¤„äºå·¥ä½œçŠ¶æ€ã€‚Watchdogè‡ªèº«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒUi, Io, Displayè¿™äº›å…¨å±€çš„æ¶ˆæ¯é˜Ÿåˆ—éƒ½æ˜¯è¢«æ£€æŸ¥çš„å¯¹è±¡ã€‚æ­¤å¤–ï¼Œä¸€äº›é‡è¦çš„çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿä¼šåŠ å…¥åˆ°<strong>Looper Checker</strong>ä¸­ï¼Œè­¬å¦‚AMS, PKMSï¼Œè¿™äº›æ˜¯åœ¨å¯¹åº”çš„å¯¹è±¡åˆå§‹åŒ–æ—¶åŠ å…¥çš„ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">Watchdog</span><span class="hljs-params">()</span> &#123;<br>    ....<br>    mMonitorChecker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(FgThread.getHandler(),<br>                <span class="hljs-string">&quot;foreground thread&quot;</span>, DEFAULT_TIMEOUT);<br>    mHandlerCheckers.add(mMonitorChecker);<br>    mHandlerCheckers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper()),<br>                <span class="hljs-string">&quot;main thread&quot;</span>, DEFAULT_TIMEOUT));<br>    mHandlerCheckers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(UiThread.getHandler(),<br>                <span class="hljs-string">&quot;ui thread&quot;</span>, DEFAULT_TIMEOUT));<br>    mHandlerCheckers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(IoThread.getHandler(),<br>                <span class="hljs-string">&quot;i/o thread&quot;</span>, DEFAULT_TIMEOUT));<br>    mHandlerCheckers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(DisplayThread.getHandler(),<br>                <span class="hljs-string">&quot;display thread&quot;</span>, DEFAULT_TIMEOUT));<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸¤ç±»<strong>HandlerChecker</strong>çš„ä¾§é‡ç‚¹ä¸åŒï¼Œ<strong>Monitor Checker</strong>é¢„è­¦æˆ‘ä»¬ä¸èƒ½é•¿æ—¶é—´æŒæœ‰æ ¸å¿ƒç³»ç»ŸæœåŠ¡çš„å¯¹è±¡é”ï¼Œå¦åˆ™ä¼šé˜»å¡å¾ˆå¤šå‡½æ•°çš„è¿è¡Œ; <strong>Looper Checker</strong>é¢„è­¦æˆ‘ä»¬ä¸èƒ½é•¿æ—¶é—´çš„éœ¸å æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦åˆ™å…¶ä»–æ¶ˆæ¯å°†å¾—ä¸åˆ°å¤„ç†ã€‚è¿™ä¸¤ç±»éƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå¡ä½(System Not Responding)ã€‚</p><h3 id="2-2-æ·»åŠ Watchdogæ£€æµ‹å¯¹è±¡"><a href="#2-2-æ·»åŠ Watchdogæ£€æµ‹å¯¹è±¡" class="headerlink" title="2.2 æ·»åŠ Watchdogæ£€æµ‹å¯¹è±¡"></a>2.2 æ·»åŠ Watchdogæ£€æµ‹å¯¹è±¡</h3><p>Watchdogåˆå§‹åŒ–ä»¥åï¼Œå°±å¯ä»¥ä½œä¸ºsystem_serverè¿›ç¨‹ä¸­çš„ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹è¿è¡Œäº†ã€‚ä½†è¿™ä¸ªæ—¶å€™ï¼Œè¿˜ä¸èƒ½è§¦å‘Watchdogçš„è¿è¡Œï¼Œå› ä¸ºAMS, PKMSç­‰ç³»ç»ŸæœåŠ¡è¿˜æ²¡æœ‰åŠ å…¥åˆ°Watchdogçš„ç›‘æµ‹é›†ã€‚ æ‰€è°“ç›‘æµ‹é›†ï¼Œå°±æ˜¯éœ€è¦Watchdogå…³æ³¨çš„å¯¹è±¡ï¼ŒAndroidä¸­æœ‰æˆåƒä¸Šä¸‡çš„æ¶ˆæ¯é˜Ÿåˆ—åœ¨åŒæ—¶è¿è¡Œï¼Œç„¶è€Œï¼ŒWatchdogæ¯•ç«Ÿæ˜¯ç³»ç»Ÿå±‚é¢çš„ä¸œè¥¿ï¼Œå®ƒåªä¼šå…³æ³¨ä¸€äº›æ ¸å¿ƒçš„ç³»ç»ŸæœåŠ¡ã€‚</p><p>Watchdogæä¾›ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºæ·»åŠ <strong>Monitor Checker</strong>å¯¹è±¡å’Œ<strong>Looper Checker</strong>å¯¹è±¡:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMonitor</span><span class="hljs-params">(Monitor monitor)</span> &#123;<br>    <span class="hljs-comment">// å°†monitorå¯¹è±¡æ·»åŠ åˆ°Monitor Checkerä¸­ï¼Œ</span><br>    <span class="hljs-comment">// åœ¨Watchdogåˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥çœ‹åˆ°Monitor Checkeræœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªHandlerCheckerå¯¹è±¡</span><br>    mMonitors.add(monitor);<br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addThread</span><span class="hljs-params">(Handler thread, <span class="hljs-type">long</span> timeoutMillis)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (isAlive()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Threads can&#x27;t be added once the Watchdog is running&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> thread.getLooper().getThread().getName();<br>        <span class="hljs-comment">// ä¸ºHandleræ„å»ºä¸€ä¸ªHandlerCheckerå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯**Looper Checker**</span><br>        mHandlerCheckers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(thread, name, timeoutMillis));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¢«Watchdogç›‘æµ‹çš„å¯¹è±¡ï¼Œéƒ½éœ€è¦å°†è‡ªå·±æ·»åŠ åˆ°Watchdogçš„ç›‘æµ‹é›†ä¸­ã€‚ä»¥ä¸‹æ˜¯AMSçš„ç±»å®šä¹‰å’Œæ„é€ å™¨çš„ä»£ç ç‰‡æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActivityManagerNative</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ActivityManagerService</span><span class="hljs-params">(Context systemContext)</span> &#123;<br>        ...<br>        Watchdog.getInstance().addMonitor(<span class="hljs-built_in">this</span>);<br>        Watchdog.getInstance().addThread(mHandler);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123; &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>AMSå®ç°äº†Watchdog.Monitoræ¥å£ï¼Œè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯monitor()ï¼Œå®ƒçš„ä½œç”¨åæ–‡ä¼šå†è§£é‡Šã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨AMSçš„æ„é€ å™¨ä¸­ï¼Œå°†è‡ªå·±æ·»åŠ åˆ°Monitor Checkerå¯¹è±¡ä¸­ï¼Œç„¶åå°†è‡ªå·±çš„handleræ·»åŠ åˆ°Looper Checkerå¯¹è±¡ä¸­ã€‚ å…¶ä»–é‡è¦çš„ç³»ç»ŸæœåŠ¡æ·»åŠ åˆ°Watchdogçš„ä»£ç é€»è¾‘éƒ½ä¸AMSå·®ä¸å¤šã€‚</p><p>æ•´ä¸ªAndroidç³»ç»Ÿä¸­ï¼Œè¢«monitorçš„å¯¹è±¡å¹¶ä¸å¤šï¼Œåä¸ªæ‰‹æŒ‡å¤´å°±èƒ½æ•°å‡ºæ¥Watchdog.Monitorçš„å®ç°ç±»çš„ä¸ªæ•°ã€‚</p><h3 id="2-3-Watchdogçš„ç›‘æµ‹æœºåˆ¶"><a href="#2-3-Watchdogçš„ç›‘æµ‹æœºåˆ¶" class="headerlink" title="2.3 Watchdogçš„ç›‘æµ‹æœºåˆ¶"></a>2.3 Watchdogçš„ç›‘æµ‹æœºåˆ¶</h3><p>Watchdogæœ¬èº«æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒçš„run()æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">waitedHalf</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        ...<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            ...<br>            <span class="hljs-comment">// 1. è°ƒåº¦æ‰€æœ‰çš„HandlerChecker</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;mHandlerCheckers.size(); i++) &#123;<br>                <span class="hljs-type">HandlerChecker</span> <span class="hljs-variable">hc</span> <span class="hljs-operator">=</span> mHandlerCheckers.get(i);<br>                hc.scheduleCheckLocked();<br>            &#125;<br>            ...<br>            <span class="hljs-comment">// 2. å¼€å§‹å®šæœŸæ£€æŸ¥</span><br>            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> SystemClock.uptimeMillis();<br>            <span class="hljs-keyword">while</span> (timeout &gt; <span class="hljs-number">0</span>) &#123;<br>                ...<br>                <span class="hljs-keyword">try</span> &#123;<br>                    wait(timeout);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    Log.wtf(TAG, e);<br>                &#125;<br>                ...<br>                timeout = CHECK_INTERVAL - (SystemClock.uptimeMillis() - start);<br>            &#125;<br> <br>            <span class="hljs-comment">// 3. æ£€æŸ¥HandlerCheckerçš„å®ŒæˆçŠ¶æ€</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">waitState</span> <span class="hljs-operator">=</span> evaluateCheckerCompletionLocked();<br>            <span class="hljs-keyword">if</span> (waitState == COMPLETED) &#123;<br>                ...<br>                <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (waitState == WAITING) &#123;<br>                ...<br>                <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (waitState == WAITED_HALF) &#123;<br>                ...<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br> <br>            <span class="hljs-comment">// 4. å­˜åœ¨è¶…æ—¶çš„HandlerChecker</span><br>            blockedCheckers = getBlockedCheckersLocked();<br>            subject = describeCheckersLocked(blockedCheckers);<br>            allowRestart = mAllowRestart;<br>        &#125;<br>        ...<br>        <span class="hljs-comment">// 5. ä¿å­˜æ—¥å¿—ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ€æ‰ç³»ç»Ÿè¿›ç¨‹</span><br>        Slog.w(TAG, <span class="hljs-string">&quot;*** GOODBYE!&quot;</span>);<br>        Process.killProcess(Process.myPid());<br>        System.exit(<span class="hljs-number">10</span>);<br>    &#125; <span class="hljs-comment">// end of while (true)</span><br> <br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç ç‰‡æ®µä¸»è¦çš„è¿è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>Watchdogè¿è¡Œåï¼Œä¾¿å¼€å§‹æ— é™å¾ªç¯ï¼Œä¾æ¬¡è°ƒç”¨æ¯ä¸€ä¸ªHandlerCheckerçš„scheduleCheckLocked()æ–¹æ³•</li><li>è°ƒåº¦å®ŒHandlerCheckerä¹‹åï¼Œä¾¿å¼€å§‹å®šæœŸæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼Œæ¯ä¸€æ¬¡æ£€æŸ¥çš„é—´éš”æ—¶é—´ç”±<strong>CHECK_INTERVAL</strong>å¸¸é‡è®¾å®šï¼Œä¸º30ç§’</li><li>æ¯ä¸€æ¬¡æ£€æŸ¥éƒ½ä¼šè°ƒç”¨evaluateCheckerCompletionLocked()æ–¹æ³•æ¥è¯„ä¼°ä¸€ä¸‹HandlerCheckerçš„å®ŒæˆçŠ¶æ€ï¼š<ul><li>COMPLETEDè¡¨ç¤ºå·²ç»å®Œæˆ</li><li>WAITINGå’ŒWAITED_HALFè¡¨ç¤ºè¿˜åœ¨ç­‰å¾…ï¼Œä½†æœªè¶…æ—¶</li><li>OVERDUEè¡¨ç¤ºå·²ç»è¶…æ—¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œtimeoutæ˜¯1åˆ†é’Ÿï¼Œä½†ç›‘æµ‹å¯¹è±¡å¯ä»¥é€šè¿‡ä¼ å‚è‡ªè¡Œè®¾å®šï¼Œè­¬å¦‚PKMSçš„<strong>Handler Checker</strong>çš„è¶…æ—¶æ˜¯10åˆ†é’Ÿ</li></ul></li><li>å¦‚æœè¶…æ—¶æ—¶é—´åˆ°äº†ï¼Œè¿˜æœ‰HandlerCheckerå¤„äºæœªå®Œæˆçš„çŠ¶æ€(OVERDUE)ï¼Œåˆ™é€šè¿‡getBlockedCheckersLocked()æ–¹æ³•ï¼Œè·å–é˜»å¡çš„HandlerCheckerï¼Œç”Ÿæˆä¸€äº›æè¿°ä¿¡æ¯</li><li>ä¿å­˜æ—¥å¿—ï¼ŒåŒ…æ‹¬ä¸€äº›è¿è¡Œæ—¶çš„å †æ ˆä¿¡æ¯ï¼Œè¿™äº›æ—¥å¿—æ˜¯æˆ‘ä»¬è§£å†³Watchdogé—®é¢˜çš„é‡è¦ä¾æ®ã€‚å¦‚æœåˆ¤æ–­éœ€è¦æ€æ‰system_serverè¿›ç¨‹ï¼Œåˆ™ç»™å½“å‰è¿›ç¨‹(system_server)å‘é€signal 9</li></ol><p>åªè¦Watchdogæ²¡æœ‰å‘ç°è¶…æ—¶çš„ä»»åŠ¡ï¼ŒHandlerCheckerå°±ä¼šè¢«ä¸åœçš„è°ƒåº¦ï¼Œé‚£HandlerCheckerå…·ä½“åšä¸€äº›ä»€ä¹ˆæ£€æŸ¥å‘¢ï¼Ÿ ç›´æ¥ä¸Šä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerChecker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleCheckLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Looper Checkerä¸­æ˜¯ä¸åŒ…å«monitorå¯¹è±¡çš„ï¼Œåˆ¤æ–­æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¤„äºç©ºé—²</span><br>        <span class="hljs-keyword">if</span> (mMonitors.size() == <span class="hljs-number">0</span> &amp;&amp; mHandler.getLooper().isIdling()) &#123;<br>            mCompleted = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        ...<br>        <span class="hljs-comment">// å°†Monitor Checkerçš„å¯¹è±¡ç½®äºæ¶ˆæ¯é˜Ÿåˆ—ä¹‹å‰ï¼Œä¼˜å…ˆè¿è¡Œ</span><br>        mHandler.postAtFrontOfQueue(<span class="hljs-built_in">this</span>);<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// ä¾æ¬¡è°ƒç”¨Monitorå¯¹è±¡çš„monitor()æ–¹æ³•</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ; i &lt; size ; i++) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Watchdog.<span class="hljs-built_in">this</span>) &#123;<br>                mCurrentMonitor = mMonitors.get(i);<br>            &#125;<br>            mCurrentMonitor.monitor();<br>        &#125;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å¯¹äº<strong>Looper Checker</strong>è€Œè¨€ï¼Œä¼šåˆ¤æ–­çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ã€‚ å¦‚æœè¢«ç›‘æµ‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸€ç›´é—²ä¸ä¸‹æ¥ï¼Œåˆ™è¯´æ˜å¯èƒ½å·²ç»é˜»å¡ç­‰å¾…äº†å¾ˆé•¿æ—¶é—´</li><li>å¯¹äº<strong>Monitor Checker</strong>è€Œè¨€ï¼Œä¼šè°ƒç”¨å®ç°ç±»çš„monitoræ–¹æ³•ï¼Œè­¬å¦‚ä¸Šæ–‡ä¸­æåˆ°çš„AMS.monitor()æ–¹æ³•ï¼Œ æ–¹æ³•å®ç°ä¸€èˆ¬å¾ˆç®€å•ï¼Œå°±æ˜¯è·å–å½“å‰ç±»çš„å¯¹è±¡é”ï¼Œå¦‚æœå½“å‰å¯¹è±¡é”å·²ç»è¢«æŒæœ‰ï¼Œåˆ™monitor()ä¼šä¸€ç›´å¤„äºwaitçŠ¶æ€ï¼Œç›´åˆ°è¶…æ—¶ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆå¯èƒ½æ˜¯çº¿ç¨‹å‘ç”Ÿäº†æ­»é”</li></ul><p><strong>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»åˆ†æäº†Watchdogçš„å·¥ä½œæœºåˆ¶ï¼Œå›ç­”äº†æˆ‘ä»¬æå‡ºçš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</strong></p><p><strong>Watchdogå®šæ—¶æ£€æŸ¥ä¸€äº›é‡è¦çš„ç³»ç»ŸæœåŠ¡ï¼Œä¸¾æŠ¥é•¿æ—¶é—´é˜»å¡çš„äº‹ä»¶ï¼Œç”šè‡³æ€æ‰system_serverè¿›ç¨‹ï¼Œè®©Androidç³»ç»Ÿé‡å¯ã€‚</strong></p><h2 id="3-é—®é¢˜åˆ†ææ–¹æ³•"><a href="#3-é—®é¢˜åˆ†ææ–¹æ³•" class="headerlink" title="3.é—®é¢˜åˆ†ææ–¹æ³•"></a>3.é—®é¢˜åˆ†ææ–¹æ³•</h2><h3 id="3-1-æ—¥å¿—è·å–"><a href="#3-1-æ—¥å¿—è·å–" class="headerlink" title="3.1 æ—¥å¿—è·å–"></a>3.1 æ—¥å¿—è·å–</h3><p>Andriodçš„æ—¥å¿—é—¨ç±»ç¹å¤šï¼Œè€Œä¸”ï¼Œä¸ºäº†è°ƒè¯•çš„éœ€è¦ï¼Œè®¾å¤‡å‚å•†å’Œåº”ç”¨å¼€å‘è€…éƒ½ä¼šåœ¨AOSPçš„åŸºç¡€ä¸Šå¢åŠ å¾ˆå¤šæ—¥å¿—ã€‚ é¢å¯¹å¦‚æ­¤åºå¤§å¤æ‚çš„æ—¥å¿—ç³»ç»Ÿï¼Œé€šå¸¸åªæœ‰å¯¹åº”é¢†åŸŸçš„ä¸“å®¶æ‰èƒ½çœ‹æ‡‚å…¶é€éœ²çš„ç»†èŠ‚ä¿¡æ¯ï¼Œå°±åƒå»åŒ»é™¢å°±è¯Šï¼ŒåŒ»ç”Ÿä¸€çœ‹æ£€æŸ¥æŠ¥å‘Šå°±çŸ¥é“æ‚£è€…èº«ä½“å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œè€Œå¤–è¡Œå¯¹è¿™äº›è¯Šæ–­ä¿¡æ¯å¾€å¾€æ˜¯æŸæ‰‹æ— ç­–çš„ã€‚</p><p>è§£å†³Watchdogç›¸å…³çš„é—®é¢˜ï¼Œå¯¹æ—¥å¿—çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œæœ‰äº›é—®é¢˜ä¸å½“æ—¶çš„ç³»ç»Ÿç¯å¢ƒç›¸å…³ï¼Œä»…ä»…å‡­å€Ÿå•ä¸€çš„æ—¥å¿—å¹¶ä¸èƒ½å®šä½é—®é¢˜ã€‚ ä»¥ä¸‹ç½—åˆ—å‡ºè·å–Androidæ—¥å¿—çš„ä¸€äº›é‡è¦æ‰‹æ®µï¼Œéƒ¨åˆ†åœºæ™¯ä¸‹ï¼ŒWatchdogç›¸å…³çš„é—®é¢˜ç”šè‡³éœ€è¦ä»¥ä¸‹æ‰€æœ‰çš„æ—¥å¿—ï¼š</p><ul><li><strong>logcat</strong> é€šè¿‡<code>adb logcat</code>å‘½ä»¤è¾“å‡ºAndroidçš„ä¸€äº›å½“å‰è¿è¡Œæ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡logcatçš„ <strong>-b</strong> å‚æ•°æŒ‡å®šè¦è¾“å‡ºçš„æ—¥å¿—ç¼“å†²åŒºï¼Œç¼“å†²åŒºå¯¹åº”ç€logcatçš„ä¸€ç§æ—¥å¿—ç±»å‹ã€‚ é«˜ç‰ˆæœ¬çš„logcatå¯ä»¥ä½¿ç”¨ <strong>-b all</strong> è·å–åˆ°æ‰€æœ‰ç¼“å†²åŒºçš„æ—¥å¿—<ul><li>event é€šè¿‡android.util.EventLogå·¥å…·ç±»æ‰“å°çš„æ—¥å¿—ï¼Œä¸€äº›é‡è¦çš„ç³»ç»Ÿäº‹ä»¶ä¼šä½¿ç”¨æ­¤ç±»æ—¥å¿—</li><li>main é€šè¿‡android.util.Logå·¥å…·ç±»æ‰“å°çš„æ—¥å¿—ï¼Œåº”ç”¨ç¨‹åºï¼Œå°¤å…¶æ˜¯åŸºäºSDKçš„åº”ç”¨ç¨‹åºï¼Œä¼šä½¿ç”¨æ­¤ç±»æ—¥å¿—</li><li>system é€šè¿‡android.util.Slogå·¥å…·ç±»æ‰“å°çš„æ—¥å¿—ï¼Œç³»ç»Ÿç›¸å…³çš„æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨æ­¤ç±»æ—¥å¿—ï¼Œè­¬å¦‚SystemServer</li><li>radio é€šè¿‡android.util.Rlogå·¥å…·ç±»æ‰“å°çš„æ—¥å¿—ï¼Œé€šä¿¡æ¨¡å—ç›¸å…³çš„æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨æ­¤ç±»æ—¥å¿—ï¼Œè­¬å¦‚RIL</li></ul></li><li><strong>dumpsys</strong> é€šè¿‡<code>adb dumpsys</code>å‘½ä»¤è¾“å‡ºä¸€äº›é‡è¦çš„ç³»ç»ŸæœåŠ¡ä¿¡æ¯ï¼Œè­¬å¦‚å†…å­˜ã€ç”µæºã€ç£ç›˜ç­‰ï¼Œ å·¥ä½œåŸç†å¯ä»¥æŸ¥é˜…<a href="http://duanqz.github.io/2015-07-19-Intro-to-dumpsys">dumpsysä»‹ç»</a>ä¸€æ–‡</li><li><strong>traces</strong> è¯¥æ–‡ä»¶è®°å½•äº†ä¸€ä¸ªæ—¶é—´æ®µçš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œé€šå¸¸åœ¨åº”ç”¨å‘ç”ŸANR(Application Not Responding)æ—¶ï¼Œä¼šè§¦å‘æ‰“å°å„è¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆã€‚ ç«™åœ¨Linuxçš„è§’åº¦ï¼Œå…¶å®å°±æ˜¯å‘è¿›ç¨‹å‘é€SIGNAL_QUIT(3)è¯·æ±‚ï¼Œè­¬å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>adb shell kill -3 &lt;pid&gt;</code>å‘½ä»¤ï¼Œæ‰“å°æŒ‡å®šè¿›ç¨‹çš„çš„traceã€‚ SIGNAL_QUIT(3)è¡¨é¢æ„æ€æœ‰ä¸€ç‚¹è¯¯å¯¼ï¼Œå®ƒå…¶å®å¹¶ä¸ä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºã€‚è¾“å‡ºä¸€èˆ¬åœ¨ <em>&#x2F;data&#x2F;anr&#x2F;traces.txt</em> æ–‡ä»¶ä¸­ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯å¯ä»¥çµæ´»é…ç½®çš„ï¼Œ Androidæä¾›çš„ç³»ç»Ÿå±æ€§dalvik.vm.stack-trace-fileå¯ä»¥ç”¨æ¥é…ç½®ç”Ÿæˆtracesæ–‡ä»¶çš„ä½ç½®ã€‚</li><li><strong>binder</strong> é€šè¿‡Binderè·¨è¿›ç¨‹è°ƒç”¨çš„æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡<code>adb shell cat</code>å‘½ä»¤ä» &#x2F;proc&#x2F;binder ä¸‹å–å‡ºå¯¹åº”çš„æ—¥å¿—<ul><li>failed_transaction_log</li><li>transaction_log</li><li>transactions</li><li>stats</li></ul></li><li><strong>dropbox</strong> ä¸ºäº†è®°å½•å†å²çš„logcatæ—¥å¿—ï¼ŒAndroidå¼•å…¥äº†Dropboxï¼Œå°†å†å²æ—¥å¿—æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­(<strong>&#x2F;data&#x2F;system&#x2F;dropbox</strong>)ã€‚ logcatçš„ç¼“å†²åŒºå¤§å°æ¯•ç«Ÿæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯åˆ©ç”¨ï¼Œè¿™æ ·å†å²çš„æ—¥å¿—ä¿¡æ¯å°±ä¼šè¢«å†²æ‰ã€‚åœ¨ä¸€äº›è‡ªåŠ¨åŒ–æµ‹è¯•çš„åœºæ™¯ä¸‹ï¼Œè­¬å¦‚Monkeyéœ€è¦é•¿æ—¶é—´çš„è¿è¡Œï¼Œ å°±éœ€è¦æŠŠå†å²çš„æ—¥å¿—å…¨éƒ½ä¿å­˜ä¸‹æ¥ã€‚</li><li><strong>tombstone</strong> tombstoneé”™è¯¯ä¸€èˆ¬ç”±Dalviké”™è¯¯ã€nativeå±‚çš„ä»£ç é—®é¢˜å¯¼è‡´çš„ã€‚å½“ç³»ç»Ÿå‘ç”Ÿtombstoneæ—¶ï¼Œå†…æ ¸ä¼šä¸ŠæŠ¥ä¸€ä¸ªä¸¥é‡çš„è­¦å‘Šä¿¡å·ï¼Œ ä¸Šå±‚æ”¶åˆ°åï¼ŒæŠŠå½“å‰çš„è°ƒç”¨æ ˆä¿¡æ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­(<strong>&#x2F;data&#x2F;tombstone</strong>)</li><li><strong>bugreport</strong> é€šè¿‡<code>adb bugreport</code>å‘½ä»¤è¾“å‡ºï¼Œæ—¥å¿—å†…å®¹å¤šåˆ°çˆ†ï¼Œlogcat, traces, dmesg, dumpsys, binderçš„æ—¥å¿—éƒ½åŒ…å«åœ¨å…¶ä¸­ã€‚ ç”±äºè¾“å‡ºbugreportçš„æ—¶é—´å¾ˆé•¿ï¼Œå½“ç³»ç»Ÿå‘ç”Ÿé”™è¯¯æ—¶ï¼Œæˆ‘ä»¬å†æ‰§è¡Œbugreportå¾€å¾€å°±æ¥ä¸åŠäº†(æ­¤æ—¶ï¼Œç³»ç»Ÿå¯èƒ½éƒ½å·²ç»é‡å¯äº†)ï¼Œæ‰€ä»¥ï¼Œè¦åŠ¨ç”¨bugreportå°±éœ€è¦ç»“åˆä¸€äº›å…¶ä»–æœºåˆ¶ï¼Œ è­¬å¦‚åœ¨æ€æ‰system_serverè¿›ç¨‹ä¹‹å‰ï¼Œå…ˆè®©bugreportè¿è¡Œå®Œ</li></ul><h3 id="3-2-é—®é¢˜å®šä½"><a href="#3-2-é—®é¢˜å®šä½" class="headerlink" title="3.2 é—®é¢˜å®šä½"></a>3.2 é—®é¢˜å®šä½</h3><p>Watchdogå‡ºç°çš„æ—¥å¿—å¾ˆæ˜æ˜¾ï¼Œlogcatä¸­çš„event, systemä¸­éƒ½ä¼šæœ‰ä½“ç°ï¼Œè¦å®šä½é—®é¢˜ï¼Œå¯ä»¥ä»æ£€ç´¢æ—¥å¿—ä¸­çš„watchdogå…³é”®å­—å¼€å§‹ã€‚</p><p>å‘ç”ŸWatchdogæ£€æµ‹è¶…æ—¶è¿™ä¹ˆé‡è¦çš„ç³»ç»Ÿäº‹ä»¶ï¼ŒAndroidä¼šæ‰“å°ä¸€ä¸ªEventLogï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">watchdog: Blocked <span class="hljs-keyword">in</span> handler XXX    <span class="hljs-comment"># è¡¨ç¤ºHandlerCheckerè¶…æ—¶äº†</span><br>watchdog: Blocked <span class="hljs-keyword">in</span> monitor XXX    <span class="hljs-comment"># è¡¨ç¤ºMonitorCheckerè¶…æ—¶äº†</span><br></code></pre></td></tr></table></figure><p>Watchdogæ˜¯è¿è¡Œåœ¨system_serverè¿›ç¨‹ä¸­ï¼Œä¼šæ‰“å°ä¸€äº›Systemç±»å‹çš„æ—¥å¿—ã€‚åœ¨æ‰‹æœºå¤„äºéè°ƒè¯•çŠ¶æ€æ—¶ï¼Œä¼´éšWatchdogå‡ºç°çš„å¾€å¾€æ˜¯system_serverè¿›ç¨‹è¢«æ€ï¼Œä»è€Œç³»ç»Ÿé‡å¯ã€‚ å½“Watchdogè¦ä¸»åŠ¨æ€æ‰system_serverè¿›ç¨‹æ—¶ï¼Œä»¥ä¸‹å…³é”®å­—å°±ä¼šå‡ºç°åœ¨SystemLogä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Watchdog: *** WATCHDOG KILLING SYSTEM PROCESS: XXX<br>Watchdog: XXX<br>Watchdog: <span class="hljs-string">&quot;*** GOODBYE!</span><br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨æ—¥å¿—ä¸­æ£€ç´¢åˆ°ä¸Šè¿°ä¸¤ç±»å…³é”®ä¿¡æ¯æ—¶ï¼Œè¯´æ˜â€œWatchdogæ˜¾çµâ€äº†ï¼Œä»å¦ä¸€ä¸ªè§’åº¦æ¥ç†è§£ï¼Œå°±æ˜¯â€œSystem Not Respondingâ€äº†ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å®šä½åœ¨watchdogå‡ºç°ä¹‹å‰ï¼Œsystem_serverè¿›ç¨‹åœ¨å¹²ä»€ä¹ˆï¼Œå¤„äºä¸€ä¸ªä»€ä¹ˆçŠ¶æ€ã€‚ è¿™ä¸æ’é™¤â€Application Not Respondingâ€œé—®é¢˜å·®ä¸å¤šï¼Œæˆ‘ä»¬éœ€è¦è¿›ç¨‹çš„tracesä¿¡æ¯ã€å½“å‰ç³»ç»Ÿçš„CPUè¿è¡Œä¿¡æ¯ã€IOä¿¡æ¯ã€‚</p><p>æ‰¾åˆ°Watchddogå‡ºç°ä¹‹å‰çš„traces.txtæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶é—´å·®æœ€å¥½ä¸è¦å¤ªå¤§ï¼Œå› ä¸ºWatchdogé»˜è®¤çš„è¶…æ—¶æ—¶é—´æ˜¯1åˆ†é’Ÿï¼Œå¤ªä¹…ä»¥å‰çš„traceså¹¶ä¸èƒ½è¯´æ˜é—®é¢˜ã€‚ è¯±å¯¼Watchdongå‡ºç°çš„ç›´æ¥åŸå› å…¶å®å°±æ˜¯system_serverä¸­æŸä¸ªçº¿ç¨‹è¢«é˜»å¡äº†ï¼Œè¿™ä¸ªä¿¡æ¯åœ¨eventå’Œsystemçš„logä¸­æ¸…æ™°å¯è§ã€‚ æˆ‘ä»¬ä»¥ä¸€ä¸ªsystemLogä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">W Watchdog: *** WATCHDOG KILLING SYSTEM PROCESS: Blocked <span class="hljs-keyword">in</span> monitor com.android.server.wm.WindowManagerService on foreground thread (android.fg)<br></code></pre></td></tr></table></figure><p>Watchdogå‘Šè¯‰æˆ‘ä»¬<strong>Monitor Checker</strong>è¶…æ—¶äº†ï¼Œå…·ä½“åœ¨å“ªå‘¢ï¼Ÿ åä¸º<strong>android.fg</strong>çš„çº¿ç¨‹åœ¨WindowManagerServiceçš„monitor()æ–¹æ³•è¢«é˜»å¡äº†ã€‚è¿™é‡Œéšå«äº†ä¸¤å±‚æ„æ€ï¼š</p><ol><li>WindowManagerServiceå®ç°äº†Watchdog.Monitorè¿™ä¸ªæ¥å£ï¼Œå¹¶å°†è‡ªå·±ä½œä¸º<strong>Monitor Checker</strong>çš„å¯¹è±¡åŠ å…¥åˆ°äº†Watchdogçš„ç›‘æµ‹é›†ä¸­</li><li>monitor()æ–¹æ³•æ˜¯è¿è¡Œåœ¨<strong>android.fg</strong>çº¿ç¨‹ä¸­çš„ã€‚Androidå°†<strong>android.fg</strong>è®¾è®¡ä¸ºä¸€ä¸ªå…¨å±€å…±äº«çš„çº¿ç¨‹ï¼Œæ„å‘³ç€å®ƒçš„æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹å…±äº«ï¼Œ Watchdogçš„<strong>Monitor Checker</strong>å°±æ˜¯ä½¿ç”¨çš„<strong>android.fg</strong>çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å› æ­¤ï¼Œå‡ºç°<strong>Monitor Checker</strong>çš„è¶…æ—¶ï¼Œè‚¯å®šæ˜¯<strong>android.fg</strong>çº¿ç¨‹é˜»å¡åœ¨monitor()æ–¹æ³•ä¸Šã€‚</li></ol><p>æˆ‘ä»¬æ‰“å¼€system_serverè¿›ç¨‹çš„tracesï¼Œæ£€ç´¢ <strong>android.fg</strong> å¯ä»¥å¿«é€Ÿå®šä½åˆ°è¯¥çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;android.fg&quot;</span> prio=5 tid=25 Blocked<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 obj=0x12eef900 self=0x7f7a8b1000<br>  | sysTid=973 <span class="hljs-built_in">nice</span>=0 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x7f644e9000<br>  | state=S schedstat=( 3181688530 2206454929 8991 ) utm=251 stm=67 core=1 HZ=100<br>  | stack=0x7f643e7000-0x7f643e9000 stackSize=1036KB<br>  | held mutexes=<br>  at com.android.server.wm.WindowManagerService.monitor(WindowManagerService.java:13125)<br>  - waiting to lock &lt;0x126dccb8&gt; (a java.util.HashMap) held by thread 91<br>  at com.android.server.Watchdog<span class="hljs-variable">$HandlerChecker</span>.run(Watchdog.java:204)<br>  at android.os.Handler.handleCallback(Handler.java:815)<br>  at android.os.Handler.dispatchMessage(Handler.java:104)<br>  at android.os.Looper.loop(Looper.java:194)<br>  at android.os.HandlerThread.run(HandlerThread.java:61)<br>  at com.android.server.ServiceThread.run(ServiceThread.java:46)<br></code></pre></td></tr></table></figure><p><strong>android.fg</strong>çº¿ç¨‹è°ƒç”¨æ ˆå‘Šè¯‰æˆ‘ä»¬å‡ ä¸ªå…³é”®çš„ä¿¡æ¯ï¼š</p><ul><li>è¿™ä¸ªçº¿ç¨‹å½“å‰çš„çŠ¶æ€æ˜¯<strong>Blocked</strong>ï¼Œé˜»å¡</li><li>ç”±Watchdogå‘èµ·è°ƒç”¨monitor()ï¼Œè¿™æ˜¯ä¸€ä¸ªWatchdogæ£€æŸ¥ï¼Œé˜»å¡å·²ç»è¶…æ—¶</li><li>**waiting to lock &lt;0x126dccb8&gt;**ï¼š é˜»å¡çš„åŸå› æ˜¯monitor()æ–¹æ³•ä¸­åœ¨ç­‰é”&lt;0x126dccb8&gt;</li><li><strong>held by thread 91</strong>ï¼š è¿™ä¸ªé”è¢«ç¼–å·ä¸º91çš„çº¿ç¨‹æŒæœ‰ï¼Œéœ€è¦è¿›ä¸€æ­¥è§‚å¯Ÿ91å·çº¿ç¨‹çš„çŠ¶æ€ã€‚</li></ul><blockquote><p>é¢˜å¤–è¯ï¼šæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä¼šå¯¹è‡ªå·±æ‰€è¾–çš„çº¿ç¨‹ç¼–å·ï¼Œä»1å¼€å§‹ã€‚1å·çº¿ç¨‹é€šå¸¸å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ä¸»çº¿ç¨‹ã€‚ çº¿ç¨‹åœ¨Linuxç³»ç»Ÿä¸­è¿˜æœ‰ä¸€ä¸ªå…¨å±€çš„ç¼–å·ï¼Œç”±sysTidè¡¨ç¤ºã€‚æˆ‘ä»¬åœ¨logcatç­‰æ—¥å¿—ä¸­çœ‹åˆ°çš„ä¸€èˆ¬æ˜¯çº¿ç¨‹çš„å…¨å±€ç¼–å·ã€‚ è­¬å¦‚ï¼Œæœ¬ä¾‹ä¸­android.fgçº¿ç¨‹åœ¨system_serverè¿›ç¨‹ä¸­çš„ç¼–å·æ˜¯25ï¼Œç³»ç»Ÿå…¨å±€ç¼–å·æ˜¯973ã€‚</p></blockquote><p>å¯ä»¥åœ¨traces.txtæ–‡ä»¶ä¸­æ£€ç´¢ tid&#x3D;91 æ¥å¿«é€Ÿæ‰¾åˆ°91å·çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;Binder_C&quot;</span> prio=5 tid=91 Native<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 obj=0x12e540a0 self=0x7f63289000<br>  | sysTid=1736 <span class="hljs-built_in">nice</span>=0 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x7f6127c000<br>  | state=S schedstat=( 96931835222 49673449591 260122 ) utm=7046 stm=2647 core=2 HZ=100<br>  | stack=0x7f5ffbc000-0x7f5ffbe000 stackSize=1008KB<br>  | held mutexes=<br>  at libcore.io.Posix.writeBytes(Native method)<br>  at libcore.io.Posix.write(Posix.java:258)<br>  at libcore.io.BlockGuardOs.write(BlockGuardOs.java:313)<br>  at libcore.io.IoBridge.write(IoBridge.java:537)<br>  at java.io.FileOutputStream.write(FileOutputStream.java:186)<br>  at com.android.internal.util.FastPrintWriter.flushBytesLocked(FastPrintWriter.java:334)<br>  at com.android.internal.util.FastPrintWriter.flushLocked(FastPrintWriter.java:355)<br>  at com.android.internal.util.FastPrintWriter.appendLocked(FastPrintWriter.java:303)<br>  at com.android.internal.util.FastPrintWriter.<span class="hljs-built_in">print</span>(FastPrintWriter.java:466)<br>  - locked &lt;@addr=0x134c4910&gt; (a com.android.internal.util.FastPrintWriter<span class="hljs-variable">$DummyWriter</span>)<br>  at com.android.server.wm.WindowState.dump(WindowState.java:1510)<br>  at com.android.server.wm.WindowManagerService.dumpWindowsNoHeaderLocked(WindowManagerService.java:12279)<br>  at com.android.server.wm.WindowManagerService.dumpWindowsLocked(WindowManagerService.java:12266)<br>  at com.android.server.wm.WindowManagerService.dump(WindowManagerService.java:12654)<br>  - locked &lt;0x126dccb8&gt; (a java.util.HashMap)<br>  at android.os.Binder.dump(Binder.java:324)<br>  at android.os.Binder.onTransact(Binder.java:290)<br></code></pre></td></tr></table></figure><p>91å·çº¿ç¨‹çš„åå­—æ˜¯<strong>Binder_C</strong>ï¼Œå®ƒçš„å‡½æ•°è°ƒç”¨æ ˆå‘Šè¯‰æˆ‘ä»¬å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š</p><ul><li>Nativeï¼Œè¡¨ç¤ºçº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€(RUNNING)ï¼Œå¹¶ä¸”æ­£åœ¨æ‰§è¡ŒJNIæ–¹æ³•</li><li>åœ¨WindowManagerService.dump()æ–¹æ³•ç”³è¯·äº†é”&lt;0x126dccb8&gt;ï¼Œè¿™ä¸ªé”æ­£æ˜¯<strong>android.fg</strong>çº¿ç¨‹æ‰€ç­‰å¾…çš„</li><li>FileOutputStream.write()è¡¨ç¤º<strong>Binder_C</strong>çº¿ç¨‹åœ¨æ‰§è¡ŒIOå†™æ“ä½œï¼Œæ­£å¼å› ä¸ºè¿™ä¸ªå†™æ“ä½œä¸€ç›´åœ¨é˜»å¡ï¼Œå¯¼è‡´çº¿ç¨‹æŒæœ‰çš„é”ä¸èƒ½é‡Šæ”¾</li></ul><blockquote><p>é¢˜å¤–è¯ï¼šå…³äºBinderçº¿ç¨‹ã€‚å½“Androidè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸“é—¨å¤„ç†Binderäº‹åŠ¡ã€‚çº¿ç¨‹æ± ä¸­ä¼šæ ¹æ®å½“å‰çš„binderçº¿ç¨‹è®¡æ•°å™¨çš„å€¼æ¥æ„é€ æ–°åˆ›å»ºçš„binderçº¿ç¨‹, çº¿ç¨‹åâ€Binder_%Xâ€ï¼ŒXæ˜¯åå…­è¿›åˆ¶ã€‚å½“ç„¶ï¼Œçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ä¹Ÿæœ‰ä¸Šé™ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º16ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥çœ‹åˆ° Binder_1 ~ Binder_F è¿™æ ·çš„çº¿ç¨‹å‘½åã€‚</p></blockquote><p>èªæ˜çš„ä½ çœ‹åˆ°è¿™æˆ–è®¸å·²ç»èƒ½å¤Ÿæƒ³åˆ°è§£å†³åŠæ³•äº†ï¼Œåœ¨è¿™ä¸ªIOå†™æ“ä½œä¸ŠåŠ ä¸€ä¸ªè¶…æ—¶æœºåˆ¶ï¼Œå¹¶ä¸”è¿™ä¸ªè¶…æ—¶å°äºWatchdogçš„è¶…æ—¶ï¼Œä¸å°±å¯ä»¥è®©çº¿ç¨‹é‡Šæ”¾å®ƒæ‰€å æœ‰çš„é”äº†å—ï¼Ÿ æ˜¯çš„ï¼Œè¿™ç¡®å®å¯ä»¥ä½œä¸ºä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆ(Workaround)ï¼Œæˆ–è€…è¯´ä¸€ä¸ªä¿æŠ¤æœºåˆ¶ã€‚ä½†æˆ‘ä»¬å¯ä»¥å†å¾€æ·±å¤„æƒ³ä¸€æƒ³ï¼Œè¿™ä¸ªIOå†™æ“ä½œä¸ºä»€ä¹ˆä¼šé˜»å¡ï¼š</p><ul><li>æ˜¯ä¸æ˜¯IOç¼“å†²åŒºæ»¡äº†ï¼Œå¯¼è‡´å†™é˜»å¡å‘¢ï¼Ÿ</li><li>æ˜¯ä¸æ˜¯å†™æ“ä½œæœ‰ä»€ä¹ˆé”ï¼Œå¯¼è‡´è¿™ä¸ªwriteæ–¹æ³•åœ¨ç­‰é”å‘¢ï¼Ÿ</li><li>æ˜¯ä¸æ˜¯å½“å‰ç³»ç»Ÿçš„IOè´Ÿè½½è¿‡äºé«˜ï¼Œå¯¼è‡´å†™æ“ä½œæ•ˆç‡å¾ˆä½å‘¢ï¼Ÿ</li></ul><p>è¿™éƒ½éœ€è¦æˆ‘ä»¬å†è¿›ä¸€æ­¥ä»æ—¥å¿—ä¸­å»æ‰¾åŸå› ã€‚å¦‚æœå·²æœ‰çš„æ—¥å¿—ä¸å…¨ï¼Œæ‰¾ä¸åˆ°è®ºæ®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾è®¡åœºæ™¯æ¥éªŒè¯å‡è®¾ï¼Œè§£å†³é—®é¢˜çš„éš¾åº¦é™¡ç„¶ä¸Šå‡ã€‚</p><h3 id="3-3-åœºæ™¯è¿˜åŸ"><a href="#3-3-åœºæ™¯è¿˜åŸ" class="headerlink" title="3.3 åœºæ™¯è¿˜åŸ"></a>3.3 åœºæ™¯è¿˜åŸ</h3><p>æˆ‘ä»¬ç»å†äº†ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š</p><ol><li>é€šè¿‡eventæˆ–systemç±»å‹çš„æ—¥å¿—ï¼Œå‘ç°äº†Watchdogæ€æ‰system_serverå¯¼è‡´ç³»ç»Ÿé‡å¯</li><li>é€šè¿‡tracesæ—¥å¿—ï¼Œå‘äº†å¯¼è‡´Watchdogå‡ºç°çš„å…·ä½“çº¿ç¨‹æ“ä½œ</li></ol><p>è¿™ä¸¤ä¸ªè¿‡ç¨‹åŸºæœ¬å°±æ¶µç›–äº†Watchdogçš„è¿è¡Œæœºåˆ¶äº†ï¼Œä½†è¿™å¹¶æ²¡æœ‰è§£å†³é—®é¢˜å•Šã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°çº¿ç¨‹é˜»å¡çš„åŸå› æ˜¯ä»€ä¹ˆï¼Œç„¶è€Œï¼Œçº¿ç¨‹é˜»å¡çš„åŸå› å°±åƒå¥‡ç™¾æ€ªäº†ã€‚ å¦‚æœæœ‰é—®é¢˜å‡ºç°çš„ç°åœºï¼Œå¹¶ä¸”é—®é¢˜å¯ä»¥é‡ç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒè¯•çš„æ‰‹æ®µæ¥åˆ†æé—®é¢˜äº§ç”Ÿçš„åŸå› ã€‚ å¦‚æœé—®é¢˜åªæ˜¯å¶ç„¶å‡ºç°ï¼Œç”šè‡³åªæœ‰ä¸€å †æ—¥å¿—ï¼Œæˆ‘ä»¬å°±éœ€è¦ä»æ—¥å¿—ä¸­æ¥è¿˜åŸé—®é¢˜å‡ºç°çš„åœºæ™¯ï¼Œè¿™ä¸€æ­¥æ‰æ˜¯çœŸæ­£è€ƒéªŒå¤§å®¶Android&#x2F;LinuxåŠŸåº•çš„åœ°æ–¹ã€‚</p><p>ç»§ç»­ä»¥ä¸Šè¿°é—®é¢˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥è¿˜åŸé—®é¢˜å‡ºç°çš„åœºæ™¯ï¼Œä»Javaå±‚çš„å‡½æ•°è°ƒç”¨æ ˆæ¥çœ‹ï¼š</p><ul><li>é¦–å…ˆï¼Œè·¨è¿›ç¨‹å‘èµ·äº†Binder.dump()æ–¹æ³•çš„è°ƒç”¨ï¼šat android.os.Binder.dump(Binder.java:324)</li><li>ç„¶åï¼Œè¿›å…¥äº†WMSçš„dump()ï¼šat com.android.server.wm.WindowManagerService.dump(WindowManagerService.java:12654)</li><li>æ¥ç€ï¼Œå‘ç”Ÿäº†å†™æ–‡ä»¶æ“ä½œï¼šat java.io.FileOutputStream.write(FileOutputStream.java:186)</li><li>æœ€åï¼Œè°ƒç”¨äº†JNIæ–¹æ³•ï¼šat libcore.io.Posix.writeBytes(Native method)</li></ul><p><strong>Binder_C</strong>çº¿ç¨‹è¦å‡ºç°è¿™ç§å‡½æ•°è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆæ­¥ç¡®å®šæ˜¯Androidæ¥å—äº†å¦‚ä¸‹å‘½ä»¤ (dumpsysåŸç†è¯·æŸ¥é˜…<a href="http://duanqz.github.io/2015-07-19-Intro-to-dumpsys">dumpsysä»‹ç»</a>ä¸€æ–‡)ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ adb shell dumpsys window<br></code></pre></td></tr></table></figure><p>å½“é€šè¿‡å‘½ä»¤è¡Œè¿è¡Œä»¥ä¸Šå‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯(PC)çš„adb serverä¼šå‘æœåŠ¡ç«¯(æ‰‹æœº)çš„adbdå‘é€æŒ‡ä»¤ï¼Œ adbdè¿›ç¨‹ä¼šforkå‡ºä¸€ä¸ªå«åšdumpsysçš„å­è¿›ç¨‹ï¼Œdumpsysè¿›ç¨‹å†åˆ©ç”¨Binderæœºåˆ¶å’Œsystem_serveré€šä¿¡ (adbçš„å®ç°åŸç†å¯ä»¥æŸ¥é˜…<a href="http://duanqz.github.io/2015-05-21-Intro-adb">adbä»‹ç»</a>ä¸€æ–‡)ã€‚</p><p>ä»…å‡­è¿™ä¸ªè¿˜æ˜¯åˆ†æä¸å‡ºé—®é¢˜æ‰€åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨å†…æ ¸çš„æ—¥å¿—äº†ã€‚å½“è°ƒç”¨JNIæ–¹æ³•libcore.io.Posix.writeBytes()æ—¶ï¼Œä¼šè§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼Œ Linuxä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå†…æ ¸çš„å‡½æ•°è°ƒç”¨æ ˆä¹Ÿå¯ä»¥ä»tracesä¸­æ‰¾åˆ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">kernel: __switch_to+0x74/0x8c<br>kernel: pipe_wait+0x60/0x9c<br>kernel: pipe_write+0x278/0x5cc<br>kernel: do_sync_write+0x90/0xcc<br>kernel: vfs_write+0xa4/0x194<br>kernel: SyS_write+0x40/0x8c<br>kernel: cpu_switch_to+0x48/0x4c<br></code></pre></td></tr></table></figure><p>åœ¨Javaå±‚ï¼Œæ˜ç¡®æŒ‡æ˜è¦å†™æ–‡ä»¶(FileOutputStream)ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œç³»ç»Ÿè°ƒç”¨write()å°±å®Œäº‹äº†ï¼Œä½†Kernelå´æ‰“å¼€äº†ä¸€ä¸ªç®¡é“ï¼Œæœ€ç»ˆé˜»å¡åœ¨äº†pipe_wait()æ–¹æ³•ã€‚ ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šæ‰“å¼€ä¸€ä¸ªç®¡é“ï¼Œè€Œä¸”ç®¡é“ä¼šé˜»å¡å‘¢ï¼Ÿä¸€ç³»åˆ—çš„çŒœæƒ³å’ŒéªŒè¯è¿‡ç¨‹æ¥è¸µè€Œè‡³ã€‚</p><p>è¿™é‡Œæœ‰å¿…è¦å…ˆè¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†äº†ï¼š</p><ul><li><p><strong><a href="http://www.cnblogs.com/biyeymyhjob/archive/2012/11/03/2751593.html">Linuxè¿›ç¨‹é—´é€šä¿¡ä¹‹ç®¡é“(pipe)</a></strong></p><p>Linuxçš„ç®¡é“å®ç°å€ŸåŠ©äº†æ–‡ä»¶ç³»ç»Ÿçš„fileç»“æ„å’ŒVFS(Virtual File System)ï¼Œé€šè¿‡å°†ä¸¤ä¸ªfileç»“æ„æŒ‡å‘åŒä¸€ä¸ªä¸´æ—¶çš„VFSç´¢å¼•èŠ‚ç‚¹ï¼Œè€Œè¿™ä¸ªVFSç´¢å¼•èŠ‚ç‚¹åˆæŒ‡å‘ä¸€ä¸ªç‰©ç†é¡µé¢æ—¶ï¼Œ å®é™…ä¸Šå°±å»ºç«‹äº†ä¸€ä¸ªç®¡é“ã€‚</p><p>è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆå‘èµ·ç³»ç»Ÿè°ƒç”¨writeçš„æ—¶å€™ï¼Œæ‰“å¼€äº†ä¸€ä¸ªç®¡é“ã€‚å› ä¸ºdumpsyså’Œsystem_serverè¿›ç¨‹ï¼Œå°†è‡ªå·±çš„fileç»“æ„æŒ‡å‘äº†åŒä¸€ä¸ªVFSç´¢å¼•èŠ‚ç‚¹ã€‚</p></li><li><p><strong><a href="http://blog.csdn.net/sj13051180/article/details/47865803">ç®¡é“æŒ‚èµ·çš„æ¡ˆä¾‹</a></strong></p><p>ç®¡é“æ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå½“ç¼“å†²åŒºæ»¡æ—¶ï¼Œåˆ™ç”Ÿäº§è€…ä¸èƒ½å¾€ç®¡é“ä¸­å†å†™æ•°æ®äº†ï¼Œéœ€ç­‰åˆ°æ¶ˆè´¹è€…è¯»æ•°æ®ã€‚å¦‚æœæ¶ˆè´¹è€…æ¥ä¸åŠå¤„ç†ç¼“å†²åŒºçš„æ•°æ®ï¼Œæˆ–è€…é”å®šç¼“å†²åŒºï¼Œåˆ™ç”Ÿäº§è€…å°±æŒ‚èµ·äº†ã€‚</p><p>ç»“åˆåˆ°ä¾‹å­ä¸­çš„åœºæ™¯ï¼Œsystem_serverè¿›ç¨‹æ— æ³•å¾€ç®¡é“ä¸­å†™æ•°æ®ï¼Œå¾ˆå¯èƒ½æ˜¯dumpsysè¿›ç¨‹ä¸€ç›´å¿™ç¢Œæ¥ä¸åŠå¤„ç†æ–°çš„æ•°æ®ã€‚</p></li></ul><p>æ¥ä¸‹æ¥ï¼Œéœ€è¦å†ä»æ—¥å¿—ä¸­å¯»æ‰¾dumpsysè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€äº†ï¼š</p><ul><li>æ˜¯ä¸æ˜¯dumpsysè¿›ç¨‹çš„è´Ÿè½½å¤ªé«˜ï¼Ÿ</li><li>æ˜¯ä¸æ˜¯dumpsysè¿›ç¨‹æ­»æ‰äº†ï¼Œå¯¼è‡´ä¸€ç›´æ²¡æœ‰å¤„ç†ç¼“å†²åŒºæ•°æ®ï¼Ÿ</li><li>æ˜¯ä¸æ˜¯dumpsysè¿›ç¨‹æœ‰æ­»é”ï¼Ÿ</li></ul><p>æ¥ä¸‹æ¥çš„åˆ†æè¿‡ç¨‹å·²ç»åç¦»Watchdogæœºåˆ¶è¶Šæ¥è¶Šè¿œäº†ï¼Œæˆ‘ä»¬ç‚¹åˆ°ä¸ºæ­¢ã€‚</p><p>å°ä¼™ä¼´ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœºæ™¯è¿˜åŸæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹éå¸¸ä¹‹å®½æ³›ï¼Œè€Œä¸”æœ‰ä¸€å®šçš„æ·±åº¦ã€‚åœ¨æ²¡æœ‰ç°åœºçš„æƒ…å†µä¸‹ï¼Œä¼´éšä¸€ç³»åˆ—çš„å‡è®¾å’ŒéªŒè¯è¿‡ç¨‹ï¼Œå……æ»¡äº†ä¸ç¡®å®šæ€§å’Œå‘ç°é—®é¢˜çš„å–œæ‚¦ã€‚ æ­£æ‰€è°“ï¼ŒåŒé—®é¢˜åšæ–—äº‰ï¼Œå…¶ä¹æ— ç©·ï¼</p><p><strong>è‡³æ­¤ï¼Œæˆ‘ä»¬åˆ†æWatchdogé—®é¢˜çš„æƒ¯ç”¨æ–¹æ³•ï¼Œå›ç­”å‰é¢æå‡ºæ¥çš„ç¬¬äºŒä¸ªé—®é¢˜ï¼š</strong></p><p><strong>é€šè¿‡eventæˆ–systemç±»å‹çš„logcatæ—¥å¿—ï¼Œæ£€ç´¢Watchdogå‡ºç°çš„å…³é”®ä¿¡æ¯ï¼›é€šè¿‡tracesï¼Œåˆ†æå‡ºå¯¼è‡´Watchdogæ£€æŸ¥è¶…æ—¶çš„ç›´æ¥åŸå› ï¼›é€šè¿‡å…¶ä»–æ—¥å¿—ï¼Œè¿˜åŸå‡ºé—®é¢˜å‡ºç°çš„åœºæ™¯ã€‚</strong></p><h2 id="4-å®ä¾‹åˆ†æ"><a href="#4-å®ä¾‹åˆ†æ" class="headerlink" title="4.å®ä¾‹åˆ†æ"></a>4.å®ä¾‹åˆ†æ</h2><p>åœ¨ä¸Šé¢ä»‹ç»Watchdogé—®é¢˜åˆ†ææ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®å·²ç»ä¸¾äº†ä¸€ä¸ªä¾‹å­ã€‚é€šå¸¸ï¼Œæ¯”è¾ƒå®¹æ˜“å®šä½å¯¼è‡´Watchdogå‡ºç°çš„ç›´æ¥åŸå› (Direct Cause)ï¼Œä½†å¾ˆéš¾æ‰¾åˆ°æ›´æ·±å±‚æ¬¡çš„åŸå› (Root Cause)ã€‚ è¿™ä¸ªå°èŠ‚ï¼Œæˆ‘ä»¬å†ä»‹ç»ä¸€ä¸ªå®ä¾‹ï¼Œæ¥åˆ†æWatchdogå‡ºç°çš„å¦ä¸€ç§åœºæ™¯ã€‚è¯šç„¶ï¼Œä»…å‡­å‡ ä¸ªä¾‹å­ï¼Œè¿œä¸å¤Ÿæ¶µç›–Watchdogçš„æ‰€æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬çš„ç« æ³•è¿˜æ˜¯æŒ‰ç…§ä¸€å®šçš„æ–¹æ³•è®ºæ¥æ·±ç©¶é—®é¢˜ã€‚</p><p>å›é¡¾ä¸€ä¸‹è§£å†³é—®é¢˜ä¸‰éƒ¨æ›²ï¼š</p><ol><li>æ—¥å¿—è·å–ã€‚æ—¥å¿—ç§ç±»ç¹å¤šï¼Œåˆ†æWatchdogé—®é¢˜ï¼Œå®æ»¥æ¯‹ç¼º</li><li>é—®é¢˜å®šä½ã€‚ä»logcatä¸­é”å®šwatchdogçš„å‡ºç°ï¼Œä»tracesé”å®šç›´æ¥åŸå› </li><li>åœºæ™¯è¿˜åŸã€‚ç»“åˆå„ç±»æ—¥å¿—ï¼Œä¸æ–­å‡è®¾éªŒè¯</li></ol><p><strong>ä»¥CPUå ç”¨è¿‡é«˜çš„åœºæ™¯ä¸ºä¾‹ï¼š<a href="http://duanqz.github.io/2015-10-12-Watchdog-Analysis">ä¸‹è½½è¯¥é—®é¢˜çš„å…¨éƒ¨æ—¥å¿—</a></strong></p><p><strong>ä»sys_logä¸­ï¼Œæ£€ç´¢åˆ°äº†Watchdogçš„å‡ºç°å…³é”®ä¿¡æ¯</strong></p><blockquote><p>TIPS: åœ¨sys_logä¸­æœç´¢å…³é”®å­—â€WATCHDOG KILLING SYSTEM PROCESSâ€</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">10-14 17:10:51.548   892  1403 W Watchdog: *** WATCHDOG KILLING SYSTEM PROCESS: Blocked in handler on ActivityManager (ActivityManager)<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªWatchdogçš„<strong>Looper Checker</strong>è¶…æ—¶ï¼Œç”±äºActivityManagerè¿™ä¸ªçº¿ç¨‹ä¸€ç›´å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œå¯¼è‡´Watchdogæ£€æŸ¥è¶…æ—¶ã€‚ Watchdogå‡ºç°çš„æ—¶é—´æ˜¯<strong>10-14 17:10:51.548</strong>å·¦å³ï¼Œéœ€è¦ä»traces.txtä¸­æ‰¾åˆ°è¿™ä¸ªæ—¶é—´æ®µçš„system_serverè¿›ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œ system_serverçš„è¿›ç¨‹å·æ˜¯892ã€‚</p><p><strong>ä»traces.txtä¸­æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°è°ƒç”¨æ ˆ</strong></p><p>traces.txtåŒ…å«å¾ˆå¤šè¿›ç¨‹åœ¨ä¸åŒæ—¶é—´æ®µçš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ï¼Œä¸ºäº†æ£€ç´¢çš„æ–¹ä¾¿ï¼Œé¦–å…ˆå¯ä»¥å°†traces.txtåˆ†å—ã€‚ ç¬”è€…å†™äº†ä¸€ä¸ª<a href="https://github.com/duanqz">å·¥å…·</a>ï¼Œå¯ä»¥ä»traces.txtæ–‡ä»¶ä¸­åˆ†å‰²å‡ºæŒ‡å®šè¿›ç¨‹å·çš„å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ã€‚</p><blockquote><p>TIPS: åœ¨system_serverçš„tracesä¸­(é€šè¿‡å·¥å…·åˆ†å‰²å‡ºçš„system_server_892_2015-10-14-17:09:06æ–‡ä»¶)æœç´¢å…³é”®å­—â€ActivityManagerâ€</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;ActivityManager&quot;</span> prio=5 tid=17 TimedWaiting<br>  | group=<span class="hljs-string">&quot;main&quot;</span> sCount=1 dsCount=0 obj=0x12c0e6d0 self=0x7f84caf000<br>  | sysTid=938 <span class="hljs-built_in">nice</span>=-2 cgrp=default <span class="hljs-built_in">sched</span>=0/0 handle=0x7f7d887000<br>  | state=S schedstat=( 107864628645 628257779012 60356 ) utm=7799 stm=2987 core=2 HZ=100<br>  | stack=0x7f6e68f000-0x7f6e691000 stackSize=1036KB<br>  | held mutexes=<br>  at java.lang.Object.<span class="hljs-built_in">wait</span>!(Native method)<br>  - waiting on &lt;0x264ff09d&gt; (a com.android.server.am.ActivityManagerService<span class="hljs-variable">$5</span>)<br>  at java.lang.Object.<span class="hljs-built_in">wait</span>(Object.java:422)<br>  at com.android.server.am.ActivityManagerService.dumpStackTraces(ActivityManagerService.java:5395)<br>  at com.android.server.am.ActivityManagerService.dumpStackTraces(ActivityManagerService.java:5282)<br>  at com.android.server.am.ActivityManagerService<span class="hljs-variable">$AnrActivityManagerService</span>.dumpStackTraces(ActivityManagerService.java:22676)<br>  at com.mediatek.anrmanager.ANRManager<span class="hljs-variable">$AnrDumpMgr</span>.dumpAnrDebugInfoLocked(SourceFile:1023)<br>  at com.mediatek.anrmanager.ANRManager<span class="hljs-variable">$AnrDumpMgr</span>.dumpAnrDebugInfo(SourceFile:881)<br>  at com.android.server.am.ActivityManagerService.appNotResponding(ActivityManagerService.java:6122)<br>  - locked &lt;0x21c77912&gt; (a com.mediatek.anrmanager.ANRManager<span class="hljs-variable">$AnrDumpRecord</span>)<br>  at com.android.server.am.BroadcastQueue<span class="hljs-variable">$AppNotResponding</span>.run(BroadcastQueue.java:228)<br>  at android.os.Handler.handleCallback(Handler.java:815)<br>  at android.os.Handler.dispatchMessage(Handler.java:104)<br>  at android.os.Looper.loop(Looper.java:192)<br>  at android.os.HandlerThread.run(HandlerThread.java:61)<br>  at com.android.server.ServiceThread.run(ServiceThread.java:46)<br></code></pre></td></tr></table></figure><p>ActivityManagerçº¿ç¨‹å®é™…ä¸Šè¿è¡Œç€AMSçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨æ ˆçš„å…³é”®ä¿¡æ¯ï¼š</p><ul><li>çº¿ç¨‹çŠ¶æ€ä¸ºTimedWaiting, è¿™è¡¨ç¤ºå½“å‰çº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªè¶…æ—¶çš„wait()æ–¹æ³•</li><li>æ­£åœ¨å¤„ç†å¹¿æ’­æ¶ˆæ¯è¶…æ—¶å‘ç”Ÿçš„ANR(Application Not Responding)ï¼Œéœ€è¦å°†å½“å‰çš„å‡½æ•°è°ƒç”¨æ ˆæ‰“å°å‡ºæ¥</li><li>æœ€ç»ˆåœ¨&lt;0x264ff09d&gt;ç­‰å¾…ï¼Œå¯ä»¥ä»<a href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/android/server/am/ActivityManagerService.java#4830">AMSçš„æºç </a> ä¸­æ‰¾åˆ°è¿™ä¸€å¤„é”çš„æºç ï¼Œå› ä¸ºdumpStackTraces()ä¼šå†™æ–‡ä»¶ï¼Œæ‰€ä»¥AMSè®¾è®¡äº†ä¸€ä¸ª200æ¯«ç§’çš„è¶…æ—¶é”ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">observer.wait(<span class="hljs-number">200</span>);  <span class="hljs-comment">// Wait for write-close, give up after 200msec</span><br></code></pre></td></tr></table></figure><p><strong>è¿˜åŸé—®é¢˜çš„åœºæ™¯</strong></p><p>ä»ActivityManagerè¿™ä¸ªçº¿ç¨‹çš„è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬å°±ä¼šæœ‰ä¸€äº›ç–‘æƒ‘ï¼š</p><ul><li>æ˜¯å“ªä¸ªåº”ç”¨å‘ç”Ÿäº†ANRï¼Ÿä¸ºä»€ä¹ˆä¼šå‘ç”ŸANRï¼Ÿ</li><li>è¶…æ—¶é”åªç”¨200æ¯«ç§’å°±é‡Šæ”¾äº†ï¼Œä¸ºä»€ä¹ˆä¼šå¯¼è‡´Watchdogæ£€æŸ¥è¶…æ—¶ï¼Ÿ(AMSçš„Looperé»˜è®¤è¶…æ—¶æ˜¯1åˆ†é’Ÿ)</li></ul><p>å¸¦ç€è¿™äº›ç–‘æƒ‘ï¼Œæˆ‘ä»¬å†å›åˆ°æ—¥å¿—ä¸­ï¼š</p><p>ä»sys_logä¸­ï¼Œå¯ä»¥æ£€ç´¢åˆ°Watchdogå‡ºç°çš„æ—¶é—´ç‚¹(<strong>17:10:51.548</strong>)ä¹‹å‰ï¼Œcom.android.systemuiå‘ç”Ÿäº†ANRï¼Œä»è€Œå¼•å‘AMSæ‰“å°å‡½æ•°è°ƒç”¨æ ˆ:</p><blockquote><p>â­<strong>TIPS: åœ¨sys_logä¸­æ£€ç´¢â€ANR inâ€å…³é”®å­—æˆ–åœ¨event_logä¸­æ£€ç´¢â€anrâ€å…³é”®å­—</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager: ANR in com.android.systemui, time=<span class="hljs-number">27097912</span><br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager: Reason: Broadcast of Intent &#123; act=android.intent.action.TIME_TICK flg=<span class="hljs-number">0x50000114</span> (has extras) &#125;<br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager: Load: <span class="hljs-number">89.22</span> / <span class="hljs-number">288.15</span> / <span class="hljs-number">201.91</span><br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager: Android time :[<span class="hljs-number">2015</span>-<span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.14</span>] [<span class="hljs-number">27280.396</span>]<br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager: CPU usage from 17016ms to 0ms ago:<br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager:   <span class="hljs-number">358</span>% <span class="hljs-number">23682</span>/float_bessel: <span class="hljs-number">358</span>% user + <span class="hljs-number">0</span>% kernel<br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager:   <span class="hljs-number">57</span>% <span class="hljs-number">23604</span>/debuggerd64: <span class="hljs-number">3.8</span>% user + <span class="hljs-number">53</span>% kernel / faults: <span class="hljs-number">11369</span> minor<br><span class="hljs-number">10</span>-<span class="hljs-number">14</span> <span class="hljs-number">17</span>:<span class="hljs-number">10</span>:<span class="hljs-number">04.215</span>   <span class="hljs-number">892</span>   <span class="hljs-number">938</span> E ANRManager:   <span class="hljs-number">2</span>% <span class="hljs-number">892</span>/system_server: <span class="hljs-number">0.9</span>% user + <span class="hljs-number">1</span>% kernel / faults: <span class="hljs-number">136</span> minor<br></code></pre></td></tr></table></figure><p>ä»è¿™ä¸ªæ—¥å¿—ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬ä¸¤ä¸ªç–‘æƒ‘å°±é‡Šç„¶äº†ï¼š</p><p>å‘ç”ŸANRä¹‹å‰çš„CPUè´Ÿè½½è¿œé«˜äºæ­£å¸¸æƒ…å†µå¥½å‡ å€(Loadï¼š 89.22 &#x2F; 288.15 &#x2F; 201.91)ï¼Œåœ¨è¿™ç§CPUè´Ÿè½½ä¸‹ï¼Œcom.android.systemuiè¿›ç¨‹å‘ç”Ÿå¤„ç†å¹¿æ’­æ¶ˆæ¯è¶…æ—¶(Reason: Broadcast of Intent)å†æ­£å¸¸ä¸è¿‡äº†ã€‚ åœ¨è¿™ä¹‹å‰CPUéƒ½è¢«<strong>float_bessel</strong>è¿™ä¸ªè¿›ç¨‹ç»™å äº†ï¼Œè¿™è´§ä»…å‡­ä¸€å·±ä¹‹åŠ›å°±è€—äº†358%çš„CPUèµ„æºã€‚</p><p>observer.wait(200)åœ¨è°ƒç”¨åï¼Œä¾¿è¿›å…¥æ’é˜Ÿç­‰å¾…å”¤é†’çŠ¶æ€(Waiting)ï¼Œåœ¨ç­‰å¾…200æ¯«ç§’åï¼Œä¾¿é‡æ–°å¼€å§‹ç”³è¯·CPUèµ„æºï¼Œè€Œæ­¤æ—¶ï¼ŒCPUèµ„æºä¸€ç›´è¢«<strong>float_bessel</strong>å ç€æ²¡æœ‰é‡Šæ”¾ï¼Œæ‰€ä»¥è¯¥çº¿ç¨‹ä¸€ç›´åœ¨ç­‰CPUèµ„æºã€‚ ç­‰äº†1åˆ†é’Ÿåï¼ŒWatchdogè·³å‡ºæ¥è¯´â€œä¸è¡Œï¼Œä½ å·²ç»ç­‰äº†1åˆ†é’Ÿäº†ï¼Œhandlerå¤„ç†å…¶ä»–æ¶ˆæ¯äº†â€ã€‚</p><p>åœ¨å¤šæ ¸æƒ…å†µä¸‹ï¼ŒCPUçš„ä½¿ç”¨ç‡ç»Ÿè®¡ä¼šç´¯åŠ å¤šä¸ªæ ¸çš„ä½¿ç”¨ç‡ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¶…è¿‡100%çš„æƒ…å†µã€‚é‚£ä¹ˆ<strong>float_bessel</strong>ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªLinuxçš„æµ‹è¯•æ ·æœ¬ï¼Œè´å¡å°”å‡½æ•°çš„è®¡ç®—ï¼Œè€—çš„å°±æ˜¯CPUã€‚</p><p>è¿™æ ·ï¼Œè¯¥é—®é¢˜çš„åœºæ™¯æˆ‘ä»¬å°±è¿˜åŸå‡ºæ¥äº†ï¼šåœ¨å‹åŠ›æµ‹è¯•çš„ç¯å¢ƒä¸‹ï¼ŒCPUè¢«<strong>float_bessel</strong>è¿ç®—å ç”¨ï¼Œå¯¼è‡´com.android.systemuiè¿›ç¨‹å‘ç”ŸANRï¼Œä»è€Œå¼•å‘AMSæ‰“å°trace; ä½†ç”±äºAMSä¸€ç›´ç­‰ä¸åˆ°CPUèµ„æºï¼ŒWatchdogæ£€æµ‹è¶…æ—¶ï¼Œæ€æ‰system_serverè¿›ç¨‹ï¼Œç³»ç»Ÿé‡å¯ã€‚</p><p>å¯¹äºå‹åŠ›æµ‹è¯•è€Œè¨€ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾å®šä¸€ä¸ªé€šè¿‡æ ‡å‡†ï¼Œåœ¨æŸäº›å‹åŠ›æƒ…å†µä¸‹ï¼Œå‡ºç°ä¸€äº›é”™è¯¯æ˜¯å…è®¸çš„ã€‚å¯¹äºAndroidå®é™…ç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯è€Œè¨€ï¼Œæœ¬ä¾‹ä¸­çš„å‹åŠ›é€šå¸¸æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ç§ç±»å‹çš„Watchdogé—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸è§£å†³ã€‚</p><h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5.æ€»ç»“"></a>5.æ€»ç»“</h2><p>Androidä¸­Watchdogç”¨æ¥çœ‹æŠ¤system_serverè¿›ç¨‹ï¼Œsystem_serverè¿›ç¨‹è¿è¡Œç€ç³»ç»Ÿæœ€ç»ˆè¦çš„æœåŠ¡ï¼Œè­¬å¦‚AMSã€PKMSã€WMSç­‰ï¼Œ å½“è¿™äº›æœåŠ¡ä¸èƒ½æ­£å¸¸è¿è½¬æ—¶ï¼ŒWatchdogå¯èƒ½ä¼šæ€æ‰system_serverï¼Œè®©ç³»ç»Ÿé‡å¯ã€‚</p><p>Watchdogçš„å®ç°åˆ©ç”¨äº†é”å’Œæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ã€‚å½“system_serverå‘ç”Ÿæ­»é”æˆ–æ¶ˆæ¯é˜Ÿåˆ—ä¸€ç›´å¤„äºå¿™ç¢ŒçŠ¶æ€æ—¶ï¼Œåˆ™è®¤ä¸ºç³»ç»Ÿå·²ç»æ²¡æœ‰å“åº”äº†(System Not Responding)ã€‚</p><p>åœ¨åˆ†æWatchdogé—®é¢˜çš„æ—¶å€™ï¼Œé¦–å…ˆè¦æœ‰è¯¦å°½çš„æ—¥å¿—ï¼Œå…¶æ¬¡è¦èƒ½å®šä½å‡ºå¯¼è‡´Watchdogè¶…æ—¶çš„ç›´æ¥åŸå› ï¼Œæœ€é‡è¦çš„æ˜¯èƒ½è¿˜åŸå‡ºé—®é¢˜å‘ç”Ÿçš„åœºæ™¯ã€‚</p><blockquote><ol><li>ä»logcatä¸­é”å®šwatchdogçš„å‡ºç°ã€WATCHDOG KILLING SYSTEM PROCESS:ã€‘</li><li>ä»tracesé”å®šç›´æ¥åŸå› </li></ol></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€å®éªŒã€‘forkå­è¿›ç¨‹è¶…æ—¶æ§åˆ¶</title>
    <link href="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/"/>
    <url>/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘forkå­è¿›ç¨‹è¶…æ—¶æ§åˆ¶"><a href="#ã€å®éªŒã€‘forkå­è¿›ç¨‹è¶…æ—¶æ§åˆ¶" class="headerlink" title="ã€å®éªŒã€‘forkå­è¿›ç¨‹è¶…æ—¶æ§åˆ¶"></a>ã€å®éªŒã€‘forkå­è¿›ç¨‹è¶…æ—¶æ§åˆ¶</h1><h2 id="1-waitpidå‡½æ•°"><a href="#1-waitpidå‡½æ•°" class="headerlink" title="1.waitpidå‡½æ•°"></a>1.waitpidå‡½æ•°</h2><p><a href="https://blog.csdn.net/qq_21438461/article/details/130318658">https://blog.csdn.net/qq_21438461/article/details/130318658</a></p><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808232639527.png" alt="image-20230808232639527" style="zoom:80%;"><h2 id="2-å®éªŒ"><a href="#2-å®éªŒ" class="headerlink" title="2.å®éªŒ"></a>2.å®éªŒ</h2><h3 id="2-1-å­è¿›ç¨‹è¶…æ—¶"><a href="#2-1-å­è¿›ç¨‹è¶…æ—¶" class="headerlink" title="2.1 å­è¿›ç¨‹è¶…æ—¶"></a>2.1 å­è¿›ç¨‹è¶…æ—¶</h3><p>å‡è®¾å­è¿›ç¨‹æ˜¯è¶…æ—¶çš„æƒ…å†µ</p><ul><li>å­è¿›ç¨‹å‡è®¾éœ€è¦é˜»å¡5ç§’ï¼Œè€Œçˆ¶è¿›ç¨‹åšè¶…æ—¶åˆ¤æ–­ï¼šè¶…è¿‡3ç§’å°±ç»™å­è¿›ç¨‹å‘é€kill 9å‘½ä»¤</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> pid;<br><br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">5</span>);<br>        _exit(<span class="hljs-number">127</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork child process failed\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> cout = <span class="hljs-number">3</span>;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">pid_t</span> pidNo;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        pidNo = <span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG);<br>        <span class="hljs-keyword">if</span> (pidNo == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (cout &lt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">kill</span>(<span class="hljs-number">9</span>, pid);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time out\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            cout--;<br>            <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pidNo == pid) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child process exit\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>    &#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count = %d\n&quot;</span>, cout);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    <br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808225916097.png" alt="image-20230808225916097" style="zoom: 80%;"><h3 id="2-2-å­è¿›ç¨‹æ‰§è¡Œæ­£å¸¸é€€å‡º"><a href="#2-2-å­è¿›ç¨‹æ‰§è¡Œæ­£å¸¸é€€å‡º" class="headerlink" title="2.2 å­è¿›ç¨‹æ‰§è¡Œæ­£å¸¸é€€å‡º"></a>2.2 å­è¿›ç¨‹æ‰§è¡Œæ­£å¸¸é€€å‡º</h3><p>å­è¿›ç¨‹ä¸ä¼šè¶…æ—¶ï¼Œæ­£å¸¸é€€å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> pid;<br><br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">usleep</span>(<span class="hljs-number">5</span>);<br>        _exit(<span class="hljs-number">127</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork child process failed\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> cout = <span class="hljs-number">3</span>;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">pid_t</span> pidNo;<br>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">5000</span>); <span class="hljs-comment">// å¾ˆé‡è¦ï¼Œå…ˆé˜»å¡çˆ¶è¿›ç¨‹5000us=5us</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        pidNo = <span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG);<br>        <span class="hljs-keyword">if</span> (pidNo == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (cout &lt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">kill</span>(<span class="hljs-number">9</span>, pid);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time out\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            cout--;<br>            <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pidNo == pid) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child process exit\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count = %d\n&quot;</span>, cout);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    <br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808231541388.png" alt="image-20230808231541388" style="zoom: 80%;"><h2 id="3-ä¸¤ä¸ªç°è±¡"><a href="#3-ä¸¤ä¸ªç°è±¡" class="headerlink" title="3.ä¸¤ä¸ªç°è±¡"></a>3.ä¸¤ä¸ªç°è±¡</h2><h3 id="3-1-è¶…æ—¶ä¸å‡†ç¡®"><a href="#3-1-è¶…æ—¶ä¸å‡†ç¡®" class="headerlink" title="3.1 è¶…æ—¶ä¸å‡†ç¡®"></a>3.1 è¶…æ—¶ä¸å‡†ç¡®</h3><p>1.å¦‚æœä½¿ç”¨äº†usleepå‡½æ•°ï¼Œå‘ç°æœ‰é—®é¢˜ï¼Œ<strong>è¶…æ—¶ä¸å‡†ç¡®</strong></p><ul><li>å­è¿›ç¨‹é˜»å¡äº†5sï¼Œç”¨countå’Œusleepç»„åˆä¸º3sï¼Œä½†å®é™…è¿è¡Œäº†5s</li><li>æœ€åå‘ç°å³ä½¿5sè¿‡å»äº†ï¼Œ countå€¼è¿˜å‰©850ï¼Œè¯´æ˜3000ä¸ª1msèµ°å®Œå¯èƒ½è¦èŠ±è´¹è¿œå¤§äº3s</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> pid;<br><br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">5</span>);<br>        _exit(<span class="hljs-number">127</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork child process failed\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> cout = <span class="hljs-number">3000</span>;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">pid_t</span> pidNo;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        pidNo = <span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG);<br>        <span class="hljs-keyword">if</span> (pidNo == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (cout &lt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">kill</span>(<span class="hljs-number">9</span>, pid);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time out\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            cout--;<br>            <span class="hljs-built_in">usleep</span>(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 1000us=1ms</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pidNo == pid) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child process exit\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count = %d\n&quot;</span>, cout);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    <br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808230433343.png" alt="image-20230808230433343" style="zoom: 80%;"><p><strong>æµ‹è¯•ä¸€ä¸‹3000ä¸ª1msèµ°å®Œè¦å¤šä¹…</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">3000</span>;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">3000</span>; i++) &#123;<br>        usleep(<span class="hljs-number">1000</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808230828799.png" alt="image-20230808230828799" style="zoom:80%;"><p>ğŸ”´ <strong>å¯¹äºä¸åŒæ€§èƒ½çš„æœºå™¨ï¼Œæ—¶é—´å‡½æ•°å‡†ç¡®åº¦ä¸åŒï¼Œè¿™å¯¹ç”¨æˆ·æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ï¼</strong></p><h3 id="3-2-æ—¶é—´æ»å"><a href="#3-2-æ—¶é—´æ»å" class="headerlink" title="3.2 æ—¶é—´æ»å"></a>3.2 æ—¶é—´æ»å</h3><ul><li>å­è¿›ç¨‹åªæ‰§è¡Œäº†5usï¼Œä½†æ˜¯ç¨‹åºèµ°å®Œå´èŠ±äº†1sï¼Œä»countæ£€å‡ºï¼Œå…¶å¤šç­‰å¾…äº†1s</li><li>æ‰€ä»¥å…¶å®æ—¶é—´æ˜¯æ»åçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨2.2èŠ‚ä¸­åœ¨whileå¾ªç¯å‰å…ˆé˜»å¡çˆ¶è¿›ç¨‹5000us(5ms)çš„åŸå› ï¼›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> pid;<br><br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        usleep(<span class="hljs-number">5</span>);<br>        _exit(<span class="hljs-number">127</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork child process failed\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">cout</span> = <span class="hljs-number">3</span>;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">pid_t</span> pidNo;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        pidNo = waitpid(pid, &amp;status, WNOHANG);<br>        <span class="hljs-keyword">if</span> (pidNo == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">cout</span> &lt;= <span class="hljs-number">0</span>) &#123;<br>                kill(<span class="hljs-number">9</span>, pid);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time out\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-built_in">cout</span>--;<br>            sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pidNo == pid) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child process exit\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count = %d\n&quot;</span>, <span class="hljs-built_in">cout</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    <br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/08/08/fork%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6/image-20230808231706623.png" alt="image-20230808231706623" style="zoom:80%;"><h3 id="3-3-ä½“ä¼š"><a href="#3-3-ä½“ä¼š" class="headerlink" title="3.3 ä½“ä¼š"></a>3.3 ä½“ä¼š</h3><p>æ ¹æ®3.1å’Œ3.2ä¹‹é—´ï¼Œæˆ‘ä»¬è¦å¹³è¡¡å¥½å¯¹ç”¨æˆ·ä½“éªŒçš„å·®åˆ«ã€‚</p><ul><li>å³ä½¿å­è¿›ç¨‹æ‰§è¡ŒæˆåŠŸäº†ï¼Œè®©ç”¨æˆ·å¤šç­‰1s</li><li>å¦å¤–å¦‚æœwhileå¾ªç¯ä¸­ä½¿ç”¨äº†usleepï¼Œä½†å´è¾¾ä¸åˆ°å®é™…çš„è®¡æ—¶æ•ˆæœã€‚</li></ul><p>æ‰€ä»¥æˆ‘çš„å»ºè®®æ˜¯åœ¨whileå‰å¾ªç¯ä¸­ç‰ºç‰²ä¸€ç‚¹ç‚¹çš„æ—¶é—´ã€é˜»å¡çˆ¶è¿›ç¨‹ä¸€å°ä¼šã€‘ï¼Œç„¶ååœ¨whileå¾ªç¯é‡Œé¢ä½¿ç”¨ç²’åº¦æ›´é«˜çš„sleepå‡½æ•°ã€‚è‡³äºwhileå‰é¢é˜»å¡å¤šä¹…ï¼Œwhileå¾ªç¯é‡Œé¢ä¸€æ¬¡sleep(x)ï¼Œxå–å¤šå°‘ï¼Œéœ€è¦ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointç‰¹æ€§</title>
    <link href="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/"/>
    <url>/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointç‰¹æ€§"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointç‰¹æ€§" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointç‰¹æ€§"></a>f2fsæ–‡ä»¶ç³»ç»Ÿcheckpointç‰¹æ€§</h1><p>ç›¸è¾ƒäºå¾ˆå¤šæ–‡ç« ä¸€ä¸Šæ¥è§£è¯»ä»£ç ï¼Œæˆ‘æ›´æ„¿æ„ä»é—®é¢˜å‡ºç°çš„èƒŒæ™¯å¼€å§‹è®²èµ·ï¼Œä¸€ä¸ªæŠ€æœ¯å¦‚æœæ²¡æœ‰æ—¶ä»£èƒŒæ™¯ï¼Œä»–çš„å‡ºç°æ˜¾å¾—åƒä¸ªæ€ªèƒã€‚</p><h2 id="å´©æºƒä¸€è‡´æ€§é—®é¢˜"><a href="#å´©æºƒä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="å´©æºƒä¸€è‡´æ€§é—®é¢˜"></a>å´©æºƒä¸€è‡´æ€§é—®é¢˜</h2><p>å¯¹äºä¸€èˆ¬çš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ï¼Œå¦‚æœæˆ‘è¦å¯¹æ–‡ä»¶åšè¿½åŠ åŠ¨ä½œï¼Œæˆ‘ä»¬éœ€è¦åšå“ªäº›äº‹æƒ…å‘¢ï¼Œç½—åˆ—ä¸€ä¸‹ï¼š</p><ol><li>æ–‡ä»¶å…³è”çš„inodeè¡¨æ˜äº†æ–‡ä»¶çš„åŸºæœ¬å±æ€§ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œé¢è¿½åŠ å†…å®¹çš„æ—¶å€™ï¼Œinodeçš„å¤§å°ï¼Œä¿®æ”¹æ—¶é—´ç­‰éƒ½éœ€è¦ä¿®æ”¹ï¼›è¿™ä¸ªåœ¨f2fsæ–‡ä»¶ç³»ç»Ÿé‡Œé¢å°±æ˜¯f2fs_nodeå•¦ã€‚</li><li>å½“éœ€è¦æ·»åŠ çš„å†…å®¹å¾ˆå¤§çš„æ—¶å€™ï¼Œéœ€è¦åˆ†é…é¢å¤–çš„æ•°æ®å—ï¼›åœ¨f2fsæ–‡ä»¶ç³»ç»Ÿé‡Œé¢è¡¨ç°ä¸ºData Blockä¹Ÿå°±æ˜¯Data Segmenté‡Œé¢çš„ä¸€ä¸ªä¸ªblock</li><li>åœ¨FATæ–‡ä»¶ç³»ç»Ÿé‡Œé¢é€šå¸¸ä½¿ç”¨ç°‡é“¾Cluster Chainæ¥è¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ï¼Œå½“æˆ‘ä»¬æ·»åŠ æ–‡ä»¶çš„å†…å®¹æ—¶éœ€è¦å°†åŸå…ˆæŒ‡å‘EOFçš„ClusteræŒ‡å‘æ–°å¢çš„Clusterï¼Œè€Œæ–°å¢çš„ClusteræŒ‡å‘EOFï¼›åœ¨F2fsæ–‡ä»¶ç³»ç»Ÿé‡Œé¢é€šå¸¸ä½¿ç”¨Node Blockæ¥è¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ï¼Œå½“æˆ‘ä»¬æ·»åŠ æ–‡ä»¶çš„å†…å®¹æ—¶éœ€è¦æ›´æ”¹node blocké‡Œé¢çš„i_addræˆ–è€…æŒ‡å‘çš„direct nodeå’Œindirect nodeã€‚</li><li>å¦å¤–ä¸€ä¸ªå¯¹äºF2fsæ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œåœ¨å…ƒæ•°æ®åŒºåŸŸå†…æœ‰NATï¼ŒSITå’ŒSSAåŒºåŸŸï¼Œå½“æˆ‘ä»¬æ·»åŠ æ–‡ä»¶å†…å®¹æ—¶ï¼Œéœ€è¦æ›´æ–°å…ƒæ•°æ®åŒºã€‚</li></ol><p>æˆ‘ä»¬å°†ä¸Šé¢çš„å†…å®¹è¿›è¡ŒæŠ½è±¡ï¼Œå³Inodeä¿®æ”¹ï¼ŒMetaDataä¿®æ”¹ï¼Œå’ŒData Blockä¿®æ”¹ã€‚ç”¨ä¸€ä¸ªé›†åˆè¡¨ç¤º<code>&#123;INodeï¼ŒMetadataï¼ŒDataBlock&#125;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹çš„Blockèµ·ç æ¶‰åŠ3å¤„ï¼Œå‡å¦‚åœ¨è¿™ä¸ªé›†åˆä»»æ„ä¸€å¤„å‘ç”Ÿäº†ç³»ç»Ÿå´©æºƒæˆ–è€…ç³»ç»Ÿæ–­ç”µï¼Œé‚£ä¹ˆå°†é€ æˆä¸€ä¸ªé—®é¢˜ï¼Œä¸‰ä¸ªåŒºåŸŸçš„æ•°æ®å†…å®¹å¯¹ä¸ä¸Šï¼Œè¿™æ ·å°±å¼•å‘äº†å´©æºƒä¸€è‡´æ€§é—®é¢˜ã€‚</p><hr><h2 id="è§£å†³å´©æºƒä¸€è‡´æ€§é—®é¢˜"><a href="#è§£å†³å´©æºƒä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="è§£å†³å´©æºƒä¸€è‡´æ€§é—®é¢˜"></a>è§£å†³å´©æºƒä¸€è‡´æ€§é—®é¢˜</h2><p>å´©æºƒä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨ä¸€èˆ¬çš„æ•™ç§‘ä¹¦ä¸Šï¼Œé€šå¸¸æœ‰2ç§æ–¹å¼ï¼šFSCKå’ŒJounralæœºåˆ¶ã€‚</p><ul><li>FsckåŸºæœ¬åŸç†å°±æ˜¯æ£€æŸ¥ç›®å½•é¡¹æ•°æ®ä¸å…ƒæ•°æ®æ˜¯å¦ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·çš„è¯ï¼Œé€šè¿‡ä¸€å®šçš„ç®—æ³•è¿›è¡ŒRecoveryã€è¦ä¹ˆä¿®æ”¹ç›®å½•é¡¹ä¿æŒå’Œå…ƒæ•°æ®ä¸€æ ·ï¼Œè¦ä¹ˆæ ¹æ®å…ƒæ•°æ®ä¿®æ”¹ç›®å½•é¡¹ï¼Œè¿™ä¸ªçœ‹èµ·æ¥æ˜¯åºŸè¯ï¼Œä½†æ˜¯å¯¹äºfsck.msdosè¿™å°±æ˜¯è£å‰ªç°‡é“¾æˆ–è€…æ›´æ–°ç›®å½•é¡¹çš„åŸºæœ¬æ€æƒ³ã€‘</li><li>æœ¬æ–‡ä¸æ¢è®¨Fsckï¼Œè§£å†³å´©æºƒä¸€è‡´æ€§é—®é¢˜æ¯”è¾ƒæœ‰æ•ˆçš„è¿˜æ˜¯Journalæœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å†™æ—¥å¿—ï¼Œä¹Ÿæ˜¯å€Ÿé‰´äº†æ•°æ®åº“çš„æ€æƒ³ã€‚</li></ul><blockquote><p>è¿™é‡Œå€ŸåŠ©å—å¤§è’‹ç‚å²©è€å¸ˆçš„æ€è·¯å¾€ä¸‹è¯´ï¼š</p></blockquote><p>å¯¹äºä¸€ä¸ªäºŒå‰æ ‘ï¼Œæœ‰2ä¸ªè§†è§’ï¼Œä¸€ä¸ªæ˜¯æ•°æ®ç»“æ„è§†è§’ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶æ“ä½œè§†è§’ã€‚</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230807231209215.png" alt="image-20230807231209215" style="zoom:80%;"><p>ä¸­åºéå†çš„ç»“æœä¸ºï¼š<strong>12345</strong></p><p>ä»æ–‡ä»¶æ“ä½œçš„è§’åº¦çœ‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">insert</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">insert</span> <span class="hljs-number">5</span><br><span class="hljs-keyword">insert</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">insert</span> <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®°å½•æ‰€æœ‰çš„æ–‡ä»¶æ“ä½œï¼Œåå‘è¿˜åŸå‡ºè¿™æ£µæ ‘çš„åŸæ ·ã€‚</p><hr><p><strong>ä¸¤ä¸ªâ€œè§†è§’â€</strong></p><ol><li>å­˜å‚¨å®é™…æ•°æ®ç»“æ„<ul><li>æ–‡ä»¶ç³»ç»Ÿçš„â€ç›´è§‚â€è¡¨ç¤º</li><li>crash unsafe</li></ul></li><li>Append-onlyè®°å½•æ‰€æœ‰å†å²æ“ä½œ<ul><li>â€œé‡åšâ€æ‰€æœ‰æ“ä½œå¾—åˆ°æ•°æ®ç»“æ„çš„å½“å‰çŠ¶æ€</li><li>å®¹æ˜“å®ç°å´©æºƒä¸€è‡´æ€§</li></ul></li></ol><p><strong>ä¸¤è€…çš„èåˆ</strong></p><ul><li>æ•°æ®ç»“æ„å‘ç”Ÿæ—¶ï¼Œç”¨ï¼ˆ2ï¼‰append-onlyè®°å½•æ—¥å¿—</li><li>æ—¥å¿—è½ç›˜åï¼Œç”¨ï¼ˆ1ï¼‰æ›´æ–°æ•°æ®ç»“æ„</li><li>å´©æºƒåï¼Œé‡æ”¾æ—¥å¿—å¹¶æ¸…é™¤ï¼ˆç§°ä¸ºredo logï¼›ç›¸åº”ä¹Ÿå¯ä»¥undo logï¼‰</li></ul><h2 id="æŠ½è±¡Journalè¿‡ç¨‹"><a href="#æŠ½è±¡Journalè¿‡ç¨‹" class="headerlink" title="æŠ½è±¡Journalè¿‡ç¨‹"></a>æŠ½è±¡Journalè¿‡ç¨‹</h2><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230817222646785.png" alt="image-20230817222646785" style="zoom:67%;"><ol><li><p>é€šè¿‡breadæ‰«æç£ç›˜æ‰¾åˆ°å¯ä»¥å†™å…¥æ–°çš„journalçš„èµ·å§‹ä½ç½®</p></li><li><p>å¼€å§‹bwriteå†™å…¥TxBeginï¼Œè¡¨ç¤ºäº‹åŠ¡å¼€å§‹äº†</p></li><li><p>å¼€å§‹bwriteå†™å…¥è®¸å¤šçš„æ–‡ä»¶æ“ä½œ</p></li><li><p>æ–‡ä»¶æ“ä½œå†™å®Œä¹‹åï¼Œä¸€å®šè¦å…ˆè°ƒç”¨bflushç¡®ä¿å‰é¢æ‰€æœ‰çš„æ“ä½œæ—¥å¿—è½ç›˜</p></li><li><p>bwriteå†™å…¥TxEndï¼Œè¡¨ç¤ºæ•´ä¸ªäº‹åŠ¡ç»“æŸäº†</p></li><li><p>æœ€åä¸€æ ·è¦è°ƒç”¨bflushï¼Œç¡®ä¿æ•´ä¸ªæ˜¯äº‹åŠ¡æ•°æ®éƒ½è½ç›˜äº†</p><ul><li><p>å½“å­˜åœ¨ç³»ç»Ÿå´©æºƒCrash</p></li><li><p>æ¢å¤çš„æ—¶å€™åªè¦çœ‹æœ‰æ²¡æœ‰TxEndæ ‡å¿—ï¼Œå¦‚æœæ²¡æœ‰å°±å°†æ•´ä¸ªäº‹åŠ¡Transactionå…¨éƒ¨ä¸¢å¼ƒ</p></li><li><p>åªè¦æœ‰TxEndï¼Œå°±èƒ½100%ç¡®ä¿å‰é¢çš„æ‰€æœ‰æ“ä½œæ—¥å¿—å·²ç»è½ç›˜äº†</p></li></ul></li><li><p>åé¢å°±çœŸæ­£çš„å»æ›´æ–°æ•°æ®åŒºåŸŸMain Data Areaé‡Œé¢çš„æ•°æ®å—å°±è¡Œäº†</p></li></ol><hr><p><strong>Journalingçš„ä¼˜åŒ–ï¼š</strong></p><p>ç°åœ¨ç£ç›˜éƒ½éœ€è¦å†™å…¥åŒä»½çš„æ—¥å¿—journal</p><ul><li>æ‰¹å¤„ç†(xv6;jbd)<ul><li>å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨çš„Txåˆå¹¶æˆä¸€ä¸ªï¼Œå‡å°‘logå¤§å°</li><li>jdbï¼šå®šæœŸwriteback</li></ul></li><li>CheckSum(Ext4)<ul><li>ä¸å†æ ‡è®°TxBegin&#x2F;TxEnd</li><li>ç›´æ¥æ ‡è®°Txçš„é•¿åº¦å’Œchecksum</li><li>å½“Txçš„é•¿åº¦å’Œchecksumç›¸ç­‰ï¼Œè¡¨æ˜æ˜¯ä¸€æ¬¡å®Œæ•´çš„journal</li></ul></li><li>Metadata journaling(ext4 default)<ul><li>æ•°æ®å ç£ç›˜å†™å…¥çš„ç»å¤§éƒ¨åˆ†<ul><li>åªå¯¹inodeå’Œbitmapåšjournalingå¯ä»¥æé«˜æ€§èƒ½</li></ul></li><li>ä¿è¯æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œä½†æ•°æ®å¯èƒ½ä¸¢å¤±</li></ul></li></ul><h2 id="ä¹¦é¢åŒ–çš„Journal"><a href="#ä¹¦é¢åŒ–çš„Journal" class="headerlink" title="ä¹¦é¢åŒ–çš„Journal"></a>ä¹¦é¢åŒ–çš„Journal</h2><p>âœ‰ï¸ <strong>æ‘˜æŠ„è‡ªï¼šã€Šæ“ä½œç³»ç»Ÿå¯¼è®ºã€‹</strong></p><blockquote><p>å¯¹äºä¸€è‡´æ›´æ–°é—®é¢˜ï¼Œæœ€æµè¡Œçš„è§£å†³æ–¹æ¡ˆå¯èƒ½æ˜¯ä»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„ä¸–ç•Œä¸­å€Ÿé‰´çš„ä¸€ä¸ªæƒ³æ³•ã€‚è¿™ç§åä¸ºé¢„å†™æ—¥å¿—ï¼ˆwrite-ahead loggingï¼‰çš„æƒ³æ³•ï¼Œæ˜¯ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜è€Œå‘æ˜çš„ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå‡ºäºå†å²åŸå› ï¼Œæˆ‘ä»¬é€šå¸¸å°†é¢„å†™æ—¥å¿—ç§°ä¸ºæ—¥å¿—ï¼ˆjournalingï¼‰ã€‚ç¬¬ä¸€ä¸ªå®ç°å®ƒçš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ Cedar ï¼Œä½†è®¸å¤šç°ä»£æ–‡ä»¶ç³»ç»Ÿéƒ½ä½¿ç”¨è¿™ä¸ªæƒ³æ³•ï¼ŒåŒ…æ‹¬ Linux ext3 å’Œ ext4ã€reiserfsã€IBM çš„ JFSã€SGI çš„ XFS å’Œ Windows NTFSã€‚</p></blockquote><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230817224041664.png" alt="image-20230817224041664" style="zoom:80%;"><blockquote><p>è¿™é‡Œçš„åŠ æ£€æŸ¥ç‚¹å¯èƒ½è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡ï¼Œç®€å•çš„è¯´ï¼š</p><p>æ•°æ®æ—¥å¿—ï¼ˆdata journalingï¼‰çš„å·¥ä½œåŸç†æ˜¯ï¼Œåœ¨å°† inodeã€ä½å›¾å’Œæ•°æ®å—å†™å…¥ç£ç›˜ä½ç½®ä¹‹å‰ï¼Œå…ˆå°†å®ƒä»¬å†™å…¥æ—¥å¿—ã€‚å¯¹äºè¿™ä¸ªè¯·æ±‚æ·»åŠ äº‹åŠ¡æ ‡è®°æ„æˆä¸€ä¸ªäº‹åŠ¡ï¼Œä¸€æ—¦è¿™ä¸ªäº‹åŠ¡å®‰å…¨åœ°å­˜åœ¨äºç£ç›˜ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç³»ç»Ÿä¸­æ‰“ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¡¨æ˜æ•´ä¸ªæ“ä½œæ—¥å¿—å·²ç»é¡ºåˆ©è½ç›˜äº†ã€‚æ‰“å®Œæ—¶é—´æˆ³ï¼Œå°±å¼€å§‹å°†inodeã€ä½å›¾å’Œæ•°æ®å—å†™å…¥åˆ°ç£ç›˜ã€‚è¿™ä¸ªæ•´ä¸ªè¿‡ç¨‹æˆä¸ºåŠ æ£€æŸ¥ç‚¹ï¼Œæ‰€ä»¥checkpointæ˜¯ä¸€ä¸ªè¡Œä¸ºï¼Œæ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œåœ¨f2fsæ–‡ä»¶ç³»ç»Ÿé‡Œé¢è¡¨ç°ä¸ºdo_checkpointå‡½æ•°ã€‚å½“æˆ‘ä»¬æ¢å¤çš„æ—¶å€™åªè¦æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ªæ—¶é—´æˆ³ï¼ŒæŠŠå®ƒè®°å½•çš„äº‹åŠ¡æ—¥å¿—é‡åšä¸€éå°±è¡Œã€‚</p></blockquote><blockquote><p><strong>æ•°æ®æ¢å¤çš„è¿‡ç¨‹ï¼š</strong></p><p>å¦‚æœå´©æºƒå‘ç”Ÿåœ¨äº‹åŠ¡è¢«å®‰å…¨åœ°å†™å…¥æ—¥å¿—ä¹‹å‰ï¼Œé‚£åªéœ€è¦ç®€å•åœ°è·³è¿‡å¾…æ‰§è¡Œçš„æ›´æ–°ã€‚å¦‚æœåœ¨äº‹åŠ¡å·²æäº¤åˆ°æ—¥å¿—ä¹‹åï¼Œä½†åœ¨åŠ æ£€æŸ¥ç‚¹å®Œæˆä¹‹å‰å‘ç”Ÿå´©æºƒï¼Œå¯ä»¥åœ¨ç³»ç»Ÿå¼•å¯¼æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ¢å¤è¿‡ç¨‹å°†æ‰«ææ—¥å¿—ï¼Œå¹¶æŸ¥æ‰¾å·²æäº¤åˆ°ç£ç›˜çš„äº‹åŠ¡ã€‚ç„¶åå°†è¿™äº›äº‹åŠ¡é‡æ”¾ï¼ˆreplayedï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿå†æ¬¡å°è¯•å°†äº‹åŠ¡ä¸­çš„å—å†™å…¥å®ƒä»¬æœ€ç»ˆçš„ç£ç›˜ä½ç½®ï¼Œç§°ä¸º<strong>é‡åšæ—¥å¿—ï¼ˆredo loggingï¼‰</strong>ã€‚</p></blockquote><hr><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230817223902687.png" alt="image-20230817223902687" style="zoom: 80%;"><h2 id="æ•°æ®åº“çš„å‰æ»šæ¢å¤å’Œåæ»šæ¢å¤"><a href="#æ•°æ®åº“çš„å‰æ»šæ¢å¤å’Œåæ»šæ¢å¤" class="headerlink" title="æ•°æ®åº“çš„å‰æ»šæ¢å¤å’Œåæ»šæ¢å¤"></a>æ•°æ®åº“çš„å‰æ»šæ¢å¤å’Œåæ»šæ¢å¤</h2><p><strong>æ³¨ï¼šä¸é’ˆå¯¹æŸä¸€ä¸ªå…·ä½“çš„æ•°æ®åº“ï¼Œè¿™é‡Œåªè®¨è®ºæ€æƒ³</strong></p><p><strong>å‰æ»šï¼š</strong></p><blockquote><p>æœªå®Œå…¨æäº¤çš„äº‹åŠ¡ï¼Œå³è¯¥äº‹åŠ¡å·²ç»è¢«æ‰§è¡Œcommitå‘½ä»¤äº†ï¼Œåªæ˜¯ç°åœ¨è¯¥äº‹åŠ¡ä¿®æ”¹æ‰€å¯¹åº”çš„è„æ•°æ®å—ä¸­åªæœ‰ä¸€éƒ¨åˆ†è¢«å†™åˆ°ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ä¸­ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†å·²ç»è¢«ç½®ä¸ºæäº¤æ ‡è®°çš„è„å—è¿˜åœ¨å†…å­˜ä¸Šï¼Œå¦‚æœæ­¤æ—¶æ•°æ®åº“å®ä¾‹å´©æºƒäº†ï¼Œåˆ™å½“æ•°æ®åº“å®ä¾‹æ¢å¤æ—¶ï¼Œå°±éœ€è¦ç”¨å‰æ»šï¼ˆè¿™ä¸ªæœºåˆ¶ï¼‰æ¥å®Œæˆäº‹åŠ¡çš„å®Œå…¨æäº¤ï¼Œå³å°†å…ˆå‰é‚£éƒ¨åˆ†å·²ç»è¢«ç½®ä¸ºæäº¤æ ‡è®°ä¸”è¿˜åœ¨å†…å­˜ä¸Šçš„è„å—å†™å…¥åˆ°ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ä¸­ã€‚</p></blockquote><p><strong>å›æ»šï¼ˆåæ»šï¼‰ï¼š</strong></p><blockquote><p>æœªæäº¤çš„äº‹åŠ¡ï¼Œå³è¯¥äº‹åŠ¡æœªè¢«æ‰§è¡Œcommitå‘½ä»¤ã€‚ä½†æ˜¯æ­¤æ—¶ï¼Œè¯¥äº‹åŠ¡ä¿®æ”¹çš„è„å—ä¸­ä¹Ÿæœ‰å¯èƒ½ä¸€éƒ¨åˆ†è„å—å†™å…¥åˆ°æ•°æ®æ–‡ä»¶ä¸­äº†ã€‚å¦‚æœæ­¤æ—¶æ•°æ®åº“å®ä¾‹å´©æºƒäº†ï¼Œåˆ™å½“æ•°æ®åº“å®ä¾‹æ¢å¤æ—¶ï¼Œå°±éœ€è¦ç”¨å›æ»šï¼ˆè¿™ä¸ªæœºåˆ¶ï¼‰æ¥å°†å…ˆå‰é‚£éƒ¨åˆ†å·²ç»å†™å…¥åˆ°æ•°æ®æ–‡ä»¶çš„è„å—ä»æ•°æ®æ–‡ä»¶ä¸Šæ’¤é”€æ‰ã€‚</p></blockquote><p><strong>æ•°æ®åº“Crash Recoveryè¿‡ç¨‹ï¼š</strong></p><ol><li>é¦–å…ˆè¿›è¡Œå‰æ»šï¼šåœ¨é‡åšæ—¥å¿—redologä¸­æ‰¾åˆ°æœ€è¿‘æ£€æŸ¥ç‚¹ä½ç½®ï¼Œç„¶åä»è¯¥æ£€æŸ¥ç‚¹ä½ç½®å¼€å§‹å¾€ä¸‹ï¼Œåº”ç”¨æ‰€æœ‰çš„é‡åšæ¡ç›®ï¼Œä»è€Œåœ¨buffer cacheé‡Œåˆæ¢å¤äº†å®ä¾‹å´©æºƒé‚£ä¸ªæ—¶é—´ç‚¹çš„çŠ¶æ€ã€‚è¿™ä¸ªè¿‡ç¨‹å«åšå‰æ»šï¼Œå‰æ»šå®Œæ¯•ä»¥åï¼Œbuffer cacheé‡Œæ—¢æœ‰å´©æºƒæ—¶å·²ç»æäº¤è¿˜æ²¡æœ‰å†™å…¥æ•°æ®æ–‡ä»¶çš„è„æ•°æ®å—ï¼Œä¹Ÿè¿˜æœ‰äº‹åŠ¡è¢«çªç„¶ç»ˆæ­¢ï¼Œè€Œå¯¼è‡´çš„æ—¢æ²¡æœ‰æäº¤åˆæ²¡æœ‰å›æ»šçš„äº‹åŠ¡æ‰€å¼„è„çš„æ•°æ®å—ã€‚</li><li>å‰æ»šä¸€æ—¦å®Œæ¯•ï¼Œç«‹å³æ‰“å¼€æ•°æ®åº“ã€‚ä½†æ˜¯ï¼Œè¿™æ—¶çš„æ•°æ®åº“ä¸­è¿˜å«æœ‰é‚£äº›ä¸­é—´çŠ¶æ€çš„ã€æ—¢æ²¡æœ‰æäº¤åˆæ²¡æœ‰å›æ»šçš„è„å—ï¼Œè¿™ç§è„å—æ˜¯ä¸èƒ½å­˜åœ¨äºæ•°æ®åº“ä¸­çš„ï¼Œå› ä¸ºå®ƒä»¬å¹¶æ²¡æœ‰è¢«æäº¤ï¼Œå¿…é¡»è¢«å›æ»šã€‚æ‰“å¼€æ•°æ®åº“ä»¥åï¼Œè¿›ç¨‹ä¼šåœ¨åå°è¿›è¡Œå›æ»šã€‚</li></ol><p><strong>æ•°æ®åº“Crash Recoveryç¤ºä¾‹ï¼š</strong></p><p>ç¨‹åºå‘˜åœ¨9:00:00æ‰“å¡å¼€å§‹ä¸Šç­ï¼Œè§¦å‘äº†5ä¸ªäº‹åŠ¡ï¼Œåˆ†åˆ«æ˜¯T1ï¼ŒT2ï¼ŒT3ï¼ŒT4ï¼ŒT5ã€‚åœ¨9:07:46çš„æ—¶å€™ï¼ŒT3å’ŒT5å®Œæˆï¼ˆcommitï¼‰ï¼Œåœ¨9:08:00çš„æ—¶å€™å‘ç”Ÿäº†æ£€æŸ¥ç‚¹äº‹ä»¶ï¼Œæ­¤æ—¶ç³»ç»Ÿå°†å¯¹æ•°æ®åŒºçš„æ›´æ”¹éƒ½å†™å…¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶ä¸­ï¼Œåœ¨9:08:27æ—¶ï¼Œç³»ç»Ÿå¼‚å¸¸æ–­ç”µï¼Œå› æ­¤9:08:00åˆ°9:08:27ä¹‹é—´çš„æ•°æ®æ“ä½œéƒ½ä»…ä»…è®°å½•åœ¨redo logä¸­ï¼Œå¹¶æ²¡æœ‰å°†è¿™äº›ä¿®æ”¹å†™å…¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶ä¸­ã€‚å½“é‡æ–°å¯åŠ¨æ•°æ®åº“æ—¶ï¼Œä¼šè¿›è¡ŒCrash Recoveryï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå‰æ»šå’Œåæ»šã€‚å‰æ»šæ˜¯æŒ‡9:08:00è‡³9:08:27çš„æ“ä½œé‡æ–°ä¿å­˜åˆ°Buffer Cacheä¸­ï¼Œç”±äºè¿™äº›æ“ä½œéƒ½è®°å½•åœ¨äº†redo logä¸­ï¼Œå› æ­¤åªéœ€è¦ä»redo logä¸­è¯»å–è¿™äº›æ“ä½œå¹¶æ‰§è¡Œå³å¯ã€‚å‰æ»šæ‰§è¡Œå®Œæ¯•ä»¥åï¼Œä¼šç«‹å³æ‰“å¼€æ•°æ®åº“ï¼Œæ­¤æ—¶æ•°æ®åº“åƒé±¼å¼‚å¸¸å…³é—­å‰çš„çŠ¶æ€ã€‚æ‰“å¼€æ•°æ®åº“åè¿›å…¥å›æ»šï¼Œå›æ»šé˜¶æ®µæ˜¯æŒ‡å°†æœªæäº¤çš„äº‹åŠ¡å›æ»šï¼Œå³ç¤ºä¾‹ä¸­çš„T1ã€T2å’ŒT4å›æ»šï¼Œæ­¤æ—¶æ•°æ®åº“æ¢å¤æ­£å¸¸ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼šä¸æ˜¯åªæœ‰commitæ‰ä¼šè§¦å‘å†™å…¥redo logï¼Œäº‹åŠ¡å¼€å§‹åä¼šæœ‰å„ç§åœºæ™¯è§¦å‘redo logå†™å…¥ã€‚</p></blockquote><h2 id="F2FSæ–‡ä»¶ç³»ç»ŸCheckpointæœºåˆ¶"><a href="#F2FSæ–‡ä»¶ç³»ç»ŸCheckpointæœºåˆ¶" class="headerlink" title="F2FSæ–‡ä»¶ç³»ç»ŸCheckpointæœºåˆ¶"></a>F2FSæ–‡ä»¶ç³»ç»ŸCheckpointæœºåˆ¶</h2><h3 id="f2fs-checkpointæ•°æ®ç»“æ„"><a href="#f2fs-checkpointæ•°æ®ç»“æ„" class="headerlink" title="f2fs_checkpointæ•°æ®ç»“æ„"></a>f2fs_checkpointæ•°æ®ç»“æ„</h3><p>é¦–å…ˆæˆ‘ä»¬çœ‹è®ºæ–‡ã€ŠF2FS: A New File System for Flash Storageã€‹æ€ä¹ˆè¯´çš„</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230820215948710.png" alt="image-20230820215948710" style="zoom:50%;"><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230820220002296.png" alt="image-20230820220002296" style="zoom:50%;"><p>checkpointåŒºåŸŸä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>Headerå’Œfooterï¼šåœ¨æ¯ä¸€ä¸ªcheckpoint packä¸­éƒ½æœ‰headerå’Œfooterã€‚checkpointä¼šåœ¨headerå’Œfooterä¸­éƒ½å­˜å‚¨ä¸€ä¸ªcpç‰ˆæœ¬å·ï¼Œéšç€æ¯ä¸€æ¬¡checkpointåŠ¨ä½œå‘ç”Ÿï¼Œä¼šä¾æ¬¡é€’å¢ã€‚å½“è¿›è¡ŒæŒ‚è½½çš„æ—¶å€™ï¼Œå½“cp_packä¸­çš„headerå’Œfooterç›¸ç­‰è®¤ä¸ºè¯¥cpæ˜¯æœ‰æ•ˆçš„ï¼Œå¦åˆ™å¤‡ä»½åŒºåŸŸæœ‰æ•ˆã€‚å¦‚æœä¸»å¤‡ä»½åŒºåŸŸéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œé€‰æ‹©æ—¶é—´ç‚¹æœ€è¿‘çš„ä¸€ä¸ªcpåŒºåŸŸã€‚</li><li>nat_bitmapå’Œsit_bitmapï¼šnat_bitmapè¡¨ç¤ºå½“å‰çš„blockæ˜¯åœ¨natä¸»åŒºè¿˜æ˜¯natå¤‡åŒºï¼›sit_bitmapè¡¨ç¤ºå½“å‰segmentçš„åˆ†é…æƒ…å†µã€å­˜ç–‘ï¼Œæ˜¯å¦ä¹Ÿæ˜¯ç”¨äºåŒºåˆ†ä¸»å¤‡åŒºã€‘ã€‚</li><li>nat_journalå’Œsit_journalï¼šæ˜¯natåŒºåŸŸå’ŒsitåŒºåŸŸçš„journalæ—¥å¿—ï¼Œè¯¦è§ï¼š<a href="https://anmuxixixi.github.io/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/">f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶_</a></li><li>summary blocks of active segmentsï¼š</li><li>Orphan blockï¼šå­˜æ”¾å­¤å„¿èŠ‚ç‚¹æ‰“ä¿¡æ¯ã€‚</li></ul><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¯¹åº”çš„æ•°æ®ç»“æ„ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> &#123;</span><br>    __le64 checkpoint_ver;      <span class="hljs-comment">/* checkpoint block version number */</span><br>    __le64 user_block_count;    <span class="hljs-comment">/* # of user blocks */</span><br>    __le64 valid_block_count;   <span class="hljs-comment">/* # of valid blocks in main area */</span><br>    __le32 rsvd_segment_count;  <span class="hljs-comment">/* # of reserved segments for gc */</span><br>    __le32 free_segment_count;  <span class="hljs-comment">/* # of free segments in main area */</span><br><br>    <span class="hljs-comment">/* information of current node segments */</span><br>    __le32 cur_node_segno[MAX_ACTIVE_NODE_LOGS];<br>    __le16 cur_node_blkoff[MAX_ACTIVE_NODE_LOGS];<br>    <span class="hljs-comment">/* information of current data segments */</span><br>    __le32 cur_data_segno[MAX_ACTIVE_DATA_LOGS];<br>    __le16 cur_data_blkoff[MAX_ACTIVE_DATA_LOGS];<br>    __le32 ckpt_flags;      <span class="hljs-comment">/* Flags : umount and journal_present */</span><br>    __le32 cp_pack_total_block_count;   <span class="hljs-comment">/* total # of one cp pack */</span><br>    __le32 cp_pack_start_sum;   <span class="hljs-comment">/* start block number of data summary */</span><br>    __le32 valid_node_count;    <span class="hljs-comment">/* Total number of valid nodes */</span><br>    __le32 valid_inode_count;   <span class="hljs-comment">/* Total number of valid inodes */</span><br>    __le32 next_free_nid;       <span class="hljs-comment">/* Next free node number */</span><br>    __le32 checksum_offset;     <span class="hljs-comment">/* checksum offset inside cp block */</span><br>    __le64 elapsed_time;        <span class="hljs-comment">/* mounted time */</span><br>    <span class="hljs-comment">/* allocation type of current segment */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> alloc_type[MAX_ACTIVE_LOGS];<br><br>    <span class="hljs-comment">/* SIT and NAT version bitmap */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sit_nat_version_bitmap[];<br>&#125; __packed;<br></code></pre></td></tr></table></figure><h3 id="checkpointä½œç”¨"><a href="#checkpointä½œç”¨" class="headerlink" title="checkpointä½œç”¨"></a>checkpointä½œç”¨</h3><p>çœ‹è®ºæ–‡ã€ŠF2FS: A New File System for Flash Storageã€‹æ€ä¹ˆè¯´çš„</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230820215120800.png" alt="image-20230820215120800" style="zoom:50%;"><p>ä»F2FSçš„ç£ç›˜å¸ƒå±€å¯ä»¥äº†è§£åˆ°ï¼ŒF2FSæœ‰ä¸€ä¸ªå…ƒæ•°æ®åŒºåŸŸï¼Œç”¨äºé›†ä¸­ç®¡ç†ç£ç›˜æ‰€æœ‰çš„blockçš„ä¿¡æ¯ï¼Œå› æ­¤F2FSä½¿ç”¨äº†æ£€æŸ¥ç‚¹(checkpointing)æœºåˆ¶å»ç»´æŠ¤æ–‡ä»¶ç³»ç»Ÿçš„æ¢å¤ç‚¹(recovery point)ï¼Œè¿™ä¸ªæ¢å¤ç‚¹ç”¨äºåœ¨ç³»ç»Ÿçªç„¶å´©æºƒçš„æ—¶å€™ï¼Œå…ƒæ•°æ®åŒºåŸŸä¾ç„¶èƒ½å¤Ÿæ­£ç¡®åœ°å°†æ•°æ®é‡æ–°è¯»å–å‡ºæ¥ã€‚å› æ­¤ä¿è¯å…ƒæ•°æ®åŒºåŸŸçš„æœ‰æ•ˆæ€§ä»¥åŠæ¢å¤æ€§ã€‚å½“F2FSéœ€è¦é€šè¿‡ <code>fsync</code> æˆ– <code>umount</code> ç­‰å‘½ä»¤å¯¹ç³»ç»Ÿè¿›è¡ŒåŒæ­¥çš„æ—¶å€™ï¼ŒF2FSä¼šè§¦å‘ä¸€æ¬¡Checkpointæœºåˆ¶ï¼Œå®ƒä¼šå®Œæˆä»¥ä¸‹çš„å·¥ä½œ:</p><ol><li>é¡µç¼“å­˜çš„è„nodeå’Œdentry blockä¼šåˆ·å†™å›åˆ°ç£ç›˜;</li><li>æŒ‚èµ·ç³»ç»Ÿå…¶ä»–çš„å†™è¡Œä¸ºï¼Œå¦‚createï¼Œunlinkï¼Œmkdirï¼›</li><li>å°†ç³»ç»Ÿçš„meta dataï¼Œå¦‚NATã€SITã€SSAçš„æ•°æ®å†™å›ç£ç›˜;</li><li>æ›´æ–°checkpointçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬checkpointçš„ç‰ˆæœ¬ï¼ŒNATå’ŒSITçš„bitmapsä»¥åŠjournalsï¼ŒSSAï¼ŒOrphan inode</li></ol><h3 id="åæ»šæ¢å¤åŸç†Roll-Back-Recovery"><a href="#åæ»šæ¢å¤åŸç†Roll-Back-Recovery" class="headerlink" title="åæ»šæ¢å¤åŸç†Roll-Back Recovery"></a>åæ»šæ¢å¤åŸç†Roll-Back Recovery</h3><p>çœ‹è®ºæ–‡ã€ŠF2FS: A New File System for Flash Storageã€‹æ€ä¹ˆè¯´çš„</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230727232432068.png" alt="image-20230727232432068" style="zoom: 50%;"><p>çªç„¶å‡ºç°æ–­ç”µå¼‚å¸¸ä»¥åï¼ŒF2FSä¼šå›æ»šåˆ°æœ€è¿‘çš„ä¸€æ¬¡æ£€æŸ¥ç‚¹ã€‚ä¸ºäº†ç¡®ä¿æœ€å°‘æœ‰ä¸€ä¸ªç¨³å®šçš„æ£€æŸ¥ç‚¹ï¼ŒF2fSä¼šç»´æŠ¤ä¸¤ä»½checkpoint packï¼Œå¦‚æœä¸€ä¸ªcheckpoint packçš„å¤´éƒ¨å’Œå°¾éƒ¨æ˜¯ä¸€è‡´çš„ï¼Œæˆ‘ä»¬è®¤ä¸ºä»–æ˜¯æœ‰æ•ˆçš„ï¼Œå¦åˆ™å°±ä¸¢å¼ƒå®ƒé‡Œé¢çš„å†…å®¹ã€‚</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230727232815934.png" alt="image-20230727232815934" style="zoom: 50%;"><p>åæ»šæ¢å¤å‘ç”Ÿçš„F2FSæ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™ï¼Œå®ƒä¼šå»æ£€æŸ¥checkpoint packçš„å¤´éƒ¨å’Œå°¾éƒ¨ã€‚å¦‚æœ2ä¸ªcheckpoint packéƒ½æ˜¯æœ‰æ•ˆçš„ï¼ŒF2FSä¼šæ¯”è¾ƒcp1å’Œcp2çš„ç‰ˆæœ¬ï¼Œæœ€ç»ˆä¼šé€‰æ‹©ç‰ˆæœ¬æœ€æ–°çš„é‚£ä¸€ä¸ªã€‚åŒæ—¶ä¼šå»æ£€æŸ¥é€‰æ‹©çš„cpæ˜¯å¦å­˜åœ¨å­¤å„¿èŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨ä¼šå°†å®ƒå¼•ç”¨çš„æ•°æ®å—å…¨éƒ¨æˆªæ–­ã€‚</p><hr><p>å› ä¸ºåæ»šæ¢å¤å‘ç”Ÿåœ¨äº†mounté˜¶æ®µï¼Œå…ˆç®€å•è¯´ä¸‹è°ƒç”¨è°ƒç”¨æ ˆï¼š</p><p><strong>f2fs_mount -&gt; f2fs_fill_super -&gt; f2fs_get_valid_checkpoint</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_get_valid_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span> &#123;<br>sbi-&gt;ckpt = f2fs_kvzalloc(sbi, array_size(blk_size, cp_blks),<br>  GFP_KERNEL);<br>    <br>    <span class="hljs-comment">// cp1çš„èµ·å§‹åœ°å€</span><br>cp_start_blk_no = le32_to_cpu(fsb-&gt;cp_blkaddr);<br>    <span class="hljs-comment">// è·å–cp1çš„ç‰ˆæœ¬å·ï¼ŒåŒæ—¶cp1æ˜¯ä¸€ä¸ªé¡µï¼Œå¯¹åº”äº†cpåŒºåŸŸçš„ä¸€ä¸ªblock</span><br>cp1 = validate_checkpoint(sbi, cp_start_blk_no, &amp;cp1_version);<br><br><span class="hljs-comment">// cp2çš„èµ·å§‹åœ°å€</span><br>cp_start_blk_no += ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>)<span class="hljs-number">1</span>) &lt;&lt;<br>le32_to_cpu(fsb-&gt;log_blocks_per_seg);<br>    <span class="hljs-comment">// è·å–cp2çš„ç‰ˆæœ¬å·ï¼ŒåŒæ—¶cp2æ˜¯ä¸€ä¸ªé¡µï¼Œå¯¹åº”äº†cpåŒºåŸŸçš„ä¸€ä¸ªblock</span><br>cp2 = validate_checkpoint(sbi, cp_start_blk_no, &amp;cp2_version);<br><br>    <span class="hljs-comment">// å¦‚æœ2ä¸ªcp packéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œé€‰æ‹©æœ€æ–°çš„é‚£ä¸ª</span><br><span class="hljs-keyword">if</span> (cp1 &amp;&amp; cp2) &#123;<br><span class="hljs-keyword">if</span> (ver_after(cp2_version, cp1_version))<br>cur_page = cp2;<br><span class="hljs-keyword">else</span><br>cur_page = cp1;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cp1) &#123;<br>cur_page = cp1;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cp2) &#123;<br>cur_page = cp2;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>err = -EFSCORRUPTED;<br><span class="hljs-keyword">goto</span> fail_no_cp;<br>&#125;<br><br>cp_block = (<span class="hljs-keyword">struct</span> f2fs_checkpoint *)page_address(cur_page);<br><span class="hljs-built_in">memcpy</span>(sbi-&gt;ckpt, cp_block, blk_size);  <span class="hljs-comment">// æ‹·è´åˆ°å†…å­˜ä¸­</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä¸æƒ³èŠ±å¤ªå¤šçš„ç»å†å»ç ”ç©¶æ‰€è°“çš„checksumç®—æ³•ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ç¡®ä¿å¤´éƒ¨å’Œå°¾éƒ¨æ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">validate_checkpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">block_t</span> cp_addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *version)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">cp_page_1</span> =</span> <span class="hljs-literal">NULL</span>, *cp_page_2 = <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> *<span class="hljs-title">cp_block</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> cur_version = <span class="hljs-number">0</span>, pre_version = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">// è·å–cp packä¸­page1çš„ç‰ˆæœ¬å·ã€ä¹Ÿå°±æ˜¯å¤´éƒ¨ã€‘</span><br>err = get_checkpoint_version(sbi, cp_addr, &amp;cp_block, &amp;cp_page_1, version);<br>pre_version = *version;<br><br>    <span class="hljs-comment">// è·å–cp packä¸­page2çš„ç‰ˆæœ¬å·ã€ä¹Ÿå°±æ˜¯å°¾éƒ¨ã€‘</span><br>cp_addr += le32_to_cpu(cp_block-&gt;cp_pack_total_block_count) - <span class="hljs-number">1</span>;<br>err = get_checkpoint_version(sbi, cp_addr, &amp;cp_block, &amp;cp_page_2, version);<br>cur_version = *version;<br><br>    <span class="hljs-comment">// åˆ¤æ–­å¤´éƒ¨å°¾éƒ¨æ˜¯ä¸æ˜¯ç›¸ç­‰</span><br><span class="hljs-keyword">if</span> (cur_version == pre_version) &#123;<br>*version = cur_version;<br>f2fs_put_page(cp_page_2, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">return</span> cp_page_1;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¸å»ç ”ç©¶è¿™ä¸ªcrcå€¼æ€ä¹ˆç®—çš„äº†ï¼š</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230727234038768.png" alt="image-20230727234038768" style="zoom: 67%;"><ul><li>é¦–å…ˆè·å–åˆ°cpèµ·å§‹ä½ç½®åç§»0xffcåçš„4ä¸ªå­—èŠ‚å€¼</li><li>ç„¶åè®¡ç®—cpåŒºåŸŸçš„crcå€¼</li><li>å°†è®¡ç®—å‡ºæ¥çš„å€¼å’ŒcpåŒºåŸŸä¿å­˜çš„å€¼æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­CPåŒºåŸŸçš„æ•°æ®æ˜¯ä¸æ˜¯è®°å½•å…¨äº†ï¼Œæ—¥å¿—æ˜¯ä¸æ˜¯å®Œå¤‡çš„ã€‚</li></ul><hr><p>ç®—äº†ï¼Œç®€å•è¯´ä¸€ä¸‹CPåŒºåŸŸé‡Œé¢ä¿å­˜çš„é‚£ä¸ª<strong>cpèµ·å§‹ä½ç½®åç§»0xffcåçš„4ä¸ªå­—èŠ‚å€¼</strong>æ€ä¹ˆæ¥çš„ï¼Ÿ</p><ol><li>å½“æˆ‘ä»¬æ‰§è¡Œmkfs.f2fsæ ¼å¼åŒ–ç£ç›˜çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™é‡Œ</li></ol><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230727234351910.png" alt="image-20230727234351910" style="zoom:75%;"><ol start="2"><li>è®¡ç®—CRCå€¼ä»¥åè®°å½•åˆ°å¯¹åº”çš„ä½ç½®</li></ol><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230727234432799.png" alt="image-20230727234432799" style="zoom:75%;"><h3 id="å‰æ»šæ¢å¤åŸç†Roll-Forward-Recovery"><a href="#å‰æ»šæ¢å¤åŸç†Roll-Forward-Recovery" class="headerlink" title="å‰æ»šæ¢å¤åŸç†Roll-Forward Recovery"></a>å‰æ»šæ¢å¤åŸç†Roll-Forward Recovery</h3><p>è¿˜æ˜¯å…ˆçœ‹è®ºæ–‡ã€ŠF2FS: A New File System for Flash Storageã€‹æ€ä¹ˆè¯´çš„</p><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230820214217698.png" alt="image-20230820214217698" style="zoom:50%;"><img src="/2023/07/26/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fcheckpoint%E7%89%B9%E6%80%A7/image-20230820214243206.png" alt="image-20230820214243206" style="zoom:50%;"><p>åº”ç”¨ç¨‹åºå¸¸å¸¸ä¼šè°ƒç”¨fsyncå®Œæˆä¸€äº›åŒæ­¥æ€§çš„è¯·æ±‚ï¼Œä¸ºäº†æ»¡è¶³è¿™ä¸ªåŒæ­¥æ€§çš„è¯·æ±‚ï¼Œä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯æ¯æ¬¡è°ƒç”¨fsyncéƒ½å†™ä¸€æ¬¡Checkpointã€‚ç„¶è€Œï¼Œç”±äºCheckpointéœ€è¦åŒæ—¶å†™å…¥å¤§é‡ä¸è°ƒç”¨fsyncçš„åº”ç”¨ç¨‹åºæ— å…³çš„nodeã€ dentry blockç­‰æ•°æ®ï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¤§å¼€é”€çš„æ“ä½œï¼Œä¼šå½±å“åˆ°æ‰‹æœºçš„æµç•…æ€§ã€‚</p><p>å› æ­¤ï¼ŒF2FSä½¿ç”¨äº†é«˜æ•ˆçš„å‰æ»šæ¢å¤æ–¹å¼ä»¥ä¼˜åŒ–fsyncçš„æ€§èƒ½ã€‚æ ¸å¿ƒçš„æ¦‚å¿µæ˜¯åªå†™å…¥data blockå’Œdirect nodeåˆ°ç£ç›˜ï¼Œä½†æ˜¯è€Œä¸å†™å…¥å…¶ä»–å…ƒæ•°æ®ã€‚F2FSå…·ä½“å®ç°æ˜¯åœ¨fsyncæ“ä½œå®Œæˆä¹‹åï¼Œç»™æ¯ä¸€ä¸ªç›¸å…³çš„direct nodeåŠ ä¸Šä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ä½ã€‚å½“ç³»ç»Ÿåæ»šæ¢å¤åˆ°äº†ä¸€ä¸ªç¨³å®šçš„Checkpointåï¼ŒF2FSä¼šé€‰æ‹©æ€§åœ°(é€šè¿‡æ ‡è®°ä½)é€šè¿‡å‰æ»šæ¢å¤æ¢å¤ä¸€äº›å·²ç»fsyncåˆ°ç£ç›˜ï¼Œä½†æ˜¯æ²¡æœ‰è¢«å…ƒæ•°æ®ç´¢å¼•çš„ä¸€äº›æ•°æ®ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯ï¼šå½“å®Œæˆä¸€æ¬¡å†™æ“ä½œåï¼Œéœ€è¦æ›´æ–°node pageå’Œdata blockï¼Œç„¶åæ‰§è¡Œfsyncï¼Œnode pageä»¥åŠdata blockåœ¨submit bioåå°±å®Œæˆäº†æ•°æ®å†™å…¥ç£ç›˜ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„çš„æ˜¯nat bitmapæ˜¯åœ¨checkpoitçš„åœ°æ–¹æ›´æ–°çš„ï¼Œä¼˜åŒ–åçš„fsyncï¼Œä¸ä¼šæ¯ä¸€æ¬¡fsyncéƒ½ä¼šæ‰§è¡Œcheckpointã€‚ä½†æ˜¯å¦‚æœåœ¨checkpointä¹‹å‰å‡ºç°äº†å®•æœºï¼Œè™½ç„¶node pageå’Œdata pageæœ¬èº«å·²ç»å†™å…¥äº†ç£ç›˜ï¼Œä½†æ˜¯ä¸¢å¤±äº†nat bitmapï¼Œå› æ­¤æ— æ³•ç´¢å¼•è¿™äº›å·²ç»å†™å…¥ç£ç›˜çš„node pageå’Œdata pageï¼Œè¿™æ—¶å°±è¦åˆ©ç”¨å‰æ»šæ¢å¤æœºåˆ¶ï¼Œé‡æ–°å»ºç«‹ç´¢å¼•ã€‚</p><p>å‰æ»šæ¢å¤çš„åŸç†å¦‚ä¸‹:</p><ol><li>å‡è®¾ä¸Šä¸€æ¬¡ç¨³å®šçš„Checkpointçš„æ—¥å¿—ä½ç½®æ˜¯N</li><li>F2FSæ”¶é›†äº†æ—¥å¿—ä½ç½®æ˜¯N+nçš„ï¼Œå«æœ‰ç‰¹æ®Šæ ‡è®°ä½çš„direct node blockï¼Œè¿™äº›blockä¹‹é—´ç»„æˆä¸€ä¸ªlistç”¨äºè¡¨ç¤ºnode informationï¼Œå…¶ä¸­nè¡¨ç¤ºä¸Šä¸€æ¬¡ç¨³å®šçš„Checkpointä¹‹åå†™å…¥äº†å¤šå°‘ä¸ªblockã€‚é€šè¿‡è¿™ä¸ªlistä¸­çš„node informationï¼Œç³»ç»Ÿå°†è·ç¦»ä¸Šä¸€æ¬¡ç¨³å®šçš„Checkpointæœ€é è¿‘çš„è¢«æ›´æ–°çš„node block(æ—¥å¿—ä½ç½®æ˜¯N-n)ï¼Œè½½å…¥åˆ°cacheå½“ä¸­ã€‚</li><li>æ¯”è¾ƒæ—¥å¿—ä½ç½®æ˜¯N-nå’ŒN+nçš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™ä½¿ç”¨N+nçš„æ•°æ®è¦†ç›–å·²ç»ç¼“å­˜çš„N-nçš„node blockï¼Œç„¶åæ ‡è®°ä¸ºè„ã€‚</li><li>æ‰§è¡Œå†™Checkpointæµç¨‹ï¼Œåˆ·æ–°å…ƒæ•°æ®ã€‚</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿ"></a>æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿ</h1><blockquote><p>å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/107558961">https://zhuanlan.zhihu.com/p/107558961</a></p></blockquote><h2 id="æ ¸å¿ƒæ€æƒ³"><a href="#æ ¸å¿ƒæ€æƒ³" class="headerlink" title="æ ¸å¿ƒæ€æƒ³"></a>æ ¸å¿ƒæ€æƒ³</h2><p><strong>æ—¥å¿—å¼æ–‡ä»¶ç³»ç»Ÿ ï¼ˆJournaling filesystemï¼‰</strong></p><ol><li><p>é¢„å¤‡ï¼šå½“ç³»ç»Ÿè¦å†™å…¥ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šå…ˆåœ¨æ—¥å¿—è®°å½•åŒºå—ä¸­çºªå½•æŸä¸ªæ–‡ä»¶å‡†å¤‡è¦å†™å…¥çš„ä¿¡æ¯ï¼›</p></li><li><p>å®é™…å†™å…¥ï¼šå¼€å§‹å†™å…¥æ–‡ä»¶çš„æƒé™ä¸æ•°æ®ï¼›å¼€å§‹æ›´æ–° metadata çš„æ•°æ®ï¼›</p></li><li><p>ç»“æŸï¼šå®Œæˆæ•°æ®ä¸ metadata çš„æ›´æ–°åï¼Œåœ¨æ—¥å¿—è®°å½•åŒºå—å½“ä¸­å®Œæˆè¯¥æ–‡ä»¶çš„çºªå½•ã€‚</p></li></ol><p><strong>æ—¥å¿—å¼æ–‡ä»¶çš„åŠŸèƒ½ï¼š</strong>æ•°æ®çš„è®°å½•è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿåªè¦å»æ£€æŸ¥æ—¥å¿—è®°å½•åŒºå—ï¼Œå°±å¯ä»¥çŸ¥é“å“ªä¸ªæ–‡ä»¶å‘ç”Ÿäº†é—®é¢˜ï¼Œé’ˆå¯¹è¯¥é—®é¢˜åšä¸€è‡´æ€§çš„æ£€æŸ¥ï¼Œä¸å¿…å¯¹æ•´å—filesystemå»æ£€æŸ¥ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°å¿«é€Ÿä¿®å¤filesystemçš„èƒ½åŠ›ã€‚</p><h2 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h2><p>ä½äºç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿéœ€è¦é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå½“ç³»ç»Ÿcrashæˆ–è€…æ„å¤–æ‰ç”µçš„æ—¶å€™ï¼Œå¦‚ä½•ç»´æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚æ¯”å¦‚ç°åœ¨ä¸ºäº†å®ŒæˆæŸé¡¹åŠŸèƒ½ï¼Œéœ€è¦åŒæ—¶æ›´æ–°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸¤ä¸ªæ•°æ®ç»“æ„Aå’ŒBï¼Œå› ä¸ºç£ç›˜æ¯æ¬¡åªèƒ½å“åº”ä¸€æ¬¡è¯»å†™è¯·æ±‚ï¼ŒåŠ¿å¿…é€ æˆAå’ŒBå…¶ä¸­ä¸€è€…çš„æ›´æ–°å…ˆè¢«ç£ç›˜æ¥æ”¶å¤„ç†ã€‚å¦‚æœæ­£å¥½åœ¨å…¶ä¸­ä¸€ä¸ªæ›´æ–°å®Œæˆåå‘ç”Ÿäº†æ‰ç”µæˆ–è€…crashï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆä¸ä¸€è‡´çš„çŠ¶æ€ã€‚</p><p>å‡è®¾ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿåœ¨ç£ç›˜ä¸Šçš„åˆ†å¸ƒæ˜¯è¿™æ ·çš„ï¼šå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªæ–‡ä»¶çš„inodeï¼ˆå³I[v1]ï¼‰ï¼Œdata blockï¼ˆå³Daï¼‰å’Œè®°å½•åˆ†é…çŠ¶æ€çš„inode bitmap, data bitmapã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-0d1621b2e45ee4a48f2e02cb7f9b3ba8_720w.jpeg" alt="img" style="zoom:67%;"><p>ç°åœ¨è¦åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ ä¸€éƒ¨åˆ†å†…å®¹ï¼Œé‚£ä¹ˆéœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„data blockï¼ˆå³Dbï¼‰ï¼Œè¿™ä¼šå¯¼è‡´inodeå’Œdata bitmapéƒ½å‘ç”Ÿç›¸åº”çš„å˜åŒ–ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-f26dfcb482ef977fc5ff81480b38266f_720w.webp" alt="img" style="zoom:67%;"><p>å› æ­¤éœ€è¦å¯¹ç£ç›˜çš„ä¸‰ä¸ªä¸åŒä½ç½®ï¼ˆ3ä¸ªblocksï¼‰åˆ†åˆ«è¿›è¡Œå†™æ“ä½œï¼Œå¦‚æœåœ¨è¿™ä¸‰æ¬¡å†™æ“ä½œçš„é—´éš™å‘ç”Ÿäº†crashï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°è‹¥å¹²ç§æƒ…å†µï¼šåªæ›´æ–°äº†å…¶ä¸­ä¸€ä¸ªéƒ¨åˆ†ï¼Œæˆ–è€…åªæ›´æ–°äº†å…¶ä¸­çš„ä¸¤ä¸ªéƒ¨åˆ†ã€‚</p><p>ä¼ ç»Ÿçš„Unixç³»ç»Ÿå¯¹æ­¤çš„è§£å†³åŠæ³•æ˜¯ä½¿ç”¨fsckå·¥å…·ï¼Œä½†æ˜¯fscké€šå¸¸éœ€è¦åœ¨å‘ç”Ÿcrashé‡å¯åï¼Œæ‰«ææ•´ä¸ªç£ç›˜ï¼Œç¹çä¸”é€Ÿåº¦è¾ƒæ…¢ï¼Œå› æ­¤ç›®å‰æ›´æµè¡Œçš„åšæ³•æ˜¯ä½¿ç”¨æ—¥å¿—ï¼ˆ<strong>Journaling</strong>ï¼‰ã€‚</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ€æƒ³æ˜¯è¿™æ ·çš„ï¼šåœ¨çœŸæ­£æ›´æ–°ç£ç›˜ä¸Šçš„æ•°æ®ä¹‹å‰ï¼Œå…ˆå¾€ç£ç›˜ä¸Šå†™å…¥ä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸»è¦æ˜¯æè¿°æ¥ä¸‹æ¥è¦æ›´æ–°ä»€ä¹ˆï¼Œç›¸å½“äº <strong>wrtie ahead</strong>ï¼Œå› æ­¤è¿™ç§æ–¹å¼åˆè¢«ç§°ä¸ºwrite-ahead loggingã€‚</p><p>è¿™æ ·ï¼Œå³ä¾¿å‘ç”Ÿcrashï¼Œä¹Ÿå¯é€šè¿‡è®°å½•çš„æ—¥å¿—ä¿¡æ¯ï¼Œå›æº¯å¹¶æ¢å¤crashå‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼ˆç§°ä¸º<strong>replay</strong>ï¼‰ã€‚åœ¨æ›´æ–°çš„æ—¶å€™å¢åŠ ä¸€ç‚¹é¢å¤–çš„æ“ä½œï¼Œæ¢æ¥äº†recoveryæ—¶æ‰€éœ€çš„å·¥ä½œé‡çš„å‡å°‘ã€‚</p><p>åœ¨Linuxä¸­ï¼Œext2æ–‡ä»¶ç³»ç»Ÿå°†ç£ç›˜åˆ’åˆ†æˆè‹¥å¹²ä¸ªblock groupsï¼Œæ¯ä¸ªblock groupåŒ…å«ä¸€ä¸ªinode bitmap, data bitmap, inodeså’Œè‹¥å¹²ä¸ªdata blocksï¼Œå®ƒæ²¡æœ‰ä½¿ç”¨æ—¥å¿—ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-2815b51c09d65b8aa50b604409709e7e_720w.png" alt="img" style="zoom:67%;"><p>è€Œåœ¨ext3æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ŒåŠ å…¥äº†å¯¹æ—¥å¿—çš„æ”¯æŒï¼Œæ—¥å¿—éƒ¨åˆ†å•ç‹¬å æ®ä¸€å—ç£ç›˜ç©ºé—´ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-0341a084fee9daf8237093a781776845_720w.png" alt="img" style="zoom:67%;"><p>è¿˜æ˜¯å‰é¢é‚£ä¸ªä¾‹å­ï¼Œç°åœ¨æˆ‘ä»¬è¦æ›´æ–°ç£ç›˜ä¸Šçš„inodeï¼ˆI[v2]ï¼‰, bitmapï¼ˆB[v2]ï¼‰å’Œdata block ï¼ˆDbï¼‰ã€‚åœ¨æ›´æ–°è¿™ä¸ªæ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ›´æ–°æ“ä½œçš„æ­¥éª¤ï¼ˆç§°ä¸ºä¸€ä¸ª <strong>transcation</strong>ï¼‰ï¼ŒåŠ ä¸Šåˆ†åˆ«è¡¨ç¤ºè¿™ä¸ªtranscationå¼€å§‹å’Œç»“æŸçš„TxBå’ŒTxEï¼Œå†™å…¥ç£ç›˜ã€‚</p><p>Transactionçš„æ¦‚å¿µèµ·æºäºæ•°æ®åº“é¢†åŸŸï¼Œå®ƒæœ‰åŠ©äºåœ¨æ“ä½œæœªèƒ½å®Œæˆçš„æƒ…å†µä¸‹ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚åŒä¸€transcationçš„TxBå’ŒTxEå…·æœ‰ç›¸åŒçš„sequence numberã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-610cee7e2e5d28b1484ffd19c283724b_720w.png" alt="img" style="zoom:67%;"><p>åœ¨ä¸€ä¸ªè®°å½•æ­¥éª¤ä¿¡æ¯çš„transcationå®Œæˆä¹‹åï¼Œæ‰çœŸæ­£åœ°æ›´æ–°ç£ç›˜ä¸Šçš„æ–‡ä»¶æ•°æ®ï¼ˆè¿™ä¸€æ­¥ç§°ä¸º<strong>checkpoint</strong>ï¼‰ã€‚</p><p>Journalæ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ï¼Œè€Œjournalæœ¬èº«ä¹Ÿæ˜¯ç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼Œé‚£åœ¨å†™å…¥journalçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†crashæ€ä¹ˆåŠï¼Ÿç”±äºI&#x2F;O schedulingç­‰åŸå› ï¼Œå„ä¸ªéƒ¨åˆ†ä¸ä¸€å®šæ˜¯æŒ‰ç…§æäº¤çš„é¡ºåºå†™å…¥çš„ï¼ˆout of orderï¼‰ï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°ä¸‹å›¾æ‰€ç¤ºçš„è¿™ç§æƒ…å†µï¼šç¼ºå°‘äº†Dbï¼Œä½†TxBå’ŒTxEéƒ½å­˜åœ¨ï¼Œç³»ç»Ÿæ¢å¤çš„æ—¶å€™ä¼šè¯¯ä»¥ä¸ºè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„transcationã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-e5655c491410121e939d313582cef477_720w.png" alt="img" style="zoom:67%;"><p>è§£å†³çš„åŠæ³•æ˜¯ä½¿ç”¨<strong>write barrier</strong>ã€‚å†™å…¥é™¤TxEä»¥å¤–çš„éƒ¨åˆ†åï¼ˆè¿™ä¸€æ­¥å«åš <strong>journal write</strong>ï¼‰ï¼Œæ‰§è¡Œä¸€æ¬¡barrieræ“ä½œï¼ˆå¯¹äºæ”¯æŒjournal checksumçš„ext4æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ­¥éª¤å¯çœç•¥ï¼‰ã€‚å¦‚æœåœ¨æ­¤æœŸé—´crashäº†ï¼Œç”±äºæ²¡æœ‰TxEï¼Œè¿™ä¸ªtranscationä¼šè¢«è®¤ä¸ºæ˜¯ä¸å®Œæ•´çš„ï¼Œé‡å¯åå°±ä¸ä¼šè¯•å›¾æ¢å¤è¿™ä¸ªtranscationæ‰€ä»£è¡¨çš„æ­¥éª¤ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-a752af2b794d9a74641d06f9d9c53d42_720w.png" alt="img" style="zoom:67%;"><p>å¾…journal writeé¡ºåˆ©å®Œæˆä»¥åï¼Œå†å†™å…¥TxEï¼ˆè¿™ä¸€æ­¥å«åš <strong>journal commit</strong>ï¼‰ï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡barrieræ“ä½œï¼Œä»¥ä¿è¯æ•°æ®çš„å†™å…¥æ˜¯å‘ç”Ÿåœ¨journalå®Œæˆä¹‹åï¼ˆwrite barrieråœ¨ä¿è¯æ•°æ®ä¸€ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œä¼šä¸å¯é¿å…åœ°å¯¹æ€§èƒ½é€ æˆå½±å“ï¼Œå¦‚æœèƒ½å¤Ÿæ¥å—ä¸ä½¿ç”¨barrierå¸¦æ¥çš„æ½œåœ¨é£é™©ï¼Œå¯ä»¥åœ¨mountæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ä½¿ç”¨â€nobarrierâ€é€‰é¡¹ï¼‰ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-bd63060e028328e458000e3f02821a7d_720w.png" alt="img" style="zoom:67%;"><p>å› æ­¤ï¼Œåœ¨æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„æ•°æ®å†™æ“ä½œç”±â€journal writeâ€ï¼Œâ€journal commitâ€å’Œâ€checkpointâ€ä¸‰éƒ¨åˆ†ç»„æˆã€‚å†™æ“ä½œå®Œæˆåï¼Œå°±å¯ä»¥é‡Šæ”¾journalæœ¬èº«æ‰€å æ®çš„ç£ç›˜ç©ºé—´äº†ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-02e661cc552def6708c125fa3c13a344_720w.webp" alt="img" style="zoom:67%;"><p>è‡³æ­¤ï¼Œæ¶‰åŠå¤šä¸ªblockçš„å†™æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ç®—æ˜¯æœ‰äº†ä¿è¯ï¼Œä½†è¿™åŸºäºçš„æ˜¯ä¸€ä¸ªblockçš„æ•°æ®è¦ä¹ˆå®Œå…¨å†™äº†ï¼Œè¦ä¹ˆå®Œå…¨æ²¡å†™çš„å‰æï¼Œé‚£ä¼šä¸ä¼šå‡ºç°ä¸€ä¸ªblockçš„æ•°æ®åªå†™äº†ä¸€éƒ¨åˆ†çš„æƒ…å†µå‘¢ï¼ˆhalf-writtenï¼‰ï¼Ÿè¿™å…¶å®æ˜¯ä¸€ä¸ª<strong>åŸå­æ€§</strong>çš„é—®é¢˜ï¼Œç”±ç£ç›˜æœ¬èº«æä¾›ä¿éšœï¼Œå³å¯¹ä¸€ä¸ªblockçš„æ“ä½œå¿…é¡»æ˜¯åŸå­çš„ï¼ˆä¸å¯åˆ†å‰²çš„ï¼‰ã€‚</p><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><p>journalå¥½æ˜¯å¥½ï¼Œä¸è¿‡è¦å¤šåšçš„å·¥ä½œä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œåˆ«çš„ä¸è¯´ï¼Œç£ç›˜çš„I&#x2F;Oè´Ÿè½½é¦–å…ˆå°±ä¼šè¹­è¹­åœ°ä¸Šå‡ã€‚é‚£æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ä¼˜åŒ–å—ï¼Ÿï¼ˆæ­¤å¤„çš„ã€Œä¼˜åŒ–ã€æ˜¯çœŸçš„ä¼˜åŒ–å“ˆï¼Œä¸æ˜¯å…¬å¸è£äººçš„é‚£ç§æ‰€è°“â€œä¼˜åŒ–â€ï¼‰ã€‚</p><p>ä¸€ç§æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•æ˜¯å°†å¤šä¸ªjournalçš„æ“ä½œè¿›è¡Œèšåˆå¤„ç†ï¼Œè¿™ç§batchingçš„æ€æƒ³åœ¨è½¯ä»¶è®¾è®¡ä¸­ä¹Ÿæ˜¯éšå¤„å¯è§çš„ã€‚ç»“åˆåˆ°æ—¥å¿—å‹æ–‡ä»¶ç³»ç»Ÿè‡ªèº«çš„è¿‡ç¨‹ï¼Œè¿˜å¯ä»¥å°†journalä¸­å¯¹â€Dbâ€çš„è®°å½•ç§»é™¤ï¼Œå³journalä¸­åªåŒ…å«å¯¹inodeå’Œbitmapæ›´æ–°çš„è®°å½•ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-fccba8c55b41fa08d0f581e4b716b325_720w.png" alt="img" style="zoom:67%;"><p>æ­¤æ—¶ï¼Œwrite barrieråªèƒ½ä¿è¯å¯¹meta dataï¼ˆåŒ…æ‹¬inodeå’Œbitmapï¼‰çš„çœŸå®å†™æ“ä½œå‘ç”Ÿåœ¨journalçš„å†™æ“ä½œä¹‹åï¼Œç”±äºç£ç›˜å†™æ“ä½œçš„out of orderç‰¹æ€§ï¼Œuser dataçš„çœŸå®å†™æ“ä½œåˆ™å¯èƒ½å‘ç”Ÿåœ¨æ­¤è¿‡ç¨‹ä¸­çš„ä»»ä½•èŠ‚ç‚¹ï¼Œè¿™ç§æ¨¡å¼è¢«ç§°ä¸ºâ€<strong>Writeback</strong>â€œã€‚</p><p>å…è®¸out of orderå¯¹æ€§èƒ½çš„æå‡å½“ç„¶æ˜¯æœ‰è£¨ç›Šçš„ï¼Œä½†å¦‚æœcrashæ˜¯å‘ç”Ÿåœ¨journalå†™æ“ä½œä¹‹åï¼Œmeta dataçš„çœŸå®å†™æ“ä½œä¹‹å‰ï¼ˆå‡è®¾ä¹Ÿåœ¨user dataçš„å†™æ“ä½œä¹‹å‰ï¼‰ï¼Œé‚£ä¹ˆè¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„recoveræ—¶ï¼Œmeta dataçš„å†™æ“ä½œä¼šè¢«replayï¼Œä½†æ˜¯user dataçš„å†™æ“ä½œä¸ä¼šï¼Œè¿™å°†æœ‰å¯èƒ½é€ æˆåŒä¸€æ–‡ä»¶çš„meta dataå’Œuser dataçš„ä¸ä¸€è‡´ï¼ˆå›¾1å·¦ä¾§éƒ¨åˆ†ï¼‰ã€‚</p><img src="/2023/07/26/%E6%97%A5%E5%BF%97%E5%9E%8B%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/v2-76c1b29f6675ea1e888018c85c10fd78_720w.webp" alt="img" style="zoom: 80%;"><p>ä¸è¿‡å‘¢ï¼ŒWritebackæ¨¡å¼ç›¸å¯¹å®Œå…¨ä¸ç”¨journalçš„æ¨¡å¼ï¼Œé€ æˆä¸ä¸€è‡´çš„æ¦‚ç‡é™ä½äº†ï¼Œä¸ä¸€è‡´å¸¦æ¥çš„å±å®³ä¹Ÿé™ä½äº†ï¼Œä½œä¸ºæ€§èƒ½å’Œç¨³å¥çš„å¹³è¡¡ï¼Œè¿˜æ˜¯æœ‰ç›¸å½“çš„å¯å–ä¹‹å¤„çš„ã€‚å¦‚æœæƒ³æŠŠç¨³å¥æ€§å†æé«˜ä¸€ç‚¹å‘¢ï¼Œå°±å†å¤šåšå‡ºä¸€ç‚¹é™åˆ¶ï¼šå³ä¿è¯å¯¹user dataçš„çœŸå®å†™æ“ä½œå‘ç”Ÿåœ¨journalçš„å†™æ“ä½œä¹‹å‰ï¼Œè¿™å°±æ˜¯â€<strong>Ordered</strong>â€œæ¨¡å¼ã€‚</p><p>å¯¹äºOrderedçš„æ¨¡å¼ï¼Œå¦‚æœcrashå‘ç”Ÿåœ¨user dataçš„å†™æ“ä½œä¹‹åï¼Œjournalçš„å†™æ“ä½œä¹‹å‰ï¼Œé‚£ä¹ˆå°†é€ æˆè¿™ä¸€éƒ¨åˆ†user dataçš„ä¸¢å¤±ï¼Œä¸è¿‡ä¸ä¼šé€ æˆä¸ä¸€è‡´çš„é—®é¢˜ã€‚å¦‚æœcrashå‘ç”Ÿåœ¨journalçš„å†™æ“ä½œä¹‹åï¼Œmeta dataçš„çœŸå®å†™æ“ä½œä¹‹å‰ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥é€šè¿‡replayæ¥è¿˜åŸã€‚</p><p>å¯è§ï¼Œä»â€Writebackâ€æ¨¡å¼ï¼Œåˆ°â€Orderedâ€æ¨¡å¼ï¼ˆåŒä¸º<strong>Metadata Journal</strong>ï¼‰ï¼Œå†åˆ°æœ¬æ–‡æœ€å¼€å§‹ä»‹ç»çš„åŸºæœ¬æ¨¡å¼ï¼ˆ<strong>Data Journal</strong>ï¼‰ï¼Œæ•°æ®ä¸¢å¤±å’Œä¸ä¸€è‡´çš„é£é™©æ˜¯ä¾æ¬¡é™ä½çš„ï¼Œè€Œå¯¹æ€§èƒ½çš„æŸè€—åˆ™æ˜¯ä¾æ¬¡å‡é«˜çš„ã€‚ç°ä»£çš„æ–‡ä»¶ç³»ç»Ÿé€šå¸¸ä¼šæä¾›å¤šç§æ¨¡å¼çš„é€‰æ‹©ï¼Œä¾›ä¸åŒåœºæ™¯ä¸‹çš„ç”¨æˆ·ä½¿ç”¨ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶</title>
    <link href="/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶"><a href="#f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶"></a>f2fsæ–‡ä»¶ç³»ç»ŸJournalæœºåˆ¶</h1><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/u011649400/article/details/106957151">https://blog.csdn.net/u011649400/article/details/106957151</a></p></blockquote><h2 id="Journalæœºåˆ¶çš„ä»‹ç»"><a href="#Journalæœºåˆ¶çš„ä»‹ç»" class="headerlink" title="Journalæœºåˆ¶çš„ä»‹ç»"></a>Journalæœºåˆ¶çš„ä»‹ç»</h2><p>å½“F2FSè¿›è¡Œæ–‡ä»¶è¯»å†™çš„æ—¶å€™ï¼Œæ ¹æ® f2fs_node çš„è®¾è®¡ä»¥åŠé—ªå­˜è®¾å¤‡å¼‚åœ°æ›´æ–°çš„ç‰¹æ€§ï¼Œæ¯ä¿®æ”¹ä¸€ä¸ªæ•°æ®å—ï¼Œéƒ½éœ€è¦æ”¹åŠ¨ f2fs_node çš„åœ°å€æ˜ å°„ï¼Œä»¥åŠNATï¼ŒSITç­‰ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœä»…ä»…å› ä¸ºä¸€ä¸ªå°æ”¹åŠ¨ï¼Œä¾‹å¦‚ä¿®æ”¹ä¸€ä¸ªå—ï¼Œå°±éœ€è¦æ”¹åŠ¨è¿™ä¹ˆå¤šæ•°æ®ï¼Œç„¶åå†å†™å…¥ç£ç›˜ï¼Œè¿™æ ·æ—¢ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œä¹Ÿä¼šå¯¼è‡´é—ªå­˜å¯¿å‘½çš„ä¸‹é™ã€‚</p><p>å› æ­¤F2FSè®¾è®¡äº†journalæœºåˆ¶ï¼Œç”¨äºå°†è¿™äº›å¯¹SITå’ŒNATåŒºåŸŸçš„æ•°æ®çš„ä¿®æ”¹æš‚å­˜åœ¨CheckpointåŒºåŸŸçš„ <code>f2fs_journal</code> ä¸­ï¼Œè¿™ç§è®¾è®¡å¯ä»¥<strong>å‡å°‘NATå’ŒSITçš„æ›´æ–°äº§ç”Ÿçš„å¤§é‡çš„I&#x2F;O</strong>ã€‚</p><p>äº§ç”Ÿå¤§é‡I&#x2F;Oçš„åŸå› æ˜¯ï¼Œsitå’Œnatçš„å€¼ä¼š<strong>éšæœº</strong>æ›´æ–°ï¼Œç”±äºflashçš„æœºåˆ¶ï¼Œå³ä½¿æ›´æ–°SIT&#x2F;NATå…¶ä¸­çš„ä¸€ä¸ªentryï¼Œéƒ½è¦å°†è¿™ä¸ªentryæ‰€åœ¨çš„æ•´ä¸ªNAT&#x2F;SITçš„blockè¿›è¡Œé‡å†™ã€‚å¦‚ç”¨æˆ·æ›´æ–°äº†å¤šä¸ªnode(segment)ï¼Œæ¯ä¸€ä¸ªnode&#x2F;segmentçš„æ›´æ”¹éƒ½è¦æ›´æ–°äº†å…¶ä¸­ä¸€ä¸ªentryï¼Œå³<code>f2fs_nat_entry</code>(<code>f2fs_sit_entry</code>)ã€‚å‡è®¾è¿™äº›éœ€è¦æ›´æ–°çš„entryéƒ½ä¸åœ¨é€šè¿‡ä¸€ä¸ª<code>f2fs_nat_block</code>(<code>f2fs_sit_block</code>)ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è¦å°†æ‰€æœ‰çš„blockæ›´æ–°ï¼Œä»è€Œäº§ç”Ÿå¤§é‡çš„4KBçš„I&#x2F;Oï¼Œå³ä½¿åªæ”¹åŠ¨å…¶ä¸­ä¸€ä¸ªentryã€‚</p><p>F2FSåˆ™æ˜¯é€šè¿‡journalæœºåˆ¶ï¼Œå°†è¿™äº›éšæœºæ›´æ–°çš„f2fs_nat_entry(f2fs_sit_entry)éƒ½ä¼šå°è¯•é›†ä¸­å†™åˆ°checkpointåŒºåŸŸçš„f2fs_journalå½“ä¸­ï¼Œå³æŠŠéšæœºæ›´æ–°çš„NAT&#x2F;SITçš„blockéœ€è¦æ›´æ–°çš„entryéƒ½é›†ä¸­å†™åˆ°åŒä¸€ä¸ªblockï¼Œä»è€Œå‡å°‘I&#x2F;Oçš„å†™å…¥ã€‚<strong>å¦‚æœf2fs_journalçš„ç©ºé—´è¿˜æ²¡ç”¨å°½ï¼Œç³»ç»Ÿå°±ä¼šå°†æ›´æ–°çš„NAT&#x2F;SIT entryå†™å…¥journalä¸­ï¼Œå¦‚æœè¿™äº›journalç”¨å°½äº†ï¼Œæ‰å›å†™åˆ°NAT&#x2F;SITåŒºåŸŸå½“ä¸­ã€‚</strong></p><h2 id="Journalæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„"><a href="#Journalæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„" class="headerlink" title="Journalæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„"></a>Journalæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__le16 n_nats; <span class="hljs-comment">/* è¿™ä¸ªjournalé‡Œé¢åŒ…å«å¤šå°‘ä¸ªnat_journalå¯¹è±¡ */</span><br>__le16 n_sits; <span class="hljs-comment">/* è¿™ä¸ªjournalé‡Œé¢åŒ…å«å¤šå°‘ä¸ªsit_journalå¯¹è±¡ */</span><br>&#125;;<br><span class="hljs-comment">/* spare area is used by NAT or SIT journals or extra info */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal</span> <span class="hljs-title">nat_j</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal</span> <span class="hljs-title">sit_j</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_extra_info</span> <span class="hljs-title">info</span>;</span><br>&#125;;<br>&#125; __packed;<br></code></pre></td></tr></table></figure><p><code>f2fs_journal</code> å¯ä»¥ä¿å­˜NATçš„journalä¹Ÿå¯ä»¥ä¿å­˜SITçš„journalï¼Œä»¥ä¸‹åˆ†åˆ«åˆ†æ:</p><h3 id="NAT-Journal"><a href="#NAT-Journal" class="headerlink" title="NAT Journal"></a>NAT Journal</h3><p>æ¯ä¸€ä¸ª<code>nat_journal</code>éƒ½å¯¹åº”äº†ä¸€ä¸ªnodeï¼Œè®°å½•äº†è¿™ä¸ªnodeæ˜¯å±äºå“ªä¸€ä¸ªinodeï¼Œä»¥åŠè¿™ä¸ªnodeçš„åœ¨flashè®¾å¤‡çš„ç‰©ç†åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal_entry</span> <span class="hljs-title">entries</span>[<span class="hljs-title">NAT_JOURNAL_ENTRIES</span>];</span><br>__u8 reserved[NAT_JOURNAL_RESERVED];<br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal_entry</span> &#123;</span><br>__le32 nid; <span class="hljs-comment">/* å½“å‰nodeçš„nidä¿¡æ¯ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> <span class="hljs-title">ne</span>;</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> &#123;</span><br>__u8 version;<span class="hljs-comment">/* latest version of cached nat entry */</span><br>__le32 ino;<span class="hljs-comment">/* å±äºå“ªä¸€ä¸ªinode */</span><br>__le32 block_addr;<span class="hljs-comment">/* flashè®¾å¤‡çš„ç‰©ç†åœ°å€ */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><h3 id="SIT-Journal"><a href="#SIT-Journal" class="headerlink" title="SIT Journal"></a>SIT Journal</h3><p>æ¯ä¸€ä¸ª<code>sit_journal</code>éƒ½å¯¹åº”äº†ä¸€ä¸ªsegmentï¼Œè®°å½•äº†è¯¥segmentçš„æœ‰æ•ˆblockçš„æ•°ç›® <code>vblocks</code> ä»¥åŠ å®ƒçš„åˆ†é…çŠ¶æ€bitmap <code>valid_map</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal_entry</span> <span class="hljs-title">entries</span>[<span class="hljs-title">SIT_JOURNAL_ENTRIES</span>];</span><br>__u8 reserved[SIT_JOURNAL_RESERVED];<br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal_entry</span> &#123;</span><br>__le32 segno; <span class="hljs-comment">/* å½“å‰çš„segment number */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> <span class="hljs-title">se</span>;</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> &#123;</span><br>__le16 vblocks;<span class="hljs-comment">/* æœ‰æ•ˆblockçš„æ•°ç›® */</span><br>__u8 valid_map[SIT_VBLOCK_MAP_SIZE]; <span class="hljs-comment">/* SIT_VBLOCK_MAP_SIZE=64ï¼Œ64*8=512å¯ä»¥è¡¨ç¤ºæ¯ä¸€ä¸ªå—çš„validçŠ¶æ€ */</span><br>__le64 mtime;<span class="hljs-comment">/* ç”¨äºGCçš„victim segment selection */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><h2 id="Journalæœºåˆ¶çš„å®ç°"><a href="#Journalæœºåˆ¶çš„å®ç°" class="headerlink" title="Journalæœºåˆ¶çš„å®ç°"></a>Journalæœºåˆ¶çš„å®ç°</h2><p>å‰é¢æåŠJournalæœºåˆ¶ä¸»è¦ç”¨äºå°†é¢‘ç¹çš„NATå’ŒSITçš„æ›´æ–°é›†ä¸­å†™åˆ°checkpointåŒºåŸŸçš„<code>f2fs_journal</code>ä¸­ï¼Œä»è€Œæé«˜æ€§èƒ½ï¼Œå»¶é•¿é—ªå­˜é¢—ç²’çš„å¯¿å‘½ã€‚å»åˆ†æJournalæœºåˆ¶å¦‚ä½•å®ç°æ—¶ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ†æï¼Œç³»ç»Ÿä»€ä¹ˆæ—¶å€™ä¼šè¯»å†™NATã€SITåŒºåŸŸçš„æ•°æ®:</p><ul><li><strong>NAT:</strong> æ›´æ–°ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€ï¼Œè·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€</li><li><strong>SIT:</strong> åˆ†é…segmentä¸­çš„blockï¼Œå›æ”¶segmentä¸­çš„block</li></ul><p>ğŸ”´ å› æ­¤è¿™é‡Œå…³æ³¨å¦‚ä½•è·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€ï¼Œä»¥åŠä¸€ä¸ªsegmentçš„blockåˆ†é…çŠ¶æ€ã€‚</p><h3 id="é€šè¿‡Journalè·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€"><a href="#é€šè¿‡Journalè·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€" class="headerlink" title="é€šè¿‡Journalè·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€"></a>é€šè¿‡Journalè·å–ä¸€ä¸ªnodeçš„ç‰©ç†åœ°å€</h3><p>F2FSä¸€èˆ¬æ˜¯é€šè¿‡<code>f2fs_get_node_info</code>å‡½æ•°ï¼Œæ ¹æ®ä¼ å…¥çš„nidå€¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚é¦–å…ˆä»å†…å­˜ä¸­æ‰¾ä¸€ä¸‹nidæœ‰æ²¡æœ‰cacheï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨journalå¯»å€ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰é‡‡å–NATæ‰¾ï¼Œæœ€åæ‰¾åˆ°ä¹‹åå°†è¿™ä¸ªentryçš„ä¿¡æ¯ï¼ŒåŠ å…¥åˆ°cacheä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">f2fs_get_node_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">nid_t</span> nid,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> node_info *ni)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> *<span class="hljs-title">nm_i</span> =</span> NM_I(sbi);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, CURSEG_HOT_DATA);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> *<span class="hljs-title">journal</span> =</span> curseg-&gt;journal;<br><span class="hljs-type">nid_t</span> start_nid = START_NID(nid); <span class="hljs-comment">// è®¡ç®—è¿™ä¸ªnidæ‰€åœ¨çš„f2fs_nat_blockçš„ç¬¬ä¸€ä¸ªnid</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_block</span> *<span class="hljs-title">nat_blk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> <span class="hljs-title">ne</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_entry</span> *<span class="hljs-title">e</span>;</span><br><span class="hljs-type">pgoff_t</span> index;<br><span class="hljs-type">int</span> i;<br><br>ni-&gt;nid = nid;<br><br><span class="hljs-comment">/* æ ¹æ®nidä»cacheå¯»æ‰¾ç‰©ç†åœ°å€ä¿¡æ¯ */</span><br>e = __lookup_nat_cache(nm_i, nid);<br><span class="hljs-keyword">if</span> (e) &#123; <span class="hljs-comment">// å¦‚æœæœ‰å°±è¿”å›</span><br>ni-&gt;ino = nat_get_ino(e);<br>ni-&gt;blk_addr = nat_get_blkaddr(e);<br>ni-&gt;version = nat_get_version(e);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-built_in">memset</span>(&amp;ne, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> f2fs_nat_entry));<br><br><span class="hljs-comment">/* å†å»journalæ‰¾ */</span><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * æ ¹æ®nidä»journalæ‰¾nat_entryçš„ä¿¡æ¯ï¼Œå¦‚æœ i&gt;=0 ï¼Œ</span><br><span class="hljs-comment"> * åˆ™è¡¨ç¤ºjournalæœ‰è¿™ä¸ªä¿¡æ¯ï¼Œå¦åˆ™è¡¨ç¤ºjournalä¸å­˜åœ¨è¿™ä¸ªnidçš„ä¿¡æ¯ </span><br><span class="hljs-comment"> * */</span><br>i = f2fs_lookup_journal_in_cursum(journal, NAT_JOURNAL, nid, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">0</span>) &#123;<br>ne = nat_in_journal(journal, i); <span class="hljs-comment">// å°†journalä¸­çš„nat_entryè¿”å›å‡ºæ¥</span><br>node_info_from_raw_nat(ni, &amp;ne); <span class="hljs-comment">// è¯»åˆ°node_infoä¸­</span><br>&#125;<br><span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">goto</span> cache; <span class="hljs-comment">// åœ¨journalæ‰¾åˆ°äº†ï¼Œç›´æ¥å°±è¿”å›</span><br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¦‚æœjournaléƒ½æ²¡æœ‰ï¼Œå°±è¦ä»NATè¯»å–</span><br><span class="hljs-comment"> * å…ˆæ ¹æ®è¿™ä¸ªnidè®¡ç®—ä¸€ä¸‹æ‰€å±çš„f2fs_nat_blockçš„åç§»ï¼Œå³ç‰©ç†åœ°å€</span><br><span class="hljs-comment"> * */</span><br>index = current_nat_addr(sbi, nid);<br><br><span class="hljs-comment">/* æ ¹æ®f2fs_nat_blockåç§»ï¼Œå°†ä»ç£ç›˜è¯»å–å‡ºæ¥ */</span><br>page = f2fs_get_meta_page(sbi, index); <br><span class="hljs-comment">/* å°†æ•°æ®è½¬æ¢ä¸ºf2fs_nat_blockçš„å½¢å¼ */</span><br>nat_blk = (<span class="hljs-keyword">struct</span> f2fs_nat_block *)page_address(page);<br><span class="hljs-comment">/* start_nidæ˜¯è¿™ä¸ªnat_blockçš„ç¬¬ä¸€ä¸ªnidï¼Œ</span><br><span class="hljs-comment"> * å‡å»å®ƒå°±å¯ä»¥æ‰¾å‡ºå½“å‰nidåœ¨nat_blockå†…çš„åç§»ï¼Œç„¶åéƒ½å–å‡ºæ¥ </span><br><span class="hljs-comment"> * */</span><br>ne = nat_blk-&gt;entries[nid - start_nid];<br><span class="hljs-comment">/* æ ¹æ®è¯»å–å‡ºæ¥çš„entryè½¬ä¸ºä¸ºneçš„å€¼ï¼Œè¿”å›ç»™è°ƒç”¨å‡½æ•° */</span><br>node_info_from_raw_nat(ni, &amp;ne);<br>f2fs_put_page(page, <span class="hljs-number">1</span>);<br>cache:<br><span class="hljs-comment">/* å¦‚æœcacheä¸å­˜åœ¨è‡ªç„¶è¦ç¼“å­˜ä¸€ä¸‹åˆ°å†…å­˜ä¸­ */</span><br>cache_nat_entry(sbi, nid, &amp;ne); <span class="hljs-comment">// ç¼“å­˜è¿™ä¸ªnode_entry</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„å‡½æ•°<strong>current_nat_addr</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">pgoff_t</span> <span class="hljs-title function_">current_nat_addr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-type">nid_t</span> start)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nm_info</span> *<span class="hljs-title">nm_i</span> =</span> NM_I(sbi);<br><span class="hljs-type">pgoff_t</span> block_off;<br><span class="hljs-type">pgoff_t</span> block_addr;<br><br>    <span class="hljs-comment">// è®¡ç®—åç§»é‡</span><br>block_off = NAT_BLOCK_OFFSET(start);<br><br>    <span class="hljs-comment">// è®¡ç®—åœ¨ä¸»åŒºä¸­çš„åç§»é‡</span><br>block_addr = (<span class="hljs-type">pgoff_t</span>)(nm_i-&gt;nat_blkaddr +<br>(block_off &lt;&lt; <span class="hljs-number">1</span>) -<br>(block_off &amp; (sbi-&gt;blocks_per_seg - <span class="hljs-number">1</span>)));<br><br>    <span class="hljs-comment">// nat_bitmapæŒ‡æ˜æ˜¯åœ¨ä¸»åŒºè¿˜æ˜¯å¤‡åŒº</span><br>    <span class="hljs-comment">// å¦‚æœåœ¨å¤‡åŒºï¼Œè¿˜è¦åŠ ä¸Šblocks_per_seg</span><br><span class="hljs-keyword">if</span> (f2fs_test_bit(block_off, nm_i-&gt;nat_bitmap))<br>block_addr += sbi-&gt;blocks_per_seg;<br><br><span class="hljs-keyword">return</span> block_addr;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä¸ªNATåŒºåŸŸçš„å¸ƒå±€ä¸ºï¼š</p><blockquote><p>æ¥æºï¼š<a href="https://blog.csdn.net/geshifei/article/details/126390920">https://blog.csdn.net/geshifei/article/details/126390920</a></p></blockquote><img src="/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/e70cb7105d434b019d36cf0992dd232f.jpeg" alt="img" style="zoom:80%;"><p>æˆ‘ä»¬å‡è®¾å½“å‰çš„éœ€è¦çŸ¥é“<strong>nid&#x3D;233870</strong>å¯¹åº”çš„ç‰©ç†Blockä½ç½®ï¼Œ</p><p>ï¼ˆ1ï¼‰æ ¹æ®<code>#define NAT_BLOCK_OFFSET(start_nid) ((start_nid) / NAT_ENTRY_PER_BLOCK)</code>ç®—å‡ºblock_offä¸º514</p><p>ï¼ˆ2ï¼‰é‚£ä¹ˆå®ƒåº”è¯¥åœ¨ç¬¬2ä¸ªSegmentçš„ç¬¬2ä¸ªä½ç½®ï¼Œä¹Ÿå°±æ˜¯<strong>åç§»1026ä½ç½®</strong></p><img src="/2023/07/23/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FJournal%E6%9C%BA%E5%88%B6/image-20230723223652646.png" alt="image-20230723223652646" style="zoom:67%;"><p>ï¼ˆ3ï¼‰æˆ‘ä»¬éœ€è¦å°†åç§»é‡block_off &lt;&lt; 1ï¼ˆä¹˜2ï¼‰ï¼Œå› ä¸ºå¤šç®—äº†å®ƒåœ¨å¤‡ä»½åŒºåŸŸé‡Œé¢çš„æ•°é‡ï¼Œæ‰€ä»¥å‡å»<strong>block_off &amp; (sbi-&gt;blocks_per_seg - 1)</strong></p><p>ï¼ˆ4ï¼‰å³nat_blkaddr + 514 Ã— 2 - (514 &amp; 511) &#x3D; nat_blkaddr  + 1028 - 2 &#x3D; <strong>nat_blkaddr + 1026</strong></p><h3 id="é€šè¿‡Journalè·å–ä¸€ä¸ªsegmentçš„blockåˆ†é…çŠ¶æ€"><a href="#é€šè¿‡Journalè·å–ä¸€ä¸ªsegmentçš„blockåˆ†é…çŠ¶æ€" class="headerlink" title="é€šè¿‡Journalè·å–ä¸€ä¸ªsegmentçš„blockåˆ†é…çŠ¶æ€"></a>é€šè¿‡Journalè·å–ä¸€ä¸ªsegmentçš„blockåˆ†é…çŠ¶æ€</h3><p>F2FSä¸€èˆ¬æ˜¯é€šè¿‡get_seg_entryå‡½æ•°æ ¹æ®segment number(segno)è·å–å¯¹åº”çš„entryã€‚ç”±äºsegmentçš„entryçš„æ•°ç›®æ¯”node entryå°‘å¾ˆå¤šï¼Œæ‰€ä»¥F2FSå°†æ‰€æœ‰çš„segmentçš„entryéƒ½è¯»å…¥äº†å†…å­˜ï¼Œå‚è€ƒ<a href="https://blog.csdn.net/u011649400/article/details/102490983">Segmentç»“æ„</a>è¿™ä¸€èŠ‚ã€‚å› æ­¤ç³»ç»Ÿä¸­è¯»å–segmeng entryçš„çŠ¶æ€æ˜¯ç®€å•çš„æ•°ç»„è®¿é—®:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* seg_entryæ˜¯f2fs_sit_entryçš„å†…å­˜ç»“æ„ï¼ŒåŒæ ·è®°å½•äº†vblock valid_bitmapç­‰ä¿¡æ¯ */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> seg_entry *<span class="hljs-title function_">get_seg_entry</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_info</span> *<span class="hljs-title">sit_i</span> =</span> SIT_I(sbi); <span class="hljs-comment">// è·å–segmentçš„å†…å­˜ç®¡ç†ç»“æ„</span><br><span class="hljs-keyword">return</span> &amp;sit_i-&gt;sentries[segno]; <span class="hljs-comment">// æ ¹æ®segnoè¿”å›entry</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>f2fsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</title>
    <link href="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/"/>
    <url>/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="f2fsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"><a href="#f2fsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€" class="headerlink" title="f2fsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"></a>f2fsæ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</h1><p>ğŸ’Œ æ„Ÿè°¢<a href="https://blog.csdn.net/jasonactions/article/details/122409327">HZero.chen</a>ï¼Œè®©æˆ‘å¯¹f2fsæ–‡ä»¶ç³»ç»Ÿçš„å¸ƒå±€æœ‰äº†æ›´æ·±åˆ»çš„è®¤è¯†~æ–‡ç« è®¸å¤šå›¾ç‰‡éƒ½æ¥æ¥è‡ªäºä»–çš„æ–‡ç« ï¼Œä»…ä½œæœ¬äººå­¦ä¹ å¤‡å¿˜</p><h2 id="1-å‡†å¤‡å®éªŒç¯å¢ƒ"><a href="#1-å‡†å¤‡å®éªŒç¯å¢ƒ" class="headerlink" title="1.å‡†å¤‡å®éªŒç¯å¢ƒ"></a>1.å‡†å¤‡å®éªŒç¯å¢ƒ</h2><p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªé•œåƒï¼Œå°†å…¶æ ¼å¼åŒ–ä¸ºf2fsæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸loopè®¾å¤‡è¿›è¡Œç»‘å®šï¼Œéšåè¿›è¡ŒæŒ‚è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install -y f2fs-tools             // å®‰è£…f2fså·¥å…·<br><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=f2fs.img bs=4K count=51200  // åˆ›å»º200Mçš„f2fs.img<br>mkfs.f2fs -l f2fs f2fs.img                     // æ ¼å¼åŒ–ä¸ºf2fs<br>sudo losetup /dev/loop0 f2fs.img               // å°†loop0ä¸f2fs.imgç»‘å®šã€å¯ä»¥é€šè¿‡losetup -fæŸ¥çœ‹å½“å‰ç©ºé—²loopè®¾å¤‡ã€‘<br>sudo mount /dev/loop0 ./mntf2fs/               // å°†loop0è¿›è¡ŒæŒ‚è½½<br></code></pre></td></tr></table></figure><p>ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„f2fsæ–‡ä»¶ç³»ç»Ÿçš„flashè®¾å¤‡ï¼Œæˆ‘ä»¬å¾€é‡Œé¢æ”¾ä¸€äº›ææ–™</p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719212612079.png" alt="image-20230719212612079" style="zoom: 80%;"><ul><li>foo.txtæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢åªæœ‰ä¸€å¥è¯å°±æ˜¯hello amx</li><li>meinv.jpgæ˜¯ä¸€ä¸ªjpgæ ¼å¼çš„å›¾ç‰‡ï¼Œå¤§å°çº¦ä¸º5.40Mb</li></ul><h2 id="2-æ•´ä½“å¸ƒå±€"><a href="#2-æ•´ä½“å¸ƒå±€" class="headerlink" title="2.æ•´ä½“å¸ƒå±€"></a>2.æ•´ä½“å¸ƒå±€</h2><blockquote><p>è¿™å¼ å›¾æ¥è‡ªäºè®ºæ–‡ï¼šã€Š<strong>F2FS: A New File System for Flash Storage</strong>ã€‹</p></blockquote><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 80%;"><p>å¯ä»¥çœ‹åˆ°æ•´ä½“å¸ƒå±€æ˜¯å¸¸è§„çš„æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€æ–¹å¼ï¼š<strong>è¶…çº§å— + å…ƒæ•°æ®åŒº + ç”¨æˆ·æ•°æ®åŒº</strong>ï¼›</p><ul><li>å…ƒæ•°æ®åŒºåˆ†ä¸ºäº†CPã€SITã€NATã€SSAå››ä¸ªåŒºåŸŸï¼Œè¿™å››ä¸ªåŒºåŸŸéƒ½æ˜¯ä»¥Segmentä¸ºå•ä½è¿›è¡Œå¯¹é½çš„ã€‚</li><li>å› f2fsä¸ºæ—¥å¿—ç»“æ„æ–‡ä»¶ç³»ç»ŸLFSï¼Œæ‰€ä»¥å…¶ç”¨æˆ·æ•°æ®åŒºä¹Ÿç§°ä¸ºæ—¥å¿—åŒºMain Areaã€‚f2fsä¸åŒäºä¼ ç»Ÿçš„LFSå°†æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ—¥å¿—é‡Œé¢ï¼Œf2fså°†å…¶åˆ’åˆ†ä¸ºäº†Node Segmentå’ŒData Segmentï¼Œåˆæ ¹æ®å…¶æ˜¯å¦ç»å¸¸æ”¹åŠ¨åˆ’åˆ†ä¸ºäº†Hotã€Warmå’ŒColdï¼Œå› æ­¤æ€»å…±æ˜¯6ç§å½¢å¼ã€‚</li></ul><hr><p><strong>f2fsåŸºæœ¬æ•°æ®å•ä½</strong></p><ul><li><strong>block</strong>: F2FSçš„æ•°æ®å­˜å‚¨çš„åŸºæœ¬å•ä½æ˜¯blockï¼Œå¤§å°ä¸º4KBï¼Œæ•´ä¸ªflashè®¾å¤‡è¢«æ ¼å¼åŒ–ä¸ºå¤šä¸ªblockç»„æˆçš„ç»“æ„ã€‚å¾ˆå¤šæ•°æ®ç»“æ„ä¹Ÿè¢«è®¾è®¡ä¸º4KBçš„å¤§å°ï¼Œè¿™æ˜¯å› ä¸ºå¾ˆå¤šflashè®¾å¤‡å•æ¬¡IOçš„è¯»å†™éƒ½æ˜¯åŸºäº4KBçš„å€æ•°è¿›è¡Œã€‚</li><li><strong>segment</strong>: segmentæ˜¯ç®¡ç†blockçš„ç»“æ„ï¼Œä¸€ä¸ªsegmentçš„å¤§å°æ˜¯512ä¸ªblockï¼Œä¹Ÿå°±æ˜¯2MBã€‚</li><li><strong>section</strong>: é»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªsegmentç­‰äºä¸€ä¸ªsectionï¼Œsectionæ˜¯GCçš„åŸºæœ¬æ“ä½œå•ä½ï¼Œæ¯æ¬¡GCéƒ½ä¼šä»sectionä¸­é€‰å‡ºç‰¹å®šçš„segmentè¿›è¡Œå›æ”¶ã€‚F2FSå°†sectionåˆ†ä¸ºäº†6ç±»ï¼Œåˆ†åˆ«æ˜¯hot-nodeï¼Œwarm-nodeï¼Œcold-nodeï¼Œhot-dataï¼Œwarm-dataï¼Œcold-dataï¼Œhot-&gt;coldè¡¨ç¤ºäº†æ•°æ®çš„ä»é«˜åˆ°ä½çš„ä¿®æ”¹é¢‘ç‡ï¼Œé€šè¿‡ä¸åŒç±»å‹sectionï¼šè¿›è¡Œgcçš„æ—¶å€™å¯é’ˆå¯¹ä½¿ç”¨hotçš„sectionè¿›è¡Œgcï¼Œä»¥é™ä½gcçš„æ—¶é—´å¼€é”€ã€‚</li><li><strong>zone</strong>: é»˜è®¤æƒ…å†µä¸€ä¸ªzoneç­‰äºä¸€ä¸ªsectionï¼Œä¸ç‰©ç†è®¾å¤‡æœ‰å…³ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ç”¨ä¸ä¸Š</li></ul><h3 id="2-1-è¶…çº§å—SuperBlock"><a href="#2-1-è¶…çº§å—SuperBlock" class="headerlink" title="2.1 è¶…çº§å—SuperBlock"></a>2.1 è¶…çº§å—SuperBlock</h3><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œf2fsçš„superblockä¸æ˜¯ä»0x0å¼€å§‹ï¼Œè€Œæ˜¯é¢„ç•™äº†1KBï¼Œå³å…¶åç§»é‡ä¸º0x400</p><blockquote><p>è¯»è€…å¯ä»¥é€šè¿‡<strong>hexdump</strong>å‘½ä»¤æŸ¥çœ‹supeblockæˆ–è€…é€šè¿‡<strong>ultra edit</strong>æ‰‹åŠ¨æŸ¥çœ‹</p></blockquote><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719213848821.png" alt="image-20230719213848821" style="zoom:80%;"><p>ğŸ”´ <strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬è¿™é‡Œåªå…³æ³¨Diskæœ¬èº«çš„å¸ƒå±€æ–¹å¼ï¼Œè€Œä¸å…³æ³¨å…¶åœ¨å†…å­˜ä¸­çš„è¡¨ç°å½¢å¼ï¼</p><p>å…¶å¯¹åº”äº†<code>f2fs_super_block</code>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_super_block</span> &#123;</span><br>__le32 magic;<span class="hljs-comment">/* Magic Number */</span><br>__le16 major_ver;<span class="hljs-comment">/* Major Version */</span><br>__le16 minor_ver;<span class="hljs-comment">/* Minor Version */</span><br>__le32 log_sectorsize;<span class="hljs-comment">/* log2 sector size in bytes */</span><br>__le32 log_sectors_per_block;<span class="hljs-comment">/* log2 # of sectors per block */</span><br>__le32 log_blocksize;<span class="hljs-comment">/* log2 block size in bytes */</span><br>__le32 log_blocks_per_seg;<span class="hljs-comment">/* log2 # of blocks per segment */</span><br>__le32 segs_per_sec;<span class="hljs-comment">/* # of segments per section */</span><br>__le32 secs_per_zone;<span class="hljs-comment">/* # of sections per zone */</span><br>__le32 checksum_offset;<span class="hljs-comment">/* checksum offset inside super block */</span><br>__le64 block_count;<span class="hljs-comment">/* total # of user blocks */</span><br>__le32 section_count;<span class="hljs-comment">/* total # of sections */</span><br>__le32 segment_count;<span class="hljs-comment">/* total # of segments */</span><br>__le32 segment_count_ckpt;<span class="hljs-comment">/* # of segments for checkpoint */</span><br>__le32 segment_count_sit;<span class="hljs-comment">/* # of segments for SIT */</span><br>__le32 segment_count_nat;<span class="hljs-comment">/* # of segments for NAT */</span><br>__le32 segment_count_ssa;<span class="hljs-comment">/* # of segments for SSA */</span><br>__le32 segment_count_main;<span class="hljs-comment">/* # of segments for main area */</span><br>__le32 segment0_blkaddr;<span class="hljs-comment">/* start block address of segment 0 */</span><br>__le32 cp_blkaddr;<span class="hljs-comment">/* start block address of checkpoint */</span><br>__le32 sit_blkaddr;<span class="hljs-comment">/* start block address of SIT */</span><br>__le32 nat_blkaddr;<span class="hljs-comment">/* start block address of NAT */</span><br>__le32 ssa_blkaddr;<span class="hljs-comment">/* start block address of SSA */</span><br>__le32 main_blkaddr;<span class="hljs-comment">/* start block address of main area */</span><br>__le32 root_ino;<span class="hljs-comment">/* root inode number */</span><br>__le32 node_ino;<span class="hljs-comment">/* node inode number */</span><br>__le32 meta_ino;<span class="hljs-comment">/* meta inode number */</span><br>__u8 uuid[<span class="hljs-number">16</span>];<span class="hljs-comment">/* 128-bit uuid for volume */</span><br>__le16 volume_name[MAX_VOLUME_NAME];<span class="hljs-comment">/* volume name */</span><br>__le32 extension_count;<span class="hljs-comment">/* # of extensions below */</span><br>__u8 extension_list[F2FS_MAX_EXTENSION][F2FS_EXTENSION_LEN];<span class="hljs-comment">/* extension array */</span><br>__le32 cp_payload;<br>__u8 version[VERSION_LEN];<span class="hljs-comment">/* the kernel version */</span><br>__u8 init_version[VERSION_LEN];<span class="hljs-comment">/* the initial kernel version */</span><br>__le32 feature;<span class="hljs-comment">/* defined features */</span><br>__u8 encryption_level;<span class="hljs-comment">/* versioning level for encryption */</span><br>__u8 encrypt_pw_salt[<span class="hljs-number">16</span>];<span class="hljs-comment">/* Salt used for string2key algorithm */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_device</span> <span class="hljs-title">devs</span>[<span class="hljs-title">MAX_DEVICES</span>];</span><span class="hljs-comment">/* device list */</span><br>__le32 qf_ino[F2FS_MAX_QUOTAS];<span class="hljs-comment">/* quota inode numbers */</span><br>__u8 hot_ext_count;<span class="hljs-comment">/* # of hot file extension */</span><br>__le16  s_encoding;<span class="hljs-comment">/* Filename charset encoding */</span><br>__le16  s_encoding_flags;<span class="hljs-comment">/* Filename charset encoding flags */</span><br>__u8 reserved[<span class="hljs-number">306</span>];<span class="hljs-comment">/* valid reserved region */</span><br>__le32 crc;<span class="hljs-comment">/* checksum of superblock */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><ul><li><strong>ç¬¬ä¸€ä¸ªSuperBlock(sb#1)å¦‚ä¸‹æ‰€ç¤ºã€åç§»0x400ã€‘ï¼š</strong></li></ul><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><ul><li><strong>ç¬¬äºŒä¸ªSuperBlock(sb#2)å¦‚ä¸‹æ‰€ç¤ºã€åç§»0x1400ã€‘ï¼š</strong></li></ul><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><blockquote><p>ä»¥ä¸‹å†…å®¹æ¥è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/634651371">https://zhuanlan.zhihu.com/p/634651371</a></p></blockquote><ul><li><p><strong>magic</strong>ï¼šf2fsçš„é­”æ•°å­—ï¼Œç”¨æ¥æ£€æŸ¥SuperBlockæ˜¯å¦ç ´æŸï¼Œå…¶å†…å®¹å›ºå®šä¸º0xF2F52010ã€‚</p></li><li><p><strong>major_verã€minor_ver</strong>ï¼šè¿™ä¸¤ä¸ªæ˜¯Linuxç”¨äºæ ‡è¯†ä¸€ä¸ªå—è®¾å¤‡çš„ä¸»æ¬¡å·ï¼Œä¸»æ¬¡å·å¯ä»¥ç¡®å®šç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªå—è®¾å¤‡ã€‚</p></li><li><p><strong>log_sectorsize</strong>ï¼šå—è®¾å¤‡ä¸­ä¸€ä¸ªæ‰‡åŒºå¤§å°ï¼Œæ™®é€šè®¾å¤‡æ˜¯512ï¼Œæ­¤å¤„æ˜¯å¯¹2å–å¯¹æ•°åçš„ç»“æœï¼Œæ‰€ä»¥æ˜¯9ã€‚</p></li><li><p><strong>log_sectors_per_block</strong>ï¼šä¸€ä¸ªblockå¯¹åº”æ‰‡åŒºæ•°ï¼Œå¹¶å¯¹2å–å¯¹æ•°åçš„ç»“æœï¼Œä¸€ä¸ªblockæ˜¯4KBï¼Œè€Œsectoræ˜¯512ï¼Œæ‰€ä»¥ç»“æœæ˜¯3ã€‚</p></li><li><p><strong>log_blocksize</strong>ï¼šä¸€ä¸ªblockå¤§å°å¯¹2å–å¯¹æ•°çš„ç»“æœï¼Œä¹Ÿå³log2(4096)ï¼Œç»“æœæ˜¯12ã€‚</p></li><li><p><strong>log_blocks_per_seg</strong>ï¼šä¸€ä¸ªsegmentå¯¹åº”çš„blockæ•°ç›®ï¼Œå¹¶å¯¹2å–å¯¹æ•°çš„ç»“æœï¼Œç»“æœæ˜¯9ã€‚</p></li><li><p><strong>segs_per_secã€secs_per_zone</strong>ï¼šåˆ†åˆ«æ˜¯ä¸€ä¸ªsectionå¯¹åº”çš„segmengæ•°é‡å’Œä¸€ä¸ªzoneå¯¹åº”çš„sectionæ•°é‡ï¼Œé»˜è®¤ä¸¤è€…å‡ä¸º1ã€‚</p></li><li><p><strong>crc_offsetã€crc</strong>ï¼šSuperBlockä¸­çš„crcå­—æ®µåç§»é‡ï¼Œcrcåˆ™æ˜¯è¯¥SuperBlockç»“æ„ä½“çš„crcè®¡ç®—ç»“æœï¼Œç”¨äºæ£€æŸ¥SuperBlockçš„æ­£ç¡®æ€§ã€‚å…¶ä¸­è¿™ä¸¤ä¸ªå­—æ®µç”±F2FS_FEATURE_SB_CHKSUMæ ‡è®°ä½æ§åˆ¶ï¼Œå¦‚æœè®¾ç½®äº†è¯¥æ ‡è®°ï¼Œmkfsæ‰ä¼šçœŸæ­£å†™å…¥è¿™ä¸¤ä¸ªå­—æ®µçš„å†…å®¹ã€‚</p></li><li><p><strong>block_count</strong>ï¼šæ•´ä¸ªå—è®¾å¤‡çš„blockä¸ªæ•°ï¼Œéœ€è¦åš4KBå¯¹é½ï¼Œå¦‚æœå¯¹åº”å¤šä¸ªè®¾å¤‡ï¼Œè®¡ç®—çš„æ˜¯æ‰€æœ‰è®¾å¤‡çš„blockä¸ªæ•°ã€‚</p></li><li><p><strong>section_count</strong>ï¼šMain Areaå¯¹åº”çš„sectionä¸ªæ•°ï¼Œå¦‚æœæ˜¯å¤šè®¾å¤‡ï¼Œéœ€è¦å…¨éƒ¨è®¡ç®—ã€‚</p></li><li><p><strong>segment_count_ckpt</strong>ï¼šCPåŒºåŸŸæ‰€å çš„segmentæ•°ï¼ŒCPåŒºåŸŸå›ºå®šå 2ä¸ªsegmentã€‚</p></li><li><p><strong>segment_count_sit</strong>ï¼šSITåŒºåŸŸæ‰€å ç”¨çš„segmentæ•°ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®segment_countçš„å€¼ç¡®å®šçš„ï¼Œä¸€ä¸ªf2fs_sit_entryç»“æ„ä½“å 74å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªblockå¯å®¹çº³56ä¸ªf2fs_sit_entryï¼Œä¹Ÿå³ä¸€ä¸ªsegmentå¯å®¹çº³28672ä¸ªf2fs_sit_entryï¼Œå¯¹åº”çš„æ˜¯56Gã€‚ä½†ç”±äºSITæœ‰ä¸€ä¸ªå¤‡ä»½åŒºåŸŸï¼Œæ‰€ä»¥æ¯56Gçš„å¤§å°å°±éœ€è¦2ä¸ªsegmentã€‚æ³¨æ„ï¼šSITåŒºåŸŸç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰çš„segmentï¼ŒåŒ…æ‹¬CPåŒºåŸŸå’ŒSITåŒºåŸŸè‡ªèº«ã€‚</p></li><li><p><strong>segment_count_nat</strong>ï¼šNATåŒºåŸŸæ‰€å ç”¨çš„segmentæ•°ï¼Œå¯¹åº”çš„æ˜¯ä»NATåŒºåŸŸå¼€å§‹çš„æ‰€æœ‰blockï¼ˆåŒ…æ‹¬NATã€SSAã€Nodeã€DataåŒºåŸŸï¼‰ã€‚ä¸€ä¸ªf2fs_nat_entryå¤§å°æ˜¯9å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªblockå¯¹åº”455ä¸ªf2fs_nat_entryã€‚åŒæ ·ï¼ŒNATåŒºåŸŸä¹Ÿæœ‰ä¸€ä¸ªå¤‡ä»½åŒºã€‚</p></li><li><p><strong>segment_count_ssa</strong>ï¼šSSAåŒºåŸŸæ‰€å ç”¨çš„segmengæ•°ï¼Œä¸€ä¸ªSSA Blockå¯¹åº”çš„æ˜¯ä¸€ä¸ªsegmentä¿¡æ¯ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSSAåŒºåŸŸä¸»è¦æ˜¯ç”¨äºGCæµç¨‹çš„ï¼Œå¦‚æœf2fsåœ¨mkfsçš„æ—¶å€™æŒ‡å®šäº†åªè¯»å±æ€§ï¼Œé‚£ä¹ˆè¯¥åŒºåŸŸä¹Ÿå°±æ²¡å¿…è¦çš„ã€‚å¯¹åº”çš„æ˜¯ä»SSAåŒºåŸŸå¼€å§‹çš„æ‰€æœ‰segmentçš„ç®¡ç†ã€‚SSAåŒºåŸŸä¸åšå¤‡ä»½ã€‚</p></li><li><p><strong>segment_count_main</strong>ï¼šMain AreaåŒºåŸŸå¯¹åº”çš„segmentæ•°ï¼ŒåŒ…æ‹¬Nodeå’ŒDataçš„åŒºåŸŸã€‚</p></li><li><p><strong>segment0_blkaddr</strong>ï¼šç¬¬ä¸€ä¸ªsegmentçš„å¼€å§‹å¯¹åº”çš„blockå·ï¼Œæ³¨æ„ï¼šæœ¬æ¥ç¬¬ä¸€ä¸ªsegmentåº”è¯¥å¯¹åº”çš„æ˜¯SuperBlockï¼Œä½†æ˜¯f2fsæ˜¯ä»CPåŒºåŸŸå¼€å§‹å¯¹segmentè¿›è¡Œç¼–ç çš„ï¼Œæ‰€ä»¥å¯¹åº”çš„æ˜¯CPåŒºåŸŸçš„å¼€å§‹blockã€‚</p></li><li><p>â­<strong>cp_blkaddr</strong>ï¼šCPåŒºåŸŸçš„èµ·å§‹blockå·ï¼Œå’Œsegment0_blkaddrä¸€æ ·ã€‚</p></li><li><p>â­<strong>sit_blkaddr</strong>ï¼šSITåŒºåŸŸçš„èµ·å§‹blockå·ã€‚</p></li><li><p>â­<strong>nat_blkaddr</strong>ï¼šNATåŒºåŸŸçš„èµ·å§‹blockå·ã€‚</p></li><li><p>â­<strong>ssa_blkaddr</strong>ï¼šSSAåŒºåŸŸçš„èµ·å§‹blockå·ã€‚</p></li><li><p>â­<strong>main_blkaddr</strong>ï¼šMain Areaå¼€å§‹çš„blockå·ã€‚</p></li><li><p><strong>root_inoã€meta_inoã€node_ino</strong>ï¼šåˆ†åˆ«æ˜¯root inodeå·ï¼Œå›ºå®šæ˜¯3ï¼›å…ƒæ•°æ®inodeå·ï¼Œå›ºå®šæ˜¯2ï¼›Nodeå¯¹åº”çš„inodeå·ï¼Œå›ºå®šæ˜¯1ã€‚å…¶ä¸­root_inoæ˜¯æ ¹ç›®å½•çš„inodeå·ï¼Œåœ¨æ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ˜¯æ—¶å€™åˆå§‹åŒ–ï¼Œè€Œmeta_inoåˆ™å¯¹åº”å…ƒæ•°æ®åŒºåŸŸï¼Œç¼“å­˜å…ƒæ•°æ®çš„page cacheï¼›node_inoåˆ™å¯¹åº”çš„æ˜¯æ‰€æœ‰nodeçš„page cache</p></li><li><p><strong>uuid</strong>ï¼šéšæœºå€¼ç›å€¼ï¼Œç”¨äºè®¡ç®—inodeçš„crcã€‚</p></li><li><p><strong>volume_name</strong>ï¼šåˆ†åŒºåã€‚</p></li><li><p><strong>extension_list</strong>ï¼šå¯ä»¥é€šè¿‡ioctlè®¾å®šå°†å“ªäº›æ–‡ä»¶æ ‡è®°ä¸ºcoldï¼Œä¸€èˆ¬æ˜¯è¯»å¤šå†™å°‘çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼šmp3ã€gifç­‰ç­‰</p></li><li><p><strong>version</strong>ï¼šmkfsæ—¶çš„linuxçš„ç‰ˆæœ¬å·ã€‚</p></li><li><p><strong>feature</strong>ï¼šmkfsæŒ‡å®šçš„ç‰¹æ€§åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼šåŠ å¯†ã€SuperBlockçš„crcæ£€æŸ¥ç­‰ç­‰ã€‚&#x2F;sys&#x2F;fs&#x2F;f2fs&#x2F;features&#x2F;è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„ç‰¹æ€§ã€‚</p></li><li><p><strong>encrypt_pw_salt</strong>ï¼šå¯†é’¥çš„åŠ å¯†ç›å€¼ï¼Œå¯é€šè¿‡ioctlè·å–ã€‚</p></li><li><p><strong>devs</strong>ï¼šæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„è®¾å¤‡åˆ—è¡¨ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½æœ‰å„è‡ªçš„åœ°å€è®¿é—®ï¼Œåœ¨å†™æ•°æ®çš„æ—¶å€™éœ€è¦éå†æ‰€æœ‰è®¾å¤‡ã€‚</p></li><li><p><strong>s_encodingã€s_encoding_flags</strong>ï¼šæ–‡ä»¶åç¼–ç æ ¼å¼ï¼Ÿ</p></li><li><p><strong>s_stop_reason</strong>ï¼šCPåœæ­¢çš„åŸå› ï¼ˆCPå¤±è´¥çš„åŸå› ï¼Ÿï¼‰</p></li><li><p><strong>s_errors</strong>ï¼šæ–‡ä»¶ç³»ç»ŸæŸåçš„åŸå› ã€‚</p></li></ul><h3 id="2-2-CheckPoint"><a href="#2-2-CheckPoint" class="headerlink" title="2.2 CheckPoint"></a>2.2 CheckPoint</h3><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><blockquote><p>å¦‚ä¸Šä¸ºcp blockçš„æ€»ä½“å¸ƒå±€ï¼Œåˆ†ä¸ºä¸¤ç§ï¼š<strong>nomal mode</strong>å’Œ<strong>compact mode</strong>.é€šè¿‡é•œåƒå¯çŸ¥ï¼Œæœ¬æ–‡åˆ›å»ºçš„é•œåƒçš„CPä¸ºcompact mode<br>ckpt_flagsçš„å€¼æ˜¯5ï¼Œé€šè¿‡ckpt_flags &amp; CP_COMPACT_SUM_FLAGçš„å€¼ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œå®ƒå°±æ˜¯compact mode.<br>cpåŒºåŸŸä¸»è¦åŒ…å«ä¸¤ä¸ªcp packï¼Œæ¯ä¸ªcp packå æ®ä¸€ä¸ªsegmentã€‚</p></blockquote><h4 id="2-2-1-cp-page-1"><a href="#2-2-1-cp-page-1" class="headerlink" title="2.2.1 cp page 1"></a>2.2.1 cp page 1</h4><p>å…¶å¯¹åº”çš„æ•°æ®ç»“æ„ä¸º<code>f2fs_checkpoint</code>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> &#123;</span><br>__le64 checkpoint_ver;<span class="hljs-comment">/* checkpoint block version number */</span><br>__le64 user_block_count;<span class="hljs-comment">/* # of user blocks */</span><br>__le64 valid_block_count;<span class="hljs-comment">/* # of valid blocks in main area */</span><br>__le32 rsvd_segment_count;<span class="hljs-comment">/* # of reserved segments for gc */</span><br>__le32 overprov_segment_count;<span class="hljs-comment">/* # of overprovision segments */</span><br>__le32 free_segment_count;<span class="hljs-comment">/* # of free segments in main area */</span><br><br><span class="hljs-comment">/* information of current node segments */</span><br>__le32 cur_node_segno[MAX_ACTIVE_NODE_LOGS];<br>__le16 cur_node_blkoff[MAX_ACTIVE_NODE_LOGS];<br><span class="hljs-comment">/* information of current data segments */</span><br>__le32 cur_data_segno[MAX_ACTIVE_DATA_LOGS];<br>__le16 cur_data_blkoff[MAX_ACTIVE_DATA_LOGS];<br>__le32 ckpt_flags;<span class="hljs-comment">/* Flags : umount and journal_present */</span><br>__le32 cp_pack_total_block_count;<span class="hljs-comment">/* total # of one cp pack */</span><br>__le32 cp_pack_start_sum;<span class="hljs-comment">/* start block number of data summary */</span><br>__le32 valid_node_count;<span class="hljs-comment">/* Total number of valid nodes */</span><br>__le32 valid_inode_count;<span class="hljs-comment">/* Total number of valid inodes */</span><br>__le32 next_free_nid;<span class="hljs-comment">/* Next free node number */</span><br>__le32 sit_ver_bitmap_bytesize;<span class="hljs-comment">/* Default value 64 */</span><br>__le32 nat_ver_bitmap_bytesize; <span class="hljs-comment">/* Default value 256 */</span><br>__le32 checksum_offset;<span class="hljs-comment">/* checksum offset inside cp block */</span><br>__le64 elapsed_time;<span class="hljs-comment">/* mounted time */</span><br><span class="hljs-comment">/* allocation type of current segment */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> alloc_type[MAX_ACTIVE_LOGS];<br><br><span class="hljs-comment">/* SIT and NAT version bitmap */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sit_nat_version_bitmap[<span class="hljs-number">1</span>];<br>&#125; __packed;<br></code></pre></td></tr></table></figure><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><blockquote><p>ä¸Šé¢ä¸ºHZero.chenåšå®¢ä¸­çš„æ•°æ®ï¼Œä¸‹é¢æ˜¯æˆ‘è‡ªå·±å®éªŒçš„æ•°æ®</p></blockquote><hr><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719233445458.png" alt="image-20230719233445458" style="zoom:67%;"><ul><li><p><strong>checkpoint_ver</strong>ï¼š0x69d7b561</p></li><li><p><strong>user_block_count</strong>ï¼š0x7a00(31232)ï¼Œ4096&#x2F;512&#x3D;8ä¸ªsegment,è€Œmain areaæœ‰56ä¸ªsegmentï¼Œå…¶å®ƒ48ä¸ªsegmentä¸ºoverprovision segment</p></li><li><p><strong>valid_block_count</strong>ï¼š0x56d(1389)</p></li><li><p><strong>rsvd_segment_count</strong>ï¼š0x15(31)ï¼Œä¿ç•™äº†21ä¸ªsegment</p></li><li><p><strong>overprov_segment_count</strong>ï¼š0x1f(31)</p></li><li><p><strong>free_segment_count</strong>ï¼š0x54(84)</p></li><li><p><strong>cur_node_segno</strong></p><ul><li>0x01ã€0x02</li></ul></li></ul><p>â€”-cur_node_blkoffâ€”-<br>0x00000006<br>0x0000000C<br>0x00000000</p><p>â€”-cur_data_segnoâ€”-<br>0x00000034<br>0x00000001<br>0x00000000|</p><p>â€”-cur_data_blkoffâ€”-<br>0x00000005<br>0x00000003<br>0x00000001</p><p>ckpt_flags:0x5</p><p>cp_pack_total_block_count:0x6</p><p>cp_pack_start_sum:0x1</p><p>valid_node_count:0x5</p><p>valid_inode_count:0x5</p><p>next_free_nid:0x8</p><p>sit_ver_bitmap_bytesize:0x40</p><p>nat_ver_bitmap_bytesize:0x40</p><p>checksum_offset:0xffc</p><p>elapsed_time:40</p><p>allocation type of current segment<br>0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|<br>0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|0x00000000|<br>0x00000000|0x00000000|</p><p>sit_nat_version_bitmap:0x0</p><p>&#x2F;&#x2F; TODO</p><h4 id="2-2-2-NAT-Journal"><a href="#2-2-2-NAT-Journal" class="headerlink" title="2.2.2 NAT Journal"></a>2.2.2 NAT Journal</h4><p>åœ¨f2fsä¸­å­˜åœ¨journalæœºåˆ¶ï¼Œé€šè¿‡è”åˆä½“<code>f2fs_journal</code>è¡¨ç¤ºï¼Œæ‰€ä»¥å®ƒæ—¢å¯ä»¥è¡¨ç¤ºNATï¼Œåˆå¯ä»¥è¡¨ç¤ºSIT</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__le16 n_nats;<br>__le16 n_sits;<br>&#125;;<br><span class="hljs-comment">/* spare area is used by NAT or SIT journals or extra info */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal</span> <span class="hljs-title">nat_j</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal</span> <span class="hljs-title">sit_j</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_extra_info</span> <span class="hljs-title">info</span>;</span><br>&#125;;<br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆä»¥NATä¸ºä¾‹ï¼Œå‰é¢16ä½å°ç«¯ä¸ºnatsï¼Œåé¢çš„æ˜¯nat_journalç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal_entry</span> <span class="hljs-title">entries</span>[<span class="hljs-title">NAT_JOURNAL_ENTRIES</span>];</span><br>__u8 reserved[NAT_JOURNAL_RESERVED];<br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nat_journal_entry</span> &#123;</span><br>__le32 nid;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> <span class="hljs-title">ne</span>;</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> &#123;</span><br>__u8 version;<span class="hljs-comment">/* latest version of cached nat entry */</span><br>__le32 ino;<span class="hljs-comment">/* inode number */</span><br>__le32 block_addr;<span class="hljs-comment">/* block address */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>è¯´ç™½äº†é‡Œé¢å­˜å‚¨çš„ä¹Ÿæ˜¯<strong>f2fs_nat_entry</strong></p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719234855034.png" alt="image-20230719234855034" style="zoom:67%;"><p>å‰é¢2ä¸ªå­—èŠ‚0x05è¡¨ç¤ºnatsï¼Œéšåçš„4ä¸ªå­—èŠ‚0x00000003è¡¨ç¤ºçš„æ˜¯nidï¼Œåé¢å³ä½¿f2fs_nat_entryç»“æ„ä½“äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">00            version      0x00<br>00 00 00 03   ino          0x03(3)<br>00 00 10 04   block_addr   0x1004(4100)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸€èˆ¬ä¼š<strong>dump.f2fs -n 0~-1 f2fs.img</strong>æŸ¥çœ‹natçš„ä¿¡æ¯ï¼Œç»“æœä¼šä¿å­˜åœ¨<code>dump_nat</code>ä¸­</p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719235441702.png" alt="image-20230719235441702" style="zoom:67%;"><p>ä»¥ç¬¬ä¸€ä¸ª<strong>nid:3</strong>ä¸ºä¾‹ï¼Œä¸ä¸Šé¢çš„nat journalå®Œç¾çš„å¯¹ä¸Šäº†ï¼ŒåŒç†è¿™é‡Œé¢çš„ä¿¡æ¯éƒ½ä¸nat journalä¸€ä¸€å¯¹åº”ã€‚</p><h4 id="2-2-3-SIT-Journal"><a href="#2-2-3-SIT-Journal" class="headerlink" title="2.2.3 SIT Journal"></a>2.2.3 SIT Journal</h4><p>å¦‚2.2.2æ‰€è¯´ï¼Œf2fs_journalç»“æ„ä½“æ—¢èƒ½è¡¨ç¤ºnatï¼Œä¹Ÿèƒ½è¡¨ç¤ºsitã€å› ä¸ºå†…éƒ¨æˆå‘˜æ˜¯è”åˆä½“ã€‘ï¼Œé‚£ä¹ˆè¿™è¾¹åº”è¯¥è¡¨ç¤ºçš„æ˜¯sit</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal_entry</span> <span class="hljs-title">entries</span>[<span class="hljs-title">SIT_JOURNAL_ENTRIES</span>];</span><br>__u8 reserved[SIT_JOURNAL_RESERVED];<br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sit_journal_entry</span> &#123;</span><br>__le32 segno;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> <span class="hljs-title">se</span>;</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> &#123;</span><br>__le16 vblocks;<span class="hljs-comment">/* reference above */</span><br>__u8 valid_map[SIT_VBLOCK_MAP_SIZE];<span class="hljs-comment">/* bitmap for valid blocks */</span><br>__le64 mtime;<span class="hljs-comment">/* segment age for cleaning */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>è¯´ç™½äº†é‡Œé¢å­˜å‚¨çš„ä¹Ÿæ˜¯<strong>f2fs_sit_entry</strong></p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230719235854137.png" alt="image-20230719235854137" style="zoom:67%;"><h3 id="2-3-SIT"><a href="#2-3-SIT" class="headerlink" title="2.3 SIT"></a>2.3 SIT</h3><p>SITåŒºåŸŸç”±Nä¸ªstruct f2fs_sit_blockç»„æˆï¼Œæ¯ä¸€ä¸ªstruct f2fs_sit_blockåŒ…å«äº†55ä¸ªstruct f2fs_sit_entryï¼Œæ¯ä¸€ä¸ªentryå¯¹åº”äº†ä¸€ä¸ªsegmentçš„ç®¡ç†çŠ¶æ€ã€‚æ¯ä¸€ä¸ªentryåŒ…å«äº†ä¸‰ä¸ªå˜é‡: vblocks(è®°å½•è¿™ä¸ªsegmentæœ‰å¤šå°‘ä¸ªblockå·²ç»è¢«ä½¿ç”¨äº†)ï¼Œvalid_map(è®°å½•è¿™ä¸ªsegmenté‡Œé¢çš„å“ªä¸€äº›blockæ˜¯æ— æ•ˆçš„)ï¼Œmtime(è¡¨ç¤ºä¿®æ”¹æ—¶é—´)ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_block</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> <span class="hljs-title">entries</span>[<span class="hljs-title">SIT_ENTRY_PER_BLOCK</span>];</span><br>&#125; __packed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_sit_entry</span> &#123;</span><br>__le16 vblocks;<span class="hljs-comment">/* reference above */</span><br>__u8 valid_map[SIT_VBLOCK_MAP_SIZE];<span class="hljs-comment">/* bitmap for valid blocks */</span><br>__le64 mtime;<span class="hljs-comment">/* segment age for cleaning */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230724233134094.png" alt="image-20230724233134094" style="zoom:67%;"><p><strong>æ³¨æ„åˆ°å†…æ ¸ä»£ç é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æ³¨é‡Šï¼š</strong></p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230724232829641.png" alt="image-20230724232829641" style="zoom: 67%;"><p>åœ¨f2fs_sit_entryçš„ç¬¬ä¸€ä¸ªå­—æ®µvblockså…¶ä»£è¡¨çš„å«ä¹‰ä¸ºï¼š</p><ul><li><p>**[15:10]**è¡¨ç¤ºå½“å‰Segmentç±»å‹æ˜¯å±äºå“ªä¸€ç§ï¼ŒHOT&#x2F;WARM&#x2F;COLD * NODE&#x2F;DATA</p></li><li><p>**[9:0]**è¡¨ç¤ºæœ‰æ•ˆå—çš„æ•°é‡</p></li><li><p>è¿™2ä¸ªå€¼ä¹Ÿå¯¹åº”äº†<strong>dump_sit</strong>ä¸­çš„å€¼</p></li></ul><hr><p>é¦–å…ˆæˆ‘ä»¬éªŒè¯ä¸€ä¸‹ä¸Šé¢çš„æ³¨é‡Šæ˜¯å¦æ˜¯æ­£ç¡®çš„ï¼š</p><p>è§‚å¯Ÿåˆ°ç¬¬ä¸€ä¸ªSegment 0çš„å‰2ä¸ªå­—èŠ‚ä¸º0xc01 &#x3D; 0000 1100 0000 0001ï¼Œå…¶<strong>é«˜[15:10]ä½ä¸º0000 11 &#x3D;  3ï¼Œä½[9:0]ä½ä¸º00 0000 0001 &#x3D; 1</strong>ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„dump_sitä¸­<strong>segno: 0</strong>å¯¹åº”çš„<strong>seg_type: 3</strong>ï¼Œ<strong>vblocks: 1</strong></p><p>é€šè¿‡<strong>dump.f2fs -s 0~-1 f2fs.img</strong> çœ‹ä¸€ä¸‹SITçš„æ•´ä½“æƒ…å†µ</p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230724232531598.png" alt="image-20230724232531598" style="zoom:67%;"><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œè§‚å¯Ÿ<strong>segno: 9</strong>ï¼Œå‘ç°å®ƒæ˜¯ä¸€ä¸ªWarm Nodeï¼Œ</p><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230724233756028.png" alt="image-20230724233756028" style="zoom:80%;"><p>è¿™ä¸ªsegmentåç§»é‡ä¸º9ï¼Œå‰é¢å·²ç»æœ‰9ä¸ªSegmentäº†ï¼Œä¸€ä¸ªSegmentä¸º2MBï¼Œè€ŒMain Areaçš„èµ·å§‹ä½ç½®ä¸º<strong>0x100000</strong>ï¼Œæ‰€ä»¥</p><ul><li><strong>SegNo 9</strong>çš„ç‰©ç†èµ·å§‹åœ°å€ä¸ºï¼š<strong>0x20000(2M) * 0x9 + 0x100000 &#x3D; 0x1300000</strong></li></ul><p>åˆæ³¨æ„åˆ°e0è¿™ä¸ªä½ç½®å‰é¢æ€»å…±59ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯472Bitï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ˜¯ä¸€ä¸ªä½å›¾ï¼Œå…¶ä»£è¡¨äº†å‰472ä¸ªBlockéƒ½æ˜¯æ— æ•ˆçš„ï¼Œå…¶å¤§å°æ€»å…±ä¸ºï¼š</p><ul><li><strong>472 * 4096 &#x3D; 1,933,312Byte  &#x3D; 0x1D8000</strong></li></ul><p>ä¸‹é¢å¼€å§‹çœ‹0xe0(11100000)å…¶è¡¨ç¤ºäº†ä»ç¬¬472ä¸ªBlockå¼€å§‹çš„8ä¸ªå—ï¼Œå…¶ä¸­ç¬¬472ï¼Œ473ï¼Œ474ä¸ªBlockæ˜¯æœ‰æ•ˆçš„ï¼Œæ€»å…±3ä¸ªï¼Œè¿™ä¹ŸéªŒè¯äº†dump_sitçš„vblocksä¸º3ã€‚</p><ul><li>è®¡ç®—å‡ºç¬¬472ä¸ªBlockçš„ä½ç½®ä¸º<strong>0x1300000 + 0x1D8000 &#x3D; 0x14D8000</strong></li></ul><h3 id="2-4-NAT"><a href="#2-4-NAT" class="headerlink" title="2.4 NAT"></a>2.4 NAT</h3><img src="/2023/07/19/f2fs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80/image-20230723231428571.png" alt="image-20230723231428571" style="zoom:80%;"><p>è¿™é‡Œä¸€å¼€å§‹æˆ‘å¾ˆå¥‡æ€ªï¼Œä¸ºå•¥è¿™é‡Œåªæœ‰3ä¸ªinodeï¼Œå³node_ino:1ã€meta_ino:2ã€root_ino:3ï¼Œé‚£å…¶ä½™æ–‡ä»¶çš„inodeå»å“ªé‡Œäº†ï¼Œä¸æ˜¯è¯´NATç»´æŠ¤äº†ä¸€å¼ inode noå’Œblock addrçš„è¡¨å—ã€‚</p><p>è¿™é‡Œå…¶å®æ˜¯ç”±äºJournalæœºåˆ¶ï¼Œä¸ºäº†ä¸é¢‘ç¹è¯»å†™NATï¼Œæ‰€ä»¥å°†natçš„æ”¹åŠ¨å…ˆå­˜æ”¾åœ¨äº†nat journalä¸­ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆnat journalå’ŒNATåŒºåŸŸéƒ½æ˜¯æŒ‰ç…§<strong>f2fs_nat_entry</strong> æ’å¸ƒçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_nat_entry</span> &#123;</span><br>__u8 version;<span class="hljs-comment">/* latest version of cached nat entry */</span><br>__le32 ino;<span class="hljs-comment">/* inode number */</span><br>__le32 block_addr;<span class="hljs-comment">/* block address */</span><br>&#125; __packed;<br></code></pre></td></tr></table></figure><p>åªæœ‰å½“nat journalåŒºåŸŸæ’‘æ»¡äº†æ”¾ä¸ä¸‹äº†ï¼Œæ‰ä¼šåˆ·å†™åˆ°ç£ç›˜å¯¹åº”çš„NATåŒºåŸŸä¸­ã€‚</p><hr><p>æˆ‘ä»¬åšä¸ªå®éªŒï¼Œå†™ä¸€ä¸ªshellè„šæœ¬<code>f2fs.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>for i in &#123;1..2000&#125;<br>do<br>fileName=&quot;hello&quot;$&#123;i&#125;<br>touch /home/amx/Desktop/f2fs/mntf2fs/$&#123;fileName&#125;.txt<br>echo &quot;hello amx&quot;$&#123;i&#125; &gt;&gt; /home/amx/Desktop/f2fs/mntf2fs/$&#123;fileName&#125;.txt<br>done<br></code></pre></td></tr></table></figure><blockquote><p>åŠŸèƒ½å°±æ˜¯åˆ›å»º2000ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºhello[i]ï¼Œå‘é‡Œé¢å†™å…¥hello amx[i]</p></blockquote><p>æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œå†æ¬¡<code>hexdump -C -s 0xA00000 -n 2097152 f2fs.img</code>å°±å¯ä»¥çœ‹åˆ°NATåŒºåŸŸå·²ç»æ›´æ–°äº†ã€å¦‚æœæ²¡æ›´æ–°ï¼Œå°±æŠŠforå¾ªç¯æ¬¡æ•°æ”¾å¤§ã€‘ã€‚åç»­ç›´æ¥ <strong>rm -rf hello</strong>*åˆ æ‰è¿™äº›æ–‡ä»¶å³å¯</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å—è®¾å¤‡é©±åŠ¨</title>
    <link href="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/"/>
    <url>/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="å—è®¾å¤‡é©±åŠ¨"><a href="#å—è®¾å¤‡é©±åŠ¨" class="headerlink" title="å—è®¾å¤‡é©±åŠ¨"></a>å—è®¾å¤‡é©±åŠ¨</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://mshrimp.github.io/2020/04/19/Linux%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/">https://mshrimp.github.io/2020/04/19/Linux%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/</a></p></blockquote><h2 id="1-å—è®¾å¤‡ç»“æ„"><a href="#1-å—è®¾å¤‡ç»“æ„" class="headerlink" title="1.å—è®¾å¤‡ç»“æ„"></a>1.å—è®¾å¤‡ç»“æ„</h2><p><strong>æ®µï¼ˆSegmentsï¼‰</strong>ï¼šç”±è‹¥å¹²ä¸ªå—ç»„æˆï¼›æ˜¯Linuxå†…å­˜ç®¡ç†æœºåˆ¶ä¸­ä¸€ä¸ªå†…å­˜é¡µæˆ–å†…å­˜é¡µçš„ä¸€éƒ¨åˆ†ï¼›</p><p><strong>å—ï¼ˆBlocksï¼‰</strong>ï¼šç”±Linuxåˆ¶å®šå¯¹å†…æ ¸æˆ–æ–‡ä»¶ç³»ç»Ÿç­‰æ•°æ®å¤„ç†çš„åŸºæœ¬å•ä½ï¼›é€šå¸¸é€šå¸¸ä¸º4096ä¸ªå­—èŠ‚ï¼Œç”±1ä¸ªæˆ–å¤šä¸ªæ‰‡åŒºç»„æˆï¼›</p><p><strong>æ‰‡åŒºï¼ˆSectorsï¼‰</strong>ï¼šå—è®¾å¤‡çš„åŸºæœ¬å•ä½ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šçš„ç¡¬ä»¶å•ä½ï¼Œåˆ¶å®šäº†è®¾å¤‡æœ€å°‘èƒ½å¤Ÿä¼ è¾“çš„æ•°æ®é‡ï¼›é€šå¸¸åœ¨512å­—èŠ‚åˆ°32768å­—èŠ‚ä¹‹é—´ï¼Œé»˜è®¤ï¼š512å­—èŠ‚ï¼›</p><p>å—æ˜¯è¿ç»­æ‰‡åŒºçš„åºåˆ—ï¼Œå—é•¿åº¦æ€»æ˜¯æ‰‡åŒºé•¿åº¦çš„æ•´æ•°å€ï¼›å—çš„æœ€å¤§é•¿åº¦ï¼Œå—ç‰¹å®šä½“ç³»ç»“æ„çš„å†…å­˜é¡µé•¿åº¦é™åˆ¶ï¼›</p><p>å—è®¾å¤‡ä½¿ç”¨è¯·æ±‚é˜Ÿåˆ—ï¼Œç¼“å­˜å¹¶é‡æ’è¯»å†™æ•°æ®å—çš„è¯·æ±‚ï¼Œç”¨é«˜æ•ˆçš„æ–¹å¼è¯»å–æ•°æ®ï¼›å—è®¾å¤‡çš„æ¯ä¸ªè®¾å¤‡éƒ½å…³è”äº†è¯·æ±‚é˜Ÿåˆ—ï¼›å¯¹å—è®¾å¤‡çš„è¯»å†™è¯·æ±‚ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè¿™äº›è¯·æ±‚ä¼šæ±‡æ€»èµ·æ¥ï¼Œç»è¿‡ååŒä¹‹åä¼ è¾“åˆ°è®¾å¤‡ï¼›</p><h2 id="2-å—è®¾å¤‡é©±åŠ¨æ¡†æ¶"><a href="#2-å—è®¾å¤‡é©±åŠ¨æ¡†æ¶" class="headerlink" title="2.å—è®¾å¤‡é©±åŠ¨æ¡†æ¶"></a>2.å—è®¾å¤‡é©±åŠ¨æ¡†æ¶</h2><img src="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/å—è®¾å¤‡é©±åŠ¨æ¶æ„å›¾.jpg" alt="å—è®¾å¤‡é©±åŠ¨æ¶æ„å›¾" style="zoom:80%;"><hr><img src="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/100045938-83907-1.png" alt="img" style="zoom:67%;"><ul><li>å—è®¾å¤‡çš„åº”ç”¨åœ¨Linuxä¸­æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­ç³»ç»Ÿã€‚</li><li>åœ¨Linuxä¸­ï¼Œé©±åŠ¨å¯¹å—è®¾å¤‡çš„è¾“å…¥æˆ–è¾“å‡º(I&#x2F;O)æ“ä½œï¼Œéƒ½ä¼šå‘å—è®¾å¤‡å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨é©±åŠ¨ä¸­ç”¨<strong>request</strong>ç»“æ„ä½“æè¿°ã€‚ä½†å¯¹äºä¸€äº›ç£ç›˜è®¾å¤‡è€Œè¨€è¯·æ±‚çš„é€Ÿåº¦å¾ˆæ…¢ï¼Œè¿™æ—¶å€™å†…æ ¸å°±æä¾›ä¸€ç§é˜Ÿåˆ—çš„æœºåˆ¶æŠŠè¿™äº›I&#x2F;Oè¯·æ±‚æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼ˆå³ï¼šè¯·æ±‚é˜Ÿåˆ—ï¼‰ï¼Œåœ¨é©±åŠ¨ä¸­ç”¨<strong>request_queue</strong>ç»“æ„ä½“æè¿°ã€‚åœ¨å‘å—è®¾å¤‡æäº¤è¿™äº›è¯·æ±‚å‰å†…æ ¸ä¼šå…ˆæ‰§è¡Œè¯·æ±‚çš„åˆå¹¶å’Œæ’åºé¢„æ“ä½œï¼Œä»¥æé«˜è®¿é—®çš„æ•ˆç‡ï¼Œç„¶åå†ç”±å†…æ ¸ä¸­çš„I&#x2F;Oè°ƒåº¦ç¨‹åºå­ç³»ç»Ÿæ¥è´Ÿè´£æäº¤  I&#x2F;O è¯·æ±‚ï¼Œ  è°ƒåº¦ç¨‹åºå°†ç£ç›˜èµ„æºåˆ†é…ç»™ç³»ç»Ÿä¸­æ‰€æœ‰æŒ‚èµ·çš„å— I&#x2F;O  è¯·æ±‚ï¼Œå…¶å·¥ä½œæ˜¯ç®¡ç†å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ï¼Œå†³å®šé˜Ÿåˆ—ä¸­çš„è¯·æ±‚çš„æ’åˆ—é¡ºåºä»¥åŠä»€ä¹ˆæ—¶å€™æ´¾å‘è¯·æ±‚åˆ°è®¾å¤‡ã€‚</li><li>ç”±é€šç”¨å—å±‚(Generic Block Layer)è´Ÿè´£ç»´æŒä¸€ä¸ªI&#x2F;Oè¯·æ±‚åœ¨ä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿä¸åº•å±‚ç‰©ç†ç£ç›˜ä¹‹é—´çš„å…³ç³»ã€‚åœ¨é€šç”¨å—å±‚ä¸­ï¼Œé€šå¸¸ç”¨ä¸€ä¸ªbioç»“æ„ä½“æ¥å¯¹åº”ä¸€ä¸ªI&#x2F;Oè¯·æ±‚ã€‚</li><li>Linuxæä¾›äº†ä¸€ä¸ªgendiskæ•°æ®ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡æˆ–åˆ†åŒºï¼Œç”¨äºå¯¹åº•å±‚ç‰©ç†ç£ç›˜è¿›è¡Œè®¿é—®ã€‚åœ¨gendiskä¸­æœ‰ä¸€ä¸ªç±»ä¼¼å­—ç¬¦è®¾å¤‡ä¸­file_operationsçš„ç¡¬ä»¶æ“ä½œç»“æ„æŒ‡é’ˆï¼Œæ˜¯block_device_operationsç»“æ„ä½“ã€‚</li><li>å½“å¤šä¸ªè¯·æ±‚æäº¤ç»™å—è®¾å¤‡æ—¶ï¼Œæ‰§è¡Œæ•ˆç‡ä¾èµ–äºè¯·æ±‚çš„é¡ºåºã€‚å¦‚æœæ‰€æœ‰çš„è¯·æ±‚æ˜¯åŒä¸€ä¸ªæ–¹å‘ï¼ˆå¦‚ï¼šå†™æ•°æ®ï¼‰ï¼Œæ‰§è¡Œæ•ˆç‡æ˜¯æœ€å¤§çš„ã€‚å†…æ ¸åœ¨è°ƒç”¨å—è®¾å¤‡é©±åŠ¨ç¨‹åºä¾‹ç¨‹å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œå…ˆæ”¶é›†I&#x2F;Oè¯·æ±‚å¹¶å°†è¯·æ±‚æ’åºï¼Œç„¶åï¼Œå°†è¿ç»­æ‰‡åŒºæ“ä½œçš„å¤šä¸ªè¯·æ±‚è¿›è¡Œåˆå¹¶ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ï¼ˆå†…æ ¸ç®—æ³•ä¼šè‡ªå·±åšï¼Œä¸ç”¨ä½ ç®¡ï¼‰ï¼Œå¯¹I&#x2F;Oè¯·æ±‚æ’åºçš„ç®—æ³•ç§°ä¸ºç”µæ¢¯ç®—æ³•ï¼ˆelevator algorithmï¼‰ã€‚ç”µæ¢¯ç®—æ³•åœ¨I&#x2F;Oè°ƒåº¦å±‚å®Œæˆã€‚</li></ul><h2 id="3-é‡è¦ç»“æ„åŠæ“ä½œ"><a href="#3-é‡è¦ç»“æ„åŠæ“ä½œ" class="headerlink" title="3.é‡è¦ç»“æ„åŠæ“ä½œ"></a>3.é‡è¦ç»“æ„åŠæ“ä½œ</h2><h3 id="3-1-æ³¨å†Œå—è®¾å¤‡é©±åŠ¨ç¨‹åº"><a href="#3-1-æ³¨å†Œå—è®¾å¤‡é©±åŠ¨ç¨‹åº" class="headerlink" title="3.1 æ³¨å†Œå—è®¾å¤‡é©±åŠ¨ç¨‹åº"></a>3.1 æ³¨å†Œå—è®¾å¤‡é©±åŠ¨ç¨‹åº</h3><ul><li>å‘å†…æ ¸æ³¨å†Œå—è®¾å¤‡é©±åŠ¨ç¨‹åº</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">register_blkdev</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> major, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br></code></pre></td></tr></table></figure><blockquote><p>nameï¼šè®¾å¤‡åå­—ï¼Œæ˜¯åœ¨&#x2F;proc&#x2F;devicesä¸­æ˜¾ç¤ºçš„åå­—</p><p>majorï¼šè®¾å¤‡çš„ä¸»è®¾å¤‡å·ï¼Œå¦‚æœmajor&#x3D;0ï¼Œåˆ™åˆ†é…ä¸€ä¸ªä¸»è®¾å¤‡å·</p></blockquote><p>è¯¥å‡½æ•°çš„è°ƒç”¨æ˜¯å¯é€‰çš„ï¼Œå®Œæˆçš„å·¥ä½œï¼š</p><blockquote><ol><li>å¦‚æœéœ€è¦çš„è¯åˆ†é…ä¸€ä¸ªåŠ¨æ€çš„ä¸»è®¾å¤‡å·</li><li>åœ¨&#x2F;proc&#x2F;devicesä¸­åˆ›å»ºä¸€ä¸ªå…¥å£é¡¹</li></ol></blockquote><ul><li>æ³¨é”€å—è®¾å¤‡é©±åŠ¨ç¨‹åº</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">unregister_blkdev</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> major, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br></code></pre></td></tr></table></figure><hr><p>å¦‚ä¸‹ç”¨ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> sbull_major = <span class="hljs-number">0</span>;<br>sbull_major = register_blkdev(sbull_major, <span class="hljs-string">&quot;sbull&quot;</span>);<br><span class="hljs-keyword">if</span> (sbull_major &lt; <span class="hljs-number">0</span>) &#123;<br>printk(KERN_WARNNING <span class="hljs-string">&quot;sbull: unable to get major number\n&quot;</span>);<br><span class="hljs-keyword">return</span> -EBUSY;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/fs.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block_device</span> &#123;</span><br>    <span class="hljs-type">dev_t</span>           bd_dev;  <span class="hljs-comment">/* not a kdev_t - it&#x27;s a search key */</span><br>    <span class="hljs-type">int</span>         bd_openers;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *      <span class="hljs-title">bd_inode</span>;</span>   <span class="hljs-comment">/* will die */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *    <span class="hljs-title">bd_super</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>        <span class="hljs-title">bd_mutex</span>;</span>   <span class="hljs-comment">/* open/close mutex */</span><br>    <span class="hljs-type">void</span> *          bd_claiming;<br>    <span class="hljs-type">void</span> *          bd_holder;<br>    <span class="hljs-type">int</span>         bd_holders;<br>    <span class="hljs-type">bool</span>            bd_write_holder;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>    <span class="hljs-title">bd_holder_disks</span>;</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block_device</span> *   <span class="hljs-title">bd_contains</span>;</span><br>    <span class="hljs-type">unsigned</span>        bd_block_size;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hd_struct</span> *  <span class="hljs-title">bd_part</span>;</span><br>    <span class="hljs-comment">/* number of times partitions within this device have been opened. */</span><br>    <span class="hljs-type">unsigned</span>        bd_part_count;<br>    <span class="hljs-type">int</span>         bd_invalidated;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gendisk</span> *    <span class="hljs-title">bd_disk</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> *  <span class="hljs-title">bd_queue</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>    <span class="hljs-title">bd_list</span>;</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Private data.  You must have bd_claim&#x27;ed the block_device</span><br><span class="hljs-comment">     * to use this.  <span class="hljs-doctag">NOTE:</span>  bd_claim allows an owner to claim</span><br><span class="hljs-comment">     * the same device multiple times, the owner must take special</span><br><span class="hljs-comment">     * care to not mess up bd_private for that case.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>       bd_private;<br><br>    <span class="hljs-comment">/* The counter of freeze processes */</span><br>    <span class="hljs-type">int</span>         bd_fsfreeze_count;<br>    <span class="hljs-comment">/* Mutex for freeze */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>        <span class="hljs-title">bd_fsfreeze_mutex</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3-2-å—è®¾å¤‡æ“ä½œ"><a href="#3-2-å—è®¾å¤‡æ“ä½œ" class="headerlink" title="3.2 å—è®¾å¤‡æ“ä½œ"></a>3.2 å—è®¾å¤‡æ“ä½œ</h3><p>å­—ç¬¦è®¾å¤‡ä½¿ç”¨file_operationsç»“æ„ï¼Œæ¥å‘Šè¯‰ç³»ç»Ÿå­—ç¬¦è®¾å¤‡é©±åŠ¨çš„æ“ä½œæ¥å£ï¼›</p><p>å—è®¾å¤‡ä½¿ç”¨block_device_operationsç»“æ„ï¼Œæ¥å‘Šè¯‰ç³»ç»Ÿå—è®¾å¤‡é©±åŠ¨çš„æ“ä½œæ¥å£ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/blkdev.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block_device_operations</span> &#123;</span><br>    <span class="hljs-type">int</span> (*open) (<span class="hljs-keyword">struct</span> block_device *, <span class="hljs-type">fmode_t</span>);<br>    <span class="hljs-type">void</span> (*release) (<span class="hljs-keyword">struct</span> gendisk *, <span class="hljs-type">fmode_t</span>);<br>    <span class="hljs-type">int</span> (*rw_page)(<span class="hljs-keyword">struct</span> block_device *, <span class="hljs-type">sector_t</span>, <span class="hljs-keyword">struct</span> page *, <span class="hljs-type">bool</span>);<br>    <span class="hljs-type">int</span> (*ioctl) (<span class="hljs-keyword">struct</span> block_device *, <span class="hljs-type">fmode_t</span>, <span class="hljs-type">unsigned</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br>    <span class="hljs-type">int</span> (*compat_ioctl) (<span class="hljs-keyword">struct</span> block_device *, <span class="hljs-type">fmode_t</span>, <span class="hljs-type">unsigned</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br>......<br>    <span class="hljs-comment">/* -&gt;media_changed() is DEPRECATED, use -&gt;check_events() instead */</span><br>    <span class="hljs-type">int</span> (*media_changed) (<span class="hljs-keyword">struct</span> gendisk *);<br>    <span class="hljs-type">int</span> (*getgeo)(<span class="hljs-keyword">struct</span> block_device *, <span class="hljs-keyword">struct</span> hd_geometry *);<br>......<br>&#125;;<br></code></pre></td></tr></table></figure><p>å’Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸åŒï¼Œå—è®¾å¤‡é©±åŠ¨çš„block_device_operationsæ“ä½œé›†ä¸­æ²¡æœ‰è´Ÿè´£è¯»å’Œå†™æ•°æ®çš„å‡½æ•°ï¼›åœ¨å—è®¾å¤‡é©±åŠ¨ä¸­ï¼Œè¿™äº›æ“ä½œæ˜¯ç”±requestå‡½æ•°å¤„ç†çš„ï¼›</p><h3 id="3-3-æ³¨å†Œç£ç›˜"><a href="#3-3-æ³¨å†Œç£ç›˜" class="headerlink" title="3.3 æ³¨å†Œç£ç›˜"></a>3.3 æ³¨å†Œç£ç›˜</h3><p>ä¸ºäº†ç®¡ç†ç‹¬ç«‹çš„ç£ç›˜ï¼Œéœ€è¦ä½¿ç”¨struct gendiskç»“æ„ä½“ï¼Œå†…æ ¸ä½¿ç”¨gendiskç»“æ„è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºåˆ†åŒºï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/genhd.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gendisk</span> &#123;</span><br>    <span class="hljs-type">int</span> major;          <span class="hljs-comment">/* major number of driver */</span><br>    <span class="hljs-type">int</span> first_minor;<br>    <span class="hljs-type">int</span> minors;                     <span class="hljs-comment">/* maximum number of minors, =1 for</span><br><span class="hljs-comment">                                         * disks that can&#x27;t be partitioned. */</span><br>    <span class="hljs-type">char</span> disk_name[DISK_NAME_LEN];  <span class="hljs-comment">/* name of major driver */</span><br>    <span class="hljs-type">char</span> *(*devnode)(<span class="hljs-keyword">struct</span> gendisk *gd, <span class="hljs-type">umode_t</span> *mode);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hd_struct</span> <span class="hljs-title">part0</span>;</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block_device_operations</span> *<span class="hljs-title">fops</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> *<span class="hljs-title">queue</span>;</span><br>......<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>majorï¼šæŒ‡å®šé©±åŠ¨ç¨‹åºçš„ä¸»è®¾å¤‡å·</p><p>first_minorå’Œminorsï¼šä»è®¾å¤‡å·çš„å¯èƒ½èŒƒå›´</p><p>disk_nameï¼šç£ç›˜åç§°ï¼Œåœ¨&#x2F;proc&#x2F;partitions å’Œ sysfs ä¸­è¡¨ç¤ºè¯¥ç£ç›˜</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> disk_name[DISK_NAME_LEN];<br></code></pre></td></tr></table></figure><p>æ˜¾ç¤ºåœ¨&#x2F;proc&#x2F;partitions å’Œ sysfs ä¸­</p><p>å¯¹äºæ¯ä¸€ä¸ªåˆ†åŒºæ¥è¯´ï¼Œéƒ½æœ‰ä¸€ä¸ªhd_structç»“æ„ä½“ï¼Œç”¨äºæè¿°è¯¥åˆ†åŒº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/genhd.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hd_struct</span> &#123;</span><br>    <span class="hljs-type">sector_t</span> start_sect;<br>    <span class="hljs-type">sector_t</span> nr_sects;<br>    <span class="hljs-type">seqcount_t</span> nr_sects_seq;<br>......<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition_meta_info</span> *<span class="hljs-title">info</span>;</span><br>......<br>&#125;;<br></code></pre></td></tr></table></figure><p>start_sectå’Œnr_sectsï¼šå®šä¹‰äº†è¯¥åˆ†åŒºåœ¨å—è®¾å¤‡ä¸Šçš„èµ·å§‹æ‰‡åŒºå’Œé•¿åº¦ï¼Œå”¯ä¸€åœ°æè¿°äº†è¯¥åˆ†åŒº</p><p>æ‹¥æœ‰äº†è®¾å¤‡å†…å­˜å’Œè¯·æ±‚é˜Ÿåˆ—ï¼Œå°±å¯ä»¥åˆ†é…ã€åˆå§‹åŒ–åŠå®‰è£…gendiskç»“æ„ï¼›åœ¨struct gendiskæ˜¯åŠ¨æ€åˆ†é…çš„ç»“æ„ï¼Œéœ€è¦å†…æ ¸è¿›è¡Œåˆå§‹åŒ–ï¼Œé©±åŠ¨å¿…é¡»é€šè¿‡alloc_diskåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> gendisk *<span class="hljs-title function_">alloc_disk</span><span class="hljs-params">(<span class="hljs-type">int</span> minors)</span>;<br></code></pre></td></tr></table></figure><blockquote><p>minorsï¼šæ˜¯è¯¥ç£ç›˜ä½¿ç”¨çš„ä»è®¾å¤‡å·çš„æ•°ç›®ï¼›</p></blockquote><p>å¸è½½ç£ç›˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">del_gendisk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gendisk *disk)</span><br></code></pre></td></tr></table></figure><p>gendiskæ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°ç»“æ„ï¼Œget_diskå’Œput_diskå‡½æ•°è´Ÿè´£å¤„ç†å¼•ç”¨è®¡æ•°ï¼›è°ƒç”¨del_gendiskåï¼Œè¯¥ç»“æ„å¯èƒ½ç»§ç»­å­˜åœ¨ï¼›</p><p>ä¸ºäº†ä½¿gendiskç»“æ„çš„ç£ç›˜è®¾å¤‡ç”Ÿæ•ˆï¼Œéœ€è¦åˆå§‹åŒ–ç»“æ„ï¼Œå¹¶å°†ç£ç›˜æˆ–åˆ†åŒºä¿¡æ¯æ·»åŠ åˆ°å†…æ ¸é“¾è¡¨ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">add_disk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gendisk *gd)</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨add_diskåï¼Œç£ç›˜è®¾å¤‡å°†è¢«æ¿€æ´»ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒæä¾›çš„æ“ä½œæ–¹æ³•ï¼Œå› æ­¤åœ¨é©±åŠ¨ç¨‹åºå®Œå…¨è¢«åˆå§‹åŒ–å¹¶ä¸”èƒ½å¤Ÿå“åº”å¯¹ç£ç›˜çš„è¯·æ±‚å‰ï¼Œä¸è¦è°ƒç”¨add_diskï¼›</p><h3 id="3-4-è¯·æ±‚é˜Ÿåˆ—"><a href="#3-4-è¯·æ±‚é˜Ÿåˆ—" class="headerlink" title="3.4 è¯·æ±‚é˜Ÿåˆ—"></a>3.4 è¯·æ±‚é˜Ÿåˆ—</h3><p>å—è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ ¸å¿ƒæ˜¯è¯·æ±‚å‡½æ•°ï¼ŒåŒ…å«è¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼›</p><ul><li>æœ‰I&#x2F;Oè°ƒåº¦ç±»è®¾å¤‡ï¼Œä½¿ç”¨blk_init_queue()å‡½æ•°ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> request_queue *<span class="hljs-title function_">blk_init_queue</span><span class="hljs-params">(request_fn_proc *rfn, <span class="hljs-type">spinlock_t</span> *lock)</span><br></code></pre></td></tr></table></figure><ul><li>æ— I&#x2F;Oè°ƒåº¦ç±»è®¾å¤‡ï¼Œä½¿ç”¨blk_alloc_queue()å‡½æ•°ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// block/blk-core.c</span><br><span class="hljs-keyword">struct</span> request_queue *<span class="hljs-title function_">blk_alloc_queue</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask)</span><br><span class="hljs-comment">// block/blk-settings.c</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">blk_queue_make_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request_queue *q, make_request_fn *mfn)</span><br></code></pre></td></tr></table></figure><p>ä»è¯·æ±‚é˜Ÿåˆ—ä¸­æå–è¯·æ±‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// block/blk-core.c</span><br><span class="hljs-keyword">struct</span> request *<span class="hljs-title function_">blk_fetch_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request_queue *q)</span><br></code></pre></td></tr></table></figure><p>åœ¨å¸è½½å‡½æ•°ä¸­ä½¿ç”¨çš„æ¸…é™¤è¯·æ±‚é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// block/blk-core.c</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">blk_cleanup_queue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> request_queue *q)</span><br></code></pre></td></tr></table></figure><p>å—è®¾å¤‡çš„è¯»å†™è¯·æ±‚æ”¾ç½®åœ¨è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œåœ¨struct gendiskä¸­ï¼Œé€šè¿‡struct request_queue *queueæŒ‡é’ˆæŒ‡å‘è¯·æ±‚é˜Ÿåˆ—ï¼›è¯·æ±‚é˜Ÿåˆ—ç”¨æ•°æ®ç»“æ„struct request_queueè¡¨ç¤ºï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/blkdev.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>    <span class="hljs-title">queue_head</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span>      *<span class="hljs-title">last_merge</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">elevator_queue</span>   *<span class="hljs-title">elevator</span>;</span><br>......<br>    request_fn_proc     *request_fn;<br>    make_request_fn     *make_request_fn;<br>......<br>    <span class="hljs-type">void</span>            *queuedata;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>    <span class="hljs-title">icq_list</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_limits</span> <span class="hljs-title">limits</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_flush_queue</span>  *<span class="hljs-title">fq</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>    <span class="hljs-title">requeue_list</span>;</span><br>    <span class="hljs-type">spinlock_t</span>      requeue_lock;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">delayed_work</span> <span class="hljs-title">requeue_work</span>;</span><br>......<br>&#125;;<br></code></pre></td></tr></table></figure><p>queue_headï¼šè¡¨å¤´ï¼Œç”¨äºæ„å»ºä¸€ä¸ªIOè¯·æ±‚çš„åŒé“¾è¡¨ï¼›é“¾è¡¨æ¯ä¸ªå…ƒç´ ä»£è¡¨å‘å—è®¾å¤‡è¯»å–æ•°æ®çš„ä¸€ä¸ªè¯·æ±‚ï¼›å†…æ ¸ä¼šé‡æ’è¯¥é“¾è¡¨ï¼Œä»¥å¾—åˆ°æ›´å¥½çš„IOæ€§èƒ½ï¼›</p><p>ä¸æ¯ä¸ªå—è®¾å¤‡é©±åŠ¨ç¨‹åºç›¸å…³çš„I&#x2F;Oè¯·æ±‚é˜Ÿåˆ—ç”¨request_queueç»“æ„ä½“æè¿°ï¼Œè€Œæ¯ä¸ªrequest_queueé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç”¨requestç»“æ„ä½“æè¿°ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/blkdev.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">queuelist</span>;</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request_queue</span> *<span class="hljs-title">q</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">blk_mq_ctx</span> *<span class="hljs-title">mq_ctx</span>;</span><br><br>    <span class="hljs-comment">/* the following two fields are internal, NEVER access directly */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __data_len;    <span class="hljs-comment">/* total data len */</span><br>    <span class="hljs-type">sector_t</span> __sector;      <span class="hljs-comment">/* sector cursor */</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio</span> *<span class="hljs-title">bio</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio</span> *<span class="hljs-title">biotail</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> *<span class="hljs-title">next_rq</span>;</span><br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>requestç»“æ„ä½“å…³è”äº†struct bioï¼Œstruct bioç»“æ„ä½“æ˜¯å—I&#x2F;Oæ“ä½œåœ¨é¡µçº§ç²’åº¦çš„åº•å±‚æè¿°ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/blk_types.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio</span>      *<span class="hljs-title">bi_next</span>;</span>   <span class="hljs-comment">/* request queue link */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block_device</span> *<span class="hljs-title">bi_bdev</span>;</span><br>    <span class="hljs-type">int</span>         bi_error;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>      bi_flags;   <span class="hljs-comment">/* status, command, etc */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>      bi_ioprio;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bvec_iter</span>    <span class="hljs-title">bi_iter</span>;</span><br><br>    <span class="hljs-type">atomic_t</span>        __bi_remaining;<br>    <span class="hljs-type">bio_end_io_t</span>        *bi_end_io;<br>    <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>      bi_vcnt;    <span class="hljs-comment">/* how many bio_vec&#x27;s */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>      bi_max_vecs;    <span class="hljs-comment">/* max bvl_vecs we can hold */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_vec</span>      *<span class="hljs-title">bi_io_vec</span>;</span> <span class="hljs-comment">/* the actual vec list */</span><br>......<br>&#125;<br></code></pre></td></tr></table></figure><p>å—æ•°æ®é€šè¿‡bio_vecç»“æ„ä½“æ•°ç»„åœ¨å†…éƒ¨è¢«è¡¨ç¤ºæˆI&#x2F;Oå‘é‡ï¼›æ¯ä¸ªbio_vecæ•°ç»„å…ƒç´ ç”±ä¸‰å…ƒç»„ç»„æˆï¼ˆå³ï¼Œé¡µã€é¡µåç§»ã€é•¿åº¦ï¼‰ï¼Œè¡¨ç¤ºè¯¥å—I&#x2F;Oçš„ä¸€ä¸ªæ®µï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/bvec.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_vec</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">bv_page</span>;</span><span class="hljs-comment">// é¡µæŒ‡é’ˆ</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    bv_len;<span class="hljs-comment">// ä¼ è¾“çš„å­—èŠ‚æ•°</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    bv_offset;<span class="hljs-comment">// åç§»ä½ç½®</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>struct bvec_iterç»“æ„ä½“ç”¨æ¥è®°å½•å½“å‰bvecè¢«å¤„ç†çš„æƒ…å†µï¼Œç”¨äºéå†bioï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/bvec.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bvec_iter</span> &#123;</span><br>    <span class="hljs-type">sector_t</span>        bi_sector;  <span class="hljs-comment">/* device address in 512 byte sectors */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>bi_size;    <span class="hljs-comment">/* residual I/O count */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>bi_idx;     <span class="hljs-comment">/* current index into bvl_vec */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>bi_bvec_done;   <span class="hljs-comment">/* number of bytes completed in current bvec */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3-5-æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"><a href="#3-5-æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»" class="headerlink" title="3.5 æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»"></a>3.5 æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</h3><img src="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/image-20230716175745706.png" alt="image-20230716175745706" style="zoom:80%;"><p><strong>å—è®¾å¤‡æ•°æ®ç»“æ„é—´çš„å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p><img src="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/å—è®¾å¤‡æ•°æ®ç»“æ„é—´çš„å…³ç³».png" alt="å—è®¾å¤‡æ•°æ®ç»“æ„é—´çš„å…³ç³»" style="zoom:80%;"><p>bioã€bio_vectorå’ŒPageä¹‹é—´çš„å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/07/16/%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/100045938-83908-2.png" alt="img" style="zoom:80%;"><h2 id="4-å—è®¾å¤‡é©±åŠ¨çš„åˆå§‹åŒ–"><a href="#4-å—è®¾å¤‡é©±åŠ¨çš„åˆå§‹åŒ–" class="headerlink" title="4.å—è®¾å¤‡é©±åŠ¨çš„åˆå§‹åŒ–"></a>4.å—è®¾å¤‡é©±åŠ¨çš„åˆå§‹åŒ–</h2><h2 id="åƒå³°è§†é¢‘"><a href="#åƒå³°è§†é¢‘" class="headerlink" title="åƒå³°è§†é¢‘"></a>åƒå³°è§†é¢‘</h2><p><a href="https://www.bilibili.com/video/BV1dG4y1E7x1?p=1&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">https://www.bilibili.com/video/BV1dG4y1E7x1?p=1&amp;vd_source=0a2a531b678f5afe0a34f933b2fbdcb4</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä»€ä¹ˆæ˜¯é¡µç¼“å­˜Page Cache</title>
    <link href="/2023/07/16/%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E7%BC%93%E5%AD%98Page-Cache/"/>
    <url>/2023/07/16/%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E7%BC%93%E5%AD%98Page-Cache/</url>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯é¡µç¼“å­˜Page-Cache"><a href="#ä»€ä¹ˆæ˜¯é¡µç¼“å­˜Page-Cache" class="headerlink" title="ä»€ä¹ˆæ˜¯é¡µç¼“å­˜Page Cache"></a>ä»€ä¹ˆæ˜¯é¡µç¼“å­˜Page Cache</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://cloud.tencent.com/developer/article/1848933">https://cloud.tencent.com/developer/article/1848933</a></p></blockquote><p>æˆ‘ä»¬çŸ¥é“æ–‡ä»¶ä¸€èˆ¬å­˜æ”¾åœ¨ç¡¬ç›˜ï¼ˆæœºæ¢°ç¡¬ç›˜æˆ–å›ºæ€ç¡¬ç›˜ï¼‰ä¸­ï¼ŒCPU å¹¶ä¸èƒ½ç›´æ¥è®¿é—®ç¡¬ç›˜ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯éœ€è¦å…ˆå°†ç¡¬ç›˜ä¸­çš„æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œç„¶åæ‰èƒ½è¢« CPU è®¿é—®ã€‚</p><p>ç”±äºè¯»å†™ç¡¬ç›˜çš„é€Ÿåº¦æ¯”è¯»å†™å†…å­˜è¦æ…¢å¾ˆå¤šï¼ˆDDR4 å†…å­˜è¯»å†™é€Ÿåº¦æ˜¯æœºæ¢°ç¡¬ç›˜500å€ï¼Œæ˜¯å›ºæ€ç¡¬ç›˜çš„200å€ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…æ¯æ¬¡è¯»å†™æ–‡ä»¶æ—¶ï¼Œéƒ½éœ€è¦å¯¹ç¡¬ç›˜è¿›è¡Œè¯»å†™æ“ä½œï¼ŒLinux å†…æ ¸ä½¿ç”¨ <code>é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰</code> æœºåˆ¶æ¥å¯¹æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œç¼“å­˜ã€‚</p><blockquote><p>æœ¬æ–‡ä½¿ç”¨çš„ Linux å†…æ ¸ç‰ˆæœ¬ä¸ºï¼šLinux-2.6.23</p></blockquote><h2 id="ä»€ä¹ˆæ˜¯ä¹Ÿé¡µç¼“å­˜"><a href="#ä»€ä¹ˆæ˜¯ä¹Ÿé¡µç¼“å­˜" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¹Ÿé¡µç¼“å­˜"></a>ä»€ä¹ˆæ˜¯ä¹Ÿé¡µç¼“å­˜</h2><p>ä¸ºäº†æå‡å¯¹æ–‡ä»¶çš„è¯»å†™æ•ˆç‡ï¼Œ<strong>Linux å†…æ ¸ä¼šä»¥é¡µå¤§å°ï¼ˆ4KBï¼‰ä¸ºå•ä½ï¼Œå°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šæ•°æ®å—</strong>ã€‚å½“ç”¨æˆ·å¯¹æ–‡ä»¶ä¸­çš„æŸä¸ªæ•°æ®å—è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå†…æ ¸é¦–å…ˆä¼š<u>ç”³è¯·ä¸€ä¸ªå†…å­˜é¡µï¼ˆç§°ä¸º <code>é¡µç¼“å­˜</code>ï¼‰</u>ä¸æ–‡ä»¶ä¸­çš„æ•°æ®å—è¿›è¡Œç»‘å®šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/07/16/%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E7%BC%93%E5%AD%98Page-Cache/1200.png" alt="img" style="zoom: 67%;"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ç”¨æˆ·å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹æ–‡ä»¶çš„ <code>é¡µç¼“å­˜</code> è¿›è¡Œè¯»å†™ã€‚æ‰€ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œä¼šåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š</p><ul><li>å½“ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœè¦è¯»å–çš„æ•°æ®æ‰€åœ¨çš„é¡µç¼“å­˜å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´ç»™ç”¨æˆ·å³å¯ã€‚å¦åˆ™ï¼Œå†…æ ¸é¦–å…ˆä¼šç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µï¼ˆé¡µç¼“å­˜ï¼‰ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ï¼Œå¹¶ä¸”æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´ç»™ç”¨æˆ·ã€‚</li><li>å½“å‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœè¦å†™å…¥çš„æ•°æ®æ‰€åœ¨çš„é¡µç¼“å­˜å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥æŠŠæ–°æ•°æ®å†™å…¥åˆ°é¡µç¼“å­˜å³å¯ã€‚å¦åˆ™ï¼Œå†…æ ¸é¦–å…ˆä¼šç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µï¼ˆé¡µç¼“å­˜ï¼‰ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ï¼Œå¹¶ä¸”æŠŠæ–°æ•°æ®å†™å…¥åˆ°é¡µç¼“å­˜ä¸­ã€‚å¯¹äºè¢«ä¿®æ”¹çš„é¡µç¼“å­˜ï¼Œå†…æ ¸ä¼šå®šæ—¶æŠŠè¿™äº›é¡µç¼“å­˜åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ã€‚</li></ul><h2 id="é¡µç¼“å­˜çš„å®ç°"><a href="#é¡µç¼“å­˜çš„å®ç°" class="headerlink" title="é¡µç¼“å­˜çš„å®ç°"></a>é¡µç¼“å­˜çš„å®ç°</h2><p>å‰é¢ä¸»è¦ä»‹ç»äº†é¡µç¼“å­˜çš„ä½œç”¨å’ŒåŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šåˆ†æ Linux å†…æ ¸æ˜¯æ€ä¹ˆå®ç°é¡µç¼“å­˜æœºåˆ¶çš„ã€‚</p><ol><li><strong>address_space</strong></li></ol><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œä½¿ç”¨ <code>file</code> å¯¹è±¡æ¥æè¿°ä¸€ä¸ªè¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸ªåä¸º <code>f_mapping</code> çš„å­—æ®µï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> &#123;</span><br>    ...<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">f_mapping</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ<code>f_mapping</code> å­—æ®µçš„ç±»å‹ä¸º <code>address_space</code> ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span>           *<span class="hljs-title">host</span>;</span>      <span class="hljs-comment">/* owner: inode, block_device */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">radix_tree_root</span> <span class="hljs-title">page_tree</span>;</span>  <span class="hljs-comment">/* radix tree of all pages */</span><br>    <span class="hljs-type">rwlock_t</span>               tree_lock;  <span class="hljs-comment">/* and rwlock protecting it */</span><br>    ...<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>address_space</code> ç»“æ„å…¶ä¸­çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯ç”¨äºå­˜å‚¨æ–‡ä»¶çš„ <code>é¡µç¼“å­˜</code>ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹å„ä¸ªå­—æ®µçš„ä½œç”¨ï¼š</p><ul><li><code>host</code>ï¼šæŒ‡å‘å½“å‰ <code>address_space</code> å¯¹è±¡æ‰€å±çš„æ–‡ä»¶ <code>inode</code> å¯¹è±¡ï¼ˆæ¯ä¸ªæ–‡ä»¶éƒ½ä½¿ç”¨ä¸€ä¸ª <code>inode</code> å¯¹è±¡è¡¨ç¤ºï¼‰ã€‚</li><li><code>page_tree</code>ï¼šç”¨äºå­˜å‚¨å½“å‰æ–‡ä»¶çš„ <code>é¡µç¼“å­˜</code>ã€‚</li><li><code>tree_lock</code>ï¼šç”¨äºé˜²æ­¢å¹¶å‘è®¿é—® <code>page_tree</code> å¯¼è‡´çš„èµ„æºç«äº‰é—®é¢˜ã€‚</li></ul><p>ä» <code>address_space</code> å¯¹è±¡çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶çš„ <code>é¡µç¼“å­˜</code> ä½¿ç”¨äº† <code>radixæ ‘</code> æ¥å­˜å‚¨ã€‚</p><blockquote><p><code>radixæ ‘</code>ï¼šåˆååŸºæ•°æ ‘ï¼Œå®ƒä½¿ç”¨é”®å€¼ï¼ˆkey-valueï¼‰å¯¹çš„å½¢å¼æ¥ä¿å­˜æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡é”®å¿«é€ŸæŸ¥æ‰¾åˆ°å…¶å¯¹åº”çš„å€¼ã€‚å†…æ ¸ä»¥æ–‡ä»¶è¯»å†™æ“ä½œä¸­çš„æ•°æ® <code>åç§»é‡</code> ä½œä¸ºé”®ï¼Œä»¥æ•°æ®åç§»é‡æ‰€åœ¨çš„ <code>é¡µç¼“å­˜</code> ä½œä¸ºå€¼ï¼Œå­˜å‚¨åœ¨ <code>address_space</code> ç»“æ„çš„ <code>page_tree</code> å­—æ®µä¸­ã€‚</p></blockquote><p>ä¸‹å›¾å±•ç¤ºäº†ä¸Šè¿°å„ä¸ªç»“æ„ä¹‹é—´çš„å…³ç³»ï¼š</p><img src="/2023/07/16/%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E7%BC%93%E5%AD%98Page-Cache/1200-1689498860578-3.png" alt="img" style="zoom: 80%;"><ol start="2"><li><strong>è¯»æ–‡ä»¶æ“ä½œ</strong></li></ol><p>ç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¯»å–æ–‡ä»¶æ•°æ®çš„è¿‡ç¨‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨ <code>read</code> ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå…¶è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">read()<br>â””â†’ sys_read()<br>   â””â†’ vfs_read()<br>      â””â†’ do_sync_read()<br>         â””â†’ generic_file_aio_read()<br>            â””â†’ do_generic_file_read()<br>               â””â†’ do_generic_mapping_read()<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„è°ƒç”¨é“¾å¯ä»¥çœ‹å‡ºï¼Œ<code>read</code> ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆä¼šè°ƒç”¨ <code>do_generic_mapping_read</code> å‡½æ•°æ¥è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">do_generic_mapping_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> file_ra_state *_ra,</span><br><span class="hljs-params">                        <span class="hljs-keyword">struct</span> file *filp,</span><br><span class="hljs-params">                        <span class="hljs-type">loff_t</span> *ppos,</span><br><span class="hljs-params">                        <span class="hljs-type">read_descriptor_t</span> *desc,</span><br><span class="hljs-params">                        <span class="hljs-type">read_actor_t</span> actor)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> mapping-&gt;host;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> index;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">cached_page</span>;</span><br>    ...<br><br>    cached_page = <span class="hljs-literal">NULL</span>;<br>    index = *ppos &gt;&gt; PAGE_CACHE_SHIFT;<br>    ...<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>        ...<br><br>find_page:<br>        <span class="hljs-comment">// 1. æŸ¥æ‰¾æ–‡ä»¶åç§»é‡æ‰€åœ¨çš„é¡µç¼“å­˜æ˜¯å¦å­˜åœ¨</span><br>        page = find_get_page(mapping, index);<br>        <span class="hljs-keyword">if</span> (!page) &#123;<br>            ...<br>            <span class="hljs-comment">// 2. å¦‚æœé¡µç¼“å­˜ä¸å­˜åœ¨, é‚£ä¹ˆè·³åˆ° no_cached_page è¿›è¡Œå¤„ç†</span><br>            <span class="hljs-keyword">goto</span> no_cached_page; <br>        &#125;<br>        ...<br><br>page_ok:<br>        ...<br>        <span class="hljs-comment">// 3. å¦‚æœé¡µç¼“å­˜å­˜åœ¨, é‚£ä¹ˆæŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­</span><br>        ret = actor(desc, page, offset, nr);<br>        ...<br>        <span class="hljs-keyword">if</span> (ret == nr &amp;&amp; desc-&gt;count)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">goto</span> out;<br>        ...<br><br>readpage:<br>        <span class="hljs-comment">// 4. ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ä¸­</span><br>        error = mapping-&gt;a_ops-&gt;readpage(filp, page);<br>        ...<br>        <span class="hljs-keyword">goto</span> page_ok;<br>        ...<br><br>no_cached_page:<br>        <span class="hljs-keyword">if</span> (!cached_page) &#123;<br>            <span class="hljs-comment">// 5. ç”³è¯·ä¸€ä¸ªå†…å­˜é¡µä½œä¸ºé¡µç¼“å­˜</span><br>            cached_page = page_cache_alloc_cold(mapping);<br>            ...<br>        &#125;<br><br>        <span class="hljs-comment">// 6. æŠŠæ–°ç”³è¯·çš„é¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­</span><br>        error = add_to_page_cache_lru(cached_page, mapping, index, GFP_KERNEL);<br>        ...<br>        page = cached_page;<br>        cached_page = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">goto</span> readpage;<br>    &#125;<br><br>out:<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>do_generic_mapping_read</code> å‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œç»è¿‡ç²¾ç®€åï¼Œä¸Šé¢ä»£ç åªç•™ä¸‹æœ€é‡è¦çš„é€»è¾‘ï¼Œå¯ä»¥å½’çº³ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>é€šè¿‡è°ƒç”¨ <code>find_get_page</code> å‡½æ•°æŸ¥æ‰¾è¦è¯»å–çš„æ–‡ä»¶åç§»é‡æ‰€å¯¹åº”çš„é¡µç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±æŠŠé¡µç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­ã€‚</li><li>å¦åˆ™è°ƒç”¨ <code>page_cache_alloc_cold</code> å‡½æ•°ç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µä½œä¸ºæ–°çš„é¡µç¼“å­˜ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ <code>add_to_page_cache_lru</code> å‡½æ•°æŠŠæ–°ç”³è¯·çš„é¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜å’Œ LRU é˜Ÿåˆ—ä¸­ï¼ˆåé¢ä¼šä»‹ç»ï¼‰ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>readpage</code> æ¥å£ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­ã€‚</li></ul><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“é¡µç¼“å­˜ä¸å­˜åœ¨æ—¶ä¼šç”³è¯·ä¸€å—ç©ºé—²çš„å†…å­˜é¡µä½œä¸ºé¡µç¼“å­˜ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ <code>add_to_page_cache_lru</code> å‡½æ•°æŠŠå…¶æ·»åŠ åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜å’Œ LRU é˜Ÿåˆ—ä¸­ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ <code>add_to_page_cache_lru</code> å‡½æ•°çš„å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-type">int</span> <span class="hljs-title function_">add_to_page_cache_lru</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">struct</span> address_space *mapping,</span><br><span class="hljs-params">                           <span class="hljs-type">pgoff_t</span> offset, <span class="hljs-type">gfp_t</span> gfp_mask)</span><br>&#123;<br>    <span class="hljs-comment">// 1. æŠŠé¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­</span><br>    <span class="hljs-type">int</span> ret = add_to_page_cache(page, mapping, offset, gfp_mask);<br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>        lru_cache_add(page); <span class="hljs-comment">// 2. æŠŠé¡µç¼“å­˜æ·»åŠ åˆ° LRU é˜Ÿåˆ—ä¸­</span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>add_to_page_cache_lru</code> å‡½æ•°ä¸»è¦å®Œæˆä¸¤ä¸ªå·¥ä½œï¼š</p><ul><li>é€šè¿‡è°ƒç”¨ <code>add_to_page_cache</code> å‡½æ•°æŠŠé¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ åˆ° <code>address_space</code> ç»“æ„çš„ <code>page_tree</code> å­—æ®µä¸­ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>lru_cache_add</code> å‡½æ•°æŠŠé¡µç¼“å­˜æ·»åŠ åˆ° LRU é˜Ÿåˆ—ä¸­ã€‚LRU é˜Ÿåˆ—ç”¨äºå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œå¯¹é¡µç¼“å­˜è¿›è¡Œæ¸…ç†æ—¶ä½¿ç”¨ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† <code>é¡µç¼“å­˜</code> çš„ä½œç”¨å’ŒåŸç†ï¼Œå¹¶ä¸”ä»‹ç»äº†åœ¨è¯»å–æ–‡ä»¶æ•°æ®æ—¶å¯¹é¡µç¼“å­˜çš„å¤„ç†è¿‡ç¨‹ã€‚æœ¬æ–‡å¹¶æ²¡æœ‰ä»‹ç»å†™æ–‡ä»¶æ“ä½œå¯¹åº”çš„é¡µç¼“å­˜å¤„ç†å’Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶æ€ä¹ˆé‡Šæ”¾é¡µç¼“å­˜ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³çš„ä»£ç å®ç°ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>structç»“æ„ä½“å†…å­˜å¯¹é½</title>
    <link href="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/"/>
    <url>/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.cnblogs.com/hyacinthLJP/p/16041690.html">https://www.cnblogs.com/hyacinthLJP/p/16041690.html</a></p><p>ä½œè€…ï¼š <a href="https://www.cnblogs.com/hyacinthLJP">MElephant</a></p></blockquote><h2 id="å°è¯•ç‰›åˆ€"><a href="#å°è¯•ç‰›åˆ€" class="headerlink" title="å°è¯•ç‰›åˆ€"></a>å°è¯•ç‰›åˆ€</h2><p>æˆ‘ä»¬è‡ªå®šä¹‰ä¸¤ä¸ªç»“æ„ä½“ A å’Œ Bï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> c1;<br>    <span class="hljs-type">char</span> c2;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">double</span> d;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> c1;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> c2;<br>    <span class="hljs-type">double</span> d;<br>&#125;;<br></code></pre></td></tr></table></figure><p>é€šè¿‡å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç»“æ„ä½“ A å’Œ B æ‹¥æœ‰ç›¸åŒçš„æˆå‘˜ï¼Œåªä¸è¿‡åœ¨æ’åˆ—é¡ºåºä¸Šæœ‰æ‰€ä¸åŒï¼›</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œchar ç±»å‹å  1 ä¸ªå­—èŠ‚ï¼Œint ç±»å‹å  4 ä¸ªå­—èŠ‚ï¼Œdouble ç±»å‹å  8 ä¸ªå­—èŠ‚</p><p>é‚£ä¹ˆï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“æ‰€å å†…å­˜ç©ºé—´å¤§å°ä¸ºå¤šå°‘å‘¢ï¼Ÿå ç”¨çš„ç©ºé—´æ˜¯å¦ç›¸åŒï¼Ÿ</p><p>ç©ºå£æ— å‡­ï¼Œè®©æˆ‘ä»¬é€šè¿‡ç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ä»¬ç­”æ¡ˆï¼ˆæˆ‘ä½¿ç”¨çš„æ˜¯ VS2022ï¼ŒX86ï¼‰ã€‚</p><p>åœ¨ main() å‡½æ•°ä¸­è¾“å‡ºå¦‚ä¸‹è¯­å¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç»“æ„ä½“Aæ‰€å å†…å­˜å¤§å°ä¸ºï¼š%d\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(A));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç»“æ„ä½“Bæ‰€å å†…å­˜å¤§å°ä¸ºï¼š%d\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(B));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œä¹‹å‰ï¼Œå…ˆç›²çŒœä¸€ä¸ªç»“æœï¼š</p><p> <code>sizeof(A) = sizeof(B) = sizeof(c1)+sizeof(c2)+sizeof(i)+sizeof(d) = 1+1+4+8 = 14</code></p><p>åˆ°åº•å¯¹ä¸å¯¹å‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿è¡Œç»“æœï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322175926325-808092561.png" alt="img" style="zoom: 80%;"><p>amazing~~</p><p>ç«Ÿç„¶ä¸€ä¸ªéƒ½æ²¡çŒœå¯¹ï¼Œè¿™ç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p><p>ä¸‹é¢å¼€å§‹è¿›å…¥ä»Šå¤©çš„ä¸»é¢˜â€”â€”struct å†…å­˜å¯¹é½ã€‚</p><h2 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h2><p>ä¸€ç§æé«˜å†…å­˜è®¿é—®é€Ÿåº¦çš„ç­–ç•¥ï¼ŒCPU åœ¨è®¿é—®æœªå¯¹é½çš„å†…å­˜å¯èƒ½éœ€è¦ç»è¿‡ä¸¤æ¬¡çš„å†…å­˜è®¿é—®ï¼Œè€Œç»è¿‡å†…å­˜å¯¹é½ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>å‡å®šç°åœ¨æœ‰ä¸€ä¸ª 32 ä½å¤„ç†å™¨ï¼Œé‚£è¿™ä¸ªå¤„ç†å™¨ä¸€æ¬¡æ€§è¯»å–æˆ–å†™å…¥éƒ½æ˜¯å››å­—èŠ‚ã€‚</p><p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ª 32 ä½å¤„ç†å™¨è¦è¯»å–ä¸€ä¸ª int ç±»å‹çš„å˜é‡ï¼Œåœ¨å†…å­˜å¯¹é½çš„æƒ…å†µä¸‹ï¼Œå¤„ç†å™¨æ˜¯è¿™æ ·è¿›è¡Œè¯»å–çš„ï¼š</p><p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322180540589-204374352.png" alt="img" style="zoom:80%;">é‚£å¦‚æœæ•°æ®å­˜å‚¨æ²¡æœ‰æŒ‰ç…§å†…å­˜å¯¹é½çš„æ–¹å¼è¿›è¡Œçš„è¯ï¼Œå¤„ç†å™¨å°±ä¼šè¿™æ ·è¿›è¡Œè¯»å–ï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322180810600-1218351587.png" alt="img" style="zoom:80%;"><p>å¯¹æ¯”å†…å­˜å¯¹é½å’Œå†…å­˜æ²¡æœ‰å¯¹é½ä¸¤ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥æ˜æ˜¾åœ°çœ‹åˆ°ï¼Œåœ¨å†…å­˜å¯¹é½çš„æƒ…å†µä¸‹ï¼Œå–å¾—è¿™ä¸ª intå‹ å˜é‡åªéœ€è¦ç»è¿‡ä¸€æ¬¡å¯»å€ï¼ˆ0~3ï¼‰ï¼›</p><p>ä½†åœ¨å†…å­˜æ²¡æœ‰å¯¹é½çš„æƒ…å†µä¸‹ï¼Œå–å¾—è¿™ä¸ª intå‹ å˜é‡éœ€è¦ç»è¿‡ä¸¤æ¬¡çš„å¯»å€ï¼ˆ0<del>3 å’Œ 4</del>7ï¼‰ï¼Œç„¶åå†åˆå¹¶æ•°æ®ã€‚</p><p>é€šè¿‡ä¸Šè¿°çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å†…å­˜å¯¹é½èƒ½å¤Ÿæå‡æ€§èƒ½ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¦è¿›è¡Œå†…å­˜å¯¹é½çš„åŸå› ä¹‹ä¸€ã€‚</p><h2 id="å†…å­˜å¯¹é½çš„åŸåˆ™"><a href="#å†…å­˜å¯¹é½çš„åŸåˆ™" class="headerlink" title="å†…å­˜å¯¹é½çš„åŸåˆ™"></a>å†…å­˜å¯¹é½çš„åŸåˆ™</h2><ol><li>å¯¹äºç»“æ„ä½“çš„å„ä¸ªæˆå‘˜ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªæˆå‘˜çš„åç§»é‡ä¸º 0 å¤–ï¼Œå…¶ä½™æˆå‘˜çš„åç§»é‡æ˜¯ å…¶å®é™…é•¿åº¦ çš„æ•´æ•°å€ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™åœ¨å‰ä¸€ä¸ªæˆå‘˜åé¢è¡¥å……å­—èŠ‚ã€‚</li><li>ç»“æ„ä½“å†…æ‰€æœ‰æ•°æ®æˆå‘˜å„è‡ªå†…å­˜å¯¹é½åï¼Œç»“æ„ä½“æœ¬èº«è¿˜è¦è¿›è¡Œä¸€æ¬¡å†…å­˜å¯¹é½ï¼Œä¿è¯æ•´ä¸ªç»“æ„ä½“å ç”¨å†…å­˜å¤§å°æ˜¯ç»“æ„ä½“å†…æœ€å¤§æ•°æ®æˆå‘˜çš„æœ€å°æ•´æ•°å€ã€‚</li><li>å¦‚ç¨‹åºä¸­æœ‰ #pragma pack(n) é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œåˆ™æ‰€æœ‰æˆå‘˜å¯¹é½ä»¥ nå­—èŠ‚ ä¸ºå‡†ï¼ˆå³åç§»é‡æ˜¯nçš„æ•´æ•°å€ï¼‰ï¼Œä¸å†è€ƒè™‘å½“å‰ç±»å‹ä»¥åŠæœ€å¤§ç»“æ„ä½“å†…ç±»å‹ã€‚</li></ol><p>ä¸‹é¢é€šè¿‡æ ·ä¾‹æ¥åˆ†äº«ä¸€ä¸‹æˆ‘çš„è§è§£ï¼Œä¸ºæ–¹ä¾¿ç†è§£ï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p><ul><li>å®šä¹‰çš„ç»“æ„ä½“åŒ…å« char , short , int , doubleç±»å‹å„ä¸€ä¸ªï¼Œå¹¶é€šè¿‡ä¸åŒçš„ç»„åˆæ„é€ å‡ºä¸åŒçš„ç»“æ„ä½“ Test01 , Test02 , Test03 , Test04</li><li>å†…å­˜åœ°å€çš„ç¼–å·è®¾ç½®ä¸º 0~24</li><li>char ç±»å‹å 1 ä¸ª å­—èŠ‚ï¼Œå¹¶ç”¨æ©™è‰²å¡«å……</li><li>short ç±»å‹å  2ä¸ª å­—èŠ‚ï¼Œå¹¶ç”¨é»„è‰²å¡«å……</li><li>int ç±»å‹å  4ä¸ª å­—èŠ‚ï¼Œå¹¶ç”¨ç»¿è‰²å¡«å……</li><li>double ç±»å‹å  8ä¸ª å­—èŠ‚ï¼Œå¹¶ç”¨è“è‰²å¡«å……</li><li>è¡¥å……å­—èŠ‚ç”¨é»‘è‰²å¡«å……</li></ul><h3 id="å®éªŒ1"><a href="#å®éªŒ1" class="headerlink" title="å®éªŒ1"></a>å®éªŒ1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test01</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">short</span> s;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">double</span> d;<br>&#125;t1;<br></code></pre></td></tr></table></figure><p>å†…å­˜åˆ†å¸ƒæƒ…å†µï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322210431773-1594212085.png" alt="img" style="zoom:80%;"><ul><li>ç¬¬ä¸€ä¸ªæˆå‘˜ c çš„åç§»é‡ä¸º 0ï¼Œæ‰€ä»¥æˆå‘˜ c çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 0</li><li>ç¬¬äºŒä¸ªæˆå‘˜ s çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 2 å·åœ°å€ï¼Œåç§»é‡ä¸º 2 - 0 &#x3D; 2</li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ i çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 4 å·åœ°å€ï¼Œåç§»é‡ä¸º 4 - 0 &#x3D; 4</li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ d çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 8 å·åœ°å€ï¼Œåç§»é‡ä¸º 8 - 0 &#x3D; 8</li><li>Test01 æ‰€å å†…å­˜å¤§å°ä¸º 16 ä¸ªå­—èŠ‚</li></ul><p>è®©æˆ‘ä»¬é€šè¿‡è¾“å‡ºæ¥éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">showTest01</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Test01æ‰€å å†…å­˜å¤§å°ï¼š%d\n&quot;</span>,<span class="hljs-keyword">sizeof</span>(Test01));<br>    <span class="hljs-comment">//å¹¶æŒ‰ç…§å£°æ˜é¡ºåºè¾“å‡º Test01 ä¸­çš„æˆå‘˜å˜é‡åœ°å€å¯¹åº”çš„åå…­è¿›åˆ¶</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;t1.c);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;t1.s);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;t1.i);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;t1.d);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322212203167-1077116233.png" alt="img" style="zoom:80%;"><p>æˆ‘ä»¬å°†è¾“å‡ºçš„åå…­è¿›åˆ¶åœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶ï¼š</p><blockquote><p> 00209400 -&gt; 2135040</p><p> 00209402 -&gt; 2135042</p><p> 00209404 -&gt; 2135044</p><p> 00209408 -&gt; 2135048</p></blockquote><ul><li>ä»¥ç¬¬ä¸€ä¸ªæˆå‘˜ c çš„èµ·å§‹åœ°å€ä¸ºèµ·ç‚¹</li><li>ç¬¬äºŒä¸ªæˆå‘˜ s çš„åç§»é‡ä¸º 2</li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ i çš„åç§»é‡ä¸º 4</li><li>ç¬¬å››ä¸ªæˆå‘˜ d çš„åç§»é‡ä¸º 8</li><li>æ‰€å å†…å­˜å¤§å°ä¸º 16</li></ul><p>éªŒè¯æˆåŠŸï¼</p><h3 id="å®éªŒ2"><a href="#å®éªŒ2" class="headerlink" title="å®éªŒ2"></a>å®éªŒ2</h3><p>è°ƒæ¢ä¸€ä¸‹æˆå‘˜é¡ºåºï¼Œå†æ¬¡æµ‹è¯•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test02</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">double</span> d;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">short</span> s;<br>&#125;t2;<br></code></pre></td></tr></table></figure><p>å†…å­˜åˆ†å¸ƒæƒ…å†µï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322213003845-1448339865.png" alt="img" style="zoom:80%;"><ul><li>ç¬¬ä¸€ä¸ªæˆå‘˜ c çš„åç§»é‡ä¸º 0ï¼Œæ‰€ä»¥æˆå‘˜ c çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 0</li><li>ç¬¬äºŒä¸ªæˆå‘˜ d çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 8 å·åœ°å€ï¼Œåç§»é‡ä¸º 8 - 0 &#x3D; 8ï¼ˆdouble ç±»å‹çš„æ•´å€æ•°ï¼‰</li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ i çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 16 å·åœ°å€ï¼Œåç§»é‡ä¸º 16 - 0 &#x3D; 16ï¼ˆint ç±»å‹çš„æ•´å€æ•°ï¼‰</li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ s çš„å†…å­˜ç©ºé—´çš„é¦–åœ°å€ä¸º 20 å·åœ°å€ï¼Œåç§»é‡ä¸º 20 - 0 &#x3D; 20ï¼ˆshort ç±»å‹çš„æ•´å€æ•°ï¼‰</li><li>Test02 æ‰€å å†…å­˜å¤§å°ä¸º 24 ä¸ªå­—èŠ‚ï¼ˆç»“æ„ä½“å ç”¨å†…å­˜å¤§å°æ˜¯ç»“æ„ä½“å†…æœ€å¤§æ•°æ®æˆå‘˜ double çš„æœ€å°æ•´æ•°å€ï¼š24 &#x2F; 8 &#x3D; 4ï¼‰</li></ul><p>æ¥ç€é€šè¿‡è¾“å‡ºæ¥éªŒè¯ä¸€ä¸‹ï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322213218244-1085267920.png" alt="img" style="zoom:80%;"><p>æˆ‘ä»¬å°†è¾“å‡ºçš„åå…­è¿›åˆ¶åœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶ï¼š</p><blockquote><p> 007C9410 -&gt; 8164368</p><p> 007C9418 -&gt; 8164376</p><p> 007C9420 -&gt; 8164384</p><p> 007C9424 -&gt; 8164388</p></blockquote><ul><li>ä»¥ç¬¬ä¸€ä¸ªæˆå‘˜ c çš„èµ·å§‹åœ°å€ä¸ºèµ·ç‚¹</li><li>ç¬¬äºŒä¸ªæˆå‘˜ d çš„åç§»é‡ä¸º 8164376 - 8164368 &#x3D; 8 </li><li>ç¬¬ä¸‰ä¸ªæˆå‘˜ i çš„åç§»é‡ä¸º 8164384 - 8164368 &#x3D; 16 </li><li>ç¬¬å››ä¸ªæˆå‘˜ d çš„åç§»é‡ä¸º 8164388 - 8164368 &#x3D; 20 </li><li>æ‰€å å†…å­˜å¤§å°ä¸º 24</li></ul><p>éªŒè¯æˆåŠŸï¼</p><h3 id="å®éªŒ3-amp-å®éªŒ4"><a href="#å®éªŒ3-amp-å®éªŒ4" class="headerlink" title="å®éªŒ3 &amp; å®éªŒ4"></a>å®éªŒ3 &amp; å®éªŒ4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test03</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">short</span> s;<br>    <span class="hljs-type">double</span> d;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">int</span> i;<br>&#125;t3;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test04</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">double</span> d;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">short</span> s;<br>&#125;t4;<br></code></pre></td></tr></table></figure><p>å†…å­˜åˆ†å¸ƒæƒ…å†µï¼š</p><img src="/2023/07/11/struct%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/1494888-20220322214300062-750016192.png" alt="img" style="zoom:80%;"><p>å¯è‡ªè¡Œè¾“å‡ºéªŒè¯ï¼ï¼ï¼</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è‡ªè¡Œæ¨¡æ‹Ÿï¼Œå†å›è¿‡å¤´çœ‹çœ‹å†…å­˜å¯¹é½çš„åŸåˆ™ï¼Œæ˜¯ä¸æ˜¯æœ‰ç§æç„¶å¤§æ˜ç™½çš„æ„Ÿè§‰~</p><p>é€šè¿‡æ¨¡æ‹Ÿä¸Šè¿°ä¸åŒæƒ…å†µï¼Œä½ ä¼šå‘ç°åŒç§ç±»å‹çš„æˆå‘˜å˜é‡é€šè¿‡ä¸åŒçš„ç»„åˆï¼Œæ‰€å ç”¨çš„æ€»å†…å­˜æ˜¯ä¸ç›¸åŒçš„ï¼›</p><p>é‚£ä¹ˆï¼Œå…³äºç»“æ„ä½“å†…æˆå‘˜å®šä¹‰çš„é¡ºåºåº”è¯¥éµå¾ªè¿™æ ·ä¸€ä¸ªåŸåˆ™ï¼šæŒ‰ç…§é•¿åº¦é€’å¢çš„é¡ºåºä¾æ¬¡å®šä¹‰å„ä¸ªæˆå‘˜ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>System DE Master Keyæµç¨‹åˆ†æ</title>
    <link href="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <url>/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="System-DE-Master-Keyæµç¨‹åˆ†æ"><a href="#System-DE-Master-Keyæµç¨‹åˆ†æ" class="headerlink" title="System DE Master Keyæµç¨‹åˆ†æ"></a>System DE Master Keyæµç¨‹åˆ†æ</h1><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/cs_tech/article/details/127593457?spm=1001.2014.3001.5506">https://blog.csdn.net/cs_tech/article/details/127593457?spm=1001.2014.3001.5506</a></p><p>ä»…ä½œè‡ªå·±å­¦ä¹ å¤‡å¿˜ï¼Œä¾µæƒè”ç³»åˆ é™¤</p></blockquote><h2 id="1-åˆ›å»º-System-DE-Master-Key-æµç¨‹"><a href="#1-åˆ›å»º-System-DE-Master-Key-æµç¨‹" class="headerlink" title="1. åˆ›å»º System DE Master Key æµç¨‹"></a>1. åˆ›å»º System DE Master Key æµç¨‹</h2><p>ä¸‹å›¾å±•ç¤ºäº†åœ¨è®¾å¤‡ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œåˆ›å»º System DE Master Key çš„å®Œæ•´æµç¨‹ï¼Œåœ¨è¿™ä¸ªç« èŠ‚ä¼šå¯¹å…¶æ‹†åˆ†ï¼Œåˆ†åˆ«ä»‹ç»ã€‚</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/b325b451b58545b2aa95646471b01109.png" alt="img" style="zoom:80%;"><h3 id="1-1-åˆ›å»º-System-DE-Master-Key"><a href="#1-1-åˆ›å»º-System-DE-Master-Key" class="headerlink" title="1.1 åˆ›å»º System DE Master Key"></a>1.1 åˆ›å»º System DE Master Key</h3><p>åœ¨ vold å‡½æ•° fscrypt_initialize_systemwide_keys ä¸­ï¼ŒVold é€šè¿‡ keymaster HAL å‘ keymaster TA è¯·æ±‚åˆ›å»º Master Keyã€‚åœ¨è¯·æ±‚å‚æ•°ä¸­ï¼Œ km::TAG_STORAGE_KEY è¡¨æ˜äº†åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨å™¨åŠ å¯†çš„ Master Keyï¼ŒHLOS å°†è¿™ä¸ª key ç”¨ä½œ System DE Master Keyã€‚</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/a564146a9d814d8987692446b88e4d1f.png" alt="img" style="zoom: 50%;"><p>è¿™é‡Œè¦æ³¨æ„ keymaster TA ä¸ä¼šç›´æ¥å°† Master Key çš„æ˜æ–‡ç›´æ¥è¿”å›åˆ° HLOSï¼Œè€Œæ˜¯ Master Key Blobã€‚é‚£ä¹ˆ Master Key Blob æ˜¯æ€ä¹ˆç”Ÿæˆçš„ï¼Ÿ</p><ol><li>KM TA é¦–é€‰åˆ›å»ºä¸€ä¸ª AES ç®—æ³•åŠ å¯† keyï¼Œä½œä¸º Master Keyï¼›</li><li>ä½¿ç”¨ç”± SHK æ´¾ç”Ÿå‡ºæ¥çš„ KEK å°† Master Key åŠ å¯†ï¼Œå¹¶æŠŠå¯†æ–‡å­˜æ”¾åˆ°ç‰¹æ®Šæ•°æ®ç»“æ„ï¼Œå³ key blobï¼›</li><li>å†ä½¿ç”¨ç”± SHK æ´¾ç”Ÿå‡ºæ¥çš„ HMAC Key é€šè¿‡ HMAC ç®—æ³•å¯¹ key blob ç­¾åï¼›</li><li>è¿™æ ·å°±ç”Ÿæˆäº† Master Key Blobï¼Œè¿”å›åˆ° HLOS çš„ Voldï¼›</li></ol><p><strong>ç–‘é—®ï¼šSHK æ˜¯ä»€ä¹ˆï¼ŸKEK æ˜¯ä»€ä¹ˆï¼ŸHMAC Key æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>â‘  SHK æ˜¯è®¾å¤‡ä½¿èƒ½ secure boot åï¼Œç”Ÿæˆçš„ä¸€ä¸ªæ¯ä¸ªè®¾å¤‡å”¯ä¸€ã€è½¯ä»¶æˆ–è€…å›ºä»¶æ— æ³•å¯¼å‡ºçš„ keyï¼ŒTZ å¯ä»¥ä» SHK æ´¾ç”Ÿå‡ºå„ç§ç”¨é€”çš„ keyã€‚</p><p>â‘¡ KEK æ´¾ç”Ÿè‡ª SHK ï¼Œç”¨äºåŠ å¯† KM TA ç”Ÿæˆçš„ keyï¼Œå› ä¸º key ä¸å…è®¸æš´éœ²åœ¨ HLOSï¼š</p><ul><li>å½“ HLOS è¯·æ±‚ KM TA ç”Ÿæˆ key æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ KEK å°† key åŠ å¯†æˆ key blob åè¿”å›ç»™ HLOSï¼›</li><li>key åªèƒ½åœ¨ secure world ä¸‹ä½¿ç”¨ï¼ˆåŒ…æ‹¬ï¼šåŠ å¯†ã€è§£å¯†ã€ç­¾åã€æ ¡éªŒç­‰æ“ä½œï¼‰ã€‚å› æ­¤æ—¶ HLOS æœ‰éœ€æ±‚æ—¶ï¼Œè¯·æ±‚ KM TA æ‰§è¡Œç›¸å…³æ“ä½œï¼Œéœ€è¦å°†æ•°æ®å’Œ key blob ä¸€èµ·ä¼ ç»™ KM TAï¼ŒKM TA ä½¿ç”¨ KEK è§£å¯† key blob å¾—åˆ° keyï¼Œå†å¯¹æ•°æ®æ‰§è¡Œç›¸å…³çš„æ“ä½œï¼›</li></ul><p>â‘¢ HMAC Key æ´¾ç”Ÿè‡ª SHK ï¼Œç”¨äºå¯¹ key blob ç­¾åï¼Œä¿è¯äº†  key blob ä¸è¢«æ¶æ„ç¯¡æ”¹æˆ–è€…æ£€æŸ¥æ˜¯å¦æŸåï¼›</p><p><strong>ç–‘é—®ï¼šä¸ºä»€ä¹ˆ TZ è¦å°† key åŠ å¯†åè¿”å› HLOS å‘¢ï¼Ÿ</strong></p><p>åœ¨å®é™…ç”¨æˆ·åœºæ™¯ä¸­ï¼Œå„ç§å„æ ·çš„è¿›ç¨‹å¯èƒ½ä¼šåˆ›å»ºå‡ åä¸ªç”šè‡³å‡ ç™¾ä¸ªç”¨äºå„ç§å„æ ·çš„ä»»åŠ¡çš„ keyï¼ŒåŠ å¯†åè¿”å› HLOSï¼Œç”±ä½¿ç”¨è€…è‡ªè¡Œç®¡ç†ï¼Œé‚£ä¹ˆ TZ å°±æ— éœ€ç»´æŠ¤è¾ƒå¤§çš„å­˜å‚¨åŒºåŸŸä»¥åŠè¿™äº› key ä¸å®¢æˆ·ç«¯çš„è”ç³»ã€‚</p><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> KeyGeneration <span class="hljs-title">makeGen</span><span class="hljs-params">(<span class="hljs-type">const</span> EncryptionOptions&amp; options)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> KeyGeneration&#123;FSCRYPT_MAX_KEY_SIZE, <span class="hljs-literal">true</span>, options.use_hw_wrapped_key&#125;;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">retrieveOrGenerateKey</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key_path, <span class="hljs-type">const</span> std::string&amp; tmp_path,</span></span><br><span class="hljs-params"><span class="hljs-function">                           <span class="hljs-type">const</span> KeyAuthentication&amp; key_authentication, <span class="hljs-type">const</span> KeyGeneration&amp; gen,</span></span><br><span class="hljs-params"><span class="hljs-function">                           KeyBuffer* key)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pathExists</span>(key_path)) &#123;<br>        <span class="hljs-built_in">LOG</span>(DEBUG) &lt;&lt; <span class="hljs-string">&quot;Key exists, using: &quot;</span> &lt;&lt; key_path;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">retrieveKey</span>(key_path, key_authentication, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!gen.allow_gen) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;No key found in &quot;</span> &lt;&lt; key_path;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Creating new key in &quot;</span> &lt;&lt; key_path;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateStorageKey</span>(gen, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ç”ŸæˆMaster Key</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">storeKeyAtomically</span>(key_path, tmp_path, key_authentication, *key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ç”Ÿæˆæœ€ç»ˆçš„åŠ å¯†ç§˜é’¥encrypted key</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆè°ƒç”¨generateStorageKeyç”ŸæˆMaster Keyï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">generateStorageKey</span><span class="hljs-params">(<span class="hljs-type">const</span> KeyGeneration&amp; gen, KeyBuffer* key)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (gen.use_hw_wrapped_key) &#123;  <span class="hljs-comment">/* ä½¿ç”¨ç¡¬ä»¶ç”Ÿæˆå¯†é’¥ */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">generateWrappedStorageKey</span>(key);<br>    &#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">/* çº¯è½¯ç”Ÿæˆéšæœºç§˜é’¥ */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">randomKey</span>(gen.keysize, key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨generateWrappedStorageKeyç”Ÿæˆç§˜é’¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">generateWrappedStorageKey</span><span class="hljs-params">(KeyBuffer* key)</span> </span>&#123;<br>    Keymaster keymaster;  <span class="hljs-comment">// åˆ›å»ºå¯¹è±¡</span><br>    <span class="hljs-keyword">if</span> (!keymaster) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string key_temp;<br>    <span class="hljs-keyword">auto</span> paramBuilder = km::<span class="hljs-built_in">AuthorizationSetBuilder</span>().<span class="hljs-built_in">AesEncryptionKey</span>(AES_KEY_BYTES * <span class="hljs-number">8</span>);<br>    paramBuilder.<span class="hljs-built_in">Authorization</span>(km::TAG_STORAGE_KEY);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateKeymasterKey</span>(keymaster, paramBuilder, &amp;key_temp)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">//</span><br>    *key = <span class="hljs-built_in">KeyBuffer</span>(key_temp.<span class="hljs-built_in">size</span>());<br>    <span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(key-&gt;<span class="hljs-built_in">data</span>()), key_temp.<span class="hljs-built_in">c_str</span>(), key-&gt;<span class="hljs-built_in">size</span>());  <span class="hljs-comment">// å°†ä¸´æ—¶ç”Ÿæˆçš„ç§˜é’¥æ‹·è´åˆ°keyä¸­</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">generateKeymasterKey</span><span class="hljs-params">(Keymaster&amp; keymaster,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> km::AuthorizationSetBuilder&amp; paramBuilder,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 std::string* key)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> paramsWithRollback = paramBuilder;<br>    paramsWithRollback.<span class="hljs-built_in">Authorization</span>(km::TAG_ROLLBACK_RESISTANCE);<br>    <span class="hljs-keyword">if</span> (!keymaster.<span class="hljs-built_in">generateKey</span>(paramsWithRollback, key)) &#123; <span class="hljs-comment">// è°ƒç”¨keymasterå¯¹è±¡çš„generateKeyæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (!keymaster.<span class="hljs-built_in">generateKey</span>(paramBuilder, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Keymaster::generateKey</span><span class="hljs-params">(<span class="hljs-type">const</span> km::AuthorizationSet&amp; inParams, std::string* key)</span> </span>&#123;<br>    ks2::KeyDescriptor in_key = &#123;<br>            .domain = ks2::Domain::BLOB,<br>            .alias = std::<span class="hljs-literal">nullopt</span>,<br>            .nspace = VOLD_NAMESPACE,<br>            .blob = std::<span class="hljs-literal">nullopt</span>,<br>    &#125;;<br>    ks2::KeyMetadata keyMetadata;<br>    <span class="hljs-comment">// securityLevelæ˜¯å…±äº«æ™ºèƒ½æŒ‡é’ˆstd::shared_ptr&lt;ks2::IKeystoreSecurityLevel&gt; securityLevel;</span><br>    <span class="hljs-keyword">auto</span> rc = securityLevel-&gt;<span class="hljs-built_in">generateKey</span>(in_key, std::<span class="hljs-literal">nullopt</span>, inParams.<span class="hljs-built_in">vector_data</span>(), <span class="hljs-number">0</span>, &#123;&#125;, &amp;keyMetadata);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">logKeystore2ExceptionIfPresent</span>(rc, <span class="hljs-string">&quot;generateKey&quot;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (keyMetadata.key.blob == std::<span class="hljs-literal">nullopt</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;keystore2 generated key blob was null&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (key) *key = std::<span class="hljs-built_in">string</span>(keyMetadata.key.blob-&gt;<span class="hljs-built_in">begin</span>(), keyMetadata.key.blob-&gt;<span class="hljs-built_in">end</span>());<br><br>    <span class="hljs-built_in">zeroize_vector</span>(keyMetadata.key.blob.<span class="hljs-built_in">value</span>());<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œé¢æœ‰ä¸ªåœ°æ–¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼ŒIKeystoreSecurityLevelè¿™ä¸ªé‡Œé¢æä¾›çš„aidlæ¥å£ï¼Œå‚è€ƒ<a href="https://blog.csdn.net/weixin_42135087/article/details/125172636">https://blog.csdn.net/weixin_42135087/article/details/125172636</a></p></blockquote><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230711231226553.png" alt="image-20230711231226553" style="zoom:67%;"><h3 id="1-2-HLOS-æŠŠ-System-DE-Master-Key-Blob-åŠ å¯†åä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ"><a href="#1-2-HLOS-æŠŠ-System-DE-Master-Key-Blob-åŠ å¯†åä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.2 HLOS æŠŠ System DE Master Key Blob åŠ å¯†åä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ"></a>1.2 HLOS æŠŠ System DE Master Key Blob åŠ å¯†åä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ</h3><p>åœ¨ä¸Šä¸€ä¸ªæ­¥éª¤ä¸­ï¼ŒKM TA åˆ›å»ºäº† Master Key ï¼ˆ km::TAG_STORAGE_KEY FBEï¼‰ï¼Œå¹¶ä»¥ key blob çš„å½¢å¼è¿”å›åˆ° HLOSã€‚åœ¨ vold æ”¶åˆ° Master Key Blob åï¼Œåˆå°†è¿™ä¸ª key blob åŠ å¯†åä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/da064c351cf545baac70a0203018796f.png" alt="img" style="zoom: 67%;"><p><strong>ç–‘é—®ï¼šMaster Key Blob å·²ç»æ˜¯å¯†æ–‡äº†ï¼Œä¸ºä»€ä¹ˆ vold è¿˜è¦å°† key blob äºŒæ¬¡åŠ å¯†ï¼Ÿ</strong></p><p>è¿™ä¸ªæ“ä½œä¼¼ä¹æœ‰ç‚¹å¤šä½™ï¼Œå¦‚æœå¯¹ key åŠ å¯†ä¸€æ¬¡ä¸å®‰å…¨ï¼Œé‚£ä¹ˆåŠ å¯†ä¸¤æ¬¡ä¹Ÿä¸è§å¾—æ›´å®‰å…¨ï¼Œæˆ–è€…ä¸ºä»€ä¹ˆä¸åŠ å¯†æ›´å¤šæ¬¡å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬è¦ä» FBE çš„è®¾è®¡æ¥çœ‹ï¼Œ<strong>Google æŠŠ userdata åˆ†åŒºåˆ’åˆ†äº†ä¸åŒå®‰å…¨ç­‰çº§çš„å­˜å‚¨ä½ç½®ï¼Œä½†ä»…ä½¿ç”¨ä¸åŒçš„å¯†é’¥å¹¶ä¸èƒ½ä½“ç°å‡ºå®‰å…¨ç­‰çº§è¿™ä¸ªæ¦‚å¿µï¼Œè€Œæ˜¯è¦ä»å¯¹å¯†é’¥çš„çº¦æŸæ¥ä½“ç°ï¼Œæ¯”å¦‚ç»è¿‡ä»€ä¹ˆæ ·çš„è®¤è¯åï¼Œå“ªäº›ä½ç½®çš„æ•°æ®æ‰å…è®¸è®¿é—®ï¼Œè¨€ä¸‹ä¹‹æ„å°±æ˜¯å¯¹åº”çš„åŠ å¯†å¯†é’¥æ‰å…è®¸è¢«ä½¿ç”¨ã€‚</strong>é‚£æ€ä¹ˆè®¤è¯å‘¢ï¼Ÿ</p><p>System DE Master Key çš„å®‰å…¨è®¤è¯æ­£æ˜¯é€šè¿‡äºŒæ¬¡åŠ å¯†æ¥ä½“ç°çš„ï¼Œä½†æ˜¯åŠ å¯† Master Key çš„ key ï¼ˆKEKï¼‰ æ€ä¹ˆåšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼ŸSystem DE çš„è®¾è®¡åˆè¡·å°±æ˜¯ç›¸åº”çš„å­˜å‚¨ä½ç½®æ˜¯è®¾å¤‡ç»‘å®šï¼Œå³è¿™äº›å­˜å‚¨ä½ç½®çš„æ•°æ®åªèƒ½åœ¨ç‰¹å®šçš„è®¾å¤‡ï¼ˆCPUã€å­˜å‚¨å™¨ç»‘å®šï¼‰ä¸Šæ‰èƒ½è§£å¯†å’Œè®¿é—®ã€‚Master Key åªè´Ÿè´£ç”¨æˆ·åŠ è§£å¯†æ–‡ä»¶çš„æ•°æ®ï¼Œä½†æ˜¯ç‰¹å®šçš„è®¾å¤‡æ€ä¹ˆä¿è¯å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯åŠ å¯† Master Key çš„ key è¦è¾¾æˆçš„ç›®æ ‡ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª key ç§°ä½œ KSKï¼ˆKey Strorage Keyï¼Œè¿™ä¸æ˜¯ä¸“æœ‰åè¯ï¼Œè€Œæ˜¯æŒ‰ç…§ Google ä»£ç å˜é‡åæ¥å‘½å ï¼‰ã€‚</p><p>ä»æµç¨‹å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆ›å»º KSK æ—¶éœ€è¦æŒ‡å®š app idï¼ˆå³è¡¨æ˜è°åˆ›å»ºçš„ï¼Ÿï¼‰ã€‚åŒæ ·åç»­ä½¿ç”¨è¿™ä¸ª key æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šç›¸åŒçš„ appidã€‚appid çš„ç»„æˆä¸­åŒ…æ‹¬è®¾å¤‡ç»‘å®šçš„ä¿¡æ¯ï¼ˆæ¯å°è®¾å¤‡ï¼ŒKSK çš„ appid ä¸ä¸€æ ·ï¼Œå› ä¸ºä»å®ƒçš„åˆ›å»ºæµç¨‹å¯ä»¥çœ‹å‡ºï¼ŒåŒ…æ‹¬ä¸¤ä¸ªéšæœºæ•° Secdiscardable å’Œ storage_binding_info.seedï¼‰ã€‚ä¸ä»…å¦‚æ­¤ï¼Œåœ¨ KM TA å†…éƒ¨è¿˜ä¼šå°† secure boot çŠ¶æ€ã€è®¾å¤‡é”çŠ¶æ€ã€å®‰å…¨è¡¥ä¸æ—¥æœŸç­‰ç­‰ä¿¡æ¯å’Œ KSK ç»‘å®šï¼Œåœ¨ä½¿ç”¨ KSK ä¹‹å‰ï¼Œä¼šæ ¡éªŒç›¸å…³çš„ä¿¡æ¯æ˜¯å¦ä¸¥æ ¼åŒ¹é…ï¼Œåªæœ‰å®Œå…¨æ»¡è¶³åï¼ŒKSK æ‰å…è®¸ç”¨äºè§£å¯† Master Blobã€‚è¿™äº›çº¦æŸçš„å®ç°éƒ½æ˜¯åœ¨ KM TA å®Œæˆçš„ã€‚</p><p>è¿™é‡Œä¸¾å‡ ä¸ªå®é™…çš„ä¾‹å­è¯´æ˜ï¼š</p><blockquote><p><strong>ä¾‹1ï¼šæŠŠä¸€å°è®¾å¤‡çš„å­˜å‚¨å™¨æ‰€æœ‰æ•°æ®ï¼Œdump åˆ°å¦å¤–ä¸€å°å®Œå…¨ä¸€è‡´çš„è®¾å¤‡ä¸Šï¼Œç”¨æˆ·æ•°æ®ä¸ºä»€ä¹ˆæ— æ³•è§£å¯†ï¼Ÿ</strong></p><p>å› ä¸º KSK å·²ç»å’Œ secure boot çŠ¶æ€ç»‘å®šï¼Œåœ¨å¦å¤–ä¸€å°è®¾å¤‡ä¸Šï¼Œæ— æ³•çŸ¥é“ EKEï¼Œè¿›è€Œæ— æ³•è§£å¯† KSK blobï¼ŒKSK å³æ— æ³•è¢«ä½¿ç”¨ã€‚å½“ç„¶è¢« KSK åŠ å¯†çš„ master key blob ä¹Ÿæ— æ³•è§£å¯†ï¼Œè‡ªç„¶è·å–ä¸åˆ° master key ã€‚å®é™…å®ç°ä¸åªå¦‚æ­¤ç®€å•ï¼Œè¿™é‡Œä¸åšè¯¦ç»†ä»‹ç»ã€‚</p><p><strong>ä¾‹2ï¼šåŒä¸€å°è®¾å¤‡ï¼Œå¦‚æœ OTA æ›´æ–°åˆ°å®‰å…¨è¡¥ä¸æ—¥æœŸå‡çº§çš„è½¯ä»¶åï¼Œå†å›æ»šåˆ°æ—§è½¯ä»¶ç‰ˆæœ¬ï¼Œç”¨æˆ·æ•°æ®ä¸ºä»€ä¹ˆæ— æ³•è§£å¯†ï¼Ÿ</strong></p><p>å› ä¸º KSK å·²ç»å’Œå®‰å…¨è¡¥ä¸æ—¥æœŸç»‘å®šï¼Œå®‰å…¨è¡¥ä¸æ—¥æœŸä¸èƒ½å‡å°ã€‚å®‰å…¨è¡¥ä¸æ—¥æœŸå›æ»šåï¼ŒKSK å°†ä¸å¯ç”¨ã€‚</p><p><strong>ä¾‹3ï¼šè®¾å¤‡ç¬¬ä¸€æ¬¡å¼€æœºæ˜¯åœ¨è®¾å¤‡é”ï¼ˆä¹Ÿå« fastbooté”ï¼‰é”å®šçš„æƒ…å†µä¸‹å¼€æœºï¼Œé‚£ä¹ˆ unlock è®¾å¤‡é”åï¼Œç”¨æˆ·æ•°æ®ä¸ºä»€ä¹ˆæ— æ³•è§£å¯†ï¼Ÿ</strong></p><p>å› ä¸º KSK å’Œè®¾å¤‡é”çš„çŠ¶æ€ç»‘å®šï¼Œå¦‚æœè®¾å¤‡é”çš„çŠ¶æ€å‡ºç°åè½¬ï¼ŒKSK å°†ä¸å¯ç”¨ã€‚</p></blockquote><p><strong>ç–‘é—®ï¼šåŠ å¯† Master Key Blob çš„ key KSK ä»ä½•è€Œæ¥ ï¼Ÿ</strong></p><p>å’Œ Master Key ç±»ä¼¼ï¼Œéƒ½æ˜¯ç”± KM TA åˆ›å»ºçš„ï¼Œå¹¶ä»¥ key blob çš„å½¢å¼è¿”å› HLOSï¼Œç”± vold è‡ªè¡Œç®¡ç†ã€‚è¿™é‡Œæ³¨æ„åˆ›å»º key æ—¶ï¼Œå‚æ•° km::AuthorizationSet ä¸ä¸€æ ·ï¼Œè¿™å°±å¯¼è‡´åœ¨ KM TA å†…éƒ¨ï¼Œå®ƒä»¬çš„ç®¡ç†å’Œç”¨é€”éƒ½æ˜¯ä¸ä¸€æ ·ã€‚</p><p>vold è¯·æ±‚ KM TA åˆ›å»º KSK æ‰€ä½¿ç”¨çš„ appidçš„å‚æ•°ã€KSK Blobã€åŠ å¯†åçš„ Master Key Blob è¢«å­˜å‚¨åˆ° &#x2F;data&#x2F;unencrypted&#x2F;key&#x2F;ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ls /data/unencrypted/key/ -l</span><br>total 16<br>-rw------- 1 root root   268 1970-01-03 04:47 encrypted_key<br>-rw------- 1 root root   194 1970-01-03 04:47 keymaster_key_blob<br>-rw------- 1 root root 16384 1970-01-03 04:47 secdiscardable<br>-rw------- 1 root root    10 1970-01-03 04:47 stretching<br>-rw------- 1 root root     1 1970-01-03 04:47 version<br></code></pre></td></tr></table></figure><p><strong>ç–‘é—®ï¼šç¬¬ä¸€æ¬¡å¼€æœºæ—¶ï¼Œä¸ºä»€ä¹ˆè¦æŠŠ KSK blob  å’Œ åŠ å¯†åçš„ Master Key Blob ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Ÿ</strong></p><p>åç»­æ¯æ¬¡å¼€æœºï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ KSK blob ï¼ˆ&#x2F;data&#x2F;unencrypted&#x2F;key&#x2F;keymaster_key_blobï¼‰è§£å¯†Master Key Blob çš„å¯†æ–‡ï¼ˆ&#x2F;data&#x2F;unencrypted&#x2F;keyencrypted_keyï¼‰å¾—åˆ° Master Key Blobï¼Œè¿™ä¸ªåŠ¨ä½œæ˜¯åœ¨ TZ å†…éƒ¨å®Œæˆçš„ï¼Œæœ‰äº† Master Key Blobï¼Œé‚£ä¹ˆå¯ä»¥å°† Master Key å®‰è£…åˆ° kernel keyringï¼Œè¯¦è§ä¸‹æ–‡ã€‚</p><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">storeKey</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; dir, <span class="hljs-type">const</span> KeyAuthentication&amp; auth, <span class="hljs-type">const</span> KeyBuffer&amp; key)</span> </span>&#123;<br><span class="hljs-comment">// å°†kCurrentVersion(1)å†™å…¥åˆ°/data/unencrypted/key/version</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kCurrentVersion, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_version)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string secdiscardable_hash;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">createSecdiscardable</span>(dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_secdiscardable, &amp;secdiscardable_hash)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string stretching = <span class="hljs-built_in">getStretching</span>(auth);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(stretching, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_stretching)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string appId;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateAppId</span>(auth, stretching, secdiscardable_hash, &amp;appId)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string encryptedKey;<br>    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) &#123;<br>        Keymaster keymaster;<br>        <span class="hljs-keyword">if</span> (!keymaster) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        std::string kmKey;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateKeyStorageKey</span>(keymaster, appId, &amp;kmKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kmKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_keymaster_key_blob)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        km::AuthorizationSet keyParams = <span class="hljs-built_in">beginParams</span>(appId);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithKeymasterKey</span>(keymaster, dir, keyParams, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithoutKeymaster</span>(appId, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(encryptedKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_encrypted_key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">FsyncDirectory</span>(dir)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-1-å†™å…¥version"><a href="#1-2-1-å†™å…¥version" class="headerlink" title="1.2.1 å†™å…¥version"></a>1.2.1 å†™å…¥version</h4><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230711231926237.png" alt="image-20230711231926237" style="zoom: 67%;"><h4 id="1-2-2-å†™å…¥secdiscardable"><a href="#1-2-2-å†™å…¥secdiscardable" class="headerlink" title="1.2.2 å†™å…¥secdiscardable"></a>1.2.2 å†™å…¥secdiscardable</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// filename: /data/unencrypted/key/secdiscardable</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">createSecdiscardable</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename, std::string* hash)</span> </span>&#123;<br>    std::string secdiscardable;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">readRandomBytesOrLog</span>(SECDISCARDABLE_BYTES, &amp;secdiscardable)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// é€šè¿‡/dev/urandomç”Ÿæˆéšæœºæ•°</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(secdiscardable, filename)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// å°†ç”Ÿæˆçš„éšæœºæ•°ä¿å­˜åˆ°/data/unencrypted/key/secdiscardable</span><br>    <span class="hljs-built_in">hashWithPrefix</span>(kHashPrefix_secdiscardable, secdiscardable, hash); <span class="hljs-comment">// å°†ç”Ÿæˆçš„éšæœºæ•°å–hash</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-3-å†™å…¥stretching"><a href="#1-2-3-å†™å…¥stretching" class="headerlink" title="1.2.3 å†™å…¥stretching"></a>1.2.3 å†™å…¥stretching</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++">std::string stretching = <span class="hljs-built_in">getStretching</span>(auth); <span class="hljs-comment">// å¦‚æœæœ‰é”å±å¯†ç å€¼ä¸ºnoneï¼Œæ²¡æœ‰é”å±å¯†ç ä¸ºnopassword</span><br><span class="hljs-built_in">writeStringToFile</span>(stretching, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_stretching);<span class="hljs-comment">// å°†stretchingå€¼å†™å…¥åˆ°/data/unencrypted/key/stretching</span><br><br><br><span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">getStretching</span><span class="hljs-params">(<span class="hljs-type">const</span> KeyAuthentication&amp; auth)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) &#123;<br>        <span class="hljs-keyword">return</span> kStretch_nopassword;  <span class="hljs-comment">// nopassword</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> kStretch_none;  <span class="hljs-comment">// none</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¾—è¯´ä¸‹ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œauthçš„usesKeymasterè¿”å›true</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230712213844099.png" alt="image-20230712213844099" style="zoom:50%;"><p>æˆ‘ä»¬çŸ¥é“è¿™ä¸ªsecretæ˜¯ä»FWKä¼ ä¸‹æ¥çš„é”å±Credentialã€‚</p><p><strong>æ‰€ä»¥å¦‚æœsecretä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œè¿”å›Trueï¼</strong></p><h4 id="1-2-4-å†™å…¥keymaster-key-blob"><a href="#1-2-4-å†™å…¥keymaster-key-blob" class="headerlink" title="1.2.4 å†™å…¥keymaster_key_blob"></a>1.2.4 å†™å…¥keymaster_key_blob</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::string appId;<br><span class="hljs-comment">// // ç”ŸæˆappIdï¼Œå¦‚æœè®¾ç½®äº†é”å±å¯†ç ï¼Œåˆ™ä¸ºappId = secdiscardable_hash + auth.secretï¼›æ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œåˆ™appId = secdiscardable_hash</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateAppId</span>(auth, stretching, secdiscardable_hash, &amp;appId)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>std::string encryptedKey;<br><span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) &#123;  <span class="hljs-comment">// æ²¡æœ‰é”å±å¯†ç çš„æ—¶å€™</span><br>    Keymaster keymaster;<br>    <span class="hljs-keyword">if</span> (!keymaster) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string kmKey;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateKeyStorageKey</span>(keymaster, appId, &amp;kmKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å°†ç”Ÿæˆçš„KSK Blobå†™å…¥åˆ°/data/unencrypted/key/keymaster_key_blob</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kmKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_keymaster_key_blob)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    km::AuthorizationSet keyParams = <span class="hljs-built_in">beginParams</span>(appId);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithKeymasterKey</span>(keymaster, dir, keyParams, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// æœ‰é”å±å¯†ç çš„æ—¶å€™ç”ŸæˆéšæœºencryptedKey</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithoutKeymaster</span>(appId, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰generateKeyStorageKeyç”ŸæˆKSK Blob</p><p>è¿™é‡ŒSystem CE Master Keyèµ°çš„æ˜¯keymasterç®¡ç†åˆ†æ”¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++">generateKeyStorageKey<br>     -&gt; generateKeymasterKey<br>    -&gt; keymaster.generateKey<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†keymasterçš„generateKeyæ–¹æ³•ï¼ˆ1.1èŠ‚åˆ›å»ºMaster Keyçš„æ—¶å€™å·²ç»åˆ›å»ºè¿‡ä¸€æ¬¡äº†ï¼‰ï¼Œä¸åŒç‚¹åœ¨äºï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„æ˜¯Master Keyçš„Blob</li><li>è¿™æ¬¡ç”Ÿæˆçš„æ˜¯KeyStorageKeyï¼ˆç®€ç§°KSKï¼‰çš„Blob</li><li>è‡³äºä¸ºä»€ä¹ˆè¦å†ç”ŸæˆKSK Blobï¼Œä¸Šé¢åšä¸»å·²ç»å†™å¾—å¾ˆæ¸…æ¥šäº†</li></ul><p>ï¼ˆ2ï¼‰encryptWithKeymasterKeyå°†ç”Ÿæˆçš„KSK Blobå¯¹Master Key BlobäºŒæ¬¡åŠ å¯†ï¼Œç”Ÿæˆæœ€ç»ˆçš„encryptedKey</p><h4 id="1-2-5-å†™å…¥encrypted-key"><a href="#1-2-5-å†™å…¥encrypted-key" class="headerlink" title="1.2.5 å†™å…¥encrypted_key"></a>1.2.5 å†™å…¥encrypted_key</h4><p>ä¸Šé¢ç”Ÿæˆäº†æœ€ç»ˆçš„åŠ å¯†ç§˜é’¥encrypted_keyï¼Œéšåå†™å…¥åˆ°&#x2F;data&#x2F;unencrypted&#x2F;key&#x2F;encrypted_key</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230712215850630.png" alt="image-20230712215850630" style="zoom:67%;"><h3 id="1-3-å®‰è£…-Master-Key-åˆ°-kernel-keyring"><a href="#1-3-å®‰è£…-Master-Key-åˆ°-kernel-keyring" class="headerlink" title="1.3 å®‰è£… Master Key åˆ° kernel keyring"></a>1.3 å®‰è£… Master Key åˆ° kernel keyring</h3><p>åœ¨ä¸Šä¸€æ­¥éª¤ä¸­ï¼Œå·²ç»æˆåŠŸåˆ›å»ºäº† Master Keyï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯è¦æŠŠ Master Key æ³¨å†Œåˆ° kernel keyringã€‚åœ¨æ–‡ä»¶ I&#x2F;O æ—¶å¯ä»¥é€šè¿‡  Encryption Policy çš„ master_key_identifier å­—æ®µä» kernel keyring ä¸­æ‰¾åˆ° Master Keyã€‚</p><p>åœ¨è¿™ä¸ªæ­¥éª¤ä¸­çš„ä¸¤ä¸ªé‡ç‚¹æ“ä½œï¼š</p><ol><li>å®‰è£… Master Key åˆ° kernel keyringï¼›</li><li>ç”Ÿæˆ Master Key çš„ master_key_identifierï¼›</li></ol><p>è½¯ä»¶æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/d231d91958ff4902bc5118818bb13942.png" alt="img" style="zoom: 80%;"><p>æµç¨‹å›¾æ¯”è¾ƒå¤æ‚ï¼Œæ¥ä¸‹æ¥æ ¹æ®ç–‘é—®æ¥åˆ†è§£å›¾ä¸­çš„æ­¥éª¤ã€‚</p><p><strong>ç–‘é—®ï¼š Master Key ä¸æ˜¯ä¸å…è®¸æš´éœ²åœ¨ HLOS å—ï¼Ÿé‚£æ³¨å†Œåˆ° kernel keyring çš„ Master Key ä»ä½•è€Œæ¥ï¼Ÿ</strong></p><p>å®é™…ä¸Šæ˜¯ Master Key çš„ Wrapped Key è¢«æ³¨å†Œåˆ° kernel keyring ï¼Œæ¯•ç«Ÿ Master Key ç¡®å®ä¸èƒ½æš´éœ²åœ¨ HLOSã€‚é‚£ Wrapped Key ä»ä½•è€Œæ¥ï¼Ÿ</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/e885b34443284656a74001cbcaaef2c1.png" alt="img" style="zoom: 80%;"><p> ä»å›¾ä¸­å¯çŸ¥ï¼Œç”Ÿæˆ Wrapped Key çš„è¿‡ç¨‹ï¼š</p><ol><li>vold æŠŠ Master Key Blob ä¼ é€åˆ° KM TAï¼Œè¯·æ±‚åˆ›å»º Wrapped Keyï¼›</li><li>KM TA ä½¿ç”¨ HMAC Key æ ¡éªŒ Master Key Blob ï¼›</li><li>KM TA ä½¿ç”¨ KEK è§£å¯† Master Key Blob å¾—åˆ° Master Keyï¼›</li><li>KM TA ä½¿ç”¨ Ephemeral Key é€šè¿‡ AES Wrap Key RFC3394 Algorithm ç”Ÿæˆ Master Key çš„ Wrapped Key<ol><li>Ephemeral Keyï¼šä» SHK  æ´¾ç”Ÿè€Œæ¥ï¼Œä½†æ˜¯æ¯æ¬¡è®¾å¤‡é‡å¯ï¼ˆcold rebootï¼‰éƒ½ä¼šæ”¹å˜ï¼Œæ„å‘³ç€ Wrapped Key æ¯æ¬¡è®¾ç½®é‡å¯éƒ½ä¸ä¸€æ ·ï¼›</li><li>AES Wrap Key RFC3394 Algorithmï¼šè¯¦è§ <a href="https://www.ietf.org/rfc/rfc3394.txt">Advanced Encryption Standard (AES) Key Wrap Algorithm</a></li></ol></li><li>KM TA å°†ç”Ÿæˆçš„ Wrapped Key è¿”å› HLOS voldï¼›</li><li>Vold é€šè¿‡ç³»ç»Ÿè°ƒç”¨ ioctl  FS_IOC_ADD_ENCRYPTION_KEYï¼Œå°† Wrapped Key å®‰è£…åˆ° Kernel Keyring</li></ol><blockquote><ul><li>ç›¸åï¼ŒKM TA å¯ä»¥ä½¿ç”¨ Ephemeral Key é€šè¿‡ AES Unwrap Key RFC3394 Algorithm  å°† Wrapped Key è½¬æˆ Master Keyã€‚å› æ­¤åé¢ HLOS å†è½¯ä»¶æµç¨‹ä¸­å¯ä»¥æŠŠ  Wrapped Key å½“ä½œ Master Keyï¼Œåœ¨å®é™…æ‰§è¡Œæ“ä½œæ—¶ï¼ŒKM TA ä¼šå°† Wrapped Key è‡ªåŠ¨è½¬æ¢æˆ Master Key åå†æ‰§è¡Œï¼›</li><li>AES Wrap Key RFC3394 Algorithm æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥ç®€å•çš„ç†è§£ä¸º AES ç®—æ³•æ˜¯ä¸“é—¨ç”¨äºæ•°æ®åŠ è§£å¯†ï¼Œè€Œ AES Wrap Key RFC3394 Algorithm ä¸“é—¨ç”¨äºåŠ è§£å¯† AES Key;</li></ul></blockquote><p><strong>ç–‘é—®ï¼šmaster_key_identifier æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿæ€ä¹ˆé€šè¿‡ master_key_identifier æ‰¾åˆ° Master Keyï¼Ÿ</strong></p><p>é¦–å…ˆç»™å‡ºä¸€å¼ è½¯ä»¶æµç¨‹å›¾ï¼Œå¯ä»¥çœ‹åˆ° master_key_identifier  æ˜¯åœ¨å®‰è£… Wrapped Key çš„è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ï¼Œå¹¶ä¸”éšç³»ç»Ÿè°ƒç”¨è¿”å›åˆ° vold è¿›ç¨‹ã€‚<br><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/9ef600a59078447a938051efb9099422.png" alt="img" style="zoom:80%;"></p><p>ç”Ÿæˆ master_key_identifier  çš„æ­¥éª¤æœ‰ï¼š</p><ol><li>Kernel å‡½æ•° fscrypt_derive_raw_secret å°† Wrapped Key å‘é€åˆ° TZ KM TAï¼Œè¯·æ±‚ Master Key æ´¾ç”Ÿ raw secret ï¼›</li><li>KM TA æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä½¿ç”¨ Ephemeral Key é€šè¿‡ Unwrap Wrapped Key å¾—åˆ° Master Keyï¼›</li><li>KM TA é€šè¿‡ KDF ï¼Œä½¿å¾— Master Key æ´¾ç”Ÿå‡ºä¸€ä¸ª keyï¼Œå¹¶å°†è¿™ä¸ªæ´¾ç”Ÿ key è¿”å› HLOS Linux kernel</li><li>Linux Kernel ä½¿ç”¨ä» TZ è¿”å›çš„æ´¾ç”Ÿ key ä½œä¸º KDF keyï¼Œç»§ç»­é€šè¿‡ KDF æ´¾ç”Ÿå‡ºä¸€ä¸ª keyï¼Œè¿™ä¸ª key ä½œä¸º master_key_identifierï¼›</li></ol><hr><h4 id="1-3-1-é‡è¦çš„æ•°æ®ç»“æ„"><a href="#1-3-1-é‡è¦çš„æ•°æ®ç»“æ„" class="headerlink" title="1.3.1 é‡è¦çš„æ•°æ®ç»“æ„"></a>1.3.1 é‡è¦çš„æ•°æ®ç»“æ„</h4><h5 id="1-3-1-1-ç»“æ„ä½“key"><a href="#1-3-1-1-ç»“æ„ä½“key" class="headerlink" title="1.3.1.1 ç»“æ„ä½“key"></a>1.3.1.1 ç»“æ„ä½“key</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> &#123;</span><br><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">keyring_index_key</span> <span class="hljs-title">index_key</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>hash;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>len_desc;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_type</span>*<span class="hljs-title">type</span>;</span><span class="hljs-comment">/* type of key */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_tag</span>*<span class="hljs-title">domain_tag</span>;</span><span class="hljs-comment">/* Domain of operation */</span><br><span class="hljs-type">char</span>*description;<br>&#125;;<br>&#125;;<br><br><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">key_payload</span> <span class="hljs-title">payload</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* Keyring bits */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">name_link</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">assoc_array</span> <span class="hljs-title">keys</span>;</span><br>&#125;;<br>&#125;;<br><br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹ï¼š</p><ul><li>index_keyï¼Œç±»å‹ä¸ºkeyring_index_keyï¼Œæœ€ç»ˆæˆ‘ä»¬è¦é€šè¿‡è¿™ä¸ªå˜é‡è·å–master key</li><li>keyringå’Œkeyçš„åŒºåˆ«åœ¨äºï¼Œkeyringæœ‰ä¸€ä¸ªkeyså…³è”æ•°ç»„ï¼Œå…¶ç±»å‹ä¸ºassoc_arrayï¼Œè¿™ä¸ªå…³è”æ•°ç»„ä¸­å­˜å‚¨äº†æ‰€æœ‰çš„master key</li></ul><h5 id="1-3-1-2-ç»“æ„ä½“å˜é‡key-type-keyring"><a href="#1-3-1-2-ç»“æ„ä½“å˜é‡key-type-keyring" class="headerlink" title="1.3.1.2 ç»“æ„ä½“å˜é‡key_type_keyring"></a>1.3.1.2 ç»“æ„ä½“å˜é‡key_type_keyring</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key_type</span> <span class="hljs-title">key_type_keyring</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;keyring&quot;</span>,<br>.def_datalen= <span class="hljs-number">0</span>,<br>.preparse= keyring_preparse,<br>.free_preparse= keyring_free_preparse,<br>.instantiate= keyring_instantiate,<br>.revoke= keyring_revoke,<br>.destroy= keyring_destroy,<br>.describe= keyring_describe,<br>.read= keyring_read,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…³äºkeyringç›¸å…³çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªç»“æ„ä½“é‡Œé¢äº†â€¦</p><h4 id="1-3-2-æ·»åŠ ç§˜é’¥"><a href="#1-3-2-æ·»åŠ ç§˜é’¥" class="headerlink" title="1.3.2 æ·»åŠ ç§˜é’¥"></a>1.3.2 æ·»åŠ ç§˜é’¥</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fscrypt_ioctl_add_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">void</span> __user *_uarg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> file_inode(filp)-&gt;i_sb;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_add_key_arg</span> __<span class="hljs-title">user</span> *<span class="hljs-title">uarg</span> =</span> _uarg;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_add_key_arg</span> <span class="hljs-title">arg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fscrypt_master_key_secret</span> <span class="hljs-title">secret</span>;</span><br><span class="hljs-type">int</span> err;<br><br>    <span class="hljs-comment">// å°†ç”¨æˆ·ç©ºé—´çš„å‚æ•°ä¼ å…¥åˆ°å†…æ ¸ç©ºé—´,è¿™é‡Œä¼ è¿›æ¥çš„å°±æ˜¯master key</span><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;arg, uarg, <span class="hljs-keyword">sizeof</span>(arg))) <span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-built_in">memset</span>(&amp;secret, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secret));<br><br>err = add_master_key(sb, &amp;secret, &amp;arg.key_spec);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230717225544268.png" alt="image-20230717225544268" style="zoom: 50%;"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_master_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> fscrypt_master_key_secret *secret,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> fscrypt_key_specifier *key_spec)</span> &#123;<br>    <span class="hljs-keyword">return</span> do_add_master_key(sb, secret, key_spec);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_add_master_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb,</span><br><span class="hljs-params">     <span class="hljs-keyword">struct</span> fscrypt_master_key_secret *secret,</span><br><span class="hljs-params">     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> fscrypt_key_specifier *mk_spec)</span><br>&#123;<br><span class="hljs-type">static</span> <span class="hljs-title function_">DEFINE_MUTEX</span><span class="hljs-params">(fscrypt_add_key_mutex)</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">key</span>;</span><br><span class="hljs-type">int</span> err;<br><br>mutex_lock(&amp;fscrypt_add_key_mutex); <span class="hljs-comment">/* serialize find + link */</span><br>key = fscrypt_find_master_key(sb, mk_spec);<br><span class="hljs-keyword">if</span> (IS_ERR(key)) &#123;<br>err = allocate_filesystem_keyring(sb);<br>err = add_new_master_key(secret, mk_spec, sb-&gt;s_master_keys);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">allocate_filesystem_keyring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb)</span> &#123;<br><span class="hljs-type">char</span> description[FSCRYPT_FS_KEYRING_DESCRIPTION_SIZE];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">keyring</span>;</span><br>    <br>    <span class="hljs-comment">// å°†sb-&gt;s_idæ ¼å¼åŒ–æˆ[&quot;fscrypt-%s&quot;, sb-&gt;s_id]ä¿å­˜åˆ°descriptionå˜é‡ä¸­</span><br>    <span class="hljs-comment">// è¿™è¾¹çš„sb-&gt;s_idå°±æ˜¯Dataåˆ†åŒºå¯¹åº”çš„è®¾å¤‡åï¼Œå¦‚fscrypt-sda61</span><br>format_fs_keyring_description(description, sb);  <br>keyring = keyring_alloc(description, GLOBAL_ROOT_UID, GLOBAL_ROOT_GID, current_cred(), KEY_POS_SEARCH |<br>  KEY_USR_SEARCH | KEY_USR_READ | KEY_USR_VIEW, KEY_ALLOC_NOT_IN_QUOTA, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// ----------------------------------------------------------------------------</span><br><span class="hljs-keyword">struct</span> key *<span class="hljs-title function_">keyring_alloc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *description, <span class="hljs-type">kuid_t</span> uid, <span class="hljs-type">kgid_t</span> gid,</span><br><span class="hljs-params">  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> cred *cred, <span class="hljs-type">key_perm_t</span> perm,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> key_restriction *restrict_link,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> key *dest)</span> &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">keyring</span>;</span><br><br>    <span class="hljs-comment">// ç”³è¯·keyringï¼Œå°†descriptionè®¾ç½®åˆ°keyringçš„index_keyæˆå‘˜å˜é‡ä¸­</span><br>keyring = key_alloc(&amp;key_type_keyring, description, uid, gid, cred, perm, flags, restrict_link);<br><span class="hljs-keyword">if</span> (!IS_ERR(keyring)) &#123;<br>ret = key_instantiate_and_link(keyring, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, dest, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> keyring;<br>&#125;<br><br><span class="hljs-keyword">struct</span> key *<span class="hljs-title function_">key_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> key_type *type, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *desc,</span><br><span class="hljs-params">      <span class="hljs-type">kuid_t</span> uid, <span class="hljs-type">kgid_t</span> gid, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> cred *cred,</span><br><span class="hljs-params">      <span class="hljs-type">key_perm_t</span> perm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> key_restriction *restrict_link)</span> &#123;<br><span class="hljs-comment">// ...</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span> *<span class="hljs-title">key</span>;</span><br>key-&gt;index_key.desc_len = desclen;<br>key-&gt;index_key.description = kmemdup(desc, desclen + <span class="hljs-number">1</span>, GFP_KERNEL);<br>key-&gt;index_key.type = type;<br>key_set_index_key(&amp;key-&gt;index_key);<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-User-0-CE-Master-Key"><a href="#2-User-0-CE-Master-Key" class="headerlink" title="2.User.0 CE Master Key"></a>2.User.0 CE Master Key</h2><p>å½“ç”¨æˆ·è®¾ç½®ç”¨æˆ·é”å±å¯†ç åï¼Œ User CE Master  key çš„è®¤è¯æ–¹å¼ä¼šæ”¹å˜ï¼Œå—ç”¨æˆ·å¯†ç ä¿æŠ¤ï¼Œåªæœ‰å¯†ç æ ¡éªŒæˆåŠŸåï¼Œæ‰èƒ½å¾—åˆ° User.0 CE Master Keyï¼Œå¹¶å°†å…¶å®‰è£…åˆ° kernel keyringã€‚</p><p>User.0 CE Master Key ç›¸å…³çš„è®¤è¯æ•°æ®è¢«å­˜å‚¨åˆ°ç›®å½• &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;current ä¸‹ã€‚æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹æœªè®¾ç½®é”å±å¯†ç å’Œè®¾ç½®é”å±å¯†ç åï¼Œè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶å·®å¼‚ï¼š</p><ul><li>æœªè®¾ç½®é”å±å¯†ç </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; adb shell <span class="hljs-built_in">ls</span> /data/misc/vold/user_keys/ce/0/current -l<br>-rw------- 1 root root   268 2022-11-05 22:08 encrypted_key<br>-rw------- 1 root root   194 2022-11-05 22:08 keymaster_key_blob<br>-rw------- 1 root root 16384 2022-11-05 22:08 secdiscardable<br>-rw------- 1 root root    10 2022-11-05 22:08 stretching<br>-rw------- 1 root root     1 2022-11-05 22:08 version<br></code></pre></td></tr></table></figure><ul><li>è®¾ç½®é”å±å¯†ç </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; adb shell <span class="hljs-built_in">ls</span> /data/misc/vold/user_keys/ce/0/current -l<br>-rw------- 1 root root   268 2022-11-05 22:11 encrypted_key<br>-rw------- 1 root root 16384 2022-11-05 22:11 secdiscardable<br>-rw------- 1 root root     4 2022-11-05 22:11 stretching<br>-rw------- 1 root root     1 2022-11-05 22:11 version<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è®¾ç½®é”å±å¯†ç åï¼Œå°‘äº†æ–‡ä»¶ keymaster_key_blobã€‚åœ¨ä»‹ç» System DE Master Key æ—¶å·²ç»çŸ¥é“ï¼Œkeymaster_key_blob æ˜¯ KM TA åˆ›å»ºçš„ä¸€ä¸ªç”¨äºåŠ å¯† Master Key Blob çš„ keyï¼ˆä¸Šæ–‡ç§°å…¶ä¸º KSKï¼‰ï¼Œç”¨äºä¿è¯ Master Key Blob çš„å®‰å…¨æ€§ï¼Œä½œä¸ºè®¾å¤‡ç»‘å®šè®¤è¯çš„ä¸€ç§å®ç°ï¼Œå³ KSK åªèƒ½åœ¨å”¯ä¸€çš„è®¾å¤‡ï¼ˆå’ŒCPUã€å­˜å‚¨å™¨ç­‰å™¨ä»¶ç»‘å®šï¼‰ä¸Šå¯ç”¨ã€‚</p><p>åœ¨ç”¨æˆ·è®¾ç½®é”å±å¯†ç åï¼Œè®¤è¯æ›´åŠ ä¸¥æ ¼ï¼Œä¸ä»…è¦å”¯ä¸€çš„è®¾å¤‡ï¼Œè€Œä¸”éœ€è¦ç”¨æˆ·è¾“å…¥æ­£ç¡®çš„é”å±å¯†ç ã€‚å› æ­¤ï¼ŒMaster Key Blob  ä¸å†ç”¨ KSK åŠ å¯†ï¼Œå®ƒå·²ç»ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚</p><p><strong>ç–‘é—®ï¼šencrypted_key ä»ç„¶å­˜åœ¨ï¼Œè¡¨æ˜ä»ç„¶ä½¿ç”¨å¯¹ Master Key Blob åŠ å¯†çš„æ–¹å¼å®ç°è®¤è¯ã€‚ä½†æ˜¯åŠ å¯† Master Key Blob çš„ key ä»å“ªé‡Œæ¥ï¼Ÿå’Œç”¨æˆ·é”å±å¯†ç å­˜åœ¨ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p><p>æˆ‘ä»¬å…ˆçœ‹ä»¥ä¸‹ç”¨æˆ·è®¾ç½®é”å±å¯†ç æ—¶ï¼Œå¯¼è‡´ &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;current ä¸‹æ–‡ä»¶å†…å®¹å˜åŒ–çš„æµç¨‹ï¼š</p><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/9ff061c0788748cbadc82023fc2f90b6.png" alt="img" style="zoom:80%;"><p>AuthenticationToken çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/locksettings/SyntheticPasswordManager.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationToken</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span> mVersion;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Here is the relationship between these fields:</span><br><span class="hljs-comment"> * Generate two random block P0 and P1. P1 is recorded in mEscrowSplit1 but P0 is not.</span><br><span class="hljs-comment"> * mSyntheticPassword = hash(P0 || P1)</span><br><span class="hljs-comment"> * E0 = P0 encrypted under syntheticPassword, recoreded in mEncryptedEscrowSplit0.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] mSyntheticPassword;<br><span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] mEncryptedEscrowSplit0;<br><span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] mEscrowSplit1;<br> <br>AuthenticationToken(<span class="hljs-type">byte</span> version) &#123;<br>mVersion = version;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Derives a subkey from the synthetic password. For v3 and later synthetic passwords the</span><br><span class="hljs-comment"> * subkeys are 256-bit; for v1 and v2 they are 512-bit.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] deriveSubkey(<span class="hljs-type">byte</span>[] personalization) &#123;<br><span class="hljs-keyword">if</span> (mVersion == SYNTHETIC_PASSWORD_VERSION_V3) &#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SP800Derive</span>(mSyntheticPassword))<br>.withContext(personalization, PERSONALISATION_CONTEXT);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> SyntheticPasswordCrypto.personalisedHash(personalization,<br>mSyntheticPassword);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] deriveDiskEncryptionKey() &#123;<br><span class="hljs-keyword">return</span> deriveSubkey(PERSONALIZATION_FBE_KEY);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Re-creates synthetic password from both escrow splits. See javadoc for</span><br><span class="hljs-comment"> * AuthenticationToken.mSyntheticPassword for details on what each block means.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recreate</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] escrowSplit0, <span class="hljs-type">byte</span>[] escrowSplit1)</span> &#123;<br>mSyntheticPassword = bytesToHex(SyntheticPasswordCrypto.personalisedHash(<br>PERSONALIZATION_SP_SPLIT, escrowSplit0, escrowSplit1));<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Assign escrow data to this auth token. This is a prerequisite to call</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> AuthenticationToken#recreateFromEscrow&#125;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEscrowData</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] encryptedEscrowSplit0,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] escrowSplit1)</span> &#123;<br>mEncryptedEscrowSplit0 = encryptedEscrowSplit0;<br>mEscrowSplit1 = escrowSplit1;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Generates a new random synthetic password with escrow data.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> AuthenticationToken <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">AuthenticationToken</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationToken</span>(SYNTHETIC_PASSWORD_VERSION_V3);<br><span class="hljs-type">byte</span>[] escrowSplit0 = secureRandom(SYNTHETIC_PASSWORD_LENGTH);<br><span class="hljs-type">byte</span>[] escrowSplit1 = secureRandom(SYNTHETIC_PASSWORD_LENGTH);<br>result.recreate(escrowSplit0, escrowSplit1);<br><span class="hljs-type">byte</span>[] encrypteEscrowSplit0 = SyntheticPasswordCrypto.encrypt(result.mSyntheticPassword,<br>PERSONALIZATION_E0, escrowSplit0);<br>result.setEscrowData(encrypteEscrowSplit0,  escrowSplit1);<br><span class="hljs-keyword">return</span> result;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆä»£ç å’Œæµç¨‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·è®¾ç½®å¯†ç åï¼Œæ¡†æ¶ä¼šç›´æ¥è°ƒåˆ° vold æ‰§è¡Œæ›´æ¢ MasterKey è®¤è¯æ–¹å¼ï¼š</p><ol><li>è°ƒç”¨å‡½æ•° fscrypt_add_user_key_auth(user_id, serial, secret_hexï¼‰ï¼Œå¢åŠ å¯¹ CE Master Key çš„è®¤è¯æ–¹å¼ï¼š<ol><li>é¦–å…ˆï¼ŒåŠ è½½ keymaster_key_blob ï¼Œä½¿ç”¨ KSK è§£å¯† encrypted_keyï¼Œå¾—åˆ° Master CE Key Blobï¼›</li><li>æ¥ç€ï¼Œç”Ÿæˆæ–°çš„ appidï¼Œappid ç”± fscrypt_add_user_key_auth ä¼ å…¥çš„å‚æ•° secret_hex ç»„æˆï¼›</li><li>å°† appid Hash æˆ AES Key;</li><li>ä½¿ç”¨ç”Ÿæˆçš„ AES Key åŠ å¯†  Master CE Key Blobï¼Œå¾—åˆ° encrypted_keyï¼›</li><li>å°†æ–°çš„è®¤è¯æ•°æ®å­˜å‚¨åˆ° &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;cx0000000000 ä¸‹ï¼›</li><li>æ­¤æ—¶ &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0 ä¸‹å·²ç»å­˜åœ¨ä¸¤ç§ CE Master Key çš„è®¤è¯æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º</li></ol></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è€çš„è®¤è¯æ–¹å¼ï¼Œé€šè¿‡ KM key KSK è®¤è¯</span><br>&gt; adb shell <span class="hljs-built_in">ls</span> /data/misc/vold/user_keys/ce/0/current<br>encrypted_key<br>keymaster_key_blob<br>secdiscardable<br>stretching<br>version<br> <br><span class="hljs-comment"># æ–°çš„è®¤è¯æ–¹å¼ï¼Œé€šè¿‡ç”¨æˆ·å¯†ç æ ¡éªŒè®¤è¯</span><br>&gt; adb shell <span class="hljs-built_in">ls</span> /data/misc/vold/user_keys/ce/0/cx0000000000<br>encrypted_key<br>secdiscardable<br>stretching<br>version<br></code></pre></td></tr></table></figure><ol start="2"><li>è°ƒç”¨ fscrypt_fixate_newest_user_key_authï¼Œæ¸…é™¤è€çš„è®¤è¯æ–¹å¼ï¼Œæ”¹ç”¨ç”¨æˆ·å¯†ç è®¤è¯ï¼Œå®Œæˆåï¼Œ&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;cx0000000000 çš„å†…å®¹å°†è¦†ç›– &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;currentã€‚vold ä¼šæ‰“å‡ºå¦‚ä¸‹çš„ log ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">vold    : fscrypt_fixate_newest_user_key_auth 0<br>vold    : Deleting key /data/misc/vold/user_keys/ce/0/current/keymaster_key_blob from Keymaster<br>vold    : /system/bin/secdiscard<br>vold    :     --<br>vold    :     /data/misc/vold/user_keys/ce/0/current/encrypted_key<br>vold    :     /data/misc/vold/user_keys/ce/0/current/secdiscardable<br>vold    :     /data/misc/vold/user_keys/ce/0/current/keymaster_key_blob<br>vold    : /system/bin/rm<br>vold    :     -rf<br>vold    :     /data/misc/vold/user_keys/ce/0/current<br>vold    : Renaming /data/misc/vold/user_keys/ce/0/cx0000000000 to /data/misc/vold/user_keys/ce/0/current<br></code></pre></td></tr></table></figure><hr><h3 id="2-1-tokenä¸secret"><a href="#2-1-tokenä¸secret" class="headerlink" title="2.1 tokenä¸secret"></a>2.1 tokenä¸secret</h3><p>åœ¨Androidç³»ç»Ÿé‡çš„è®¾ç½®å¯†ç ã€æ¸…é™¤å¯†ç ã€ä¿®æ”¹å¯†ç ï¼Œéƒ½æ˜¯è°ƒç”¨åˆ°LockSettingsService.javaçš„setLockCredentialå‡½æ•°è¿›è¡Œçš„ï¼Œè€ŒsetLockCredentialåˆè°ƒç”¨äº†setLockCredentialInternalã€‚ã€å¼•ç”¨ï¼š<a href="https://blog.csdn.net/weixin_42135087/article/details/109726612?spm=1001.2014.3001.5506%E3%80%91">https://blog.csdn.net/weixin_42135087/article/details/109726612?spm=1001.2014.3001.5506ã€‘</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»[ä»£ç æ”¹å˜ä¸–ç•Œctw](https://blog.csdn.net/weixin_42135087)å¤§å“¥çš„åšå®¢ä¸­å¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†è®¾ç½®ç”¨æˆ·å¯†ç çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°setLockCredentialInternal ï¼Œä¸‹é¢çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</span><br><br>setLockCredentialInternal -&gt; setUserKeyProtection -&gt; addUserKeyAuth<br></code></pre></td></tr></table></figure><p>â­ åœ¨æˆ‘é˜…è¯»ä»£ç çš„æ—¶å€™ï¼Œæš‚ä¸”å°†ï¼š</p><ul><li>tokenç†è§£æˆTEEä¸–ç•Œå‘ç»™æˆ‘ä»¬çš„ä»¤ç‰Œï¼Œåªæœ‰è¿™ä¸ªä»¤ç‰Œæˆ‘ä»¬æ‰èƒ½åšæˆ‘ä»¬çš„äº‹æƒ…ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªbyte[]æ•°ç»„<ul><li>æ¨èæ–‡ç« ï¼š<a href="https://blog.csdn.net/weixin_42800689/article/details/84071690">authè®¤è¯ç›¸å…³</a>ã€<a href="https://blog.csdn.net/weixin_42135087/article/details/107861296">androidå¯†ç è§£é”&#x2F;æŒ‡çº¹è§£é”è¿”å›çš„authTokenæ·±åº¦è§£å‰–</a></li><li>ç»è¿‡gatekeeperã€ç”Ÿç‰©è®¤è¯ï¼ˆäººè„¸ã€æŒ‡çº¹ï¼‰éªŒè¯åè¿”å›çš„authTokenï¼Œè¯¥authTokenæ˜¯ç»è¿‡äº†å…±äº«Hmackeyç­¾åçš„ã€‚æ‰€ä»¥åœ¨keystoreä½¿ç”¨ä¸€äº›åŠŸèƒ½çš„æ—¶å€™ï¼Œä¼šä¼ ä¸‹æ¥è¿™ä¸ªauthtokenï¼Œå¿…é¡»éªŒè¯è¿™ä¸ªauthtokenï¼Œæ‰èƒ½è¿›è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ã€‚ã€æ¥æºï¼š<a href="https://blog.csdn.net/weixin_42135087/article/details/124565234">android gatekeeper(locksettingå¯†ç é”)å­¦ä¹ è¿™ä¸€ç¯‡å°±å¤Ÿäº†</a>ã€‘</li><li>ğŸ”•ä½†æ˜¯æ³¨æ„ä¸€ä¸‹ï¼š<strong>FBEæ˜¯ä¸éœ€è¦è¿™ä¸ªauthtokençš„</strong></li></ul></li><li>secretå°±ç†è§£æˆé”å±å¯†ç ï¼Œåªä¸è¿‡ä¼šä»å¯†ç åŒ…è£…ä¸€ä¸‹å˜æˆäº†LockscreenCredentialå¯¹è±¡ï¼Œåˆé€šè¿‡secretFromCredentialåŒ…è£…æˆäº†ä¸€ä¸ªbyteæ•°ç»„</li></ul><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230712233532925.png" alt="image-20230712233532925" style="zoom: 50%;"><h3 id="2-2-addUserKeyAuthå±‚å±‚è°ƒç”¨"><a href="#2-2-addUserKeyAuthå±‚å±‚è°ƒç”¨" class="headerlink" title="2.2  addUserKeyAuthå±‚å±‚è°ƒç”¨"></a>2.2  addUserKeyAuthå±‚å±‚è°ƒç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\locksettings\LockSettingsService.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserKeyAuth</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> mUserManager.getUserInfo(userId);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">callingId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();<br>    <span class="hljs-comment">// è°ƒç”¨SMSçš„addUserKeyAuthæ–¹æ³•</span><br>    mStorageManager.addUserKeyAuth(userId, userInfo.serialNumber, token, secret);<br>&#125;<br><br><span class="hljs-comment">// ---------------------------------------------------------------</span><br><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\StorageManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserKeyAuth</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> serialNumber, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret)</span> &#123;<br>    mVold.addUserKeyAuth(userId, serialNumber, encodeBytes(token), encodeBytes(secret));<br>&#125;<br><br><span class="hljs-comment">// ---------------------------------------------------------------</span><br><span class="hljs-comment">// system\vold\VoldNativeService.cpp</span><br>binder::Status VoldNativeService::addUserKeyAuth(int32_t userId, int32_t userSerial,<br>                                                 const std::string&amp; token,<br>                                                 const std::string&amp; secret) &#123;<br>    <span class="hljs-keyword">if</span> (!token_empty(token)) &#123;<br>        LOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;Vold doesn&#x27;t use auth tokens, but non-empty token passed to addUserKeyAuth.&quot;</span>;<br>        <span class="hljs-keyword">return</span> binder::Status::fromServiceSpecificError(-EINVAL);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> translateBool(fscrypt_add_user_key_auth(userId, userSerial, secret));<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼ŒVoldæœåŠ¡æ˜¯ä¸éœ€è¦AuthTokençš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å‘FBEä¼ é€’ã€‚</p><h3 id="2-3-fscrypt-add-user-key-authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™"><a href="#2-3-fscrypt-add-user-key-authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™" class="headerlink" title="2.3 fscrypt_add_user_key_authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™"></a>2.3 fscrypt_add_user_key_authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_add_user_key_auth</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">int</span> serial, <span class="hljs-type">const</span> std::string&amp; secret_hex)</span> </span>&#123;<br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ”¯æŒæ–‡ä»¶çº§åŠ å¯†</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">fscrypt_is_native</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// è¿˜åŸé”å±ç </span><br>    <span class="hljs-keyword">auto</span> auth = <span class="hljs-built_in">authentication_from_hex</span>(secret_hex);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">fscrypt_rewrap_user_key</span>(user_id, serial, kEmptyAuthentication, *auth);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨fscrypt_rewrap_user_key</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_rewrap_user_key</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">int</span> serial,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">const</span> android::vold::KeyAuthentication&amp; retrieve_auth,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">const</span> android::vold::KeyAuthentication&amp; store_auth)</span> </span>&#123;<br>    <span class="hljs-comment">// è·å–å½“å‰ç”¨æˆ·çš„CE_KEYç›®å½•: /data/misc/vold/user_keys/ce/&lt;userid&gt;</span><br>    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> directory_path = <span class="hljs-built_in">get_ce_key_directory_path</span>(user_id);<br>    KeyBuffer ce_key;<br>    std::string ce_key_current_path = <span class="hljs-built_in">get_ce_key_current_path</span>(directory_path); <span class="hljs-comment">// /data/misc/vold/user_keys/ce/&lt;userid&gt;/current</span><br>    <span class="hljs-built_in">retrieveKey</span>(ce_key_current_path, kEmptyAuthentication, &amp;ce_key);<br>    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> paths = <span class="hljs-built_in">get_ce_key_paths</span>(directory_path);<br>    std::string ce_key_path;<br>    <span class="hljs-comment">// æ–°è·¯å¾„: /data/misc/vold/user_keys/ce/&lt;userid&gt;/current/cx%010uï¼Œä¾‹å¦‚/data/misc/vold/user_keys/ce/0/current/cx0000000000</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">get_ce_key_new_path</span>(directory_path, paths, &amp;ce_key_path)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// user_key_temp: /data/misc/vold/user_keys/temp</span><br>    <span class="hljs-comment">// ä¿å­˜CE Key</span><br>    <span class="hljs-keyword">if</span> (!android::vold::<span class="hljs-built_in">storeKeyAtomically</span>(ce_key_path, user_key_temp, store_auth, ce_key))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å†å²æ€»æ˜¯æƒŠäººçš„ç›¸ä¼¼ã€1.1èŠ‚åˆ›å»ºSystem DE Master Keyã€‘</strong>ï¼Œè¿™é‡Œåˆè°ƒç”¨storeKeyAtomicallyä¿å­˜å½“å‰ç”¨æˆ·çš„User CE Master Key</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">storeKeyAtomically</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key_path, <span class="hljs-type">const</span> std::string&amp; tmp_path,</span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-type">const</span> KeyAuthentication&amp; auth, <span class="hljs-type">const</span> KeyBuffer&amp; key)</span> </span>&#123;<br>    <span class="hljs-comment">// åé¢ä¼šå°†tmp_pathæ¢æˆKey_pathï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æ”¹ä¸ºkey_path</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">storeKey</span>(key_path, auth, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨storeKeyã€â­ è¿™é‡Œæ‰€æœ‰çš„æ“ä½œå³ä½¿éƒ½æ˜¯åœ¨&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;tempä¸­å¤„ç†çš„ï¼Œåªæ˜¯åé¢ä¼šæœ‰RenameKeyDirå’ŒFsyncParentDirectoryæ“ä½œï¼Œåªè¦æ“ä½œæˆåŠŸäº†ï¼Œå°±ç›¸å½“äº<code>/data/misc/vold/user_keys/ce/&lt;userid&gt;/current</code>ã€‘</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">storeKey</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; dir, <span class="hljs-type">const</span> KeyAuthentication&amp; auth, <span class="hljs-type">const</span> KeyBuffer&amp; key)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">mkdir</span>(dir.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0700</span>)) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;key mkdir &quot;</span> &lt;&lt; dir;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// å‘/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/versionä¸­å†™å…¥1</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kCurrentVersion, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_version)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// åˆ›å»ºéšæœºçš„secdiscardable_hashå€¼</span><br>    std::string secdiscardable_hash;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">createSecdiscardable</span>(dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_secdiscardable, &amp;secdiscardable_hash)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å¦‚æœæœ‰é”å±å¯†ç ï¼Œåˆ™stretchingä¸ºnone; å¦‚æœæ²¡æœ‰é”å±å¯†ç ï¼Œåˆ™stretchingä¸ºnopassword</span><br>    std::string stretching = <span class="hljs-built_in">getStretching</span>(auth);<br>    <span class="hljs-comment">// å‘/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/stretchingä¸­å†™å…¥stretchingçš„å€¼</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(stretching, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_stretching)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// ç”ŸæˆappIdï¼Œå¦‚æœè®¾ç½®äº†é”å±å¯†ç ï¼Œåˆ™ä¸ºappId = hash + auth.secretï¼›æ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œåˆ™appId = hash</span><br>    std::string appId;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateAppId</span>(auth, stretching, secdiscardable_hash, &amp;appId)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string encryptedKey;<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œä½¿ç”¨keymasterç®¡ç†</span><br>    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) &#123;<br>        Keymaster keymaster;<br>        <span class="hljs-keyword">if</span> (!keymaster) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        std::string kmKey;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateKeyStorageKey</span>(keymaster, appId, &amp;kmKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kmKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_keymaster_key_blob)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        km::AuthorizationSet keyParams = <span class="hljs-built_in">beginParams</span>(appId);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithKeymasterKey</span>(keymaster, dir, keyParams, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è®¾ç½®äº†é”å±å¯†ç ï¼Œä¸é€‚ç”¨keymaster</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithoutKeymaster</span>(appId, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// å°†åŠ å¯†åçš„CE keyå†™å…¥/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/encrypted_key</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(encryptedKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_encrypted_key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">FsyncDirectory</span>(dir)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>éå¸¸æ„Ÿè°¢å¤§ä½¬çš„åšå®¢ï¼Œæ”¶ç›Šè‰¯å¤šã€‚åœ¨åšä¸»çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šäº†è‡ªå·±çš„ä¸€ç‚¹ç‚¹ç†è§£ã€‚</p><p>å…¶ä¸­ï¼š</p><ul><li>æ¯ä¸€ä¸ªå°èŠ‚åˆ†ç•Œçº¿ä»¥ä¸Šæ˜¯åšä¸»åŸæ–‡</li><li>åˆ†ç•Œçº¿ä»¥ä¸‹æ˜¯æˆ‘çš„ç†è§£</li></ul><hr><img src="/2023/07/11/System-DE-Master-Key%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/image-20230712233104163.png" alt="image-20230712233104163" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è´ºåˆ©åšæ±‡ç¼–åŸç†å­¦ä¹ ç¬”è®°</title>
    <link href="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="è´ºåˆ©åšæ±‡ç¼–åŸç†å­¦ä¹ ç¬”è®°"><a href="#è´ºåˆ©åšæ±‡ç¼–åŸç†å­¦ä¹ ç¬”è®°" class="headerlink" title="è´ºåˆ©åšæ±‡ç¼–åŸç†å­¦ä¹ ç¬”è®°"></a>è´ºåˆ©åšæ±‡ç¼–åŸç†å­¦ä¹ ç¬”è®°</h1><h2 id="1-ç»ªè®º"><a href="#1-ç»ªè®º" class="headerlink" title="1.ç»ªè®º"></a>1.ç»ªè®º</h2><h2 id="2-å¯„å­˜å™¨ä¸å†…å­˜"><a href="#2-å¯„å­˜å™¨ä¸å†…å­˜" class="headerlink" title="2.å¯„å­˜å™¨ä¸å†…å­˜"></a>2.å¯„å­˜å™¨ä¸å†…å­˜</h2><h3 id="2-1-å¯„å­˜å™¨ä¸æ•°æ®å­˜å‚¨"><a href="#2-1-å¯„å­˜å™¨ä¸æ•°æ®å­˜å‚¨" class="headerlink" title="2.1 å¯„å­˜å™¨ä¸æ•°æ®å­˜å‚¨"></a>2.1 å¯„å­˜å™¨ä¸æ•°æ®å­˜å‚¨</h3><p>CPUçš„ç»„æˆï¼š</p><ul><li>è¿ç®—å™¨è¿›è¡Œä¿¡æ¯å¤„ç†</li><li>å¯„å­˜å™¨è¿›è¡Œä¿¡æ¯å­˜å‚¨</li><li>æ§åˆ¶å™¨åè°ƒå„ç§å™¨ä»¶è¿›è¡Œå·¥ä½œ</li><li>å†…éƒ¨æ€»çº¿å®ç°CPUå†…éƒ¨å„ä¸ªå™¨ä»¶ä¹‹é—´çš„è”ç³»</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710233214391.png" alt="image-20230710233214391" style="zoom: 67%;"><p><strong>å¯„å­˜å™¨æ˜¯CPUå†…éƒ¨çš„ä¿¡æ¯å­˜å‚¨å•å…ƒ</strong></p><p>8086CPUæœ‰14ä¸ªå¯„å­˜å™¨ï¼š</p><ul><li>é€šç”¨å¯„å­˜å™¨ï¼šAXã€BXã€CXã€DX</li><li>ç¼–åˆ¶å¯„å­˜å™¨ï¼šSIã€DI</li><li>æŒ‡é’ˆå¯„å­˜å™¨ï¼šSPã€BP</li><li>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼šIP</li><li>æ®µå¯„å­˜å™¨ï¼šCSã€SSã€DSã€ES</li><li>æ ‡å¿—å¯„å­˜å™¨ï¼šPSW</li></ul><p><strong>å…±æ€§ï¼š8086CPUæ‰€æœ‰çš„å¯„å­˜å™¨éƒ½æ˜¯16ä½çš„ï¼Œå¯ä»¥å­˜æ”¾ä¸¤ä¸ªå­—èŠ‚</strong></p><h4 id="2-1-1-é€šç”¨å¯„å­˜å™¨â€”â€”ä»¥AXä¸ºä¾‹"><a href="#2-1-1-é€šç”¨å¯„å­˜å™¨â€”â€”ä»¥AXä¸ºä¾‹" class="headerlink" title="2.1.1 é€šç”¨å¯„å­˜å™¨â€”â€”ä»¥AXä¸ºä¾‹"></a>2.1.1 é€šç”¨å¯„å­˜å™¨â€”â€”ä»¥AXä¸ºä¾‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710233531410.png" alt="image-20230710233531410" style="zoom:50%;"><ul><li>ä¸€ä¸ªå¯„å­˜å™¨å­˜å‚¨ä¸€ä¸ª16çš„æ•°æ®<ul><li>æœ€å¤§å€¼ä¸º2^16-1</li></ul></li><li>ä¾‹å¦‚ï¼šåœ¨AXä¸­å­˜å‚¨18Dï¼Œæ¢ç®—æˆ16è¿›åˆ¶ä¸º12Hï¼Œæ¢ç®—æˆ2è¿›åˆ¶ä¸º10010B</li><li>ä¾‹å¦‚ï¼šåœ¨AXä¸­å­˜å‚¨20000Dï¼Œæ¢ç®—æˆ16è¿›åˆ¶ä¸º4E20Hï¼Œæ¢ç®—æˆ2è¿›åˆ¶ä¸º0100111000100000B</li></ul><h4 id="2-1-2-å¦‚ä½•å…¼å®¹8ä½CPU"><a href="#2-1-2-å¦‚ä½•å…¼å®¹8ä½CPU" class="headerlink" title="2.1.2 å¦‚ä½•å…¼å®¹8ä½CPU"></a>2.1.2 å¦‚ä½•å…¼å®¹8ä½CPU</h4><p>8086ä¸Šä¸€ä»£CPUä¸­çš„å¯„å­˜å™¨éƒ½æ˜¯8ä½çš„ï¼Œå¦‚ä½•ä¿è¯ç¨‹åºçš„å…¼å®¹æ€§</p><blockquote><p>é€šç”¨å¯„å­˜å™¨å‡å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„8ä½å¯„å­˜å™¨ä½¿ç”¨</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710233807727.png" alt="image-20230710233807727" style="zoom:67%;"><ul><li>AXå¯ä»¥åˆ†ä¸ºAHå’ŒAL</li><li>BXå¯ä»¥åˆ†ä¸ºBHå’ŒBL</li><li>CXå¯ä»¥åˆ†ä¸ºCHå’ŒCL</li><li>DXå¯ä»¥åˆ†ä¸ºDHå’ŒDL</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710233838706.png" alt="image-20230710233838706" style="zoom:80%;"><h4 id="2-1-3-â€œå­—â€åœ¨å¯„å­˜å™¨ä¸­çš„å­˜å‚¨"><a href="#2-1-3-â€œå­—â€åœ¨å¯„å­˜å™¨ä¸­çš„å­˜å‚¨" class="headerlink" title="2.1.3 â€œå­—â€åœ¨å¯„å­˜å™¨ä¸­çš„å­˜å‚¨"></a>2.1.3 â€œå­—â€åœ¨å¯„å­˜å™¨ä¸­çš„å­˜å‚¨</h4><ul><li>8086æ˜¯16ä½CPU<ul><li>8086çš„å­—é•¿(word size)ä¸º16bit</li></ul></li><li>ä¸€ä¸ªå­—(word)å¯ä»¥å­˜åœ¨ä¸€ä¸ª16ä½å¯„å­˜å™¨ä¸­<ul><li>è¿™ä¸ªå­—çš„é«˜ä½å­—èŠ‚å­˜åœ¨è¿™ä¸ªå¯„å­˜å™¨çš„é«˜8ä½å¯„å­˜å™¨</li><li>è¿™ä¸ªå­—çš„ä½ä½å­—èŠ‚å­˜åœ¨è¿™ä¸ªå¯„å­˜å™¨çš„ä½8ä½å¯„å­˜å™¨</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710233936082.png" alt="image-20230710233936082" style="zoom: 67%;"><h3 id="2-2-movå’ŒaddæŒ‡ä»¤"><a href="#2-2-movå’ŒaddæŒ‡ä»¤" class="headerlink" title="2.2 movå’ŒaddæŒ‡ä»¤"></a>2.2 movå’ŒaddæŒ‡ä»¤</h3><h4 id="2-2-1-å­¦ä¹ æ±‡ç¼–æŒ‡ä»¤â€”â€”ç”¨ä¸­å­¦"><a href="#2-2-1-å­¦ä¹ æ±‡ç¼–æŒ‡ä»¤â€”â€”ç”¨ä¸­å­¦" class="headerlink" title="2.2.1 å­¦ä¹ æ±‡ç¼–æŒ‡ä»¤â€”â€”ç”¨ä¸­å­¦"></a>2.2.1 å­¦ä¹ æ±‡ç¼–æŒ‡ä»¤â€”â€”ç”¨ä¸­å­¦</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234028265.png" alt="image-20230710234028265" style="zoom:80%;"><h4 id="2-2-2-å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ-1"><a href="#2-2-2-å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ-1" class="headerlink" title="2.2.2 å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ(1)"></a>2.2.2 å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ(1)</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234058102.png" alt="image-20230710234058102" style="zoom:80%;"><h4 id="2-2-3-å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ-2"><a href="#2-2-3-å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ-2" class="headerlink" title="2.2.3 å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ(2)"></a>2.2.3 å†™å‡ºæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ(2)</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234149190.png" alt="image-20230710234149190" style="zoom:80%;"><h3 id="2-3-ç¡®å®šç‰©ç†åœ°å€çš„åŠæ³•"><a href="#2-3-ç¡®å®šç‰©ç†åœ°å€çš„åŠæ³•" class="headerlink" title="2.3 ç¡®å®šç‰©ç†åœ°å€çš„åŠæ³•"></a>2.3 ç¡®å®šç‰©ç†åœ°å€çš„åŠæ³•</h3><h4 id="2-3-1-ç‰©ç†åœ°å€"><a href="#2-3-1-ç‰©ç†åœ°å€" class="headerlink" title="2.3.1 ç‰©ç†åœ°å€"></a>2.3.1 ç‰©ç†åœ°å€</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234217377.png" alt="image-20230710234217377" style="zoom:67%;"><ul><li>CPUè®¿é—®å†…å­˜å•å…ƒæ—¶è¦ç»™å‡ºå†…å­˜å•å…ƒçš„åœ°å€ã€‚</li><li>æ‰€æœ‰çš„å†…å­˜å•å…ƒæ„æˆçš„å­˜å‚¨ç©ºé—´æ˜¯ä¸€ä¸ªä¸€ç»´çš„çº¿æ€§ç©ºé—´ã€‚</li><li>æ¯ä¸€ä¸ªå†…å­˜å•å…ƒåœ¨è¿™ä¸ªç©ºé—´ä¸­éƒ½æœ‰å”¯ä¸€çš„åœ°å€ï¼Œè¿™ä¸ªå”¯ä¸€çš„åœ°å€ç§°ä¸º<strong>ç‰©ç†åœ°å€</strong>ã€‚</li><li>äº‹å®ï¼š<ul><li>8086æœ‰20ä½åœ°å€æ€»çº¿ï¼Œå¯ä¼ é€20ä½åœ°å€ï¼Œ<strong>å¯»å€èƒ½åŠ›ä¸º1M</strong>ã€‚</li><li>8086æ˜¯16ä½ç»“æ„çš„CPU<ul><li>è¿ç®—å™¨ä¸€æ¬¡æœ€å¤šå¯ä»¥å¤„ç†16ä½çš„æ•°æ®ï¼Œå¯„å­˜å™¨çš„æœ€å¤§å®½åº¦ä¸º16ä½</li><li>åœ¨8086å†…éƒ¨å¤„ç†çš„ã€ä¼ è¾“ã€æš‚å­˜çš„åœ°å€ä¹Ÿæ˜¯16ä½ï¼Œ<strong>å¯»å€èƒ½åŠ›ä¹Ÿåªæœ‰64KB</strong>ï¼</li></ul></li></ul></li><li><strong>é—®é¢˜ï¼š8086å¦‚ä½•å¤„ç†åœ¨å¯»å€ç©ºé—´ä¸Šçš„è¿™ä¸ªçŸ›ç›¾ï¼Ÿï¼</strong></li></ul><hr><p><strong>8086CPUç»™å‡ºç‰©ç†åœ°å€çš„æ–¹æ³•</strong></p><ul><li>8086CPUçš„è§£å†³æ–¹æ³•<ul><li>ç”¨ä¸¤ä¸ª16ä½åœ°å€(æ®µåœ°å€ã€åç§»åœ°å€)åˆæˆä¸€ä¸ª20ä½çš„ç‰©ç†åœ°å€ã€‚</li></ul></li><li>åœ°å€åŠ æ³•å™¨åˆæˆç‰©ç†åœ°å€çš„æ–¹æ³•ï¼š<ul><li>ç‰©ç†åœ°å€&#x3D;æ®µåœ°å€Ã—16+åç§»åœ°å€</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234435359.png" alt="image-20230710234435359" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710234448354.png" alt="image-20230710234448354" style="zoom: 50%;"><h4 id="2-3-2-æ¼”ç¤ºï¼šç‰©ç†åœ°å€-x3D-æ®µåœ°å€Ã—16-åç§»åœ°å€"><a href="#2-3-2-æ¼”ç¤ºï¼šç‰©ç†åœ°å€-x3D-æ®µåœ°å€Ã—16-åç§»åœ°å€" class="headerlink" title="2.3.2 æ¼”ç¤ºï¼šç‰©ç†åœ°å€&#x3D;æ®µåœ°å€Ã—16+åç§»åœ°å€"></a>2.3.2 æ¼”ç¤ºï¼šç‰©ç†åœ°å€&#x3D;æ®µåœ°å€Ã—16+åç§»åœ°å€</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/å¯»å€.gif" style="zoom:67%;"><p><strong>æ€è€ƒï¼šæ®µåœ°å€æ˜¯123CHï¼Œå¯å¦ï¼Ÿ</strong></p><blockquote><p>å¯ä»¥ï¼Œæ®µåœ°å€Ã—16+åç§»åœ°å€&#x3D;0x123C8ï¼Œè¿˜æ˜¯æ²¡å˜</p></blockquote><h4 id="2-3-3-â€œæ®µåœ°å€Ã—16-åç§»åœ°å€-x3D-ç‰©ç†åœ°å€â€çš„æœ¬è´¨"><a href="#2-3-3-â€œæ®µåœ°å€Ã—16-åç§»åœ°å€-x3D-ç‰©ç†åœ°å€â€çš„æœ¬è´¨" class="headerlink" title="2.3.3 â€œæ®µåœ°å€Ã—16+åç§»åœ°å€&#x3D;ç‰©ç†åœ°å€â€çš„æœ¬è´¨"></a>2.3.3 â€œæ®µåœ°å€Ã—16+åç§»åœ°å€&#x3D;ç‰©ç†åœ°å€â€çš„æœ¬è´¨</h4><ul><li><p>è¦è§£å†³çš„é—®é¢˜</p><ul><li>ç”¨ä¸¤ä¸ª16ä½çš„åœ°å€ï¼ˆæ®µåœ°å€ã€åç§»åœ°å€ï¼‰ï¼Œç›¸åŠ å¾—åˆ°ä¸€ä¸ª20ä½çš„ç‰©ç†åœ°å€</li></ul></li><li><p>æœ¬è´¨å«ä¹‰</p><ul><li>CPUåœ¨è®¿é—®å†…å­˜æ—¶ï¼Œç”¨ä¸€ä¸ªåŸºç¡€åœ°å€ï¼ˆæ®µåœ°å€Ã—16ï¼‰å’Œä¸€ä¸ªç›¸å¯¹äºåŸºç¡€åœ°å€çš„åç§»åœ°å€ç›¸åŠ ï¼Œç»™å‡ºå†…å­˜å•å…ƒçš„ç‰©ç†åœ°å€ã€‚</li></ul></li></ul><h3 id="2-4-å†…å­˜çš„åˆ†æ®µè¡¨ç¤ºæ³•"><a href="#2-4-å†…å­˜çš„åˆ†æ®µè¡¨ç¤ºæ³•" class="headerlink" title="2.4 å†…å­˜çš„åˆ†æ®µè¡¨ç¤ºæ³•"></a>2.4 å†…å­˜çš„åˆ†æ®µè¡¨ç¤ºæ³•</h3><h4 id="2-4-1-ç”¨åˆ†æ®µçš„æ–¹å¼ç®¡ç†å†…å­˜"><a href="#2-4-1-ç”¨åˆ†æ®µçš„æ–¹å¼ç®¡ç†å†…å­˜" class="headerlink" title="2.4.1 ç”¨åˆ†æ®µçš„æ–¹å¼ç®¡ç†å†…å­˜"></a>2.4.1 ç”¨åˆ†æ®µçš„æ–¹å¼ç®¡ç†å†…å­˜</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710235315274.png" alt="image-20230710235315274" style="zoom: 67%;"><h4 id="2-4-2-åŒä¸€æ®µå†…å­˜ï¼Œå¤šç§åˆ†æ®µæ–¹æ¡ˆ"><a href="#2-4-2-åŒä¸€æ®µå†…å­˜ï¼Œå¤šç§åˆ†æ®µæ–¹æ¡ˆ" class="headerlink" title="2.4.2 åŒä¸€æ®µå†…å­˜ï¼Œå¤šç§åˆ†æ®µæ–¹æ¡ˆ"></a>2.4.2 åŒä¸€æ®µå†…å­˜ï¼Œå¤šç§åˆ†æ®µæ–¹æ¡ˆ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710235333716.png" alt="image-20230710235333716" style="zoom: 67%;"><h4 id="2-4-3-ç”¨ä¸åŒçš„æ®µåœ°å€å’Œåç§»åœ°å€å½¢æˆåŒä¸€ä¸ªç‰©ç†åœ°å€"><a href="#2-4-3-ç”¨ä¸åŒçš„æ®µåœ°å€å’Œåç§»åœ°å€å½¢æˆåŒä¸€ä¸ªç‰©ç†åœ°å€" class="headerlink" title="2.4.3 ç”¨ä¸åŒçš„æ®µåœ°å€å’Œåç§»åœ°å€å½¢æˆåŒä¸€ä¸ªç‰©ç†åœ°å€"></a>2.4.3 ç”¨ä¸åŒçš„æ®µåœ°å€å’Œåç§»åœ°å€å½¢æˆåŒä¸€ä¸ªç‰©ç†åœ°å€</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230710235404944.png" alt="image-20230710235404944" style="zoom:67%;"><h3 id="2-5-Debugçš„ä½¿ç”¨"><a href="#2-5-Debugçš„ä½¿ç”¨" class="headerlink" title="2.5 Debugçš„ä½¿ç”¨"></a>2.5 Debugçš„ä½¿ç”¨</h3><h3 id="2-6-CSã€IPä¸ä»£ç æ®µ"><a href="#2-6-CSã€IPä¸ä»£ç æ®µ" class="headerlink" title="2.6 CSã€IPä¸ä»£ç æ®µ"></a>2.6 CSã€IPä¸ä»£ç æ®µ</h3><p>ä¸¤ä¸ªå…³é”®çš„å¯„å­˜å™¨ï¼š</p><ul><li>CSï¼šä»£ç æ®µå¯„å­˜å™¨</li><li>IPï¼šæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨</li><li>â­<strong>CS:IPï¼šCPUå°†å†…å­˜ä¸­CS:IPæŒ‡å‘çš„å†…å®¹å½“åšæŒ‡ä»¤æ‰§è¡Œ</strong></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814230353121.png" alt="image-20230814230353121" style="zoom:67%;"><p><strong>ç¤ºä¾‹ï¼šåœ¨CSå’ŒIPæŒ‡ç¤ºä¸‹ä»£ç çš„æ‰§è¡Œ</strong></p><ul><li>8086CPUå½“å‰çŠ¶æ€ï¼šCSä¸­å†…å®¹ä¸º2000Hï¼ŒIPä¸­å†…å®¹ä¸º0000H</li><li>å†…å­˜20000H~20009Hå¤„å­˜æ”¾ç€å¯æ‰§è¡Œçš„æœºå™¨ä»£ç â€˜</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814230512608.png" alt="image-20230814230512608" style="zoom:67%;"><p><strong>8086PCå·¥ä½œè¿‡ç¨‹çš„ç®€è¦æè¿°ï¼š</strong></p><ol><li>ä»CS:IPæŒ‡å‘å†…å­˜å•å…ƒè¯»å–æŒ‡ä»¤ï¼Œè¯»å–çš„æŒ‡ä»¤è¿›å…¥æŒ‡ä»¤ç¼“å†²å™¨</li><li>IP&#x3D;IP+æ‰€è¯»æŒ‡ä»¤çš„é•¿åº¦ï¼Œä»è€ŒæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤</li><li>æ‰§è¡ŒæŒ‡ä»¤ã€‚è½¬åˆ°æ­¥éª¤ï¼ˆ1ï¼‰ï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹</li></ol><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/CSIPä½¿ç”¨.gif" style="zoom:67%;"><p><strong>DEBUGæ¼”ç¤ºï¼š</strong></p><ul><li>ä½¿ç”¨<strong>r</strong>å‘½ä»¤æŸ¥çœ‹å½“å‰æ‰€æœ‰å¯„å­˜å™¨çš„å€¼</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814230955255.png" alt="image-20230814230955255" style="zoom:67%;"><ul><li>ä½¿ç”¨<strong>rcs</strong>å’Œ<strong>rip</strong>æ”¹å˜cså’Œipçš„å€¼</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814231054600.png" alt="image-20230814231054600" style="zoom:80%;"><ul><li><p>ä½¿ç”¨<strong>a</strong>å‘½ä»¤å†™å…¥æ±‡ç¼–æŒ‡ä»¤</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814231121068.png" alt="image-20230814231121068" style="zoom:67%;"></li><li><p>ä½¿ç”¨tå‘½ä»¤æ‰§è¡ŒæŒ‡ä»¤</p></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814231312265.png" alt="image-20230814231312265" style="zoom:67%;"><blockquote><p>å†æ¬¡å¼ºè°ƒï¼š<strong>å†…å­˜ä¸­æ¯ä¸ªä½ç½®åˆ°åº•å­˜çš„æ˜¯æ•°æ®è¿˜æ˜¯æŒ‡ä»¤ï¼Œå¦‚æœæ˜¯CS:IPæŒ‡å‘çš„é‚£å°±æ˜¯æŒ‡ä»¤</strong></p></blockquote><h3 id="2-7-jmpæŒ‡ä»¤"><a href="#2-7-jmpæŒ‡ä»¤" class="headerlink" title="2.7 jmpæŒ‡ä»¤"></a>2.7 jmpæŒ‡ä»¤</h3><p>äº‹å®ï¼šæ‰§è¡Œä½•å¤„çš„æŒ‡ä»¤ï¼Œå–å†³äºCS:IP</p><p>åº”ç”¨ï¼šå¯ä»¥é€šè¿‡æ”¹å˜CSã€IPä¸­çš„å†…å®¹ï¼Œæ¥æ§åˆ¶CPUè¦æ‰§è¡Œçš„ç›®æ ‡æŒ‡ä»¤</p><p>é—®é¢˜ï¼šå¦‚ä½•æ”¹å˜CSã€IPçš„å€¼ï¼Ÿ</p><ul><li><p>æ–¹æ³•1ï¼šDebug ä¸­çš„ R å‘½ä»¤å¯ä»¥æ”¹å˜å¯„å­˜å™¨çš„å€¼â€”â€”rcs, rip</p></li><li><p>Debugæ˜¯è°ƒè¯•æ‰‹æ®µï¼Œå¹¶éç¨‹åºæ–¹å¼ï¼</p></li><li><p>æ–¹æ³•2ï¼šç”¨æŒ‡ä»¤ä¿®æ”¹</p></li><li><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814232606821.png" alt="image-20230814232606821" style="zoom:67%;"></li><li><p><strong>æ–¹æ³•3ï¼šè½¬ç§»æŒ‡ä»¤ jmp</strong></p></li></ul><h4 id="2-7-1-è½¬ç§»æŒ‡ä»¤jmp"><a href="#2-7-1-è½¬ç§»æŒ‡ä»¤jmp" class="headerlink" title="2.7.1 è½¬ç§»æŒ‡ä»¤jmp"></a>2.7.1 è½¬ç§»æŒ‡ä»¤jmp</h4><p><strong>åŒæ—¶ä¿®æ”¹CSã€IPçš„å†…å®¹</strong></p><ul><li>jmp æ®µåœ°å€ï¼šåç§»åœ°å€</li><li>jmp 2AE3:3</li><li>jmp 3:0B16</li></ul><p><strong>åŠŸèƒ½ï¼šç”¨æŒ‡ä»¤ä¸­ç»™å‡ºçš„æ®µåœ°å€ä¿®æ”¹CSï¼Œåç§»åœ°å€ä¿®æ”¹IPã€‚</strong></p><p><strong>ä»…ä¿®æ”¹IPçš„å†…å®¹</strong></p><ul><li>jmp æŸä¸€åˆæ³•å¯„å­˜å™¨</li><li>jmp ax ï¼ˆç±»ä¼¼äº mov IP, axï¼‰</li><li>jmp bx</li></ul><p><strong>åŠŸèƒ½ï¼šç”¨å¯„å­˜å™¨ä¸­çš„å€¼ä¿®æ”¹IPã€‚</strong></p><h4 id="2-7-2-æ¡ˆä¾‹åˆ†æ"><a href="#2-7-2-æ¡ˆä¾‹åˆ†æ" class="headerlink" title="2.7.2 æ¡ˆä¾‹åˆ†æ"></a>2.7.2 æ¡ˆä¾‹åˆ†æ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814232824634.png" alt="image-20230814232824634" style="zoom:80%;"><p><strong>DEBUGè°ƒè¯•</strong></p><ul><li>é€šè¿‡<strong>a</strong>å‘½ä»¤å†™å…¥æŒ‡ä»¤</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814232859407.png" alt="image-20230814232859407" style="zoom:67%;"><ul><li><p>ä¿®æ”¹<strong>rcsï¼Œrip</strong>èµ·å§‹åœ°å€</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814232939498-1692026986451-1.png" alt="image-20230814232939498" style="zoom:67%;"></li><li><p>é€šè¿‡<strong>t</strong>æŒ‡ä»¤å•æ­¥è°ƒè¯•</p></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814233023823.png" alt="image-20230814233023823" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230814233101872-1692027062908-3.png" alt="image-20230814233101872" style="zoom:67%;"><h3 id="2-8-å†…å­˜ä¸­å­—çš„å­˜å‚¨"><a href="#2-8-å†…å­˜ä¸­å­—çš„å­˜å‚¨" class="headerlink" title="2.8 å†…å­˜ä¸­å­—çš„å­˜å‚¨"></a>2.8 å†…å­˜ä¸­å­—çš„å­˜å‚¨</h3><h4 id="2-8-1-å†…å­˜ä¸­å­—çš„å­˜å‚¨"><a href="#2-8-1-å†…å­˜ä¸­å­—çš„å­˜å‚¨" class="headerlink" title="2.8.1 å†…å­˜ä¸­å­—çš„å­˜å‚¨"></a>2.8.1 å†…å­˜ä¸­å­—çš„å­˜å‚¨</h4><p>äº‹å®ï¼šå¯¹8086CPUï¼Œ16ä½ä½œä¸ºä¸€ä¸ªå­—</p><p>é—®é¢˜ï¼š16ä½çš„å­—å­˜å‚¨åœ¨ä¸€ä¸ª16ä½çš„å¯„å­˜å™¨ä¸­ï¼Œå¦‚ä½•å­˜å‚¨ï¼Ÿ</p><p>å›ç­”ï¼šé«˜8ä½æ”¾é«˜å­—èŠ‚ï¼Œä½8ä½æ”¾ä½å­—èŠ‚</p><p>é—®é¢˜ï¼š16ä½çš„å­—åœ¨<strong>å†…å­˜</strong>ä¸­éœ€è¦2ä¸ªè¿ç»­å­—èŠ‚å­˜å‚¨ï¼Œæ€ä¹ˆå­˜æ”¾ï¼Ÿ</p><p>å›ç­”ï¼š ä½ä½å­—èŠ‚å­˜åœ¨ä½åœ°å€å•å…ƒï¼Œé«˜ä½å­—èŠ‚å­˜åœ¨é«˜åœ°å€å•å…ƒ</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017223725866.png" alt="image-20231017223725866" style="zoom:67%;"><h4 id="2-8-2-å­—å•å…ƒ"><a href="#2-8-2-å­—å•å…ƒ" class="headerlink" title="2.8.2 å­—å•å…ƒ"></a>2.8.2 å­—å•å…ƒ</h4><p><strong>å­—å•å…ƒ</strong>ï¼šç”±ä¸¤ä¸ªåœ°å€è¿ç»­çš„å†…å­˜å•å…ƒç»„æˆï¼Œå­˜æ”¾ä¸€ä¸ªå­—å‹æ•°æ®ï¼ˆ16ä½ï¼‰</p><p><strong>åŸç†</strong>ï¼šåœ¨ä¸€ä¸ªå­—å•å…ƒä¸­ï¼Œä½åœ°å€å•å…ƒå­˜æ”¾ä½ä½å­—èŠ‚ï¼Œé«˜åœ°å€å•å…ƒå­˜æ”¾é«˜ä½å­—èŠ‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017223822854.png" alt="image-20231017223822854" style="zoom:80%;"><ul><li>åœ¨èµ·å§‹åœ°å€ä¸º0çš„å•å…ƒä¸­ï¼Œå­˜æ”¾çš„æ˜¯4E20H</li><li>åœ¨èµ·å§‹åœ°å€ä¸º2çš„å•å…ƒä¸­ï¼Œå­˜æ”¾çš„æ˜¯0012H</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017223854704.png" alt="image-20231017223854704" style="zoom:67%;"><h3 id="2-9-ç”¨DSå’Œ-addresss-å®ç°å­—çš„ä¼ é€"><a href="#2-9-ç”¨DSå’Œ-addresss-å®ç°å­—çš„ä¼ é€" class="headerlink" title="2.9 ç”¨DSå’Œ[addresss]å®ç°å­—çš„ä¼ é€"></a>2.9 ç”¨DSå’Œ[addresss]å®ç°å­—çš„ä¼ é€</h3><h4 id="2-9-1-è¦è§£å†³çš„é—®é¢˜ï¼šCPUä»å†…å­˜å•å…ƒä¸­è¦è¯»å–çš„æ•°æ®"><a href="#2-9-1-è¦è§£å†³çš„é—®é¢˜ï¼šCPUä»å†…å­˜å•å…ƒä¸­è¦è¯»å–çš„æ•°æ®" class="headerlink" title="2.9.1 è¦è§£å†³çš„é—®é¢˜ï¼šCPUä»å†…å­˜å•å…ƒä¸­è¦è¯»å–çš„æ•°æ®"></a>2.9.1 è¦è§£å†³çš„é—®é¢˜ï¼šCPUä»å†…å­˜å•å…ƒä¸­è¦è¯»å–çš„æ•°æ®</h4><p>è¦æ±‚ï¼šCPUè¦è¯»å–ä¸€ä¸ªå†…å­˜å•å…ƒçš„æ—¶å€™ï¼Œå¿…é¡»å…ˆç»™å‡ºè¿™ä¸ªå†…å­˜å•å…ƒçš„åœ°å€</p><p>åŸç†ï¼šåœ¨8086 PCä¸­ï¼Œå†…å­˜åœ°å€ç”±æ®µåœ°å€å’Œåç§»åœ°å€ç»„æˆï¼ˆæ®µåœ°å€:åç§»åœ°å€ï¼‰</p><p>è§£å†³æ–¹æ¡ˆï¼šDSå’Œ[address]é…åˆ</p><ul><li>ç”¨DSå¯„å­˜å™¨å­˜æ”¾è¦ä¿®æ”¹çš„æ•°æ®çš„æ®µåœ°å€</li><li>åç§»åœ°å€ç”¨[â€¦]å½¢å¼ç»™å‡º</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017224210041.png" alt="image-20231017224210041" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017224225895.png" alt="image-20231017224225895" style="zoom:80%;"><h4 id="2-9-2-å­—çš„ä¼ é€"><a href="#2-9-2-å­—çš„ä¼ é€" class="headerlink" title="2.9.2 å­—çš„ä¼ é€"></a>2.9.2 å­—çš„ä¼ é€</h4><p>8086CPUå¯ä»¥ä¸€æ¬¡æ€§ä¼ é€ä¸€ä¸ªå­—ï¼ˆ16ä½çš„æ•°æ®ï¼‰</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017224322736.png" alt="image-20231017224322736" style="zoom:67%;"><h4 id="2-9-3-æ¡ˆä¾‹åˆ†æ"><a href="#2-9-3-æ¡ˆä¾‹åˆ†æ" class="headerlink" title="2.9.3 æ¡ˆä¾‹åˆ†æ"></a>2.9.3 æ¡ˆä¾‹åˆ†æ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017224347327.png" alt="image-20231017224347327" style="zoom: 50%;"><ul><li>mov ax, 1000Hï¼šå°†1000Hå­˜æ”¾åœ¨AXå¯„å­˜å™¨ä¸­</li><li>mov ds, axï¼šå°†axå¯„å­˜å™¨çš„å€¼èµ‹å€¼ç»™dså¯„å­˜å™¨ï¼Œå³ç°åœ¨æ®µåœ°å€ä¸º1000H</li><li>mov ax, [0]ï¼šå°†1000:0çš„å€¼ã€å³1123ï¼Œå› ä¸ºaxæ˜¯16ä½çš„ï¼Œä¸ºå­—ç¬¦å‹å¯„å­˜å™¨ã€‘èµ‹å€¼ç»™axå¯„å­˜å™¨</li><li>mov bx, [2]ï¼šå°†1000:2çš„å€¼ã€å³6622ï¼Œå› ä¸ºbxä¹Ÿæ˜¯å­—ç¬¦å‹å¯„å­˜å™¨ã€‘èµ‹å€¼ç»™bxå¯„å­˜å™¨</li><li>mov cx, [1]ï¼šå°†1000:1çš„å€¼ã€å³2211ï¼Œå› ä¸ºcxä¹Ÿæ˜¯å­—ç¬¦å‹å¯„å­˜å™¨ã€‘èµ‹å€¼ç»™cxå¯„å­˜å™¨</li><li>add bx, [1]ï¼šå°†bxåŠ ä¸Š1000:1çš„å€¼ &#x3D; 6622H + 2211H &#x3D; 8833H</li><li>add cx, [2]ï¼šå°†cxåŠ ä¸Š1000:2çš„å€¼ &#x3D; 2211H + 6622H &#x3D; 8833H</li></ul><p>è°ƒè¯•ç»“æœï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017224431299.png" alt="image-20231017224431299" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017225144131.png" alt="image-20231017225144131" style="zoom:80%;"><h3 id="2-10-DSä¸æ•°æ®æ®µ"><a href="#2-10-DSä¸æ•°æ®æ®µ" class="headerlink" title="2.10 DSä¸æ•°æ®æ®µ"></a>2.10 DSä¸æ•°æ®æ®µ</h3><h4 id="2-10-1-å¯¹å†…å­˜å•å…ƒä¸­æ•°æ®çš„è®¿é—®"><a href="#2-10-1-å¯¹å†…å­˜å•å…ƒä¸­æ•°æ®çš„è®¿é—®" class="headerlink" title="2.10.1 å¯¹å†…å­˜å•å…ƒä¸­æ•°æ®çš„è®¿é—®"></a>2.10.1 å¯¹å†…å­˜å•å…ƒä¸­æ•°æ®çš„è®¿é—®</h4><p>å¯¹äº8096 PCæœºï¼Œå¯ä»¥æ ¹æ®éœ€è¦å°†ä¸€ç»„å†…å­˜å•å…ƒå®šä¹‰ä¸ºä¸€ä¸ªæ®µã€‚</p><ul><li>ç‰©ç†åœ°å€&#x3D;æ®µåœ°å€Ã—16+åç§»åœ°å€</li><li>å°†ä¸€ç»„é•¿åº¦ä¸ºNï¼ˆNâ‰¤64Kï¼‰ã€åœ°å€è¿ç»­ã€èµ·å§‹åœ°å€ä¸º16çš„å€æ•°çš„å†…å­˜å•å…ƒå½“ä½œä¸“é—¨å­˜å‚¨æ•°æ®çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå®šä¹‰äº†ä¸€ä¸ªæ•°æ®æ®µ</li></ul><p>ä¾‹ï¼šç”¨123B0H~123B9Hçš„ç©ºé—´æ¥å­˜æ”¾æ•°æ®</p><ul><li>æ®µåœ°å€ï¼š123BHã€€èµ·å§‹åç§»åœ°å€ï¼š0000Hã€€é•¿åº¦ï¼š10å­—èŠ‚</li><li>æ®µåœ°å€ï¼š1230Hã€€èµ·å§‹åç§»åœ°å€ï¼š00B0Hã€€é•¿åº¦ï¼š10å­—èŠ‚</li></ul><p><strong>å¤„ç†æ–¹æ³•</strong>ï¼š(DS):([address])</p><ul><li>ç”¨DSå­˜æ”¾æ•°æ®æ®µçš„æ®µåœ°å€</li><li>ç”¨ç›¸å…³æŒ‡ä»¤è®¿é—®æ•°æ®æ®µä¸­çš„å…·ä½“å•å…ƒï¼Œå•å…ƒåœ°å€ç”±[address]æŒ‡å‡º</li></ul><h4 id="2-10-2-å°†123B0H-123BAHçš„å†…å­˜å•å…ƒå®šä¹‰ä¸ºæ•°æ®æ®µ"><a href="#2-10-2-å°†123B0H-123BAHçš„å†…å­˜å•å…ƒå®šä¹‰ä¸ºæ•°æ®æ®µ" class="headerlink" title="2.10.2 å°†123B0H~123BAHçš„å†…å­˜å•å…ƒå®šä¹‰ä¸ºæ•°æ®æ®µ"></a>2.10.2 å°†123B0H~123BAHçš„å†…å­˜å•å…ƒå®šä¹‰ä¸ºæ•°æ®æ®µ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017230500913.png" alt="image-20231017230500913" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231017230529058.png" alt="image-20231017230529058" style="zoom: 67%;"><h4 id="2-10-3-ç”¨DSå’Œ-address-å½¢å¼è®¿é—®å†…å­˜ä¸­æ•°æ®æ®µæ–¹æ³•å°ç»“"><a href="#2-10-3-ç”¨DSå’Œ-address-å½¢å¼è®¿é—®å†…å­˜ä¸­æ•°æ®æ®µæ–¹æ³•å°ç»“" class="headerlink" title="2.10.3 ç”¨DSå’Œ[address]å½¢å¼è®¿é—®å†…å­˜ä¸­æ•°æ®æ®µæ–¹æ³•å°ç»“"></a>2.10.3 ç”¨DSå’Œ[address]å½¢å¼è®¿é—®å†…å­˜ä¸­æ•°æ®æ®µæ–¹æ³•å°ç»“</h4><ul><li>å­—åœ¨å†…å­˜ä¸­å­˜å‚¨æ—¶ ï¼Œè¦ç”¨ä¸¤ä¸ªåœ°å€è¿ç»­çš„å†…å­˜å•å…ƒæ¥å­˜æ”¾ï¼Œå­—çš„ä½ä½å­—èŠ‚å­˜æ”¾åœ¨ä½åœ°å€å•å…ƒä¸­ï¼Œé«˜ä½å­—èŠ‚å­˜æ”¾å†é«˜åœ°å€å•å…ƒä¸­ã€‚</li><li>ç”¨ mov æŒ‡ä»¤è¦è®¿é—®å†…å­˜å•å…ƒï¼Œå¯ä»¥åœ¨movæŒ‡ä»¤ä¸­åªç»™å‡ºå•å…ƒçš„åç§»åœ°å€ï¼Œæ­¤æ—¶ï¼Œæ®µåœ°å€é»˜è®¤åœ¨DSå¯„å­˜å™¨ä¸­</li><li>[address]è¡¨ç¤ºä¸€ä¸ªåç§»åœ°å€ä¸ºaddressçš„å†…å­˜å•å…ƒã€‚</li><li>åœ¨å†…å­˜å’Œå¯„å­˜å™¨ä¹‹é—´ä¼ é€å­—ç¬¦å‹æ•°æ®æ—¶ï¼Œé«˜åœ°å€å•å…ƒå’Œé«˜8ä½å¯„å­˜å™¨ã€ä½åœ°å€å•å…ƒå’Œä½8ä½å¯„å­˜å™¨ç›¸å¯¹åº”ã€‚</li><li>movã€addã€subæ˜¯å…·æœ‰ä¸¤ä¸ªæ“ä½œå¯¹è±¡çš„æŒ‡ä»¤ï¼Œè®¿é—®å†…å­˜ä¸­çš„æ•°æ®æ®µï¼ˆå¯¹ç…§ï¼šjmpæ˜¯å…·æœ‰ä¸€ä¸ªæ“ä½œå¯¹è±¡çš„æŒ‡ä»¤ï¼Œå¯¹åº”å†…å­˜ä¸­çš„ä»£ç æ®µï¼‰</li><li>å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¨æµ‹ï¼Œåœ¨Debugä¸­å®éªŒæŒ‡ä»¤çš„æ–°æ ¼å¼ã€‚</li></ul><h3 id="2-11-æ ˆåŠæ ˆæ“ä½œçš„å®ç°"><a href="#2-11-æ ˆåŠæ ˆæ“ä½œçš„å®ç°" class="headerlink" title="2.11  æ ˆåŠæ ˆæ“ä½œçš„å®ç°"></a>2.11  æ ˆåŠæ ˆæ“ä½œçš„å®ç°</h3><h4 id="2-11-1-æ ˆç»“æ„"><a href="#2-11-1-æ ˆç»“æ„" class="headerlink" title="2.11.1 æ ˆç»“æ„"></a>2.11.1 æ ˆç»“æ„</h4><ul><li>æ ˆæ˜¯ä¸€ç§åªèƒ½åœ¨ä¸€ç«¯è¿›è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œçš„æ•°æ®ç»“æ„ã€‚</li><li>æ ˆæœ‰2ä¸ªåŸºæœ¬çš„æ“ä½œï¼šå…¥æ ˆå’Œå‡ºæ ˆ<ul><li>å…¥æ ˆï¼šå°†ä¸€ä¸ªæ–°çš„å…ƒç´ æ”¾åˆ°æ ˆé¡¶</li><li>å‡ºæ ˆï¼šä»æ ˆé¡¶å–å‡ºä¸€ä¸ªå…ƒç´ </li></ul></li><li>æ ˆé¡¶çš„å…ƒç´ æ€»æ˜¯æœ€åå…¥æ ˆï¼Œéœ€è¦å‡ºæ ˆæ—¶ï¼Œåˆæœ€å…ˆè¢«ä»æ ˆä¸­å–å‡º</li><li>æ ˆçš„æ“ä½œè§„åˆ™ï¼šLIFOï¼ˆLast In First Outï¼Œåè¿›å…ˆå‡ºï¼‰</li><li>CPUæä¾›çš„æ ˆæœºåˆ¶<ul><li>ç°é‡‘çš„CPUä¸­éƒ½æœ‰æ ˆçš„è®¾è®¡</li><li>8086 CPUæä¾›ç›¸å…³çš„æŒ‡ä»¤ï¼Œæ”¯æŒç”¨æ ˆçš„æ–¹å¼è®¿é—®å†…å­˜ç©ºé—´</li><li>åŸºäº8086 CPUçš„ç¼–ç¨‹ï¼Œå¯ä»¥å°†ä¸€æ®µå†…å­˜å½“ä½œæ ˆæ¥ä½¿ç”¨</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224356757.png" alt="image-20231019224356757" style="zoom:80%;"><hr><p><strong>ä¾‹ï¼šç°å°†10000H~1000FHå†…å­˜å½“ä½œæ ˆæ¥ä½¿ç”¨â€¦â€¦</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224507713.png" alt="image-20231019224507713" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224524046.png" alt="image-20231019224524046" style="zoom:80%;"><h4 id="2-11-2-æ ˆçš„æ“ä½œ"><a href="#2-11-2-æ ˆçš„æ“ä½œ" class="headerlink" title="2.11.2 æ ˆçš„æ“ä½œ"></a>2.11.2 æ ˆçš„æ“ä½œ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224551005.png" alt="image-20231019224551005" style="zoom:67%;"><p>æ‰§è¡Œå‰å†…å­˜ç©ºé—´ï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224616181.png" alt="image-20231019224616181" style="zoom: 67%;"><p>æ‰§è¡Œæ ˆæ“ä½œåï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019224637070.png" alt="image-20231019224637070" style="zoom: 67%;"><h4 id="2-11-3-pushæŒ‡ä»¤å’ŒpopæŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#2-11-3-pushæŒ‡ä»¤å’ŒpopæŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="2.11.3 pushæŒ‡ä»¤å’ŒpopæŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹"></a>2.11.3 pushæŒ‡ä»¤å’ŒpopæŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹</h4><p>ğŸ†<strong>push ax</strong></p><ul><li>SP&#x3D;SP-2</li><li>å°†axä¸­çš„å†…å®¹é€å…¥SS:SPæŒ‡å‘çš„å†…å­˜å•å…ƒå¤„ï¼ŒSS:SPæ­¤æ—¶æŒ‡å‘æ–°æ ˆé¡¶</li></ul><p>ğŸ†<strong>pop ax</strong></p><ul><li>å°†SS:SPæŒ‡å‘çš„å†…å­˜å•å…ƒå¤„çš„æ•°æ®é€å…¥axä¸­</li><li>SP&#x3D;SP+2ï¼ŒSS:SPæŒ‡å‘å½“å‰æ ˆé¡¶ä¸‹é¢çš„å•å…ƒï¼Œä»¥å½“å‰æ ˆé¡¶ä¸‹é¢çš„å•å…ƒä¸ºæ–°çš„æ ˆé¡¶</li></ul><h4 id="2-11-4-æ‰§è¡Œå…¥æ ˆæˆ–å‡ºæ ˆæ—¶å¦‚ä½•ä¿è¯ä¸è¶Šç•Œ"><a href="#2-11-4-æ‰§è¡Œå…¥æ ˆæˆ–å‡ºæ ˆæ—¶å¦‚ä½•ä¿è¯ä¸è¶Šç•Œ" class="headerlink" title="2.11.4 æ‰§è¡Œå…¥æ ˆæˆ–å‡ºæ ˆæ—¶å¦‚ä½•ä¿è¯ä¸è¶Šç•Œ"></a>2.11.4 æ‰§è¡Œå…¥æ ˆæˆ–å‡ºæ ˆæ—¶å¦‚ä½•ä¿è¯ä¸è¶Šç•Œ</h4><p><strong>8086 CPUä¸ä¿è¯å¯¹æ ˆçš„æ“ä½œä¸ä¼šè¶Šç•Œï¼›</strong></p><p>8086CPUåªçŸ¥é“æ ˆé¡¶åœ¨ä½•å¤„ï¼ˆç”±SS:SPæŒ‡ç¤ºï¼‰ï¼Œä¸çŸ¥é“ç¨‹åºå®‰æ’çš„æ ˆç©ºé—´æœ‰å¤šå¤§ã€‚</p><p>æˆ‘ä»¬åœ¨ç¼–ç¨‹çš„æ—¶å€™è¦è‡ªå·±æ“å¿ƒæ ˆé¡¶è¶Šç•Œçš„é—®é¢˜ï¼Œè¦æ ¹æ®å¯èƒ½ç”¨åˆ°çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ¥å®‰æ’æ ˆçš„å¤§å°ï¼Œé˜²æ­¢å…¥æ ˆçš„æ•°æ®å¤ªå¤šè€Œå¯¼è‡´çš„è¶Šç•Œï¼›é˜²æ­¢å‡ºæ ˆæ—¶ç©ºäº†ä»ç„¶ç»§ç»­å‡ºæ ˆè€Œå¯¼è‡´çš„è¶Šç•Œã€‚</p><h4 id="2-11-5-æ ˆçš„å°ç»“"><a href="#2-11-5-æ ˆçš„å°ç»“" class="headerlink" title="2.11.5 æ ˆçš„å°ç»“"></a>2.11.5 æ ˆçš„å°ç»“</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019225239376.png" alt="image-20231019225239376" style="zoom:67%;"><h3 id="2-12-å…³äºæ®µçš„æ€»ç»“"><a href="#2-12-å…³äºæ®µçš„æ€»ç»“" class="headerlink" title="2.12 å…³äºæ®µçš„æ€»ç»“"></a>2.12 å…³äºæ®µçš„æ€»ç»“</h3><h4 id="2-12-1-å„ç§æ®µ"><a href="#2-12-1-å„ç§æ®µ" class="headerlink" title="2.12.1 å„ç§æ®µ"></a>2.12.1 å„ç§æ®µ</h4><p>âœ…åŸºç¡€ï¼š<strong>ç‰©ç†åœ°å€ &#x3D; æ®µåœ°å€ Ã— 16 + åç§»åœ°å€</strong></p><p>åšæ³•ï¼š</p><ul><li>ç¼–ç¨‹æ—¶ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å°†ä¸€ç»„å†…å­˜å•å…ƒå®šä¹‰ä¸ºä¸€ä¸ªæ®µ</li><li>å¯ä»¥å°†èµ·å§‹åœ°å€ä¸º16çš„å€æ•°ï¼Œé•¿åº¦ä¸ºNï¼ˆNâ‰¤64Kï¼‰çš„ä¸€ç»„åœ°å€è¿ç»­çš„å†…å­˜å•å…ƒï¼Œå®šä¹‰ä¸ºä¸€ä¸ªæ®µ</li><li>å°†ä¸€æ®µå†…å­˜å®šä¹‰ä¸ºä¸€ä¸ªæ®µï¼Œç”¨ä¸€ä¸ªæ®µåœ°å€æŒ‡ç¤ºæ®µï¼Œç”¨åç§»åœ°å€è®¿é—®æ®µå†…çš„å•å…ƒâ€”â€”åœ¨ç¨‹åºä¸­å¯ä»¥å®Œæˆç”±ç¨‹åºå‘˜å®‰æ’</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019225602999.png" alt="image-20231019225602999" style="zoom: 80%;"><h2 id="3-æ±‡ç¼–è¯­è¨€ç¨‹åº"><a href="#3-æ±‡ç¼–è¯­è¨€ç¨‹åº" class="headerlink" title="3.æ±‡ç¼–è¯­è¨€ç¨‹åº"></a>3.æ±‡ç¼–è¯­è¨€ç¨‹åº</h2><h3 id="3-1-ç”¨æ±‡ç¼–è¯­è¨€å†™æºç¨‹åº"><a href="#3-1-ç”¨æ±‡ç¼–è¯­è¨€å†™æºç¨‹åº" class="headerlink" title="3.1 ç”¨æ±‡ç¼–è¯­è¨€å†™æºç¨‹åº"></a>3.1 ç”¨æ±‡ç¼–è¯­è¨€å†™æºç¨‹åº</h3><h4 id="3-1-1-ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ç¨‹åºçš„å·¥ä½œè¿‡ç¨‹"><a href="#3-1-1-ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ç¨‹åºçš„å·¥ä½œè¿‡ç¨‹" class="headerlink" title="3.1.1 ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ç¨‹åºçš„å·¥ä½œè¿‡ç¨‹"></a>3.1.1 ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ç¨‹åºçš„å·¥ä½œè¿‡ç¨‹</h4><p>ğŸ†<strong>æ±‡ç¼–ç¨‹åºï¼šåŒ…å«æ±‡ç¼–æŒ‡ä»¤å’Œä¼ªæŒ‡ä»¤çš„æ–‡æœ¬</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019233615304.png" alt="image-20231019233615304" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019233706662.png" alt="image-20231019233706662" style="zoom: 80%;"><p><strong>ä¼ªæŒ‡ä»¤ï¼šæ²¡æœ‰å¯¹åº”çš„æœºå™¨ç æŒ‡ä»¤ï¼Œæœ€ç»ˆä¸è¢«CPUæ‰§è¡Œ</strong></p><blockquote><p>è°æ¥æ‰§è¡Œä¼ªæŒ‡ä»¤å‘¢ï¼Ÿ</p><p>ä¼ªæŒ‡ä»¤æ˜¯ç”±ç¼–è¯‘å™¨æ¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œç¼–è¯‘å™¨æ ¹æ®ä¼ªæŒ‡ä»¤æ¥è¿›è¡Œç›¸å…³çš„ç¼–è¯‘å·¥ä½œ</p></blockquote><p>ç¨‹åºè¿”å›ï¼šç¨‹åºè¿è¡Œç»“æŸåï¼Œå°†CPUçš„æ§åˆ¶æƒäº¤ç»™ä½¿å®ƒå¾—ä»¥è¿è¡Œçš„ç¨‹åºï¼ˆå¸¸ä¸ºDOSç³»ç»Ÿï¼‰ã€8086CPUå›ºå®šä½ï¼šmov ax,4c00hï¼›int 21hã€‘</p><h4 id="3-1-2-ç¨‹åºä¸­ä¸‰ç§ä¼ªæŒ‡ä»¤"><a href="#3-1-2-ç¨‹åºä¸­ä¸‰ç§ä¼ªæŒ‡ä»¤" class="headerlink" title="3.1.2 ç¨‹åºä¸­ä¸‰ç§ä¼ªæŒ‡ä»¤"></a>3.1.2 ç¨‹åºä¸­ä¸‰ç§ä¼ªæŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019233938706.png" alt="image-20231019233938706" style="zoom:67%;"><h4 id="3-1-3-æºç¨‹åºç»ç¼–è¯‘é“¾æ¥åå˜ä¸ºæœºå™¨ç "><a href="#3-1-3-æºç¨‹åºç»ç¼–è¯‘é“¾æ¥åå˜ä¸ºæœºå™¨ç " class="headerlink" title="3.1.3 æºç¨‹åºç»ç¼–è¯‘é“¾æ¥åå˜ä¸ºæœºå™¨ç "></a>3.1.3 æºç¨‹åºç»ç¼–è¯‘é“¾æ¥åå˜ä¸ºæœºå™¨ç </h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019234020855.png" alt="image-20231019234020855" style="zoom:67%;"><h4 id="3-1-4-å¦‚ä½•å†™å‡ºä¸€ä¸ªç¨‹åºæ¥"><a href="#3-1-4-å¦‚ä½•å†™å‡ºä¸€ä¸ªç¨‹åºæ¥" class="headerlink" title="3.1.4 å¦‚ä½•å†™å‡ºä¸€ä¸ªç¨‹åºæ¥"></a>3.1.4 å¦‚ä½•å†™å‡ºä¸€ä¸ªç¨‹åºæ¥</h4><ol><li>å®šä¹‰ä¸€ä¸ªæ®µ</li><li>å®ç°å¤„ç†ä»»åŠ¡</li><li>æŒ‡å‡ºç¨‹åºåœ¨ä½•å¤„ç»“æŸ</li><li>æ®µä¸æ®µå¯„å­˜å™¨å…³è”</li><li>åŠ ä¸Šç¨‹åºè¿”å›çš„ä»£ç </li></ol><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019234134875.png" alt="image-20231019234134875" style="zoom:67%;"><h3 id="3-2-ç”±æºç¨‹åºåˆ°ç¨‹åºæ‰§è¡Œ"><a href="#3-2-ç”±æºç¨‹åºåˆ°ç¨‹åºæ‰§è¡Œ" class="headerlink" title="3.2 ç”±æºç¨‹åºåˆ°ç¨‹åºæ‰§è¡Œ"></a>3.2 ç”±æºç¨‹åºåˆ°ç¨‹åºæ‰§è¡Œ</h3><h4 id="3-2-1-ç¼–è¾‘æºç¨‹åº"><a href="#3-2-1-ç¼–è¾‘æºç¨‹åº" class="headerlink" title="3.2.1 ç¼–è¾‘æºç¨‹åº"></a>3.2.1 ç¼–è¾‘æºç¨‹åº</h4><p>åœ¨<code>D:\MASM</code>åˆ›å»ºæ–‡ä»¶<code>p4-1.asm</code>ï¼Œå¹¶å†™å…¥æ±‡ç¼–æŒ‡ä»¤</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025232807914.png" alt="image-20231025232807914" style="zoom:80%;"><h4 id="3-2-2-ç¼–è¯‘"><a href="#3-2-2-ç¼–è¯‘" class="headerlink" title="3.2.2 ç¼–è¯‘"></a>3.2.2 ç¼–è¯‘</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025232927777.png" alt="image-20231025232927777" style="zoom:67%;"><ul><li>ç›®æ ‡æ–‡ä»¶ï¼ˆ*.OBJï¼‰æ˜¯æˆ‘ä»¬å¯¹ä¸€ä¸ªæºç¨‹åºè¿›è¡Œç¼–è¯‘è¦å¾—åˆ°çš„æœ€ç»ˆç»“æœã€‚</li><li>åˆ—è¡¨æ–‡ä»¶ï¼ˆ*.LSTï¼‰æ˜¯ç¼–è¯‘å™¨å°†æºç¨‹åºç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶çš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚</li><li>äº¤å‰å¼•ç”¨æ–‡ä»¶ï¼ˆ*.CRFï¼‰åŒåˆ—è¡¨æ–‡ä»¶ä¸€æ ·ï¼Œæ˜¯ç¼–è¯‘å™¨å°†æºç¨‹åºç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚</li><li>å¯¹æºç¨‹åºçš„ç¼–è¯‘ç»“æŸï¼Œç¼–è¯‘å™¨è¾“å‡ºçš„æœ€åä¸¤è¡Œå‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæºç¨‹åºæ²¡æœ‰è­¦å‘Šé”™è¯¯å’Œå¿…é¡»è¦æ”¹æ­£çš„é”™è¯¯ã€‚</li></ul><h4 id="3-2-3-è¿æ¥"><a href="#3-2-3-è¿æ¥" class="headerlink" title="3.2.3 è¿æ¥"></a>3.2.3 è¿æ¥</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233038026.png" alt="image-20231025233038026" style="zoom:80%;"><ul><li>å¯æ‰§è¡Œæ–‡ä»¶(.EXE)æ˜¯æˆ‘ä»¬å¯¹ä¸€ä¸ªç¨‹åºè¿›è¡Œè¿æ¥è¦å¾—åˆ°çš„æœ€ç»ˆç»“æœã€‚</li><li>æ˜ åƒæ–‡ä»¶(.MAP)æ˜¯è¿æ¥ç¨‹åºå°†ç›®æ ‡æ–‡ä»¶è¿æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´ç»“æœã€‚</li><li>åº“æ–‡ä»¶(.LIB)é‡ŒåŒ…å«äº†ä¸€äº›å¯ä»¥è°ƒç”¨çš„å­ç¨‹åºï¼Œå¦‚æœæˆ‘ä»¬çš„ç¨‹åºä¸­è°ƒç”¨äº†æŸä¸€ä¸ªåº“æ–‡ä»¶ä¸­çš„å­ç¨‹åºï¼Œå°±éœ€è¦<br>åœ¨è¿æ¥çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªåº“æ–‡ä»¶å’Œæˆ‘ä»¬çš„ç›®æ ‡æ–‡ä»¶è¿æ¥åˆ°ä¸€èµ·ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li>no stack segmentï¼Œä¸€ä¸ªâ€œæ²¡æœ‰æ ˆæ®µâ€çš„è­¦å‘Šé”™è¯¯ ï¼Œå½“å‰å¯ä»¥ä¸ç†ä¼šè¿™ä¸ªé”™è¯¯ã€‚</li></ul><h4 id="3-2-4-æ‰§è¡Œå¯æ‰§è¡Œç¨‹åº"><a href="#3-2-4-æ‰§è¡Œå¯æ‰§è¡Œç¨‹åº" class="headerlink" title="3.2.4 æ‰§è¡Œå¯æ‰§è¡Œç¨‹åº"></a>3.2.4 æ‰§è¡Œå¯æ‰§è¡Œç¨‹åº</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233149391.png" alt="image-20231025233149391" style="zoom:80%;"><ul><li>æˆ‘ä»¬çš„ç¨‹åºæ²¡æœ‰åƒæ˜¾ç¤ºå™¨è¾“å‡ºä»»ä½•ä¿¡æ¯ã€‚ç¨‹åºåªæ˜¯åšäº†ä¸€äº›å°†æ•°æ®é€å…¥å¯„å­˜å™¨å’ŒåŠ æ³•çš„æ“ä½œï¼Œè€Œè¿™äº›äº‹æƒ…ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ä»æ˜¾ç¤ºå±ä¸Šçœ‹å‡ºæ¥ã€‚</li><li>ç¨‹åºæ‰§è¡Œå®Œæˆåï¼Œè¿”å›ï¼Œå±å¹•ä¸Šå†æ¬¡å‡ºç°æ“ä½œç³»ç»Ÿçš„æç¤ºç¬¦ã€‚</li></ul><h3 id="3-3-è¿è¡ŒåŠè·Ÿè¸ª"><a href="#3-3-è¿è¡ŒåŠè·Ÿè¸ª" class="headerlink" title="3.3 è¿è¡ŒåŠè·Ÿè¸ª"></a>3.3 è¿è¡ŒåŠè·Ÿè¸ª</h3><h4 id="3-3-1-ç”¨Debugè£…è½½ç¨‹åº"><a href="#3-3-1-ç”¨Debugè£…è½½ç¨‹åº" class="headerlink" title="3.3.1 ç”¨Debugè£…è½½ç¨‹åº"></a>3.3.1 ç”¨Debugè£…è½½ç¨‹åº</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233325126.png" alt="image-20231025233325126" style="zoom:80%;"><ul><li><p>ç¨‹åºåŠ è½½åï¼ŒDSä¸­å­˜æ”¾ç€ç¨‹åºæ‰€åœ¨å†…å­˜åŒºçš„æ®µåœ°å€ï¼Œè¿™ä¸ªå†…å­˜åŒºçš„åç§»åœ°å€ä¸º 0 ï¼Œåˆ™ç¨‹åºæ‰€åœ¨çš„å†…å­˜åŒºçš„åœ°å€ä¸ºï¼šDS:0ã€‚</p></li><li><p>è¿™ä¸ªå†…å­˜åŒºçš„å‰256 ä¸ªå­—èŠ‚å­˜PSPï¼ŒDOSç”¨æ¥å’Œç¨‹åºè¿›è¡Œé€šä¿¡ã€‚</p></li><li><p>ä» 256å­—èŠ‚å¤„å‘åçš„ç©ºé—´å­˜æ”¾çš„æ˜¯ç¨‹åºï¼ŒCSçš„å€¼ä¸ºDS+100Hã€‚</p></li><li><p>ç¨‹åºåŠ è½½åï¼ŒCXä¸­å­˜æ”¾ä»£ç çš„é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ã€‚</p></li></ul><h4 id="3-3-2-ç”¨Debugå•æ­¥æ‰§è¡Œç¨‹åº"><a href="#3-3-2-ç”¨Debugå•æ­¥æ‰§è¡Œç¨‹åº" class="headerlink" title="3.3.2 ç”¨Debugå•æ­¥æ‰§è¡Œç¨‹åº"></a>3.3.2 ç”¨Debugå•æ­¥æ‰§è¡Œç¨‹åº</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233439215.png" alt="image-20231025233439215" style="zoom:80%;"><h4 id="3-3-3-å…¶ä»–è°ƒè¯•æŒ‡ä»¤"><a href="#3-3-3-å…¶ä»–è°ƒè¯•æŒ‡ä»¤" class="headerlink" title="3.3.3 å…¶ä»–è°ƒè¯•æŒ‡ä»¤"></a>3.3.3 å…¶ä»–è°ƒè¯•æŒ‡ä»¤</h4><p><strong>ç»§ç»­å‘½ä»¤P(Proceed)ï¼šç±»ä¼¼</strong>Tå‘½ä»¤ï¼Œé€æ¡æ‰§è¡ŒæŒ‡ä»¤ã€æ˜¾ç¤ºç»“æœã€‚ä½†é‡å­ç¨‹åºã€ä¸­æ–­ç­‰æ—¶ï¼Œç›´æ¥æ‰§è¡Œï¼Œç„¶åæ˜¾ç¤ºç»“æœã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233541049.png" alt="image-20231025233541049" style="zoom:67%;"><p><strong>è¿è¡Œå‘½ä»¤G(Go)ï¼š</strong>ä»æŒ‡å®šåœ°å€å¤„å¼€å§‹è¿è¡Œç¨‹åºï¼Œç›´åˆ°é‡åˆ°æ–­ç‚¹æˆ–è€…ç¨‹åºæ­£å¸¸ç»“æŸã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233613363.png" alt="image-20231025233613363" style="zoom: 67%;"><h3 id="3-4-â€¦-å’Œ-â€¦"><a href="#3-4-â€¦-å’Œ-â€¦" class="headerlink" title="3.4 [â€¦]å’Œ(â€¦)"></a>3.4 [â€¦]å’Œ(â€¦)</h3><h4 id="3-4-1-â€¦-çš„è§„å®šä¸-â€¦-çš„çº¦å®š"><a href="#3-4-1-â€¦-çš„è§„å®šä¸-â€¦-çš„çº¦å®š" class="headerlink" title="3.4.1 [â€¦]çš„è§„å®šä¸(â€¦)çš„çº¦å®š"></a>3.4.1 [â€¦]çš„è§„å®šä¸(â€¦)çš„çº¦å®š</h4><ul><li>[â€¦]â€”â€”(æ±‡ç¼–è¯­æ³•è§„å®š)è¡¨ç¤ºä¸€ä¸ªå†…å­˜å•å…ƒ</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233721670.png" alt="image-20231025233721670" style="zoom:67%;"><ul><li>(â€¦)â€”â€”(ä¸ºå­¦ä¹ æ–¹ä¾¿åšå‡ºçš„çº¦å®š)è¡¨ç¤ºä¸€ä¸ªå†…å­˜å•å…ƒæˆ–å¯„å­˜å™¨ä¸­çš„å†…å®¹</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231025233755039.png" alt="image-20231025233755039" style="zoom:80%;"><h4 id="3-4-2-ç¬¦å·idataè¡¨ç¤ºå¸¸é‡"><a href="#3-4-2-ç¬¦å·idataè¡¨ç¤ºå¸¸é‡" class="headerlink" title="3.4.2 ç¬¦å·idataè¡¨ç¤ºå¸¸é‡"></a>3.4.2 ç¬¦å·idataè¡¨ç¤ºå¸¸é‡</h4><ul><li>mov ax,[idata]ï¼šä»£è¡¨mov ax,[1]ã€mov ax,[2]ã€mov ax,[3]â€¦</li><li>mov bx,idataï¼šä»£è¡¨mov bx,1ã€mov bx,2ã€mov bx,3â€¦</li><li>mov ds,idataï¼šä»£è¡¨mov ds,1ã€mov ds,2â€¦(éƒ½æ˜¯éæ³•æŒ‡ä»¤)</li></ul><h4 id="3-4-3-æ¡ˆä¾‹åˆ†æ"><a href="#3-4-3-æ¡ˆä¾‹åˆ†æ" class="headerlink" title="3.4.3 æ¡ˆä¾‹åˆ†æ"></a>3.4.3 æ¡ˆä¾‹åˆ†æ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asm">mov ax,200H<br>mov ds,ax<br>mov bx,1000H<br>mov ax,[bx]<br>inc bx<br>inc bx<br>mov [bx],ax<br>inc bx<br>inc bx<br>mov [bx],ax<br>inc bx<br>mov [bx],al<br>inc bx<br>mov [bx],al<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/å¯„å­˜å™¨.gif" alt="image-20231025233755039" style="zoom:50%;"><h3 id="3-5-LoopæŒ‡ä»¤"><a href="#3-5-LoopæŒ‡ä»¤" class="headerlink" title="3.5 LoopæŒ‡ä»¤"></a>3.5 LoopæŒ‡ä»¤</h3><h4 id="3-5-1-loopæŒ‡ä»¤"><a href="#3-5-1-loopæŒ‡ä»¤" class="headerlink" title="3.5.1 loopæŒ‡ä»¤"></a>3.5.1 loopæŒ‡ä»¤</h4><p>åŠŸèƒ½ï¼šå®ç°å¾ªç¯ï¼ˆè®¡æ•°å‹å¾ªç¯ï¼‰</p><ul><li>CPUæ‰§è¡ŒloopæŒ‡ä»¤æ—¶è¦è¿›è¡Œçš„æ“ä½œ<ul><li>(cx)&#x3D;(cx)-1</li><li>åˆ¤æ–­cxä¸­çš„å€¼ï¼Œä¸ä¸ºé›¶è½¬è‡³æ ‡å·å¤„æ‰§è¡Œç¨‹åºï¼Œä¸ºé›¶åˆ™å‘ä¸‹æ‰§è¡Œ</li></ul></li></ul><p>è¦æ±‚ï¼š</p><ul><li>cx ä¸­è¦æå‰å­˜æ”¾å¾ªç¯æ¬¡æ•°ï¼Œå› ä¸º(cx)å½±å“ç€loopæŒ‡ä»¤çš„æ‰§è¡Œç»“æœ</li><li>è¦å®šä¹‰ä¸€ä¸ªæ ‡å·</li></ul><blockquote><p>å…¶å®å°±ç›¸å½“äºdo whileå¾ªç¯ã€æå‰ä¸€æ¬¡ï¼Œååˆ¤æ–­ç±»å‹ã€‘</p></blockquote><h4 id="3-5-2-æ¡ˆä¾‹åˆ†æ"><a href="#3-5-2-æ¡ˆä¾‹åˆ†æ" class="headerlink" title="3.5.2 æ¡ˆä¾‹åˆ†æ"></a>3.5.2 æ¡ˆä¾‹åˆ†æ</h4><ol><li>ç¼–ç¨‹è®¡ç®—2^12</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>code segment<br>mov ax,2<br>mov cx,11<br>  s:add ax,ax<br>  loop s<br>  <br>  mov ax,4c00h<br>  int 21h<br>code ends<br>end<br></code></pre></td></tr></table></figure><ol start="2"><li>è®¡ç®—123Ã—236ï¼Œç»“æœå­˜å‚¨åœ¨axä¸­</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>code segment<br>mov ax,0<br>mov cx,236<br>  s:add ax,123<br>  loop s<br>  <br>  mov ax,4c00h<br>  int 21h<br>code ends<br>end<br></code></pre></td></tr></table></figure><ol start="3"><li>è®¡ç®—ffff:0006<strong>å­—èŠ‚</strong>å•å…ƒä¸­çš„æ•°ä¹˜ä»¥3ï¼Œç»“æœå­˜å‚¨åœ¨dxä¸­</li></ol><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026230503145.png" alt="image-20231026230503145" style="zoom:67%;"><h3 id="3-6-æ®µå‰ç¼€çš„ä½¿ç”¨"><a href="#3-6-æ®µå‰ç¼€çš„ä½¿ç”¨" class="headerlink" title="3.6 æ®µå‰ç¼€çš„ä½¿ç”¨"></a>3.6 æ®µå‰ç¼€çš„ä½¿ç”¨</h3><h4 id="3-6-1-å¼•å…¥æ®µå‰ç¼€ï¼šä¸€ä¸ªâ€œå¼‚å¸¸â€ç°è±¡åŠå¯¹ç­–"><a href="#3-6-1-å¼•å…¥æ®µå‰ç¼€ï¼šä¸€ä¸ªâ€œå¼‚å¸¸â€ç°è±¡åŠå¯¹ç­–" class="headerlink" title="3.6.1 å¼•å…¥æ®µå‰ç¼€ï¼šä¸€ä¸ªâ€œå¼‚å¸¸â€ç°è±¡åŠå¯¹ç­–"></a>3.6.1 å¼•å…¥æ®µå‰ç¼€ï¼šä¸€ä¸ªâ€œå¼‚å¸¸â€ç°è±¡åŠå¯¹ç­–</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026230756028.png" alt="image-20231026230756028" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026230828068.png" alt="image-20231026230828068" style="zoom:67%;"><h4 id="3-6-2-è®¿é—®è¿ç»­çš„å†…å­˜å•å…ƒâ€”â€”loopå’Œ-bx-è”æ‰‹"><a href="#3-6-2-è®¿é—®è¿ç»­çš„å†…å­˜å•å…ƒâ€”â€”loopå’Œ-bx-è”æ‰‹" class="headerlink" title="3.6.2 è®¿é—®è¿ç»­çš„å†…å­˜å•å…ƒâ€”â€”loopå’Œ[bx]è”æ‰‹"></a>3.6.2 è®¿é—®è¿ç»­çš„å†…å­˜å•å…ƒâ€”â€”loopå’Œ[bx]è”æ‰‹</h4><p><strong>é—®é¢˜</strong>ï¼šè®¡ç®—ffff:0~ffff:bå­—èŠ‚å•å…ƒä¸­çš„æ•°æ®çš„å’Œï¼Œç»“æœå­˜å‚¨åœ¨dxä¸­</p><p><strong>åˆ†æï¼š</strong></p><ul><li>è¿ç®—åçš„ç»“æœæ˜¯å¦ä¼šè¶…å‡º dx æ‰€èƒ½å­˜å‚¨çš„èŒƒå›´ï¼Ÿ<ul><li>ffff:0ï½ffff:bå†…å­˜å•å…ƒä¸­çš„æ•°æ®æ˜¯å­—èŠ‚å‹æ•°æ®ï¼ŒèŒƒå›´åœ¨0ï½255ä¹‹é—´ï¼Œ12ä¸ªè¿™æ ·çš„æ•°æ®ç›¸åŠ ï¼Œç»“æœä¸ä¼šå¤§äº 65535ï¼Œå¯ä»¥åœ¨dxä¸­å­˜æ”¾ä¸‹ã€‚</li></ul></li><li>æ˜¯å¦å¯ä»¥å°† ffff:0ï½ffff:bä¸­çš„æ•°æ®ç›´æ¥ç´¯åŠ åˆ°dxä¸­ï¼Ÿ<ul><li>add dx, ds:[addr] ;(dx)&#x3D;(dx)+?</li><li>æœŸæœ›ï¼šå–å‡ºå†…å­˜ä¸­çš„8ä½æ•°æ®è¿›è¡Œç›¸åŠ </li><li>å®é™…ï¼šå–å‡ºçš„æ˜¯å†…å­˜ä¸­çš„16ä½æ•°æ®</li></ul></li><li>æ˜¯å¦å¯ä»¥å°† ffff:0ï½ffff:bä¸­çš„æ•°æ®ç›´æ¥ç´¯åŠ åˆ°dlä¸­ï¼Ÿ<ul><li>add dl, ds:[addr] ;(dl)&#x3D;(dl)+?</li><li>æœŸæœ›ï¼šå–å‡ºå†…å­˜ä¸­çš„8ä½æ•°æ®ç›¸åŠ </li><li>å®é™…ï¼šå–å‡ºçš„æ˜¯å†…å­˜ä¸­çš„8ä½æ•°æ®ï¼Œä½†å¾ˆæœ‰å¯èƒ½é€ æˆè¿›ä½ä¸¢å¤±ã€‚</li></ul></li><li>å¯¹ç­–ï¼šå–å‡º8ä½æ•°æ®ï¼ŒåŠ åˆ°16ä½çš„å¯„å­˜å™¨</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026231029785.png" alt="image-20231026231029785" style="zoom:80%;"><hr><p>é‚£ä¹ˆé—®é¢˜çš„è®¡ç®—ä¸ºï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026231104392.png" alt="image-20231026231104392" style="zoom:67%;"><h4 id="3-6-3-æ®µå‰ç¼€çš„ä½¿ç”¨"><a href="#3-6-3-æ®µå‰ç¼€çš„ä½¿ç”¨" class="headerlink" title="3.6.3 æ®µå‰ç¼€çš„ä½¿ç”¨"></a>3.6.3 æ®µå‰ç¼€çš„ä½¿ç”¨</h4><p><strong>é—®é¢˜ï¼š</strong>å°†å†…å­˜ffff:0~ffff:bä¸­çš„æ•°æ®æ‹·è´åˆ° 0:200~0:20bå•å…ƒä¸­</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026231317864.png" alt="image-20231026231317864" style="zoom:50%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026231334269.png" alt="image-20231026231334269" style="zoom: 80%;"><p><strong>ç–‘é—®1ï¼šä¸ºä»€ä¹ˆmov ax,0020hè¡¨ç¤ºå†…å­˜å•å…ƒ0:200</strong></p><blockquote><p>å› ä¸º20:0å’Œ0:200è¡¨ç¤ºçš„æ˜¯åŒä¸€ä¸ªç‰©ç†æ®µåœ°å€ï¼Œéƒ½æ˜¯512</p></blockquote><p><strong>ç–‘é—®2ï¼šdlçš„ä½œç”¨</strong></p><blockquote><p>å°†dlä½œä¸ºä¸­ä»‹ï¼Œå°†ffff:0å†…å­˜å•å…ƒä¸­çš„æ•°æ®æš‚å­˜dlï¼ŒåæœŸå°†å…¶æ‹·è´åˆ°0:200</p></blockquote><p><strong>ç–‘é—®3ï¼šåŸå§‹æ–¹æ¡ˆå“ªé‡Œæ•ˆç‡ä½ï¼Ÿ</strong></p><blockquote><p>å…¶éƒ½æ˜¯ç”¨å°†axä¸­çš„å€¼æ‹·è´åˆ°dsä¸­ï¼Œè¿™æ ·æ¯æ¬¡å¾ªç¯éƒ½æœ‰ä¸€æ¬¡å¤šä½™çš„å†…å­˜æ¬è¿</p><p>ä½¿ç”¨é™„åŠ æ®µå¯„å­˜å™¨ï¼Œå³dsä¸å˜ï¼Œä¸€ç›´è¡¨ç¤ºffff:0å¼€å§‹çš„å†…å­˜åœ°å€ï¼Œè€Œesè¡¨ç¤ºçš„æ˜¯0:200çš„åœ°å€</p></blockquote><h3 id="3-7-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ•°æ®"><a href="#3-7-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ•°æ®" class="headerlink" title="3.7 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ•°æ®"></a>3.7 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ•°æ®</h3><h4 id="3-7-1-é—®é¢˜ï¼šè¿™æ ·ä½œæ˜¯å±é™©çš„ï¼"><a href="#3-7-1-é—®é¢˜ï¼šè¿™æ ·ä½œæ˜¯å±é™©çš„ï¼" class="headerlink" title="3.7.1 é—®é¢˜ï¼šè¿™æ ·ä½œæ˜¯å±é™©çš„ï¼"></a>3.7.1 é—®é¢˜ï¼šè¿™æ ·ä½œæ˜¯å±é™©çš„ï¼</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026233116017.png" alt="image-20231026233116017" style="zoom:80%;"><h4 id="3-7-2-æœ‰é—®é¢˜çš„æ¡ˆä¾‹"><a href="#3-7-2-æœ‰é—®é¢˜çš„æ¡ˆä¾‹" class="headerlink" title="3.7.2 æœ‰é—®é¢˜çš„æ¡ˆä¾‹"></a>3.7.2 æœ‰é—®é¢˜çš„æ¡ˆä¾‹</h4><blockquote><p><strong>æ³¨æ„ï¼š</strong>æˆ‘ä»¬çŸ¥é“ä»£ç çš„æ¡†æ¶ä¸º</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231019233938706.png" alt="image-20231019233938706" style="zoom:50%;"><p>ç†è®ºä¸Šæ•°æ®æ®µå’Œä»£ç æ®µæ˜¯åˆ†å¼€çš„ï¼Œè¿™é‡Œåªæ˜¯åœ¨codesegä¸­ä½¿ç”¨dwå£°æ˜äº†æ•°æ®æ®µï¼›è¿™ä¹Ÿæ˜¯æœ¬å°èŠ‚ã€3.7 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ•°æ®ã€‘çš„ä½œç”¨ã€‚</p></blockquote><hr><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026233147770.png" alt="image-20231026233147770" style="zoom:80%;"><p>ä½†æ˜¯è¿™ä¸ªä»£ç å­˜åœ¨é—®é¢˜ï¼šä»£ç å¼€å§‹åœ°å€æ˜¯cs:0ï¼Œè€Œè¿™é‡Œæ˜¯æ•°æ®æ®µ</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026233240390.png" alt="image-20231026233240390" style="zoom:80%;"><h4 id="3-7-3-æ”¹è¿›ä»£ç "><a href="#3-7-3-æ”¹è¿›ä»£ç " class="headerlink" title="3.7.3 æ”¹è¿›ä»£ç "></a>3.7.3 æ”¹è¿›ä»£ç </h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026233536229.png" alt="image-20231026233536229" style="zoom:67%;"><p>æ­¤æ—¶ï¼Œä»£ç æ®µçœŸæ­£çš„å¼€å§‹åœ°å€æ˜¯0010ï¼ˆIP&#x3D;0010ï¼‰</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231026233635364.png" alt="image-20231026233635364" style="zoom:67%;"><h3 id="3-8-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆ"><a href="#3-8-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆ" class="headerlink" title="3.8 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆ"></a>3.8 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆ</h3><h4 id="3-8-1-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆï¼šä»¥æ•°æ®é€†åºå­˜æ”¾ä¸ºä¾‹"><a href="#3-8-1-åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆï¼šä»¥æ•°æ®é€†åºå­˜æ”¾ä¸ºä¾‹" class="headerlink" title="3.8.1 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆï¼šä»¥æ•°æ®é€†åºå­˜æ”¾ä¸ºä¾‹"></a>3.8.1 åœ¨ä»£ç æ®µä¸­ä½¿ç”¨æ ˆï¼šä»¥æ•°æ®é€†åºå­˜æ”¾ä¸ºä¾‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110230247901.png" alt="image-20231110230247901" style="zoom:67%;"><p>ç¨‹åºçš„æ€è·¯å¤§è‡´å¦‚ä¸‹ï¼š</p><ul><li>ç¨‹åºè¿è¡Œæ—¶ï¼Œå®šä¹‰çš„æ•°æ®å­˜æ”¾åœ¨cs:0~cs:Få•å…ƒä¸­ï¼Œå…±8ä¸ªå­—å•å…ƒã€‚</li><li>ä¾æ¬¡å°†è¿™8ä¸ªå­—å•å…ƒä¸­çš„æ•°æ®å…¥æ ˆï¼Œç„¶åå†ä¾æ¬¡å‡ºæ ˆåˆ°è¿™ 8 ä¸ªå­—å•å…ƒä¸­ï¼Œä»è€Œå®ç°æ•°æ®çš„é€†åºå­˜æ”¾ã€‚</li><li>æ ˆéœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œåœ¨ç¨‹åºä¸­é€šè¿‡å®šä¹‰â€œç©ºâ€æ•°æ®æ¥å–å¾—</li></ul><h4 id="3-8-2-æ•°æ®é€†åºå­˜æ”¾ç¨‹åº"><a href="#3-8-2-æ•°æ®é€†åºå­˜æ”¾ç¨‹åº" class="headerlink" title="3.8.2 æ•°æ®é€†åºå­˜æ”¾ç¨‹åº"></a>3.8.2 æ•°æ®é€†åºå­˜æ”¾ç¨‹åº</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110230402736.png" alt="image-20231110230402736" style="zoom:80%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>code segment<br>dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H<br>dw 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0<br><br>start: mov ax,cs<br>   mov ss,ax<br>   mov sp,30h<br>   mov bx,0<br>   mov cx,8<br>s: push cs:[bx]<br>   add bx,2<br>   loop s<br><br>   mov bx,0<br>   mov cx,8<br>s0:pop cs:[bx]<br>   add bx,2<br>   loop s0<br>   <br>   mov ax,4c00h<br>   int 21h<br><br>code ends<br>end start<br></code></pre></td></tr></table></figure><h3 id="3-9-å°†æ•°æ®ã€ä»£ç ã€æ ˆæ”¾å…¥ä¸åŒæ®µ"><a href="#3-9-å°†æ•°æ®ã€ä»£ç ã€æ ˆæ”¾å…¥ä¸åŒæ®µ" class="headerlink" title="3.9 å°†æ•°æ®ã€ä»£ç ã€æ ˆæ”¾å…¥ä¸åŒæ®µ"></a>3.9 å°†æ•°æ®ã€ä»£ç ã€æ ˆæ”¾å…¥ä¸åŒæ®µ</h3><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110230955692.png" alt="image-20231110230955692" style="zoom:80%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code,ds:data,ss:stack<br>data segment<br>dw 0123H,0456H,0789H,0abcH,0defH,0fedH,0cbaH,0987H<br>data ends<br>stack segment<br>dw 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0<br>stack ends<br><br>code segment<br>start: mov ax,stack<br>   mov ss,ax<br>   mov sp,20h<br>   mov ax,data<br>   mov ds,ax<br>   <br>   mov bx,0<br>   mov cx,8<br>s: push [bx]<br>   add bx,2<br>   loop s<br><br>   mov bx,0<br>   mov cx,8<br>s0:pop [bx]<br>   add bx,2<br>   loop s0<br>   <br>   mov ax,4c00h<br>   int 21h<br>  <br>code ends<br>end start<br></code></pre></td></tr></table></figure><h2 id="4-å¯„å­˜å™¨"><a href="#4-å¯„å­˜å™¨" class="headerlink" title="4.å¯„å­˜å™¨"></a>4.å¯„å­˜å™¨</h2><h3 id="4-1-å¤„ç†å­—ç¬¦é—®é¢˜"><a href="#4-1-å¤„ç†å­—ç¬¦é—®é¢˜" class="headerlink" title="4.1 å¤„ç†å­—ç¬¦é—®é¢˜"></a>4.1 å¤„ç†å­—ç¬¦é—®é¢˜</h3><p>æ±‡ç¼–ç¨‹åºä¸­ï¼Œç”¨ <strong>â€˜â€¦â€¦â€™</strong> çš„æ–¹å¼æŒ‡æ˜æ•°æ®æ˜¯ä»¥å­—ç¬¦çš„å½¢å¼ç»™å‡ºçš„ï¼Œç¼–è¯‘å™¨å°†æŠŠå®ƒä»¬è½¬åŒ–ä¸ºç›¸å¯¹åº”çš„ASCIIç ã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110233558883.png" alt="image-20231110233558883" style="zoom:80%;"><blockquote><p>è¿™é‡Œèµ·å§‹åœ¨è´ºè€å¸ˆçš„P23è®²è¿‡ï¼Œåœ¨ä»£ç æ®µå¼€å§‹çš„å‰256ä¸ªå­—èŠ‚(0x100)å­˜æ”¾äº†æ®µå‰ç¼€ç”¨æ¥å­˜æ”¾æ•°æ®ã€‚</p></blockquote><p>ğŸ†è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå¤§å°å†™è½¬æ¢çš„è§„å¾‹ï¼Œå­—ç¬¦çš„ASCIIç ç›¸å·®äº†0x20H</p><h4 id="4-1-1-å¤§å°å†™è½¬æ¢çš„é—®é¢˜"><a href="#4-1-1-å¤§å°å†™è½¬æ¢çš„é—®é¢˜" class="headerlink" title="4.1.1 å¤§å°å†™è½¬æ¢çš„é—®é¢˜"></a>4.1.1 å¤§å°å†™è½¬æ¢çš„é—®é¢˜</h4><p>é—®é¢˜ï¼šå¯¹datasegä¸­çš„å­—ç¬¦ä¸²</p><ul><li>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ï¼šå°å†™å­—æ¯è½¬æ¢ä¸ºå¤§å†™å­—æ¯<ul><li>è‹¥å­—æ¯æ˜¯å°å†™ï¼Œè½¬å¤§å†™ï¼›å¦‚æœ¬èº«æ˜¯å¤§å†™ï¼Œä¸å˜</li></ul></li><li>ç¬¬äºŒä¸ªå­—ç¬¦ä¸²ï¼šå¤§å†™å­—æ¯è½¬æ¢ä¸ºå°å†™å­—æ¯<ul><li>è‹¥å­—æ¯æ˜¯å¤§å†™ï¼Œè½¬å°å†™ï¼›è‹¥æœ¬èº«æ˜¯å°å†™ï¼Œä¸å˜</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110233913928.png" alt="image-20231110233913928" style="zoom:50%;"><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ°**ä¸è¿ç®— **å’Œ <strong>æˆ–è¿ç®—</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110234103528.png" alt="image-20231110234103528" style="zoom:80%;"><h4 id="4-1-2-ç¨‹åºï¼šè§£å†³å¤§å°å†™é—®é¢˜"><a href="#4-1-2-ç¨‹åºï¼šè§£å†³å¤§å°å†™é—®é¢˜" class="headerlink" title="4.1.2 ç¨‹åºï¼šè§£å†³å¤§å°å†™é—®é¢˜"></a>4.1.2 ç¨‹åºï¼šè§£å†³å¤§å°å†™é—®é¢˜</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110234134851.png" alt="image-20231110234134851" style="zoom: 60%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231110234159040.png" alt="image-20231110234159040" style="zoom:67%;"><h3 id="4-2-bx-idata-æ–¹å¼å¯»å€"><a href="#4-2-bx-idata-æ–¹å¼å¯»å€" class="headerlink" title="4.2 [bx+idata]æ–¹å¼å¯»å€"></a>4.2 [bx+idata]æ–¹å¼å¯»å€</h3><h4 id="4-2-1-bx-idata-çš„å«ä¹‰"><a href="#4-2-1-bx-idata-çš„å«ä¹‰" class="headerlink" title="4.2.1 [bx+idata]çš„å«ä¹‰"></a>4.2.1 [bx+idata]çš„å«ä¹‰</h4><ul><li>[bx+idata]è¡¨ç¤ºä¸€ä¸ªå†…å­˜å•å…ƒï¼Œå®ƒçš„åç§»åœ°å€ä¸º(bx)+idataï¼ˆbxä¸­çš„æ•°å€¼åŠ ä¸Šidataï¼‰ã€‚</li><li>mov ax,[bx+200] &#x2F; mov ax,[200+bx] çš„å«ä¹‰<ul><li>å°†ä¸€ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹é€å…¥ax</li><li>è¿™ä¸ªå†…å­˜å•å…ƒçš„é•¿åº¦ä¸º2å­—èŠ‚ï¼ˆå­—å•å…ƒï¼‰ï¼Œå­˜æ”¾ä¸€ä¸ªå­—</li><li>å†…å­˜å•å…ƒçš„æ®µåœ°å€åœ¨dsä¸­ï¼Œåç§»åœ°å€ä¸º200åŠ ä¸Šbxä¸­çš„å€¼</li><li>æ•°å­¦åŒ–çš„æè¿°ä¸ºï¼š(ax)&#x3D;((ds)*16+bx+200)</li></ul></li><li>æŒ‡ä»¤mov ax,[bx+200]çš„å…¶ä»–å†™æ³•<ul><li>mov ax,[200+bx]</li><li>mov ax,200[bx]</li><li>mov ax,[bx].200</li></ul></li></ul><h4 id="4-2-2-åº”ç”¨ï¼šç”¨-bx-idata-çš„æ–¹å¼è¿›è¡Œæ•°ç»„çš„å¤„ç†"><a href="#4-2-2-åº”ç”¨ï¼šç”¨-bx-idata-çš„æ–¹å¼è¿›è¡Œæ•°ç»„çš„å¤„ç†" class="headerlink" title="4.2.2 åº”ç”¨ï¼šç”¨[bx+idata]çš„æ–¹å¼è¿›è¡Œæ•°ç»„çš„å¤„ç†"></a>4.2.2 åº”ç”¨ï¼šç”¨[bx+idata]çš„æ–¹å¼è¿›è¡Œæ•°ç»„çš„å¤„ç†</h4><p><strong>é—®é¢˜ï¼š</strong>åœ¨codesgä¸­å¡«å†™ä»£ç ï¼Œå°†datasgä¸­å®šä¹‰çš„</p><ul><li>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè½¬åŒ–ä¸ºå¤§å†™</li><li>ç¬¬äºŒä¸ªå­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111214422664.png" alt="image-20231111214422664" style="zoom:67%;"><h4 id="4-2-3-åœ¨Debugä¸­æ‰§è¡Œ"><a href="#4-2-3-åœ¨Debugä¸­æ‰§è¡Œ" class="headerlink" title="4.2.3 åœ¨Debugä¸­æ‰§è¡Œ"></a>4.2.3 åœ¨Debugä¸­æ‰§è¡Œ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111214444899.png" alt="image-20231111214444899" style="zoom: 90%;"><h3 id="4-3-SIå’ŒDIå¯„å­˜å™¨"><a href="#4-3-SIå’ŒDIå¯„å­˜å™¨" class="headerlink" title="4.3 SIå’ŒDIå¯„å­˜å™¨"></a>4.3 SIå’ŒDIå¯„å­˜å™¨</h3><h4 id="4-3-1-CPUå†…éƒ¨çš„å¯„å­˜å™¨"><a href="#4-3-1-CPUå†…éƒ¨çš„å¯„å­˜å™¨" class="headerlink" title="4.3.1 CPUå†…éƒ¨çš„å¯„å­˜å™¨"></a>4.3.1 CPUå†…éƒ¨çš„å¯„å­˜å™¨</h4><p>8086 CPUæœ‰14ä¸ªå¯„å­˜å™¨ï¼š</p><ul><li>é€šç”¨å¯„å­˜å™¨ï¼šAXã€BXã€CXã€DX</li><li><strong>å˜å€å¯„å­˜å™¨ï¼šSIã€DI</strong></li><li>æŒ‡é’ˆå¯„å­˜å™¨ï¼šSPã€BP</li><li>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼š IP</li><li>æ®µå¯„å­˜å™¨ï¼šCSã€SSã€DSã€ES</li><li>æ ‡å¿—å¯„å­˜å™¨ï¼šPSW</li></ul><h4 id="4-3-2-SIå’ŒDIå¸¸æ‰§è¡Œä¸åœ°å€æœ‰å…³çš„æ“ä½œ"><a href="#4-3-2-SIå’ŒDIå¸¸æ‰§è¡Œä¸åœ°å€æœ‰å…³çš„æ“ä½œ" class="headerlink" title="4.3.2 SIå’ŒDIå¸¸æ‰§è¡Œä¸åœ°å€æœ‰å…³çš„æ“ä½œ"></a>4.3.2 SIå’ŒDIå¸¸æ‰§è¡Œä¸åœ°å€æœ‰å…³çš„æ“ä½œ</h4><p>SI å’Œ DI æ˜¯8086CPUä¸­å’ŒBXåŠŸèƒ½ç›¸è¿‘çš„å¯„å­˜å™¨</p><blockquote><p>åŒºåˆ«ï¼šSIå’ŒDIä¸èƒ½å¤Ÿåˆ†æˆä¸¤ä¸ª8 ä½å¯„å­˜å™¨æ¥ä½¿ç”¨ã€‚</p></blockquote><ul><li>BXï¼šé€šç”¨å¯„å­˜å™¨ï¼Œåœ¨è®¡ç®—å­˜å‚¨å™¨åœ°å€æ—¶ï¼Œå¸¸ä½œä¸ºåŸºå€å¯„å­˜å™¨ç”¨</li><li>SIï¼šsource indexï¼Œæºå˜å€å¯„å­˜å™¨</li><li>DIï¼šdestination indexï¼Œç›®æ ‡å˜å€å¯„å­˜å™¨</li></ul><h4 id="4-3-3-åº”ç”¨SIå’ŒDI"><a href="#4-3-3-åº”ç”¨SIå’ŒDI" class="headerlink" title="4.3.3 åº”ç”¨SIå’ŒDI"></a>4.3.3 åº”ç”¨SIå’ŒDI</h4><p><strong>é—®é¢˜ï¼š</strong>ç”¨å¯„å­˜å™¨SIå’ŒDIå®ç°å°†å­—ç¬¦ä¸²**â€™welcome to masm!â€™**å¤åˆ¶åˆ°å®ƒåé¢çš„æ•°æ®åŒºä¸­ã€‚</p><p>æ€è·¯ï¼š</p><ol><li>ç”¨ds:siæŒ‡å‘è¦å¤åˆ¶çš„åŸå§‹å­—ç¬¦ä¸²</li><li>ç”¨ds:diæŒ‡å‘ç›®çš„ç©ºé—´</li><li>ç„¶åç”¨ä¸€ä¸ªå¾ªç¯å®Œæˆå¤åˆ¶</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:codeseg,ds:dataseg<br>dataseg segement<br>db &#x27;Welcome to masm!&#x27;<br>db &#x27;................&#x27;<br>dataseg ends<br>codeseg segment<br>start:mov ax,dataseg<br>mov ds,ax<br><br>mov si,0<br>mov di,16<br>mov cx,8<br>s:mov ax,[si]<br>mov [di],ax<br>add si,2<br>add di,2<br>loop s<br><br>mov ax,4c00j<br>int 21h<br>codeseg ends<br>end start<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111215522599.png" alt="image-20231111215522599" style="zoom: 60%;"><h3 id="4-4-bx-si-å’Œ-bx-di-æ–¹å¼å¯»å€"><a href="#4-4-bx-si-å’Œ-bx-di-æ–¹å¼å¯»å€" class="headerlink" title="4.4 [bx+si] å’Œ [bx+di]æ–¹å¼å¯»å€"></a>4.4 [bx+si] å’Œ [bx+di]æ–¹å¼å¯»å€</h3><h4 id="4-4-1-bx-si-å’Œ-bx-di-æ–¹å¼æŒ‡å®šåœ°å€"><a href="#4-4-1-bx-si-å’Œ-bx-di-æ–¹å¼æŒ‡å®šåœ°å€" class="headerlink" title="4.4.1 [bx+si] å’Œ [bx+di]æ–¹å¼æŒ‡å®šåœ°å€"></a>4.4.1 [bx+si] å’Œ [bx+di]æ–¹å¼æŒ‡å®šåœ°å€</h4><ul><li><p>[bx+si]è¡¨ç¤ºä¸€ä¸ªå†…å­˜å•å…ƒï¼Œåç§»åœ°å€ä¸º(bx)+(si)ï¼ˆå³bxä¸­çš„æ•°å€¼åŠ ä¸Šsiä¸­çš„æ•°å€¼ï¼‰ã€‚</p></li><li><p>æŒ‡ä»¤mov ax,[bx+si]çš„å«ä¹‰ï¼š</p><ul><li>å°†ä¸€ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹é€å…¥ax</li><li>è¿™ä¸ªå†…å­˜å•å…ƒçš„é•¿åº¦ä¸º2å­—èŠ‚ï¼ˆå­—å•å…ƒï¼‰ï¼Œå­˜æ”¾ä¸€ä¸ªå­—</li><li>åç§»åœ°å€ä¸ºbxä¸­çš„æ•°å€¼åŠ ä¸Šsiä¸­çš„æ•°å€¼</li><li>æ®µåœ°å€åœ¨dsä¸­</li></ul></li><li><p>æŒ‡ä»¤mov ax,[bx+si]çš„æ•°å­¦åŒ–çš„æè¿°ï¼š(ax)&#x3D;( (ds)*16+(bx)+(si))</p></li><li><p>mov ax,[bx+si]çš„å…¶ä»–å†™æ³•ï¼šmov ax,[bx][si]</p></li></ul><h4 id="4-4-2-åº”ç”¨æ¡ˆä¾‹"><a href="#4-4-2-åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="4.4.2 åº”ç”¨æ¡ˆä¾‹"></a>4.4.2 åº”ç”¨æ¡ˆä¾‹</h4><p>å†…å­˜ä¸­æ•°æ®ï¼š2000:1000 BE 00 06 00 00 00 â€¦.</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111222346551.png" alt="image-20231111222346551" style="zoom: 40%;"><p>ç¨‹åºæ‰§è¡Œå®Œæˆä»¥åï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111222404831.png" alt="image-20231111222404831" style="zoom: 50%;"><h3 id="4-5-bx-si-idata-å’Œ-bx-di-idata"><a href="#4-5-bx-si-idata-å’Œ-bx-di-idata" class="headerlink" title="4.5 [bx+si+idata]å’Œ[bx+di+idata]"></a>4.5 [bx+si+idata]å’Œ[bx+di+idata]</h3><h4 id="4-5-1-bx-si-idata-å’Œ-bx-di-idata-æ–¹å¼æŒ‡å®šåœ°å€"><a href="#4-5-1-bx-si-idata-å’Œ-bx-di-idata-æ–¹å¼æŒ‡å®šåœ°å€" class="headerlink" title="4.5.1 [bx+si+idata]å’Œ[bx+di+idata]æ–¹å¼æŒ‡å®šåœ°å€"></a>4.5.1 [bx+si+idata]å’Œ[bx+di+idata]æ–¹å¼æŒ‡å®šåœ°å€</h4><ul><li><p>bx+si+idata]è¡¨ç¤ºä¸€ä¸ªå†…å­˜å•å…ƒï¼šåç§»åœ°å€ä¸º(bx)+(si)+idataï¼Œå³bxä¸­çš„æ•°å€¼åŠ ä¸Šsiä¸­çš„æ•°å€¼å†åŠ ä¸Šidata</p></li><li><p>æŒ‡ä»¤mov ax,[bx+si+idata]çš„å«ä¹‰</p><ul><li>å°†ä¸€ä¸ªå†…å­˜å•å…ƒçš„å†…å®¹é€å…¥ax</li><li>è¿™ä¸ªå†…å­˜å•å…ƒçš„é•¿åº¦ä¸º2å­—èŠ‚ï¼ˆå­—å•å…ƒï¼‰ï¼Œå­˜æ”¾ä¸€ä¸ªå­—</li><li>åç§»åœ°å€ä¸ºbxä¸­çš„æ•°å€¼åŠ ä¸Šsiä¸­çš„æ•°å€¼å†åŠ ä¸Šidataï¼Œæ®µåœ°å€åœ¨dsä¸­</li></ul></li><li><p>æ•°å­¦åŒ–çš„æè¿°ï¼š(ax)&#x3D;( (ds)*16+(bx)+(si)+idata)</p></li><li><p>æŒ‡ä»¤mov ax,[bx+si+idata]çš„å…¶ä»–å†™æ³•</p></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111222724356.png" alt="image-20231111222724356" style="zoom:80%;"><h4 id="4-5-2-åº”ç”¨æ¡ˆä¾‹"><a href="#4-5-2-åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="4.5.2 åº”ç”¨æ¡ˆä¾‹"></a>4.5.2 åº”ç”¨æ¡ˆä¾‹</h4><p>å†…å­˜ä¸­æ•°æ®ï¼š2000:1000 BE 00 06 00 00 00 â€¦.</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111222751863.png" alt="image-20231111222751863" style="zoom: 60%;"><p>ç¨‹åºå®Œæˆä»¥åï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111222821711.png" alt="image-20231111222821711" style="zoom: 50%;"><h3 id="4-6-ä¸åŒçš„å¯»å€æ–¹å¼çš„çµæ´»åº”ç”¨"><a href="#4-6-ä¸åŒçš„å¯»å€æ–¹å¼çš„çµæ´»åº”ç”¨" class="headerlink" title="4.6 ä¸åŒçš„å¯»å€æ–¹å¼çš„çµæ´»åº”ç”¨"></a>4.6 ä¸åŒçš„å¯»å€æ–¹å¼çš„çµæ´»åº”ç”¨</h3><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225708887.png" alt="image-20231111225708887" style="zoom:80%;"><h4 id="4-6-1-æ¡ˆä¾‹1ï¼šå¤´ä¸€ä¸ªå­—æ¯æ”¹ä¸ºå¤§å†™å­—æ¯"><a href="#4-6-1-æ¡ˆä¾‹1ï¼šå¤´ä¸€ä¸ªå­—æ¯æ”¹ä¸ºå¤§å†™å­—æ¯" class="headerlink" title="4.6.1 æ¡ˆä¾‹1ï¼šå¤´ä¸€ä¸ªå­—æ¯æ”¹ä¸ºå¤§å†™å­—æ¯"></a>4.6.1 æ¡ˆä¾‹1ï¼šå¤´ä¸€ä¸ªå­—æ¯æ”¹ä¸ºå¤§å†™å­—æ¯</h4><p><strong>é—®é¢˜ï¼š</strong>ç¼–ç¨‹å°†datasgæ®µä¸­æ¯ä¸ªå•è¯çš„å¤´ä¸€ä¸ªå­—æ¯æ”¹ä¸ºå¤§å†™å­—æ¯ã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225811584.png" alt="image-20231111225811584" style="zoom:80%;"><p>æ€è·¯ï¼šä½¿ç”¨[bx+data]çš„æ–¹å¼ï¼Œå› ä¸ºæ¯ä¸ªå•è¯çš„ç›¸å¯¹åœ°å€éƒ½æ˜¯å›ºå®šçš„ï¼Œåªæ˜¯åŸºå€ï¼ˆç¬¬ä¸€è¡Œã€ç¬¬äºŒè¡Œâ€¦ï¼‰éœ€è¦æ¢</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225829214.png" alt="image-20231111225829214" style="zoom:67%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asm">    mov ax,datasg<br>    mov ds,ax<br><br>    mov bx,0<br>    mov cx,6<br>s:  mov al,[bx+3]<br>and al,11011111b<br>mov [bx+3],al<br>add bx,16<br>loop s<br></code></pre></td></tr></table></figure><h4 id="4-6-2-æ¡ˆä¾‹2ï¼šåŒé‡å¾ªç¯å¤„ç†"><a href="#4-6-2-æ¡ˆä¾‹2ï¼šåŒé‡å¾ªç¯å¤„ç†" class="headerlink" title="4.6.2 æ¡ˆä¾‹2ï¼šåŒé‡å¾ªç¯å¤„ç†"></a>4.6.2 æ¡ˆä¾‹2ï¼šåŒé‡å¾ªç¯å¤„ç†</h4><p><strong>é—®é¢˜ï¼š</strong>ç¼–ç¨‹å°†datasgæ®µä¸­æ¯ä¸ªå•è¯æ”¹ä¸ºå¤§å†™å­—æ¯ã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230125070.png" alt="image-20231111230125070" style="zoom:67%;"><p><strong>é—®é¢˜æŠ½è±¡ï¼š</strong></p><ul><li>4ä¸ªå­—ç¬¦ä¸²ï¼Œçœ‹æˆä¸€ä¸ª4è¡Œ16åˆ—çš„äºŒç»´æ•°ç»„</li><li>è¦ä¿®æ”¹äºŒç»´æ•°æ®çš„æ¯ä¸€è¡Œçš„å‰3åˆ—</li><li>æ„é€ 4Ã—3çš„äºŒé‡æ•°ç»„</li></ul><p><strong>æ€è·¯ï¼š</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230234039.png" alt="image-20231111230234039" style="zoom:80%;"><p><strong>æ–¹æ¡ˆ0ï¼š</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230243711.png" alt="image-20231111230243711" style="zoom:67%;"><blockquote><p>å½“ç¬¬ä¸€ä¸ªå¾ªç¯å¤„ç†å®Œäº†ï¼Œæ­¤æ—¶cxä¸º0ï¼Œåˆ™å¤–å±‚å¾ªç¯ä¸ä¼šæ‰§è¡Œ</p></blockquote><p><strong>æ–¹æ³•1ï¼š</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230328737.png" alt="image-20231111230328737" style="zoom:50%;"><p><strong>æ–¹æ³•2ï¼š</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230350736.png" alt="image-20231111230350736" style="zoom: 50%;"><p>ğŸ† <strong>æ–¹æ³•3ï¼šï¼ˆæ¨èï¼‰</strong>ï¼Œå‰é¢çš„å…¶ä»–è§£æ³•éœ€è¦è®¾ç½®ä¸­é—´ä»‹è´¨å­˜å‚¨ï¼Œå½“å‡ºç°ä¸‰é‡å¾ªç¯å¯èƒ½ä¼šæœ‰é—®é¢˜</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111230422845.png" alt="image-20231111230422845" style="zoom: 50%;"><h3 id="4-7-ä¸åŒå¯»å€æ–¹å¼æ¼”ç¤º"><a href="#4-7-ä¸åŒå¯»å€æ–¹å¼æ¼”ç¤º" class="headerlink" title="4.7 ä¸åŒå¯»å€æ–¹å¼æ¼”ç¤º"></a>4.7 ä¸åŒå¯»å€æ–¹å¼æ¼”ç¤º</h3><h4 id="4-7-1-ç›´æ¥å¯»å€è¿‡ç¨‹"><a href="#4-7-1-ç›´æ¥å¯»å€è¿‡ç¨‹" class="headerlink" title="4.7.1 ç›´æ¥å¯»å€è¿‡ç¨‹"></a>4.7.1 ç›´æ¥å¯»å€è¿‡ç¨‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ç›´æ¥å¯»å€è¿‡ç¨‹.gif" alt="image-20231111222821711" style="zoom:50%;"><h4 id="4-7-2-ç®€æ¥å¯»å€è¿‡ç¨‹"><a href="#4-7-2-ç®€æ¥å¯»å€è¿‡ç¨‹" class="headerlink" title="4.7.2 ç®€æ¥å¯»å€è¿‡ç¨‹"></a>4.7.2 ç®€æ¥å¯»å€è¿‡ç¨‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/é—´æ¥å¯»å€è¿‡ç¨‹.gif" alt="image-20231111222821711" style="zoom:50%;"><h4 id="4-7-3-ç›¸å¯¹å¯»å€è¿‡ç¨‹"><a href="#4-7-3-ç›¸å¯¹å¯»å€è¿‡ç¨‹" class="headerlink" title="4.7.3 ç›¸å¯¹å¯»å€è¿‡ç¨‹"></a>4.7.3 ç›¸å¯¹å¯»å€è¿‡ç¨‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ç›¸å¯¹å¯»å€è¿‡ç¨‹.gif" alt="image-20231111222821711" style="zoom:50%;"><h4 id="4-7-4-åŸºå€å˜å€å¯»å€è¿‡ç¨‹"><a href="#4-7-4-åŸºå€å˜å€å¯»å€è¿‡ç¨‹" class="headerlink" title="4.7.4 åŸºå€å˜å€å¯»å€è¿‡ç¨‹"></a>4.7.4 åŸºå€å˜å€å¯»å€è¿‡ç¨‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/åŸºå€å˜å€å¯»å€è¿‡ç¨‹.gif" alt="image-20231111222821711" style="zoom:50%;"><h4 id="4-7-5-ç›¸å¯¹åŸºå€å˜å€å¯»å€è¿‡ç¨‹"><a href="#4-7-5-ç›¸å¯¹åŸºå€å˜å€å¯»å€è¿‡ç¨‹" class="headerlink" title="4.7.5 ç›¸å¯¹åŸºå€å˜å€å¯»å€è¿‡ç¨‹"></a>4.7.5 ç›¸å¯¹åŸºå€å˜å€å¯»å€è¿‡ç¨‹</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ç›¸å¯¹åŸºå€å˜å€å¯»å€è¿‡ç¨‹.gif" alt="image-20231111222821711" style="zoom:50%;"><blockquote><p>è¿™é‡Œæœ‰ä¸ªå°å°çš„é”™è¯¯ï¼Œåœ°å€åŠ æ³•å™¨ä¸­åº”è¯¥æ˜¯ ds*16 + bx + si + 1ï¼ŒåŠ¨ç”»ä¸­å°‘äº†åŠ 1ï¼Œä½†æœ€ç»ˆçš„è¦æ‰¾çš„å†…å­˜å•å…ƒæ˜¯å¯¹çš„</p></blockquote><h3 id="4-8-bpå¯„å­˜å™¨"><a href="#4-8-bpå¯„å­˜å™¨" class="headerlink" title="4.8 bpå¯„å­˜å™¨"></a>4.8 bpå¯„å­˜å™¨</h3><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111224722444.png" alt="image-20231111224722444" style="zoom:80%;"><blockquote><p>æ³¨æ„ï¼šbxé»˜è®¤çš„åŸºå€æ˜¯dsæ®µï¼Œbpé»˜è®¤æŒ‡ssæ®µ</p></blockquote><h3 id="4-9-æ•°ç»„åœ¨å“ªé‡Œï¼Œæœ‰å¤šé•¿ï¼Ÿ"><a href="#4-9-æ•°ç»„åœ¨å“ªé‡Œï¼Œæœ‰å¤šé•¿ï¼Ÿ" class="headerlink" title="4.9 æ•°ç»„åœ¨å“ªé‡Œï¼Œæœ‰å¤šé•¿ï¼Ÿ"></a>4.9 æ•°ç»„åœ¨å“ªé‡Œï¼Œæœ‰å¤šé•¿ï¼Ÿ</h3><h4 id="4-9-1-æ±‡ç¼–è¯­è¨€ä¸­æ•°æ®ä½ç½®çš„è¡¨è¾¾"><a href="#4-9-1-æ±‡ç¼–è¯­è¨€ä¸­æ•°æ®ä½ç½®çš„è¡¨è¾¾" class="headerlink" title="4.9.1 æ±‡ç¼–è¯­è¨€ä¸­æ•°æ®ä½ç½®çš„è¡¨è¾¾"></a>4.9.1 æ±‡ç¼–è¯­è¨€ä¸­æ•°æ®ä½ç½®çš„è¡¨è¾¾</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111224937285.png" alt="image-20231111224937285" style="zoom: 67%;"><h4 id="4-9-2-æŒ‡ä»¤è¦å¤„ç†çš„æ•°æ®æœ‰å¤šé•¿ï¼Ÿ"><a href="#4-9-2-æŒ‡ä»¤è¦å¤„ç†çš„æ•°æ®æœ‰å¤šé•¿ï¼Ÿ" class="headerlink" title="4.9.2 æŒ‡ä»¤è¦å¤„ç†çš„æ•°æ®æœ‰å¤šé•¿ï¼Ÿ"></a>4.9.2 æŒ‡ä»¤è¦å¤„ç†çš„æ•°æ®æœ‰å¤šé•¿ï¼Ÿ</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225006820.png" alt="image-20231111225006820" style="zoom: 67%;"><h3 id="4-10-å¯»å€æ–¹å¼çš„ç»¼åˆåº”ç”¨"><a href="#4-10-å¯»å€æ–¹å¼çš„ç»¼åˆåº”ç”¨" class="headerlink" title="4.10 å¯»å€æ–¹å¼çš„ç»¼åˆåº”ç”¨"></a>4.10 å¯»å€æ–¹å¼çš„ç»¼åˆåº”ç”¨</h3><h4 id="4-10-1-åº”ç”¨é—®é¢˜"><a href="#4-10-1-åº”ç”¨é—®é¢˜" class="headerlink" title="4.10.1 åº”ç”¨é—®é¢˜"></a>4.10.1 åº”ç”¨é—®é¢˜</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225123350.png" alt="image-20231111225123350" style="zoom:80%;"><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asm">mov ax,seg<br>mov ds,ax<br>mov bx,60h<br>mov word ptr [bx+0ch],11<br>mov word ptr [bx+0eh],13<br><br>mov si,0<br>mov byte ptr [bx+10h+si],&#x27;H&#x27;<br>inc si<br>mov byte ptr [bx+10h+si],&#x27;O&#x27;<br>inc si<br>mov byte ptr [bx+10h+si],&#x27;U&#x27;<br></code></pre></td></tr></table></figure><h4 id="4-10-2-Cè¯­è¨€å’Œæ±‡ç¼–çš„å¤„ç†æ–¹å¼å¯¹æ¯”"><a href="#4-10-2-Cè¯­è¨€å’Œæ±‡ç¼–çš„å¤„ç†æ–¹å¼å¯¹æ¯”" class="headerlink" title="4.10.2 Cè¯­è¨€å’Œæ±‡ç¼–çš„å¤„ç†æ–¹å¼å¯¹æ¯”"></a>4.10.2 Cè¯­è¨€å’Œæ±‡ç¼–çš„å¤„ç†æ–¹å¼å¯¹æ¯”</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231111225405800.png" alt="image-20231111225405800" style="zoom: 50%;"><h3 id="4-11-ç”¨divæŒ‡ä»¤å®ç°é™¤æ³•"><a href="#4-11-ç”¨divæŒ‡ä»¤å®ç°é™¤æ³•" class="headerlink" title="4.11 ç”¨divæŒ‡ä»¤å®ç°é™¤æ³•"></a>4.11 ç”¨divæŒ‡ä»¤å®ç°é™¤æ³•</h3><h4 id="4-11-1-divæŒ‡ä»¤"><a href="#4-11-1-divæŒ‡ä»¤" class="headerlink" title="4.11.1 divæŒ‡ä»¤"></a>4.11.1 divæŒ‡ä»¤</h4><p>divæ˜¯é™¤æ³•æŒ‡ä»¤ï¼Œä½¿ç”¨divä½œé™¤æ³•çš„æ—¶å€™</p><ul><li>è¢«é™¤æ•°ï¼šï¼ˆé»˜è®¤ï¼‰æ”¾åœ¨AXæˆ–DXå’ŒAXä¸­</li><li>é™¤æ•°ï¼š8ä½æˆ–16ä½ï¼Œåœ¨å¯„å­˜å™¨æˆ–å†…å­˜å•å…ƒä¸­</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112204734926.png" alt="image-20231112204734926" style="zoom:80%;"><blockquote><p>å¦‚æœé™¤æ•°æ˜¯8ä½å†…å­˜æˆ–å¯„å­˜å™¨ï¼Œåˆ™è¢«é™¤æ•°å¤„äºAXä¸­</p><p>å¦‚æœé™¤æ•°æ˜¯16ä½å†…å­˜æˆ–å¯„å­˜å™¨ï¼Œåˆ™è¢«é™¤æ•°ä½äºDXå’ŒAXä¸­</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112204842121.png" alt="image-20231112204842121" style="zoom:67%;"><h4 id="4-11-2-divæŒ‡ä»¤ç¤ºä¾‹"><a href="#4-11-2-divæŒ‡ä»¤ç¤ºä¾‹" class="headerlink" title="4.11.2 divæŒ‡ä»¤ç¤ºä¾‹"></a>4.11.2 divæŒ‡ä»¤ç¤ºä¾‹</h4><p>ç¼–ç¨‹ï¼šåˆ©ç”¨é™¤æ³•æŒ‡ä»¤è®¡ç®— 100001&#x2F;100</p><ul><li>100001D&#x3D;186A1H</li><li>éœ€è¦è¿›è¡Œ16ä½çš„é™¤æ³•</li><li>ç”¨dxå’Œaxä¸¤ä¸ªå¯„å­˜å™¨è”åˆå­˜æ”¾186A1H</li><li>ç”¨bxå­˜æ”¾é™¤æ•°100D&#x3D;64H</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112205034655.png" alt="image-20231112205034655" style="zoom: 50%;"><p>ç¼–ç¨‹ï¼šåˆ©ç”¨é™¤æ³•æŒ‡ä»¤è®¡ç®— 1001&#x2F;100</p><ul><li>è¿›è¡Œ8é™¤æ³•å³å¯</li><li>åœ¨axå¯„å­˜å™¨å­˜æ”¾è¢«é™¤æ•°3E9H</li><li>ç”¨bxå­˜æ”¾é™¤æ•°100D&#x3D;64H</li></ul><h4 id="4-11-3-åœ¨å†…å­˜å•å…ƒä¸­å®æ–½é™¤æ³•"><a href="#4-11-3-åœ¨å†…å­˜å•å…ƒä¸­å®æ–½é™¤æ³•" class="headerlink" title="4.11.3 åœ¨å†…å­˜å•å…ƒä¸­å®æ–½é™¤æ³•"></a>4.11.3 åœ¨å†…å­˜å•å…ƒä¸­å®æ–½é™¤æ³•</h4><ul><li>åŒå­—å‹æ•°æ®çš„å®šä¹‰(ä¾‹ç¤º)</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112205224931.png" alt="image-20231112205224931" style="zoom:60%;"><p>ä¾‹ï¼šç”¨div è®¡ç®—dataæ®µä¸­ç¬¬ä¸€ä¸ªæ•°æ®é™¤ä»¥ç¬¬äºŒä¸ªæ•°æ®åçš„ç»“æœï¼Œå•†å­˜æ”¾åœ¨ç¬¬3ä¸ªæ•°æ®çš„å­˜å‚¨å•å…ƒä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asm">data segment<br>dd 100001<br>dw 100<br>dw 0<br>data ends<br>code segment<br>mov ax,data<br>mov ds,ax<br>mov ax,ds:[0]<br>mov dx,ds:[2]<br>div word ptr ds:[4]<br>mov ds:[6],ax<br>code ends<br></code></pre></td></tr></table></figure><h3 id="4-12-ç”¨dupè®¾ç½®å†…å­˜ç©ºé—´"><a href="#4-12-ç”¨dupè®¾ç½®å†…å­˜ç©ºé—´" class="headerlink" title="4.12 ç”¨dupè®¾ç½®å†…å­˜ç©ºé—´"></a>4.12 ç”¨dupè®¾ç½®å†…å­˜ç©ºé—´</h3><h4 id="4-12-1-dupåŠŸèƒ½å’Œç”¨æ³•"><a href="#4-12-1-dupåŠŸèƒ½å’Œç”¨æ³•" class="headerlink" title="4.12.1 dupåŠŸèƒ½å’Œç”¨æ³•"></a>4.12.1 dupåŠŸèƒ½å’Œç”¨æ³•</h4><p>åŠŸèƒ½ï¼šdupå’Œdbã€dwã€dd ç­‰æ•°æ®å®šä¹‰ä¼ªæŒ‡ä»¤é…åˆä½¿ç”¨ï¼Œç”¨æ¥è¿›è¡Œæ•°æ®çš„é‡å¤ã€‚</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112205458273.png" alt="image-20231112205458273" style="zoom: 67%;"><p>dupçš„ä½¿ç”¨æ ¼å¼ï¼š</p><ul><li>dbé‡å¤çš„æ¬¡æ•°dupï¼ˆé‡å¤çš„å­—èŠ‚å‹æ•°æ®ï¼‰</li><li>dwé‡å¤çš„æ¬¡æ•°dupï¼ˆé‡å¤çš„å­—å‹æ•°æ®ï¼‰</li><li>ddé‡å¤çš„æ¬¡æ•°dupï¼ˆé‡å¤çš„åŒå­æ•°æ®ï¼‰</li></ul><h4 id="4-12-2-dupç”¨é€”"><a href="#4-12-2-dupç”¨é€”" class="headerlink" title="4.12.2 dupç”¨é€”"></a>4.12.2 dupç”¨é€”</h4><p>ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ª200å­—èŠ‚çš„æ ˆæ®µ</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112205624778.png" alt="image-20231112205624778" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231112205630893.png" alt="image-20231112205630893" style="zoom:67%;"><h2 id="5-æµç¨‹è½¬ç§»ä¸å­ç¨‹åº"><a href="#5-æµç¨‹è½¬ç§»ä¸å­ç¨‹åº" class="headerlink" title="5.æµç¨‹è½¬ç§»ä¸å­ç¨‹åº"></a>5.æµç¨‹è½¬ç§»ä¸å­ç¨‹åº</h2><h3 id="5-1-æ“ä½œç¬¦offset"><a href="#5-1-æ“ä½œç¬¦offset" class="headerlink" title="5.1 æ“ä½œç¬¦offset"></a>5.1 æ“ä½œç¬¦offset</h3><h4 id="5-1-1-ç”¨æ“ä½œç¬¦offsetå–å¾—æ ‡å·çš„åç§»åœ°å€"><a href="#5-1-1-ç”¨æ“ä½œç¬¦offsetå–å¾—æ ‡å·çš„åç§»åœ°å€" class="headerlink" title="5.1.1 ç”¨æ“ä½œç¬¦offsetå–å¾—æ ‡å·çš„åç§»åœ°å€"></a>5.1.1 ç”¨æ“ä½œç¬¦offsetå–å¾—æ ‡å·çš„åç§»åœ°å€</h4><p><strong>æ ¼å¼ï¼š</strong>offset æ ‡å·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:codeseg<br>codeseg segment<br>start:  mov ax,offset start   ; ç›¸å½“äºmov ax,0<br>    s:  mov ax,offset s       ; ç›¸å½“äºmov ax,3<br>codeseg ends<br>end start<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115225802336.png" alt="image-20231115225802336" style="zoom: 50%;"><h4 id="5-1-2-ç»ƒä¹ "><a href="#5-1-2-ç»ƒä¹ " class="headerlink" title="5.1.2 ç»ƒä¹ "></a>5.1.2 ç»ƒä¹ </h4><p><strong>é—®é¢˜ï¼š</strong>æœ‰å¦‚ä¸‹ç¨‹åºæ®µï¼Œæ·»å†™2æ¡æŒ‡ä»¤ï¼Œä½¿è¯¥ç¨‹åºåœ¨è¿è¡Œä¸­å°†så¤„çš„ä¸€æ¡æŒ‡ä»¤å¤åˆ¶åˆ°s0å¤„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:codesg<br>codesg segment<br>s:  mov ax,bx<br>    mov si,offset s<br>    mov di,offset s0<br>    mov ax,cs:[si]<br>    mov cs:[di],ax<br>s0: nop<br>nop<br>codeseg ends<br>ends  ;nopçš„æœºå™¨ç å ä¸€ä¸ªå­—èŠ‚ï¼Œèµ·â€œå ä½â€ä½œç”¨<br></code></pre></td></tr></table></figure><p><strong>åˆ†æï¼š</strong></p><ul><li>så’Œs0å¤„çš„æŒ‡ä»¤æ‰€åœ¨çš„å†…å­˜å•å…ƒçš„åœ°å€æ˜¯å¤šå°‘ï¼Ÿ<ul><li>cs:offset s å’Œcs:offset s0</li></ul></li><li>å°†så¤„çš„æŒ‡ä»¤å¤åˆ¶åˆ°s0å¤„ï¼Œå°±æ˜¯________<ul><li>å°±æ˜¯å°†cs:offset s å¤„çš„æ•°æ®å¤åˆ¶åˆ°cs:offset s0å¤„</li></ul></li><li>åœ°å€å¦‚ä½•è¡¨ç¤ºï¼Ÿ<ul><li>æ®µåœ°å€å·²çŸ¥åœ¨csä¸­ï¼Œåç§»åœ°å€å·²ç»é€å…¥siå’Œdiä¸­</li></ul></li><li>è¦å¤åˆ¶çš„æ•°æ®æœ‰å¤šé•¿ï¼Ÿ<ul><li>mov ax,bxæŒ‡ä»¤çš„é•¿åº¦ä¸ºä¸¤ä¸ªå­—èŠ‚ï¼Œå³1ä¸ªå­—ã€‚</li></ul></li></ul><h3 id="5-2-jmpæŒ‡ä»¤"><a href="#5-2-jmpæŒ‡ä»¤" class="headerlink" title="5.2 jmpæŒ‡ä»¤"></a>5.2 jmpæŒ‡ä»¤</h3><h4 id="5-2-1-jmpæŒ‡ä»¤â€”â€”æ— æ¡ä»¶è½¬ç§»"><a href="#5-2-1-jmpæŒ‡ä»¤â€”â€”æ— æ¡ä»¶è½¬ç§»" class="headerlink" title="5.2.1 jmpæŒ‡ä»¤â€”â€”æ— æ¡ä»¶è½¬ç§»"></a>5.2.1 jmpæŒ‡ä»¤â€”â€”æ— æ¡ä»¶è½¬ç§»</h4><p><strong>jmpæŒ‡ä»¤çš„åŠŸèƒ½ï¼š</strong>æ— æ¡ä»¶è½¬ç§»ï¼Œå¯ä»¥åªä¿®æ”¹IPï¼Œä¹Ÿå¯ä»¥åŒæ—¶ä¿®æ”¹CSå’ŒIP</p><p>jmpæŒ‡ä»¤è¦ç»™å‡ºä¸¤ç§ä¿¡æ¯ï¼š</p><ul><li>è½¬ç§»çš„ç›®çš„åœ°å€</li><li>è½¬ç§»çš„è·ç¦»<ul><li>æ®µé—´è½¬ç§»ï¼ˆè¿œè½¬ç§»ï¼‰ï¼š jmp 2000:1000</li><li>æ®µå†…çŸ­è½¬ç§»ï¼š jmp short æ ‡å· ; IPçš„ä¿®æ”¹èŒƒå›´ä¸º -128~127ï¼Œ8ä½çš„ä½ç§»</li><li>æ®µå†…è¿‘è½¬ç§»ï¼š jmp near ptr æ ‡å· ; IPçš„ä¿®æ”¹èŒƒå›´ä¸º -32768~32767ï¼Œ16ä½çš„ä½ç§»</li></ul></li></ul><h4 id="5-2-2-jmpæŒ‡ä»¤ï¼šä¾æ®ä½ç§»è¿›è¡Œè½¬ç§»"><a href="#5-2-2-jmpæŒ‡ä»¤ï¼šä¾æ®ä½ç§»è¿›è¡Œè½¬ç§»" class="headerlink" title="5.2.2 jmpæŒ‡ä»¤ï¼šä¾æ®ä½ç§»è¿›è¡Œè½¬ç§»"></a>5.2.2 jmpæŒ‡ä»¤ï¼šä¾æ®ä½ç§»è¿›è¡Œè½¬ç§»</h4><p><strong>å¼•å­ï¼š</strong>å¸¸è§æŒ‡ä»¤ä¸­çš„ç«‹å³æ•°å‡åœ¨æœºå™¨æŒ‡ä»¤ä¸­æœ‰ä½“ç°</p><p><strong>é—®é¢˜ï¼š</strong>jmp short æŒ‡ä»¤ä¸­ï¼Œè½¬ç§»åˆ°äº†å“ªé‡Œï¼Ÿ</p><blockquote><p>jmp short çš„æœºå™¨æŒ‡ä»¤ä¸­ï¼ŒåŒ…å«çš„æ˜¯è·³è½¬åˆ°æŒ‡ä»¤çš„ç›¸å¯¹ä½ç½®ï¼Œè€Œä¸æ˜¯è½¬ç§»çš„ç›®æ ‡åœ°å€ã€‚</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230436427.png" alt="image-20231115230436427" style="zoom:50%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230444733.png" alt="image-20231115230444733" style="zoom:50%;"><p>ç¬¬ä¸€ä¸ªç¨‹åºjmp short sæŒ‡ä»¤çš„è¯»å–å’Œæ‰§è¡Œï¼š</p><p>ï¼ˆ1ï¼‰(IP)&#x3D;0003ï¼ŒCS:IPæŒ‡å‘EB 05(jmp çš„æœºå™¨ç )</p><p>ï¼ˆ2ï¼‰è¯»å–æŒ‡ä»¤ç EB 05è¿›å…¥æŒ‡ä»¤ç¼“å†²å™¨ï¼›</p><p>ï¼ˆ3ï¼‰(IP)&#x3D;(IP)+æ‰€è¯»å–æŒ‡ä»¤çš„é•¿åº¦&#x3D;(IP)+2&#x3D;0005ï¼ŒCS:IPæŒ‡å‘add ax, 0001ï¼›</p><p>ï¼ˆ4ï¼‰CPUæ‰§è¡ŒæŒ‡ä»¤ç¼“å†²å™¨ä¸­çš„æŒ‡ä»¤EB05ï¼›</p><p>ï¼ˆ5ï¼‰æŒ‡ä»¤EB <strong>05</strong>æ‰§è¡Œåï¼Œ(IP)&#x3D;(IP)+<strong>05</strong>&#x3D;000AHï¼ŒCS:IPæŒ‡å‘inc ax</p><h4 id="5-2-3-ä¸¤ç§æ®µå†…è½¬ç§»"><a href="#5-2-3-ä¸¤ç§æ®µå†…è½¬ç§»" class="headerlink" title="5.2.3 ä¸¤ç§æ®µå†…è½¬ç§»"></a>5.2.3 ä¸¤ç§æ®µå†…è½¬ç§»</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230820219.png" alt="image-20231115230820219" style="zoom:50%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230831757.png" alt="image-20231115230831757" style="zoom: 50%;"><h4 id="5-2-4-è¿œè½¬ç§»ï¼šjmp-far-ptr-æ ‡å·"><a href="#5-2-4-è¿œè½¬ç§»ï¼šjmp-far-ptr-æ ‡å·" class="headerlink" title="5.2.4 è¿œè½¬ç§»ï¼šjmp far ptr æ ‡å·"></a>5.2.4 è¿œè½¬ç§»ï¼šjmp far ptr æ ‡å·</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230909267.png" alt="image-20231115230909267" style="zoom:80%;"><h4 id="5-2-5-è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„jmpæŒ‡ä»¤"><a href="#5-2-5-è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„jmpæŒ‡ä»¤" class="headerlink" title="5.2.5 è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„jmpæŒ‡ä»¤"></a>5.2.5 è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„jmpæŒ‡ä»¤</h4><p>æŒ‡ä»¤æ ¼å¼ï¼šjmp 16ä½å¯„å­˜å™¨</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115230953946.png" alt="image-20231115230953946" style="zoom:67%;"><h4 id="5-2-6-è½¬ç§»åœ°å€åœ¨å†…å­˜ä¸­çš„jmpæŒ‡ä»¤"><a href="#5-2-6-è½¬ç§»åœ°å€åœ¨å†…å­˜ä¸­çš„jmpæŒ‡ä»¤" class="headerlink" title="5.2.6 è½¬ç§»åœ°å€åœ¨å†…å­˜ä¸­çš„jmpæŒ‡ä»¤"></a>5.2.6 è½¬ç§»åœ°å€åœ¨å†…å­˜ä¸­çš„jmpæŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115231012570.png" alt="image-20231115231012570" style="zoom:67%;"><h4 id="5-2-7-jmpæŒ‡ä»¤å°ç»“"><a href="#5-2-7-jmpæŒ‡ä»¤å°ç»“" class="headerlink" title="5.2.7 jmpæŒ‡ä»¤å°ç»“"></a>5.2.7 jmpæŒ‡ä»¤å°ç»“</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231115231033431.png" alt="image-20231115231033431" style="zoom:67%;"><h3 id="5-3-callæŒ‡ä»¤å’ŒretæŒ‡ä»¤"><a href="#5-3-callæŒ‡ä»¤å’ŒretæŒ‡ä»¤" class="headerlink" title="5.3 callæŒ‡ä»¤å’ŒretæŒ‡ä»¤"></a>5.3 callæŒ‡ä»¤å’ŒretæŒ‡ä»¤</h3><h4 id="5-3-1-callæŒ‡ä»¤"><a href="#5-3-1-callæŒ‡ä»¤" class="headerlink" title="5.3.1 callæŒ‡ä»¤"></a>5.3.1 callæŒ‡ä»¤</h4><p>å­—é¢æ„æ€ï¼šè°ƒç”¨å­ç¨‹åº</p><p>å®è´¨ï¼šæµç¨‹è½¬ç§»ï¼ˆcallæŒ‡ä»¤å®ç°è½¬ç§»çš„æ–¹æ³•å’Œ jmp æŒ‡ä»¤çš„åŸç†ç›¸ä¼¼ï¼‰</p><p>æ ¼å¼ï¼šcall æ ‡å·</p><p><strong>CPUæ‰§è¡ŒcallæŒ‡ä»¤ï¼Œè¿›è¡Œä¸¤æ­¥æ“ä½œï¼š</strong></p><ul><li>å°†å½“å‰çš„IP æˆ– CSå’ŒIP å‹å…¥æ ˆä¸­</li><li>è½¬ç§»åˆ°æ ‡å·å¤„æ‰§è¡ŒæŒ‡ä»¤</li></ul><p><strong>callæ ‡å·ï¼š</strong></p><ul><li>16ä½ä½ç§»&#x3D; â€œæ ‡å·â€å¤„çš„åœ°å€ï¼callæŒ‡ä»¤åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼›</li><li>16ä½ä½ç§»çš„èŒƒå›´ä¸º -32768~32767ï¼Œç”¨è¡¥ç è¡¨ç¤ºï¼›</li><li>16ä½ä½ç§»ç”±ç¼–è¯‘ç¨‹åºåœ¨ç¼–è¯‘æ—¶ç®—å‡ºã€‚</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232508424.png" alt="image-20231121232508424" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232516058.png" alt="image-20231121232516058" style="zoom:80%;"><h4 id="5-3-2-æŒ‡ä»¤â€call-far-ptræ ‡å·â€å®ç°çš„æ˜¯æ®µé—´è½¬ç§»"><a href="#5-3-2-æŒ‡ä»¤â€call-far-ptræ ‡å·â€å®ç°çš„æ˜¯æ®µé—´è½¬ç§»" class="headerlink" title="5.3.2 æŒ‡ä»¤â€call far ptræ ‡å·â€å®ç°çš„æ˜¯æ®µé—´è½¬ç§»"></a>5.3.2 æŒ‡ä»¤â€call far ptræ ‡å·â€å®ç°çš„æ˜¯æ®µé—´è½¬ç§»</h4><p>CPUæ‰§è¡Œâ€œ call far ptr æ ‡å·â€æ—¶çš„æ“ä½œ</p><blockquote><p>(sp) &#x3D; (sp) â€“ 2</p><p>((ss) Ã—16+(sp)) &#x3D; (CS)</p><p>(sp) &#x3D; (sp) â€“ 2</p><p>((ss) Ã—16+(sp)) &#x3D; (IP)</p><ul><li>(CS) &#x3D; æ ‡å·æ‰€åœ¨çš„æ®µåœ°å€</li><li>(IP) &#x3D; æ ‡å·æ‰€åœ¨çš„åç§»åœ°å€</li></ul></blockquote><p>â€œ call far ptr æ ‡å·â€ ç›¸å½“äº</p><blockquote><p>push CS</p><p>push IP</p><p>jmp far ptr æ ‡å·</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232759181.png" alt="image-20231121232759181" style="zoom: 50%;"><h4 id="5-3-3-è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„callæŒ‡ä»¤"><a href="#5-3-3-è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„callæŒ‡ä»¤" class="headerlink" title="5.3.3 è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„callæŒ‡ä»¤"></a>5.3.3 è½¬ç§»åœ°å€åœ¨å¯„å­˜å™¨ä¸­çš„callæŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232833839.png" alt="image-20231121232833839" style="zoom:80%;"><h4 id="5-3-4-è½¬ç§»æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„callæŒ‡ä»¤"><a href="#5-3-4-è½¬ç§»æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„callæŒ‡ä»¤" class="headerlink" title="5.3.4 è½¬ç§»æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„callæŒ‡ä»¤"></a>5.3.4 è½¬ç§»æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„callæŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232900240.png" alt="image-20231121232900240" style="zoom: 67%;"><h4 id="5-3-5-è¿”å›æŒ‡ä»¤ï¼šretå’Œretf"><a href="#5-3-5-è¿”å›æŒ‡ä»¤ï¼šretå’Œretf" class="headerlink" title="5.3.5 è¿”å›æŒ‡ä»¤ï¼šretå’Œretf"></a>5.3.5 è¿”å›æŒ‡ä»¤ï¼šretå’Œretf</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121232939435.png" alt="image-20231121232939435" style="zoom:67%;"><h3 id="5-4-callå’Œretçš„é…åˆä½¿ç”¨"><a href="#5-4-callå’Œretçš„é…åˆä½¿ç”¨" class="headerlink" title="5.4 callå’Œretçš„é…åˆä½¿ç”¨"></a>5.4 callå’Œretçš„é…åˆä½¿ç”¨</h3><h4 id="5-4-1-å…·æœ‰å­ç¨‹åºçš„æºç¨‹åºçš„æ¡†æ¶"><a href="#5-4-1-å…·æœ‰å­ç¨‹åºçš„æºç¨‹åºçš„æ¡†æ¶" class="headerlink" title="5.4.1 å…·æœ‰å­ç¨‹åºçš„æºç¨‹åºçš„æ¡†æ¶"></a>5.4.1 å…·æœ‰å­ç¨‹åºçš„æºç¨‹åºçš„æ¡†æ¶</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121233111259.png" alt="image-20231121233111259" style="zoom:67%;"><h4 id="5-4-2-callå’Œretçš„é…åˆä½¿ç”¨"><a href="#5-4-2-callå’Œretçš„é…åˆä½¿ç”¨" class="headerlink" title="5.4.2 callå’Œretçš„é…åˆä½¿ç”¨"></a>5.4.2 callå’Œretçš„é…åˆä½¿ç”¨</h4><p>ä¾‹ï¼šè®¡ç®—2çš„Næ¬¡æ–¹ï¼Œè®¡ç®—å‰ï¼ŒNçš„å€¼ç”±CXæä¾›</p><blockquote><p>æç¤ºï¼šè¿™ä¸ªç¨‹åºæ²¡æœ‰æ ˆæ®µï¼Œæ˜¯æ¯”è¾ƒå±é™©çš„</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>code segment<br>start: mov ax,1<br>   mov cx,3<br>   call s<br>   mov bx,ax<br>   mov ax,4c00h<br>   int 21h<br>s: add ax,ax<br>   loop s<br>   ret<br>code ends<br>end start<br></code></pre></td></tr></table></figure><p>debugç»“æœï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121233449096.png" alt="image-20231121233449096" style="zoom:67%;"><p>å•æ­¥è°ƒè¯•ç»“æœï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121233515697.png" alt="image-20231121233515697" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121233532438.png" alt="image-20231121233532438" style="zoom:67%;"><h4 id="5-4-3-ä¸ºcallå’ŒretæŒ‡ä»¤è®¾ç½®æ ˆ"><a href="#5-4-3-ä¸ºcallå’ŒretæŒ‡ä»¤è®¾ç½®æ ˆ" class="headerlink" title="5.4.3 ä¸ºcallå’ŒretæŒ‡ä»¤è®¾ç½®æ ˆ"></a>5.4.3 ä¸ºcallå’ŒretæŒ‡ä»¤è®¾ç½®æ ˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code, ss:stack<br>stack segment<br>   db 8 dup(0)<br>   db 8 dup(0)<br>stack ends<br>code segment<br>start: mov ax,1<br>   mov cx,3<br>   call s<br>   mov bx,ax<br>   mov ax,4c00h<br>   int 21h<br>s: add ax,ax<br>   loop s<br>   ret<br>code ends<br>end start<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231121233751028.png" alt="image-20231121233751028" style="zoom: 67%;"><h3 id="5-5-mulæŒ‡ä»¤"><a href="#5-5-mulæŒ‡ä»¤" class="headerlink" title="5.5 mulæŒ‡ä»¤"></a>5.5 mulæŒ‡ä»¤</h3><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303183904011.png" alt="image-20240303183904011" style="zoom: 67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303183919422.png" alt="image-20240303183919422" style="zoom:67%;"><h3 id="5-6-æ±‡ç¼–è¯­è¨€çš„æ¨¡å—åŒ–ç¨‹åºè®¾è®¡"><a href="#5-6-æ±‡ç¼–è¯­è¨€çš„æ¨¡å—åŒ–ç¨‹åºè®¾è®¡" class="headerlink" title="5.6 æ±‡ç¼–è¯­è¨€çš„æ¨¡å—åŒ–ç¨‹åºè®¾è®¡"></a>5.6 æ±‡ç¼–è¯­è¨€çš„æ¨¡å—åŒ–ç¨‹åºè®¾è®¡</h3><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303184058864.png" alt="image-20240303184058864" style="zoom:80%;"><p>æ¨¡å—åŒ–è°ƒç”¨è·¯å¾„ï¼šmain -&gt; sub1 -&gt; sub2</p><blockquote><p>è°ƒç”¨å­ç¨‹åºï¼šcallæŒ‡ä»¤</p><p>è¿”å›ï¼šretæŒ‡ä»¤</p><p>å­ç¨‹åºï¼šæ ¹æ®æä¾›çš„å‚æ•°å¤„ç†ä¸€å®šçš„äº‹åŠ¡ï¼Œå¤„ç†åï¼Œå°†ç»“æœï¼ˆè¿”å›å€¼ï¼‰æä¾›ç»™è°ƒç”¨è€…</p></blockquote><h4 id="5-6-1-å‚æ•°å’Œç»“æœçš„ä¼ é€’çš„é—®é¢˜"><a href="#5-6-1-å‚æ•°å’Œç»“æœçš„ä¼ é€’çš„é—®é¢˜" class="headerlink" title="5.6.1 å‚æ•°å’Œç»“æœçš„ä¼ é€’çš„é—®é¢˜"></a>5.6.1 å‚æ•°å’Œç»“æœçš„ä¼ é€’çš„é—®é¢˜</h4><p>é—®é¢˜ï¼šæ ¹æ®æä¾›çš„Nï¼Œè®¡ç®—Nçš„3æ¬¡æ–¹</p><p>è€ƒè™‘ï¼šï¼ˆ1ï¼‰æˆ‘ä»¬å°†å‚æ•°Nå­˜å‚¨åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿï¼ˆ2ï¼‰è®¡ç®—å¾—åˆ°çš„æ•°å€¼ï¼Œå­˜å‚¨åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</p><p>æ–¹æ¡ˆï¼šï¼ˆ1ï¼‰ç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼ˆ2ï¼‰ç”¨å†…å­˜å•å…ƒè¿›è¡Œå‚æ•°ä¼ é€’ï¼ˆ3ï¼‰ç”¨æ ˆä¼ é€’å‚æ•°</p><p>Cè¯­è¨€çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">cube</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span><br>&#123;<br>    <span class="hljs-type">int</span> f;<br>    f = x * x;<br>    f = f * x;<br>    <span class="hljs-keyword">return</span> f;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, cube(<span class="hljs-number">2</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-6-2-ç”¨å¯„å­˜å™¨æ¥å­˜å‚¨å‚æ•°å’Œç»“æœæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•"><a href="#5-6-2-ç”¨å¯„å­˜å™¨æ¥å­˜å‚¨å‚æ•°å’Œç»“æœæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•" class="headerlink" title="5.6.2 ç”¨å¯„å­˜å™¨æ¥å­˜å‚¨å‚æ•°å’Œç»“æœæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•"></a>5.6.2 ç”¨å¯„å­˜å™¨æ¥å­˜å‚¨å‚æ•°å’Œç»“æœæ˜¯æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•</h4><p>ç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼š</p><ul><li>å‚æ•°æ”¾åˆ°bxä¸­ï¼Œå³(bx)&#x3D;x</li><li>å­ç¨‹åºä¸­ç”¨åˆ°å¤šä¸ªmulæŒ‡ä»¤è®¡ç®—N^3</li><li>å°†ç»“æœæ”¾åˆ°dxå’Œaxä¸­ï¼š(dx:ax)&#x3D;N^3</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>data segment<br>dw 1,2,3,4,5,6,7,8<br>dd 0,0,0,0,0,0,0,0<br>data ends<br>code segment<br>start: mov ax,data<br>mov ds,ax<br>mov si,0<br>mov di,16<br>mov cx,8<br>s:  mov bx,[si]<br>call cube<br>mov [di],ax<br>mov [di].2,ax<br>add si,2<br>add di,4<br>loop s<br><br>mov ax,4c00h<br>int 21h<br><br> cube:  mov ax,bx<br>mul bx<br>mul bx<br>ret<br>code ends<br>end start<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303185212685.png" alt="image-20240303185212685" style="zoom: 67%;"><h4 id="5-6-3-ç”¨å†…å­˜å•å…ƒæ‰¹é‡ä¼ é€’æ•°æ®"><a href="#5-6-3-ç”¨å†…å­˜å•å…ƒæ‰¹é‡ä¼ é€’æ•°æ®" class="headerlink" title="5.6.3 ç”¨å†…å­˜å•å…ƒæ‰¹é‡ä¼ é€’æ•°æ®"></a>5.6.3 ç”¨å†…å­˜å•å…ƒæ‰¹é‡ä¼ é€’æ•°æ®</h4><p>æ–¹æ¡ˆï¼š</p><ul><li>å°†æ•°æ®æ”¾åˆ°å†…å­˜ä¸­ï¼Œç„¶åå°†å®ƒä»¬æ”¾åˆ°å†…å­˜ç©ºé—´çš„é¦–åœ°å€æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¼ é€’ç»™éœ€è¦çš„å­ç¨‹åº</li><li>å¯¹äºå…·æœ‰æ‰¹é‡æ•°æ®çš„è¿”å›ç»“æœï¼Œä¹Ÿå¯ç”¨åŒæ ·çš„æ–¹æ³•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:cdoe<br>data segment<br>db &#x27;conversation&#x27;<br>data ends<br>code segment<br>start:   mov ax,data<br>  mov ds,ax<br>  mov si,0<br>  mov cx,12<br>  call capital<br>  mov ax,4c00h<br>  int 21h<br>capital:  and bypte ptr [si],11011111b<br>  inc si<br>  loop capital<br>  ret<br><br>code ends<br>end start<br></code></pre></td></tr></table></figure><p>å°†æ‰€æœ‰çš„å°å†™å­—æ¯æ”¹æˆå¤§å†™å­—æ¯åç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303185939593.png" alt="image-20240303185939593" style="zoom:67%;"><h4 id="5-6-4-ç”¨æ ˆä¼ é€’å‚æ•°"><a href="#5-6-4-ç”¨æ ˆä¼ é€’å‚æ•°" class="headerlink" title="5.6.4 ç”¨æ ˆä¼ é€’å‚æ•°"></a>5.6.4 ç”¨æ ˆä¼ é€’å‚æ•°</h4><p>åŸç†ï¼šç”±è°ƒç”¨è€…å°†éœ€è¦ä¼ é€’ç»™å­ç¨‹åºçš„å‚æ•°å‹å…¥æ ˆä¸­ï¼Œå­ç¨‹åºä»æ ˆä¸­å–å¾—å‚æ•°</p><p>ä»»åŠ¡ï¼šè®¡ç®— (a - b) ^ 3ï¼Œaã€bä¸ºwordå‹æ•°æ®</p><p>ï¼ˆ1ï¼‰è¿›å…¥å­ç¨‹åºå‰ï¼Œå‚æ•°aã€bå…¥æ ˆ</p><p>ï¼ˆ2ï¼‰è°ƒç”¨å­ç¨‹åºï¼Œå°†ä½¿æ ˆé¡¶å­˜æ”¾IP</p><p>ï¼ˆ3ï¼‰ç»“æœï¼š(dx:ax)&#x3D;(a-b)^3</p><p>ä¾‹ï¼šè®¾ a &#x3D; 3 ã€b &#x3D; 1 ï¼Œè®¡ç®—ï¼š( a â€“ b ) ^ 3</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303214615586.png" alt="image-20240303214615586" style="zoom: 80%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asm">difcute: push bp<br> mov bp,sp<br> mov ax,[bp+4]<br> sub ax,[bp+6]<br> mov bp,ax<br> mul bp<br> mul bp<br> pop bp<br> ret 4<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303214741610.png" alt="image-20240303214741610" style="zoom: 50%;"><p>Q1ï¼šä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦å¯„å­˜å™¨bpï¼Ÿå¯„å­˜å™¨bpçš„å€¼æœ‰æ²¡æœ‰è¢«æ”¹åŠ¨ï¼Ÿ</p><p>A1ï¼š <code>push bp</code> æ˜¯å°†bpä¸­çš„å†…å®¹é€å…¥SS:SPæŒ‡å‘çš„å†…å­˜å•å…ƒä¸­ï¼Œæ­¤æ—¶è¿™ä¸ªå†…å­˜å•å…ƒå°±ä¼šä¿å­˜bpçš„æ—§å€¼ï¼Œç„¶åSS:SPæŒ‡å‘æ–°æ ˆé¡¶ã€‚æœ€å<code>pop bp</code>çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªå†…å­˜å•å…ƒçš„å€¼é‡æ–°èµ‹å€¼åˆ°bpå¯„å­˜å™¨é‡Œé¢ã€‚</p><p>A2ï¼šä¸ºä»€ä¹ˆè¦ä½¿ç”¨bpå¯„å­˜å™¨ï¼Œå‰é¢çš„å†…å®¹æåˆ°è¿‡ï¼Œbpå¯„å­˜å™¨é»˜è®¤æ˜¯SSæ®µçš„(stack segment)ï¼Œç”¨å®ƒæ¥åšåç§»åœ°å€ï¼Œå¾ˆæ–¹ä¾¿ã€‚</p><h3 id="5-7-å¯„å­˜å™¨å†²çªé—®é¢˜"><a href="#5-7-å¯„å­˜å™¨å†²çªé—®é¢˜" class="headerlink" title="5.7 å¯„å­˜å™¨å†²çªé—®é¢˜"></a>5.7 å¯„å­˜å™¨å†²çªé—®é¢˜</h3><h4 id="5-7-1-é—®é¢˜å¼•å…¥"><a href="#5-7-1-é—®é¢˜å¼•å…¥" class="headerlink" title="5.7.1 é—®é¢˜å¼•å…¥"></a>5.7.1 é—®é¢˜å¼•å…¥</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303225236381.png" alt="image-20240303225236381" style="zoom:67%;"><p>è¿™é‡Œcxæ—¢å¯ä»¥ç”¨äºå¾ªç¯ï¼Œåˆç”¨äºè¯»å–æ•°æ®ï¼Œæœ€åcx&#x3D;0çš„æ—¶å€™è¿”å›ä¸Šé¢çš„såŒºåŸŸï¼Œæ­¤æ—¶å†å»loop sï¼Œå¯¹cx-1ï¼Œæ­¤æ—¶cxä¼šè¶Šç•ŒæˆFFFF</p><h4 id="5-7-2-å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³"><a href="#5-7-2-å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³" class="headerlink" title="5.7.2 å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³"></a>5.7.2 å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303225415284.png" alt="image-20240303225415284" style="zoom:80%;"><h4 id="5-7-3-å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³ç¤ºä¾‹"><a href="#5-7-3-å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³ç¤ºä¾‹" class="headerlink" title="5.7.3 å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³ç¤ºä¾‹"></a>5.7.3 å¯„å­˜å™¨å†²çªé—®é¢˜çš„è§£å†³ç¤ºä¾‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>data segment<br>db &#x27;word&#x27;0<br>db &#x27;unix&#x27;0<br>db &#x27;wind&#x27;0<br>db &#x27;good&#x27;0<br>data ends<br><br>code segment<br>start:   mov ax,data<br> mov ds,ax<br> mov bx,0<br> mov cx,4<br>s:   mov si,bx<br> call capital<br> add bx,5<br> loop s<br> mov ax,4c00h<br> int 21h<br>capital: push cx<br> push si<br>change:  mov cl,[si]<br> mov ch,0<br> jcxz ok<br> and byte ptr [si],11011111<br> inc si<br> jmp short change<br>ok:  pop si<br> pop cx<br> ret<br><br>code ends<br>end start<br></code></pre></td></tr></table></figure><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240303230013763.png" alt="image-20240303230013763" style="zoom:80%;"><p><a href="https://blog.csdn.net/struggle_w/article/details/123221670">https://blog.csdn.net/struggle_w/article/details/123221670</a></p><h3 id="5-8-æ ‡å¿—å¯„å­˜å™¨"><a href="#5-8-æ ‡å¿—å¯„å­˜å™¨" class="headerlink" title="5.8 æ ‡å¿—å¯„å­˜å™¨"></a>5.8 æ ‡å¿—å¯„å­˜å™¨</h3><h4 id="5-8-1-è®¤è¯†æ ‡å¿—å¯„å­˜å™¨çš„ç‰¹æ®Šä¹‹å¤„"><a href="#5-8-1-è®¤è¯†æ ‡å¿—å¯„å­˜å™¨çš„ç‰¹æ®Šä¹‹å¤„" class="headerlink" title="5.8.1 è®¤è¯†æ ‡å¿—å¯„å­˜å™¨çš„ç‰¹æ®Šä¹‹å¤„"></a>5.8.1 è®¤è¯†æ ‡å¿—å¯„å­˜å™¨çš„ç‰¹æ®Šä¹‹å¤„</h4><ul><li>æ ‡å¿—å¯„å­˜å™¨çš„ç»“æ„<ul><li>flagå¯„å­˜å™¨æ˜¯æŒ‰ä½èµ·ä½œç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„æ¯ä¸€ä½éƒ½æœ‰ä¸“é—¨çš„å«ä¹‰ï¼Œè®°å½•ç‰¹å®šçš„ä¿¡æ¯</li><li>8086CPUä¸­æ²¡æœ‰ä½¿ç”¨flagçš„1ã€3ã€5ã€12ã€13ã€14ã€15ä½ï¼Œè¿™äº›ä½ä¸å…·æœ‰ä»»ä½•å«ä¹‰</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231430845.png" alt="image-20240304231430845" style="zoom:67%;"><ul><li><p>æ ‡å¿—å¯„å­˜å™¨çš„ä½œç”¨</p><ul><li>ç”¨æ¥å­˜å‚¨ç›¸å…³æŒ‡ä»¤çš„æŸäº›æ‰§è¡Œç»“æœ</li><li>ç”¨æ¥ä¸ºCPUæ‰§è¡Œç›¸å…³æŒ‡ä»¤æä¾›è¡Œä¸ºä¾æ®</li><li>ç”¨æ¥æ§åˆ¶CPUçš„ç›¸å…³å·¥ä½œæ–¹å¼</li></ul></li><li><p>ç›´æ¥è®¿é—®æ ‡å¿—å¯„å­˜å™¨çš„æ–¹æ³•</p><ul><li>pushf ï¼šå°†æ ‡å¿—å¯„å­˜å™¨çš„å€¼å‹æ ˆ</li><li>popf ï¼šä»æ ˆä¸­å¼¹å‡ºæ•°æ®ï¼Œé€å…¥æ ‡å¿—å¯„å­˜å™¨ä¸­</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231442019.png" alt="image-20240304231442019" style="zoom:80%;"><h4 id="5-8-2-ZF-é›¶æ ‡å¿—-Zero-Flag"><a href="#5-8-2-ZF-é›¶æ ‡å¿—-Zero-Flag" class="headerlink" title="5.8.2 ZF-é›¶æ ‡å¿—(Zero Flag)"></a>5.8.2 ZF-é›¶æ ‡å¿—(Zero Flag)</h4><ul><li>ZFæ ‡è®°ç›¸å…³æŒ‡ä»¤çš„è®¡ç®—ç»“æœæ˜¯å¦ä¸º 0 <ul><li>ZF&#x3D;1ï¼Œè¡¨ç¤ºâ€œç»“æœæ˜¯0 â€ ï¼Œ1è¡¨ç¤ºâ€é€»è¾‘çœŸâ€</li><li>ZF&#x3D;0ï¼Œè¡¨ç¤ºâ€œç»“æœä¸æ˜¯0â€ ï¼Œ0è¡¨ç¤ºâ€œé€»è¾‘å‡â€</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231553015.png" alt="image-20240304231553015" style="zoom: 67%;"><h4 id="5-8-3-PF-å¥‡å¶æ ‡å¿—-Parity-Flag"><a href="#5-8-3-PF-å¥‡å¶æ ‡å¿—-Parity-Flag" class="headerlink" title="5.8.3 PF-å¥‡å¶æ ‡å¿—(Parity Flag)"></a>5.8.3 PF-å¥‡å¶æ ‡å¿—(Parity Flag)</h4><ul><li>PFè®°å½•æŒ‡ä»¤æ‰§è¡Œåï¼Œç»“æœçš„æ‰€æœ‰äºŒè¿›åˆ¶ä½ä¸­1çš„ä¸ªæ•°ï¼š<ul><li>1çš„ä¸ªæ•°ä¸ºå¶æ•°ï¼ŒPF &#x3D; 1ï¼›</li><li>1çš„ä¸ªæ•°ä¸ºå¥‡æ•°ï¼ŒPF &#x3D; 0;</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231653626.png" alt="image-20240304231653626" style="zoom: 67%;"><h4 id="5-8-4-SF-ç¬¦å·æ ‡å¿—-Sign-Flag-ã€æœ‰ç¬¦å·æ•°ã€‘"><a href="#5-8-4-SF-ç¬¦å·æ ‡å¿—-Sign-Flag-ã€æœ‰ç¬¦å·æ•°ã€‘" class="headerlink" title="5.8.4 SF-ç¬¦å·æ ‡å¿—(Sign Flag)ã€æœ‰ç¬¦å·æ•°ã€‘"></a>5.8.4 SF-ç¬¦å·æ ‡å¿—(Sign Flag)ã€æœ‰ç¬¦å·æ•°ã€‘</h4><ul><li>SFè®°å½•æŒ‡ä»¤æ‰§è¡Œåï¼Œå°†ç»“æœè§†ä¸ºæœ‰ç¬¦å·æ•°<ul><li>ç»“æœä¸ºè´Ÿï¼ŒSF &#x3D; 1ï¼›</li><li>ç»“æœä¸ºéè´Ÿï¼ŒSF &#x3D; 0ï¼›</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231752734.png" alt="image-20240304231752734" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231820589.png" alt="image-20240304231820589" style="zoom:80%;"><h4 id="5-8-5-CF-è¿›ä½æ ‡å¿—-Carry-Flag"><a href="#5-8-5-CF-è¿›ä½æ ‡å¿—-Carry-Flag" class="headerlink" title="5.8.5 CF-è¿›ä½æ ‡å¿—(Carry Flag)"></a>5.8.5 CF-è¿›ä½æ ‡å¿—(Carry Flag)</h4><ul><li>åœ¨è¿›è¡Œæ— ç¬¦å·æ•°è¿ç®—çš„æ—¶å€™ï¼ŒCFè®°å½•äº†è¿ ç®—ç»“æœçš„æœ€é«˜æœ‰æ•ˆä½å‘æ›´é«˜ä½çš„è¿›ä½å€¼ï¼Œ æˆ–ä»æ›´é«˜ä½çš„å€Ÿä½å€¼ã€‚<ul><li>CFè®°å½•æŒ‡ä»¤æ‰§è¡Œåï¼Œæœ‰è¿›ä½æˆ–å€Ÿä½ï¼ŒCF &#x3D; 1ï¼›æ— è¿›ä½æˆ–å€Ÿä½ï¼ŒCF &#x3D; 0</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304231936728.png" alt="image-20240304231936728" style="zoom:67%;"><h4 id="5-8-6-OF-æº¢å‡ºæ ‡å¿—-Overflow-Flag-ã€æœ‰ç¬¦å·æ•°ã€‘"><a href="#5-8-6-OF-æº¢å‡ºæ ‡å¿—-Overflow-Flag-ã€æœ‰ç¬¦å·æ•°ã€‘" class="headerlink" title="5.8.6 OF-æº¢å‡ºæ ‡å¿—(Overflow Flag)ã€æœ‰ç¬¦å·æ•°ã€‘"></a>5.8.6 OF-æº¢å‡ºæ ‡å¿—(Overflow Flag)ã€æœ‰ç¬¦å·æ•°ã€‘</h4><ul><li>åœ¨è¿›è¡Œæœ‰ç¬¦å·æ•°è¿ç®—çš„æ—¶å€™ï¼Œå¦‚ç»“æœè¶…è¿‡äº†æœºå™¨æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ç§°ä¸ºæº¢å‡ºã€‚<ul><li>OFè®°å½•æœ‰ç¬¦å·æ•°æ“ä½œæŒ‡ä»¤æ‰§è¡Œåï¼Œæœ‰æº¢å‡ºï¼ŒOF &#x3D; 1ï¼›æ— æº¢å‡ºï¼ŒOF &#x3D; 0</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304232034695.png" alt="image-20240304232034695" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240304232043454.png" alt="image-20240304232043454" style="zoom:80%;"><h3 id="5-9-å¸¦è¿›ï¼ˆå€Ÿï¼‰ä½çš„åŠ å‡æ³•"><a href="#5-9-å¸¦è¿›ï¼ˆå€Ÿï¼‰ä½çš„åŠ å‡æ³•" class="headerlink" title="5.9 å¸¦è¿›ï¼ˆå€Ÿï¼‰ä½çš„åŠ å‡æ³•"></a>5.9 å¸¦è¿›ï¼ˆå€Ÿï¼‰ä½çš„åŠ å‡æ³•</h3><h4 id="5-9-1-adc-å¸¦è¿›ä½åŠ æ³•æŒ‡ä»¤"><a href="#5-9-1-adc-å¸¦è¿›ä½åŠ æ³•æŒ‡ä»¤" class="headerlink" title="5.9.1 adc - å¸¦è¿›ä½åŠ æ³•æŒ‡ä»¤"></a>5.9.1 adc - å¸¦è¿›ä½åŠ æ³•æŒ‡ä»¤</h4><ul><li>adcæ˜¯å¸¦è¿›ä½åŠ æ³•æŒ‡ä»¤ ï¼Œå®ƒåˆ©ç”¨äº†CFä½ä¸Šè®°å½•çš„è¿›ä½å€¼ã€‚<ul><li>æ ¼å¼ï¼šadc æ“ä½œå¯¹è±¡1,æ“ä½œå¯¹è±¡2</li><li>åŠŸèƒ½ï¼šæ“ä½œå¯¹è±¡1&#x3D;æ“ä½œå¯¹è±¡1+æ“ä½œå¯¹è±¡2+CF</li><li>ä¾‹ï¼šadc ax,bx å®ç°çš„åŠŸèƒ½æ˜¯ï¼š(ax)&#x3D;(ax)+(bx)+CF</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305230140896.png" alt="image-20240305230140896" style="zoom:80%;"><h4 id="5-9-2-adcæŒ‡ä»¤åº”ç”¨ï¼šå¤§æ•°ç›¸åŠ "><a href="#5-9-2-adcæŒ‡ä»¤åº”ç”¨ï¼šå¤§æ•°ç›¸åŠ " class="headerlink" title="5.9.2 adcæŒ‡ä»¤åº”ç”¨ï¼šå¤§æ•°ç›¸åŠ "></a>5.9.2 adcæŒ‡ä»¤åº”ç”¨ï¼šå¤§æ•°ç›¸åŠ </h4><p>é—®é¢˜ï¼š8086æŒ‡ä»¤æä¾›addæŒ‡ä»¤ï¼Œå®Œæˆ8ä½æˆ–16ä½åŠ æ³•ï¼Œæœ‰æ›´å¤§çš„æ•°ç›¸åŠ æ—¶ï¼Œå¦‚ä½•åšï¼Ÿä¾‹å¦‚32ä½ã€64ä½ã€24ä½</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305230235890.png" alt="image-20240305230235890" style="zoom:80%;"><p>ğŸ§¸<strong>å¦™å•Šï¼Œå¦™å•Š</strong></p><h4 id="5-9-3-128ä½æ•°æ®çš„ç›¸åŠ "><a href="#5-9-3-128ä½æ•°æ®çš„ç›¸åŠ " class="headerlink" title="5.9.3 128ä½æ•°æ®çš„ç›¸åŠ "></a>5.9.3 128ä½æ•°æ®çš„ç›¸åŠ </h4><p><strong>é—®é¢˜ï¼š</strong>ç¼–å†™ä¸€ä¸ªå­ç¨‹åºï¼Œå¯¹ä¸¤ä¸ª128ä½æ•°æ®è¿›è¡Œç›¸åŠ ã€‚</p><p>åç§°ï¼šadd128</p><p>åŠŸèƒ½ï¼šä¸¤ä¸ªé€†åºå­˜æ”¾çš„128ä½æ•°æ®è¿›è¡Œç›¸åŠ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">data segment<br>    dw 0A452H,0A8F5H,78E6H,0A8EH,8B7AH,54F6H,0F04H,671EH<br>    dw 0E71EH,0EF04H,54F6H,8B7AH,0A8EH,78E6H,58F5H,0452H<br>data end<br></code></pre></td></tr></table></figure><p>æ•°æ®ä¸º128ä½ï¼Œéœ€è¦8ä¸ªå­—å•å…ƒï¼Œç”±ä½åœ°å€å•å…ƒåˆ°é«˜åœ°å€ å•å…ƒï¼Œä¾æ¬¡å­˜æ”¾ç”±ä½åˆ°é«˜çš„å„ä¸ªå­—ã€‚</p><p><strong>åˆ†æï¼š</strong></p><ul><li>ds:siæŒ‡å‘å­˜å‚¨ç¬¬ä¸€ä¸ªæ•°çš„å†…å­˜ç©ºé—´</li><li>ds:diæŒ‡å‘å­˜å‚¨ç¬¬äºŒä¸ªæ•°çš„å†…å­˜ç©ºé—´</li><li>è¿ç®—ç»“æœå­˜å‚¨åœ¨ç¬¬ä¸€ä¸ªæ•°çš„å­˜å‚¨ç©ºé—´ä¸­</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305230635245.png" alt="image-20240305230635245" style="zoom: 80%;"><p><strong>Q1ï¼šsub ax,axå¯å¦æ›¿æ¢ä¸ºmov ax,0</strong></p><p>A1ï¼šä¸å¯ä»¥ ï¼Œsub ax,axç›®çš„æ˜¯ä¸ºäº†æ¸…é›¶cfå¯„å­˜å™¨ï¼Œä¸ºä¸‹ä¸€æ¬¡è°ƒç”¨å­ç¨‹åºåšåˆå§‹åŒ–cf</p><p><strong>Q2ï¼šä¸¤ä¸ªinc diæ˜¯å¦å¯ä»¥æ›¿æ¢ä¸ºadd di,2</strong></p><p>A2ï¼šä¸å¯ä»¥ï¼Œå¦‚æœdi+2åæº¢å‡ºäº†ï¼Œä¼šæ±¡æŸ“cfå¯„å­˜å™¨</p><h3 id="5-9-4-ssbæŒ‡ä»¤"><a href="#5-9-4-ssbæŒ‡ä»¤" class="headerlink" title="5.9.4 ssbæŒ‡ä»¤"></a>5.9.4 ssbæŒ‡ä»¤</h3><ul><li>sbbï¼šå¸¦å€Ÿä½å‡æ³•æŒ‡ä»¤<ul><li>æ ¼å¼ï¼šsbb æ“ä½œå¯¹è±¡1,æ“ä½œå¯¹è±¡2</li><li>åŠŸèƒ½ï¼šæ“ä½œå¯¹è±¡1&#x3D;æ“ä½œå¯¹è±¡1â€“æ“ä½œå¯¹è±¡2â€“CF</li><li>ä¸subåŒºåˆ«ï¼šåˆ©ç”¨CFä½ä¸Šè®°å½•çš„å€Ÿä½å€¼</li><li>æ¯”å¦‚ï¼šsbb ax,bï¼Œå®ç°åŠŸèƒ½ï¼š (ax) &#x3D; (ax) â€“ (bx)</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305230944934.png" alt="image-20240305230944934" style="zoom: 75%;"><h3 id="5-10-cmpä¸æ¡ä»¶è½¬ç§»æŒ‡ä»¤"><a href="#5-10-cmpä¸æ¡ä»¶è½¬ç§»æŒ‡ä»¤" class="headerlink" title="5.10 cmpä¸æ¡ä»¶è½¬ç§»æŒ‡ä»¤"></a>5.10 cmpä¸æ¡ä»¶è½¬ç§»æŒ‡ä»¤</h3><h4 id="5-10-1-cmpæŒ‡ä»¤"><a href="#5-10-1-cmpæŒ‡ä»¤" class="headerlink" title="5.10.1 cmpæŒ‡ä»¤"></a>5.10.1 cmpæŒ‡ä»¤</h4><ul><li>cmpæŒ‡ä»¤<ul><li>æ ¼å¼ï¼šcmp æ“ä½œå¯¹è±¡1,æ“ä½œå¯¹</li><li>åŠŸèƒ½ï¼šè®¡ç®—æ“ä½œå¯¹è±¡1â€“æ“ä½œå¯¹è±¡2</li></ul></li><li>åº”ç”¨ï¼š<ul><li>å…¶ä»–ç›¸å…³æŒ‡ä»¤é€šè¿‡è¯†åˆ«è¿™äº›è¢«å½±å“çš„æ ‡å¿—å¯„å­˜å™¨ä½æ¥å¾—çŸ¥æ¯”è¾ƒç»“æœ</li></ul></li></ul><blockquote><p>cmp æ˜¯æ¯”è¾ƒæŒ‡ä»¤ï¼ŒåŠŸèƒ½ç›¸å½“äºå‡æ³•æŒ‡ä»¤ï¼Œåªæ˜¯ ä¸ä¿å­˜ç»“æœã€‚</p><p>cmp æŒ‡ä»¤æ‰§è¡Œåï¼Œå°†å¯¹æ ‡å¿—å¯„å­˜å™¨äº§ç”Ÿå½±å“ã€‚</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305232631338.png" alt="image-20240305232631338" style="zoom:67%;"><h4 id="5-10-2-æ— ç¬¦å·æ•°æ¯”è¾ƒä¸æ ‡å¿—ä½å–å€¼"><a href="#5-10-2-æ— ç¬¦å·æ•°æ¯”è¾ƒä¸æ ‡å¿—ä½å–å€¼" class="headerlink" title="5.10.2 æ— ç¬¦å·æ•°æ¯”è¾ƒä¸æ ‡å¿—ä½å–å€¼"></a>5.10.2 æ— ç¬¦å·æ•°æ¯”è¾ƒä¸æ ‡å¿—ä½å–å€¼</h4><p><strong>æ€è·¯ï¼š</strong>é€šè¿‡cmp æŒ‡ä»¤æ‰§è¡Œåç›¸å…³æ ‡å¿—ä½çš„å€¼ï¼Œå¯ä»¥çœ‹å‡ºæ¯”è¾ƒçš„ç»“æœ</p><ul><li>æŒ‡ä»¤ï¼šcmp ax,b</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305232840562.png" alt="image-20240305232840562" style="zoom:80%;"><h4 id="5-10-3-æ¡ä»¶è½¬ç§»æŒ‡ä»¤"><a href="#5-10-3-æ¡ä»¶è½¬ç§»æŒ‡ä»¤" class="headerlink" title="5.10.3 æ¡ä»¶è½¬ç§»æŒ‡ä»¤"></a>5.10.3 æ¡ä»¶è½¬ç§»æŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305232932548.png" alt="image-20240305232932548" style="zoom:67%;"><h4 id="5-10-4-æ¡ä»¶è½¬ç§»æŒ‡ä»¤çš„ä½¿ç”¨"><a href="#5-10-4-æ¡ä»¶è½¬ç§»æŒ‡ä»¤çš„ä½¿ç”¨" class="headerlink" title="5.10.4 æ¡ä»¶è½¬ç§»æŒ‡ä»¤çš„ä½¿ç”¨"></a>5.10.4 æ¡ä»¶è½¬ç§»æŒ‡ä»¤çš„ä½¿ç”¨</h4><ul><li>jxxxç³»åˆ—æŒ‡ä»¤å’ŒcmpæŒ‡ä»¤é…åˆï¼Œæ„é€ æ¡ä»¶è½¬ç§»æŒ‡<ul><li>ä¸å¿…å†è€ƒè™‘cmpæŒ‡ä»¤å¯¹ç›¸å…³æ ‡å¿—ä½çš„å½±å“å’ŒjxxxæŒ‡ä»¤å¯¹ç›¸å…³æ ‡å¿—ä½çš„æ£€æµ‹</li><li>å¯ä»¥ç›´æ¥è€ƒè™‘cmpå’ŒjxxxæŒ‡ä»¤é…åˆä½¿ç”¨æ—¶è¡¨ç°å‡ºæ¥çš„é€»è¾‘å«ä¹‰</li></ul></li><li>jxxxç³»åˆ—æŒ‡ä»¤å’ŒcmpæŒ‡ä»¤é…åˆå®ç°é«˜çº§è¯­è¨€ä¸­ifè¯­å¥çš„åŠŸèƒ½</li></ul><p><strong>ä¾‹1ï¼šç”¨æ±‡ç¼–è¯­è¨€å’ŒCè¯­è¨€å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼šå¦‚æœ(ah)&#x3D;(bh)ï¼Œåˆ™(ah)&#x3D;(ah)+(ah)ï¼Œå¦åˆ™(ah)&#x3D;(ah)+(bh)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (a == b) &#123;<br>    a += a;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    a += b;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asm">cmp ah,bh<br>je s<br>add ah,bh<br>jmp short ok<br>s:  add ah,bh<br>ok: ret<br></code></pre></td></tr></table></figure><p><strong>ä¾‹2ï¼šç»™å‡ºä¸‹é¢ä¸€ç»„æ•°æ®ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asm">data segment<br>db 8,11,8,1,5,63,38<br>data ends<br></code></pre></td></tr></table></figure><p>è¯·ç¼–ç¨‹å®ç°å¦‚ä¸‹ç»Ÿè®¡ï¼Œç”¨axä¿å­˜ç»Ÿè®¡ç»“æœ</p><p><strong>ï¼ˆ1ï¼‰ç»Ÿè®¡æ•°å€¼ä¸º8çš„å­—èŠ‚çš„ä¸ªæ•°</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305233803864.png" alt="image-20240305233803864" style="zoom: 80%;"><p><strong>ï¼ˆ2ï¼‰ç»Ÿè®¡æ•°å€¼å¤§äº8çš„å­—èŠ‚çš„ä¸ªæ•°</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305233822669.png" alt="image-20240305233822669" style="zoom:80%;"><p><strong>ï¼ˆ3ï¼‰ç»Ÿè®¡æ•°å€¼å°äº8çš„å­—èŠ‚çš„ä¸ªæ•°</strong></p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305233838883.png" alt="image-20240305233838883" style="zoom:80%;"><h3 id="5-11-DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤"><a href="#5-11-DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤" class="headerlink" title="5.11 DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤"></a>5.11 DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤</h3><p>ç¼–ç¨‹ï¼šå°†dataæ®µä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²å¤åˆ¶åˆ°å®ƒåé¢çš„ç©ºé—´ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">data segment<br>    db &#x27;Welcome to masm!&#x27;<br>    db 16 dup (0)<br>data ends<br></code></pre></td></tr></table></figure><p>ä»¥å‰æˆ‘ä»¬çš„å†™æ³•æ˜¯è¿™æ ·çš„ï¼Œç°åœ¨è¦ç”¨æ›´ç®€æ´çš„å†™æ³•</p><h4 id="5-11-1-DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤"><a href="#5-11-1-DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤" class="headerlink" title="5.11.1 DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤"></a>5.11.1 DFæ ‡å¿—å’Œä¸²ä¼ é€æŒ‡ä»¤</h4><ul><li>åŠŸèƒ½<ul><li>åœ¨ä¸²å¤„ç†æŒ‡ä»¤ä¸­ï¼Œæ§åˆ¶æ¯æ¬¡æ“ä½œåsiï¼Œdiçš„å¢å‡ã€‚</li><li>DF &#x3D; 0ï¼šæ¯æ¬¡æ“ä½œåsiï¼Œdié€’å¢ï¼›</li><li>DF &#x3D; 1ï¼šæ¯æ¬¡æ“ä½œåsiï¼Œdié€’å‡ã€‚</li></ul></li><li>å¯¹DFä½è¿›è¡Œè®¾ç½®çš„æŒ‡ä»¤ï¼š<ul><li>cldæŒ‡ä»¤ï¼šå°†æ ‡å¿—å¯„å­˜å™¨çš„DFä½è®¾ä¸º0(clear)</li><li>stdæŒ‡ä»¤ï¼šå°†æ ‡å¿—å¯„å­˜å™¨çš„DFä½è®¾ä¸º1(setup)</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305235352330.png" alt="image-20240305235352330" style="zoom:67%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs asm">data segment<br>    db &#x27;Welcome to masm!&#x27;<br>    db 16 dup (0)<br>data ends<br><br>code segment<br>start: mov ax,data<br>mov ds,ax<br>mov si,0<br>mov es,ax<br>mov di,16<br>cld<br>mov cx,16<br>s:movsb<br>loops<br>code ends<br>end start<br></code></pre></td></tr></table></figure><h4 id="5-11-2-repæŒ‡ä»¤"><a href="#5-11-2-repæŒ‡ä»¤" class="headerlink" title="5.11.2 repæŒ‡ä»¤"></a>5.11.2 repæŒ‡ä»¤</h4><ul><li>repæŒ‡ä»¤å¸¸å’Œä¸²ä¼ é€æŒ‡ä»¤æ­é…ä½¿ç”¨</li><li>åŠŸèƒ½ï¼šæ ¹æ®cxçš„å€¼ï¼Œé‡å¤æ‰§è¡Œåé¢çš„æŒ‡ä»¤</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305235614090.png" alt="image-20240305235614090" style="zoom:80%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240305235622143.png" alt="image-20240305235622143" style="zoom:80%;"><h2 id="6-ä¸­æ–­åŠå¤–éƒ¨è®¾å¤‡ä»æ“ä½œ"><a href="#6-ä¸­æ–­åŠå¤–éƒ¨è®¾å¤‡ä»æ“ä½œ" class="headerlink" title="6.ä¸­æ–­åŠå¤–éƒ¨è®¾å¤‡ä»æ“ä½œ"></a>6.ä¸­æ–­åŠå¤–éƒ¨è®¾å¤‡ä»æ“ä½œ</h2><h3 id="6-1-ç§»ä½æŒ‡ä»¤"><a href="#6-1-ç§»ä½æŒ‡ä»¤" class="headerlink" title="6.1 ç§»ä½æŒ‡ä»¤"></a>6.1 ç§»ä½æŒ‡ä»¤</h3><h4 id="6-1-1-ç§»ä½æŒ‡ä»¤"><a href="#6-1-1-ç§»ä½æŒ‡ä»¤" class="headerlink" title="6.1.1 ç§»ä½æŒ‡ä»¤"></a>6.1.1 ç§»ä½æŒ‡ä»¤</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307230827387.png" alt="image-20240307230827387" style="zoom: 67%;"><h4 id="6-1-2-é€»è¾‘ç§»ä½æŒ‡ä»¤shlå’Œshr"><a href="#6-1-2-é€»è¾‘ç§»ä½æŒ‡ä»¤shlå’Œshr" class="headerlink" title="6.1.2 é€»è¾‘ç§»ä½æŒ‡ä»¤shlå’Œshr"></a>6.1.2 é€»è¾‘ç§»ä½æŒ‡ä»¤shlå’Œshr</h4><ul><li><p>SHL OPR, CNTï¼Œå°†OPRé€»è¾‘å·¦ç§»CNTä½</p><ul><li>å°†å¯„å­˜å™¨æˆ–å†…å­˜å•å…ƒä¸­çš„æ•°æ®å‘å·¦ç§»ä½</li><li>å°†æœ€åç§»å‡ºçš„ä¸€ä½å†™å…¥CFä¸­</li><li>æœ€ä½ä½ç”¨0è¡¥å……</li></ul></li><li><p>shlæŒ‡ä»¤æ“ä½œå®ä¾‹</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asm">mov al,01010001b<br>mov cl,3<br>shl al,cl<br></code></pre></td></tr></table></figure><p>ç»“æœï¼š(al)&#x3D;10001000b  CF&#x3D;0</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231027733.png" alt="image-20240307231027733" style="zoom:80%;"><p>å·¦ç§»3æ¬¡ä¹‹åï¼Œæœ€åä¸€ä½ä½0ï¼Œæ‰€ä»¥CF&#x3D;0</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231054757.png" alt="image-20240307231054757" style="zoom:67%;"><h3 id="6-2-æ“ä½œæ˜¾å­˜æ•°æ®"><a href="#6-2-æ“ä½œæ˜¾å­˜æ•°æ®" class="headerlink" title="6.2 æ“ä½œæ˜¾å­˜æ•°æ®"></a>6.2 æ“ä½œæ˜¾å­˜æ•°æ®</h3><h4 id="6-2-1-æ˜¾ç¤ºçš„åŸç†"><a href="#6-2-1-æ˜¾ç¤ºçš„åŸç†" class="headerlink" title="6.2.1 æ˜¾ç¤ºçš„åŸç†"></a>6.2.1 æ˜¾ç¤ºçš„åŸç†</h4><p><strong>å±å¹•ä¸Šçš„å†…å®¹&#x3D;æ˜¾å­˜ä¸­çš„æ•°æ®</strong></p><ul><li>ğŸ§¸å¯¹äº8086CPUï¼Œæ˜¾å­˜åœ°å€ç©ºé—´ä¸º0x<strong>B8000h~0xBFFFF</strong>ï¼Œå…±32Kçš„ç©ºé—´ï¼Œæ˜¯80*25å½©è‰²å­—ç¬¦æ¨¡å¼ç¬¬0é¡µçš„æ˜¾ç¤ºç¼“å†²åŒº</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231508991.png" alt="image-20240307231508991" style="zoom:67%;"><h4 id="6-2-2-æ˜¾ç¤ºç¼“å†²åŒºçš„ç»“æ„"><a href="#6-2-2-æ˜¾ç¤ºç¼“å†²åŒºçš„ç»“æ„" class="headerlink" title="6.2.2 æ˜¾ç¤ºç¼“å†²åŒºçš„ç»“æ„"></a>6.2.2 æ˜¾ç¤ºç¼“å†²åŒºçš„ç»“æ„</h4><p>80*25å½©è‰²å­—ç¬¦æ¨¡å¼</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231548037.png" alt="image-20240307231548037" style="zoom:67%;"><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231607907.png" alt="image-20240307231607907" style="zoom:67%;"><p>ä¸‹é¢çš„ç¤ºä¾‹ä¸ºæ˜¾ç¤ºABCDä¸åŒçš„é¢œè‰²ï¼šç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º41ï¼Œå¯¹åº”å­—ç¬¦ä¸ºAï¼›å±æ€§å­—èŠ‚ä¸º42(0000 0010)ï¼ŒèƒŒæ™¯ä¸º000(é»‘è‰²)ï¼Œå‰æ™¯ä¹Ÿå°±æ˜¯å­—ç¬¦é¢œè‰²ä¸º010(ç»¿è‰²)</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307231655253.png" alt="image-20240307231655253" style="zoom: 80%;"><h4 id="6-2-3-æ˜¾ç¤ºä¿¡æ¯çš„ä¸€ç§â€ç›´æ¥â€æ–¹å¼"><a href="#6-2-3-æ˜¾ç¤ºä¿¡æ¯çš„ä¸€ç§â€ç›´æ¥â€æ–¹å¼" class="headerlink" title="6.2.3 æ˜¾ç¤ºä¿¡æ¯çš„ä¸€ç§â€ç›´æ¥â€æ–¹å¼"></a>6.2.3 æ˜¾ç¤ºä¿¡æ¯çš„ä¸€ç§â€ç›´æ¥â€æ–¹å¼</h4><p>ç¼–ç¨‹åºï¼Œåœ¨å±å¹•çš„ä¸­é—´ï¼Œç™½åº•è“å­—ï¼Œæ˜¾ç¤ºâ€Welcome to masm!â€</p><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307232011828.png" alt="image-20240307232011828" style="zoom:67%;"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:codeseg,ds:datasg<br>datasg segment<br>db &#x27;Welcome to masm!&#x27;<br>datasg ends<br><br>codeseg segment<br>start:mov ax,datasg<br>mov ds,ax<br>mov ax,0B800H<br>mov es,ax<br>mov si,0<br>mov di,160*12+80-16  ; å®šä½åˆ°ä¸­é—´è¡Œä¸­é—´åˆ—ï¼Œå¹¶å®šä½åˆ°èµ·å§‹ä½ç½®<br>mov cx,16<br>w:mov al,[si]<br>mov es:[di],al<br>inc di<br>mov al,71H<br>mov es:[di],al<br>inc si<br>inc di<br>loop w<br><br>mov ax,4c00h<br>int 21h<br>codeseg ends<br>end start<br></code></pre></td></tr></table></figure><h3 id="6-3-æè¿°å†…å­˜å•å…ƒçš„æ ‡å·"><a href="#6-3-æè¿°å†…å­˜å•å…ƒçš„æ ‡å·" class="headerlink" title="6.3 æè¿°å†…å­˜å•å…ƒçš„æ ‡å·"></a>6.3 æè¿°å†…å­˜å•å…ƒçš„æ ‡å·</h3><h4 id="6-3-1-å…³äºæ ‡å·"><a href="#6-3-1-å…³äºæ ‡å·" class="headerlink" title="6.3.1 å…³äºæ ‡å·"></a>6.3.1 å…³äºæ ‡å·</h4><ul><li>ä»£ç æ®µä¸­çš„æ ‡å·å¯ä»¥ç”¨æ¥ æ ‡è®°æŒ‡ä»¤ã€æ®µçš„èµ·å§‹åœ°å€</li><li>ä»£ç æ®µä¸­çš„æ•°æ®ä¹Ÿå¯ä»¥ç”¨ æ ‡å·</li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307232939157.png" alt="image-20240307232939157" style="zoom: 67%;"><h4 id="6-3-2-å»äº†å†’å·çš„æ•°æ®æ ‡å·"><a href="#6-3-2-å»äº†å†’å·çš„æ•°æ®æ ‡å·" class="headerlink" title="6.3.2 å»äº†å†’å·çš„æ•°æ®æ ‡å·"></a>6.3.2 å»äº†å†’å·çš„æ•°æ®æ ‡å·</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307233344065.png" alt="image-20240307233344065" style="zoom:67%;"><ul><li>æˆ‘ä»¬åœ¨code æ®µä¸­ä½¿ç”¨çš„æ ‡å·aã€ båé¢æ²¡æœ‰â€œ : â€ ï¼Œå®ƒä»¬åŒæ—¶æè¿° å†…å­˜åœ°å€å’Œå•å…ƒé•¿åº¦çš„æ ‡å·ã€‚</li><li><strong>æ ‡å·a</strong><ul><li>åœ°å€code:0</li><li>ä»¥åçš„å†…å­˜å•å…ƒéƒ½æ˜¯å­—èŠ‚</li></ul></li><li><strong>æ ‡å·b</strong><ul><li>åœ°å€code:8</li><li>ä»¥åçš„å†…å­˜å•å…ƒéƒ½æ˜¯å­—</li></ul></li></ul><h4 id="6-3-3-æ•°æ®æ ‡å·åŒæ—¶æè¿°å†…å­˜åœ°å€å’Œå•å…ƒé•¿åº¦"><a href="#6-3-3-æ•°æ®æ ‡å·åŒæ—¶æè¿°å†…å­˜åœ°å€å’Œå•å…ƒé•¿åº¦" class="headerlink" title="6.3.3 æ•°æ®æ ‡å·åŒæ—¶æè¿°å†…å­˜åœ°å€å’Œå•å…ƒé•¿åº¦"></a>6.3.3 æ•°æ®æ ‡å·åŒæ—¶æè¿°å†…å­˜åœ°å€å’Œå•å…ƒé•¿åº¦</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307233624935.png" alt="image-20240307233624935" style="zoom:67%;"><h4 id="6-3-4-æ›´å¸¸è§çš„æ–¹å¼ï¼šæ•°æ®æ®µä¸­çš„æ•°æ®æ ‡å·"><a href="#6-3-4-æ›´å¸¸è§çš„æ–¹å¼ï¼šæ•°æ®æ®µä¸­çš„æ•°æ®æ ‡å·" class="headerlink" title="6.3.4 æ›´å¸¸è§çš„æ–¹å¼ï¼šæ•°æ®æ®µä¸­çš„æ•°æ®æ ‡å·"></a>6.3.4 æ›´å¸¸è§çš„æ–¹å¼ï¼šæ•°æ®æ®µä¸­çš„æ•°æ®æ ‡å·</h4><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240307233800314.png" alt="image-20240307233800314" style="zoom:67%;"><p>ğŸ§‘â€ğŸ„<code>c dw offset a,offset b</code>ï¼š<strong>æœ‰ç‚¹ç±»ä¼¼äºCè¯­è¨€é‡Œé¢çš„æŒ‡é’ˆï¼Œcé‡Œé¢å­˜æ”¾äº†aå’Œbçš„åœ°å€</strong></p><h3 id="6-4-æ•°æ®çš„ç›´æ¥å®šå€è¡¨"><a href="#6-4-æ•°æ®çš„ç›´æ¥å®šå€è¡¨" class="headerlink" title="6.4 æ•°æ®çš„ç›´æ¥å®šå€è¡¨"></a>6.4 æ•°æ®çš„ç›´æ¥å®šå€è¡¨</h3><p><strong>åˆ©ç”¨è¡¨ï¼Œåœ¨ä¸¤ä¸ªæ•°æ®é›†åˆä¹‹é—´å»ºç«‹ä¸€ç§æ˜ å°„å…³ç³»ï¼Œç”¨æŸ¥è¡¨çš„æ–¹æ³•æ ¹æ®ç»™å‡ºçš„æ•°æ®å¾—åˆ°å…¶åœ¨å¦ä¸€é›†åˆä¸­çš„å¯¹åº”æ•°æ®ã€‚</strong></p><ul><li>åº”ç”¨ç¤ºä¾‹ï¼šç¼–å†™ç¨‹åºï¼Œè®¡ç®—sin(x)ï¼Œxâˆˆ{0Â° ,30Â° ,60Â° ,90Â° ,120Â° ,150Â° ,180Â°}ï¼Œå¹¶åœ¨å±å¹•ä¸­é—´æ˜¾ç¤ºè®¡ç®—ç»“æœã€‚</li><li>å¸¸è§„è§£æ³•ï¼š<ul><li>åˆ©ç”¨éº¦å…‹åŠ³æ—å…¬å¼è®¡ç®—ï¼š</li></ul></li></ul><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240313222815307.png" alt="image-20240313222815307" style="zoom:67%;"><ul><li>ç©ºé—´æ¢æ—¶é—´æ–¹æ¡ˆ<ul><li>å°†æ‰€è¦è®¡ç®—å¾—sin(x)çš„ç»“æœéƒ½å­˜å‚¨åˆ°ä¸€å¼ è¡¨ä¸­ï¼Œç„¶åç”¨è§’åº¦å€¼æ¥æŸ¥è¡¨ï¼Œæ‰¾åˆ°å¯¹å¯¹åº”çš„sin(x)å€¼</li><li>å…·ä½“æ–¹æ³•ï¼š<ul><li>ç”¨axå‘å­ç¨‹åºä¼ é€’è§’åº¦å€¼</li><li>ç”¨è§’åº¦å€¼&#x2F;30ä¸ºtableè¡¨ä¸­çš„åç§»ï¼Œå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²é¦–åœ°å€</li></ul></li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs asm">assume cs:code<br>code segment<br>start:<br>mov al,60<br>call showsin<br>mov ax,4c00h<br>int 21h<br><br>    showsin: jmp short show<br>            table dw ag0,ag30,ag60,ag90,ag120,ag150,ag180 <br>            ag0   db&#x27;0&#x27;,0;sin 0=0<br>            ag30  db &#x27;0.5&#x27;,0;sin 30=0.5<br>            ag60  db &#x27;0.866&#x27;,0;sin 60=0.866<br>            ag90  db &#x27;1&#x27;,0<br>            ag120 db &#x27;0.866&#x27;,0<br>            ag150 db &#x27;0.5&#x27;,0<br>            ag180 db &#x27;0&#x27;,0<br>    show: push bx<br>            push es<br>            push si<br>            mov bx,0b800h<br>            mov es,bx<br><br>            ;è®¡ç®—å‡ºsin(x)å¯¹åº”ç»“æœå­—ç¬¦ä¸²çš„åç§»åœ°å€<br>            mov bl,30<br>            div bl;ç”¨è§’åº¦å€¼/30æ¥å¾—åˆ°ç›¸å¯¹äºtableçš„åç§»<br>            mov bl,al<br>            mov bh,0<br>            add bx,bx;å› ä¸ºtableä¸­æ˜¯å­—å•å…ƒï¼Œéœ€è¦å†ä¹˜2<br>            mov bx,table[bx];bxä¸­æ˜¯å¯¹åº”ç»“æœå­—ç¬¦ä¸²çš„åç§»åœ°å€<br><br>            ;æ˜¾ç¤ºå¯¹åº”ç»“æœå­—ç¬¦ä¸²åˆ°å±å¹•<br>            mov si,160*12+40*2<br>    shows: mov ah,cs:[bx]<br>            cmp ah,0<br>            je showret<br>            mov es:[si],ah<br>            inc bx<br>            add si,2<br>            jmp short shows<br><br>showret:pop si<br>            pop es<br>            pop bx<br>            ret<br><br>code ends<br>end start<br></code></pre></td></tr></table></figure><blockquote><p>å¤‡æ³¨ï¼šä»£ç æ ‡å·ï¼Œä¸ä¼šå½±å“ä»£ç æ®µæ‰§è¡Œï¼Œä¼šä¾æ¬¡é¡ºåºæ‰§è¡Œï¼Œé™¤éæœ‰jmp&#x2F;callæŒ‡ä»¤</p></blockquote><img src="/2023/07/10/%E8%B4%BA%E5%88%A9%E5%9D%9A%E6%B1%87%E7%BC%96%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240313230336086.png" alt="image-20240313230336086" style="zoom:67%;">]]></content>
    
    
    <categories>
      
      <category>æ±‡ç¼–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ±‡ç¼–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android æ–‡ä»¶çº§åŠ å¯†ï¼ˆFile-based Encryptionï¼‰ä¹‹å¯†é’¥ç®¡ç†</title>
    <link href="/2023/07/06/Android-%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86%EF%BC%88File-based-Encryption%EF%BC%89%E4%B9%8B%E5%AF%86%E9%92%A5%E7%AE%A1%E7%90%86/"/>
    <url>/2023/07/06/Android-%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86%EF%BC%88File-based-Encryption%EF%BC%89%E4%B9%8B%E5%AF%86%E9%92%A5%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-æ–‡ä»¶çº§åŠ å¯†ï¼ˆFile-based-Encryptionï¼‰ä¹‹å¯†é’¥ç®¡ç†"><a href="#Android-æ–‡ä»¶çº§åŠ å¯†ï¼ˆFile-based-Encryptionï¼‰ä¹‹å¯†é’¥ç®¡ç†" class="headerlink" title="Android æ–‡ä»¶çº§åŠ å¯†ï¼ˆFile-based Encryptionï¼‰ä¹‹å¯†é’¥ç®¡ç†"></a>Android æ–‡ä»¶çº§åŠ å¯†ï¼ˆFile-based Encryptionï¼‰ä¹‹å¯†é’¥ç®¡ç†</h1>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fsck_msdoså­¦ä¹ ç¬”è®°</title>
    <link href="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="fsck-msdoså­¦ä¹ ç¬”è®°"><a href="#fsck-msdoså­¦ä¹ ç¬”è®°" class="headerlink" title="fsck_msdoså­¦ä¹ ç¬”è®°"></a>fsck_msdoså­¦ä¹ ç¬”è®°</h1><h2 id="1-äº†è§£ä»€ä¹ˆæ˜¯FATäº¤å‰é“¾"><a href="#1-äº†è§£ä»€ä¹ˆæ˜¯FATäº¤å‰é“¾" class="headerlink" title="1.äº†è§£ä»€ä¹ˆæ˜¯FATäº¤å‰é“¾"></a>1.äº†è§£ä»€ä¹ˆæ˜¯FATäº¤å‰é“¾</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªå®šä¹‰ï¼š</p><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703214405538.png" alt="image-20230703214405538" style="zoom: 50%;"><blockquote><p>cross-linked filesæ˜¯é‚£äº›æŒ‡å‘äº†åŒä¸€ä¸ªç°‡çš„fat entryã€‚</p></blockquote><p>ä¸‹é¢æˆ‘ä»¬å†çœ‹è¿™é‡Œç»™å‡ºçš„è¯¦ç»†å®šä¹‰ï¼š<a href="http://www.edusoftmax.com/cross_linked_file.html">http://www.edusoftmax.com/cross_linked_file.html</a></p><blockquote><p>MS-DOS organizes the diskâ€™s data area into sections called clusters or allocation units. Each file has its own directory entry, which includes the file name, size, attribute information, date, time, and the cluster where the start of the file is stored.</p><p>The file allocation table (FAT) includes an entry for each cluster. Each clusterâ€™s entry includes either a code specifying that it is the last cluster in the file, or the number of the next cluster used by the file. Clusters can also be marked unusable, which CHKDSK reports as bad sectors.</p><p>When the computer tries to save data to the hard drive in a place where a file already exists, the two files become cross-linked. When this occurs, data from both files share the same sector on the hard drive causing both to become corrupt. In some cases, one of the cross-linked files can be saved, but often both must be deleted.</p><p>For example, suppose you have two files, each 512 bytes in size. Each file requires one cluster. If both files are marked as being located in cluster 5, then cluster 5 probably contains the file with the later date. You can confirm this by looking at it (if itâ€™s a data file) or running it (if itâ€™s a program).</p><p>Cross-linked files are generally created when the computer is improperly shut down or an application abnormally aborts.</p></blockquote><p>è¿™é‡Œè§£é‡Šçš„ä¹Ÿæ˜¯ç›¸å½“çš„æ¸…æ¥šï¼Œ<strong>å½“è®¡ç®—æœºè¯•å›¾å°†æ•°æ®ä¿å­˜åˆ°å·²ç»å­˜åœ¨æ–‡ä»¶çš„ç¡¬ç›˜æ—¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶ä¼šäº¤å‰è¿æ¥ã€‚</strong></p><hr><p>ä¸‹é¢åªæ˜¯å®šä¹‰ï¼Œçœ‹èµ·æ¥ä»ç„¶æ¯”è¾ƒçš„æŠ½è±¡ï¼Œä¸‹é¢æˆ‘ç”»ä¸€ä¸ªå›¾è¿›è¡Œè¯´æ˜ï¼š</p><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703215118346.png" alt="image-20230703215118346" style="zoom:67%;"><ul><li>å‡è®¾æ–‡ä»¶hello1.txtçš„ç°‡é“¾ä¸º3-&gt;5-&gt;7-&gt;8</li><li>å‡è®¾æ–‡ä»¶hello2.txtçš„ç°‡é“¾ä¸º4-&gt;6-&gt;7-&gt;8</li><li>å¯ä»¥å‘ç°ä¸¤æ¡é“¾æ˜¯ç›¸äº¤çš„ï¼Œä¸”ç›¸äº¤ç‚¹åœ¨7è¿™ä¸ªä½ç½®ï¼</li></ul><h2 id="2-Android-Pä¹‹å‰fsck-msdos"><a href="#2-Android-Pä¹‹å‰fsck-msdos" class="headerlink" title="2.Android Pä¹‹å‰fsck_msdos"></a>2.Android Pä¹‹å‰fsck_msdos</h2><p>å‰é¢è¯»å–bootblockå•¥çš„éƒ½æ¯”è¾ƒç®€å•å°±ä¸è´´äº†ï¼</p><h3 id="2-1-è¯»å–fatè¡¨readfat"><a href="#2-1-è¯»å–fatè¡¨readfat" class="headerlink" title="2.1 è¯»å–fatè¡¨readfat"></a>2.1 è¯»å–fatè¡¨readfat</h3><p>è¿™é‡Œå…ˆåªçœ‹FAT32ï¼Œå…¶ä½™çš„FAT12å’ŒFAT16éƒ½æ˜¯å¤§å·®ä¸å·®çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">readfat</span><span class="hljs-params">(<span class="hljs-type">int</span> fs, <span class="hljs-keyword">struct</span> bootblock *boot, <span class="hljs-type">int</span> no, <span class="hljs-keyword">struct</span> fatEntry **fp)</span> &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fatEntry</span> *<span class="hljs-title">fat</span>;</span><br>u_char *buffer, *p;<br><span class="hljs-type">cl_t</span> cl;<br><span class="hljs-type">int</span> ret = FSOK;<br><br>boot-&gt;NumFree = boot-&gt;NumBad = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// è¯»å–FATåˆ°bufferä¸­</span><br><span class="hljs-keyword">if</span> (!_readfat(fs, boot, no, &amp;buffer))<br><span class="hljs-keyword">return</span> FSFATAL;<br><br>    <span class="hljs-comment">// åˆ†é…å†…å­˜ï¼šæœ€å¤§ä¸º4Gï¼Œå…·ä½“è§ç¬¬4èŠ‚</span><br>fat = <span class="hljs-built_in">calloc</span>(boot-&gt;NumClusters, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> fatEntry));<br><br><span class="hljs-keyword">switch</span> (boot-&gt;ClustMask) &#123;<br><span class="hljs-keyword">case</span> CLUST32_MASK:<br>p = buffer + <span class="hljs-number">8</span>;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">for</span> (cl = CLUST_FIRST; cl &lt; boot-&gt;NumClusters;) &#123;<br><span class="hljs-keyword">switch</span> (boot-&gt;ClustMask) &#123;<br><span class="hljs-keyword">case</span> CLUST32_MASK:<br>fat[cl].next = p[<span class="hljs-number">0</span>] + (p[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) + (p[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">16</span>) + (p[<span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">24</span>);  <span class="hljs-comment">// è¯»å–4ä¸ªå­—èŠ‚</span><br>fat[cl].next &amp;= boot-&gt;ClustMask; <span class="hljs-comment">// ä¸æ“ä½œï¼Œé€šè¿‡æ©ç è¿‡æ»¤å‰4ä½(ä¿ç•™ä½)</span><br>ret |= checkclnum(boot, no, cl, &amp;fat[cl].next); <span class="hljs-comment">// æ£€éªŒç°‡çš„åˆæ³•æ€§</span><br>cl++; <span class="hljs-comment">// ç°‡++</span><br>p += <span class="hljs-number">4</span>; <span class="hljs-comment">// æ¯ä¸€ä¸ªç°‡æ˜¯4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥é€’å¢4</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">free</span>(buffer);<br>*fp = fat;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-æ£€æŸ¥fatè¡¨é¡¹checkfat"><a href="#2-2-æ£€æŸ¥fatè¡¨é¡¹checkfat" class="headerlink" title="2.2 æ£€æŸ¥fatè¡¨é¡¹checkfat"></a>2.2 æ£€æŸ¥fatè¡¨é¡¹checkfat</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// external/fsck_msdos/fat.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">checkfat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bootblock *boot, <span class="hljs-keyword">struct</span> fatEntry *fat)</span><br>&#123;<br><span class="hljs-type">cl_t</span> head, p, h, n;<br>u_int len;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> conf;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * pass 1: ç¡®å®šæ‰€æœ‰çš„ç°‡é“¾</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (head = CLUST_FIRST; head &lt; boot-&gt;NumClusters; head++) &#123;<br><span class="hljs-comment">/* find next untravelled chain */</span><br><span class="hljs-keyword">if</span> (fat[head].head != <span class="hljs-number">0</span><span class="hljs-comment">/* å¦‚æœå½“å‰çš„headä¸æ˜¯0ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»éš¶å±äºå¦å¤–ä¸€æ¡ç°‡é“¾äº† */</span><br>    || fat[head].next == CLUST_FREE<br>    || fat[head].next == CLUST_BAD)<br><span class="hljs-keyword">continue</span>;<span class="hljs-comment">/* skip it. */</span><br><br><span class="hljs-comment">/* éå†ç°‡é“¾ï¼šå°†é“¾ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰çš„ç°‡é“¾å¤´head */</span><br><span class="hljs-keyword">for</span> (len = <span class="hljs-number">0</span>, p = head;<br>     p &gt;= CLUST_FIRST &amp;&amp; p &lt; boot-&gt;NumClusters &amp;&amp;<br>     fat[p].head != head;<br>     p = fat[p].next) &#123;<br>fat[p].head = head;<br>len++;<br>&#125;<br><br><span class="hljs-comment">/* ç»™ç°‡é“¾å¤´è®¾ç½®ç°‡é“¾é•¿åº¦ */</span><br>fat[head].length = fat[head].next == CLUST_FREE ? <span class="hljs-number">0</span> : len;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * pass 2: æ£€æŸ¥æ˜¯å¦æœ‰äº¤å‰é“¾</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (head = CLUST_FIRST; head &lt; boot-&gt;NumClusters; head++) &#123;<br><span class="hljs-comment">/* æ‰¾åˆ°ç°‡é“¾å¤´ */</span><br><span class="hljs-keyword">if</span> (fat[head].head != head)<br><span class="hljs-keyword">continue</span>;<br>        <span class="hljs-comment">// é€€å‡ºå¾ªç¯çš„æ¡ä»¶æœ‰2ä¸ª</span><br>        <span class="hljs-comment">// 1.å‡ºç°äº¤å‰é“¾ï¼Œä¹Ÿå°±æ˜¯fat[n].fat.head!=head</span><br>        <span class="hljs-comment">// 2.ç°‡é“¾å·²ç»æŸå</span><br><span class="hljs-keyword">for</span> (p = head,wdk=boot-&gt;NumClusters;<br>     (n = fat[p].next) &gt;= CLUST_FIRST &amp;&amp; n &lt; boot-&gt;NumClusters &amp;&amp; wdk;p = n,wdk--) &#123;<br><span class="hljs-keyword">if</span> (fat[n].head != head)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>        <span class="hljs-comment">// æƒ…å†µä¸€ï¼šå¦‚æœæ˜¯æ­£å¸¸çš„ç»“å°¾ï¼šåŒ…æ‹¬FATç»“å°¾æˆ–è€…æ–‡ä»¶ç°‡é“¾ç»“å°¾</span><br><span class="hljs-keyword">if</span> (n &gt;= CLUST_EOFS)<br><span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// æƒ…å†µäºŒï¼šå½“å‰ç°‡æ˜¯ç©ºé—²çš„æˆ–è€…åœ¨ä¿ç•™ç°‡åŒºåŸŸå†…</span><br><span class="hljs-keyword">if</span> (n == CLUST_FREE || n &gt;= CLUST_RSRVD) &#123;<br>pwarn(<span class="hljs-string">&quot;Cluster chain starting at %u ends with cluster marked %s\n&quot;</span>, head, rsrvdcltype(n));<br>ret |= tryclear(boot, fat, head, &amp;fat[p].next);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>        <span class="hljs-comment">// æƒ…å†µä¸‰ï¼šå½“å‰ç°‡åœ¨å‰2ä¸ªç°‡ä»¥å†…æˆ–è¶…å‡ºç°‡æ•°é‡</span><br><span class="hljs-keyword">if</span> (n &lt; CLUST_FIRST || n &gt;= boot-&gt;NumClusters) &#123;<br>pwarn(<span class="hljs-string">&quot;Cluster chain starting at %u ends with cluster out of range (%u)\n&quot;</span>, head, n);<br>ret |= tryclear(boot, fat, head, &amp;fat[p].next);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>        <span class="hljs-comment">// æƒ…å†µå››ï¼šå‡ºç°äº†äº¤å‰é“¾</span><br>pwarn(<span class="hljs-string">&quot;Cluster chains starting at %u and %u are linked at cluster %u\n&quot;</span>, head, fat[n].head, n);<br>conf = tryclear(boot, fat, head, &amp;fat[p].next);<br>ret |= conf;<br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥ç¬¬1èŠ‚ä¸­çš„äº¤å‰é“¾ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œæ­¤æ—¶2ä¸ªé“¾çš„æƒ…å†µåˆ†åˆ«å¦‚ä¸‹ï¼š</p><ul><li>ç°‡é“¾1ï¼š3-&gt;5-&gt;7-&gt;8</li></ul><table><thead><tr><th>èŠ‚ç‚¹</th><th>3</th><th>5</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>ç°‡å€¼</td><td>5</td><td>7</td><td>8</td><td>EOF</td></tr><tr><td>å¤´</td><td>3</td><td>3</td><td>3</td><td>3</td></tr></tbody></table><ul><li>ç°‡é“¾2ï¼š4-&gt;6-&gt;7-&gt;8</li></ul><table><thead><tr><th>èŠ‚ç‚¹</th><th>4</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>ç°‡å€¼</td><td>6</td><td>7</td><td>8</td><td>EOF</td></tr><tr><td>å¤´</td><td>4</td><td>4</td><td>4</td><td>4</td></tr></tbody></table><p>è¯´æ˜ä¸€ä¸‹ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼š</p><ol><li>å½“éå†ç¬¬ä¸€ä¸ªç°‡é“¾æ—¶ï¼Œå‘ç°fat[7].next &#x3D; 8ï¼Œæ­¤æ—¶fat[7].head &#x3D; 3ï¼ŒåŒç†fat[8].head &#x3D; 3</li><li>ä½†æ˜¯å½“éå†ç¬¬äºŒå“¥ç°‡é“¾æ—¶ï¼Œfat[7].head &#x3D; 4ï¼ŒåŒç†fat[8].head &#x3D; 4</li></ol><p>å› æ­¤äº¤å‰é“¾å‡ºç°ï¼Œåœ¨p<strong>ass 2: æ£€æŸ¥æ˜¯å¦æœ‰äº¤å‰é“¾</strong>æ—¶ï¼Œå°±ä¼šæ£€æµ‹å‡ºè¿™æ˜¯äº¤å‰é“¾ï¼Œå› æ­¤æ­¤æ—¶<strong>fat[7].head !&#x3D; 3</strong></p><p>â­æ­¤æ—¶å°±ä¼šè§¦å‘ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯tryclearæ¸…é™¤äº¤å‰é“¾ï¼Œæ€»å…±æœ‰2ç§ç©æ³•ï¼š</p><ul><li>è°ƒç”¨clearchainæ¸…ç†äº¤å‰ç‚¹çš„ç°‡ï¼Œå…¨éƒ¨è®¾ç½®ä¸ºFREEã€è¿™æ ·ç ´åçš„å°±æ˜¯ç¬¬ä¸€ä¸ªç°‡é“¾ã€‘</li><li>ç›´æ¥å°†äº¤å‰ç‚¹å¤„è®¾ç½®ä¸ºCLUST_EOFã€è¿™æ ·ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªç°‡é“¾éƒ½è¢«ç ´åäº†ã€‘</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tryclear</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bootblock *boot, <span class="hljs-keyword">struct</span> fatEntry *fat, <span class="hljs-type">cl_t</span> head, <span class="hljs-type">cl_t</span> *trunc)</span><br>&#123;<br><span class="hljs-keyword">if</span> (ask(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Clear chain starting at %u&quot;</span>, head)) &#123;<br>clearchain(boot, fat, head);<br><span class="hljs-keyword">return</span> FSFATMOD;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ask(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Truncate&quot;</span>)) &#123;<br>*trunc = CLUST_EOF;<br><span class="hljs-keyword">return</span> FSFATMOD;<br>&#125; <span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> FSERROR;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">clearchain</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bootblock *boot, <span class="hljs-keyword">struct</span> fatEntry *fat, <span class="hljs-type">cl_t</span> head)</span><br>&#123;<br><span class="hljs-type">cl_t</span> p, q;<br><br>   <span class="hljs-comment">// éå†ç¬¬ä¸€æ¡ç°‡é“¾ï¼Œå°†ç°‡é“¾çš„äº¤å‰ç‚¹ä¹‹å‰æˆªæ–­ï¼Œå…¨éƒ¨è®¾ç½®ä¸ºFREE</span><br><span class="hljs-keyword">for</span> (p = head; p &gt;= CLUST_FIRST &amp;&amp; p &lt; boot-&gt;NumClusters; p = q) &#123;<br><span class="hljs-keyword">if</span> (fat[p].head != head)<br><span class="hljs-keyword">break</span>;<br>q = fat[p].next;<br>fat[p].next = fat[p].head = CLUST_FREE;<br>fat[p].length = <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-Android-Så¼€å§‹fsck-msdosçš„å¤„ç†"><a href="#3-Android-Så¼€å§‹fsck-msdosçš„å¤„ç†" class="headerlink" title="3.Android Så¼€å§‹fsck_msdosçš„å¤„ç†"></a>3.Android Så¼€å§‹fsck_msdosçš„å¤„ç†</h2><p>æ­¤å¤„æ˜¯<strong>Li Xin</strong>å¤§ä½¬æäº¤çš„ä»£ç ï¼Œæ•…è€Œæ‹œè¯»å…¶æ–‡ç« åä¸å¾—èµå¹ï¼Œç°è´´å‡ºå…¶æ€æƒ³å­¦ä¹ ï¼š<a href="https://blog.delphij.net/posts/2021/06/fsck_msdosfs/">https://blog.delphij.net/posts/2021/06/fsck_msdosfs/</a></p><blockquote><p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ˜¯åœ¨æ£€æŸ¥æ˜¯å¦å‡ºç°äº†äº¤å‰é“¾ï¼Œé‚£ä¹ˆæ–°çš„ç®—æ³•å¦‚ä¸‹ï¼š</p><p>å…ˆå‡å®šæ‰€æœ‰çš„ç°‡éƒ½æ˜¯é“¾å¤´ï¼Œç„¶åä¸€æ¬¡éå†æ•´ä¸ªçº¿æ€§è¡¨ï¼Œå°†è¢« <code>next</code> æŒ‡é’ˆå¼•ç”¨çš„ç°‡æ ‡è®°ä¸ºä¸æ˜¯é“¾å¤´ã€‚æ­¤æ–¹æ³•åªéœ€éå†æ•´ä¸ªçº¿æ€§è¡¨ï¼Œå³ <code>O(N)</code>ã€‚ ç”±æ­¤ï¼Œæˆ‘ä»¬å°†è·å¾—ä¸€ä¸ªè¡¨ç¤ºå¯¹åº”ç°‡æ˜¯å¦æ˜¯ç°‡é“¾å¤´çš„ä½æ˜ å°„å›¾ ï¼ˆ<code>headbitmap</code>ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ ‡è®°çš„æ˜¯æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯é“¾å¤´ï¼Œè€Œå¹¶ä¸çŸ¥é“è¯¥èŠ‚ç‚¹å¯¹åº”çš„é“¾å¤´æ˜¯è°ï¼Œ è‡ªç„¶ä¹Ÿå°±æ— ä»ç«‹å³çŸ¥æ™“ç°‡é“¾çš„é•¿åº¦ã€‚è¯¥ä»»åŠ¡å¯ä»¥å»¶ååˆ°æ£€æŸ¥ç›®å½•é¡¹å®Œæ•´æ€§çš„éƒ¨åˆ†æ¥è¿›è¡Œï¼Œ å› ä¸ºç›®å½•é¡¹ä¸­ä¿å­˜äº†é“¾ç°‡å¤´èŠ‚ç‚¹çš„ä½ç½®ï¼Œæ•…è€Œåªéœ€åˆ¤æ–­è¯¥ç°‡æ˜¯å¦æ˜¯é“¾å¤´ï¼Œå¦‚æœæ˜¯ï¼Œ åˆ™æ²¿ç€è¯¥ç°‡é“¾é€ä¸ªéå†ç›´åˆ°æ‰¾åˆ°é“¾å°¾å¹¶è®¡ç®—é•¿åº¦ã€‚</p></blockquote><h3 id="3-1-è¯»å–fatè¡¨-readfat"><a href="#3-1-è¯»å–fatè¡¨-readfat" class="headerlink" title="3.1 è¯»å–fatè¡¨_readfat"></a>3.1 è¯»å–fatè¡¨_readfat</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br>_readfat(<span class="hljs-keyword">struct</span> fat_descriptor *fat)<br>&#123;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">size_t</span> i;<br><span class="hljs-type">off_t</span> off;<br><span class="hljs-type">size_t</span> readsize;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bootblock</span> *<span class="hljs-title">boot</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fat32_cache_entry</span> *<span class="hljs-title">entry</span>;</span><br><br>boot = boot_of_(fat);<br>fd = fd_of_(fat);<br>fat-&gt;fatsize = boot-&gt;FATsecs * boot-&gt;bpbBytesPerSec;<br><br>off = boot-&gt;bpbResSectors;<br>off *= boot-&gt;bpbBytesPerSec;<br><br>fat-&gt;is_mmapped = <span class="hljs-literal">false</span>;<br>fat-&gt;use_cache = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">/* Attempt to mmap() first */</span><br><span class="hljs-keyword">if</span> (allow_mmap) &#123;<br>fat-&gt;fatbuf = mmap(<span class="hljs-literal">NULL</span>, fat-&gt;fatsize,<br>PROT_READ | (rdonly ? <span class="hljs-number">0</span> : PROT_WRITE),<br>MAP_SHARED, fd_of_(fat), off);<br><span class="hljs-keyword">if</span> (fat-&gt;fatbuf != MAP_FAILED) &#123;<br>fat-&gt;is_mmapped = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Unfortunately, we were unable to mmap().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Only use the cache manager when it&#x27;s necessary, that is,</span><br><span class="hljs-comment"> * when the FAT is sufficiently large; in that case, only</span><br><span class="hljs-comment"> * read in the first 4 MiB of FAT into memory, and split the</span><br><span class="hljs-comment"> * buffer into chunks and insert to the LRU queue to populate</span><br><span class="hljs-comment"> * the cache with data.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (boot-&gt;ClustMask == CLUST32_MASK &amp;&amp;<br>    fat-&gt;fatsize &gt;= fat32_cache_size) &#123;<br>readsize = fat32_cache_size;<br>fat-&gt;use_cache = <span class="hljs-literal">true</span>;<br><br>fat-&gt;fat32_offset = boot-&gt;bpbResSectors * boot-&gt;bpbBytesPerSec;<br>fat-&gt;fat32_lastaddr = fat-&gt;fatsize &amp; ~(fat32_cache_chunk_size);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>readsize = fat-&gt;fatsize;<br>&#125;<br>fat-&gt;fatbuf = <span class="hljs-built_in">malloc</span>(readsize);<br><span class="hljs-keyword">if</span> (fat-&gt;fatbuf == <span class="hljs-literal">NULL</span>) &#123;<br>perr(<span class="hljs-string">&quot;No space for FAT (%zu)&quot;</span>, readsize);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (lseek(fd, off, SEEK_SET) != off) &#123;<br>perr(<span class="hljs-string">&quot;Unable to read FAT&quot;</span>);<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><span class="hljs-keyword">if</span> ((<span class="hljs-type">size_t</span>)read(fd, fat-&gt;fatbuf, readsize) != readsize) &#123;<br>perr(<span class="hljs-string">&quot;Unable to read FAT&quot;</span>);<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When cache is used, split the buffer into chunks, and</span><br><span class="hljs-comment"> * connect the buffer into the cache.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (fat-&gt;use_cache) &#123;<br>TAILQ_INIT(&amp;fat-&gt;fat32_cache_head);<br>entry = <span class="hljs-built_in">calloc</span>(fat32_cache_entries, <span class="hljs-keyword">sizeof</span>(*entry));<br><span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">NULL</span>) &#123;<br>perr(<span class="hljs-string">&quot;No space for FAT cache (%zu of %zu)&quot;</span>,<br>    fat32_cache_entries, <span class="hljs-keyword">sizeof</span>(entry));<br><span class="hljs-keyword">goto</span> err;<br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; fat32_cache_entries; i++) &#123;<br>entry[i].addr = fat32_cache_chunk_size * i;<br>entry[i].chunk = &amp;fat-&gt;fatbuf[entry[i].addr];<br>TAILQ_INSERT_TAIL(&amp;fat-&gt;fat32_cache_head,<br>    &amp;entry[i], entries);<br>&#125;<br>fat-&gt;fat32_cache_allentries = entry;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>err:<br><span class="hljs-built_in">free</span>(fat-&gt;fatbuf);<br>fat-&gt;fatbuf = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æåˆ°ï¼ŒFAT32æœ€å¤šå¯ä»¥æœ‰ 2^28 ä¸ªç°‡ï¼Œè¿™éœ€è¦å ç”¨ 1GiB çš„ç©ºé—´ã€‚ç¬¬ä¸€éæ‰«ææ—¶æˆ‘ä»¬æ˜¯æŠŠ FAT ä½œä¸ºä¸€ä¸ªçº¿æ€§è¡¨æ¥åšçº¿æ€§æ‰«æçš„ï¼Œå®Œå…¨æ²¡æœ‰ä»»ä½•å¿…è¦å°†å…¶æ•´ä¸ªè½½å…¥å†…å­˜ã€‚ä¹‹åæ£€æŸ¥ç›®å½•é¡¹æ—¶ï¼Œ åœ¨æç«¯æƒ…å†µï¼ˆæ–‡ä»¶ç³»ç»Ÿéå¸¸ç¢å—åŒ–ï¼‰æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šéœ€è¦åå¤è®¿é—®FATçš„ä¸åŒåŒºåŸŸã€‚</p><p>ç»¼åˆä»¥ä¸Šè€ƒè™‘ï¼Œä¸€ä¸ªæ˜¾ç„¶çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å¢åŠ ä¸€ä¸ªç¼“å­˜å±‚ï¼Œå¹¶å°†åŸå…ˆå®ç°ä¸­ç›´æ¥è¯»å†™ FAT å†…éƒ¨è¡¨ç°å½¢å¼çš„éƒ¨åˆ†æ”¹å†™ä¸ºç›´æ¥ä½¿ç”¨ä¸€ä¸ªæŠ½è±¡çš„è®¿é—®å‡½æ•°æ¥è¿›è¡Œæ“ä½œï¼Œå¹¶å°†ç¼“å­˜çš„é—®é¢˜äº¤ç»™ç¼“å­˜å±‚æ¥è¿›è¡Œã€‚ æ“ä½œç³»ç»Ÿå·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„ç¼“å­˜å®ç°ï¼Œå› æ­¤å¦‚æœèƒ½ç”¨çš„è¯ç›´æ¥ <code>mmap(2)</code> æ˜¯æœ€ä½³ç­–ç•¥ï¼› å¦‚æœä¸èƒ½ï¼Œåˆ™é€€è€Œæ±‚å…¶æ¬¡ï¼Œè‡ªå·±å®ç°ä¸€ä¸ª LRU é˜Ÿåˆ—ã€‚</p><p>å‰é¢æåˆ° FAT12 å’Œ FAT16 çš„æœ€å¤§å°ºå¯¸éƒ½è¶³å¤Ÿå°ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å°†å…¶æ”¾è¿›å†…å­˜ã€‚FAT32 åˆ™åˆ†ä¸¤ç§æƒ…å†µï¼Œ å¯¹äºèƒ½ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ç³»ç»Ÿçš„æƒ…å†µï¼Œæˆ‘ä»¬åªéœ€æŠŠæ•´ä¸ª FAT æ˜ å°„åˆ°å†…å­˜ä¸­å¹¶å½“ä½œä¸€ä¸ªå¤§æ•°ç»„è®¿é—®å³å¯ï¼› å¯¹äºè‡ªè¡Œå®ç° LRU é˜Ÿåˆ—çš„æƒ…å†µï¼Œåˆ™åˆ›å»ºä¸€ä¸ª LRU ç¼“å­˜æ± ï¼ˆå°ºå¯¸æ˜¯æ‹è„‘é—¨å®šçš„ 4MiBï¼Œ æ¯ä¸ªç¼“å­˜å—æ˜¯ 128kiBï¼‰ã€‚</p><p>LRU çš„å®ç°è¿‡äºç®€å•ä¸”å¹¶æ— ç‰¹åˆ«ï¼Œå†æ¬¡ä¸å†èµ˜è¿°ï¼Œæ·˜æ±°æ—¶å¦‚æœç¼“å­˜å—å‘ç”Ÿè¿‡å†™æ“ä½œï¼Œåˆ™å°†å…¶å†™å›ç£ç›˜åŸä½ç½®ã€‚</p><h3 id="3-2-é€šè¿‡ä½å›¾æ£€æŸ¥è¡¨é¡¹"><a href="#3-2-é€šè¿‡ä½å›¾æ£€æŸ¥è¡¨é¡¹" class="headerlink" title="3.2 é€šè¿‡ä½å›¾æ£€æŸ¥è¡¨é¡¹"></a>3.2 é€šè¿‡ä½å›¾æ£€æŸ¥è¡¨é¡¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * éå† FAT è¡¨å¹¶åˆ›å»ºç°‡é“¾å¤´ä½å›¾ã€‚</span><br><span class="hljs-comment"> * é¦–å…ˆå‡å®šæ¯ä¸€ä¸ªç°‡éƒ½æ˜¯ä¸€ä¸ªç°‡é“¾çš„å¤´ï¼Œç„¶åéå†æ•´ä¸ª FAT è¡¨ï¼Œ</span><br><span class="hljs-comment"> * å¹¶å°†å…¶ä¸­ä¸æ˜¯ç°‡é“¾å¤´ï¼Œå³é‚£äº›æœ‰å…¶ä»–ç°‡å°†å…¶æŒ‡ä¸ºåç»§èŠ‚ç‚¹çš„é‚£äº›ç°‡ä»è¯¥ä½å›¾ä¸­åˆ å»ï¼Œ</span><br><span class="hljs-comment">         * åœ¨æ­¤è¿‡ç¨‹ä¸­ä¿®å¤ä¸€äº›æ˜æ˜¾çš„é—®é¢˜ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ¯ä¸ª &quot;next&quot; ç°‡çš„å¯èƒ½å–å€¼å¦‚ä¸‹ï¼š</span><br><span class="hljs-comment"> * a) CLUST_FREE æˆ– CLUST_BADã€‚å½“å‰ç°‡ä¸å¯èƒ½æ˜¯ç°‡é“¾èµ·ç‚¹ã€‚</span><br><span class="hljs-comment"> * b) è¶…å‡ºèŒƒå›´çš„å€¼ã€‚æ­¤æ—¶å¿…é¡»å°†ç°‡é“¾åœ¨æ­¤å¤„åˆ‡æ–­ã€‚</span><br><span class="hljs-comment"> * c) æœ‰æ•ˆç°‡ã€‚è¿™è¯´æ˜æ­¤ç°‡ (nextcl) ä¸å¯èƒ½æ˜¯ç°‡é“¾èµ·ç‚¹ã€‚</span><br><span class="hljs-comment"> *    åœ¨éå†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç°‡æœ€å¤šåªèƒ½è¢«ä¸€ä¸ªå…¶ä»–ç°‡æŒ‡ä¸ºä¸‹ä¸€ç°‡ï¼Œ</span><br><span class="hljs-comment"> *    å› æ­¤è‹¥è¯¥ç°‡å·²ç»è¢«æ ‡è®°ä¸ºä¸æ˜¯ç°‡èµ·ç‚¹ï¼Œåˆ™è¡¨ç¤ºå‡ºç°äº†é“¾äº¤å‰çš„æƒ…å†µï¼Œ</span><br><span class="hljs-comment"> *    æ­¤æ—¶åªèƒ½åœ¨å½“å‰ç°‡åˆ‡æ–­ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å®Œæˆæ­¤æ‰«æä¹‹åï¼Œç°‡é“¾å¤´ä½å›¾ä¸­ä»ç„¶ä¸º1çš„å°±æ˜¯æ‰€æœ‰æ½œåœ¨çš„ç°‡é“¾å¤´äº†ã€‚</span><br><span class="hljs-comment"> * ä¸è¿‡æˆ‘ä»¬æš‚æ—¶è¿˜ä¸çŸ¥é“å®ƒä»¬æ˜¯å¦ä»¥æ­£ç¡®çš„EOFç»ˆç»“ï¼Œä¹Ÿä¸çŸ¥é“å®ƒä»¬çš„é•¿åº¦ã€‚</span><br><span class="hljs-comment">         * è¿™å°†åœ¨æ£€æŸ¥ç›®å½•ç»“æ„æ—¶ç”± checkchain() è¿›è¡Œï¼Œ</span><br><span class="hljs-comment">         * ç”±äºç°‡é“¾åªèƒ½å±äºä¸€ä¸ªæ–‡ä»¶ï¼Œå› æ­¤æ£€æŸ¥è¿‡çš„ç°‡é“¾å¤´ä¹Ÿå°†ä»ä½å›¾ä¸­æ¸…é™¤ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æœ€ç»ˆï¼Œä½å›¾ä¸­ä½™ä¸‹çš„ç°‡é“¾å¤´å³ä¸ºä¸¢å¤±ç°‡é“¾å¤´ã€‚</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">for</span> (cl = CLUST_FIRST; cl &lt; boot-&gt;NumClusters; cl++) &#123;<br>    nextcl = fat_get_cl_next(fat, cl);<br><br>    <span class="hljs-comment">/* æ£€æŸ¥ nextcl æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´ */</span><br>    <span class="hljs-keyword">if</span> (nextcl == CLUST_FREE) &#123;<br>        <span class="hljs-comment">/* å¦‚æœå°šä¸çŸ¥é“æœ€åä¸€ä¸ªæœªåˆ†é…ç°‡åœ¨å“ªï¼Œä¿å­˜è¯¥ç°‡å· */</span><br>        <span class="hljs-keyword">if</span> (boot-&gt;FSNext == <span class="hljs-number">0</span>) &#123;<br>            boot-&gt;FSNext = cl;<br>        &#125;<br>        <span class="hljs-comment">/* è¯¥ç°‡ä¸å¯èƒ½æ˜¯ç°‡é“¾å¤´ï¼Œæ ‡è®° */</span><br>        <span class="hljs-keyword">if</span> (fat_is_cl_head(fat, cl)) &#123;<br>            fat_clear_cl_head(fat, cl);<br>        &#125;<br>        <span class="hljs-comment">/* è®°è´¦ */</span><br>        boot-&gt;NumFree++;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextcl == CLUST_BAD) &#123;<br>        <span class="hljs-comment">/* è¯¥ç°‡ä¸å¯èƒ½æ˜¯ç°‡é“¾å¤´ï¼Œæ ‡è®° */</span><br>        <span class="hljs-keyword">if</span> (fat_is_cl_head(fat, cl)) &#123;<br>            fat_clear_cl_head(fat, cl);<br>        &#125;<br>        <span class="hljs-comment">/* è®°è´¦ */</span><br>        boot-&gt;NumBad++;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!valid_cl(fat, nextcl) &amp;&amp; nextcl &lt; CLUST_RSRVD) &#123;<br>        <span class="hljs-comment">/* æ— æ•ˆç°‡å·ï¼Œåˆ‡æ–­ */</span><br>        pwarn(<span class="hljs-string">&quot;Cluster %u continues with out of range &quot;</span><br>              <span class="hljs-string">&quot;cluster number %u\n&quot;</span>,<br>              cl,<br>              nextcl &amp; boot-&gt;ClustMask);<br>        <span class="hljs-keyword">if</span> (ask(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;Truncate&quot;</span>)) &#123;<br>            ret |= fat_set_cl_next(fat, cl, CLUST_EOF);<br>            ret |= FSFATMOD;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valid_cl(fat, nextcl)) &#123;<br>        <span class="hljs-comment">/* æœ‰æ•ˆç°‡å·ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–ç°‡é“¾å¼•ç”¨è¿‡ï¼Œåˆ™è¯¥ç°‡ä¸€å®šä¸æ˜¯ç°‡é“¾å¤´ */</span><br>        <span class="hljs-keyword">if</span> (fat_is_cl_head(fat, nextcl)) &#123;<br>            fat_clear_cl_head(fat, nextcl);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/* å‡ºç°äº†äº¤å‰ */</span><br>            pwarn(<span class="hljs-string">&quot;Cluster %u crossed another chain at %u\n&quot;</span>,<br>                  cl, nextcl);<br>            <span class="hljs-keyword">if</span> (ask(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;Truncate&quot;</span>)) &#123;<br>                ret |= fat_set_cl_next(fat, cl, CLUST_EOF);<br>                ret |= FSFATMOD;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åˆå§‹çŠ¶æ€ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯ç°‡å¤´ï¼š</li></ul><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703231451831.png" alt="image-20230703231451831" style="zoom:67%;"><ul><li>éå†åˆ°3çš„æ—¶å€™ï¼Œè¿™æ—¶å€™nextcl&#x3D;5ï¼Œåˆ™æ­¤æ—¶æ˜¯5æœ‰æ•ˆçš„ç°‡å¤´ï¼Œéœ€è¦åœ¨ä½å›¾ä¸­æ¸…ç†ï¼Œç½®ä¸ºF</li></ul><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703231548196.png" alt="image-20230703231548196" style="zoom:67%;"><ul><li>éå†åˆ°4çš„æ—¶å€™ï¼Œè¿™æ—¶å€™nextcl&#x3D;6ï¼Œåˆ™æ­¤æ—¶æ˜¯6æ˜¯æœ‰æ•ˆçš„ç°‡å¤´ï¼Œéœ€è¦ä¸ºä½å›¾ä¸­æ¸…ç†ï¼Œç½®ä¸ºF</li></ul><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703231704977.png" alt="image-20230703231704977" style="zoom:67%;"><ul><li>éå†åˆ°5çš„æ—¶å€™ï¼Œè¿™æ—¶å€™nextcl&#x3D;6ï¼Œæ­¤æ—¶å‘ç°<strong>6å·²ç»ä¸æ˜¯ç°‡å¤´</strong>äº†ï¼Œè¯´æ˜ä¹‹å‰å·²ç»æœ‰ä¸€ä¸ªé“¾å ç”¨äº†å®ƒï¼Œé‚£ä¹ˆæ­¤æ—¶å·²ç»å‘ç”Ÿäº†äº¤å‰</li></ul><h2 id="4-ä¸¤è€…çš„å·®å¼‚"><a href="#4-ä¸¤è€…çš„å·®å¼‚" class="headerlink" title="4.ä¸¤è€…çš„å·®å¼‚"></a>4.ä¸¤è€…çš„å·®å¼‚</h2><p>åœ¨Android Pé‡Œé¢ï¼Œæ˜¯å°†æ‰€æœ‰çš„Fat entryéƒ½è¯»å–åˆ°fatEntryè¿™ä¸ªæ•°ç»„ä¸­ï¼Œæœ€åä¸€ä¸ªä¸ªéå†fatEntryè®¾ç½®æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„headæ¥æ£€éªŒæ˜¯å¦äº¤å‰ï¼š</p><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703232110410.png" alt="image-20230703232110410" style="zoom:50%;"><p>å…¶å¼€è¾Ÿçš„å†…å­˜callocä¸º <code>NumberClusters * sizeof(fatEntry)</code></p><ul><li>å·²çŸ¥Fat32æœ€å¤§æ”¯æŒçš„ç°‡ä¸º2^28ã€è™½ç„¶ä¸€ä¸ªç°‡æ˜¯32ä½ï¼Œä½†æ˜¯å‰4ä½æ˜¯ä¿ç•™çš„ï¼Œåªç”¨äº†28ä½ã€‘</li><li>fatEntryçš„å¤§å°ä¸º16å­—èŠ‚ã€æ­¤å¤„å·²ç»è¿›è¡Œäº†å†…å­˜å¯¹é½ï¼Œéƒ½æ˜¯32ä½ã€‘</li><li>æœ€ç»ˆå¼€è¾Ÿçš„å†…å­˜ä¸º 2^32(Byte)&#x3D;4(GB)</li></ul><hr><p>è€ŒAndroid Sé‡Œé¢æ˜¯é€šè¿‡ä½å›¾æ¥æ£€éªŒæ˜¯å¦å‘ç”Ÿäº†äº¤å‰</p><img src="/2023/07/03/fsck-msdos%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230703232906748.png" alt="image-20230703232906748" style="zoom: 50%;"><p>ç›¸è¾ƒäºä¹‹å‰çš„ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºfat_descriptorå¼€è¾Ÿçš„å†…å­˜æ˜¯å¾®ä¹å…¶å¾®çš„ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>fatæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ä¸€æœ¬é€š</title>
    <link href="/2023/06/30/fat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%9C%AC%E9%80%9A/"/>
    <url>/2023/06/30/fat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E4%B8%80%E6%9C%AC%E9%80%9A/</url>
    
    <content type="html"><![CDATA[<h1 id="fatæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ä¸€æœ¬é€š"><a href="#fatæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ä¸€æœ¬é€š" class="headerlink" title="fatæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ä¸€æœ¬é€š"></a>fatæ–‡ä»¶ç³»ç»Ÿå­¦ä¹ ä¸€æœ¬é€š</h1><p>ä¸‹é¢çš„æ˜¯å­¦ä¹ fatæ–‡ä»¶ç³»ç»Ÿçš„é¡ºåºï¼š</p><ul><li><p><a href="https://anmuxixixi.github.io/2023/06/29/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">vfatæ–‡ä»¶ç³»ç»Ÿ</a></p></li><li><p><a href="https://anmuxixixi.github.io/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">FATæ–‡ä»¶ç³»ç»ŸåŸç†</a></p></li><li><p><a href="https://anmuxixixi.github.io/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/">ã€å®éªŒã€‘å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®</title>
    <link href="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/"/>
    <url>/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®"><a href="#ã€å®éªŒã€‘å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®" class="headerlink" title="ã€å®éªŒã€‘å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®"></a>ã€å®éªŒã€‘å®šä½å’Œæå–FAT32åˆ†åŒºçš„æ–‡ä»¶æ•°æ®</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://ceyewan.top/p/27eb4295.html">https://ceyewan.top/p/27eb4295.html</a></p><p>ä»…ç”¨ä½œè‡ªå·±è®°å½•ï¼Œä¾µæƒè”ç³»åˆ é™¤ï¼</p></blockquote><h2 id="ä½¿ç”¨-winHex-åˆ†æ"><a href="#ä½¿ç”¨-winHex-åˆ†æ" class="headerlink" title="ä½¿ç”¨ winHex åˆ†æ"></a>ä½¿ç”¨ winHex åˆ†æ</h2><p>è¿™é‡Œè¦æ±‚çš„æ˜¯ç›´æ¥ä»ç£ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„å±‚é¢æ¥æå–æ•°æ®ã€‚éœ€è¦ç”¨åˆ°çš„å·¥å…·æ˜¯ winHex ã€‚æˆ‘ä»¬å°† U ç›˜æ ¼å¼åŒ–ä¸º FAT32 æ ¼å¼ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ winHex å°†æ‰“å¼€ç£ç›˜ã€‚å…ˆæŸ¥çœ‹ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼Œå¾—åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼Œå¯ä»¥æå–å‡ºä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005195218939.png" alt="image-20221005195218939" style="zoom: 67%;"><ul><li>ä¿ç•™æ‰‡åŒºæ•° 0x0842</li><li>æ¯ç°‡æ‰‡åŒºæ•° 0x08</li><li>æ¯æ‰‡åŒºå­—èŠ‚æ•° 0x0200</li><li>FATçš„ä¸ªæ•° 0x02</li><li>æ¯ä¸ª FAT å ç”¨çš„æ‰‡åŒºæ•° 0x00003BDF</li><li>BPB_RootClus 0x0002</li></ul><blockquote><p>FirstDataSector&#x3D;ä¿ç•™æ‰‡åŒºæ•° + (FATä¸ªæ•°*æ¯ä¸ªFATæ‰€å æ‰‡åŒºæ•°)</p><p>FirstSectorofCluster &#x3D; ((N-2)*æ¯ç°‡æ‰‡åŒºæ•°) + FirstDataSector</p></blockquote><p>æˆ‘ä»¬é€šè¿‡ä¸Šé¢å¯ä»¥æ±‚å‡ºæ ¹ç›®å½•çš„æ‰‡åŒºä¸ºï¼š <code>0x0842 + 0x02 * 0x3BDF = 0x8000 = 32768</code> ã€‚æ ¹ç›®å½•æ‰‡åŒºå­˜å‚¨çš„å†…å®¹å°±æ˜¯æ ¹ç›®å½•é‡Œçš„æ–‡ä»¶ï¼ˆå¤¹ï¼‰ã€‚æŸ¥çœ‹è¿™ä¸ªæ‰‡åŒºï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005200017391.png" alt="image-20221005200017391" style="zoom: 67%;"><p>å¯ä»¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶ï¼ˆå‰å…«ä¸ªå­—èŠ‚æ˜¯æ–‡ä»¶åï¼‰çš„èµ·å§‹ç°‡å·ä¸º 6 ï¼Œæ–‡ä»¶å¤§å°ä¸º <code>0x12E = 302</code> ï¼š</p><p>æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ FAT1 ï¼ˆæ‰‡åŒºä¸º <code>0x0842</code>ï¼‰ï¼ŒFAT2 æ˜¯ FAT1 çš„ä¸€ä¸ªå¤‡ä»½ï¼Œè¿™é‡Œé¢å­˜å‚¨çš„æ˜¯ç°‡é“¾ï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005200437307.png" alt="image-20221005200437307" style="zoom: 67%;"><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ 6 ä¸ªé¡¹å°±æ˜¯ä¸€ä¸ªç»“æŸé¡¹ï¼Œè¯´æ˜æˆ‘ä»¬çš„æ–‡ä»¶åªæœ‰è¿™ä¸€ä¸ªç°‡ã€‚</p><p>æ–‡ä»¶ç¬¬ 6 ç°‡çš„åç§» &#x3D; æ›´ç›®å½•é¦–ç°‡åç§» + ï¼ˆæ–‡ä»¶æŸç°‡å· - æ›´ç›®å½•é¦–ç°‡å·ï¼‰* æ¯ç°‡æ‰‡åŒºæ•°</p><p>&#x3D; 32768 + ï¼ˆ6 - 2ï¼‰* 8 &#x3D; 32800ï¼ŒæŸ¥çœ‹ç¬¬ 32800 åˆ° 32808 ä¸ªæ‰‡åŒºï¼ˆä¸€ç°‡æ˜¯å…«ä¸ªæ‰‡åŒºï¼‰ï¼Œå°±æ˜¯æ–‡ä»¶å†…å®¹ï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005200922882.png" alt="image-20221005200922882" style="zoom: 67%;"><p>ç°åœ¨æˆ‘ä»¬å†æ¥è€ƒè™‘å¤§æ–‡ä»¶çš„é•¿æ–‡ä»¶åæ–‡ä»¶ï¼Œé•¿æ–‡ä»¶åä¼šæˆªå–æ–‡ä»¶åçš„å‰ 6 ä¸ªå­—ç¬¦å’Œ ~iï¼ˆi å– 1 åˆ° 5ï¼Œä» 1 å¼€å§‹ï¼Œå¦‚æœæœ‰äº†å°±åç§»ï¼‰æ‹¼æ¥æˆçŸ­æ–‡ä»¶åã€‚çŸ­æ–‡ä»¶ç›®å½•é¡¹ä¸Šé¢æ˜¯å€’å™çš„é•¿æ–‡ä»¶ç›®å½•é¡¹ï¼Œæ³¨æ„ï¼Œä¸Šé¢é•¿æ–‡ä»¶ç›®å½•é¡¹ä½¿ç”¨çš„ unicode ç¼–ç ï¼ˆå¯èƒ½å› ä¸ºé•¿æ–‡ä»¶åä¸€èˆ¬éƒ½ä¸æ˜¯çº¯ ASCII ç å­—ç¬¦å§ï¼‰ï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005202953894.png" alt="image-20221005202953894" style="zoom: 67%;"><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œèµ·å§‹ç°‡å·ä¸º 7 ï¼Œå¤§å°ä¸º <code>0x15D20 = 89376</code> ã€‚ç»§ç»­æŸ¥çœ‹ FAT1ï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221005203255683.png" alt="image-20221005203255683" style="zoom: 67%;"><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ä½¿ç”¨äº†ä» 7 åˆ° <code>0x1C = 28</code> è¿™äº›ç°‡ï¼ŒåŒç†æŸ¥çœ‹ç¬¬ 7 ç°‡åˆ°ç¬¬ 28 ç°‡çš„å†…å®¹å³å¯ã€‚ä¹Ÿå°±æ˜¯æ‰‡åŒº 32808 åˆ° 32982 ã€‚æ³¨æ„ï¼Œæ¯ç°‡ 8 ä¸ªæ‰‡åŒºã€‚</p><h2 id="ç¼–ç å®ç°"><a href="#ç¼–ç å®ç°" class="headerlink" title="ç¼–ç å®ç°"></a>ç¼–ç å®ç°</h2><p>python çš„ read å°±å¯ä»¥ç›´æ¥è¯»å–ç£ç›˜ï¼Œè¯»å–åçš„æ–‡ä»¶å¯¹è±¡ disk å¯ä»¥é€šè¿‡ seek æ–¹æ³•æ§åˆ¶åç§»ï¼Œä»è€Œè¯»å–ä¸åŒä½ç½®çš„ç£ç›˜æ–‡ä»¶ã€‚æˆ‘ä»¬è¯»åˆ°çš„ä¸œè¥¿éƒ½æ˜¯äº› byte ç±»å‹ï¼Œè€Œä¸”å¾ˆå¥‡æ€ªï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬åŒ–ä¸º 16 è¿›åˆ¶ï¼Œå¯¹äº byte ç±»å‹çš„ä»¥ 16 è¿›åˆ¶è¡¨ç¤ºçš„æ•°è¿˜æ˜¯å¾ˆéš¾å¤„ç†ï¼Œå› æ­¤æˆ‘å°†å…¶è½¬åŒ–ä¸ºäº†å­—ç¬¦ä¸²ã€‚</p><ol><li>å°†ä»¥ä¸¤ä¸ªä¸€ç»„ï¼Œé€†åºï¼ˆå°ç«¯åºï¼‰çš„ 16 è¿›åˆ¶æ•°æ®è½¬åŒ–ä¸º 10 è¿›åˆ¶æ•°æ®ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_count</span>(<span class="hljs-params">s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    ans, beishu = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-built_in">dict</span> = &#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>(i)] = i<br>    <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>([<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>]):<br>        <span class="hljs-built_in">dict</span>[c] = i + <span class="hljs-number">10</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-number">2</span>):<br>        ans += (<span class="hljs-built_in">dict</span>[s[i]] * <span class="hljs-number">16</span> + <span class="hljs-built_in">dict</span>[s[i + <span class="hljs-number">1</span>]]) * beishu<br>        beishu *= <span class="hljs-number">16</span> * <span class="hljs-number">16</span><br>    <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><ol start="2"><li>è¯»å– DBR å¾—åˆ°ä¸€äº›æœ‰ç”¨çš„æ•°æ®ï¼Œæ ¹ç›®å½•çš„æ‰‡åŒºå·ï¼ŒFAT1 çš„æ‰‡åŒºå·ï¼Œæ¯ä¸ªæ‰‡åŒºçš„å­—èŠ‚æ•°ï¼Œæ ¹ç›®å½•çš„ç°‡å·å’Œæ¯ç°‡çš„æ‰‡åŒºæ•°:</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_DBR</span>(<span class="hljs-params">disk</span>):<br>    DBR = <span class="hljs-built_in">str</span>(binascii.hexlify(<br>        disk.read(<span class="hljs-number">512</span>)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]<br>    byte_per_sector = get_count(DBR[<span class="hljs-number">22</span>: <span class="hljs-number">26</span>])<br>    sector_per_clust = get_count(DBR[<span class="hljs-number">26</span>: <span class="hljs-number">28</span>])<br>    reserve_sector = get_count(DBR[<span class="hljs-number">28</span>: <span class="hljs-number">32</span>])<br>    count_fat = get_count(DBR[<span class="hljs-number">32</span>: <span class="hljs-number">34</span>])<br>    count_sector = get_count(DBR[<span class="hljs-number">64</span>: <span class="hljs-number">72</span>])<br>    sector_per_fat = get_count(DBR[<span class="hljs-number">72</span>: <span class="hljs-number">80</span>])<br>    BPB_RootClus = get_count(DBR[<span class="hljs-number">88</span>: <span class="hljs-number">96</span>])<br>    sector_of_root_dic = reserve_sector + count_fat * sector_per_fat<br>    <span class="hljs-keyword">return</span> sector_of_root_dic, reserve_sector, byte_per_sector, BPB_RootClus, sector_per_clust<br></code></pre></td></tr></table></figure><ol start="3"><li>é€šè¿‡ FAT1 å’Œé¦–ç°‡å¾—åˆ°ç°‡é“¾ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clust_list</span>(<span class="hljs-params">fat1, first_clust</span>):<br>    ans = []<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        ans.append(first_clust)<br>        first_clust = get_count(fat1[first_clust * <span class="hljs-number">8</span>:(first_clust + <span class="hljs-number">1</span>) * <span class="hljs-number">8</span>])<br>        <span class="hljs-keyword">if</span> first_clust == <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0x0fffffff&#x27;</span>, <span class="hljs-number">16</span>):<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¸»å‡½æ•°</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-comment"># å°†æ–‡ä»¶è·¯å¾„åˆ‡åˆ†</span><br>    file_list = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼š&quot;</span>).split(<span class="hljs-string">&quot;/&quot;</span>)<br>    <span class="hljs-comment"># å°†æ–‡ä»¶å¤¹åå’Œæ–‡ä»¶åéƒ½è½¬åŒ–ä¸ºå¯¹åº”çš„ 16 è¿›åˆ¶å­—ç¬¦ä¸²</span><br>    real_filename = [<span class="hljs-built_in">str</span>(binascii.hexlify(<br>        <span class="hljs-built_in">bytes</span>(file_list[i], <span class="hljs-string">&#x27;utf-8&#x27;</span>)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(file_list))]<br>    <br>    <span class="hljs-comment"># æ–‡ä»¶åä¸è€ƒè™‘åç¼€</span><br>    file_list[-<span class="hljs-number">1</span>] = file_list[-<span class="hljs-number">1</span>].split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment"># æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿ</span><br>    disk = <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;\\.\\&#x27;</span> + file_list[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;rb&#x27;</span>)<br>    <span class="hljs-comment"># è¯»å– DBR å¾—åˆ°ä¸€äº›ç”¨äºçš„æ•°æ®</span><br>    root_addr, fat1_addr, byte_per_sector, BPB_RootClus, sector_per_clust = read_DBR(<br>        disk)<br>    <span class="hljs-comment"># æœ€å¼€å§‹çš„ç°‡é“¾å°±æ˜¯æ ¹ç›®å½•</span><br>    clust_list = [BPB_RootClus]<br>    <span class="hljs-comment"># å¯¹åº”æ¯ä¸ªæ–‡ä»¶ï¼ˆå¤¹ï¼‰åï¼Œé€šè¿‡ç°‡é“¾å®šä½å®ƒçš„ä¸Šä¸€çº§ç›®å½•çš„å†…å®¹ä»è€Œå¾—åˆ°å®ƒçš„é¦–ç°‡ï¼Œå†å¾—åˆ°ç°‡é“¾</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(file_list)):<br>        <span class="hljs-comment"># æ³¨æ„è¦è½¬å¤§å†™</span><br>        filename = <span class="hljs-built_in">str</span>(binascii.hexlify(<br>            <span class="hljs-built_in">bytes</span>(file_list[i].upper(), <span class="hljs-string">&#x27;utf-8&#x27;</span>)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]<br>        <span class="hljs-comment"># æ‰‡åŒºå·è¿˜å¾—ä¹˜ä»¥æ¯ä¸ªæ‰‡åŒºçš„å­—èŠ‚æ•°æ‰æ˜¯åç§»é‡</span><br>        disk.seek(<br>            (root_addr + (clust_list[<span class="hljs-number">0</span>] - BPB_RootClus) * sector_per_clust) * byte_per_sector)<br>        <span class="hljs-comment"># print((root_addr + (clust_list[0] - BPB_RootClus) * sector_per_clust))</span><br>        current_sector = <span class="hljs-built_in">str</span>(binascii.hexlify(<br>            disk.read(sector_per_clust * byte_per_sector)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]<br>        <span class="hljs-comment"># print(current_sector)</span><br>        <span class="hljs-comment"># print(filename)</span><br>        index = -<span class="hljs-number">1</span><br>        <span class="hljs-comment"># çŸ­æ–‡ä»¶åï¼Œç›´æ¥æŸ¥çœ‹æ–‡ä»¶åå¯¹åº”çš„ 16 è¿›åˆ¶å­—ç¬¦ä¸²</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(filename) &lt;= <span class="hljs-number">16</span>:<br>            index = current_sector.find(filename)<br>            <span class="hljs-comment"># print(index)</span><br>        <span class="hljs-comment"># é•¿æ–‡ä»¶åæŸ¥æ‰¾ æ–‡ä»¶åçš„å‰ â€œ6 ä¸ªå­—ç¬¦å’Œ ~iâ€˜ ç„¶åå†å»å’Œé•¿æ–‡ä»¶ç›®å½•é¡¹åŒ¹é…</span><br>        <span class="hljs-keyword">else</span>:<br>            num = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">14</span>, <span class="hljs-number">16</span>, <span class="hljs-number">18</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">24</span>, <span class="hljs-number">28</span>, <span class="hljs-number">30</span>]<br>            <span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>):<br>                <span class="hljs-comment"># print(</span><br>                <span class="hljs-comment">#     filename[:12] + str(binascii.hexlify(bytes(&quot;~&quot; + str(number), &#x27;utf-8&#x27;)))[2:-1])</span><br>                index = current_sector.find(<br>                    filename[:<span class="hljs-number">12</span>] + <span class="hljs-built_in">str</span>(binascii.hexlify(<span class="hljs-built_in">bytes</span>(<span class="hljs-string">&quot;~&quot;</span> + <span class="hljs-built_in">str</span>(number), <span class="hljs-string">&#x27;utf-8&#x27;</span>)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>])<br>                temp = <span class="hljs-string">&quot;&quot;</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(real_filename[i]) / <span class="hljs-number">26</span>) + <span class="hljs-number">1</span>):<br>                    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">13</span>):<br>                        temp += current_sector[index - <span class="hljs-number">64</span> * (<br>                            j + <span class="hljs-number">1</span>) + num[k] * <span class="hljs-number">2</span>: index - <span class="hljs-number">64</span> * (j + <span class="hljs-number">1</span>) + num[k] * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>]<br>                <span class="hljs-comment"># print(real_filename)</span><br>                <span class="hljs-comment"># print(temp)</span><br>                <span class="hljs-keyword">if</span> temp[:<span class="hljs-built_in">len</span>(real_filename[i])] == real_filename[i]:<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-comment"># print(index)</span><br>        <span class="hljs-comment"># æ²¡æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶åï¼Œè¯´æ˜æ˜¯é”™è¯¯çš„åœ°å€</span><br>        <span class="hljs-keyword">if</span> index == -<span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;wrong path.&quot;</span>)<br>            exit(-<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># å¾—åˆ°é¦–ç°‡</span><br>        first_clust = get_count(current_sector[index + <span class="hljs-number">40</span>:index + <span class="hljs-number">44</span>]) * \<br>            <span class="hljs-built_in">pow</span>(<span class="hljs-number">16</span>, <span class="hljs-number">4</span>) + get_count(current_sector[index + <span class="hljs-number">52</span>:index + <span class="hljs-number">56</span>])<br>        <span class="hljs-comment"># print(&quot;first_clust:&quot;, first_clust)</span><br>        <span class="hljs-comment"># æŸ¥æ‰¾ç°‡é“¾</span><br>        disk.seek(fat1_addr * byte_per_sector)<br>        fat1 = <span class="hljs-built_in">str</span>(binascii.hexlify(<br>            disk.read(sector_per_clust * byte_per_sector)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]<br>        clust_list = get_clust_list(fat1, first_clust)<br>        <span class="hljs-built_in">print</span>(clust_list)<br>    <span class="hljs-comment"># å¾—åˆ°æœ€åçš„æ–‡ä»¶çš„ç°‡é“¾ï¼Œå…¨éƒ¨è¯»å–ï¼Œç„¶åå†™å…¥åˆ°æ–‡ä»¶ä¹‹ä¸­</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;copy.txt&quot;</span>, mode=<span class="hljs-string">&quot;w+&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>, newline=<span class="hljs-string">&quot;&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-keyword">for</span> clust <span class="hljs-keyword">in</span> clust_list:<br>            disk.seek(<br>                (root_addr + (clust - BPB_RootClus) * sector_per_clust) * byte_per_sector)<br>            filecontent = <span class="hljs-built_in">str</span>(binascii.hexlify(<br>                disk.read(sector_per_clust * byte_per_sector)))[<span class="hljs-number">2</span>:-<span class="hljs-number">1</span>]<br>            <span class="hljs-comment"># print(binascii.unhexlify(filecontent.encode()).decode())</span><br>            s = binascii.unhexlify(filecontent.encode()).decode().rstrip(<span class="hljs-string">&#x27;\0&#x27;</span>)<br>            f.write(s)<br>    <span class="hljs-comment"># print(filecontent)</span><br></code></pre></td></tr></table></figure><p>æœ€åï¼Œå±•ç¤ºä¸€äº›ç»“æœï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221012205900741.png" alt="image-20221012205900741" style="zoom:80%;"><p>åŒæ ·ï¼Œå®éªŒäº†ä¸€ä¸‹é•¿æ–‡ä»¶å¤¹åï¼Œé•¿æ–‡ä»¶åå’Œé•¿ç°‡é“¾ï¼š</p><img src="/2023/06/30/%E5%AE%9A%E4%BD%8D%E5%92%8C%E6%8F%90%E5%8F%96FAT32%E5%88%86%E5%8C%BA%E7%9A%84%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE/image-20221012205951138.png" alt="image-20221012205951138" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘FATæ–‡ä»¶ç³»ç»ŸåŸç†</title>
    <link href="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"/>
    <url>/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€è½¬è½½ã€‘FATæ–‡ä»¶ç³»ç»ŸåŸç†"><a href="#ã€è½¬è½½ã€‘FATæ–‡ä»¶ç³»ç»ŸåŸç†" class="headerlink" title="ã€è½¬è½½ã€‘FATæ–‡ä»¶ç³»ç»ŸåŸç†"></a>ã€è½¬è½½ã€‘FATæ–‡ä»¶ç³»ç»ŸåŸç†</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="http://info.mrtlab.com/filesystem/FAT-principle-three.html">http://info.mrtlab.com/filesystem/FAT-principle-three.html</a></p><p>ä»…ä½œä¸ºä¸ªäººå­¦ä¹ è®°å½•ï¼Œä¾µæƒè”ç³»åˆ é™¤ï¼</p></blockquote><p>FATè¡¨(File Allocation Table æ–‡ä»¶åˆ†é…è¡¨)ï¼Œæ˜¯Microsoftåœ¨FATæ–‡ä»¶ç³»ç»Ÿä¸­ç”¨äºç£ç›˜æ•°æ®(æ–‡ä»¶)ç´¢å¼•å’Œå®šä½å¼•è¿›çš„ä¸€ç§é“¾å¼ç»“æ„ã€‚å‡å¦‚æŠŠç£ç›˜æ¯”ä½œä¸€æœ¬ä¹¦ï¼ŒFATè¡¨å¯ä»¥è®¤ä¸ºç›¸å½“äºä¹¦ä¸­çš„ç›®å½•ï¼Œè€Œæ–‡ä»¶å°±æ˜¯å„ä¸ªç« èŠ‚çš„å†…å®¹ã€‚ä½†FATè¡¨çš„è¡¨ç¤ºæ–¹æ³•å´ä¸ç›®å½•æœ‰å¾ˆå¤§çš„ä¸åŒã€‚</p><p>åœ¨FATæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶çš„å­˜å‚¨ä¾ç…§FATè¡¨åˆ¶å®šçš„ç°‡é“¾å¼æ•°æ®ç»“æ„æ¥è¿›è¡Œã€‚åŒæ—¶ï¼ŒFATæ–‡ä»¶ç³»ç»Ÿå°†ç»„ç»‡æ•°æ®æ—¶ä½¿ç”¨çš„ç›®å½•ä¹ŸæŠ½è±¡ä¸ºæ–‡ä»¶ï¼Œä»¥ç®€åŒ–å¯¹æ•°æ®çš„ç®¡ç†ã€‚</p><hr><p> â˜…å­˜å‚¨è¿‡ç¨‹å‡æƒ³ï¼š</p><p>æˆ‘ä»¬æ¨¡æ‹Ÿå¯¹ä¸€ä¸ªåˆ†åŒºå­˜å‚¨æ•°æ®çš„è¿‡ç¨‹æ¥è¯´æ˜FATæ–‡ä»¶ç³»ç»Ÿä¸­æ•°æ®çš„å­˜å‚¨åŸåˆ™ã€‚</p><p>å‡å®šç°åœ¨æœ‰ä¸€ä¸ªç©ºçš„å®Œå…¨æ²¡æœ‰å­˜æ”¾æ•°æ®çš„ç£ç›˜ï¼Œå¤§å°ä¸º100KBï¼Œæˆ‘ä»¬å°†å…¶æƒ³è±¡ä¸ºçº¿å½¢çš„ç©ºé—´åœ°å€ã€‚ä¸ºäº†å­˜å‚¨ç®¡ç†ä¸Šçš„ä¾¿åˆ©ï¼Œæˆ‘ä»¬äººä¸ºçš„å°†è¿™100KBçš„ç©ºé—´å‡åˆ†æˆ100ä»½ï¼Œæ¯ä»½1KBã€‚æˆ‘ä»¬æ¥ä¾æ¬¡å­˜å‚¨è¿™æ ·å‡ ä¸ªæ–‡ä»¶ï¼šA.TXT(å¤§å°10KB),B.TXT(å¤§å°53.6KB)ï¼ŒC.TXT(å¤§å°20.5KB)ã€‚</p><p>æœ€èµ·ç èƒ½å¤Ÿæƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é¡ºåºçš„åœ¨è¿™100KBç©ºé—´ä¸­å­˜æ”¾è¿™3ä¸ªæ–‡ä»¶ã€‚åŒæ—¶ä¸è¦å¿˜äº†ï¼Œæˆ‘ä»¬è¿˜è¦è®°ä¸‹ä»–ä»¬çš„å¤§å°å’Œå¼€å§‹çš„ä½ç½®ï¼Œè¿™æ ·ä¸‹æ¬¡è¦ç”¨æ—¶æ‰èƒ½æ‰¾çš„åˆ°ï¼Œè¿™å°±åƒæ˜¯ç›®å½•ã€‚ä¸ºäº†ä¾¿äºæŸ¥æ‰¾ï¼Œæˆ‘ä»¬å‡å®šç”¨ç¬¬1Kçš„ç©ºé—´æ¥å­˜å‚¨ä»–ä»¬çš„ç‰¹å¾(å±æ€§)ã€‚è¿˜æœ‰ï¼Œæˆ‘ä»¬è®¾è®¡çš„å­˜å‚¨å•ä½æ˜¯1KBï¼Œæ‰€ä»¥ï¼ŒA.TXTæˆ‘ä»¬éœ€è¦10ä¸ªå­˜å‚¨å•ä½(ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠå­˜å‚¨å•ä½å«åšâ€œç°‡â€å§ã€‚ä¹Ÿèƒ½å°‘æ‰“ç‚¹å­—ï¼Œå‘µå‘µã€‚)ï¼ŒB.TXTéœ€è¦54ä¸ªç°‡ï¼ŒC.TXTéœ€è¦21ä¸ªç°‡ã€‚å¯èƒ½æœ‰äººä¼šè¯´B.TXTå’ŒC.TXTä¸æ˜¯å„è‡ªæµªè´¹äº†ä¸åˆ°1ç°‡çš„ç©ºé—´å—ï¼Ÿå¹²å˜›ä¸è®©ä»–ä»¬ç´§æŒ¨ç€ï¼Œä¸æ˜¯çœåœ°æ–¹å—ï¼Ÿæˆ‘çš„å›ç­”æ˜¯ï¼Œå¦‚æœæŒ‰ç…§è¿™æ ·çš„æ–¹å¼å­˜å‚¨ï¼Œç›®å½•ä¸­åŸæœ¬åªéœ€è¦è®°ä¸‹ç°‡å·ï¼Œç°åœ¨è¿˜éœ€è¦è®°ä¸‹ç°‡å†…çš„åç§»ï¼Œè¿™æ ·ä¼šå¢åŠ ç›®å½•çš„å­˜å‚¨é‡ï¼Œè€Œä¸”å­˜å–æ²¡æœ‰äº†è§„åˆ™ï¼Œè¯»å–ä¹Ÿä¸å¤ªæ–¹ä¾¿ï¼Œæ˜¯å¾—ä¸å¿å¤±çš„ã€‚</p><p>æ ¹æ®ä¸Šé¢æ‰€è¯´çš„æ€æƒ³ï¼Œæˆ‘ä»¬è®¾è®¡äº†è¿™æ ·çš„å›¾4.3.1æ‰€ç¤ºçš„å­˜å‚¨æ–¹å¼ã€‚</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/9E224840581.gif" alt="img" style="zoom:100%;"><p>æˆ‘ä»¬å†è€ƒè™‘å¦‚ä½•æ¥å†™è¿™ä¸‰ä¸ªæ–‡ä»¶çš„ç›®å½•ã€‚å¯¹äºæ¯ä¸ªæ–‡ä»¶è€Œè¨€ï¼Œä¸€å®šè¦è®°å½•çš„æœ‰ï¼šæ–‡ä»¶åï¼Œå¼€å§‹ç°‡ï¼Œå¤§å°ï¼Œåˆ›å»ºæ—¥æœŸã€æ—¶é—´ï¼Œä¿®æ”¹æ—¥æœŸã€æ—¶é—´ï¼Œæ–‡ä»¶çš„è¯»å†™å±æ€§ç­‰ã€‚è¿™é‡Œå¤§å°èƒ½ä¸èƒ½ç”¨ç»“æŸç°‡æ¥è®¡ç®—å‘¢ï¼Ÿä¸€å®šä¸èƒ½ï¼Œå› ä¸ºæ–‡ä»¶çš„å¤§å°ä¸ä¸€å®šå°±æ˜¯æ•´æ•°ä¸ªç°‡çš„å¤§å°ï¼Œå¦åˆ™çš„è¯åƒB.TXTçš„å†…å®¹å°±æ˜¯54KBçš„å†…å®¹äº†ï¼Œå°‘äº†å›ºç„¶ä¸è¡Œï¼Œå¯å¤šäº†ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè®°å½•å‘¢ï¼Ÿå¯ä»¥æƒ³è±¡ä¸€ä¸‹ã€‚ä¸ºäº†ç®¡ç†ä¸Šçš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç”¨æ•°æ®åº“çš„ç®¡ç†æ–¹å¼æ¥ç®¡ç†æˆ‘ä»¬çš„ç›®å½•ã€‚äºæ˜¯æˆ‘æŠŠ1KBå†åˆ†æˆ10ä»½ï¼Œå‡å®šå¼€å§‹ç°‡å·ä¸º0ï¼Œå®šä¹‰æ¯ä»½100Bçš„å„ä¸ªä½ç½®çš„ä»£è¡¨å«ä¹‰å¦‚å›¾4.3.2ï¼š</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/D7224840866.gif" alt="img"><p>è¿™æ ·è®¾è®¡çš„ç»“æ„ç»å¯¹å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œæ­£ç¡®çš„è¯»å†™äº†ã€‚æ¥ç€è®©æˆ‘ä»¬è®¾è®¡çš„æ–‡ä»¶ç³»ç»Ÿå·¥ä½œå§ã€‚å…ˆæ”¹åŠ¨ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚A.TXTï¼Œå¢åŠ ç‚¹å†…å®¹å§ï¼å’¦ï¼Ÿå¢åŠ åå¾€å“ªé‡Œæ”¾å‘€ï¼Œè™½ç„¶å­˜å‚¨å—çš„åé¢æœ‰å¾ˆå¤šç©ºé—´ï¼Œä½†ç´§éšå…¶åB.TXTçš„æ•°æ®è¿˜é¡¶ç€å‘¢ï¼Ÿè¦æ˜¯æŠŠA.TXTç§»åˆ°åè¾¹å¤ªæµªè´¹å¤„ç†èµ„æºï¼Œè€Œä¸”ä¹Ÿä¸ä¸€å®šè§£å†³é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜çœ‹æ¥æš‚æ—¶è§£å†³ä¸äº†ã€‚</p><p>é‚£æˆ‘ä»¬æ¢ä¸ªæ“ä½œï¼ŒæŠŠB.txtåˆ äº†ï¼Œb.txtçš„ç©ºé—´éšä¹‹é‡Šæ”¾ã€‚è¿™æ—¶å€™ç©ºé—´å¦‚å›¾4.3.3ï¼Œç›®å½•å¦‚å›¾4.3.4ï¼š</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/AF224840326.gif" alt="img"><p>è¿™ä¸ªæ“ä½œçœ‹æ¥è¿˜å¯ä»¥ï¼Œæˆ‘ä»¬æ¥ç€åšï¼Œåœ¨å­˜å…¥ä¸€ä¸ªæ–‡ä»¶D.txt(å¤§å°ä¸º60.3KB),æ€»å…±100ç°‡çš„ç©ºé—´åªç”¨äº†31ç°‡ï¼Œè¿˜æœ‰68ç°‡å‰©ä½™ï¼ŒæŒ‰è¯´èƒ½æ”¾ä¸‹ã€‚å¯æ˜¯ï¼Ÿå¾€é‚£é‡Œæ”¾å‘¢ï¼Ÿæ²¡æœ‰61ä¸ªè¿ç»­çš„ç©ºé—´äº†ï¼Œç›®å½•è¡Œæ²¡åŠæ³•å†™äº†ï¼Œçœ‹æ¥æ— è¿ç»­å—å­˜å‚¨æš‚æ—¶ä¹Ÿä¸è¡Œã€‚</p><p>ä½ ä¸€å®šèƒ½å¤Ÿæƒ³åˆ°æˆ‘ä»¬å¯ä»¥åœ¨è¿ç»­ç©ºé—´ä¸å¤Ÿæˆ–å¢åŠ æ–‡ä»¶é•¿åº¦çš„æ—¶å€™è½¬ç§»å½±å“æˆ‘ä»¬æ“ä½œçš„å…¶ä»–æ–‡ä»¶ï¼Œä»è€Œè…¾å‡ºç©ºé—´æ¥ï¼Œä½†æˆ‘è¦é—®ä½ ï¼Œé‚£ä¸æ˜¯æˆå¤©å•¥ä¹Ÿä¸è¦å¹²äº†ï¼Œå°±æ˜¯å€’è…¾ä¸œè¥¿äº†å—ï¼Ÿ</p><p>çœ‹æ¥æˆ‘ä»¬è®¾è®¡çš„æ–‡ä»¶ç³»ç»Ÿæœ‰è‡´å‘½çš„æ¼æ´ï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿã€‚ã€‚ã€‚ã€‚</p><hr><p>å…¶å®å¯ä»¥è¿™æ ·è§£å†³ï¼š</p><p>é¦–å…ˆæˆ‘ä»¬å…è®¸æ–‡ä»¶çš„ä¸è¿ç»­å­˜å‚¨ã€‚ç›®å½•ä¸­ä¾ç„¶åªè®°å½•å¼€å§‹ç°‡å’Œæ–‡ä»¶çš„å¤§å°ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè®°å½•æ–‡ä»¶å ç”¨é‚£äº›ç°‡å‘¢ï¼Œä»¥æ–‡ä»¶æ˜ å°„ç°‡ä¸å¤ªæ–¹ä¾¿ï¼Œå› ä¸ºæ–‡ä»¶åæ˜¯ä¸å›ºå®šçš„ã€‚æˆ‘ä»¬æ¢ä¸ªæ€æƒ³ï¼Œå¯ä»¥ç”¨ç°‡æ¥æ˜ å°„æ–‡ä»¶ï¼Œåœ¨æ•´ä¸ªå­˜å‚¨ç©ºé—´çš„å‰éƒ¨ç•™ä¸‹å‡ ç°‡æ¥è®°å½•æ•°æ®åŒºä¸­æ•°æ®ä¸ç°‡å·çš„å…³ç³»ã€‚å¯¹äºä¸Šä¾‹å› ä¸ºæ€»ç©ºé—´ä¹Ÿä¸å¤§ï¼Œæ‰€ä»¥ç”¨å‰éƒ¨çš„1Kbçš„ç©ºé—´æ¥è®°å½•è¿™ç§å¯¹åº”ï¼Œå‡è®¾3ä¸ªæ–‡ä»¶éƒ½å­˜å‚¨ï¼Œç©ºé—´åˆ†é…å¦‚å›¾4.3.5ï¼ŒåŒæ—¶ä¿®æ”¹ä¸€ä¸‹ç›®å½•ï¼Œå¦‚å›¾4.3.6ï¼š</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/FF224840997.gif" alt="img"><p>ç¬¬ä¸€ç°‡ç”¨æ¥è®°å½•æ•°æ®åŒºä¸­æ¯ä¸€ç°‡çš„è¢«å ç”¨æƒ…å†µï¼Œæš‚æ—¶ç§°å…¶ä¸ºæ–‡ä»¶åˆ†é…è¡¨ã€‚ç»“åˆæ–‡ä»¶åˆ†é…è¡¨å’Œæ–‡ä»¶ç›®å½•å°±å¯ä»¥è¾¾åˆ°å®Œå…¨çš„æ–‡ä»¶è¯»å–äº†ã€‚æˆ‘ä»¬æƒ³åˆ°ï¼ŒæŠŠæ–‡ä»¶åˆ†é…è¡¨åšæˆä¸€ä¸ªæ•°æ®è¡¨ï¼Œä»¥å›¾4.3.7çš„å½¢å¼è®°å½•ç°‡ä¸æ•°æ®çš„å¯¹åº”ã€‚</p><p>ç”¨å›¾4.3.7çš„ç»„ç»‡æ–¹å¼æ˜¯å®Œå…¨å¯ä»¥å®ç°å¯¹æ–‡ä»¶å æœ‰ç°‡çš„è®°å½•çš„ã€‚ä½†è¿˜ä¸å¤Ÿæ•ˆç‡ã€‚æ¯”å¦‚æ–‡ä»¶ååœ¨æ–‡ä»¶åˆ†é…è¡¨ä¸­è®°å½•å¤ªå¤šï¼Œæµªè´¹ç©ºé—´ï¼Œè€Œå®é™…ä¸Šåœ¨ç›®å½•ä¸­å·²ç»è®°å½•äº†æ–‡ä»¶çš„å¼€å§‹ç°‡äº†ã€‚æ‰€ä»¥å¯ä»¥æ”¹è‰¯ä¸€ä¸‹ï¼Œç”¨é“¾çš„æ–¹å¼æ¥å­˜æ”¾å æœ‰ç°‡çš„å…³ç³»ï¼Œå˜æˆå›¾4.3.8çš„ç»„ç»‡æ–¹å¼ã€‚</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/DC224840568.gif" alt="img"><p>å‚ç…§å›¾4.3.8æ¥ç†è§£ä¸€ä¸‹æ–‡ä»¶åˆ†é…è¡¨çš„æ„ä¹‰ã€‚å¦‚æ–‡ä»¶a.txtæˆ‘ä»¬æ ¹æ®ç›®å½•é¡¹ä¸­æŒ‡å®šçš„a.txtçš„é¦–ç°‡ä¸º2ï¼Œç„¶åæ‰¾åˆ°æ–‡ä»¶åˆ†é…è¡¨çš„ç¬¬2ç°‡è®°å½•ï¼Œä¸Šé¢ç™»è®°çš„æ˜¯3ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®å®šä¸‹ä¸€ç°‡æ˜¯3ã€‚æ‰¾åˆ°æ–‡ä»¶åˆ†é…è¡¨çš„ç¬¬3ç°‡è®°å½•ï¼Œä¸Šé¢ç™»è®°çš„æ˜¯4ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®å®šä¸‹ä¸€ç°‡æ˜¯4â€¦â€¦ç›´åˆ°æŒ‡åˆ°ç¬¬11ç°‡ï¼Œå‘ç°ä¸‹ä¸€ä¸ªæŒ‡å‘æ˜¯FFï¼Œå°±æ˜¯ç»“æŸã€‚æ–‡ä»¶ä¾¿ä¸æ¯«æ— è¯¯è¯»å–å®Œæ¯•ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸Šé¢æåˆ°çš„ç¬¬ä¸‰ç§æƒ…å†µï¼Œå°±æ˜¯å°†b.txtåˆ é™¤ä»¥åï¼Œå­˜å…¥ä¸€ä¸ªå¤§å°ä¸º60.3KBçš„d.txtã€‚åˆ©ç”¨ç°‡é“¾å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ã€‚å®ç°åçš„ç£ç›˜å¦‚å›¾4.3.9 4.3.10 4.3.11ï¼š</p><img src="/2023/06/30/FAT%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/image-20230630230351647.png" alt="image-20230630230351647" style="zoom: 45%;">]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linuxå­¦ä¹ ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vfatæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/06/29/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/06/29/vfat%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="vfatæ–‡ä»¶ç³»ç»Ÿ"><a href="#vfatæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="vfatæ–‡ä»¶ç³»ç»Ÿ"></a>vfatæ–‡ä»¶ç³»ç»Ÿ</h1><blockquote><p><a href="https://www.cnblogs.com/Chary/p/12981056.html">https://www.cnblogs.com/Chary/p/12981056.html</a></p></blockquote><h2 id="1-åˆ†æVfatæ–‡ä»¶ç³»ç»Ÿçš„DBR"><a href="#1-åˆ†æVfatæ–‡ä»¶ç³»ç»Ÿçš„DBR" class="headerlink" title="1.åˆ†æVfatæ–‡ä»¶ç³»ç»Ÿçš„DBR"></a>1.åˆ†æVfatæ–‡ä»¶ç³»ç»Ÿçš„DBR</h2><p>vfatæ–‡ä»¶ç³»ç»Ÿçš„DBRæœ‰5éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸ºè·³è½¬æŒ‡ä»¤ï¼ŒOEMä»£å·ï¼ŒBPBï¼Œå¼•å¯¼ç¨‹åºå’Œç»“æŸæ ‡å¿—ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">00000000  eb 58 90 6d 6b 66 73 2e  66 61 74 00 02 08 20 00  |.X.mkfs.fat... .|<br>00000010  02 00 00 00 00 f8 00 00  3f 00 ff 00 00 08 00 00  |........?.......|<br>00000020  00 00 39 00 40 0e 00 00  00 00 00 00 02 00 00 00  |..9.@...........|<br>00000030  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000040  80 00 29 d7 6c d4 7e 4e  4f 20 4e 41 4d 45 20 20  |..).l.~NO NAME  |<br>00000050  20 20 46 41 54 33 32 20  20 20 0e 1f be 77 7c ac  |  FAT32   ...w|.|<br>00000060  22 c0 74 0b 56 b4 0e bb  07 00 cd 10 5e eb f0 32  |&quot;.t.V.......^..2|<br>00000070  e4 cd 16 cd 19 eb fe 54  68 69 73 20 69 73 20 6e  |.......This is n|<br>00000080  6f 74 20 61 20 62 6f 6f  74 61 62 6c 65 20 64 69  |ot a bootable di|<br>00000090  73 6b 2e 20 20 50 6c 65  61 73 65 20 69 6e 73 65  |sk.  Please inse|<br>000000a0  72 74 20 61 20 62 6f 6f  74 61 62 6c 65 20 66 6c  |rt a bootable fl|<br>000000b0  6f 70 70 79 20 61 6e 64  0d 0a 70 72 65 73 73 20  |oppy and..press |<br>000000c0  61 6e 79 20 6b 65 79 20  74 6f 20 74 72 79 20 61  |any key to try a|<br>000000d0  67 61 69 6e 20 2e 2e 2e  20 0d 0a 00 00 00 00 00  |gain ... .......|<br>000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|<br>00000200  52 52 61 41 00 00 00 00  00 00 00 00 00 00 00 00  |RRaA............|<br>00000210  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>000003e0  00 00 00 00 72 72 41 61  6b 1c 07 00 02 00 00 00  |....rrAak.......|<br>000003f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|<br>00000400  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00000c00  eb 58 90 6d 6b 66 73 2e  66 61 74 00 02 08 20 00  |.X.mkfs.fat... .|<br>00000c10  02 00 00 00 00 f8 00 00  3f 00 ff 00 00 08 00 00  |........?.......|<br>00000c20  00 00 39 00 40 0e 00 00  00 00 00 00 02 00 00 00  |..9.@...........|<br>00000c30  01 00 06 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000c40  80 00 29 d7 6c d4 7e 4e  4f 20 4e 41 4d 45 20 20  |..).l.~NO NAME  |<br>00000c50  20 20 46 41 54 33 32 20  20 20 0e 1f be 77 7c ac  |  FAT32   ...w|.|<br>00000c60  22 c0 74 0b 56 b4 0e bb  07 00 cd 10 5e eb f0 32  |&quot;.t.V.......^..2|<br>00000c70  e4 cd 16 cd 19 eb fe 54  68 69 73 20 69 73 20 6e  |.......This is n|<br>00000c80  6f 74 20 61 20 62 6f 6f  74 61 62 6c 65 20 64 69  |ot a bootable di|<br>00000c90  73 6b 2e 20 20 50 6c 65  61 73 65 20 69 6e 73 65  |sk.  Please inse|<br>00000ca0  72 74 20 61 20 62 6f 6f  74 61 62 6c 65 20 66 6c  |rt a bootable fl|<br>00000cb0  6f 70 70 79 20 61 6e 64  0d 0a 70 72 65 73 73 20  |oppy and..press |<br>00000cc0  61 6e 79 20 6b 65 79 20  74 6f 20 74 72 79 20 61  |any key to try a|<br>00000cd0  67 61 69 6e 20 2e 2e 2e  20 0d 0a 00 00 00 00 00  |gain ... .......|<br>00000ce0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00000df0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|<br>00000e00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>00004000  f8 ff ff 0f ff ff ff 0f  f8 ff ff 0f 00 00 00 00  |................|<br>00004010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>001cc000  f8 ff ff 0f ff ff ff 0f  f8 ff ff 0f 00 00 00 00  |................|<br>001cc010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>72000000<br></code></pre></td></tr></table></figure><p><strong>ï¼ˆ1ï¼‰è·³è½¬æŒ‡ä»¤</strong></p><p><strong>E8 58 90 ï¼š(è·³è½¬æŒ‡ä»¤) æœ¬èº«å 2å­—èŠ‚å®ƒå°†ç¨‹åºæ‰§è¡Œæµç¨‹è·³è½¬åˆ°å¼•å¯¼ç¨‹åºå¤„ã€‚</strong></p><p><strong>ï¼ˆ2ï¼‰OEMä»£å·</strong></p><p><strong>4D 53 57 49 4E 34 2E 31 :(OEMä»£å·) è¿™éƒ¨åˆ†å 8å­—èŠ‚ï¼Œå…¶å†…å®¹ç”±åˆ›å»ºè¯¥æ–‡ä»¶ç³»ç»Ÿçš„OEMå‚å•†å…·ä½“å®‰æ’ã€‚</strong></p><p><strong>ï¼ˆ3ï¼‰BPB</strong></p><p>vfatçš„BPBä»DBRçš„ç¬¬12ä¸ªå­—èŠ‚å¼€å§‹ï¼Œå ç”¨79å­—èŠ‚ï¼Œè®°å½•äº†æœ‰å…³è¯¥æ–‡ä»¶ç³»ç»Ÿçš„é‡è¦ä¿¡æ¯ï¼Œå„å‚æ•°è§£é‡Šå¦‚ä¸‹è¡¨ï¼š</p><p><strong>å‰é¢53ä¸ªå­—èŠ‚æ˜¯BPBï¼Œåé¢26ä¸ªå­—èŠ‚æ˜¯æ‰©å±•BPBã€‚</strong></p><table><thead><tr><th>å¯¹åº”å€¼</th><th>å­—æ®µé•¿åº¦ï¼ˆByteï¼‰</th><th>åç§°å’Œå®šä¹‰</th><th>å–å€¼å«ä¹‰</th></tr></thead><tbody><tr><td>0x0200</td><td>2</td><td>æ‰‡åŒºå­—èŠ‚æ•°ï¼ˆByte Per Sectorï¼‰</td><td>æ¯ä¸ªæ‰‡åŒº512å­—èŠ‚</td></tr><tr><td>0x08</td><td>1</td><td>æ¯ç°‡æ‰‡åŒºæ•°ï¼ˆSector Per Clusterï¼‰</td><td>æ¯ç°‡8ä¸ªæ‰‡åŒº</td></tr><tr><td>0x0020</td><td>2</td><td>ä¿ç•™æ‰‡åŒºæ•°</td><td>ä¿ç•™32ä¸ªæ‰‡åŒº</td></tr><tr><td>0x02</td><td>1</td><td>FATæ•°</td><td>2ä¸ªFAT</td></tr><tr><td>0x0000</td><td>2</td><td>æ ¹ç›®å½•é¡¹æ•°ï¼ˆåªæœ‰FAT12&#x2F;FAT16ä½¿ç”¨æ­¤å­—æ®µï¼‰</td><td>æ ¹ç›®å½•é¡¹æ•°ä¸º0</td></tr><tr><td>0x0000</td><td>2</td><td>å°æ‰‡åŒºæ•°ï¼ˆåªæœ‰FAT12&#x2F;FAT16ä½¿ç”¨æ­¤å­—æ®µï¼‰</td><td>å°æ‰‡åŒºæ•°ä¸º0</td></tr><tr><td>0xf8</td><td>1</td><td>åª’ä½“æè¿°ç¬¦ï¼ˆ0xf8è¡¨ç¤ºç¡¬ç›˜ï¼‰</td><td>ç¡¬ç›˜</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>voldä¸­forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤</title>
    <link href="/2023/06/26/vold%E4%B8%ADfork%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/06/26/vold%E4%B8%ADfork%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="voldä¸­forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"><a href="#voldä¸­forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤" class="headerlink" title="voldä¸­forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"></a>voldä¸­forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤</h1><blockquote><p>ğŸƒ å‰ç½®çŸ¥è¯†ï¼š</p><ul><li><a href="https://anmuxixixi.github.io/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/">linuxä¸­pipeå’Œdup2è¯¦è§£</a></li><li><a href="https://anmuxixixi.github.io/2023/06/26/Linux%E4%B8%AD%E7%9A%84STDIN-FILENO%E5%92%8CSTDOUT-FILENO/">Linuxä¸­çš„STDIN_FILENOå’ŒSTDOUT_FILENO_</a></li><li><a href="https://blog.csdn.net/duapple/article/details/126918593">è®°å½•forkå­è¿›ç¨‹æ‰§è¡Œexeclé˜»å¡å¡æ­»çš„é—®é¢˜</a></li></ul></blockquote><h2 id="1-forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"><a href="#1-forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤" class="headerlink" title="1.forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"></a>1.forkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\vold\Utils.cpp</span><br><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">ForkExecvp</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;std::string&gt;&amp; args, std::vector&lt;std::string&gt;* output,</span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">security_context_t</span> context)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> argv = <span class="hljs-built_in">ConvertToArgv</span>(args);<br><br>    android::base::unique_fd pipe_read, pipe_write;<br>    <span class="hljs-keyword">if</span> (!android::base::<span class="hljs-built_in">Pipe</span>(&amp;pipe_read, &amp;pipe_write)) &#123;<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Pipe in ForkExecvp&quot;</span>;<br>        <span class="hljs-keyword">return</span> -errno;<br>    &#125;<br><br>    <span class="hljs-type">pid_t</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        pipe_read.<span class="hljs-built_in">reset</span>();<br>        <span class="hljs-comment">// å°†STDOUT_FILENO(ä¹Ÿå°±æ˜¯ç»ˆç«¯è¾“å‡º)é‡å®šå‘åˆ°pipe_write</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">dup2</span>(pipe_write.<span class="hljs-built_in">get</span>(), STDOUT_FILENO) == <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;dup2 in ForkExecvp&quot;</span>;<br>            _exit(EXIT_FAILURE);<br>        &#125;<br>        pipe_write.<span class="hljs-built_in">reset</span>();<br>        <span class="hljs-comment">// æ‰§è¡Œå‘½ä»¤</span><br>        <span class="hljs-built_in">execvp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(argv.<span class="hljs-built_in">data</span>()));<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;exec in ForkExecvp&quot;</span>;<br>        _exit(EXIT_FAILURE);<br>    &#125;<br><br>    pipe_write.<span class="hljs-built_in">reset</span>();<br>    <span class="hljs-keyword">auto</span> st = <span class="hljs-built_in">ReadLinesFromFdAndLog</span>(output, std::<span class="hljs-built_in">move</span>(pipe_read));<br>    <span class="hljs-keyword">if</span> (st != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> st;<br><br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-comment">// ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸ</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">waitpid</span>(pid, &amp;status, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;waitpid in ForkExecvp&quot;</span>;<br>        <span class="hljs-keyword">return</span> -errno;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> OK;<br>&#125;<br><br>---------------------------------------------------<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">status_t</span> <span class="hljs-title">ReadLinesFromFdAndLog</span><span class="hljs-params">(std::vector&lt;std::string&gt;* output,</span></span><br><span class="hljs-params"><span class="hljs-function">                                      android::base::unique_fd ufd)</span> </span>&#123;<br>    <span class="hljs-function">std::unique_ptr&lt;FILE, <span class="hljs-title">int</span> <span class="hljs-params">(*)</span><span class="hljs-params">(FILE*)</span>&gt; <span class="hljs-title">fp</span><span class="hljs-params">(android::base::Fdopen(std::move(ufd), <span class="hljs-string">&quot;r&quot;</span>), fclose)</span></span>;<br>    <span class="hljs-type">char</span> line[<span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), fp.<span class="hljs-built_in">get</span>()) != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">LOG</span>(DEBUG) &lt;&lt; line;<br>    &#125;<br>    <span class="hljs-keyword">return</span> OK;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®å°±æ˜¯forkå­è¿›ç¨‹åç†è§£è°ƒç”¨execæ—å‡½æ•°execvpå»æ‰§è¡Œå‘½ä»¤ã€‚</p><img src="/2023/06/26/vold%E4%B8%ADfork%E5%AD%90%E8%BF%9B%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/image-20230626230653727.png" alt="image-20230626230653727" style="zoom: 80%;"><h2 id="2-å¼‚æ­¥æ‰§è¡Œforkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"><a href="#2-å¼‚æ­¥æ‰§è¡Œforkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤" class="headerlink" title="2.å¼‚æ­¥æ‰§è¡Œforkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤"></a>2.å¼‚æ­¥æ‰§è¡Œforkå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">pid_t</span> <span class="hljs-title">ForkExecvpAsync</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;std::string&gt;&amp; args)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> argv = <span class="hljs-built_in">ConvertToArgv</span>(args);<br><br>    <span class="hljs-type">pid_t</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// å…³é—­äº†æ‰€æœ‰çš„æµ</span><br>        <span class="hljs-built_in">close</span>(STDIN_FILENO);<br>        <span class="hljs-built_in">close</span>(STDOUT_FILENO);<br>        <span class="hljs-built_in">close</span>(STDERR_FILENO);<br><span class="hljs-comment">// æ‰§è¡Œå‘½ä»¤è¡Œ</span><br>        <span class="hljs-built_in">execvp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(argv.<span class="hljs-built_in">data</span>()));<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;exec in ForkExecvpAsync&quot;</span>;<br>        _exit(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">return</span> pid;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="3-å·®å¼‚"><a href="#3-å·®å¼‚" class="headerlink" title="3.å·®å¼‚"></a>3.å·®å¼‚</h2><p>ForkExecvpä¸ForkExecvpAsyncå¯¹æ¯”åå·®å¼‚åœ¨äºï¼š</p><ul><li>ForkExecvpä¼šå°†å‘½ä»¤è¡Œæ‰§è¡Œçš„ç»“æœé€šè¿‡æ—¥å¿—æ‰“å°å‡ºæ¥ï¼Œè€ŒForkExecvpAsyncåˆ™æ‰§è¡Œæ‰§è¡Œå‘½ä»¤è¡Œ</li><li>ForkExecvpåœ¨å¤šçº¿ç¨‹æŸç§æç«¯çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å‘ç”Ÿæ­»é”ã€<a href="https://blog.csdn.net/duapple/article/details/126918593%E3%80%91%E3%80%82">https://blog.csdn.net/duapple/article/details/126918593ã€‘ã€‚</a></li><li>ä½¿ç”¨äº†åŒ¿åç®¡é“çš„ForkExecvpæ˜¯éå¼‚æ­¥çš„ï¼Œè€ŒForkExecvpAsyncæ˜¯å¼‚æ­¥çš„</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘linuxä¸­pipeå’Œdup2è¯¦è§£</title>
    <link href="/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/"/>
    <url>/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€è½¬è½½ã€‘linuxä¸­pipeå’Œdup2è¯¦è§£"><a href="#ã€è½¬è½½ã€‘linuxä¸­pipeå’Œdup2è¯¦è§£" class="headerlink" title="ã€è½¬è½½ã€‘linuxä¸­pipeå’Œdup2è¯¦è§£"></a>ã€è½¬è½½ã€‘linuxä¸­pipeå’Œdup2è¯¦è§£</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://www.cnblogs.com/Hxinguan/p/5007393.html">https://www.cnblogs.com/Hxinguan/p/5007393.html</a></p></blockquote><h2 id="1-ä»€ä¹ˆæ˜¯ç®¡é“"><a href="#1-ä»€ä¹ˆæ˜¯ç®¡é“" class="headerlink" title="1.ä»€ä¹ˆæ˜¯ç®¡é“"></a>1.ä»€ä¹ˆæ˜¯ç®¡é“</h2><p>ç®¡é“æ˜¯åŠåŒå·¥çš„ï¼Œæ•°æ®åªèƒ½å‘ä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼›éœ€è¦åŒæ–¹é€šä¿¡æ—¶ï¼Œéœ€è¦å»ºç«‹èµ·ä¸¤ä¸ªç®¡é“ï¼› åªèƒ½ç”¨äºçˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´ï¼ˆå…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ï¼‰ï¼› å•ç‹¬æ„æˆä¸€ç§ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼šç®¡é“å¯¹äºç®¡é“ä¸¤ç«¯çš„è¿›ç¨‹è€Œè¨€ï¼Œå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†å®ƒä¸æ˜¯æ™®é€šçš„æ–‡ä»¶ï¼Œå®ƒä¸å±äºæŸç§æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯è‡ªç«‹é—¨æˆ·ï¼Œå•ç‹¬æ„æˆä¸€ç§æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚æ•°æ®çš„è¯»å‡ºå’Œå†™å…¥ï¼šä¸€ä¸ªè¿›ç¨‹å‘ç®¡é“ä¸­å†™çš„å†…å®¹è¢«ç®¡é“å¦ä¸€ç«¯çš„è¿›ç¨‹è¯»å‡ºã€‚å†™å…¥çš„å†…å®¹æ¯æ¬¡éƒ½æ·»åŠ åœ¨ç®¡é“ç¼“å†²åŒºçš„æœ«å°¾ï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½æ˜¯ä»ç¼“å†²åŒºçš„å¤´éƒ¨è¯»å‡ºæ•°æ®ã€‚</p><h2 id="2-ç®¡é“çš„åˆ›å»º"><a href="#2-ç®¡é“çš„åˆ›å»º" class="headerlink" title="2.ç®¡é“çš„åˆ›å»º"></a>2.ç®¡é“çš„åˆ›å»º</h2><p>int pipe(int fd[2])</p><p>è¯¥å‡½æ•°åˆ›å»ºçš„ç®¡é“çš„ä¸¤ç«¯å¤„äºä¸€ä¸ªä¸­é—´è¿›ç¨‹ï¼Œåœ¨å®é™…åº”ç”¨ä¸­å¹¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œä¸€èˆ¬åœ¨pipe()åˆ›å»ºç®¡é“åï¼Œå†fork()ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åé€šè¿‡ç®¡é“å®ç°çˆ¶å­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p><h2 id="3-ç®¡é“çš„è¯»å†™è§„åˆ™"><a href="#3-ç®¡é“çš„è¯»å†™è§„åˆ™" class="headerlink" title="3.ç®¡é“çš„è¯»å†™è§„åˆ™"></a>3.ç®¡é“çš„è¯»å†™è§„åˆ™</h2><p>ç®¡é“ä¸¤ç«¯å¯åˆ†åˆ«ç”¨æè¿°å­—fd[0]ä»¥åŠfd[1]æ¥æè¿°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç®¡é“çš„ä¸¤ç«¯æ˜¯å›ºå®šäº†ä»»åŠ¡çš„ã€‚å³ä¸€ç«¯åªèƒ½ç”¨äºè¯»ï¼Œç”±æè¿°å­—fd[0]è¡¨ç¤ºï¼Œç§°å…¶ä¸ºç®¡é“è¯»ç«¯ï¼›å¦ä¸€ç«¯åˆ™åªèƒ½ç”¨äºå†™ï¼Œç”±æè¿°å­—fd[1]æ¥è¡¨ç¤ºï¼Œç§°å…¶ä¸ºç®¡é“å†™ç«¯ã€‚</p><h2 id="4-pipeå‡½æ•°"><a href="#4-pipeå‡½æ•°" class="headerlink" title="4.pipeå‡½æ•°"></a>4.pipeå‡½æ•°</h2><p>å¤´æ–‡ä»¶ï¼š#include&lt;unistd.h&gt;</p><p>å‡½æ•°åŸå‹ï¼š int pipe(int fd[2])</p><p>å‡½æ•°å‚æ•°ï¼šfd[2],ç®¡é“çš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¹‹åå°±æ˜¯å¯ä»¥ç›´æ¥æ“ä½œè¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å…¶ä¸­fd[0]ä¸ºè¯»å–ç«¯ï¼Œfd[1]ä¸ºå†™å…¥ç«¯</p><p>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›-1</p><ul><li><p>è¯»fd[0]: close(fd[1]); read(fd[0], buf, BUF_SIZE);</p></li><li><p>å†™fd[1]: close(fd[0]); read(fd[1], buf, strlen(buf));</p></li></ul><h2 id="5-ä¾‹å­"><a href="#5-ä¾‹å­" class="headerlink" title="5.ä¾‹å­"></a>5.ä¾‹å­</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">pipe</span>(fd) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pipe error\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork error\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is the father process, here write a string to the pipe\n&quot;</span>);<br>        <span class="hljs-type">char</span> s[] = <span class="hljs-string">&quot;Hello! write a string in the father process\n&quot;</span>;<br>        <span class="hljs-built_in">close</span>(fd[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">write</span>(fd[<span class="hljs-number">1</span>], s, <span class="hljs-built_in">sizeof</span>(s));              <span class="hljs-comment">// å‘ç®¡é“ä¸­å†™å…¥æ•°æ®</span><br><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is the child process, here read a string from the pipe\n&quot;</span>);<br>        <span class="hljs-built_in">close</span>(fd[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">read</span>(fd[<span class="hljs-number">0</span>], buf, <span class="hljs-built_in">sizeof</span>(buf));          <span class="hljs-comment">//ä»ç®¡é“ä¸­è¯»å–æ•°æ®</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);<br>    &#125;<br>    <span class="hljs-built_in">waitpid</span>(pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><img src="/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/image-20230626220856696.png" alt="image-20230626220856696" style="zoom:80%;"><p>å½“ç®¡é“ä¸­æ•°æ®è¢«è¯»å–åï¼Œç®¡é“ä¸ºç©ºã€‚ä¹‹åå†readæ“ä½œå°†é»˜è®¤çš„è¢«é˜»å¡ï¼Œç­‰å¾…æŸäº›æ•°æ®è¢«å†™å…¥ã€‚å¦‚éœ€è¦è®¾ç½®ä¸ºéé˜»å¡ï¼Œåˆ™å¯åšå¦‚ä¸‹è®¾ç½®ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">fcntl</span>(filedes[<span class="hljs-number">0</span>], F_SETFL, O_NONBLOCK);<br><span class="hljs-built_in">fcntl</span>(filedes[<span class="hljs-number">1</span>], F_SETFL, O_NONBLOCK);<br></code></pre></td></tr></table></figure><h2 id="6-dup2è¯»å–"><a href="#6-dup2è¯»å–" class="headerlink" title="6.dup2è¯»å–"></a>6.dup2è¯»å–</h2><p>ç”¨æ¥å¤åˆ¶ä¸€ä¸ªç°å­˜çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘åŒä¸€ä¸ª<code>file</code>ç»“æ„ä½“ã€‚</p><p>å…¶ä¸­å¤´æ–‡ä»¶ï¼š#include &lt;unistd.h&gt;</p><p>å‡½æ•°åŸå‹ï¼šint dup2(int oldhandle, int newhandle);</p><p>ä¾‹å­è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢é‚£ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">int</span> newfd;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">pipe</span>(fd) != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pipe error\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fork error\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is the father process, here write a string to the pipe\n&quot;</span>);<br>        <span class="hljs-type">char</span> s[] = <span class="hljs-string">&quot;Hello! write a string in the father process\n&quot;</span>;<br>        <span class="hljs-built_in">close</span>(fd[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">write</span>(fd[<span class="hljs-number">1</span>], s, <span class="hljs-built_in">sizeof</span>(s));              <span class="hljs-comment">// å‘ç®¡é“ä¸­å†™å…¥æ•°æ®</span><br><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is the child process, here read a string from the pipe\n&quot;</span>);<br>        <span class="hljs-built_in">close</span>(fd[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">dup2</span>(fd[<span class="hljs-number">0</span>], newfd);<br>        <span class="hljs-built_in">read</span>(newfd, buf, <span class="hljs-built_in">sizeof</span>(buf));          <span class="hljs-comment">//ä»ç®¡é“ä¸­è¯»å–æ•°æ®</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);<br>    &#125;<br>    <span class="hljs-built_in">waitpid</span>(pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œçš„ç»“æœè¿˜æ˜¯ä¸€æ ·ã€‚åªæ˜¯åœ¨36è¡Œä»£ç ä¸­è°ƒç”¨äº†dup2,æŠŠfd[0]å¤åˆ¶ç»™newfdã€‚</p><img src="/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/image-20230626221136998.png" alt="image-20230626221136998" style="zoom:80%;"><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br> <br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FILENME   <span class="hljs-string">&quot;1.txt&quot;</span></span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">O_RDWR: å¯è¯»å¯å†™</span><br><span class="hljs-comment">O_TRUNC: ä¼šæŠŠåŸæœ‰å†…å®¹åˆ é™¤  ã€‚ è‹±æ–‡è¯»ï¼šæ¬§æ“¦å…‹</span><br><span class="hljs-comment">O_CREAT: å¦‚æœa.txt æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª a.txt</span><br><span class="hljs-comment">O_APPEND: æ¥ç»­æ·»åŠ è¦å†™å…¥çš„å†…å®¹ ã€‚ è‹±æ–‡è¯»ï¼šæ¬§é¢ç›†å¾—</span><br><span class="hljs-comment">*/</span><br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">int</span> fd1 = <span class="hljs-number">-1</span>, fd2 = <span class="hljs-number">-1</span>;<br><br>fd1 = <span class="hljs-built_in">open</span>(FILENME, O_RDWR | O_APPEND ); <br><br><span class="hljs-keyword">if</span> (fd1 &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;open&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd1 = %d.\n&quot;</span>, fd1);<br><br><span class="hljs-comment">//å¦‚æœæ­£ç¡® å°±ä¼šè¿”å›æ–°çš„ æ–‡ä»¶æè¿°ç¬¦ 16 </span><br>fd2 = <span class="hljs-built_in">dup2</span>(fd1,<span class="hljs-number">16</span>);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fd2 = %d .\n&quot;</span>,fd2);<br><br><span class="hljs-comment">//å› ä¸ºåªæ‰“å¼€äº† fd1, æ‰€ä»¥åªå…³é—­fd1å°±å¯ä»¥äº†</span><br><span class="hljs-built_in">close</span>(fd1);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><img src="/2023/06/26/linux%E4%B8%ADpipe%E5%92%8Cdup2%E8%AF%A6%E8%A7%A3/6766a5c4f0924a6aa4c0e99f3826b24b.png" alt="img" style="zoom: 80%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxä¸­çš„STDIN_FILENOå’ŒSTDOUT_FILENO</title>
    <link href="/2023/06/26/Linux%E4%B8%AD%E7%9A%84STDIN-FILENO%E5%92%8CSTDOUT-FILENO/"/>
    <url>/2023/06/26/Linux%E4%B8%AD%E7%9A%84STDIN-FILENO%E5%92%8CSTDOUT-FILENO/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€è½¬è½½ã€‘Linuxä¸­çš„STDIN-FILENOå’ŒSTDOUT-FILENO"><a href="#ã€è½¬è½½ã€‘Linuxä¸­çš„STDIN-FILENOå’ŒSTDOUT-FILENO" class="headerlink" title="ã€è½¬è½½ã€‘Linuxä¸­çš„STDIN_FILENOå’ŒSTDOUT_FILENO"></a>ã€è½¬è½½ã€‘Linuxä¸­çš„STDIN_FILENOå’ŒSTDOUT_FILENO</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="https://blog.csdn.net/sinat_25457161/article/details/48548231?spm=1001.2014.3001.5506">https://blog.csdn.net/sinat_25457161/article/details/48548231?spm=1001.2014.3001.5506</a></p></blockquote><p><strong>è¯´æ˜ï¼š</strong></p><blockquote><p>STDIN_FILENOï¼šæ¥æ”¶é”®ç›˜çš„è¾“å…¥</p><p>STDOUT_FILENOï¼šå‘å±å¹•è¾“å‡º</p></blockquote><p><strong>ç¨‹åºï¼š</strong></p><blockquote><p>æ¥æ”¶ç”¨æˆ·åœ¨å±å¹•ä¸Šè¾“å…¥çš„æ•°æ®ï¼Œå¹¶åœ¨å±å¹•ä¸Šè¾“å‡ºï¼ˆè¦æ±‚ä½¿ç”¨readå’Œwirteå®ç°ï¼‰ï¼Œç”¨æˆ·è¾“å…¥quitå°±é€€å‡ºç¨‹åºã€‚</p></blockquote><p><strong>å›¾è§£è¯´æ˜ï¼š</strong></p><img src="/2023/06/26/Linux%E4%B8%AD%E7%9A%84STDIN-FILENO%E5%92%8CSTDOUT-FILENO/20150918165941312.jpeg" alt="img" style="zoom:80%;"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *args[])</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// å®šä¹‰è¯»å–æ–‡ä»¶çš„ç¼“å†²åŒº</span><br><span class="hljs-type">char</span> buf_read[<span class="hljs-number">1024</span>];<br><span class="hljs-comment">// å®šä¹‰å†™å…¥æ–‡ä»¶çš„ç¼“å†²åŒº</span><br><span class="hljs-type">char</span> buf_write[<span class="hljs-number">1024</span>];<br><br><span class="hljs-comment">// å¾ªç¯è¯»å–ç”¨æˆ·ä»é”®ç›˜è¾“å…¥çš„ä¿¡æ¯</span><br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>&#123;<br><span class="hljs-comment">// æ¸…ç©ºè¯»å–æ–‡ä»¶ç¼“å†²åŒºä¸­çš„å†…å­˜</span><br><span class="hljs-built_in">memset</span>(buf_read, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buf_read));<br><span class="hljs-comment">// æ¸…ç©ºå†™å…¥æ–‡ä»¶ç¼“å†²åŒºä¸­çš„å†…å­˜</span><br><span class="hljs-built_in">memset</span>(buf_write, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buf_write));<br><br><span class="hljs-comment">// æ‰“å°æç¤ºä¿¡æ¯</span><br><span class="hljs-type">char</span> input_message[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;input some words : &quot;</span>;<br><span class="hljs-built_in">write</span>(STDOUT_FILENO, input_message, <span class="hljs-built_in">sizeof</span>(input_message));<br><span class="hljs-comment">// è¯»å–ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ä¿¡æ¯</span><br><span class="hljs-built_in">read</span>(STDIN_FILENO, buf_read, <span class="hljs-built_in">sizeof</span>(buf_read));<br><span class="hljs-comment">// åˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ˜¯å¦ä¸ºquit</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(buf_read, <span class="hljs-string">&quot;quit&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-comment">// å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯quitï¼Œç¨‹åºé€€å‡ºå¾ªç¯</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// å¦‚æœç”¨æˆ·è¾“å…¥çš„ä¸æ˜¯quit</span><br><span class="hljs-comment">// æŠŠå†…å®¹æ‹·è´åˆ°å†™å…¥æ–‡ä»¶ç¼“å†²åŒºä¸­</span><br><span class="hljs-built_in">strcpy</span>(buf_write, buf_read);<br><span class="hljs-comment">// æ‰“å°æç¤ºä¿¡æ¯</span><br><span class="hljs-type">char</span> output_message[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;output some words : &quot;</span>;<br><span class="hljs-built_in">write</span>(STDOUT_FILENO, output_message, <span class="hljs-built_in">sizeof</span>(output_message));<br><span class="hljs-comment">// å°†ä¿¡æ¯æ˜¾ç¤ºåœ¨å±å¹•ä¸Š</span><br><span class="hljs-built_in">write</span>(STDOUT_FILENO, buf_write, <span class="hljs-built_in">strlen</span>(buf_write));<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/06/26/Linux%E4%B8%AD%E7%9A%84STDIN-FILENO%E5%92%8CSTDOUT-FILENO/image-20230626215903169.png" alt="image-20230626215903169" style="zoom:80%;"><p>ç¨‹åºå®ç°äº†ï¼Œæ²¡æœ‰ä½¿ç”¨scanfå’Œprintfï¼Œä»é”®ç›˜æ¥æ”¶ç”¨æˆ·è¾“å…¥å’Œå°†ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯æ‰“å°åˆ°å±å¹•ä¸Šã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ç§‘æ™®ã€‘éå¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼ˆå…¬é’¥ä½“ç³»ï¼‰ã€å…¬é’¥ ç§é’¥ æ•°å­—ç­¾å CAè¯ä¹¦ã€‘</title>
    <link href="/2023/06/24/%E3%80%90%E7%A7%91%E6%99%AE%E3%80%91%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%EF%BC%88%E5%85%AC%E9%92%A5%E4%BD%93%E7%B3%BB%EF%BC%89%E3%80%90%E5%85%AC%E9%92%A5-%E7%A7%81%E9%92%A5-%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D-CA%E8%AF%81%E4%B9%A6%E3%80%91/"/>
    <url>/2023/06/24/%E3%80%90%E7%A7%91%E6%99%AE%E3%80%91%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%EF%BC%88%E5%85%AC%E9%92%A5%E4%BD%93%E7%B3%BB%EF%BC%89%E3%80%90%E5%85%AC%E9%92%A5-%E7%A7%81%E9%92%A5-%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D-CA%E8%AF%81%E4%B9%A6%E3%80%91/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€ç§‘æ™®ã€‘éå¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼ˆå…¬é’¥ä½“ç³»ï¼‰ã€å…¬é’¥-ç§é’¥-æ•°å­—ç­¾å-CAè¯ä¹¦ã€‘"><a href="#ã€ç§‘æ™®ã€‘éå¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼ˆå…¬é’¥ä½“ç³»ï¼‰ã€å…¬é’¥-ç§é’¥-æ•°å­—ç­¾å-CAè¯ä¹¦ã€‘" class="headerlink" title="ã€ç§‘æ™®ã€‘éå¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼ˆå…¬é’¥ä½“ç³»ï¼‰ã€å…¬é’¥ ç§é’¥ æ•°å­—ç­¾å CAè¯ä¹¦ã€‘"></a>ã€ç§‘æ™®ã€‘éå¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼ˆå…¬é’¥ä½“ç³»ï¼‰ã€å…¬é’¥ ç§é’¥ æ•°å­—ç­¾å CAè¯ä¹¦ã€‘</h1><p><a href="https://www.bilibili.com/video/BV15P4y1S7Jw/">https://www.bilibili.com/video/BV15P4y1S7Jw/</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ã€å®éªŒã€‘opensslæ¨¡æ‹Ÿè¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹</title>
    <link href="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/"/>
    <url>/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘opensslæ¨¡æ‹Ÿè¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹"><a href="#ã€å®éªŒã€‘opensslæ¨¡æ‹Ÿè¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹" class="headerlink" title="ã€å®éªŒã€‘opensslæ¨¡æ‹Ÿè¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹"></a>ã€å®éªŒã€‘opensslæ¨¡æ‹Ÿè¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹</h1><blockquote><p>å®éªŒå†…å®¹æ¥è‡ªï¼š<a href="https://www.cnblogs.com/frisk/p/12628159.html">https://www.cnblogs.com/frisk/p/12628159.html</a></p><p>ğŸ”•åŸºç¡€çŸ¥è¯†å‚è€ƒåšå®¢å…ˆè¿›è¡Œå›é¡¾ï¼ï¼ï¼</p></blockquote><p>ğŸ¥‡ <strong>openssl x509å·¥å…·ä¸»è¦ç”¨äºè¾“å‡ºè¯ä¹¦ä¿¡æ¯, ç­¾ç½²è¯ä¹¦è¯·æ±‚æ–‡ä»¶ã€è‡ªç­¾ç½²ã€è½¬æ¢è¯ä¹¦æ ¼å¼ç­‰ã€‚å®ƒå°±åƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„å°å‹çš„CAå·¥å…·ç®±ã€‚</strong></p><p><strong>ï¼ˆ1ï¼‰è¿è¥å•†ç§é’¥</strong></p><p> æ¨¡æ‹Ÿç”Ÿæˆè¿è¥å•†çš„ç§é’¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">éœ€è¦ç»å¸¸è¾“å…¥å¯†ç </span><br>openssl genrsa -des3 -out server_private.key 2048 ä¼šæœ‰è¾“å…¥å¯†ç çš„è¦æ±‚<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å»é™¤å¯†ç </span><br>openssl rsa -in server_private.key -out server_private.key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ— å¯†ç è¯ä¹¦ç§˜é’¥</span><br>openssl genrsa -out server_private.key 2048<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå…¬é’¥</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">openssl rsa -<span class="hljs-keyword">in</span> server_private.key -pubout -out server_public.key</span><br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621223828285.png" alt="image-20230621223828285" style="zoom: 67%;"><p><strong>ï¼ˆ2ï¼‰è¿è¥å•†å‘CAç”³è¯·è¯ä¹¦æ–‡ä»¶</strong></p><p>æ¨¡æ‹Ÿç”Ÿæˆè¿è¥å•† è¯ä¹¦ç”³è¯·æ–‡ä»¶&#x2F;è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ <code>.req</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl req -new -key server_private.key -out server.req<br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¼šè®©è¾“å…¥Country Name å¡« CN; Common Name å¡« ip ä¹Ÿå¯ä»¥ä¸å¡«ã€‚</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">æŸ¥çœ‹server.req</span><br>openssl req -in server.req -text<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621224000406.png" alt="image-20230621224000406" style="zoom: 67%;"><p><strong>ï¼ˆ3ï¼‰CAæœºæ„è¦æœ‰è‡ªå·±çš„ç§é’¥ï¼Œä¸ºè¿è¥å•†ç­¾å‘è¯ä¹¦</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl genrsa -out ca_private.key 2048<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621224112637.png" alt="image-20230621224112637" style="zoom:67%;"><p><strong>ï¼ˆ4ï¼‰CAæœºæ„ ä¹Ÿè¦å‘ æ›´é«˜çº§çš„CAæœºæ„ ç”³è¯·è¯ä¹¦, æœ‰äº†è‡ªå·±çš„è¯ä¹¦ æ‰èƒ½ä¸ºè¿è¥å•†ç­¾å‘è¯ä¹¦</strong></p><p> ç”Ÿæˆ CAè¯ä¹¦ç”³è¯·æ–‡ä»¶&#x2F;è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ <code>.req</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl req -new -key ca_private.key  -out ca_request.req<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ca_request.req</span><br>openssl req -in ca_request.req -text<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621224223565.png" alt="image-20230621224223565" style="zoom:67%;"><p><strong>ï¼ˆ5ï¼‰CAæœºæ„è·å¾—è¯ä¹¦</strong></p><p>åˆ›å»ºCAè¯ä¹¦ï¼Œç”¨æ¥ç»™è¿è¥å•†çš„è¯ä¹¦ç­¾åã€‚</p><p>è¿™ä¸ªè¯ä¹¦ï¼Œæœ¬æ¥åº”ç”±æ›´é«˜çº§çš„CAç”¨å®ƒçš„private keyå¯¹è¿™ä¸ªè¯ä¹¦è¯·æ±‚è¿›è¡Œç­¾å‘ï¼Œ</p><p>ç”±äºæ­¤æ—¶æ¨¡æ‹Ÿçš„CAæ˜¯ root CAï¼Œæ²¡æœ‰æ›´é«˜çº§çš„CAäº†ï¼Œæ‰€ä»¥è¦è¿›è¡Œè‡ªç­¾å‘ï¼Œç”¨ è‡ªå·±çš„private keyå¯¹ è‡ªå·±çš„è¯ä¹¦è¯·æ±‚ è¿›è¡Œç­¾å‘ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl x509 -req -in ca_request.req -signkey ca_private.key -days 365 -out ca.pem<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹è¯ä¹¦</span><br>openssl x509 -in ca.pem -noout -text<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621224336866.png" alt="image-20230621224336866" style="zoom:67%;"><p><strong>ï¼ˆ6ï¼‰CAæœºæ„å‘è¿è¥å•†ç­¾å‘è¯ä¹¦</strong></p><p>CAç”¨è‡ªå·±çš„CAè¯ä¹¦ca.pem å’Œ ç§é’¥ca_private.key ä¸º server.reqè¿è¥å•†è¯·æ±‚æ–‡ä»¶ç­¾åï¼Œç”Ÿæˆè¿è¥å•†çš„è¯ä¹¦:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl x509 -req -in server.req -CA ca.pem -CAkey ca_private.key -days 365 -CAcreateserial -out server.pem<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹è¯ä¹¦</span><br>openssl x509 -in server.pem -noout -text<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹å…¬é’¥</span><br>openssl x509 -in server.pem -noout -pubkey<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621225245969.png" alt="image-20230621225245969" style="zoom:67%;"><p><strong>ï¼ˆ7ï¼‰æŸ¥çœ‹æœåŠ¡å™¨è¯ä¹¦çš„moduluså’ŒæœåŠ¡å™¨ç§é’¥çš„modulusï¼Œåº”è¯¥ä¸€æ ·ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl x509 -in server.pem -noout -modulus<br>openssl rsa -in server_private.key -noout -modulus<br></code></pre></td></tr></table></figure><p><strong>ï¼ˆ8ï¼‰ç”¨æˆ·è®¿é—®httpsç½‘ç«™ï¼ŒæœåŠ¡å™¨ä¼šç”¨private keyåŠ å¯†æ•°æ®ä¼ è¾“ï¼ŒåŒæ—¶ä¼šæŠŠè¯ä¹¦ä¼ ç»™ç”¨æˆ·ï¼Œé‡Œé¢æœ‰public keyä¿¡æ¯ï¼Œç”¨äºè§£å¯†æ•°æ®ã€‚</strong></p><p>ç”¨æˆ·ä½¿ç”¨å…¬é’¥è§£å¯†çš„æ—¶å€™ï¼Œè¦ç¡®è®¤æ­¤å…¬é’¥æ˜¯å¦æ˜¯æœåŠ¡å•†çš„ï¼Œæ˜¯å¦æ˜¯å—ä¿¡ä»»çš„ã€‚</p><p>ç”¨æˆ·ä»æœåŠ¡å•†è¯ä¹¦ä¸­å‘ç°ï¼Œå…¶è¯ä¹¦æ˜¯ç”±æŸCAç­¾å‘çš„ï¼Œä»CAå®˜ç½‘ä¸‹è½½ä»–çš„è¯ä¹¦ï¼Œå‘ç°å®ƒç”± æ›´é«˜çº§CAç­¾å‘ æˆ–è€… æ˜¯rootè¯ä¹¦ï¼Œè‡ªç­¾å‘çš„ã€‚</p><p>è¿™æ—¶å°±å¯ä»¥ä¸€çº§ä¸€çº§çš„éªŒè¯è¯ä¹¦çš„åˆæ³•æ€§ï¼Œæœ€ç»ˆç¡®è®¤æœåŠ¡å•†çš„è¯ä¹¦æ˜¯å¦è¢«ä¿¡ä»»ã€‚</p><p>éªŒè¯åå°±å¯ä»¥ä½¿ç”¨å…¬é’¥è§£å¯†ä¿¡æ¯ï¼Œè¿›è¡Œé€šä¿¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl verify -CAfile ca.pem server.pem<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621225426965.png" alt="image-20230621225426965" style="zoom:67%;"><p><strong>ï¼ˆ9ï¼‰ä»è¯ä¹¦å¯¼å‡ºå…¬é’¥</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl x509 -in server.pem -noout -pubkey -out server_public.key<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621225505365.png" alt="image-20230621225505365" style="zoom:67%;"><p><strong>ï¼ˆ10ï¼‰ä½¿ç”¨å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">åˆ›å»ºæµ‹è¯•æ–‡ä»¶</span><br>cat amx.txt<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621225609552.png" alt="image-20230621225609552" style="zoom: 67%;"><p>åŠ è§£å¯†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">åŠ å¯†</span><br>openssl rsautl -encrypt -in test.txt -inkey server_public.key -pubin -out test_encrypt.txt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è§£å¯†</span><br>openssl rsautl -decrypt -in test_encrypt.txt -inkey server_private.key -out test_decrypt.txt<br></code></pre></td></tr></table></figure><img src="/2023/06/21/openssl%E6%A8%A1%E6%8B%9F%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B/image-20230621225700280.png" alt="image-20230621225700280" style="zoom:67%;"><p>æœ€ç»ˆçš„æ–‡æœ¬è§£å¯†æˆåŠŸâ€¦</p><p><strong>ï¼ˆ11ï¼‰æŸ¥çœ‹è¯ä¹¦å†…å®¹</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦çš„å†…å®¹ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -text</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦çš„ç³»åˆ—å·ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -serial</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦çš„æ‹¥æœ‰è€…åå­—ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -subject</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä»¥RFC2253è§„å®šçš„æ ¼å¼æ‰“å°å‡ºè¯ä¹¦çš„æ‹¥æœ‰è€…åå­—ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -subject -nameopt RFC2253</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦çš„MD5ç‰¹å¾å‚æ•°ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -fingerprint</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦æœ‰æ•ˆæœŸï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -dates</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">æ‰“å°å‡ºè¯ä¹¦å…¬é’¥ï¼šopenssl x509 -<span class="hljs-keyword">in</span> server.pem -noout -pubkey</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼šopenssl verify -CAfile ca.pem server.pem</span><br></code></pre></td></tr></table></figure><p>â­<strong>ï¼ˆ12ï¼‰è¯ä¹¦ç§˜é’¥è¦ä½¿ç”¨ç›¸åŒçš„ç¼–ç æ ¼å¼</strong></p><p><strong>ï¼ˆ13ï¼‰è¯ä¹¦æ ¼å¼è½¬æ¢</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">PEMè½¬DERæ ¼å¼ï¼šopenssl x509 -inform pem -<span class="hljs-keyword">in</span> server.pem -outform der -out server.der</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">DERè½¬PEMæ ¼å¼ï¼šopenssl x509 -inform der -<span class="hljs-keyword">in</span> server.der -outform pem -out server.pem0</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“é”å±ä¸FBEæµ…æµ…ç†è§£</title>
    <link href="/2023/06/18/%E5%AE%89%E5%8D%93%E9%94%81%E5%B1%8F%E4%B8%8EFBE%E6%B5%85%E6%B5%85%E7%90%86%E8%A7%A3/"/>
    <url>/2023/06/18/%E5%AE%89%E5%8D%93%E9%94%81%E5%B1%8F%E4%B8%8EFBE%E6%B5%85%E6%B5%85%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“é”å±ä¸FBEæµ…æµ…ç†è§£"><a href="#å®‰å“é”å±ä¸FBEæµ…æµ…ç†è§£" class="headerlink" title="å®‰å“é”å±ä¸FBEæµ…æµ…ç†è§£"></a>å®‰å“é”å±ä¸FBEæµ…æµ…ç†è§£</h1><blockquote><p>ğŸ”´ <strong>æ³¨æ„</strong>ï¼šæœ¬æ–‡æ˜¯åŸºäºAndroid 12(S)è¿›è¡Œåˆ†æçš„ï¼Œå¯èƒ½ä¸Android 10(Q)æœ‰äº›å‡ºå…¥ã€‚</p></blockquote><h2 id="1-LockscreenCredentialå¯¹è±¡"><a href="#1-LockscreenCredentialå¯¹è±¡" class="headerlink" title="1.LockscreenCredentialå¯¹è±¡"></a>1.LockscreenCredentialå¯¹è±¡</h2><img src="/2023/06/18/%E5%AE%89%E5%8D%93%E9%94%81%E5%B1%8F%E4%B8%8EFBE%E6%B5%85%E6%B5%85%E7%90%86%E8%A7%A3/image-20230618201829816.png" alt="image-20230618201829816" style="zoom:75%;"><p>ä»å®‰å“æ–‡æ¡£å¯ä»¥çœ‹å‡ºï¼ŒLockscreenCredentialæ˜¯ä¸€ä¸ªé”å±å‡­è¯ï¼Œå¯ä»¥æ˜¯ç©ºå¯†ç ï¼Œå›¾æ¡ˆï¼Œå¯†ç ï¼Œæˆ–è€…PINç ç­‰ã€‚ä¹Ÿå°±æ˜¯è¯´LockscreenCredentialæ˜¯ä¸€ä¸ªé”å±å‡­è¯çš„æŠ½è±¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>LockscreenCredential.createPassword</strong>å»æ„é€ ä¸€ä¸ªcredentialå¯¹è±¡ã€‚</p><blockquote><p>è¿™é‡Œè¯¦ç»†çš„å¯ä»¥å…ˆå­¦ä¹ ï¼š<a href="https://blog.csdn.net/weixin_42135087/article/details/124565234">https://blog.csdn.net/weixin_42135087/article/details/124565234</a></p></blockquote><hr><h2 id="2-è®¾ç½®é”å±ä¸FBEçš„å…³ç³»"><a href="#2-è®¾ç½®é”å±ä¸FBEçš„å…³ç³»" class="headerlink" title="2.è®¾ç½®é”å±ä¸FBEçš„å…³ç³»"></a>2.è®¾ç½®é”å±ä¸FBEçš„å…³ç³»</h2><h3 id="2-1-addUserKeyAuthå±‚å±‚è°ƒç”¨"><a href="#2-1-addUserKeyAuthå±‚å±‚è°ƒç”¨" class="headerlink" title="2.1 addUserKeyAuthå±‚å±‚è°ƒç”¨"></a>2.1 addUserKeyAuthå±‚å±‚è°ƒç”¨</h3><p>â­ åœ¨Androidç³»ç»Ÿé‡çš„è®¾ç½®å¯†ç ã€æ¸…é™¤å¯†ç ã€ä¿®æ”¹å¯†ç ï¼Œéƒ½æ˜¯è°ƒç”¨åˆ°LockSettingsService.javaçš„setLockCredentialå‡½æ•°è¿›è¡Œçš„ï¼Œè€ŒsetLockCredentialåˆè°ƒç”¨äº†setLockCredentialInternalã€‚ã€å¼•ç”¨ï¼š<a href="https://blog.csdn.net/weixin_42135087/article/details/109726612?spm=1001.2014.3001.5506%E3%80%91">https://blog.csdn.net/weixin_42135087/article/details/109726612?spm=1001.2014.3001.5506ã€‘</a></p><blockquote><p>ä»<a href="https://blog.csdn.net/weixin_42135087">ä»£ç æ”¹å˜ä¸–ç•Œctw</a>å¤§å“¥çš„åšå®¢ä¸­å¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†è®¾ç½®ç”¨æˆ·å¯†ç çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°setLockCredentialInternal ï¼Œä¸‹é¢çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><p>setLockCredentialInternal -&gt; setUserKeyProtection -&gt;  addUserKeyAuth</p><p>ä»addUserKeyAuthä»å’ŒFBEæ‰¯ä¸Šäº†å…³ç³»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\locksettings\LockSettingsService.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserKeyAuth</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> mUserManager.getUserInfo(userId);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">callingId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();<br>    <span class="hljs-comment">// è°ƒç”¨SMSçš„addUserKeyAuthæ–¹æ³•</span><br>    mStorageManager.addUserKeyAuth(userId, userInfo.serialNumber, token, secret);<br>&#125;<br><br><span class="hljs-comment">// ---------------------------------------------------------------</span><br><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\StorageManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserKeyAuth</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> serialNumber, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret)</span> &#123;<br>    mVold.addUserKeyAuth(userId, serialNumber, encodeBytes(token), encodeBytes(secret));<br>&#125;<br><br><span class="hljs-comment">// ---------------------------------------------------------------</span><br><span class="hljs-comment">// system\vold\VoldNativeService.cpp</span><br>binder::Status VoldNativeService::addUserKeyAuth(int32_t userId, int32_t userSerial,<br>                                                 const std::string&amp; token,<br>                                                 const std::string&amp; secret) &#123;<br>    <span class="hljs-keyword">if</span> (!token_empty(token)) &#123;<br>        LOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;Vold doesn&#x27;t use auth tokens, but non-empty token passed to addUserKeyAuth.&quot;</span>;<br>        <span class="hljs-keyword">return</span> binder::Status::fromServiceSpecificError(-EINVAL);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> translateBool(fscrypt_add_user_key_auth(userId, userSerial, secret));<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼ŒVoldæœåŠ¡æ˜¯ä¸éœ€è¦AuthTokençš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å‘FBEä¼ é€’ã€‚</p><h3 id="2-2-fscrypt-add-user-key-authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™"><a href="#2-2-fscrypt-add-user-key-authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™" class="headerlink" title="2.2 fscrypt_add_user_key_authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™"></a>2.2 fscrypt_add_user_key_authå¼€å§‹æ·»åŠ ç”¨æˆ·æƒé™</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_add_user_key_auth</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">int</span> serial, <span class="hljs-type">const</span> std::string&amp; secret_hex)</span> </span>&#123;<br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ”¯æŒæ–‡ä»¶çº§åŠ å¯†</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">fscrypt_is_native</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// è¿˜åŸé”å±ç </span><br>    <span class="hljs-keyword">auto</span> auth = <span class="hljs-built_in">authentication_from_hex</span>(secret_hex);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">fscrypt_rewrap_user_key</span>(user_id, serial, kEmptyAuthentication, *auth);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨fscrypt_rewrap_user_key</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_rewrap_user_key</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">int</span> serial,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">const</span> android::vold::KeyAuthentication&amp; retrieve_auth,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">const</span> android::vold::KeyAuthentication&amp; store_auth)</span> </span>&#123;<br>    <span class="hljs-comment">// è·å–å½“å‰ç”¨æˆ·çš„CE_KEYç›®å½•: /data/misc/vold/user_keys/ce/&lt;userid&gt;</span><br>    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> directory_path = <span class="hljs-built_in">get_ce_key_directory_path</span>(user_id);<br>    KeyBuffer ce_key;<br>    std::string ce_key_current_path = <span class="hljs-built_in">get_ce_key_current_path</span>(directory_path); <span class="hljs-comment">// /data/misc/vold/user_keys/ce/&lt;userid&gt;/current</span><br>    <span class="hljs-built_in">retrieveKey</span>(ce_key_current_path, kEmptyAuthentication, &amp;ce_key);<br>    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> paths = <span class="hljs-built_in">get_ce_key_paths</span>(directory_path);<br>    std::string ce_key_path;<br>    <span class="hljs-comment">// æ–°è·¯å¾„: /data/misc/vold/user_keys/ce/&lt;userid&gt;/current/cx%010uï¼Œä¾‹å¦‚/data/misc/vold/user_keys/ce/0/current/cx0000000000</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">get_ce_key_new_path</span>(directory_path, paths, &amp;ce_key_path)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// user_key_temp: /data/misc/vold/user_keys/temp</span><br>    <span class="hljs-comment">// ä¿å­˜CE Key</span><br>    <span class="hljs-keyword">if</span> (!android::vold::<span class="hljs-built_in">storeKeyAtomically</span>(ce_key_path, user_key_temp, store_auth, ce_key))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨storeKeyAtomicallyä¿å­˜å½“å‰ç”¨æˆ·çš„CE Key</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">storeKeyAtomically</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key_path, <span class="hljs-type">const</span> std::string&amp; tmp_path,</span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-type">const</span> KeyAuthentication&amp; auth, <span class="hljs-type">const</span> KeyBuffer&amp; key)</span> </span>&#123;<br>    <span class="hljs-comment">// åé¢ä¼šå°†tmp_pathæ¢æˆKey_pathï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æ”¹ä¸ºkey_path</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">storeKey</span>(key_path, auth, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨storeKeyã€â­ è¿™é‡Œæ‰€æœ‰çš„æ“ä½œå³ä½¿éƒ½æ˜¯åœ¨&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;tempä¸­å¤„ç†çš„ï¼Œåªæ˜¯åé¢ä¼šæœ‰RenameKeyDirå’ŒFsyncParentDirectoryæ“ä½œï¼Œåªè¦æ“ä½œæˆåŠŸäº†ï¼Œå°±ç›¸å½“äº<code>/data/misc/vold/user_keys/ce/&lt;userid&gt;/current</code>ã€‘</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">storeKey</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; dir, <span class="hljs-type">const</span> KeyAuthentication&amp; auth, <span class="hljs-type">const</span> KeyBuffer&amp; key)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">mkdir</span>(dir.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0700</span>)) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;key mkdir &quot;</span> &lt;&lt; dir;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// å‘/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/versionä¸­å†™å…¥1</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kCurrentVersion, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_version)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// åˆ›å»ºéšæœºçš„secdiscardable_hashå€¼</span><br>    std::string secdiscardable_hash;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">createSecdiscardable</span>(dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_secdiscardable, &amp;secdiscardable_hash)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å¦‚æœæœ‰é”å±å¯†ç ï¼Œåˆ™stretchingä¸ºnone; å¦‚æœæ²¡æœ‰é”å±å¯†ç ï¼Œåˆ™stretchingä¸ºnopassword</span><br>    std::string stretching = <span class="hljs-built_in">getStretching</span>(auth);<br>    <span class="hljs-comment">// å‘/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/stretchingä¸­å†™å…¥stretchingçš„å€¼</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(stretching, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_stretching)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// ç”ŸæˆappIdï¼Œå¦‚æœè®¾ç½®äº†é”å±å¯†ç ï¼Œåˆ™ä¸ºappId = hash + auth.secretï¼›æ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œåˆ™appId = hash</span><br>    std::string appId;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateAppId</span>(auth, stretching, secdiscardable_hash, &amp;appId)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    std::string encryptedKey;<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰è®¾ç½®é”å±å¯†ç ï¼Œä½¿ç”¨keymasterç®¡ç†</span><br>    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) &#123;<br>        Keymaster keymaster;<br>        <span class="hljs-keyword">if</span> (!keymaster) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        std::string kmKey;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateKeyStorageKey</span>(keymaster, appId, &amp;kmKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(kmKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_keymaster_key_blob)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        km::AuthorizationSet keyParams = <span class="hljs-built_in">beginParams</span>(appId);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithKeymasterKey</span>(keymaster, dir, keyParams, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è®¾ç½®äº†é”å±å¯†ç ï¼Œä¸é€‚ç”¨keymaster</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">encryptWithoutKeymaster</span>(appId, key, &amp;encryptedKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// å°†åŠ å¯†åçš„CE keyå†™å…¥/data/misc/vold/user_keys/ce/&lt;userid&gt;/current/encrypted_key</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">writeStringToFile</span>(encryptedKey, dir + <span class="hljs-string">&quot;/&quot;</span> + kFn_encrypted_key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">FsyncDirectory</span>(dir)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>â˜ƒï¸ <strong>è¿™é‡Œå°±æ­ç¤ºäº†é”å±å¯†ç ä¸FBEçš„å…³ç³»ï¼Œå½“è®¾ç½®äº†é”å±å¯†ç çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šå°†é”å±å…ƒç´ ä¸­çš„secretç”ŸæˆappIdï¼Œåœ¨åŠ å¯†ce keyçš„æ—¶å€™è¦ç”¨åˆ°ã€‚</strong></p></blockquote><h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h2><blockquote><p><a href="https://www.cnblogs.com/bobfly1984/p/14090078.html">https://www.cnblogs.com/bobfly1984/p/14090078.html</a></p></blockquote><ol><li>æ ¹æ®&#x2F;data&#x2F;unencrypted&#x2F;keyå’Œ&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;de&#x2F;0&#x2F;è·¯å¾„æ˜¯å¦å­˜åœ¨åˆ¤æ–­é¦–æ¬¡å¼€æœºè¿˜æ˜¯éé¦–æ¬¡å¼€æœº</li><li>system DEå­˜å‚¨ç©ºé—´å’Œuser DEå­˜å‚¨ç©ºé—´ä½¿ç”¨keymasterkeyåŠ è§£å¯†ï¼Œå¯†é’¥å…ƒç´ secretå’Œtokenä¸ºç©º</li><li><strong>ä¸è®¾ç½®é”å±å¯†ç ï¼Œuser CEå­˜å‚¨ç©ºé—´ä½¿ç”¨keymasterkeyåŠ è§£å¯†ï¼Œå¯†é’¥å…ƒç´ secretå’Œtokenä¸ºç©º</strong></li><li><strong>è®¾ç½®é”å±å¯†ç ï¼Œuser CEå­˜å‚¨ç©ºé—´ä½¿ç”¨withoutkeymasteryåŠ è§£å¯†ï¼Œå¯†é’¥å…ƒç´ secretä¸ºéç©ºï¼Œtokenä¸ºç©º</strong></li><li>åˆ é™¤é”å±å¯†ç åï¼Œuser CE å­˜å‚¨ç©ºé—´é‡‡ç”¨ ä¸è®¾ç½®é”å¯†ç  åŠ å¯†ç­–ç•¥</li><li>æ·»åŠ é”å±å¯†ç ã€ä¿®æ”¹é”å±å¯†ç ã€åˆ é™¤é”å±å¯†ç ååœ¨æ·»åŠ é”å±å¯†ç ï¼Œä¼ ä¸‹æ¥çš„secretå€¼æ˜¯ä¸€æ ·çš„ï¼Œç¡®ä¿ä¸åŒåœºæ™¯ä¸‹åŠ å¯†çš„æ–‡ä»¶éƒ½èƒ½è§£å¯†</li><li>å¯¹user CEå­˜å‚¨ç©ºé—´åŠ è§£å¯†çš„keyï¼Œä¸ç®¡æ˜¯è®¾ç½®é”å±å¯†ç è¿˜æ˜¯ä¸è®¾ç½®é”å±å¯†ç ï¼Œè¿™ä¸ªkeyå§‹ç»ˆæ˜¯ä¸€æ ·çš„å³é¦–æ¬¡å¼€æœºç”Ÿæˆçš„keyã€‚ä¸åŒçš„åªæ˜¯åŠ å¯†å…ƒç´ å’ŒåŠ å¯†æ–¹å¼ã€‚</li><li>&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;current # cat stretching<br>nopassword &#x2F;&#x2F; æ²¡æœ‰è®¾ç½®é”å±å¯†ç <br>none &#x2F;&#x2F; è®¾ç½®é”å±å¯†</li><li>&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;ce&#x2F;0&#x2F;current&#x2F;keymaster_key_blob &#x2F;&#x2F; æ­¤æ–‡ä»¶å­˜åœ¨æ„å‘³keymasteråŠ è§£å¯†ã€å¦åˆ™ä½¿ç”¨withoutkeymasteryåŠ è§£å¯†</li></ol>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android 12å¤šç”¨æˆ·æœºåˆ¶ä¸­çš„è¿æ¥ä¸ä¼šè¯</title>
    <link href="/2023/06/06/Android-12%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E4%BC%9A%E8%AF%9D/"/>
    <url>/2023/06/06/Android-12%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E4%BC%9A%E8%AF%9D/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-12å¤šç”¨æˆ·æœºåˆ¶ä¸­çš„è¿æ¥ä¸ä¼šè¯"><a href="#Android-12å¤šç”¨æˆ·æœºåˆ¶ä¸­çš„è¿æ¥ä¸ä¼šè¯" class="headerlink" title="Android 12å¤šç”¨æˆ·æœºåˆ¶ä¸­çš„è¿æ¥ä¸ä¼šè¯"></a>Android 12å¤šç”¨æˆ·æœºåˆ¶ä¸­çš„è¿æ¥ä¸ä¼šè¯</h1><img src="/2023/06/06/Android-12%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%B8%8E%E4%BC%9A%E8%AF%9D/image-20230606233821913.png" alt="image-20230606233821913" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“åˆ†åŒºå­˜å‚¨</title>
    <link href="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/"/>
    <url>/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“åˆ†åŒºå­˜å‚¨"><a href="#å®‰å“åˆ†åŒºå­˜å‚¨" class="headerlink" title="å®‰å“åˆ†åŒºå­˜å‚¨"></a>å®‰å“åˆ†åŒºå­˜å‚¨</h1><blockquote><p>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œguolinã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/guolin_blog/article/details/105419420/">https://blog.csdn.net/guolin_blog/article/details/105419420/</a></p></blockquote><p>â­<strong>åˆ†åŒºå­˜å‚¨çš„å‰ææ˜¯è§£å†³SDå¡å­˜å‚¨çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨å­˜å‚¨çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸æ¶‰åŠåŸæœ¬çš„å®‰å“å†…éƒ¨å­˜å‚¨ã€‚</strong></p><h2 id="1-ç†è§£åˆ†åŒºå­˜å‚¨"><a href="#1-ç†è§£åˆ†åŒºå­˜å‚¨" class="headerlink" title="1.ç†è§£åˆ†åŒºå­˜å‚¨"></a>1.ç†è§£åˆ†åŒºå­˜å‚¨</h2><p>Androidé•¿ä¹…ä»¥æ¥éƒ½æ”¯æŒå¤–ç½®å­˜å‚¨ç©ºé—´è¿™ä¸ªåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„SDå¡å­˜å‚¨ã€‚è¿™ä¸ªåŠŸèƒ½ä½¿ç”¨å¾—æå…¶å¹¿æ³›ï¼Œå‡ ä¹æ‰€æœ‰çš„Appéƒ½å–œæ¬¢åœ¨SDå¡çš„æ ¹ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªè‡ªå·±ä¸“å±çš„ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾å„ç±»æ–‡ä»¶å’Œæ•°æ®ã€‚</p><p>é‚£ä¹ˆè¿™ä¹ˆåšæœ‰ä»€ä¹ˆå¥½å¤„å—ï¼Ÿæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå¤§æ¦‚æœ‰ä¸¤ç‚¹å§ã€‚ç¬¬ä¸€ï¼Œå­˜å‚¨åœ¨SDå¡çš„æ–‡ä»¶ä¸ä¼šè®¡å…¥åˆ°åº”ç”¨ç¨‹åºçš„å ç”¨ç©ºé—´å½“ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½ åœ¨SDå¡å­˜æ”¾äº†1Gçš„æ–‡ä»¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºåœ¨è®¾ç½®ä¸­æ˜¾ç¤ºçš„å ç”¨ç©ºé—´ä»ç„¶å¯èƒ½åªæœ‰å‡ åKã€‚ç¬¬äºŒï¼Œå­˜å‚¨åœ¨SDå¡çš„æ–‡ä»¶ï¼Œå³ä½¿åº”ç”¨ç¨‹åºè¢«å¸è½½äº†ï¼Œè¿™äº›æ–‡ä»¶ä»ç„¶ä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼Œè¿™æœ‰åŠ©äºå®ç°ä¸€äº›éœ€è¦æ•°æ®è¢«æ°¸ä¹…ä¿ç•™çš„åŠŸèƒ½ã€‚</p><p>ç„¶è€Œï¼Œè¿™äº›â€œå¥½å¤„â€çœŸçš„æ˜¯å¥½å¤„å—ï¼Ÿæˆ– è®¸å¯¹äºå¼€å‘è€…è€Œè¨€è¿™ç®—æ˜¯å¥½å¤„å§ï¼Œä½†å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œä¸Šè¿°å¥½å¤„æ— å¼‚äºä¸€äº›æµæ°“è¡Œä¸ºã€‚å› ä¸ºè¿™ä¼šå°†ç”¨æˆ·çš„SDå¡ç©ºé—´æå¾—ä¹±ç³Ÿç³Ÿçš„ï¼Œè€Œä¸”å³ä½¿æˆ‘å¸è½½äº†ä¸€ä¸ªå®Œå…¨ä¸å†ä½¿ç”¨çš„ç¨‹åºï¼Œå®ƒæ‰€äº§ç”Ÿçš„åƒåœ¾æ–‡ä»¶å´å¯èƒ½ä¼šä¸€ç›´ä¿ç•™åœ¨æˆ‘çš„æ‰‹æœºä¸Šã€‚</p><p>å¦å¤–ï¼Œå­˜å‚¨åœ¨SDå¡ä¸Šçš„æ–‡ä»¶å±äºå…¬æœ‰æ–‡ä»¶ï¼Œæ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½æœ‰æƒéšæ„è®¿é—®ï¼Œè¿™ä¹Ÿå¯¹æ•°æ®çš„å®‰å…¨æ€§å¸¦æ¥äº†å¾ˆå¤§çš„æŒ‘æˆ˜ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒGoogleåœ¨Android 10å½“ä¸­åŠ å…¥äº†ä½œç”¨åŸŸå­˜å‚¨åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆåˆ°åº•ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸå­˜å‚¨å‘¢ï¼Ÿç®€å•æ¥è®²ï¼Œå°±æ˜¯Androidç³»ç»Ÿå¯¹SDå¡çš„ä½¿ç”¨åšäº†å¾ˆå¤§çš„é™åˆ¶ã€‚**ä»Android 10å¼€å§‹ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºåªèƒ½æœ‰æƒåœ¨è‡ªå·±çš„å¤–ç½®å­˜å‚¨ç©ºé—´å…³è”ç›®å½•ä¸‹è¯»å–å’Œåˆ›å»ºæ–‡ä»¶ï¼Œè·å–è¯¥å…³è”ç›®å½•çš„ä»£ç æ˜¯ï¼šcontext.getExternalFilesDir()**ã€‚å…³è”ç›®å½•å¯¹åº”çš„è·¯å¾„å¤§è‡´å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">/storage/emulated/<span class="hljs-number">0</span>/Android/data/&lt;åŒ…å&gt;/files<br></code></pre></td></tr></table></figure><p>å°†æ•°æ®å­˜æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼Œä½ å°†å¯ä»¥å®Œå…¨ä½¿ç”¨ä¹‹å‰çš„å†™æ³•æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œä¸éœ€è¦åšä»»ä½•å˜æ›´å’Œé€‚é…ã€‚ä½†åŒæ—¶ï¼Œåˆšæ‰æåˆ°çš„é‚£ä¸¤ä¸ªâ€œå¥½å¤„â€ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚è¿™ä¸ªç›®å½•ä¸­çš„æ–‡ä»¶ä¼šè¢«è®¡å…¥åˆ°åº”ç”¨ç¨‹åºçš„å ç”¨ç©ºé—´å½“ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šéšç€åº”ç”¨ç¨‹åºçš„å¸è½½è€Œè¢«åˆ é™¤ã€‚</p><p>é‚£ä¹ˆæœ‰äº›æœ‹å‹å¯èƒ½ä¼šé—®äº†ï¼Œæˆ‘å°±æ˜¯éœ€è¦è®¿é—®å…¶ä»–ç›®å½•è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚è¯»å–æ‰‹æœºç›¸å†Œä¸­çš„å›¾ç‰‡ï¼Œæˆ–è€…å‘æ‰‹æœºç›¸å†Œä¸­æ·»åŠ ä¸€å¼ å›¾ç‰‡ã€‚ä¸ºæ­¤ï¼ŒAndroidç³»ç»Ÿé’ˆå¯¹æ–‡ä»¶ç±»å‹è¿›è¡Œäº†åˆ†ç±»ï¼Œå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘è¿™ä¸‰ç±»æ–‡ä»¶å°†å¯ä»¥é€šè¿‡MediaStore APIæ¥è¿›è¡Œè®¿é—®ï¼Œè€Œå…¶ä»–ç±»å‹çš„æ–‡ä»¶åˆ™éœ€è¦ä½¿ç”¨ç³»ç»Ÿçš„æ–‡ä»¶é€‰æ‹©å™¨æ¥è¿›è¡Œè®¿é—®ã€‚</p><p>å¦å¤–ï¼Œ<strong>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‘åª’ä½“åº“è´¡çŒ®çš„å›¾ç‰‡ã€éŸ³é¢‘æˆ–è§†é¢‘ï¼Œå°†ä¼šè‡ªåŠ¨æ‹¥æœ‰å…¶è¯»å†™æƒé™</strong>ï¼Œä¸éœ€è¦é¢å¤–ç”³è¯·READ_EXTERNAL_STORAGEå’ŒWRITE_EXTERNAL_STORAGEæƒé™ã€‚<strong>è€Œå¦‚æœä½ è¦è¯»å–å…¶ä»–åº”ç”¨ç¨‹åºå‘åª’ä½“åº“è´¡çŒ®çš„å›¾ç‰‡ã€éŸ³é¢‘æˆ–è§†é¢‘ï¼Œåˆ™å¿…é¡»è¦ç”³è¯·READ_EXTERNAL_STORAGEæƒé™æ‰è¡Œ</strong>ã€‚WRITE_EXTERNAL_STORAGEæƒé™å°†ä¼šåœ¨æœªæ¥çš„Androidç‰ˆæœ¬ä¸­åºŸå¼ƒã€‚</p><p>å¥½äº†ï¼Œå…³äºä½œç”¨åŸŸå­˜å‚¨çš„ç†è®ºçŸ¥è¯†å°±å…ˆè®²åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å·²ç»å¯¹å®ƒæœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹ä¸Šæ‰‹æ“ä½œå§ã€‚</p><hr><p>è¿˜æœ‰ä¸€éƒ¨åˆ†å¸–å­ä¹Ÿæœ‰è¿™ç§è¯´æ³•ï¼Œ<strong>å¤–å¡ï¼ˆå¤–éƒ¨å­˜å‚¨å·ï¼‰ï¼Œ åªèƒ½è®¿é—®æ‰€è°“çš„å…±äº«æ–‡ä»¶å¤¹ï¼Œæˆ–è€…è¯´å…¬å…±ç›®å½•ã€‚è€Œä¸”åªèƒ½è®¿é—®è¿™äº›ç›®å½•çš„å¤šåª’ä½“æ–‡ä»¶(å›¾ç‰‡ï¼Œè§†é¢‘ï¼ŒéŸ³é¢‘)ã€‚éå¤šåª’ä½“æ–‡ä»¶åªèƒ½é€šè¿‡ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨è®¿é—®ï¼Œæ— æ³•åƒMediaStoreä¸€æ ·åˆ—ä¸¾äº†ã€‚</strong></p><img src="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/image-20230606225153789.png" alt="image-20230606225153789" style="zoom:67%;"><h2 id="2-æˆ‘ä¸€å®šè¦å‡çº§å—"><a href="#2-æˆ‘ä¸€å®šè¦å‡çº§å—" class="headerlink" title="2.æˆ‘ä¸€å®šè¦å‡çº§å—"></a>2.æˆ‘ä¸€å®šè¦å‡çº§å—</h2><p>ä¸€å®šä¼šæœ‰å¾ˆå¤šæœ‹å‹å…³å¿ƒè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ¯å½“é€‚é…å‡çº§é¢ä¸´ç€éœ€è¦æ›´æ”¹å¤§é‡ä»£ç çš„æ—¶å€™ï¼Œå¤§å¤šæ•°äººçš„ç¬¬ä¸€æƒ³æ³•éƒ½æ˜¯èƒ½ä¸å‡å°±ä¸å‡ï¼Œæˆ–è€…èƒ½æ™šå‡å°±æ™šå‡ã€‚è€Œåœ¨ä½œç”¨åŸŸå­˜å‚¨è¿™ä¸ªåŠŸèƒ½ä¸Šé¢ï¼Œæ­å–œå¤§å®¶ï¼Œæš‚æ—¶ç¡®å®æ˜¯å¯ä»¥ä¸ç”¨å‡çº§çš„ã€‚</p><p>ç›®å‰Android 10ç³»ç»Ÿå¯¹äºä½œç”¨åŸŸå­˜å‚¨é€‚é…çš„è¦æ±‚è¿˜ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼ï¼Œæ¯•ç«Ÿä¹‹å‰ä¼ ç»Ÿå¤–ç½®å­˜å‚¨ç©ºé—´çš„ç”¨æ³•å®åœ¨æ˜¯å¤ªå¹¿æ³›äº†ã€‚å¦‚æœä½ çš„é¡¹ç›®æŒ‡å®šçš„targetSdkVersionä½äº29ï¼Œé‚£ä¹ˆå³ä½¿ä¸åšä»»ä½•ä½œç”¨åŸŸå­˜å‚¨æ–¹é¢çš„é€‚é…ï¼Œä½ çš„é¡¹ç›®ä¹Ÿå¯ä»¥æˆåŠŸè¿è¡Œåˆ°Android 10æ‰‹æœºä¸Šã€‚</p><p>è€Œå¦‚æœä½ çš„targetSdkVersionå·²ç»æŒ‡å®šæˆäº†29ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå‡å¦‚ä½ è¿˜ä¸æƒ³è¿›è¡Œä½œç”¨åŸŸå­˜å‚¨çš„é€‚é…ï¼Œåªéœ€è¦åœ¨AndroidManifest.xmlä¸­åŠ å…¥å¦‚ä¸‹é…ç½®å³å¯ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">...</span> &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">android:requestLegacyExternalStorage</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">...</span>&gt;</span><br>    ...<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ®µé…ç½®è¡¨ç¤ºï¼Œå³ä½¿åœ¨Android 10ç³»ç»Ÿä¸Šï¼Œä»ç„¶å…è®¸ä½¿ç”¨ä¹‹å‰é—ç•™çš„å¤–ç½®å­˜å‚¨ç©ºé—´çš„ç”¨æ³•æ¥è¿è¡Œç¨‹åºï¼Œè¿™æ ·å°±ä¸ç”¨å¯¹ä»£ç è¿›è¡Œä»»ä½•ä¿®æ”¹äº†ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ç§æƒå®œä¹‹è®¡ï¼Œåœ¨æœªæ¥çš„Androidç³»ç»Ÿç‰ˆæœ¬ä¸­ï¼Œè¿™æ®µé…ç½®éšæ—¶éƒ½å¯èƒ½ä¼šå¤±æ•ˆï¼ˆAndroid 11ä¸­å·²å¼ºåˆ¶å¯ç”¨ä½œç”¨åŸŸå­˜å‚¨ï¼Œè¿™æ®µé…ç½®åœ¨Android 11å½“ä¸­å·²ä¸å†æœ‰æ•ˆï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜æ˜¯éå¸¸æœ‰å¿…è¦ç°åœ¨å°±æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œåˆ°åº•è¯¥å¦‚ä½•å¯¹ä½œç”¨åŸŸå­˜å‚¨è¿›è¡Œé€‚é…ã€‚</p><p>å¦å¤–ï¼Œæœ¬ç¯‡æ–‡ç« ä¸­æ¼”ç¤ºçš„æ‰€æœ‰ç¤ºä¾‹ï¼Œéƒ½å¯ä»¥åˆ°ScopedStorageDemoè¿™ä¸ªå¼€æºåº“ä¸­æ‰¾åˆ°å…¶å¯¹åº”çš„æºç ã€‚</p><p>å¼€æºåº“åœ°å€æ˜¯ï¼š<a href="https://github.com/guolindev/ScopedStorageDemo">https://github.com/guolindev/ScopedStorageDemo</a></p><h2 id="3-è·å–ç›¸å†Œä¸­çš„å›¾ç‰‡"><a href="#3-è·å–ç›¸å†Œä¸­çš„å›¾ç‰‡" class="headerlink" title="3.è·å–ç›¸å†Œä¸­çš„å›¾ç‰‡"></a>3.è·å–ç›¸å†Œä¸­çš„å›¾ç‰‡</h2><p>é¦–å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•åœ¨ä½œç”¨åŸŸå­˜å‚¨å½“ä¸­è·å–æ‰‹æœºç›¸å†Œé‡Œçš„å›¾ç‰‡ã€‚æ³¨æ„ï¼Œè™½ç„¶æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘æ˜¯ä»¥å›¾ç‰‡æ¥ä¸¾ä¾‹çš„ï¼Œä½†æ˜¯è·å–éŸ³é¢‘ã€è§†é¢‘çš„ç”¨æ³•ä¹Ÿæ˜¯åŸºæœ¬ç›¸åŒçš„ã€‚</p><p>ä¸åŒäºè¿‡å»å¯ä»¥ç›´æ¥è·å–åˆ°ç›¸å†Œä¸­å›¾ç‰‡çš„ç»å¯¹è·¯å¾„ï¼Œåœ¨ä½œç”¨åŸŸå­˜å‚¨å½“ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å€ŸåŠ©MediaStore APIè·å–åˆ°å›¾ç‰‡çš„Uriï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">val</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> contentResolver.query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;$&#123;MediaStore.MediaColumns.DATE_ADDED&#125; desc&quot;</span>)<br><span class="hljs-keyword">if</span> (cursor != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">while</span> (cursor.moveToNext()) &#123;<br>        <span class="hljs-type">val</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> cursor.getLong(cursor.getColumnIndexOrThrow(MediaStore.MediaColumns._ID))<br>        <span class="hljs-type">val</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> ContentUris.withAppendedId(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, id)<br>        println(<span class="hljs-string">&quot;image uri is $uri&quot;</span>)<br>    &#125;<br>cursor.close()<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆæ˜¯é€šè¿‡ContentResolverè·å–åˆ°äº†ç›¸å†Œä¸­æ‰€æœ‰å›¾ç‰‡çš„idï¼Œç„¶åå†å€ŸåŠ©ContentUriså°†idæ‹¼è£…æˆä¸€ä¸ªå®Œæ•´çš„Uriå¯¹è±¡ã€‚ä¸€å¼ å›¾ç‰‡çš„Uriæ ¼å¼å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">content:<span class="hljs-comment">//media/external/images/media/321</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæœ‰äº›æœ‹å‹å¯èƒ½ä¼šé—®äº†ï¼Œè·å–åˆ°äº†Uriä¹‹åï¼Œæˆ‘åˆè¯¥æ€æ ·å°†è¿™å¼ å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥å‘¢ï¼Ÿè¿™å°±æœ‰å¾ˆå¤šç§åŠæ³•äº†ï¼Œæ¯”å¦‚ä½¿ç”¨Glideæ¥åŠ è½½å›¾ç‰‡ï¼Œå®ƒæœ¬èº«å°±æ”¯æŒä¼ å…¥Uriå¯¹è±¡æ¥ä½œä¸ºå›¾ç‰‡è·¯å¾„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Glide.with(context).load(uri).into(imageView)<br></code></pre></td></tr></table></figure><p>è€Œå¦‚æœä½ æ²¡æœ‰ä½¿ç”¨Glideæˆ–å…¶ä»–å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œæƒ³åœ¨ä¸å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“çš„æƒ…å†µä¸‹ç›´æ¥å°†ä¸€ä¸ªUriå¯¹è±¡è§£ææˆå›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">val</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> contentResolver.openFileDescriptor(uri, <span class="hljs-string">&quot;r&quot;</span>)<br><span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-type">val</span> <span class="hljs-variable">bitmap</span> <span class="hljs-operator">=</span> BitmapFactory.decodeFileDescriptor(fd.fileDescriptor)<br>fd.close()<br>    imageView.setImageBitmap(bitmap)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†ContentResolverçš„openFileDescriptor()æ–¹æ³•ï¼Œå¹¶ä¼ å…¥Uriå¯¹è±¡æ¥æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼Œç„¶åå†è°ƒç”¨BitmapFactoryçš„decodeFileDescriptor()æ–¹æ³•å°†æ–‡ä»¶å¥æŸ„è§£ææˆBitmapå¯¹è±¡å³å¯ã€‚</p><img src="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/20200409205348955.gif" alt="img" style="zoom: 80%;"><h2 id="4-å°†å›¾ç‰‡æ·»åŠ åˆ°ç›¸å†Œ"><a href="#4-å°†å›¾ç‰‡æ·»åŠ åˆ°ç›¸å†Œ" class="headerlink" title="4.å°†å›¾ç‰‡æ·»åŠ åˆ°ç›¸å†Œ"></a>4.å°†å›¾ç‰‡æ·»åŠ åˆ°ç›¸å†Œ</h2><p>å°†ä¸€å¼ å›¾ç‰‡æ·»åŠ åˆ°æ‰‹æœºç›¸å†Œè¦ç›¸å¯¹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºä¸åŒç³»ç»Ÿç‰ˆæœ¬ä¹‹é—´çš„å¤„ç†æ–¹å¼æ˜¯ä¸å¤ªä¸€æ ·çš„ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä¸€æ®µä»£ç ç¤ºä¾‹æ¥ç›´è§‚åœ°å­¦ä¹ ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addBitmapToAlbum</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>, displayName: <span class="hljs-type">String</span>, mimeType: <span class="hljs-type">String</span>, compressFormat: <span class="hljs-type">Bitmap</span>.<span class="hljs-type">CompressFormat</span>)</span></span> &#123;<br>    <span class="hljs-keyword">val</span> values = ContentValues()<br>    values.put(MediaStore.MediaColumns.DISPLAY_NAME, displayName)<br>    values.put(MediaStore.MediaColumns.MIME_TYPE, mimeType)<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;<br>        values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DCIM)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        values.put(MediaStore.MediaColumns.DATA, <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;Environment.getExternalStorageDirectory().path&#125;</span>/<span class="hljs-subst">$&#123;Environment.DIRECTORY_DCIM&#125;</span>/<span class="hljs-variable">$displayName</span>&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">val</span> uri = contentResolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values)<br>    <span class="hljs-keyword">if</span> (uri != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">val</span> outputStream = contentResolver.openOutputStream(uri)<br>        <span class="hljs-keyword">if</span> (outputStream != <span class="hljs-literal">null</span>) &#123;<br>            bitmap.compress(compressFormat, <span class="hljs-number">100</span>, outputStream)<br>outputStream.close()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•å°†ä¸€ä¸ªBitmapå¯¹è±¡æ·»åŠ åˆ°æ‰‹æœºç›¸å†Œå½“ä¸­ï¼Œæˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹ã€‚</p><p>æƒ³è¦å°†ä¸€å¼ å›¾ç‰‡æ·»åŠ åˆ°æ‰‹æœºç›¸å†Œï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªContentValueså¯¹è±¡ï¼Œç„¶åå‘è¿™ä¸ªå¯¹è±¡ä¸­æ·»åŠ ä¸‰ä¸ªé‡è¦çš„æ•°æ®ã€‚ä¸€ä¸ªæ˜¯DISPLAY_NAMEï¼Œä¹Ÿå°±æ˜¯å›¾ç‰‡æ˜¾ç¤ºçš„åç§°ï¼Œä¸€ä¸ªæ˜¯MIME_TYPEï¼Œä¹Ÿå°±æ˜¯å›¾ç‰‡çš„mimeç±»å‹ã€‚è¿˜æœ‰ä¸€ä¸ªæ˜¯å›¾ç‰‡å­˜å‚¨çš„è·¯å¾„ï¼Œä¸è¿‡è¿™ä¸ªå€¼åœ¨Android 10å’Œä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬ä¸­çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·ã€‚Android 10ä¸­æ–°å¢äº†ä¸€ä¸ªRELATIVE_PATHå¸¸é‡ï¼Œè¡¨ç¤ºæ–‡ä»¶å­˜å‚¨çš„ç›¸å¯¹è·¯å¾„ï¼Œå¯é€‰å€¼æœ‰DIRECTORY_DCIMã€DIRECTORY_PICTURESã€DIRECTORY_MOVIESã€DIRECTORY_MUSICç­‰ï¼Œåˆ†åˆ«è¡¨ç¤ºç›¸å†Œã€å›¾ç‰‡ã€ç”µå½±ã€éŸ³ä¹ç­‰ç›®å½•ã€‚è€Œåœ¨ä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰RELATIVE_PATHï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨DATAå¸¸é‡ï¼ˆå·²åœ¨Android 10ä¸­åºŸå¼ƒï¼‰ï¼Œå¹¶æ‹¼è£…å‡ºä¸€ä¸ªæ–‡ä»¶å­˜å‚¨çš„ç»å¯¹è·¯å¾„æ‰è¡Œã€‚</p><p>æœ‰äº†ContentValueså¯¹è±¡ä¹‹åï¼Œæ¥ä¸‹æ¥è°ƒç”¨ContentResolverçš„insert()æ–¹æ³•å³å¯è·å¾—æ’å…¥å›¾ç‰‡çš„Uriã€‚ä½†ä»…ä»…è·å¾—Uriä»ç„¶æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å‘è¯¥Uriæ‰€å¯¹åº”çš„å›¾ç‰‡å†™å…¥æ•°æ®æ‰è¡Œã€‚è°ƒç”¨ContentResolverçš„openOutputStream()æ–¹æ³•è·å¾—æ–‡ä»¶çš„è¾“å‡ºæµï¼Œç„¶åå°†Bitmapå¯¹è±¡å†™å…¥åˆ°è¯¥è¾“å‡ºæµå½“ä¸­å³å¯ã€‚</p><p>ä»¥ä¸Šä»£ç å³å¯å®ç°å°†Bitmapå¯¹è±¡å­˜å‚¨åˆ°æ‰‹æœºç›¸å†Œå½“ä¸­ï¼Œé‚£ä¹ˆæœ‰äº›æœ‹å‹å¯èƒ½ä¼šé—®äº†ï¼Œå¦‚æœæˆ‘è¦å­˜å‚¨çš„å›¾ç‰‡å¹¶ä¸æ˜¯Bitmapå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€å¼ ç½‘ç»œä¸Šçš„å›¾ç‰‡ï¼Œæˆ–è€…æ˜¯å½“å‰åº”ç”¨å…³è”ç›®å½•ä¸‹çš„å›¾ç‰‡è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å…¶å®æ–¹æ³•éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œå› ä¸ºä¸ç®¡æ˜¯ç½‘ç»œä¸Šçš„å›¾ç‰‡è¿˜æ˜¯å…³è”ç›®å½•ä¸‹çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬éƒ½èƒ½è·å–åˆ°å®ƒçš„è¾“å…¥æµï¼Œåªè¦ä¸æ–­è¯»å–è¾“å…¥æµä¸­çš„æ•°æ®ï¼Œç„¶åå†™å…¥åˆ°ç›¸å†Œå›¾ç‰‡æ‰€å¯¹åº”çš„è¾“å‡ºæµå½“ä¸­å°±å¯ä»¥äº†ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">writeInputStreamToAlbum</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>, displayName: <span class="hljs-type">String</span>, mimeType: <span class="hljs-type">String</span>)</span></span> &#123;<br>    <span class="hljs-keyword">val</span> values = ContentValues()<br>    values.put(MediaStore.MediaColumns.DISPLAY_NAME, displayName)<br>    values.put(MediaStore.MediaColumns.MIME_TYPE, mimeType)<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;<br>        values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DCIM)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        values.put(MediaStore.MediaColumns.DATA, <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;Environment.getExternalStorageDirectory().path&#125;</span>/<span class="hljs-subst">$&#123;Environment.DIRECTORY_DCIM&#125;</span>/<span class="hljs-variable">$displayName</span>&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">val</span> bis = BufferedInputStream(inputStream)<br>    <span class="hljs-keyword">val</span> uri = contentResolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values)<br>    <span class="hljs-keyword">if</span> (uri != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">val</span> outputStream = contentResolver.openOutputStream(uri)<br>        <span class="hljs-keyword">if</span> (outputStream != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">val</span> bos = BufferedOutputStream(outputStream)<br>            <span class="hljs-keyword">val</span> buffer = ByteArray(<span class="hljs-number">1024</span>)<br>            <span class="hljs-keyword">var</span> bytes = bis.read(buffer)<br>            <span class="hljs-keyword">while</span> (bytes &gt;= <span class="hljs-number">0</span>) &#123;<br>                bos.write(buffer, <span class="hljs-number">0</span> , bytes)<br>                bos.flush()<br>                bytes = bis.read(buffer)<br>            &#125;<br>            bos.close()<br>        &#125;<br>    &#125;<br>    bis.close()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­åªæ˜¯å°†è¾“å…¥æµå’Œè¾“å‡ºæµçš„éƒ¨åˆ†é‡æ–°ç¼–å†™äº†ä¸€ä¸‹ï¼Œå…¶ä»–éƒ¨åˆ†å’Œä¹‹å‰å­˜å‚¨Bitmapçš„ä»£ç æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œç›¸ä¿¡å¾ˆå¥½ç†è§£ã€‚</p><img src="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/20200409205454790.gif" alt="img" style="zoom:80%;"><h2 id="5-ä¸‹è½½æ–‡ä»¶åˆ°Downloadç›®å½•"><a href="#5-ä¸‹è½½æ–‡ä»¶åˆ°Downloadç›®å½•" class="headerlink" title="5.ä¸‹è½½æ–‡ä»¶åˆ°Downloadç›®å½•"></a>5.ä¸‹è½½æ–‡ä»¶åˆ°Downloadç›®å½•</h2><p>æ‰§è¡Œæ–‡ä»¶ä¸‹è½½æ“ä½œæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ä¸‹è½½pdfã€docæ–‡ä»¶ï¼Œæˆ–è€…ä¸‹è½½APKå®‰è£…åŒ…ç­‰ç­‰ã€‚åœ¨è¿‡å»ï¼Œè¿™äº›æ–‡ä»¶æˆ‘ä»¬é€šå¸¸éƒ½ä¼šä¸‹è½½åˆ°Downloadç›®å½•ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºå­˜æ”¾ä¸‹è½½æ–‡ä»¶çš„ç›®å½•ã€‚è€Œä»Android 10å¼€å§‹ï¼Œæˆ‘ä»¬å·²ç»ä¸èƒ½ä»¥ç»å¯¹è·¯å¾„çš„æ–¹å¼è®¿é—®å¤–ç½®å­˜å‚¨ç©ºé—´äº†ï¼Œæ‰€ä»¥æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ä¹Ÿä¼šå—åˆ°å½±å“ã€‚</p><p>é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ã€‚</p><p>ç¬¬ä¸€ç§åŒæ—¶ä¹Ÿæ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯æ›´æ”¹æ–‡ä»¶çš„ä¸‹è½½ç›®å½•ã€‚å°†æ–‡ä»¶ä¸‹è½½åˆ°åº”ç”¨ç¨‹åºçš„å…³è”ç›®å½•ä¸‹ï¼Œè¿™æ ·ä¸ç”¨ä¿®æ”¹ä»»ä½•ä»£ç å°±å¯ä»¥è®©ç¨‹åºåœ¨Android 10ç³»ç»Ÿä¸Šæ­£å¸¸å·¥ä½œã€‚ä½†ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä½ éœ€è¦çŸ¥é“ï¼Œä¸‹è½½çš„æ–‡ä»¶ä¼šè¢«è®¡å…¥åˆ°åº”ç”¨ç¨‹åºçš„å ç”¨ç©ºé—´å½“ä¸­ï¼ŒåŒæ—¶å¦‚æœåº”ç”¨ç¨‹åºè¢«å¸è½½äº†ï¼Œè¯¥æ–‡ä»¶ä¹Ÿä¼šä¸€åŒè¢«åˆ é™¤ã€‚å¦å¤–ï¼Œå­˜æ”¾åœ¨å…³è”ç›®å½•ä¸‹çš„æ–‡ä»¶åªèƒ½è¢«å½“å‰çš„åº”ç”¨ç¨‹åºæ‰€è®¿é—®ï¼Œå…¶ä»–ç¨‹åºæ˜¯æ²¡æœ‰è¯»å–æƒé™çš„ã€‚</p><p>ä»¥ä¸Šå‡ ä¸ªé™åˆ¶æ¡ä»¶å¦‚æœä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œé‚£ä¹ˆå°±åªèƒ½ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œå¯¹Android 10ç³»ç»Ÿè¿›è¡Œä»£ç é€‚é…ï¼Œä»ç„¶å°†æ–‡ä»¶ä¸‹è½½åˆ°Downloadç›®å½•ä¸‹ã€‚</p><p>å…¶å®å°†æ–‡ä»¶ä¸‹è½½åˆ°Downloadç›®å½•ï¼Œå’Œå‘ç›¸å†Œä¸­æ·»åŠ ä¸€å¼ å›¾ç‰‡çš„è¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ï¼ŒAndroid 10åœ¨MediaStoreä¸­æ–°å¢äº†ä¸€ç§Downloadsé›†åˆï¼Œä¸“é—¨ç”¨äºæ‰§è¡Œæ–‡ä»¶ä¸‹è½½æ“ä½œã€‚ä½†ç”±äºæ¯ä¸ªé¡¹ç›®ä¸‹è½½åŠŸèƒ½çš„å®ç°éƒ½å„ä¸ç›¸åŒï¼Œæœ‰äº›é¡¹ç›®çš„ä¸‹è½½å®ç°è¿˜ååˆ†å¤æ‚ï¼Œå› æ­¤æ€ä¹ˆå°†ä»¥ä¸‹çš„ç¤ºä¾‹ä»£ç èåˆåˆ°ä½ çš„é¡¹ç›®å½“ä¸­æ˜¯ä½ è‡ªå·±éœ€è¦æ€è€ƒçš„é—®é¢˜ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">downloadFile</span><span class="hljs-params">(fileUrl: <span class="hljs-type">String</span>, fileName: <span class="hljs-type">String</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.Q) &#123;<br>        Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;You must use device running Android 10 or higher&quot;</span>, Toast.LENGTH_SHORT).show()<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    thread &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">val</span> url = URL(fileUrl)<br><span class="hljs-keyword">val</span> connection = url.openConnection() <span class="hljs-keyword">as</span> HttpURLConnection<br>connection.requestMethod = <span class="hljs-string">&quot;GET&quot;</span><br>connection.connectTimeout = <span class="hljs-number">8000</span><br>connection.readTimeout = <span class="hljs-number">8000</span><br><span class="hljs-keyword">val</span> inputStream = connection.inputStream<br><span class="hljs-keyword">val</span> bis = BufferedInputStream(inputStream)<br><span class="hljs-keyword">val</span> values = ContentValues()<br>values.put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)<br>values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)<br><span class="hljs-keyword">val</span> uri = contentResolver.insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, values)<br><span class="hljs-keyword">if</span> (uri != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">val</span> outputStream = contentResolver.openOutputStream(uri)<br><span class="hljs-keyword">if</span> (outputStream != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">val</span> bos = BufferedOutputStream(outputStream)<br><span class="hljs-keyword">val</span> buffer = ByteArray(<span class="hljs-number">1024</span>)<br><span class="hljs-keyword">var</span> bytes = bis.read(buffer)<br><span class="hljs-keyword">while</span> (bytes &gt;= <span class="hljs-number">0</span>) &#123;<br>bos.write(buffer, <span class="hljs-number">0</span> , bytes)<br>bos.flush()<br>bytes = bis.read(buffer)<br>&#125;<br>bos.close()<br>&#125;<br>&#125;<br>bis.close()<br>&#125; <span class="hljs-keyword">catch</span>(e: Exception) &#123;<br>e.printStackTrace()<br>&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ€»ä½“æ¥è®²è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œä¸»è¦å°±æ˜¯æ·»åŠ äº†ä¸€äº›Httpè¯·æ±‚çš„ä»£ç ï¼Œå¹¶å°†MediaStore.Images.Mediaæ”¹æˆäº†MediaStore.Downloadsï¼Œå…¶ä»–éƒ¨åˆ†å‡ ä¹æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œæˆ‘å°±ä¸å†å¤šåŠ è§£é‡Šäº†ã€‚</p><p>æ³¨æ„ï¼Œä¸Šè¿°ä»£ç åªèƒ½åœ¨Android 10æˆ–æ›´é«˜çš„ç³»ç»Ÿç‰ˆæœ¬ä¸Šè¿è¡Œï¼Œå› ä¸ºMediaStore.Downloadsæ˜¯Android 10ä¸­æ–°å¢çš„APIã€‚è‡³äºAndroid 9åŠä»¥ä¸‹çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œè¯·ä½ ä»ç„¶ä½¿ç”¨ä¹‹å‰çš„ä»£ç æ¥è¿›è¡Œæ–‡ä»¶ä¸‹è½½ã€‚</p><img src="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/20200409205714266.gif" alt="img" style="zoom:80%;"><h2 id="6-ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨"><a href="#6-ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨" class="headerlink" title="6.ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨"></a>6.ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨</h2><p>å¦‚æœæˆ‘ä»¬è¦è¯»å–SDå¡ä¸Šéå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç±»çš„æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´æ‰“å¼€ä¸€ä¸ªPDFæ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸èƒ½å†ä½¿ç”¨MediaStore APIäº†ï¼Œè€Œæ˜¯è¦ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ã€‚</p><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å†åƒä¹‹å‰çš„å†™æ³•é‚£æ ·ï¼Œè‡ªå·±å†™ä¸€ä¸ªæ–‡ä»¶æµè§ˆå™¨ï¼Œç„¶åä»ä¸­é€‰å–æ–‡ä»¶ï¼Œè€Œæ˜¯å¿…é¡»è¦ä½¿ç”¨æ‰‹æœºç³»ç»Ÿä¸­å†…ç½®çš„æ–‡ä»¶é€‰æ‹©å™¨ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> PICK_FILE = <span class="hljs-number">1</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pickFile</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">val</span> intent = Intent(Intent.ACTION_OPEN_DOCUMENT)<br>    intent.addCategory(Intent.CATEGORY_OPENABLE)<br>    intent.type = <span class="hljs-string">&quot;*/*&quot;</span><br>    startActivityForResult(intent, PICK_FILE)<br>&#125;<br><br><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityResult</span><span class="hljs-params">(requestCode: <span class="hljs-type">Int</span>, resultCode: <span class="hljs-type">Int</span>, <span class="hljs-keyword">data</span>: <span class="hljs-type">Intent</span>?)</span></span> &#123;<br>    <span class="hljs-keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="hljs-keyword">data</span>)<br>    <span class="hljs-keyword">when</span> (requestCode) &#123;<br>        PICK_FILE -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (resultCode == Activity.RESULT_OK &amp;&amp; <span class="hljs-keyword">data</span> != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">val</span> uri = <span class="hljs-keyword">data</span>.<span class="hljs-keyword">data</span><br>                <span class="hljs-keyword">if</span> (uri != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">val</span> inputStream = contentResolver.openInputStream(uri)<br><span class="hljs-comment">// æ‰§è¡Œæ–‡ä»¶è¯»å–æ“ä½œ</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨pickFile()æ–¹æ³•å½“ä¸­é€šè¿‡Intentå»å¯åŠ¨ç³»ç»Ÿçš„æ–‡ä»¶é€‰æ‹©å™¨ï¼Œæ³¨æ„Intentçš„actionå’Œcategoryéƒ½æ˜¯å›ºå®šä¸å˜çš„ã€‚è€Œtypeå±æ€§å¯ä»¥ç”¨äºå¯¹æ–‡ä»¶ç±»å‹è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚æŒ‡å®šæˆimage&#x2F;å°±å¯ä»¥åªæ˜¾ç¤ºå›¾ç‰‡ç±»å‹çš„æ–‡ä»¶ï¼Œè¿™é‡Œå†™æˆ&#x2F;*è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰ç±»å‹çš„æ–‡ä»¶ã€‚æ³¨æ„typeå±æ€§å¿…é¡»è¦æŒ‡å®šï¼Œå¦åˆ™ä¼šäº§ç”Ÿå´©æºƒã€‚</p><p>ç„¶ååœ¨onActivityResult()æ–¹æ³•å½“ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ç”¨æˆ·é€‰ä¸­æ–‡ä»¶çš„Uriï¼Œä¹‹åé€šè¿‡ContentResolveræ‰“å¼€æ–‡ä»¶è¾“å…¥æµæ¥è¿›è¡Œè¯»å–å°±å¯ä»¥äº†ã€‚</p><img src="/2023/06/06/%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E5%AD%98%E5%82%A8/20200409205805627.gif" alt="img" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AndroidåŠ å¯†ä¹‹æ–‡ä»¶çº§åŠ å¯†</title>
    <link href="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/"/>
    <url>/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="AndroidåŠ å¯†ä¹‹æ–‡ä»¶çº§åŠ å¯†"><a href="#AndroidåŠ å¯†ä¹‹æ–‡ä»¶çº§åŠ å¯†" class="headerlink" title="AndroidåŠ å¯†ä¹‹æ–‡ä»¶çº§åŠ å¯†"></a>AndroidåŠ å¯†ä¹‹æ–‡ä»¶çº§åŠ å¯†</h1><blockquote><p>å£°æ˜ï¼šæœ¬æ–‡æ•´ç†è‡ª</p><ul><li><a href="https://blog.csdn.net/myfriend0/article/details/77094890/?spm=1001.2014.3001.5506">https://blog.csdn.net/myfriend0/article/details/77094890/?spm=1001.2014.3001.5506</a></li><li><a href="https://blog.csdn.net/cs_tech/article/details/127579028">https://blog.csdn.net/cs_tech/article/details/127579028</a></li></ul><p>ä»…ä½œä¸ºè‡ªå·±å­¦ä¹ å¤‡å¿˜ä½¿ç”¨ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè”ç³»åˆ é™¤ï¼å†æ¬¡æ„Ÿè°¢2ä½å‰è¾ˆç²¾å½©çš„åšå®¢ï¼</p></blockquote><h2 id="1-ä»€ä¹ˆæ˜¯æ–‡ä»¶çº§åŠ å¯†"><a href="#1-ä»€ä¹ˆæ˜¯æ–‡ä»¶çº§åŠ å¯†" class="headerlink" title="1.ä»€ä¹ˆæ˜¯æ–‡ä»¶çº§åŠ å¯†"></a>1.ä»€ä¹ˆæ˜¯æ–‡ä»¶çº§åŠ å¯†</h2><p>Android 7.0 åŠæ›´é«˜ç‰ˆæœ¬æ”¯æŒæ–‡ä»¶çº§åŠ å¯† (FBE)ã€‚é‡‡ç”¨æ–‡ä»¶çº§åŠ å¯†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„å¯†é’¥å¯¹ä¸åŒçš„æ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼Œå¹¶ä¸”å¯ä»¥å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œå•ç‹¬è§£å¯†ã€‚</p><h2 id="2-å…¨ç›˜åŠ å¯†å’Œæ–‡ä»¶çº§åŠ å¯†çš„åŒºåˆ«"><a href="#2-å…¨ç›˜åŠ å¯†å’Œæ–‡ä»¶çº§åŠ å¯†çš„åŒºåˆ«" class="headerlink" title="2.å…¨ç›˜åŠ å¯†å’Œæ–‡ä»¶çº§åŠ å¯†çš„åŒºåˆ«"></a>2.å…¨ç›˜åŠ å¯†å’Œæ–‡ä»¶çº§åŠ å¯†çš„åŒºåˆ«</h2><p>å€ŸåŠ©æ–‡ä»¶çº§åŠ å¯†ï¼ŒAndroid 7.0 ä¸­å¼•å…¥äº†ä¸€é¡¹ç§°ä¸ºç›´æ¥å¯åŠ¨çš„æ–°åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½å¤„äºå¯ç”¨çŠ¶æ€æ—¶ï¼Œå·²åŠ å¯†è®¾å¤‡åœ¨å¯åŠ¨åå°†ç›´æ¥è¿›å…¥é”å®šå±å¹•ã€‚ä¹‹å‰ï¼Œåœ¨ä½¿ç”¨å…¨ç›˜åŠ å¯† (FDE) çš„å·²åŠ å¯†è®¾å¤‡ä¸Šï¼Œç”¨æˆ·åœ¨è®¿é—®ä»»ä½•æ•°æ®ä¹‹å‰éƒ½éœ€è¦å…ˆæä¾›å‡­æ®ï¼Œä»è€Œå¯¼è‡´æ‰‹æœºæ— æ³•æ‰§è¡Œé™¤æœ€åŸºæœ¬æ“ä½œä¹‹å¤–çš„æ‰€æœ‰å…¶ä»–æ“ä½œã€‚ä¾‹å¦‚ï¼Œé—¹é’Ÿæ— æ³•è¿è¡Œï¼Œæ— éšœç¢æœåŠ¡ä¸å¯ç”¨ï¼Œæ‰‹æœºæ— æ³•æ¥ç”µè¯ï¼Œè€Œåªèƒ½è¿›è¡ŒåŸºæœ¬çš„ç´§æ€¥æ‹¨å·æ“ä½œã€‚</p><h2 id="3-æ–‡ä»¶çº§åŠ å¯†æ¦‚è¿°"><a href="#3-æ–‡ä»¶çº§åŠ å¯†æ¦‚è¿°" class="headerlink" title="3.æ–‡ä»¶çº§åŠ å¯†æ¦‚è¿°"></a>3.æ–‡ä»¶çº§åŠ å¯†æ¦‚è¿°</h2><p>å¼•å…¥æ–‡ä»¶çº§åŠ å¯† (FBE) å’Œæ–° API åï¼Œä¾¿å¯ä»¥å°†åº”ç”¨è®¾ä¸ºåŠ å¯†æ„ŸçŸ¥å‹åº”ç”¨ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®ƒä»¬å°†èƒ½å¤Ÿåœ¨å—é™ç¯å¢ƒä¸­è¿è¡Œã€‚è¿™äº›åº”ç”¨å°†å¯ä»¥åœ¨ç”¨æˆ·æä¾›å‡­æ®ä¹‹å‰è¿è¡Œï¼ŒåŒæ—¶ç³»ç»Ÿä»èƒ½ä¿æŠ¤ç§å¯†ç”¨æˆ·ä¿¡æ¯ã€‚</p><p>åœ¨å¯ç”¨äº† FBE çš„è®¾å¤‡ä¸Šï¼Œæ¯ä½ç”¨æˆ·å‡æœ‰ä¸¤ä¸ªå¯ä¾›åº”ç”¨ä½¿ç”¨çš„å­˜å‚¨ä½ç½®ï¼š</p><ul><li>ğŸ¥‡å‡­æ®åŠ å¯† (CE) å­˜å‚¨ç©ºé—´ï¼š<strong>è¿™æ˜¯é»˜è®¤å­˜å‚¨ä½ç½®ï¼Œåªæœ‰åœ¨ç”¨æˆ·è§£é”è®¾å¤‡åæ‰å¯ç”¨ã€‚</strong></li><li>ğŸ¥ˆè®¾å¤‡åŠ å¯† (DE) å­˜å‚¨ç©ºé—´ï¼š<strong>åœ¨ç›´æ¥å¯åŠ¨æ¨¡å¼æœŸé—´ä»¥åŠç”¨æˆ·è§£é”è®¾å¤‡åå‡å¯ç”¨ã€‚</strong></li></ul><p>è¿™ç§åŒºåˆ†èƒ½å¤Ÿä½¿å·¥ä½œèµ„æ–™æ›´åŠ å®‰å…¨ï¼Œå› ä¸ºè¿™æ ·ä¸€æ¥ï¼ŒåŠ å¯†ä¸å†åªåŸºäºå¯åŠ¨æ—¶å¯†ç ï¼Œä»è€Œèƒ½å¤ŸåŒæ—¶ä¿æŠ¤å¤šä½ç”¨æˆ·ã€‚</p><p>Direct Boot API å…è®¸åŠ å¯†æ„ŸçŸ¥å‹åº”ç”¨è®¿é—®ä¸Šè¿°æ¯ä¸ªåŒºåŸŸã€‚åº”ç”¨ç”Ÿå‘½å‘¨æœŸä¼šå‘ç”Ÿä¸€äº›å˜åŒ–ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·çš„ CE å­˜å‚¨ç©ºé—´å› ç”¨æˆ·åœ¨é”å®šå±å¹•ä¸Šé¦–æ¬¡è¾“å…¥å‡­æ®è€Œè§£é”æ—¶ï¼Œæˆ–è€…åœ¨å·¥ä½œèµ„æ–™æä¾›å·¥ä½œæŒ‘æˆ˜æ—¶ï¼Œé€šçŸ¥åº”ç”¨ã€‚æ— è®ºæ˜¯å¦å®ç°äº† FBEï¼Œè¿è¡Œ Android 7.0 çš„è®¾å¤‡éƒ½å¿…é¡»è¦æ”¯æŒè¿™äº›æ–°çš„ API å’Œç”Ÿå‘½å‘¨æœŸã€‚ä¸è¿‡ï¼Œå¦‚æœæ²¡æœ‰ FBEï¼ŒDE å’Œ CE å­˜å‚¨ç©ºé—´å°†å§‹ç»ˆå¤„äºè§£é”çŠ¶æ€ã€‚</p><h3 id="3-1-å¯åŠ¨æ–‡ä»¶çº§åŠ å¯†"><a href="#3-1-å¯åŠ¨æ–‡ä»¶çº§åŠ å¯†" class="headerlink" title="3.1 å¯åŠ¨æ–‡ä»¶çº§åŠ å¯†"></a>3.1 å¯åŠ¨æ–‡ä»¶çº§åŠ å¯†</h3><p>å¦‚éœ€åœ¨è®¾å¤‡ä¸Šå¯ç”¨æ–‡ä»¶çº§åŠ å¯† (FBE)ï¼Œå°±å¿…é¡»åœ¨å†…éƒ¨å­˜å‚¨è®¾å¤‡ (userdata) ä¸Šå¯ç”¨ FBEã€‚è¿™ä¹Ÿä¼šè‡ªåŠ¨ä¸ºå¯åˆå¹¶çš„å­˜å‚¨è®¾å¤‡å¯ç”¨ FBEï¼›ä½†æ˜¯ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥è¦†ç›–å¯åˆå¹¶çš„å­˜å‚¨è®¾å¤‡çš„åŠ å¯†æ ¼å¼ã€‚å†…éƒ¨å­˜å‚¨è®¾å¤‡é€šè¿‡å°† fileencryption&#x3D;contents_encryption_mode[:filenames_encryption_mode[:flags]] é€‰é¡¹<strong>æ·»åŠ åˆ° userdata çš„ fstab è¡Œ fs_mgr_flags åˆ—ï¼Œå¯å¯ç”¨ FBE</strong>ã€‚æ­¤é€‰é¡¹ç”¨äºå®šä¹‰å†…éƒ¨å­˜å‚¨è®¾å¤‡çš„åŠ å¯†æ ¼å¼ã€‚å®ƒæœ€å¤šåŒ…å«ä¸‰ä¸ªä»¥è‹±æ–‡å†’å·åˆ†éš”çš„å‚æ•°ï¼š</p><p>Android10ï¼šext4 fileencryption&#x3D;ice,</p><p>Android11ï¼šf2fs fileencryption&#x3D;aes-256-xts:</p><ul><li>contents_encryption_mode å‚æ•°æŒ‡å®šå°†å“ªç§åŠ å¯†ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶å†…å®¹ï¼Œå¯ä¸º aes-256-xts æˆ– adiantum</li><li>filenames_encryption_mode å‚æ•°æŒ‡å®šå°†å“ªç§åŠ å¯†ç®—æ³•ç”¨äºåŠ å¯†æ–‡ä»¶åï¼Œå¯ä¸º aes-256-ctsã€aes-256-heh æˆ– adiantumã€‚å¦‚æœä¸æŒ‡å®šï¼Œåˆ™å½“ contents_encryption_mode ä¸º aes-256-xts æ—¶è¯¥å‚æ•°é»˜è®¤ä¸º aes-256-ctsï¼Œå½“ contents_encryption_mode ä¸º adiantum æ—¶è¯¥å‚æ•°é»˜è®¤ä¸º adiantumã€‚</li><li>Android 11 ä¸­æ–°å¢çš„ flags å‚æ•°æ˜¯ä»¥ + å­—ç¬¦åˆ†éš”çš„ä¸€ä¸ªæ ‡è®°åˆ—è¡¨ã€‚æ”¯æŒä»¥ä¸‹æ ‡è®°ï¼š<ul><li>v1 æ ‡è®°ç”¨äºé€‰æ‹©ç¬¬ 1 ç‰ˆåŠ å¯†æ”¿ç­–ï¼›v2 æ ‡è®°ç”¨äºé€‰æ‹©ç¬¬ 2 ç‰ˆåŠ å¯†æ”¿ç­–ã€‚ç¬¬ 2 ç‰ˆåŠ å¯†æ”¿ç­–ä½¿ç”¨æ›´å®‰å…¨ã€æ›´çµæ´»çš„å¯†é’¥æ´¾ç”Ÿå‡½æ•°ã€‚å¦‚æœè®¾å¤‡æ­è½½çš„æ˜¯ Android 11 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆç”± ro.product.first_api_level ç¡®å®šï¼‰ï¼Œåˆ™é»˜è®¤é€‰æ‹©ç¬¬ 2 ç‰ˆï¼›å¦‚æœè®¾å¤‡æ­è½½çš„æ˜¯ Android 10 æˆ–æ›´ä½ç‰ˆæœ¬ï¼Œåˆ™é»˜è®¤é€‰æ‹©ç¬¬ 1 </li><li>inlinecrypt_optimized æ ‡è®°ç”¨äºé€‰æ‹©é’ˆå¯¹æ— æ³•é«˜æ•ˆå¤„ç†å¤§é‡å¯†é’¥çš„å†…åµŒåŠ å¯†ç¡¬ä»¶è¿›è¡Œäº†ä¼˜åŒ–çš„åŠ å¯†æ ¼å¼ã€‚å…¶å…·ä½“åšæ³•æ˜¯ä»…ä¸ºæ¯ä¸ª CE æˆ– DE å¯†é’¥æ´¾ç”Ÿä¸€ä¸ªæ–‡ä»¶å†…å®¹åŠ å¯†å¯†é’¥ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ–‡ä»¶æ´¾ç”Ÿä¸€ä¸ªã€‚IVï¼ˆåˆå§‹åŒ–å‘é‡ï¼‰çš„ç”Ÿæˆä¹Ÿä¼šç›¸åº”åœ°è¿›è¡Œè°ƒæ•´ã€‚</li><li>emmc_optimized æ ‡è®°ä¸ inlinecrypt_optimized ç±»ä¼¼ï¼Œä½†å®ƒè¿˜é€‰æ‹©äº†å°† IV é™åˆ¶ä¸º 32 ä½çš„ IV ç”Ÿæˆæ–¹æ³•ã€‚æ­¤æ ‡è®°åº”ä»…åœ¨ç¬¦åˆ JEDEC eMMC v5.2 è§„èŒƒçš„å†…åµŒåŠ å¯†ç¡¬ä»¶ä¸Šä½¿ç”¨ï¼Œå› æ­¤ä»…æ”¯æŒ 32 ä½ IVã€‚åœ¨å…¶ä»–å†…åµŒåŠ å¯†ç¡¬ä»¶ä¸Šï¼Œè¯·æ”¹ç”¨ inlinecrypt_optimizedã€‚æ­¤æ ‡è®°ä¸€å¾‹ä¸å¾—åœ¨åŸºäº UFS çš„å­˜å‚¨è®¾å¤‡ä¸Šä½¿ç”¨ï¼›UFS è§„èŒƒå…è®¸ä½¿ç”¨ 64 ä½ IVã€‚</li><li>wrappedkey_v0 æ ‡è®°å…è®¸ä½¿ç”¨ç¡¬ä»¶å°è£…çš„å¯†é’¥ã€‚å¯ç”¨è¯¥æ ‡è®°åï¼ŒFBE å¯†é’¥å°±ä¸ä¼šç”±è½¯ä»¶ç”Ÿæˆï¼Œè€Œæ˜¯ç”± Keymaster ä½¿ç”¨ STORAGE_KEY æ ‡ç­¾ç”Ÿæˆã€‚ç„¶åï¼Œå®é™…å‘å†…æ ¸æä¾›çš„æ¯ä¸ª FBE å¯†é’¥éƒ½æ˜¯ä» Keymaster å¯¼å‡ºçš„ STORAGE_KEY å¯†é’¥ï¼Œè¿™ä¼šå¯¼è‡´æ¯æ¬¡å¯åŠ¨æ—¶éƒ½ä½¿ç”¨ä¸´æ—¶å¯†é’¥å¯¹å¯†é’¥è¿›è¡Œå°è£…ã€‚ç„¶åï¼Œå†…æ ¸ä¼šå°†å°è£…çš„å¯†é’¥ç›´æ¥æä¾›ç»™å†…åµŒåŠ å¯†ç¡¬ä»¶ã€‚æ­£ç¡®å®ç°åï¼Œç³»ç»Ÿå†…å­˜ä¸­æ°¸è¿œä¸ä¼šæ˜¾ç¤ºè§£å°çš„å¯†é’¥ï¼Œå¹¶ä¸”å·²ç ´è§£çš„å°è£…å¯†é’¥åœ¨é‡æ–°å¯åŠ¨åå°†æ— æ³•ä½¿ç”¨ã€‚æ­¤æ ‡è®°éœ€è¦ç¡¬ä»¶æ”¯æŒã€å¯¹ STORAGE_KEY çš„ Keymaster æ”¯æŒã€å†…æ ¸é©±åŠ¨ç¨‹åºæ”¯æŒã€inlinecrypt è£…è½½é€‰é¡¹ä»¥åŠ inlinecrypt_optimized æ ‡è®°æˆ– emmc_optimized æ ‡è®°ã€‚</li></ul></li></ul><p>å¦‚æœä¸ä½¿ç”¨å†…åµŒåŠ å¯†ç¡¬ä»¶ï¼Œåˆ™å¯¹äºå¤§å¤šæ•°è®¾å¤‡æ¨èè®¾ç½®ä¸º fileencryption&#x3D;aes-256-xtsã€‚å¦‚æœä½¿ç”¨å†…åµŒåŠ å¯†ç¡¬ä»¶ï¼Œåˆ™å¯¹äºå¤§å¤šæ•°è®¾å¤‡æ¨èè®¾ç½®ä¸º fileencryption&#x3D;aes-256-xts:aes-256-cts:inlinecrypt_optimizedã€‚åœ¨æ²¡æœ‰é‡‡ç”¨ä»»ä½•å½¢å¼çš„ AES åŠ é€Ÿçš„è®¾å¤‡ä¸Šï¼Œå¯ä»¥è®¾ç½® fileencryption&#x3D;adiantumï¼Œä»è€Œç”¨ Adiantumä»£æ›¿ AESã€‚</p><p>åœ¨æ­è½½ Android 10 æˆ–æ›´ä½ç‰ˆæœ¬çš„è®¾å¤‡ä¸Šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ fileencryption&#x3D;ice æ¥æŒ‡å®šä½¿ç”¨ FSCRYPT_MODE_PRIVATE æ–‡ä»¶å†…å®¹åŠ å¯†æ¨¡å¼ã€‚Android é€šç”¨å†…æ ¸æœªå®ç°è¯¥æ¨¡å¼ï¼Œä½†ä¾›åº”å•†å¯ä½¿ç”¨è‡ªå®šä¹‰å†…æ ¸è¡¥ä¸ç¨‹åºå®ç°è¯¥æ¨¡å¼ã€‚è¯¥æ¨¡å¼ç”Ÿæˆçš„ç£ç›˜æ ¼å¼å› ä¾›åº”å•†è€Œå¼‚ã€‚åœ¨æ­è½½ Android 11 æˆ–æ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡ä¸Šï¼Œä¸å…è®¸å†ä½¿ç”¨è¯¥æ¨¡å¼ï¼Œè€Œå¿…é¡»ä½¿ç”¨æ ‡å‡†åŠ å¯†æ ¼å¼ã€‚</p><p>è®¾å¤‡åˆ¶é€ å•†è¿˜å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ‰‹åŠ¨æµ‹è¯•ã€‚åœ¨å¯ç”¨äº† FBE çš„è®¾å¤‡ä¸Šè¿›è¡Œä»¥ä¸‹æ‰‹åŠ¨æµ‹è¯•ï¼š</p><ul><li>æ£€æŸ¥ ro.crypto.state æ˜¯å¦å­˜åœ¨<ul><li>ç¡®è®¤ ro.crypto.state æ˜¯å¦å·²åŠ å¯†</li></ul></li><li>æ£€æŸ¥ ro.crypto.type æ˜¯å¦å­˜åœ¨<ul><li>ç¡®è®¤ ro.crypto.type æ˜¯å¦å·²è®¾ç½®ä¸º file</li></ul></li></ul><h3 id="3-2-ç›´æ¥å¯åŠ¨"><a href="#3-2-ç›´æ¥å¯åŠ¨" class="headerlink" title="3.2 ç›´æ¥å¯åŠ¨"></a>3.2 ç›´æ¥å¯åŠ¨</h3><blockquote><p>å®‰å“å®˜ç½‘ï¼š<a href="https://developer.android.google.cn/training/articles/direct-boot?hl=zh-cn">https://developer.android.google.cn/training/articles/direct-boot?hl=zh-cn</a></p></blockquote><p>å½“è®¾å¤‡å·²å¼€æœºä½†ç”¨æˆ·å°šæœªè§£é”è®¾å¤‡æ—¶ï¼ŒAndroid 7.0 å°†åœ¨å®‰å…¨çš„â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œã€‚ä¸ºæ”¯æŒæ­¤æ¨¡å¼ï¼Œç³»ç»Ÿä¸ºæ•°æ®æä¾›äº†ä¸¤ä¸ªå­˜å‚¨ä½ç½®ï¼š</p><ul><li>å‡­æ®åŠ å¯†å­˜å‚¨ï¼Œè¿™æ˜¯é»˜è®¤å­˜å‚¨ä½ç½®ï¼Œä»…åœ¨ç”¨æˆ·è§£é”è®¾å¤‡åå¯ç”¨ã€‚</li><li>è®¾å¤‡åŠ å¯†å­˜å‚¨ï¼Œè¯¥å­˜å‚¨ä½ç½®åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹å’Œç”¨æˆ·è§£é”è®¾å¤‡åå‡å¯ä½¿ç”¨ã€‚</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ä¸ä¼šåœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œã€‚å¦‚æœæ‚¨çš„åº”ç”¨éœ€è¦åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹æ‰§è¡Œæ“ä½œï¼Œæ‚¨å¯ä»¥æ³¨å†Œåº”åœ¨æ­¤æ¨¡å¼ä¸‹è¿è¡Œçš„åº”ç”¨ç»„ä»¶ã€‚éœ€è¦åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œçš„ä¸€äº›å¸¸è§åº”ç”¨ç”¨ä¾‹åŒ…æ‹¬ï¼š</p><ul><li>å·²å®‰æ’é€šçŸ¥çš„åº”ç”¨ï¼Œå¦‚é—¹é’Ÿåº”ç”¨ã€‚</li><li>æä¾›é‡è¦ç”¨æˆ·é€šçŸ¥çš„åº”ç”¨ï¼Œå¦‚çŸ­ä¿¡åº”ç”¨ã€‚</li><li>æä¾›æ— éšœç¢æœåŠ¡çš„åº”ç”¨ï¼Œå¦‚ Talkbackã€‚</li></ul><p>å¦‚æœåº”ç”¨åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œæ—¶éœ€è¦è®¿é—®æ•°æ®ï¼Œè¯·ä½¿ç”¨DEè®¾å¤‡åŠ å¯†å­˜å‚¨ã€‚è®¾å¤‡åŠ å¯†å­˜å‚¨åŒ…å«ä½¿ç”¨å¯†é’¥åŠ å¯†çš„æ•°æ®ï¼Œè¯¥å¯†é’¥åªæœ‰åœ¨è®¾å¤‡æˆåŠŸæ‰§è¡Œå¯åŠ¨æ—¶éªŒè¯åæ‰å¯ç”¨ã€‚</p><p>å¯¹äºåº”ä½¿ç”¨ä¸ç”¨æˆ·å‡­æ®ï¼ˆå¦‚ PIN ç æˆ–å¯†ç ï¼‰å…³è”çš„å¯†é’¥åŠ å¯†çš„æ•°æ®ï¼Œè¯·ä½¿ç”¨CEå‡­æ®åŠ å¯†å­˜å‚¨ã€‚å‡­æ®åŠ å¯†å­˜å‚¨ä»…åœ¨ç”¨æˆ·æˆåŠŸè§£é”è®¾å¤‡åå¯ç”¨ï¼Œç›´åˆ°ç”¨æˆ·å†æ¬¡é‡å¯è®¾å¤‡ã€‚å¦‚æœç”¨æˆ·åœ¨è§£é”è®¾å¤‡åå¯ç”¨é”å®šå±å¹•ï¼Œåˆ™ä¸ä¼šé”å®šå‡­æ®åŠ å¯†å­˜å‚¨ã€‚</p><p><strong>ï¼ˆ1ï¼‰è¯·æ±‚åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œ</strong></p><p>åº”ç”¨å¿…é¡»å…ˆå‘ç³»ç»Ÿæ³¨å†Œå…¶ç»„ä»¶ï¼Œç„¶åæ‰èƒ½åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œæˆ–è®¿é—®è®¾å¤‡åŠ å¯†å­˜å‚¨ã€‚åº”ç”¨é€šè¿‡å°†ç»„ä»¶æ ‡è®°ä¸ºåŠ å¯†æ„ŸçŸ¥æ¥å‘ç³»ç»Ÿæ³¨å†Œã€‚å¦‚éœ€å°†æ‚¨çš„ç»„ä»¶æ ‡è®°ä¸ºåŠ å¯†æ„ŸçŸ¥ï¼Œè¯·åœ¨æ¸…å•ä¸­å°† <code>android:directBootAware</code> å±æ€§è®¾ä¸º trueã€‚</p><p>å½“è®¾å¤‡é‡å¯åï¼ŒåŠ å¯†æ„ŸçŸ¥ç»„ä»¶å¯ä»¥æ³¨å†Œä»¥æ¥æ”¶æ¥è‡ªç³»ç»Ÿçš„ <code>ACTION_LOCKED_BOOT_COMPLETED</code> å¹¿æ’­æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œè®¾å¤‡åŠ å¯†å­˜å‚¨å¯ç”¨ï¼Œæ‚¨çš„ç»„ä»¶å¯ä»¥æ‰§è¡Œéœ€è¦åœ¨â€œç›´æ¥å¯åŠ¨â€æ¨¡å¼ä¸‹è¿è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚è§¦å‘å·²è®¾å®šçš„é—¹é“ƒã€‚</p><p>ä»¥ä¸‹ä»£ç æ®µç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•åœ¨åº”ç”¨æ¸…å•ä¸­å°† <code>BroadcastReceiver</code> æ³¨å†Œä¸ºåŠ å¯†æ„ŸçŸ¥å¹¶ä¸º <code>ACTION_LOCKED_BOOT_COMPLETED</code> æ·»åŠ  intent è¿‡æ»¤å™¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:directBootAware</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span><br>    ...<br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.LOCKED_BOOT_COMPLETED&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span><br>    <br></code></pre></td></tr></table></figure><p>åœ¨ç”¨æˆ·è§£é”è®¾å¤‡åï¼Œæ‰€æœ‰ç»„ä»¶å‡å¯è®¿é—®è®¾å¤‡åŠ å¯†å­˜å‚¨å’Œå‡­æ®åŠ å¯†å­˜å‚¨ã€‚</p><p><strong>ï¼ˆ2ï¼‰æ¥æ”¶ç”¨æˆ·è§£é”é€šçŸ¥</strong></p><p>å½“ç”¨æˆ·åœ¨é‡å¯åè§£é”è®¾å¤‡æ—¶ï¼Œåº”ç”¨å¯ä»¥åˆ‡æ¢è‡³è®¿é—®å‡­æ®åŠ å¯†CEå­˜å‚¨ï¼Œå¹¶ä½¿ç”¨ä¾èµ–ç”¨æˆ·å‡­æ®çš„å¸¸è§„ç³»ç»ŸæœåŠ¡ã€‚</p><p>ä¸ºäº†åœ¨é‡å¯åç”¨æˆ·è§£é”è®¾å¤‡æ—¶æ”¶åˆ°é€šçŸ¥ï¼Œè¯·ä»æ­£åœ¨è¿è¡Œçš„ç»„ä»¶æ³¨å†Œ <code>BroadcastReceiver</code> ä»¥ç›‘å¬è§£é”é€šçŸ¥æ¶ˆæ¯ã€‚åœ¨ç”¨æˆ·é‡å¯åè§£é”è®¾å¤‡æ—¶ï¼š</p><ul><li>å¦‚æœåº”ç”¨å…·æœ‰éœ€è¦ç«‹å³è·å¾—é€šçŸ¥çš„å‰å°è¿›ç¨‹ï¼Œè¯·ç›‘å¬ <code>ACTION_USER_UNLOCKED</code> æ¶ˆæ¯ã€‚</li><li>å¦‚æœåº”ç”¨ä»…ä½¿ç”¨å¯ä»¥å¯¹å»¶è¿Ÿé€šçŸ¥æ‰§è¡Œæ“ä½œçš„åå°è¿›ç¨‹ï¼Œè¯·ç›‘å¬ <code>ACTION_BOOT_COMPLETED</code> æ¶ˆæ¯ã€‚</li></ul><p>æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ <code>UserManager.isUserUnlocked()</code> ç›´æ¥æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²è§£é”è®¾å¤‡ã€‚</p><h3 id="3-3-è®¾è®¡æ¦‚è§ˆ"><a href="#3-3-è®¾è®¡æ¦‚è§ˆ" class="headerlink" title="3.3 è®¾è®¡æ¦‚è§ˆ"></a>3.3 è®¾è®¡æ¦‚è§ˆ</h3><blockquote><p>é‡‡ç”¨æ–‡ä»¶çº§åŠ å¯†æ—¶ï¼š</p><ul><li>å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¯†é’¥å¯¹ä¸åŒçš„æ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼Œä¹Ÿå¯ä»¥å¯¹åŠ å¯†æ–‡ä»¶å•ç‹¬è§£å¯†</li><li>å¯ä»¥æœ‰çš„æ”¾çŸ¢ï¼Œæ²¡æœ‰å®‰å…¨è¦æ±‚çš„æ–‡ä»¶å¯ä»¥ä¸åŠ å¯†</li><li>æ”¯æŒå¤šç”¨æˆ·ï¼Œä¸åŒç”¨æˆ·ä½¿ç”¨ä¸åŒçš„å¯†é’¥</li></ul></blockquote><p>åŸºäºè¿™äº›ç‰¹æ€§ï¼ŒGoogle å¯¹ Android ç”¨æˆ·æ•°æ®åˆ†åŒºçš„ç›®å½•åšäº†å®‰å…¨ç­‰çº§åˆ’åˆ†ï¼Œä¸€äº›éç”¨æˆ·éšç§æ•°æ®å¯ä»¥åœ¨è®¾å¤‡å¯åŠ¨åç›´æ¥å¯ä»¥è®¿é—®ï¼Œè§£å†³äº† FDEï¼ˆFull Disk Encryptionï¼‰çš„å¼Šç«¯ã€‚</p><p>åœ¨ FBE çš„è®¾è®¡ä¸­ï¼Œæ ¹æ®æ–‡ä»¶å†…å®¹çš„ç§å¯†æ€§ï¼ŒGoogle æŠŠç”¨æˆ·æ•°æ®åˆ†åŒºçš„å­˜å‚¨ä½ç½®åˆ’åˆ†å®‰å…¨ç­‰çº§ï¼ŒåŒ…æ‹¬ä¸‹å‡ ç±»ï¼š</p><p>â‘ . ä¸åŠ å¯†çš„å­˜å‚¨ä½ç½®</p><ul><li>Unencrypted</li></ul><p>â‘¡. åŠ å¯†çš„å­˜å‚¨ä½ç½® </p><ul><li>ä¸ç”¨æˆ·æ— å…³çš„ç³»ç»Ÿè®¾å¤‡å­˜å‚¨ä½ç½®<ul><li>System Device Encrypted (DE) Storage ï¼šä¸€èˆ¬å­˜å‚¨ä¸€äº›è®¾å¤‡ç›¸å…³ï¼ŒFramework ç›¸å…³ç­‰ç”¨æˆ·æ— å…³çš„æ•°æ®ã€‚</li></ul></li><li>ä¸ç”¨æˆ·ç›¸å…³çš„å­˜å‚¨ä½ç½® ï¼š<ul><li>Device Encrypted (DE) Storage ï¼šä¸ç”¨æˆ·ç›¸å…³çš„æ•°æ®ï¼Œå®‰å…¨æ€§è¦æ±‚ä¸€èˆ¬ï¼Œåœ¨è®¾å¤‡å¯åŠ¨åä»¥åŠç”¨æˆ·è§£é”è®¾å¤‡åéƒ½å¯ä»¥ç›´æ¥è®¿é—®ã€‚</li><li>Credential Encrypted (CE) Storage ï¼šä¸ç”¨æˆ·ç›¸å…³çš„æ•°æ®ï¼Œå®‰å…¨æ€§ç­‰çº§é«˜ï¼Œå¦‚æœç”¨æˆ·è®¾ç½®äº†é”å±å¯†ç ï¼Œå¿…é¡»åœ¨ç”¨æˆ·è§£é”è®¾å¤‡åè¿™äº›å­˜å‚¨ä½ç½®çš„æ•°æ®æ‰å¯ç”¨ã€‚</li></ul></li></ul><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/image-20230604201431654.png" alt="image-20230604201431654" style="zoom: 67%;"><p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><p>â‘ . ä» User.x DE&#x2F;CE ä»¥åŠå¯¹åº”æ–‡ä»¶å¤¹çš„å‘½åå¯çŸ¥ï¼ŒFBE å¤©ç„¶æ”¯æŒå¤šç”¨æˆ· ï¼š</p><ul><li>æ¯ä¸ªç”¨æˆ·éƒ½æ‹¥æœ‰2ä¸ªå•ç‹¬çš„åŠ å¯†å¯†é’¥ï¼š DE Master Key å’Œ CE Master Keyã€‚</li></ul><p>â‘¡. å½“ç”¨æˆ·æœªè®¾ç½®é”å±å¯†ç æ—¶ï¼š</p><ul><li>DE å¯†é’¥å’Œ CE å¯†é’¥å®‰å…¨ç­‰çº§ä¸€è‡´ï¼Œå³å¼€æœºè¿‡ç¨‹ä¸­ï¼ŒAPP å°±å¯ä»¥ç›´æ¥è®¿é—® Device Encrypted (DE) Storage å’Œ Credential Encrypted (CE) Storageã€‚</li></ul><p>â‘¢. å½“ç”¨æˆ·è®¾ç½®é”å±å¯†ç æ—¶ï¼š</p><ul><li>åªæœ‰æ ¡éªŒç”¨æˆ·å¯†ç æˆåŠŸåï¼Œç”¨æˆ·çš„ CE å¯†é’¥æ‰å¯ç”¨ã€‚å³ç”¨æˆ·è¾“å…¥é”å±å¯†ç è§£é”è®¾å¤‡åï¼ŒAPP æ‰å¯è®¿é—® Credential Encrypted (CE) Storageï¼ŒåŒæ—¶è®¿é—®åˆ°æ–‡ä»¶çš„æ˜æ–‡æ•°æ®ã€‚</li><li>ç”¨æˆ· 0 ç”±äºæ˜¯ç‰¹æ®Šç”¨æˆ·ï¼Œå¿…é¡»å…ˆç™»å½•è®¾å¤‡ï¼ˆè®¾å¤‡å¯åŠ¨åä¼šè‡ªåŠ¨ç™»å½•ç”¨æˆ·0ï¼‰ï¼›<br>ä¸åŒå­˜å‚¨ä½ç½®çš„åŠ è§£å¯†é¡ºåºå­˜åœ¨ä¾èµ–å…³ç³»ï¼š<ul><li>è§£å¯† System DE Storage æ‰€éœ€çš„å¯†é’¥ä¿¡æ¯è¢«å­˜å‚¨åœ¨æœªåŠ å¯†ç›®å½• &#x2F;data&#x2F;unencryptedï¼›</li><li>è§£å¯† User Device Encrypted (DE) Storage å’Œ User Credential Encrypted (CE) Storage æ‰€éœ€çš„å¯†é’¥ä¿¡æ¯è¢«å­˜å‚¨åœ¨ System DE Storage è·¯å¾„ &#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keysï¼›</li></ul></li></ul><p>ğŸˆ è¿™é‡Œå†æ¬¡é‡å¤ç£ç›˜æ•°æ®åŠ å¯†è§£å†³çš„é—®é¢˜ï¼Œå¯¹äºåé¢ç†è§£ FBE çš„è®¾è®¡å¾ˆé‡è¦ã€‚</p><blockquote><p>è§£å†³è®¾å¤‡è¢«ç›—ï¼Œä¸¢å¤±æˆ–è€…é€ä¿®ç­‰æœºå™¨ä¸åœ¨ç”¨æˆ·æ‰‹ä¸­çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶ä¿æŠ¤ç”¨æˆ·çš„éšç§æ•°æ®ä¸è¢«çªƒå–ã€‚<strong>ä½†æ˜¯å¯¹äºç”¨æˆ·æ­£å¸¸ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé»‘å®¢é€šè¿‡ææƒç­‰æ‰‹æ®µçªƒå–æ•°æ®çš„è¡Œä¸ºï¼Œè¿™äº›æŠ€æœ¯åŸºæœ¬æ— èƒ½ä¸ºåŠ›ï¼Œç›®å‰ä¸»è¦è¿˜æ˜¯é ä¼ ç»Ÿçš„ DACï¼ˆuserã€groupã€othersï¼‰ å’Œ MACï¼ˆselinuxï¼‰</strong>ã€‚</p></blockquote><h3 id="3-4-ç§˜é’¥ç®¡ç†"><a href="#3-4-ç§˜é’¥ç®¡ç†" class="headerlink" title="3.4 ç§˜é’¥ç®¡ç†"></a>3.4 ç§˜é’¥ç®¡ç†</h3><p>â‘ .å¯¹ä¸åŒå®‰å…¨ç­‰çº§çš„åŠ å¯†å­˜å‚¨ä½ç½®ï¼Œè‡³å°‘æ¶‰åŠ 3 ä¸ªå¯†é’¥ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>System DE key</li><li>User DE key for user 0</li><li>User CE key for user 0</li></ul><p>â‘¡. å¯†é’¥çš„å®‰å…¨ç®¡ç†ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>åœ¨å®‰å…¨çš„å†…æ ¸å¯†é’¥ç¯ï¼ˆkernel keyringï¼‰å’Œ ARM TZ ç¯å¢ƒä¸­ç®¡ç†å¯†é’¥</li><li>å¯†é’¥ä¸å…è®¸å‡ºç°åœ¨ HLOS</li><li>æ¯ä¸ªæ–‡ä»¶åŠå…¶åç§°éƒ½åº”ä½¿ç”¨ä¸åŒä¸”å”¯ä¸€çš„å¯†é’¥è¿›è¡ŒåŠ å¯†</li><li>æ ¹æ® HLOS è¯·æ±‚ï¼Œåˆ›å»ºï¼Œæ›´æ–°å’Œå¤±æ•ˆå¯†é’¥ç­‰ï¼ˆæ”¯æŒè¿œç¨‹æ“¦é™¤å¯†é’¥ï¼‰</li><li>â€¦â€¦</li></ul><h3 id="3-5-å¯†é’¥å­˜å‚¨åŠå…¶ä¿æŠ¤æªæ–½"><a href="#3-5-å¯†é’¥å­˜å‚¨åŠå…¶ä¿æŠ¤æªæ–½" class="headerlink" title="3.5 å¯†é’¥å­˜å‚¨åŠå…¶ä¿æŠ¤æªæ–½"></a>3.5 å¯†é’¥å­˜å‚¨åŠå…¶ä¿æŠ¤æªæ–½</h3><blockquote><p>2023&#x2F;06&#x2F;19å‘ç°å¥½æ–‡ï¼š<a href="https://blog.csdn.net/csdn_liqian/article/details/129362100">https://blog.csdn.net/csdn_liqian/article/details/129362100</a></p></blockquote><p>ç³»ç»Ÿä¸ä¼šå­˜å‚¨ per-boot key ï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»–æ‰€æœ‰çš„ FBE key å°†è¢«<code>vold</code> ç®¡ç†ï¼Œå¹¶ä¸”å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚FBE keyå­˜å‚¨çš„ä½ç½®å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/image-20230619220158827.png" alt="image-20230619220158827" style="zoom: 80%;"><p>voldå¯¹æ‰€æœ‰çš„FBE keyéƒ½æœ‰ä¸€å±‚åŠ å¯†ã€‚</p><p>é™¤äº†ç”¨äºå†…éƒ¨å­˜å‚¨çš„ CE å¯†é’¥ä¹‹å¤–ï¼Œæ¯ä¸ªå¯†é’¥éƒ½ç”±è‡ªå·±çš„ Keystore keyï¼ˆè¯¥å¯†é’¥ä¸åœ¨ TEE å¤–éƒ¨å…¬å¼€ï¼‰å’Œ AES-256-GCM ç®—æ³•æ¥åŠ å¯†ã€‚è¿™ç¡®ä¿FBE keyæ— æ³•è¢«è§£é”ï¼Œé™¤éå¯ä¿¡æ“ä½œç³»ç»Ÿå·²å¯åŠ¨ï¼ˆå°±åƒå¼€æœºæ ¡éªŒå¼ºåˆ¶æ‰§è¡Œï¼ŒéªŒè¯ä¸‹ä¸€é˜¶æ®µçš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ï¼‰ã€‚</p><p>æ­¤å¤–ï¼ŒKeystore key éœ€è¦è®¾ç½®æŠ—å›æ»šï¼Œä»¥ä¾¿ Keymaster åœ¨æ”¯æŒæŠ—å›æ»šçš„è®¾å¤‡ä¸Šä¹Ÿèƒ½å®‰å…¨åœ°åˆ é™¤ FBE å¯†é’¥ã€‚æŠ—å›æ»šï¼šä¸€æ—¦ä½¿ç”¨ deleteKey æˆ–è€… deleteAllKeys æ¥åˆ é™¤å¯†é’¥ï¼Œå®‰å…¨ç¡¬ä»¶å°†ä¿è¯è¯¥å¯†é’¥ä¸å†å¯ç”¨ï¼Œå³åˆ é™¤çš„å¯†é’¥æ— æ³•æ¢å¤ã€‚</p><p>ä¸ºäº†åœ¨æŠ—å›æ»šä¸å¯ç”¨æ—¶èƒ½å¤Ÿå°½å¯èƒ½åœ°å›é€€ï¼Œ16384 ä¸ªéšæœºå­—èŠ‚çš„ SHA-512 å“ˆå¸Œå€¼å­˜å‚¨åœ¨ä¸å¯†é’¥ä¸€èµ·å­˜å‚¨çš„ secdiscardable æ–‡ä»¶ä¸­ï¼Œä½œä¸º Keystore keyä¸­çš„app ID tagã€‚åªæœ‰å°†è¿™äº›å­—èŠ‚å…¨éƒ¨æ¢å¤ï¼Œæ‰èƒ½æ¢å¤ FBE keyã€‚</p><p>ç”¨äºå†…éƒ¨å­˜å‚¨çš„ CE key å°†è·å¾—æ›´é«˜çº§åˆ«çš„ä¿æŠ¤ï¼Œä»¥ç¡®ä¿åœ¨æœªè·å–ç”¨æˆ·çš„LSKF (LSKFï¼šLock Screen Knowledge Factorï¼Œå³PIN ç  personal identificationã€å›¾æ¡ˆpattern æˆ– å£ä»¤passwordï¼‰ã€å®‰å…¨å¯†ç é‡ç½®ä»¤ç‰Œï¼ˆsecure passcode reset tokenï¼‰æˆ–åœ¨é‡å¯æ¢å¤æ“ä½œåçš„å®¢æˆ·ç«¯å¯†é’¥åŠæœåŠ¡å™¨ç«¯å¯†é’¥çš„æƒ…å†µä¸‹ï¼ŒCE key æ— æ³•è¢«è§£é”ã€‚åªå…è®¸ä¸ºå·¥ä½œèµ„æ–™å’Œå®Œå…¨å—ç®¡è®¾å¤‡ï¼ˆfor work profiles and fully managed devicesï¼‰åˆ›å»ºå¯†ç é‡ç½®ä»¤ç‰Œã€‚</p><p>ä¸ºæ­¤ï¼Œvold ç”¨AES-256-GCMç®—æ³•åŠ å¯†ç”¨äºå†…éƒ¨å­˜å‚¨çš„CE keyï¼Œå…¶åŠ å¯†å¯†é’¥æºè‡ªç”¨æˆ·åˆæˆçš„å£ä»¤ã€‚è¯¥åˆæˆå£ä»¤æ˜¯ä¸ºæ¯ä¸ªç”¨æˆ·éšæœºç”Ÿæˆçš„ä¸å¯å˜çš„é«˜çº§æ— åºçš„ï¼ˆhigh-entropyï¼Œé«˜ç†µï¼‰åŠ å¯†çš„å¯†ç ã€‚system_server ä¸­çš„ LockSettingsService ç”¨äºç®¡ç†åˆæˆå£ä»¤åŠå…¶ä¿æŠ¤æ–¹å¼ã€‚</p><p>ç”¨ LSKF ä¿æŠ¤åˆæˆå£ä»¤æ—¶ï¼ŒLockSettingsService é¦–å…ˆä¼šæ‰©å±• LSKFï¼ˆå¯ä»¥é€šè¿‡ scrypt ä¼ é€’ LSKFï¼Œç›®æ ‡æ—¶é—´çº¦ä¸º 25 æ¯«ç§’ä¸”å†…å­˜ç”¨é‡çº¦ä¸º 2 MiBï¼‰ã€‚</p><p>ç”±äº LSKF é€šå¸¸è¾ƒçŸ­ï¼Œå› æ­¤è¯¥æ­¥éª¤é€šå¸¸æ— æ³•æä¾›å¤ªå¤šå®‰å…¨æ€§ã€‚ä¸»è¦çš„å®‰å…¨ä¿éšœæ˜¯SE (SEï¼š Secure Elementå®‰å…¨å…ƒç´ ) æˆ–è€…ç”± TEE å¼ºåˆ¶æ‰§è¡Œçš„é€Ÿç‡é™åˆ¶ã€‚</p><p><strong>ï¼ˆ1ï¼‰å¦‚æœè®¾å¤‡æœ‰SEï¼Œ LockSettingsService ä½¿ç”¨ Weaver HAL å°†ç»è¿‡æ‰©å±•çš„ LSKF æ˜ å°„åˆ°å­˜å‚¨åœ¨ SE ä¸­çš„é«˜çº§æ— åºéšæœºå¯†ç ï¼ˆsecretï¼‰ã€‚</strong><br>ç„¶åï¼ŒLockSettingsService å°†å¯¹åˆæˆå£ä»¤è¿›è¡ŒåŒé‡åŠ å¯†ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡åŠ å¯†ï¼šä½¿ç”¨æ‰©å±•çš„ LSKF å’Œ Weaver secretæ´¾ç”Ÿè½¯ä»¶å¯†é’¥ï¼›</li><li>ç¬¬äºŒæ¬¡åŠ å¯†ï¼šä½¿ç”¨æœªç»èº«ä»½éªŒè¯ç»‘å®š(non-auth-bound)çš„ Keystore keyã€‚</li></ul><p>è¿™æ ·å³å¯å¯¹ LSKF çŒœæµ‹è¡Œä¸ºæ–½åŠ  SE å¼ºåˆ¶é€Ÿç‡é™åˆ¶ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Weaver HALä»£ç è·¯å¾„: platform/hardware/interfaces/refs/heads/master/./weaver/<span class="hljs-number">1.0</span>/IWeaver.hal<br></code></pre></td></tr></table></figure><p><strong>ï¼ˆ2ï¼‰å¦‚æœè®¾å¤‡æ²¡æœ‰ SEï¼Œåˆ™ LockSettingsService ä½¿ç”¨æ‰©å±•çš„ LSKF ä½œä¸º Gatekeeper å£ä»¤ã€‚</strong></p><p>ç„¶åï¼ŒLockSettingsService å°†å¯¹åˆæˆå£ä»¤è¿›è¡ŒåŒé‡åŠ å¯†ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡åŠ å¯†ï¼šä½¿ç”¨æ‰©å±•çš„ LSKF å’Œ secdiscardable æ–‡ä»¶çš„å“ˆå¸Œå€¼æ´¾ç”Ÿè½¯ä»¶å¯†é’¥ï¼›</li><li>ç¬¬äºŒæ¬¡åŠ å¯†ï¼šä½¿ç”¨ç»è¿‡èº«ä»½éªŒè¯ç»‘å®š(auth-bound)åˆ°Gatekeeperçš„ Keystore keyã€‚</li></ul><p>è¿™æ ·å³å¯å¯¹ LSKF çŒœæµ‹è¡Œä¸ºæ–½åŠ  SE å¼ºåˆ¶é€Ÿç‡é™åˆ¶ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Gatekeeperï¼š<br><span class="hljs-built_in">TEE</span>(Trusted Execution Environmentï¼Œå¯ä¿¡æ‰§è¡Œç¯å¢ƒ)ä¸­ï¼Œä½¿ç”¨ç¡¬ä»¶æ”¯æŒçš„Keystore keyé€šè¿‡HMACæ³¨å†Œå¹¶éªŒè¯è®¾å¤‡çš„å›¾æ¡ˆæˆ–è€…å£ä»¤ï¼ˆç”¨TEEæ´¾ç”Ÿçš„å…±äº«å¯†é’¥æ¥è¿›è¡Œèº«ä»½éªŒè¯ï¼‰ã€‚<br>åœ¨è¿ç»­æ•°æ¬¡éªŒè¯å¤±è´¥æ—¶ä¼šé™åˆ¶éªŒè¯å°è¯•ï¼Œæ‹’ç»ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚<br></code></pre></td></tr></table></figure><p>å½“LSKFæ”¹å˜æ—¶ï¼Œ<code>LockSettingsService</code> ä¼šåˆ é™¤æ‰€æœ‰æ—§çš„LSKFä»¥åŠåˆæˆå£ä»¤ç»‘å®šçš„ç›¸å…³ä¿¡æ¯ã€‚åœ¨æ”¯æŒ Weaver æˆ–è€…æŠ—å›æ»šçš„ Keystore key çš„è®¾å¤‡ä¸Šï¼Œè¿™æ ·åšå¯ä»¥ä¿è¯å®‰å…¨åœ°åˆ é™¤æ—§ç»‘å®šã€‚å› æ­¤ï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰è®¾ç½® LSKFï¼Œç³»ç»Ÿä¹Ÿä¼šè¿›è¡Œä¸Šè¿°ä¿æŠ¤æªæ–½ã€‚</p><h2 id="4-HLOSè½¯ä»¶æµç¨‹"><a href="#4-HLOSè½¯ä»¶æµç¨‹" class="headerlink" title="4.HLOSè½¯ä»¶æµç¨‹"></a>4.HLOSè½¯ä»¶æµç¨‹</h2><h3 id="4-1-Nativeè½¯ä»¶æµç¨‹"><a href="#4-1-Nativeè½¯ä»¶æµç¨‹" class="headerlink" title="4.1 Nativeè½¯ä»¶æµç¨‹"></a>4.1 Nativeè½¯ä»¶æµç¨‹</h3><p>Android åœ¨ init rc ä¸­ è§¦å‘ FBE è½¯ä»¶æµç¨‹ï¼š</p><blockquote><ul><li>åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå‡†å¤‡ FBE Master keyï¼Œè®¾ç½®å’Œæ ¡éªŒå„åŠ å¯†å­˜å‚¨ä½ç½®çš„åŠ å¯†ç­–ç•¥ï¼ˆEncryption Policyï¼‰ã€‚</li><li>çœŸæ­£æ•°æ®åŠ å¯†å’Œè§£å¯†æ˜¯å‘ç”Ÿåœ¨æ–‡ä»¶ I&#x2F;O æ—¶ï¼Œè€ŒåŠ å¯†å’Œè§£å¯†æ‰€éœ€çš„ä¿¡æ¯æ¥æºäºæ–‡ä»¶çš„ Encryption Policyã€‚Encryption Policy åŒ…æ‹¬ï¼š<ul><li>ä½¿ç”¨å“ªä¸ª Master Key åŠ å¯†ï¼›</li><li>æ–‡ä»¶æ•°æ®çš„åŠ å¯†ç®—æ³•ï¼›</li><li>æ–‡ä»¶åçš„åŠ å¯†ç®—æ³•ï¼›</li></ul></li></ul></blockquote><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/e09ee7d3490e49b1bd615011c7ecfc77.png" alt="img" style="zoom:80%;"><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/450367269c4d4d3781406d3411f3e6e4.png" alt="img" style="zoom: 50%;"><p><strong>â‘  installkey &#x2F;data</strong></p><p>è½¯ä»¶æµç¨‹è¿›å…¥ Vold å‡½æ•° fscrypt_initialize_systemwide_keys()ã€‚</p><p>è®¾å¤‡ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼š</p><ul><li>åˆ›å»º System DE Master Key å’Œç”Ÿæˆ System DE Encryption Policyï¼›</li><li>æŠŠ System DE Encryption Policy ä¿å­˜åˆ°æ–‡ä»¶  &#x2F;data&#x2F;unencrypted&#x2F;refï¼›</li></ul><p>åç»­æ¯æ¬¡å¯åŠ¨æ—¶ï¼š</p><ul><li>åŠ è½½ System DE Master Keyï¼›</li></ul><p><strong>â‘¡ mkdir &lt;system de storage&gt;</strong></p><ul><li>å¦‚æœ System DE Storage ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶ä¸ºæ–‡ä»¶å¤¹è®¾ç½® System DE Encryption Policyï¼›</li><li>å¦‚æœ System DE Storage å·²ç»å­˜åœ¨ï¼Œåˆ™æ ¡éªŒ System DE  Encryption Policyï¼›<br>æ ¡éªŒå¤±è´¥ä¼šå¼ºåˆ¶è®¾å¤‡å¯åŠ¨åˆ° recovery ï¼Œæ ¼å¼åŒ– userdata åˆ†åŒºï¼›</li></ul><p><strong>â‘¢ init_user0</strong></p><p>è½¯ä»¶æµç¨‹è¿›å…¥ Vold å‡½æ•° fscrypt_init_user0()ã€‚</p><p>è®¾å¤‡ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼š</p><ul><li>åˆ›å»º User 0 DE Master Key å’Œç”Ÿæˆ User 0 DE Encryption Policyï¼›</li><li>åˆ›å»º User 0 CE  Master Key å’Œç”Ÿæˆ User 0 CE Encryption Policyï¼›</li><li>åˆ›å»º User 0 DE Storageï¼Œå¹¶ä¸ºè¿™äº›æ–‡ä»¶å¤¹è®¾ç½® User 0 DE Encryption Policy</li></ul><p>åç»­æ¯æ¬¡å¯åŠ¨æ—¶ï¼š</p><ul><li>åŠ è½½ User 0 DE Master Keyï¼›</li><li>å‡†å¤‡ User 0 DE Storageï¼Œå¹¶æ ¡éªŒæ–‡ä»¶å¤¹ Encryption Policyï¼›<ul><li>æ ¡éªŒå¤±è´¥ï¼Œä¸ä¼šå¼ºåˆ¶æ ¼å¼åŒ– userdata ï¼Œä½†æ˜¯ç”¨æˆ·æ•°æ®å°†æ— æ³•ä½¿ç”¨ï¼Œå¯èƒ½æ— æ³•å¼€æœºã€‚</li></ul></li></ul><h3 id="4-2-Frameworkè½¯ä»¶æµç¨‹"><a href="#4-2-Frameworkè½¯ä»¶æµç¨‹" class="headerlink" title="4.2 Frameworkè½¯ä»¶æµç¨‹"></a>4.2 Frameworkè½¯ä»¶æµç¨‹</h3><p>å¯ä»¥å‘ç°åœ¨ Native è½¯ä»¶æµç¨‹ä¸­ï¼Œ init_user0 ä¸­å…³äº User 0 CE çš„æµç¨‹ç›¸æ¯” User 0 DE å­˜åœ¨ç¼ºå¤±ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><p><strong>(1) ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œ User 0 CE Storage æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿ</strong></p><p>è®¾å¤‡ç»§ç»­å¯åŠ¨ï¼Œç”±æ¡†æ¶ UserController é€šè¿‡ binder è§¦å‘ Vold åˆ›å»º User 0 CE Storage å’Œä¸ºç›¸å…³æ–‡ä»¶å¤¹è®¾ç½® User 0 CE Encryption Policy</p><p><strong>(2) åç»­æ¯æ¬¡å¯åŠ¨æ—¶ï¼ŒåŠ è½½ User 0 DE Master Keyã€å‡†å¤‡ User 0 DE Storage ã€æ ¡éªŒ User 0 CE Encryption Policy æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ</strong></p><p>â‘  ç”¨æˆ·æœªè®¾ç½®é”å±å¯†ç æ—¶ï¼Œè®¾å¤‡å¯åŠ¨ completed åï¼ŒActivityManagerService å±‚å±‚è§¦å‘ Vold å®Œæˆè¿™äº›ä»»åŠ¡ï¼›</p><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/7227b1872aed453187f68be2bbd5c74e.png" alt="img" style="zoom:50%;"><p> <strong>â‘¡</strong> ç”¨æˆ·è®¾ç½®é”å±å¯†ç æ—¶ï¼Œç”¨æˆ·è¾“å…¥å¯†ç å¹¶æ ¡éªŒé€šè¿‡åï¼ŒLockSettingsService å±‚å±‚è§¦å‘ Vold å®Œæˆè¿™äº›ä»»åŠ¡ï¼›</p><img src="/2023/06/04/Android%E5%8A%A0%E5%AF%86%E4%B9%8B%E6%96%87%E4%BB%B6%E7%BA%A7%E5%8A%A0%E5%AF%86/7575d136392e43b2be21ae3b9494fb43.png" alt="img" style="zoom: 50%;"><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯è®¾ç½®ç”¨æˆ·å¯†ç ï¼Œè½¯ä»¶æµç¨‹åˆå›åˆ°äº† Voldï¼š</p><ul><li>fscrypt_unlock_user_key ï¼š åŠ è½½ User 0 CE Master Key</li><li>fscrypt_prepare_user_storageï¼šå‡†å¤‡ User 0 CE Storageï¼Œå¹¶æ ¡éªŒæ–‡ä»¶å¤¹ Encryption Policyï¼›</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“12å¤šç”¨æˆ·æœºåˆ¶</title>
    <link href="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“12å¤šç”¨æˆ·æœºåˆ¶"><a href="#å®‰å“12å¤šç”¨æˆ·æœºåˆ¶" class="headerlink" title="å®‰å“12å¤šç”¨æˆ·æœºåˆ¶"></a>å®‰å“12å¤šç”¨æˆ·æœºåˆ¶</h1><h2 id="1-CPPä¸­çš„åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡"><a href="#1-CPPä¸­çš„åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡" class="headerlink" title="1.CPPä¸­çš„åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡"></a>1.CPPä¸­çš„åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡</h2><p>â˜ƒï¸ åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡æ—¶ï¼šè°ƒç”¨çš„æ˜¯åŸºç±»çš„å‡½æ•°ï¼Œå› ä¸ºå­ç±»çš„å‡½æ•°è¢«éšè—ã€‚ ä½†æ˜¯å½“åŸºç±»å‡½æ•°æœ‰virtualå…³é”®å­—ä¿®é¥°çš„æ—¶å€™è°ƒç”¨çš„æ˜¯å­ç±»çš„å‡½æ•°ã€è¯¦ç»†çš„å¯ä»¥äº†è§£ä¸€ä¸‹<a href="https://zhuanlan.zhihu.com/p/98776075">è™šå‡½æ•°è¡¨</a>ã€‘</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base</span>(<span class="hljs-type">int</span> age) &#123;<br>        mAge = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printName</span><span class="hljs-params">(string name)</span> </span>&#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;Base -&gt; name = &quot;</span> &lt;&lt; name &lt;&lt; endl;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">mount</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-built_in">doMount</span>();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> mAge;<br><br>&#125;;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> : <span class="hljs-keyword">public</span> Base<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Child</span>():<span class="hljs-built_in">Base</span>(<span class="hljs-number">24</span>)&#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;child do Mount&quot;</span> &lt;&lt; endl;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">auto</span> child = <span class="hljs-built_in">shared_ptr</span>&lt;Base&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Child</span>());<br><br>    child-&gt;<span class="hljs-built_in">printName</span>(<span class="hljs-string">&quot;amxixixi&quot;</span>);<br>    child-&gt;<span class="hljs-built_in">mount</span>();<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230607223135870.png" alt="image-20230607223135870" style="zoom:80%;"><h2 id="2-åˆ›å»ºç”¨æˆ·"><a href="#2-åˆ›å»ºç”¨æˆ·" class="headerlink" title="2.åˆ›å»ºç”¨æˆ·"></a>2.åˆ›å»ºç”¨æˆ·</h2><p>å¤šç”¨æˆ·çš„åˆ›å»ºæµç¨‹ä¸»è¦åœ¨UserManagerService.createUserInternalUnchecked()æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> UserInfo <span class="hljs-title function_">createUserInternalUnchecked</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String name,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@NonNull</span> String userType, <span class="hljs-meta">@UserInfoFlag</span> <span class="hljs-type">int</span> flags, <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> parentId,</span><br><span class="hljs-params">                                             <span class="hljs-type">boolean</span> preCreate, <span class="hljs-meta">@Nullable</span> String[] disallowedPackages,</span><br><span class="hljs-params">                                             <span class="hljs-meta">@Nullable</span> Object token)</span> <span class="hljs-keyword">throws</span> UserManager.CheckedUserOperationException &#123;<br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç”¨æˆ·IDï¼Œä»10å¼€å§‹</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">nextProbableUserId</span> <span class="hljs-operator">=</span> getNextAvailableId();<br>    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">newUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        newUser = createUserInternalUncheckedNoTracing(name, userType, flags, parentId,<br>                                                       preCreate, disallowedPackages, t, token);<br>        <span class="hljs-keyword">return</span> newUser;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨createUserInternalUncheckedNoTracing</p><blockquote><p>ğŸƒ<strong>è¿™é‡Œæˆ‘ä»¬ä¸è®¨è®ºå¸¦æœ‰parentIdç±»å‹çš„ç”¨æˆ·åˆ›å»ºï¼Œç¦»æˆ‘æœ¬äººçš„ä¸šåŠ¡æ¯”è¾ƒåç¦»</strong></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// parentId: UserHandle.USER_NULL = -1000</span><br><span class="hljs-comment">// preCreate: false</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> UserInfo <span class="hljs-title">createUserInternalUncheckedNoTracing</span><span class="hljs-params">(@Nullable String name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                      @NonNull String userType, @UserInfoFlag <span class="hljs-type">int</span> flags, @UserIdInt <span class="hljs-type">int</span> parentId,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                      boolean preCreate, @Nullable String[] disallowedPackages,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                      @NonNull TimingsTraceAndSlog t, @Nullable Object token)</span></span><br><span class="hljs-function">    throws UserManager.CheckedUserOperationException </span>&#123;<br>    <br>    flags |= userTypeDetails.<span class="hljs-built_in">getDefaultUserInfoFlags</span>();<br><br>    <span class="hljs-built_in">synchronized</span> (mUsersLock) &#123;<br>        <span class="hljs-keyword">if</span> (mForceEphemeralUsers) &#123;<br>            flags |= UserInfo.FLAG_EPHEMERAL;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Try to use a pre-created user (if available).</span><br>    <span class="hljs-keyword">if</span> (!preCreate &amp;&amp; parentId &lt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">isUserTypeEligibleForPreCreation</span>(userTypeDetails)) &#123;<br>        <span class="hljs-keyword">final</span> UserInfo preCreatedUser = <span class="hljs-built_in">convertPreCreatedUserIfPossible</span>(userType, flags, name,token);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> boolean isProfile = userTypeDetails.<span class="hljs-built_in">isProfile</span>();   <span class="hljs-comment">// åˆ›å»ºçš„ç”¨æˆ·æ˜¯ä¸æ˜¯Profile</span><br>    <span class="hljs-keyword">final</span> boolean isGuest = UserManager.<span class="hljs-built_in">isUserTypeGuest</span>(userType);    <span class="hljs-comment">// åˆ›å»ºçš„æ˜¯ä¸æ˜¯è®¿å®¢ç”¨æˆ·</span><br>    <span class="hljs-keyword">final</span> boolean isRestricted = UserManager.<span class="hljs-built_in">isUserTypeRestricted</span>(userType);  <span class="hljs-comment">// åˆ›å»ºçš„ç”¨æˆ·ç±»å‹æ˜¯ä¸æ˜¯è¢«é™åˆ¶</span><br>    <span class="hljs-keyword">final</span> boolean isDemo = UserManager.<span class="hljs-built_in">isUserTypeDemo</span>(userType);  <span class="hljs-comment">// åˆ›å»ºçš„ç”¨æˆ·æ˜¯ä¸æ˜¯ä¸€ä¸ªDemo</span><br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> ident = Binder.<span class="hljs-built_in">clearCallingIdentity</span>();<br>    UserInfo userInfo;<br>    UserData userData;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> userId;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">synchronized</span> (mPackagesLock) &#123;<br>            UserData parent = null;<br><br>            userId = <span class="hljs-built_in">getNextAvailableId</span>();  <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªå³å°†ä½¿ç”¨çš„UserId</span><br>            Environment.<span class="hljs-built_in">getUserSystemDirectory</span>(userId).<span class="hljs-built_in">mkdirs</span>();  <span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶å¤¹: /data/system/users/&lt;user_id&gt;</span><br><br>            <span class="hljs-built_in">synchronized</span> (mUsersLock) &#123;<br>                <span class="hljs-comment">// å®ä¾‹åŒ–UserInfoå¹¶è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼</span><br>                userInfo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">UserInfo</span>(userId, name, null, flags, userType);<br>                userInfo.serialNumber = mNextSerialNumber++; <span class="hljs-comment">// ä¸²è¡Œå·ï¼Œæ ¹æ®ç»éªŒæ¥çœ‹ç­‰äºUserId</span><br>                userInfo.creationTime = <span class="hljs-built_in">getCreationTime</span>();<br>                userInfo.partial = <span class="hljs-literal">true</span>;<br>                userInfo.preCreated = preCreate;<br>                userInfo.lastLoggedInFingerprint = Build.FINGERPRINT;<br>                userData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">UserData</span>();<br>                userData.info = userInfo;<br>                <span class="hljs-comment">// mUsersæ˜¯SparseArrayç±»å‹</span><br>                mUsers.<span class="hljs-built_in">put</span>(userId, userData);<br>            &#125;<br>            <span class="hljs-comment">// è¯¦è§2.2èŠ‚</span><br>            <span class="hljs-built_in">writeUserLP</span>(userData);  <span class="hljs-comment">// æ„é€ åŒ…å«æ–°ç”¨æˆ·ä¿¡æ¯çš„UserDataï¼Œå¹¶å›ºåŒ–åˆ°/data/system/users/&lt;user_id&gt;.xml</span><br>            <span class="hljs-built_in">writeUserListLP</span>();      <span class="hljs-comment">// å°†æ–°åˆ›å»ºæ–°UserIdå›ºåŒ–åˆ° data/system/users/userlist.xml</span><br>        &#125;<br><br><br>        <span class="hljs-keyword">final</span> StorageManager storage = mContext.<span class="hljs-built_in">getSystemService</span>(StorageManager.<span class="hljs-keyword">class</span>);<br>        storage.<span class="hljs-built_in">createUserKey</span>(userId, userInfo.serialNumber, userInfo.<span class="hljs-built_in">isEphemeral</span>());<br><br>        mUserDataPreparer.<span class="hljs-built_in">prepareUserData</span>(userId, userInfo.serialNumber,<br>                                          StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);<br><br>        <span class="hljs-comment">// 2.3èŠ‚ è·å–å½“å‰ç”¨æˆ·ç±»å‹éœ€è¦å®‰è£…çš„åº”ç”¨æœ‰å“ªäº›</span><br>        <span class="hljs-keyword">final</span> Set&lt;String&gt; userTypeInstallablePackages =<br>            mSystemPackageInstaller.<span class="hljs-built_in">getInstallablePackagesForUserType</span>(userType);<br><br>        <span class="hljs-comment">// 2.3èŠ‚PMSå®‰è£…æ–°ç”¨æˆ·åº”ç”¨</span><br>        mPm.<span class="hljs-built_in">createNewUser</span>(userId, userTypeInstallablePackages, disallowedPackages);<br><br>        userInfo.partial = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">synchronized</span> (mPackagesLock) &#123;<br>            <span class="hljs-built_in">writeUserLP</span>(userData);  <span class="hljs-comment">// å†æ¬¡è°ƒç”¨2.2èŠ‚ä¸­çš„æ–¹æ³•</span><br>        &#125;<br>        <span class="hljs-built_in">updateUserIds</span>();<br><br>        Bundle restrictions = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bundle</span>();<br>        <span class="hljs-keyword">if</span> (isGuest) &#123;<br><span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// æ·»åŠ é»˜è®¤çš„ç”¨æˆ·é™åˆ¶</span><br>            userTypeDetails.<span class="hljs-built_in">addDefaultRestrictionsTo</span>(restrictions);<br>        &#125;<br>        <span class="hljs-built_in">synchronized</span> (mRestrictionsLock) &#123;<br>            <span class="hljs-comment">// æ›´æ–°RestrictionsSet.javaä¸­ç»´æŠ¤çš„mUserRestrictionsçš„æ•°æ®ç»“æ„</span><br>            mBaseUserRestrictions.<span class="hljs-built_in">updateRestrictions</span>(userId, restrictions);<br>        &#125;<br><br>        mPm.<span class="hljs-built_in">onNewUserCreated</span>(userId, <span class="hljs-comment">/* convertedFromPreCreated= */</span> <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// è®¾ç½®ç”¨æˆ·é»˜è®¤çš„ç³»ç»Ÿé…ç½®å’Œå®‰å…¨é…ç½®</span><br>        <span class="hljs-built_in">applyDefaultUserSettings</span>(userTypeDetails, userId);<br>        <span class="hljs-built_in">setDefaultCrossProfileIntentFilters</span>(userId, userTypeDetails, restrictions, parentId);<br><br>        <span class="hljs-keyword">if</span> (preCreate) &#123;<br><span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">dispatchUserAdded</span>(userInfo, token);<br>        &#125;<br><br>    &#125; finally &#123;<br>        Binder.<span class="hljs-built_in">restoreCallingIdentity</span>(ident);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> userInfo;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯"><a href="#2-1-åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="2.1 åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯"></a>2.1 åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å®ä¾‹åŒ–UserInfoå¹¶è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼</span><br>userInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>(userId, name, <span class="hljs-literal">null</span>, flags, userType);<br>userInfo.serialNumber = mNextSerialNumber++; <span class="hljs-comment">// ä¸²è¡Œå·ï¼Œæ ¹æ®ç»éªŒæ¥çœ‹ç­‰äºUserId</span><br>userInfo.creationTime = getCreationTime();<br>userInfo.partial = <span class="hljs-literal">true</span>;<br>userInfo.preCreated = preCreate;<br>userInfo.lastLoggedInFingerprint = Build.FINGERPRINT;<br>userData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserData</span>();<br>userData.info = userInfo;<br><span class="hljs-comment">// mUsersæ˜¯SparseArrayç±»å‹</span><br>mUsers.put(userId, userData);<br></code></pre></td></tr></table></figure><p>â­ <strong>SparseArray</strong>å¹¶ä¸åƒHashMapé‡‡ç”¨ä¸€ç»´æ•°ç»„+å•é“¾è¡¨ç»“æ„ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸¤ä¸ªä¸€ç»´æ•°ç»„ï¼Œä¸€ä¸ªæ˜¯å­˜å‚¨key(intç±»å‹),ä¸€ä¸ªæ˜¯å­˜åœ¨valueã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mKeys;<br><span class="hljs-keyword">private</span> Object[] mValues;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè®°ä½ï¼ŒUserManagerServiceç»´æŠ¤äº†ä¸€ä¸ªKeyï¼ŒValueçš„æ•°æ®ç»“æ„ï¼ŒKeyä¸ºUserIdï¼ŒValueä¸ºUserDataç”¨æˆ·æ•°æ®ã€‚</p><p>â­ æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨<strong>dumpsys user</strong>æ‰“å°çš„å°±æ˜¯UserInfoç±»çš„ToStringæ–¹æ³•</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230608232128458.png" alt="image-20230608232128458" style="zoom:67%;"><h3 id="2-2-ä¿å­˜æ–°åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯"><a href="#2-2-ä¿å­˜æ–°åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="2.2 ä¿å­˜æ–°åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯"></a>2.2 ä¿å­˜æ–°åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">writeUserLP(userData);  <span class="hljs-comment">// æ„é€ åŒ…å«æ–°ç”¨æˆ·ä¿¡æ¯çš„UserDataï¼Œå¹¶å›ºåŒ–åˆ°/data/system/users/&lt;user_id&gt;.xml</span><br>writeUserListLP();      <span class="hljs-comment">// å°†æ–°åˆ›å»ºæ–°UserIdå›ºåŒ–åˆ° data/system/users/userlist.xml</span><br><br><span class="hljs-comment">// --------------------------------------------------</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeUserLP</span><span class="hljs-params">(UserData userData)</span> &#123;<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// åŸå­åˆ›å»ºæ–‡ä»¶ /data/system/users/&lt;user_id&gt;.xml</span><br>    <span class="hljs-type">AtomicFile</span> <span class="hljs-variable">userFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicFile</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(mUsersDir, userData.info.id + XML_SUFFIX));<br>    <span class="hljs-keyword">try</span> &#123;<br>        fos = userFile.startWrite();<br>        <span class="hljs-comment">// å°†UserDataä¸­çš„æ¶ˆæ¯å†™åˆ°/data/system/users/&lt;user_id&gt;.xml</span><br>        writeUserLP(userData, fos);<br>        userFile.finishWrite(fos);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception ioe) &#123;<br>        Slog.e(LOG_TAG, <span class="hljs-string">&quot;Error writing user info &quot;</span> + userData.info.id, ioe);<br>        userFile.failWrite(fos);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// --------------------------------------------------</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeUserListLP</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// åŸå­åˆ›å»ºæ–‡ä»¶data/system/users/userlist.xml</span><br>    <span class="hljs-type">AtomicFile</span> <span class="hljs-variable">userListFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicFile</span>(mUserListFile);<br>    <span class="hljs-comment">// å†™ä¿¡æ¯...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>â­ <strong>åŸå­ç±»æ–‡ä»¶æµæ“ä½œ</strong>ï¼š<a href="https://blog.csdn.net/FightFightFight/article/details/80069886">https://blog.csdn.net/FightFightFight/article/details/80069886</a></p><blockquote><p>AtomicFileæ˜¯Android API17ä¸­å¼•å…¥çš„å¯¹æ–‡ä»¶è¿›è¡ŒåŸå­æ“ä½œçš„å¸®åŠ©ç±»ï¼Œæ‰€è°“åŸå­æ€§ï¼Œæ˜¯æŒ‡åœ¨å¯¹æ•´ä¸ªæ–‡ä»¶æ“ä½œæ—¶ï¼Œè¦ä¹ˆä¸æ“ä½œï¼Œè¦ä¹ˆæ“ä½œæˆåŠŸã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œä¸ä¼šå½±å“æ–‡ä»¶å†…å®¹ã€‚</p><p>åœ¨è·å–è¯¥å®ä¾‹æ—¶ï¼Œä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸¤ä¸ªFileå¯¹è±¡ï¼Œä¸€ä¸ªä»£è¡¨åŸæ–‡ä»¶ï¼Œä¸€ä¸ªä»£è¡¨å¤‡ä»½æ–‡ä»¶ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªæ–‡ä»¶ä¿è¯åŸæ–‡ä»¶çš„åŸå­æ€§ï¼</p></blockquote><ul><li>æ„é€ åŒ…å«æ–°ç”¨æˆ·ä¿¡æ¯çš„UserDataï¼Œå¹¶å›ºåŒ–åˆ° <code>/data/system/users/&lt;user_id&gt;.xml</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">root@virgo:/ # cat data/system/users/10.xml<br><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">serialNumber</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">flags</span>=<span class="hljs-string">&quot;17&quot;</span> <span class="hljs-attr">created</span>=<span class="hljs-string">&quot;1561361447098&quot;</span> <span class="hljs-attr">lastLoggedIn</span>=<span class="hljs-string">&quot;1561460313625&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>security space<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">restrictions</span> <span class="hljs-attr">no_install_unknown_sources</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">no_usb_file_transfer</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">no_debugging_features</span>=<span class="hljs-string">&quot;false&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>å°†æ–°åˆ›å»ºæ–°UserIdå›ºåŒ–åˆ° <code>data/system/users/userlist.xml</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml">root@virgo:/ # cat data/system/users/userlist.xml<br><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">users</span> <span class="hljs-attr">nextSerialNumber</span>=<span class="hljs-string">&quot;12&quot;</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;5&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">guestRestrictions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">restrictions</span> <span class="hljs-attr">no_config_wifi</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">no_outgoing_calls</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">no_sms</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">guestRestrictions</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;0&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;10&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;11&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">users</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-PMSå®‰è£…æ–°ç”¨æˆ·åº”ç”¨"><a href="#2-3-PMSå®‰è£…æ–°ç”¨æˆ·åº”ç”¨" class="headerlink" title="2.3 PMSå®‰è£…æ–°ç”¨æˆ·åº”ç”¨"></a>2.3 PMSå®‰è£…æ–°ç”¨æˆ·åº”ç”¨</h3><p><strong>ï¼ˆ1ï¼‰å…ˆè·å–è¦å®‰è£…çš„åŒ…è¦æœ‰å“ªäº›</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span> Set&lt;String&gt; <span class="hljs-title function_">getInstallablePackagesForUserType</span><span class="hljs-params">(String userType)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">mode</span> <span class="hljs-operator">=</span> getWhitelistMode();  <span class="hljs-comment">// mode = 13ï¼Œå¯ä»¥é€šè¿‡dumpsys useræŸ¥çœ‹UserSystemPackageInstallerä¸­çš„dumpå‡½æ•°æ‰“å°</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">implicitlyWhitelist</span> <span class="hljs-operator">=</span> isImplicitWhitelistMode(mode)<br>        || (isImplicitWhitelistSystemMode(mode) &amp;&amp; mUm.isUserTypeSubtypeOfSystem(userType));<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; whitelistedPackages = getWhitelistedPackagesForUserType(userType); <span class="hljs-comment">// è·å–ç™½åå•å®‰è£…åŒ…</span><br><br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; installPackages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">PackageManagerInternal</span> <span class="hljs-variable">pmInt</span> <span class="hljs-operator">=</span> LocalServices.getService(PackageManagerInternal.class);<br>    pmInt.forEachPackage(pkg -&gt; &#123;<br>        <span class="hljs-keyword">if</span> (!pkg.isSystem()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (shouldInstallPackage(pkg, mWhitelistedPackagesForUserTypes,<br>                                 whitelistedPackages, implicitlyWhitelist)) &#123;<br>            <span class="hljs-comment">// Although the allowlist uses manifest names, this function returns packageNames.</span><br>            installPackages.add(pkg.getPackageName());<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> installPackages;<br>&#125;<br><span class="hljs-comment">// -------------------------------------------------------------</span><br><span class="hljs-meta">@NonNull</span> Set&lt;String&gt; <span class="hljs-title function_">getWhitelistedPackagesForUserType</span><span class="hljs-params">(String userType)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">userTypeMask</span> <span class="hljs-operator">=</span> getUserTypeMask(userType);  <span class="hljs-comment">//å¥½è·å–å½“å‰ç”¨æˆ·ç±»å‹çš„æ©ç </span><br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; installablePkgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;(mWhitelistedPackagesForUserTypes.size());<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mWhitelistedPackagesForUserTypes.size(); i++) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">pkgName</span> <span class="hljs-operator">=</span> mWhitelistedPackagesForUserTypes.keyAt(i);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">whitelistedUserTypes</span> <span class="hljs-operator">=</span> mWhitelistedPackagesForUserTypes.valueAt(i);<br>        <span class="hljs-comment">// å‡è®¾å½“å‰ç”¨æˆ·ç±»å‹ä¸ºGUESTï¼Œé‚£ä¹ˆå…¶æ©ç ä¸º 1 &lt;&lt; 1</span><br>        <span class="hljs-comment">// åˆcom.android.internal.display.cutout.emulation.cornerä½å›¾çš„ç¬¬2ä½ä¸º1ï¼Œç›¸&amp;ä¹‹åä¸ä¸º0ã€å…·ä½“è§ä¸‹å›¾ã€‘</span><br>        <span class="hljs-comment">// åˆ™è¿™ä¸ªåŒ…åº”è¯¥å®‰è£…</span><br>        <span class="hljs-keyword">if</span> ((userTypeMask &amp; whitelistedUserTypes) != <span class="hljs-number">0</span>) &#123;<br>            installablePkgs.add(pkgName);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> installablePkgs;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>â­ ä¸‹é¢è¯´æ˜ä¸€ä¸‹<strong>mWhitelistedPackagesForUserTypes</strong>è¿™ä¸ªå˜é‡çš„å­˜å‚¨æ–¹å¼ï¼Œä»–æ˜¯ä¸€ä¸ªArrayMapï¼Œé”®ä¸ºåŒ…åï¼Œå€¼ä¸ºå¯ä»¥å®‰è£…è¯¥åº”ç”¨å¯¹åº”çš„ä½å›¾</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230609203512256.png" alt="image-20230609203512256" style="zoom:67%;"><blockquote><p>ä¸‹å›¾ä¸º<strong>dumpsys user</strong>çš„æ‰“å°ç»“æœ</p></blockquote><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230609202459128.png" alt="image-20230609202459128" style="zoom:67%;"><p><strong>ï¼ˆ2ï¼‰å®‰è£…åº”ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">createNewUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-meta">@Nullable</span> Set&lt;String&gt; userTypeInstallablePackages,</span><br><span class="hljs-params">                   String[] disallowedPackages)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (mInstallLock) &#123;<br>        <span class="hljs-comment">// åœ¨mSettintgsä¸­è°ƒç”¨PMSå®‰è£…åº”ç”¨</span><br>        mSettings.createNewUserLI(<span class="hljs-built_in">this</span>, mInstaller, userId, userTypeInstallablePackages, disallowedPackages);<br>    &#125;<br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        scheduleWritePackageRestrictionsLocked(userId);<br>        scheduleWritePackageListLocked(userId);<br>        mAppsFilter.onUsersChanged();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-4-æ·»åŠ å¯¹ç”¨æˆ·çš„é™åˆ¶"><a href="#2-4-æ·»åŠ å¯¹ç”¨æˆ·çš„é™åˆ¶" class="headerlink" title="2.4 æ·»åŠ å¯¹ç”¨æˆ·çš„é™åˆ¶"></a>2.4 æ·»åŠ å¯¹ç”¨æˆ·çš„é™åˆ¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">userTypeDetails.addDefaultRestrictionsTo(restrictions);<br><br><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\pm\UserTypeDetails.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addDefaultRestrictionsTo</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Bundle currentRestrictions)</span> &#123;<br>    UserRestrictionsUtils.merge(currentRestrictions, mDefaultRestrictions);<br>&#125;<br></code></pre></td></tr></table></figure><p>â­ ä¸åŒçš„ç”¨æˆ·ç±»å‹åœ¨åˆå§‹åŒ–<strong>UserTypeDetails</strong>çš„æ—¶å€™éƒ½ä¼šå»è®¾ç½®é™åˆ¶ï¼Œä¾‹å¦‚<strong>SecondaryUser</strong>ç±»å‹çš„ç”¨æˆ·ä¼šæ·»åŠ 2é¡¹é™åˆ¶ï¼š<code>no_outgoing_calls</code>å’Œ<code>no_sms</code></p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230609210435607.png" alt="image-20230609210435607" style="zoom:67%;"><p>æˆ‘ä»¬å¯ä»¥å†æ¬¡é€šè¿‡<code>dumpsys user</code>æŸ¥çœ‹ä¸€ä¸‹ï¼š</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230609211103672.png" alt="image-20230609211103672" style="zoom:67%;"><p>å¦ˆå¦ˆè€¶ï¼Œå¯¹ä¸Šäº†å¯¹ä¸Šäº†ï¼ï¼</p><h2 id="3-åˆ‡æ¢ç”¨æˆ·"><a href="#3-åˆ‡æ¢ç”¨æˆ·" class="headerlink" title="3.åˆ‡æ¢ç”¨æˆ·"></a>3.åˆ‡æ¢ç”¨æˆ·</h2><p>å…ˆä¸Šå®é™…æ“ä½œçš„GIFï¼Œç”¨çœ¼ç›çœ‹å¾€å¾€æ›´åŠ ç›´è§‚~</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/åˆ‡æ¢ç”¨æˆ·.gif" style="zoom:50%;"><h3 id="3-1-å¼€å§‹åˆ‡æ¢ç”¨æˆ·"><a href="#3-1-å¼€å§‹åˆ‡æ¢ç”¨æˆ·" class="headerlink" title="3.1 å¼€å§‹åˆ‡æ¢ç”¨æˆ·"></a>3.1 å¼€å§‹åˆ‡æ¢ç”¨æˆ·</h3><p>Androidå¤šç”¨æˆ·çš„åˆ‡æ¢å‡½æ•°å…¥å£ActivityManagerService.switchUseræ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">switchUser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> targetUserId)</span> &#123;<br>    <span class="hljs-keyword">return</span> mUserController.switchUser(targetUserId);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨UserControllerçš„switchUseræ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\am\UserController.java</span><br><span class="hljs-function">boolean <span class="hljs-title">switchUser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> targetUserId)</span> </span>&#123;<br>    <span class="hljs-type">int</span> currentUserId = <span class="hljs-built_in">getCurrentUserId</span>();  <span class="hljs-comment">// è·å–å½“å‰ç”¨æˆ·çš„userId</span><br>    UserInfo targetUserInfo = <span class="hljs-built_in">getUserInfo</span>(targetUserId);  <span class="hljs-comment">// è·å–å³å°†åˆ‡æ¢ç”¨æˆ·çš„ä¿¡æ¯</span><br><br>    <span class="hljs-comment">// ...</span><br>    <br>    boolean userSwitchUiEnabled;<br>    <span class="hljs-built_in">synchronized</span> (mLock) &#123;<br>        mTargetUserId = targetUserId;<br>        userSwitchUiEnabled = mUserSwitchUiEnabled;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (userSwitchUiEnabled) &#123;<br>        UserInfo currentUserInfo = <span class="hljs-built_in">getUserInfo</span>(currentUserId);<br>        Pair&lt;UserInfo, UserInfo&gt; userNames = <span class="hljs-keyword">new</span> Pair&lt;&gt;(currentUserInfo, targetUserInfo);<br>        mUiHandler.<span class="hljs-built_in">removeMessages</span>(START_USER_SWITCH_UI_MSG);<br>        mUiHandler.<span class="hljs-built_in">sendMessage</span>(mUiHandler.<span class="hljs-built_in">obtainMessage</span>(START_USER_SWITCH_UI_MSG, userNames));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mHandler.<span class="hljs-built_in">removeMessages</span>(START_USER_SWITCH_FG_MSG);<br>        mHandler.<span class="hljs-built_in">sendMessage</span>(mHandler.<span class="hljs-built_in">obtainMessage</span>(START_USER_SWITCH_FG_MSG, targetUserId, <span class="hljs-number">0</span>));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šä¼ é€’ä¸€ä¸ªHandleræ¶ˆæ¯<strong>START_USER_SWITCH_UI_MSG</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> START_USER_SWITCH_UI_MSG:<br><span class="hljs-comment">// æ‹¿åˆ°Handlerçš„å‚æ•°</span><br>    <span class="hljs-keyword">final</span> Pair&lt;UserInfo, UserInfo&gt; fromToUserPair = (Pair&lt;UserInfo, UserInfo&gt;) msg.obj;<br>    showUserSwitchDialog(fromToUserPair);<br>    <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨åˆ‡æ¢ç”¨æˆ·çš„å¯¹è¯æ¡†ã€åœ¨åˆ‡æ¢ç”¨æˆ·çš„æ—¶å€™ï¼Œä¸»ç•Œé¢ä¼šæœ‰ä¸€ä¸ªUIæ˜¾ç¤ºã€‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showUserSwitchDialog</span><span class="hljs-params">(Pair&lt;UserInfo, UserInfo&gt; fromToUserPair)</span> &#123;<br>    mInjector.showUserSwitchingDialog(fromToUserPair.first, fromToUserPair.second,<br>                                      getSwitchingFromSystemUserMessage(), getSwitchingToSystemUserMessage());<br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">showUserSwitchingDialog</span><span class="hljs-params">(UserInfo fromUser, UserInfo toUser,</span><br><span class="hljs-params">                             String switchingFromSystemUserMessage, String switchingToSystemUserMessage)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Dialog</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSwitchingDialog</span>(mService, mService.mContext, fromUser,<br>                                             toUser, <span class="hljs-literal">true</span> <span class="hljs-comment">/* above system */</span>, switchingFromSystemUserMessage,<br>                                             switchingToSystemUserMessage);<br>    d.show();<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ä¸€ä¸ªç»§æ‰¿è‡ªDialogçš„è‡ªå®šä¹‰å¯¹è¯æ¡†ç±»UserSwitchingDialogï¼Œç„¶åè°ƒç”¨å…¶showæ–¹æ³•åœ¨ä¸»ç•Œé¢è¿›è¡Œæ˜¾ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>.show();<br>    mHandler.sendMessageDelayed(mHandler.obtainMessage(MSG_START_USER), WINDOW_SHOWN_TIMEOUT_MS);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆä¼ é€’äº†ä¸€ä¸ªHandlerä¿¡æ¯<strong>MSG_START_USER</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> MSG_START_USER:<br>    startUser();<br>    <span class="hljs-keyword">break</span>;<br><br><span class="hljs-comment">// è°ƒç”¨UserSwitchingDialogçš„startUser</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">startUser</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!mStartedUser) &#123;<br>            mService.mUserController.startUserInForeground(mUserId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Slog.i(TAG, <span class="hljs-string">&quot;user &quot;</span> + mUserId + <span class="hljs-string">&quot; already started&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆé‡æ–°è°ƒç”¨åˆ°äº†UserControllerçš„startUserInForegroundæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">startUserInForeground</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> targetUserId)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> startUser(targetUserId, <span class="hljs-comment">/* foreground */</span> <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">startUser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> foreground)</span> &#123;<br>    <span class="hljs-keyword">return</span> startUser(userId, foreground, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">startUser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> foreground, <span class="hljs-meta">@Nullable</span> IProgressListener unlockListener)</span> &#123;<br>    <span class="hljs-keyword">return</span> startUserNoChecks(userId, foreground, unlockListener);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startUserNoChecks</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId, <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> foreground,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@Nullable</span> IProgressListener unlockListener)</span> &#123;<br>    <span class="hljs-keyword">return</span> startUserInternal(userId, foreground, unlockListener, t);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨åˆ°äº†startUserInternal</p><h3 id="3-2-å¯åŠ¨ç”¨æˆ·startUserInternal"><a href="#3-2-å¯åŠ¨ç”¨æˆ·startUserInternal" class="headerlink" title="3.2 å¯åŠ¨ç”¨æˆ·startUserInternal"></a>3.2 å¯åŠ¨ç”¨æˆ·startUserInternal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»ä¸Šé¢ä¸€è·¯ä¼ ä¸‹æ¥çš„foregroundä¸ºtrue</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startUserInternal</span><span class="hljs-params">(<span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId, <span class="hljs-type">boolean</span> foreground,</span><br><span class="hljs-params">                                  <span class="hljs-meta">@Nullable</span> IProgressListener unlockListener, <span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ident</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldUserId</span> <span class="hljs-operator">=</span> getCurrentUserId();  <span class="hljs-comment">// è·å–å½“å‰ç”¨æˆ·çš„userId</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> getUserInfo(userId); <span class="hljs-comment">// è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯</span><br><br>        <span class="hljs-comment">// 1. å†»ç»“è¾“å…¥äº‹ä»¶</span><br>        <span class="hljs-comment">// 2. å¼ºåˆ¶ç»“æŸæ‰€æœ‰åŠ¨ç”»</span><br>        <span class="hljs-comment">// 3. æˆªå–å½“å‰å±å¹•å¹¶å±•ç¤º</span><br>        <span class="hljs-keyword">if</span> (foreground &amp;&amp; isUserSwitchUiEnabled()) &#123;<br>            mInjector.getWindowManager().startFreezingScreen(R.anim.screen_user_exit, R.anim.screen_user_enter);<br>        &#125;<br>        <br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">needStart</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">updateUmState</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        UserState uss;<br><br>        <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>            uss = mStartedUsers.get(userId);<br>            <span class="hljs-keyword">if</span> (uss == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// åˆå§‹çŠ¶æ€ä¸ºSTATE_BOOTING</span><br>                uss = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserState</span>(UserHandle.of(userId));<br>                uss.mUnlockProgress.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProgressListener</span>());<br>                <span class="hljs-comment">// mStartedUsersç»´æŠ¤äº†ç”¨æˆ·idå’Œç”¨æˆ·çŠ¶æ€</span><br>                mStartedUsers.put(userId, uss);<br>                updateStartedUserArrayLU();<br>                needStart = <span class="hljs-literal">true</span>;<br>                updateUmState = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uss.state == UserState.STATE_SHUTDOWN &amp;&amp; !isCallingOnHandlerThread()) &#123;<br>               <span class="hljs-comment">// ...</span><br>            &#125;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">userIdInt</span> <span class="hljs-operator">=</span> userId;<br>            mUserLru.remove(userIdInt);<br>            mUserLru.add(userIdInt);<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (foreground) &#123;<br>            mInjector.reportGlobalUsageEvent(UsageEvents.Event.SCREEN_NON_INTERACTIVE);<br>            <span class="hljs-type">boolean</span> userSwitchUiEnabled;<br>            <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>                mCurrentUserId = userId;<br>                mTargetUserId = UserHandle.USER_NULL;<br>                userSwitchUiEnabled = mUserSwitchUiEnabled;<br>            &#125;<br>            <span class="hljs-comment">// ä»Setting Providerè¯»å–éœ€è¦åˆ‡æ¢ç”¨æˆ·çš„å­—ä½“ã€è¯­è¨€ã€åœ°åŒºç­‰é…ç½®å¹¶æ›´æ–°</span><br>            <span class="hljs-comment">// å¦‚æœæ˜¯åˆåˆ›ç”¨æˆ·ï¼Œå¯¹äºå­—ä½“åˆ™ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œè¯­è¨€å’Œåœ°åŒºä½¿ç”¨å½“å‰ç”¨æˆ·çš„é…ç½®</span><br>            mInjector.updateUserConfiguration();<br>            <span class="hljs-comment">// æ›´æ–°å½“å‰ç”¨æˆ·é™„å±çš„ManageProfile</span><br>            updateCurrentProfileIds();<br>            <span class="hljs-comment">// è®¾ç½®å½“å‰ç”¨æˆ·ä¸‹æ‰€æœ‰windowçš„å¯è§æ€§</span><br>            <span class="hljs-comment">// è®¾ç½®åˆ‡æ¢ç”¨æˆ·çš„å±å¹•åˆ†è¾¨ç‡</span><br>            mInjector.getWindowManager().setCurrentUser(userId, getCurrentProfileIds());<br>            mInjector.reportCurWakefulnessUsageEvent();<br>            <span class="hljs-keyword">if</span> (userSwitchUiEnabled) &#123;<br>                <span class="hljs-comment">// åˆ‡æ¢è¿‡ç¨‹ä¸­å…³é—­Keyguardçš„æŒ‡çº¹ç›‘å¬</span><br>                mInjector.getWindowManager().setSwitchingUser(<span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// è®¾ç½®Keyguardé”å±(é”å±keyguardå±äºSystemUI)</span><br>                mInjector.getWindowManager().lockNow(<span class="hljs-literal">null</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (uss.state == UserState.STATE_BOOTING) &#123;<br>            <span class="hljs-comment">// è®¾ç½®æ–°ç”¨æˆ·çš„æƒé™ï¼Œæ ¡éªŒæˆ–å‡†å¤‡æ–°ç”¨æˆ·appå­˜å‚¨</span><br>            mInjector.getUserManager().onBeforeStartUser(userId);<br>            <span class="hljs-comment">// é€šçŸ¥ç³»ç»Ÿæ‰€æœ‰çš„æœåŠ¡æ–°ç”¨æˆ·å·²ç»å¯åŠ¨</span><br>            mHandler.sendMessage(mHandler.obtainMessage(USER_START_MSG, userId, <span class="hljs-number">0</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (foreground) &#123;<br>            <span class="hljs-comment">// 3.2.1 é€šçŸ¥å„æœåŠ¡åˆ‡æ¢ç”¨æˆ·</span><br>            mHandler.sendMessage(mHandler.obtainMessage(USER_CURRENT_MSG, userId, oldUserId));<br>        &#125;<br><br><br>        <span class="hljs-comment">// è¯¦è§3.2.2</span><br>        <span class="hljs-keyword">if</span> (foreground) &#123;<br>            moveUserToForeground(uss, oldUserId, userId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            finishUserBoot(uss);<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        Binder.restoreCallingIdentity(ident);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="3-2-1-é€šçŸ¥å„æœåŠ¡åˆ‡æ¢ç”¨æˆ·"><a href="#3-2-1-é€šçŸ¥å„æœåŠ¡åˆ‡æ¢ç”¨æˆ·" class="headerlink" title="3.2.1 é€šçŸ¥å„æœåŠ¡åˆ‡æ¢ç”¨æˆ·"></a>3.2.1 é€šçŸ¥å„æœåŠ¡åˆ‡æ¢ç”¨æˆ·</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">mHandler.sendMessage(mHandler.obtainMessage(USER_CURRENT_MSG, userId, oldUserId));<br><br><br>å¤„ç†Handleræ¶ˆæ¯:<br><span class="hljs-keyword">case</span> USER_CURRENT_MSG:<br>    mInjector.getSystemServiceManager().onUserSwitching(msg.arg2, msg.arg1);<br>    <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨SystemServiceManagerçš„onUserSwitchingæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\SystemServiceManager.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserSwitching</span><span class="hljs-params">(<span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> from, <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> to)</span> &#123;<br>    <span class="hljs-keyword">final</span> TargetUser curUser, prevUser;<br>    <span class="hljs-keyword">synchronized</span> (mTargetUsers) &#123;<br>        <span class="hljs-keyword">if</span> (mCurrentUser == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            prevUser = mCurrentUser;<br>        &#125;<br>        curUser = mCurrentUser = getTargetUser(to);<br>    &#125;<br>    onUser(TimingsTraceAndSlog.newAsyncLog(), USER_SWITCHING, prevUser, curUser);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨onUseræ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUser</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String onWhat, <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId)</span> &#123;<br>    onUser(TimingsTraceAndSlog.newAsyncLog(), onWhat, <span class="hljs-comment">/* prevUser= */</span> <span class="hljs-literal">null</span>, getTargetUser(userId));<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUser</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t, <span class="hljs-meta">@NonNull</span> String onWhat,</span><br><span class="hljs-params">                    <span class="hljs-meta">@Nullable</span> TargetUser prevUser, <span class="hljs-meta">@NonNull</span> TargetUser curUser)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">curUserId</span> <span class="hljs-operator">=</span> curUser.getUserIdentifier();<br><span class="hljs-comment">// SMSç®¡ç†çš„æ‰€æœ‰æœåŠ¡å­˜å‚¨åœ¨mServicesä¸­</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">serviceLen</span> <span class="hljs-operator">=</span> mServices.size();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; serviceLen; i++) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">SystemService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> mServices.get(i);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> service.getClass().getName();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">switch</span> (onWhat) &#123;<br>                <span class="hljs-keyword">case</span> USER_SWITCHING:<br>                    service.onUserSwitching(prevUser, curUser);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br><span class="hljs-comment">// ...</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>SystemServiceManager</strong>ä¼šé€šçŸ¥å…¶ç®¡ç†çš„æ‰€æœ‰æœåŠ¡è°ƒç”¨å…¶<strong>onUserSwitching</strong>æ–¹æ³•ï¼Œå¦‚StorageManagerServiceçš„onUserSwitchingæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks\base\services\core\java\com\android\server\StorageManagerService.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserSwitching</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TargetUser from, <span class="hljs-meta">@NonNull</span> TargetUser to)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">currentUserId</span> <span class="hljs-operator">=</span> to.getUserIdentifier();<br>    mStorageManagerService.mCurrentUserId = currentUserId;<br><br>    <span class="hljs-type">UserManagerInternal</span> <span class="hljs-variable">umInternal</span> <span class="hljs-operator">=</span> LocalServices.getService(UserManagerInternal.class);<br>    <span class="hljs-keyword">if</span> (umInternal.isUserUnlocked(currentUserId)) &#123;<br>        mStorageManagerService.maybeRemountVolumes(currentUserId);<br>        mStorageManagerService.mRemountCurrentUserVolumesOnUnlock = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mStorageManagerService.mRemountCurrentUserVolumesOnUnlock = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»è§£é”ï¼Œé‚£ä¹ˆç›´æ¥é‡æ–°æŒ‚è½½æ‰€æœ‰çš„å·ã€‚</p><h4 id="3-2-2-æœ€åéƒ½ä¼šèµ°åˆ°finishUserBoot"><a href="#3-2-2-æœ€åéƒ½ä¼šèµ°åˆ°finishUserBoot" class="headerlink" title="3.2.2 æœ€åéƒ½ä¼šèµ°åˆ°finishUserBoot"></a>3.2.2 æœ€åéƒ½ä¼šèµ°åˆ°finishUserBoot</h4><p>ä¸åŒçš„æ˜¯æˆ‘ä»¬åˆ›å»ºå®Œï¼Œåˆ‡æ¢ç”¨æˆ·çš„æ—¶å€™æ˜¯foregoundï¼Œå› æ­¤è°ƒç”¨çš„æ˜¯moveUserToForeground</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveUserToForeground</span><span class="hljs-params">(UserState uss, <span class="hljs-type">int</span> oldUserId, <span class="hljs-type">int</span> newUserId)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">homeInFront</span> <span class="hljs-operator">=</span> mInjector.taskSupervisorSwitchUser(newUserId, uss);<br>    <span class="hljs-keyword">if</span> (homeInFront) &#123;<br>        <span class="hljs-comment">// å¦‚æœä¹‹å‰æ²¡æœ‰å‰å°åº”ç”¨ï¼Œåˆ™å¯åŠ¨HomeActivity</span><br>        mInjector.startHomeActivity(newUserId, <span class="hljs-string">&quot;moveUserToForeground&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœä¹‹å‰æœ‰å‰å°åº”ç”¨ï¼Œåˆ™resumeè¯¥Activity</span><br>        mInjector.taskSupervisorResumeFocusedStackTopActivity();<br>    &#125;<br>    <span class="hljs-comment">// // å¯¹äºåˆ‡æ¢å‰çš„ç”¨æˆ·ï¼Œå‘é€ACTION_USER_BACKGROUNDå¹¿æ’­ï¼Œå¯¹äºåˆ‡æ¢åçš„ç”¨æˆ·ï¼Œå‘é€ ACTION_USER_FOREGROUNDå’ŒACTION_USER_SWITCHEDå¹¿æ’­</span><br>    sendUserSwitchBroadcasts(oldUserId, newUserId);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¼•ç”¨ä¸€ä¸‹<a href="https://blog.csdn.net/qq_14978113/article/details/94654401?spm=1001.2014.3001.5506%E7%89%B9%E5%88%AB%E6%A3%92%E7%9A%84%E4%B8%80%E5%BC%A0%E4%BB%8EAMS%E5%88%B0finishUserBoot%E7%9A%84%E5%9B%BE%E7%89%87">https://blog.csdn.net/qq_14978113/article/details/94654401?spm=1001.2014.3001.5506ç‰¹åˆ«æ£’çš„ä¸€å¼ ä»AMSåˆ°finishUserBootçš„å›¾ç‰‡</a></p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0OTc4MTEz.png" alt="img" style="zoom: 60%;"><p>ğŸ‡ <strong>æ‰€ä»¥ä¸ç®¡æˆ‘ä»¬æ˜¯å‰å°åˆ‡æ¢è¿˜æ˜¯åå°åˆ‡æ¢ï¼Œæœ€ç»ˆéƒ½ä¼šæ€»åˆ°finishUserBoot</strong></p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230619224008130.png" alt="image-20230619224008130" style="zoom: 50%;"><h3 id="3-3-åˆ‡æ¢ç”¨æˆ·ç»“æŸfinishUserBoot-ä¸‡ç‰©å½’å®—"><a href="#3-3-åˆ‡æ¢ç”¨æˆ·ç»“æŸfinishUserBoot-ä¸‡ç‰©å½’å®—" class="headerlink" title="3.3 åˆ‡æ¢ç”¨æˆ·ç»“æŸfinishUserBoot(ä¸‡ç‰©å½’å®—)"></a>3.3 åˆ‡æ¢ç”¨æˆ·ç»“æŸfinishUserBoot(ä¸‡ç‰©å½’å®—)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishUserBoot</span><span class="hljs-params">(UserState uss)</span> &#123;<br>    finishUserBoot(uss, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishUserBoot</span><span class="hljs-params">(UserState uss, IIntentReceiver resultTo)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> uss.mHandle.getIdentifier();<br><br>    <span class="hljs-comment">// è®¾ç½®ç”¨æˆ·çŠ¶æ€ï¼Œä»bootingè®¾ç½®ä¸ºrunning_locked</span><br>    <span class="hljs-keyword">if</span> (uss.setState(STATE_BOOTING, STATE_RUNNING_LOCKED)) &#123;<br>        logUserLifecycleEvent(userId, USER_LIFECYCLE_EVENT_USER_RUNNING_LOCKED,<br>                              USER_LIFECYCLE_EVENT_STATE_NONE);<br>        <span class="hljs-comment">// UserManagerServiceç»´æŠ¤çš„ç”¨æˆ·çŠ¶æ€ä¸­æ·»åŠ userid,uss</span><br>        mInjector.getUserManagerInternal().setUserState(userId, uss.state);<br><br>        <span class="hljs-keyword">if</span> (!mInjector.getUserManager().isPreCreated(userId)) &#123;<br>            mHandler.sendMessage(mHandler.obtainMessage(REPORT_LOCKED_BOOT_COMPLETE_MSG,<br>                                                        userId, <span class="hljs-number">0</span>));<br>            <span class="hljs-keyword">if</span> (!(UserManager.isHeadlessSystemUserMode() &amp;&amp; uss.mHandle.isSystem())) &#123;<br>                sendLockedBootCompletedBroadcast(resultTo, userId);<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰ç”¨æˆ·æ˜¯profileç±»å‹</span><br>    <span class="hljs-keyword">if</span> (mInjector.getUserManager().isProfile(userId)) &#123;<br><span class="hljs-comment">// ...</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        maybeUnlockUser(userId);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨maybeUnlockUser</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">maybeUnlockUser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-keyword">return</span> unlockUserCleared(userId, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">unlockUserCleared</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-meta">@UserIdInt</span> <span class="hljs-type">int</span> userId, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret, IProgressListener listener)</span> &#123;<br>    UserState uss;<br>    <span class="hljs-comment">// å¦‚æœç”¨æˆ·æ²¡æœ‰è§£é”</span><br>    <span class="hljs-keyword">if</span> (!StorageManager.isUserKeyUnlocked(userId)) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> getUserInfo(userId);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">IStorageManager</span> <span class="hljs-variable">storageManager</span> <span class="hljs-operator">=</span> mInjector.getStorageManager();<br>        <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è°ƒç”¨SMSè§£é”CE Storage</span><br>            storageManager.unlockUserKey(userId, userInfo.serialNumber, token, secret);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException | RuntimeException e) &#123;<br>            Slogf.w(TAG, <span class="hljs-string">&quot;Failed to unlock: &quot;</span> + e.getMessage());<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span> (!finishUserUnlocking(uss)) &#123;<br>        notifyFinished(userId, listener);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-1-è§£é”CE-Storage"><a href="#3-3-1-è§£é”CE-Storage" class="headerlink" title="3.3.1 è§£é”CE Storage"></a>3.3.1 è§£é”CE Storage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlockUserKey</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> serialNumber, <span class="hljs-type">byte</span>[] token, <span class="hljs-type">byte</span>[] secret)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isFsEncrypted</span> <span class="hljs-operator">=</span> StorageManager.isFileEncryptedNativeOrEmulated();<br>    <span class="hljs-comment">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»è§£é”</span><br>    <span class="hljs-keyword">if</span> (isUserKeyUnlocked(userId)) &#123;<br>        Slog.d(TAG, <span class="hljs-string">&quot;User &quot;</span> + userId + <span class="hljs-string">&quot;&#x27;s CE storage is already unlocked&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>   <span class="hljs-comment">// å¦‚æœæ”¯æŒæ–‡ä»¶åŠ å¯†ï¼Œåˆ™è°ƒç”¨Voldçš„unlockUserKeyæ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (isFsEncrypted) &#123;<br>        mVold.unlockUserKey(userId, serialNumber, encodeBytes(token), encodeBytes(secret));<br>    &#125;<br><br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        mLocalUnlockedUsers.append(userId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-ç»“æŸè§£é”finishUserUnlocking"><a href="#3-3-2-ç»“æŸè§£é”finishUserUnlocking" class="headerlink" title="3.3.2 ç»“æŸè§£é”finishUserUnlocking"></a>3.3.2 ç»“æŸè§£é”finishUserUnlocking</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">finishUserUnlocking</span><span class="hljs-params">(<span class="hljs-keyword">final</span> UserState uss)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> uss.mHandle.getIdentifier();<br>    <span class="hljs-keyword">if</span> (!StorageManager.isUserKeyUnlocked(userId)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    FgThread.getHandler().post(() -&gt; &#123;<br>        mInjector.getUserManager().onBeforeUnlockUser(userId);<br>        <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>            <span class="hljs-keyword">if</span> (!uss.setState(STATE_RUNNING_LOCKED, STATE_RUNNING_UNLOCKING)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// è®¾ç½®ç”¨æˆ·çŠ¶æ€</span><br>        mInjector.getUserManagerInternal().setUserState(userId, uss.state);<br><br>        <span class="hljs-comment">// å‘é€handlerä¿¡æ¯</span><br>        mHandler.obtainMessage(USER_UNLOCK_MSG, userId, <span class="hljs-number">0</span>, uss).sendToTarget();<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤„ç†handlerä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> USER_UNLOCK_MSG:<br>    finishUserUnlocked((UserState) msg.obj);<br>    <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨finishUserUnlocked</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">finishUserUnlocked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> UserState uss)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> uss.mHandle.getIdentifier();<br><br>    mInjector.installEncryptionUnawareProviders(userId);<br><br>    <span class="hljs-keyword">if</span> (!mInjector.getUserManager().isPreCreated(userId)) &#123;<br>        <span class="hljs-comment">//å‘é€ACTION_USER_UNLOCKEDå¹¿æ’­ï¼Œå¹¶è¡Œå¹¿æ’­</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Intent</span> <span class="hljs-variable">unlockedIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_USER_UNLOCKED);<br>        unlockedIntent.putExtra(Intent.EXTRA_USER_HANDLE, userId);<br>        unlockedIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_FOREGROUND);<br>        mInjector.broadcastIntent(unlockedIntent, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>,<br>                                  <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, AppOpsManager.OP_NONE, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, MY_PID, SYSTEM_UID,<br>                                  Binder.getCallingUid(), Binder.getCallingPid(), userId);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> getUserInfo(userId);<br> <span class="hljs-comment">//ç”¨æˆ·fingerprintæ”¹å˜ï¼Œåˆ™å‘é€å¹¿æ’­</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> getUserInfo(userId);<br>    <span class="hljs-keyword">if</span> (!Objects.equals(info.lastLoggedInFingerprint, Build.FINGERPRINT)<br>        || SystemProperties.getBoolean(<span class="hljs-string">&quot;persist.pm.mock-upgrade&quot;</span>, <span class="hljs-literal">false</span>)) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> quiet;<br>        <span class="hljs-keyword">if</span> (info.isManagedProfile()) &#123;<br><span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            quiet = <span class="hljs-literal">false</span>;<br>        &#125;<br>        mInjector.sendPreBootBroadcast(userId, quiet, () -&gt; finishUserUnlockedCompleted(uss));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        finishUserUnlockedCompleted(uss);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åçš„æœ€åï¼Œæˆ‘ä»¬ç»“æŸæ•´ä¸ªçš„è§£é”finishUserUnlockedCompleted</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishUserUnlockedCompleted</span><span class="hljs-params">(UserState uss)</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> uss.mHandle.getIdentifier();<br><br>      mInjector.getUserManager().onUserLoggedIn(userId);<br><br>      <span class="hljs-type">Runnable</span> <span class="hljs-variable">initializeUser</span> <span class="hljs-operator">=</span> () -&gt; mInjector.getUserManager().makeInitialized(userInfo.id);<br>      <span class="hljs-keyword">if</span> (!userInfo.isInitialized()) &#123;<br>          <span class="hljs-keyword">if</span> (userInfo.preCreated) &#123;<br>              <span class="hljs-comment">// ...</span><br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userId != UserHandle.USER_SYSTEM) &#123;<br>              <span class="hljs-comment">//å‘é€ACTION_USER_INITIALIZEå¹¿æ’­å»ç»™useråˆå§‹åŒ–ï¼Œï¼Œä¸²è¡Œå¹¿æ’­</span><br>              <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_USER_INITIALIZE);<br>              intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND<br>                      | Intent.FLAG_RECEIVER_INCLUDE_BACKGROUND);<br>              mInjector.broadcastIntent(intent, <span class="hljs-literal">null</span>,<br>                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">IIntentReceiver</span>.Stub() &#123;<br>                          <span class="hljs-meta">@Override</span><br>                          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performReceive</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> resultCode,</span><br><span class="hljs-params">                                  String data, Bundle extras, <span class="hljs-type">boolean</span> ordered,</span><br><span class="hljs-params">                                  <span class="hljs-type">boolean</span> sticky, <span class="hljs-type">int</span> sendingUser)</span> &#123;<br>                              initializeUser.run();<br>                          &#125;<br>                      &#125;, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, AppOpsManager.OP_NONE,<br>                      <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, MY_PID, SYSTEM_UID, Binder.getCallingUid(),<br>                      Binder.getCallingPid(), userId);<br>          &#125;<br>      &#125;<br><br>      mInjector.startUserWidgets(userId);<br><br>      mHandler.obtainMessage(USER_UNLOCKED_MSG, userId, <span class="hljs-number">0</span>).sendToTarget();<br><br><span class="hljs-comment">//å‘é€ACTION_BOOT_COMPLETEDå¹¿æ’­ï¼Œä¸²è¡Œå¹¿æ’­</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Intent</span> <span class="hljs-variable">bootIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_BOOT_COMPLETED, <span class="hljs-literal">null</span>);<br>      bootIntent.putExtra(Intent.EXTRA_USER_HANDLE, userId);<br>      bootIntent.addFlags(Intent.FLAG_RECEIVER_NO_ABORT<br>              | Intent.FLAG_RECEIVER_INCLUDE_BACKGROUND<br>              | Intent.FLAG_RECEIVER_OFFLOAD);<br><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();<br>      FgThread.getHandler().post(() -&gt; &#123;<br>          mInjector.broadcastIntent(bootIntent, <span class="hljs-literal">null</span>,<br>                  <span class="hljs-keyword">new</span> <span class="hljs-title class_">IIntentReceiver</span>.Stub() &#123;<br>                      <span class="hljs-meta">@Override</span><br>                      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performReceive</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> resultCode, String data,</span><br><span class="hljs-params">                              Bundle extras, <span class="hljs-type">boolean</span> ordered, <span class="hljs-type">boolean</span> sticky, <span class="hljs-type">int</span> sendingUser)</span><br>                                      <span class="hljs-keyword">throws</span> RemoteException &#123;<br>                          mBootCompleted = <span class="hljs-literal">true</span>;<br>                      &#125;<br>                  &#125;, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>,<br>                  <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;android.Manifest.permission.RECEIVE_BOOT_COMPLETED&#125;,<br>                  AppOpsManager.OP_NONE,<br>                  getTemporaryAppAllowlistBroadcastOptions(REASON_BOOT_COMPLETED).toBundle(),<br>                  <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, MY_PID, SYSTEM_UID, callingUid, callingPid, userId);<br>      &#125;);<br>  &#125;<br></code></pre></td></tr></table></figure><h2 id="4-å¤„ç†H-BOOT-COMPLETEDæ¶ˆæ¯"><a href="#4-å¤„ç†H-BOOT-COMPLETEDæ¶ˆæ¯" class="headerlink" title="4.å¤„ç†H_BOOT_COMPLETEDæ¶ˆæ¯"></a>4.å¤„ç†H_BOOT_COMPLETEDæ¶ˆæ¯</h2><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/geshifei/article/details/130194916">https://blog.csdn.net/geshifei/article/details/130194916</a></p></blockquote><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230626000521128.png" alt="image-20230626000521128" style="zoom:70%;"><p>å½“å¯åŠ¨å®Œæˆåï¼ŒSystemServiceManagerå‘é€H_BOOT_COMPLETEDæ¶ˆæ¯ã€‚StorageManagerServiceæ”¶åˆ°å¼€æœºå¹¿æ’­æ¶ˆæ¯H_BOOT_COMPLETEDï¼ŒæŒ‰æ—¶é—´é¡ºåºå®Œæˆä»¥ä¸‹4ä»¶äº‹æƒ…ï¼š</p><ul><li>initç”¨æˆ·ç›®å½•çš„åŠ å¯†çŠ¶æ€</li><li>reset external storage service</li><li>reset vold service</li><li>æ·»åŠ ç”¨æˆ·</li></ul><p>ä»£ç æ•´ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/cd5c71637c0b460f8aaae4a915c7f212.png" alt="img"><h3 id="4-1-initç”¨æˆ·ç›®å½•çš„åŠ å¯†çŠ¶æ€"><a href="#4-1-initç”¨æˆ·ç›®å½•çš„åŠ å¯†çŠ¶æ€" class="headerlink" title="4.1 initç”¨æˆ·ç›®å½•çš„åŠ å¯†çŠ¶æ€"></a>4.1 initç”¨æˆ·ç›®å½•çš„åŠ å¯†çŠ¶æ€</h3><p>ä»£ç è·¯å¾„ï¼šStorageManagerServiceHandler::handleMessage â€“&gt; handleBootCompleted â€“&gt; initIfBootedAndConnected</p><p>åˆ†ä¸¤ç§æƒ…å†µï¼š<br>1ï¼‰ç”¨æˆ·ç›®å½•é‡‡ç”¨ç¡¬ä»¶åŠ è§£å¯†ï¼ˆnative encryptionï¼‰ï¼Œæ­¤é˜¶æ®µä»€ä¹ˆäº‹ä¹Ÿä¸åšï¼Œå‡½æ•°ç›´æ¥è¿”å›<br>2ï¼‰ç”¨æˆ·ç›®å½•é‡‡ç”¨è½¯ä»¶åŠ è§£å¯†ï¼ˆenmulated encryptionï¼‰ï¼Œæ‰§è¡Œlock  encryption keyï¼ˆç”¨æˆ·ç›®å½•å·²åŠ å¯†çš„æƒ…å†µï¼‰æˆ–è€…unlock encryption keyï¼ˆç”¨æˆ·ç›®å½•æœªåŠ å¯†çš„æƒ…å†µï¼‰</p><p>ä»å®‰å…¨æ€§ã€æ€§èƒ½è§’åº¦çœ‹ï¼Œç¡¬ä»¶åŠ è§£å¯†æ›´å¥½ã€‚</p><p>ç°åœ¨çš„æ‰‹æœºåŸºæœ¬éƒ½æ˜¯ç¡¬ä»¶åŠ è§£å¯†æ–¹å¼ï¼Œé€šè¿‡<code>adb shell getprop ro.crypto.state</code>å¯æŸ¥è¯¢æ‰‹æœºç”¨çš„æ˜¯å“ªç§åŠ è§£å¯†æ–¹å¼ã€‚</p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230625235902263.png" alt="image-20230625235902263" style="zoom: 67%;"><h2 id="5-æ‹¿æå°ç»†èŠ‚"><a href="#5-æ‹¿æå°ç»†èŠ‚" class="headerlink" title="5.æ‹¿æå°ç»†èŠ‚"></a>5.æ‹¿æå°ç»†èŠ‚</h2><h3 id="5-1-è§£é”ç”¨æˆ·"><a href="#5-1-è§£é”ç”¨æˆ·" class="headerlink" title="5.1 è§£é”ç”¨æˆ·"></a>5.1 è§£é”ç”¨æˆ·</h3><h4 id="5-1-1-å­˜å‚¨äº†å·²è§£é”çš„ç”¨æˆ·"><a href="#5-1-1-å­˜å‚¨äº†å·²è§£é”çš„ç”¨æˆ·" class="headerlink" title="5.1.1 å­˜å‚¨äº†å·²è§£é”çš„ç”¨æˆ·"></a>5.1.1 å­˜å‚¨äº†å·²è§£é”çš„ç”¨æˆ·</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// /frameworks/base/core/java/android/os/storage/StorageManager.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isUserKeyUnlocked</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br><br>    sStorageManager = IStorageManager.Stub.asInterface(ServiceManager.getService(<span class="hljs-string">&quot;mount&quot;</span>));<br>   <br>    <span class="hljs-keyword">return</span> sStorageManager.isUserKeyUnlocked(userId);<br>&#125;<br><br><span class="hljs-comment">// /frameworks/base/services/core/java/com/android/server/StorageManagerService.java</span><br><span class="hljs-comment">// WatchedLockedUsersä¸­ç»´æŠ¤äº†åˆ—è¡¨ï¼Œè¡¨ç¤ºå·²ç»è§£é”çš„ç”¨æˆ·</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">WatchedLockedUsers</span> <span class="hljs-variable">mLocalUnlockedUsers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WatchedLockedUsers</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isUserKeyUnlocked</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        <span class="hljs-keyword">return</span> mLocalUnlockedUsers.contains(userId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡dumpsys mountæŸ¥çœ‹å·²è§£é”çš„ç”¨æˆ·</p><h4 id="5-1-2-æ•°æ®ç»“æ„mLocalUnlockedUsers"><a href="#5-1-2-æ•°æ®ç»“æ„mLocalUnlockedUsers" class="headerlink" title="5.1.2 æ•°æ®ç»“æ„mLocalUnlockedUsers"></a>5.1.2 æ•°æ®ç»“æ„mLocalUnlockedUsers</h4><p>æˆ‘ä»¬è°ƒç”¨SMSä¸­çš„isUserKeyUnlockedï¼Œå®é™…ä¸Šå°±æ˜¯æŸ¥è¯¢mLocalUnlockedUsersæ˜¯å¦åŒ…å«äº†è¯¥ç”¨æˆ·Id</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">WatchedLockedUsers</span> <span class="hljs-variable">mLocalUnlockedUsers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WatchedLockedUsers</span>();<br></code></pre></td></tr></table></figure><p>WatchedLockedUsersæ˜¯ä¸€ä¸ªç±»ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ã€‚å› æ­¤æˆ‘ä»¬åœ¨ç†è§£mLocalUnlockedUsersçš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥ç†è§£æˆä¸€ä¸ªåˆ—è¡¨ã€‚</p><h4 id="5-1-3-å‘mLocalUnlockedUsersæ·»åŠ å·²è§£é”ç”¨æˆ·æ—¶æœº"><a href="#5-1-3-å‘mLocalUnlockedUsersæ·»åŠ å·²è§£é”ç”¨æˆ·æ—¶æœº" class="headerlink" title="5.1.3 å‘mLocalUnlockedUsersæ·»åŠ å·²è§£é”ç”¨æˆ·æ—¶æœº"></a>5.1.3 å‘mLocalUnlockedUsersæ·»åŠ å·²è§£é”ç”¨æˆ·æ—¶æœº</h4><p>å½“ç”¨æˆ·æœ€åè°ƒç”¨finishUserBootåï¼Œä¾æ¬¡è°ƒç”¨ï¼š</p><p><strong>finishUserBoot -&gt; maybeUnlockUser -&gt; unlockUserCleared  -&gt; unlockUserKey</strong></p><img src="/2023/06/01/%E5%AE%89%E5%8D%9312%E5%A4%9A%E7%94%A8%E6%88%B7%E6%9C%BA%E5%88%B6/image-20230620215447143.png" alt="image-20230620215447143" style="zoom: 50%;"><p>ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨Voldè§£é”CE Storageæ²¡æœ‰é—®é¢˜åï¼Œè®¤ä¸ºè¯¥ç”¨æˆ·è§£é”æˆåŠŸï¼Œé‚£ä¹ˆå°†è¯¥ç”¨æˆ·æ·»åŠ åˆ°mLocalUnlockedUsersä¸­</p><h4 id="5-1-4-åˆ é™¤æœªè§£é”ç”¨æˆ·ã€æœ‰é—®é¢˜ã€‘"><a href="#5-1-4-åˆ é™¤æœªè§£é”ç”¨æˆ·ã€æœ‰é—®é¢˜ã€‘" class="headerlink" title="5.1.4 åˆ é™¤æœªè§£é”ç”¨æˆ·ã€æœ‰é—®é¢˜ã€‘"></a>5.1.4 åˆ é™¤æœªè§£é”ç”¨æˆ·ã€æœ‰é—®é¢˜ã€‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockUserKey</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// è°ƒç”¨voldé”ä½ç”¨æˆ·</span><br>        mVold.lockUserKey(userId);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        Slog.wtf(TAG, e);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// mLocalUnlockedUsersç§»é™¤ä¼ è¿›æ¥çš„userId</span><br>    <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>        mLocalUnlockedUsers.remove(userId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-ç”¨æˆ·ç±»å‹managed-profile"><a href="#5-2-ç”¨æˆ·ç±»å‹managed-profile" class="headerlink" title="5.2 ç”¨æˆ·ç±»å‹managed profile"></a>5.2 ç”¨æˆ·ç±»å‹managed profile</h3><p><a href="https://source.android.com/docs/devices/admin/multi-user?hl=zh-cn#user_types">https://source.android.com/docs/devices/admin/multi-user?hl=zh-cn#user_types</a></p><p>ç”¨æˆ·ç»å¸¸æƒ³åœ¨ä¼ä¸šç¯å¢ƒä¸­ä½¿ç”¨ä»–ä»¬çš„ç§äººè®¾å¤‡ã€‚è¿™ç§æƒ…å†µå¯èƒ½è®©ä¼ä¸šé™·å…¥å›°å¢ƒã€‚å¦‚æœç”¨æˆ·ä½¿ç”¨ä»–ä»¬çš„ç§äººè®¾å¤‡ï¼Œä¼ä¸šä¸å¾—ä¸æ‹…å¿ƒåœ¨è¿™ä¸ªä¸å—æ§åˆ¶çš„è®¾å¤‡ä¸Šçš„æœºå¯†ä¿¡æ¯ï¼ˆä¾‹å¦‚å‘˜å·¥çš„ç”µå­é‚®ä»¶å’Œé€šè®¯å½•ï¼‰ã€‚</p><p>ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼ŒAndroid 5.0ï¼ˆAPI 21ï¼‰å…è®¸ä¼ä¸šè®¾ç½® managed profileã€‚å¦‚æœè®¾å¤‡æœ‰ managed profileï¼Œè¿™ä¸ª profile çš„è®¾ç½®æ˜¯åœ¨ä¼ä¸šç®¡ç†å‘˜çš„æ§åˆ¶ä¹‹ä¸‹çš„ã€‚ç®¡ç†å‘˜å¯ä»¥é€‰æ‹©åœ¨è¿™ä¸ª profile ä¹‹ä¸‹ï¼Œä»€ä¹ˆåº”ç”¨ç¨‹åºå¯ä»¥è¿è¡Œï¼Œä»€ä¹ˆè®¾å¤‡åŠŸèƒ½å¯ä»¥å…è®¸ã€‚</p><p>å¦‚æœä¸€ä¸ªè®¾å¤‡æœ‰ managed profileï¼Œé‚£ä¹ˆï¼Œæ— è®ºåº”ç”¨ç¨‹åºåœ¨å“ªä¸ª profile ä¹‹ä¸‹è¿è¡Œï¼Œéƒ½æ„å‘³ç€ï¼š</p><ul><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§éƒ¨åˆ†çš„ intent æ— æ³•ä»ä¸€ä¸ª profile è·¨è¶Šåˆ°å¦ä¸€ä¸ªã€‚å¦‚æœåœ¨æŸä¸ª profile ä¹‹ä¸‹çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºåˆ›å»ºäº† intentï¼Œè€Œè¿™ä¸ª profile æ— æ³•å“åº”ï¼Œåˆå› ä¸º profile çš„é™åˆ¶è¿™ä¸ª intent ä¸å…è®¸è·¨è¶Šåˆ°å…¶ä»– profileï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªè¯·æ±‚å°±å¤±è´¥äº†ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½æ„å¤–å…³é—­ã€‚</p></li><li><p>profile ç®¡ç†å‘˜å¯ä»¥åœ¨ managed profile ä¸­é™åˆ¶å“ªä¸ªç³»ç»Ÿåº”ç”¨ç¨‹åºå¯ä»¥è¿è¡Œã€‚è¿™ä¸ªé™åˆ¶å¯èƒ½å¯¼è‡´åœ¨ managed profile ä¸­ä¸€äº›å¸¸è§çš„ intent æ— æ³•å¤„ç†ã€‚</p></li><li><p>å› ä¸º managed profile å’Œé managed profile æœ‰å„è‡ªçš„å­˜å‚¨åŒºåŸŸï¼Œå¯¼è‡´æ–‡ä»¶ URI åœ¨ä¸€ä¸ª profile ä¸­æœ‰æ•ˆï¼Œä½†åœ¨å…¶ä»– profile ä¸­æ— æ•ˆã€‚åœ¨ä¸€ä¸ª profile ä¸­åˆ›å»ºçš„ intent å¯èƒ½åœ¨å…¶ä»– profileï¼ˆå–å†³äº profile è®¾ç½®ï¼‰ä¸­è¢«å“åº”ï¼Œæ‰€ä»¥åœ¨ intent ä¸­æ”¾ç½®æ–‡ä»¶ URI æ˜¯ä¸å®‰å…¨çš„ã€‚</p></li></ul><p><a href="https://www.w3cschool.cn/android_training_course/android_training_course-t3xv27in.html">https://www.w3cschool.cn/android_training_course/android_training_course-t3xv27in.html</a></p><h3 id="5-3-SMSç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„å˜åŒ–UserState-Uss"><a href="#5-3-SMSç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„å˜åŒ–UserState-Uss" class="headerlink" title="5.3 SMSç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„å˜åŒ–UserState(Uss)"></a>5.3 SMSç»´æŠ¤ç”¨æˆ·çŠ¶æ€çš„å˜åŒ–UserState(Uss)</h3>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿ"><a href="#å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿ"></a>å®‰å“fuseæ–‡ä»¶ç³»ç»Ÿ</h1><p><a href="https://xie.infoq.cn/article/655c0893ed150ff65f2b7a16f">https://xie.infoq.cn/article/655c0893ed150ff65f2b7a16f</a></p><h2 id="1-Fuseæ˜¯ä»€ä¹ˆ"><a href="#1-Fuseæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.Fuseæ˜¯ä»€ä¹ˆ"></a>1.Fuseæ˜¯ä»€ä¹ˆ</h2><p>Linuxå†…æ ¸å®˜æ–¹æ–‡æ¡£å¯¹ FUSE çš„è§£é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p>What is FUSE?FUSE is a userspace filesystem framework. It consists of a kernel module (fuse.ko), a userspace library (libfuse.*) and a mount utility (fusermount).</p></blockquote><p><strong>åˆ’é‡ç‚¹ï¼šFUSE æ˜¯ä¸€ä¸ªç”¨æ¥å®ç°ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ¡†æ¶</strong>ï¼Œè¿™å¥— FUSE æ¡†æ¶åŒ…å« 3 ä¸ªç»„ä»¶ï¼š</p><ol><li><strong>å†…æ ¸æ¨¡å—</strong> <code>fuse.ko</code> ï¼šç”¨æ¥æ¥æ”¶ vfs ä¼ é€’ä¸‹æ¥çš„ IO è¯·æ±‚ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ª IO å°è£…ä¹‹åé€šè¿‡ç®¡é“å‘é€åˆ°ç”¨æˆ·æ€ï¼›</li><li><strong>ç”¨æˆ·æ€ lib åº“</strong> <code>libfuse</code> ï¼šè§£æå†…æ ¸æ€è½¬å‘å‡ºæ¥çš„åè®®åŒ…ï¼Œæ‹†è§£æˆå¸¸è§„çš„ IO è¯·æ±‚ï¼›</li><li><strong>mount å·¥å…·</strong> <code>fusermount</code> ï¼›</li></ol><p>è¿™å°±æ˜¯ FUSE æ¡†æ¶çš„ 3 å¤§å†…å®¹äº†ï¼Œä¸‹é¢æˆ‘ä»¬è§£é‡Šä¸‹ã€‚è¿™ 3 ä¸ªç»„ä»¶åªä¸ºäº†å®Œæˆä¸€ä»¶äº‹ï¼šè®© IO åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´è‡ªç”±ç©¿æ¢­ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬è®¤ä¸º FUSE æ˜¯ Filesystem in Userspace çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="2-FuseåŸç†"><a href="#2-FuseåŸç†" class="headerlink" title="2.FuseåŸç†"></a>2.FuseåŸç†</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ IO çš„è·¯å¾„ï¼Œæ¥ç†è§£ä¸‹ FUSE çš„åŸç†ã€‚é¦–å…ˆçœ‹ä¸€çœ¼ wiki ä¸Šæœ‰å¯¹ FUSE çš„ <code>ls -l /tmp/fuse</code> å‘½ä»¤çš„æ¼”ç¤ºå›¾ï¼š</p><img src="/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/b360be6f915a98e85780454c03160882-1686063758401-3.png" alt="img" style="zoom: 50%;"><p>è¿™ä¸ªå›¾çš„æ„æ€æ˜¯ï¼š</p><ol><li>èƒŒæ™¯ï¼šä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ç‚¹ä¸º <code>/tmp/fuse</code> ï¼Œç”¨æˆ·äºŒè¿›åˆ¶ç¨‹åºæ–‡ä»¶ä¸º <code>./hello</code> ï¼›</li><li>å½“æ‰§è¡Œ <code>ls -l /tmp/fuse</code> å‘½ä»¤çš„æ—¶å€™ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</li><li>IO è¯·æ±‚å…ˆè¿›å†…æ ¸ï¼Œç» vfs ä¼ é€’ç»™å†…æ ¸ FUSE æ–‡ä»¶ç³»ç»Ÿæ¨¡å—ï¼›</li><li>å†…æ ¸ FUSE æ¨¡å—æŠŠè¯·æ±‚å‘ç»™åˆ°ç”¨æˆ·æ€ï¼Œç”± <code>./hello</code> ç¨‹åºæ¥æ”¶å¹¶ä¸”å¤„ç†ã€‚å¤„ç†å®Œæˆä¹‹åï¼Œå“åº”åŸè·¯è¿”å›ï¼›</li></ol><p>ç®€åŒ–çš„ IO åŠ¨ç”»ç¤ºæ„å›¾ï¼š</p><img src="/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/fuse1.gif" alt="img" style="zoom: 67%;"><p>é€šè¿‡è¿™ä¸¤å¼ å›¾ï¼Œå¯¹ FUSE IO çš„æµç¨‹åº”è¯¥å°±æ¸…æ™°äº†ï¼Œå†…æ ¸ FUSE æ¨¡å—åœ¨å†…æ ¸æ€ä¸­é—´åšåè®®åŒ…è£…å’Œåè®®è§£æçš„å·¥ä½œã€‚æ‰¿æ¥ vfs ä¸‹æ¥çš„è¯·æ±‚å¹¶æŒ‰ç…§ FUSE åè®®è½¬å‘åˆ°ç”¨æˆ·æ€ï¼Œç„¶åæ¥æ”¶ç”¨æˆ·æ€çš„å“åº”ï¼Œå›å¤ç»™ç”¨æˆ·ã€‚</p><p>FUSE åœ¨è¿™æ¡ IO è·¯å¾„æ˜¯æ˜¯æŒ‡åšäº†ä¸€ä¸ªé€æ˜ä¸­è½¬ç«™çš„ä½œç”¨ï¼Œç”¨æˆ·å®Œå…¨ä¸æ„ŸçŸ¥è¿™å¥—æ¡†æ¶ã€‚æˆ‘ä»¬æŠŠä¸­é—´çš„ FUSE å½“ä½œä¸€ä¸ªé»‘ç›’é®ä½ï¼Œå°±æ›´å®¹æ˜“ç†è§£äº†ã€‚<img src="/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/daa6faab9efe0b3c4271bc9db2eba122.gif" alt="img" style="zoom: 67%;"></p><p><strong>æ€è€ƒé—®é¢˜ï¼šå†…æ ¸çš„ fuse.ko æ¨¡å—ï¼Œè¿˜æœ‰ libfuse åº“ã€‚è¿™ä¸¤ä¸ªè§’è‰²æ˜¯çš„ä½œç”¨ï¼Ÿ</strong></p><p>â­ åˆ’é‡ç‚¹ï¼šè¿™ä¸¤ä¸ªæ¨¡å—ä¸€ä¸ªä½äºå†…æ ¸ï¼Œä¸€ä¸ªä½äºç”¨æˆ·æ€ï¼Œæ˜¯é…å¥—ä½¿ç”¨çš„ï¼Œ<strong>æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ˜¯åè®®å°è£…å’Œè§£æ</strong>ã€‚</p><p>ä¸¾ç»™ä¾‹å­ï¼Œå†…æ ¸ fuse.ko ç”¨äºæ‰¿æ¥ vfs ä¸‹æ¥çš„ io è¯·æ±‚ï¼Œç„¶åå°è£…æˆ FUSE æ•°æ®åŒ…ï¼Œè½¬å‘ç»™ç”¨æˆ·æ€ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿæ”¶åˆ°è¿™ä¸ª FUSE æ•°æ®åŒ…ï¼Œå®ƒå¦‚æœæƒ³è¦çœ‹æ‡‚è¿™ä¸ªæ•°æ®åŒ…ï¼Œå°±å¿…é¡»å®ç°ä¸€å¥— FUSE åè®®çš„ä»£ç ï¼Œè¿™å¥—ä»£ç æ˜¯å…¬å¼€é€æ˜çš„ï¼Œå±äº FUSE æ¡†æ¶çš„å…¬å…±çš„ä»£ç ï¼Œè¿™ç§ä»£ç ä¸èƒ½å¤Ÿè®©æ‰€æœ‰çš„ç”¨æˆ·æ–‡ä»¶ç³»ç»Ÿéƒ½é‡å¤å®ç°ä¸€éï¼Œ<strong>äºæ˜¯ libfuse ç”¨æˆ·åº“å°±è¯ç”Ÿäº†</strong>ã€‚</p><blockquote><p>ğŸ”´<strong>å®‰å“å¯¹äºlibfuseçš„å¼•å…¥ï¼š</strong></p><ul><li>æ–‡ä»¶è·¯å¾„: external\libfuse</li><li>ç¼–è¯‘ç”Ÿæˆï¼šlibfuse.so</li></ul><p>é¡ºä¾¿ä»‹ç»ä¸€ä¸‹å®‰å“æºç ç›®å½•external: Androidå¼•å…¥çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒGoogleä¼šæŠŠä¸€äº›æ¯”è¾ƒä¼˜ç§€çš„å¼€æºåº“çº³å…¥åˆ°æºç é‡Œé¢ï¼Œæ¯”å¦‚appå¼€å‘å¸¸ç”¨çš„okhttpï¼Œzxingï¼Œsqliteç­‰</p></blockquote><p>å›åˆ°å¼€ç¯‡çš„é—®é¢˜ï¼ŒFUSE èƒ½åšä»€ä¹ˆï¼Ÿ</p><p>çœ‹åˆ°è¿™é‡Œä½ åº”è¯¥å°±æ¸…æ™°äº†ï¼ŒFUSE èƒ½å¤Ÿè½¬è¿ vfs ä¸‹æ¥çš„ io è¯·æ±‚åˆ°ç”¨æˆ·æ€ï¼Œç”¨æˆ·ç¨‹åºå¤„ç†ä¹‹åï¼Œç»ç”± FUSE æ¡†æ¶å›åº”ç»™ç”¨æˆ·ã€‚<strong>ä»è€Œå°±å¯ä»¥æŠŠæ–‡ä»¶ç³»ç»Ÿçš„å®ç°å…¨éƒ¨æ”¾åˆ°ç”¨æˆ·æ€å®ç°äº†</strong>ã€‚</p><h2 id="3-Fuseåè®®æ ¼å¼"><a href="#3-Fuseåè®®æ ¼å¼" class="headerlink" title="3.Fuseåè®®æ ¼å¼"></a>3.Fuseåè®®æ ¼å¼</h2><p>æˆ‘ä»¬åˆ†æä¸€çœ¼ FUSE æ•°æ®è½¬è¿çš„æ•°æ®æ ¼å¼ï¼ˆ fuse åè®®çš„æ ¼å¼ ï¼‰ï¼Œè¯·æ±‚åŒ…å’Œå“åº”åŒ…æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿå¥½å¥‡ä¸ï¼Ÿ</p><h3 id="3-1-Fuseè¯·æ±‚åŒ…"><a href="#3-1-Fuseè¯·æ±‚åŒ…" class="headerlink" title="3.1 Fuseè¯·æ±‚åŒ…"></a>3.1 Fuseè¯·æ±‚åŒ…</h3><ul><li><code>Header</code> ï¼š è¿™ä¸ªæ˜¯æ‰€æœ‰è¯·æ±‚å…±ç”¨çš„ï¼Œæ¯”å¦‚ <code>open</code> è¯·æ±‚ï¼Œ<code>read</code> è¯·æ±‚ï¼Œ<code>write</code> è¯·æ±‚ï¼Œ<code>getxattr</code> è¯·æ±‚ï¼Œå¤´éƒ¨éƒ½è‡³å°‘æœ‰è¿™ä¸ªç»“æ„ä½“ï¼Œ<code>Header</code> ç»“æ„ä½“èƒ½æè¿°æ•´ä¸ª FUSE è¯·æ±‚ï¼Œå…¶ä¸­å­—æ®µèƒ½åŒºåˆ†è¯·æ±‚ç±»å‹ï¼›</li><li><code>Payload</code> ï¼šè¿™ä¸ªä¸œè¥¿æ˜¯æ¯ä¸ª IO ç±»å‹ä¼šæ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚ <code>read</code> è¯·æ±‚å°±æ²¡è¿™ä¸ªï¼Œ<code>write</code> è¯·æ±‚å°±æœ‰è¿™ä¸ªï¼Œå› ä¸º <code>write</code> è¯·æ±‚æ˜¯æºå¸¦æ•°æ®çš„ï¼›</li></ul><p>æ•°æ®åŒ…åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šheaderï¼Œpayload ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++">type inHeader <span class="hljs-keyword">struct</span> &#123;<br>  Len    uint32<br>  Opcode uint32<br>  Unique uint64<br>  Nodeid uint64<br>  Uid    uint32<br>  Gid    uint32<br>  Pid    uint32<br>  _      uint32<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Len: æ˜¯æ•´ä¸ªè¯·æ±‚çš„å­—èŠ‚æ•°é•¿åº¦ï¼ˆ<code>Header</code> + <code>Payload</code>ï¼‰</li><li>Opcode: è¯·æ±‚çš„ç±»å‹ï¼Œæ¯”å¦‚åŒºåˆ† openã€readã€write ç­‰ç­‰ï¼›</li><li>Unique: è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼ˆå’Œå“åº”ä¸­è¦å¯¹åº”ï¼‰</li><li>Nodeid: è¯·æ±‚é’ˆå¯¹çš„æ–‡ä»¶ nodeidï¼Œç›®æ ‡æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹çš„ nodeidï¼›</li><li>Uid: æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹æ“ä½œçš„è¿›ç¨‹çš„ç”¨æˆ· ID</li><li>Gid: æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹æ“ä½œçš„è¿›ç¨‹çš„ç”¨æˆ·ç»„ ID</li><li>Pid: æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹æ“ä½œçš„è¿›ç¨‹çš„è¿›ç¨‹ ID</li></ul><h3 id="3-2-Fuseå“åº”åŒ…"><a href="#3-2-Fuseå“åº”åŒ…" class="headerlink" title="3.2 Fuseå“åº”åŒ…"></a>3.2 Fuseå“åº”åŒ…</h3><p>FUSE å“åº”åŒ…ä¹Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li><code>Header</code> ï¼šè¿™ä¸ªç»“æ„ä½“ä¹Ÿæ˜¯åœ¨æ•°æ®å¤´éƒ¨çš„ï¼Œæ‰€æœ‰ IO ç±»å‹çš„å“åº”éƒ½è‡³å°‘æœ‰è¿™ä¸ªç»“æ„ä½“ã€‚è¯¥ç»“æ„ä½“ç”¨äºæè¿°æ•´ä¸ªå“åº”è¯·æ±‚ï¼›</li><li><code>Payload</code> ï¼šæ¯ä¸ªè¯·æ±‚çš„ç±»å‹å¯èƒ½ä¸åŒï¼Œæ¯”å¦‚ <code>read</code> è¯·æ±‚å°±ä¼šæœ‰è¿™ä¸ªï¼Œå› ä¸ºè¦æºå¸¦ <code>read</code> å‡ºæ¥çš„ç”¨æˆ·æ•°æ®ï¼Œ<code>write</code> è¯·æ±‚å°±ä¸ä¼šæœ‰ï¼›</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">type outHeader <span class="hljs-keyword">struct</span> &#123;<br>  Len    uint32<br>  Error  int32<br>  Unique uint64<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Len: æ•´ä¸ªå“åº”çš„å­—èŠ‚æ•°é•¿åº¦ï¼ˆ <code>Header</code> + <code>Payload</code> ï¼‰ï¼›</li><li>Error: å“åº”é”™è¯¯ç ï¼ŒæˆåŠŸè¿”å› 0ï¼Œå…¶ä»–å¯¹åº”ç€ç³»ç»Ÿçš„é”™è¯¯ä»£ç ï¼Œè´Ÿæ•°ï¼›</li><li>Unique: å¯¹åº”è€…è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ï¼Œå’Œè¯·æ±‚å¯¹åº”ï¼›</li></ul><h2 id="4-å†…æ ¸æ€ã€ç”¨æˆ·æ€çš„çº½å¸¦"><a href="#4-å†…æ ¸æ€ã€ç”¨æˆ·æ€çš„çº½å¸¦" class="headerlink" title="4.å†…æ ¸æ€ã€ç”¨æˆ·æ€çš„çº½å¸¦"></a>4.å†…æ ¸æ€ã€ç”¨æˆ·æ€çš„çº½å¸¦</h2><p>ç°åœ¨å¯¹æ•°æ®åè®®çš„æ ¼å¼ï¼Œè½¬å‘å’Œè½¬è¿çš„æ¨¡å—æˆ‘ä»¬ä¹ŸçŸ¥é“äº†ã€‚ç°åœ¨è¿˜å·®ä¸€ä¸ªå…³é”®çš„ç‚¹ï¼š<strong>æ•°æ®åŒ…çš„é€šé“</strong>ï¼Œä¹Ÿå°±æ˜¯é«˜é€Ÿå…¬è·¯ã€‚</p><p>æ¢å¥è¯è¯´ï¼Œå†…æ ¸æ¨¡å—çš„â€œåŒ…è£¹â€å‘åˆ°å“ªé‡Œï¼Ÿç”¨æˆ·ç¨‹åºåˆä»å“ªé‡Œè¯»å–æ‹¿åˆ°è¿™ä¸ªâ€œåŒ…è£¹â€ã€‚</p><p><strong>ç­”æ¡ˆæ˜¯ï¼š</strong><code>/dev/fuse</code> <strong>ï¼Œè¿™ä¸ªè™šè®¾å¤‡æ–‡ä»¶å°±æ˜¯å†…æ ¸æ¨¡å—å’Œç”¨æˆ·ç¨‹åºçš„æ¡¥æ¢ã€‚</strong></p><p>ä¸€åˆ‡éƒ½é¡ºç†æˆç« äº†ï¼Œå†…æ ¸åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç›¸å½“äºä¸€ä¸ªä¿¡ä½¿ï¼Œç”¨æˆ·çš„ io é€šè¿‡æ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨è¿›æ¥ï¼Œèµ°åˆ°å†…æ ¸æ–‡ä»¶ç³»ç»Ÿ fuse ï¼Œfuse æ–‡ä»¶ç³»ç»ŸæŠŠè¿™ä¸ª io è¯·æ±‚å°è£…èµ·æ¥ï¼Œæ‰“åŒ…æˆç‰¹å®šçš„æ ¼å¼ï¼Œé€šè¿‡ <code>/dev/fuse</code> è¿™ä¸ªç®¡é“ä¼ é€’åˆ°ç”¨æˆ·æ€ã€‚åœ¨æ­¤ä¹‹å‰æœ‰å®ˆæŠ¤è¿›ç¨‹ç›‘å¬è¿™ä¸ªç®¡é“ï¼Œçœ‹åˆ°æœ‰æ¶ˆæ¯å‡ºæ¥ä¹‹åï¼Œç«‹é©¬è¯»å‡ºæ¥ï¼Œç„¶ååˆ©ç”¨ <code>libfuse</code> åº“è§£æåè®®ï¼Œä¹‹åå°±æ˜¯ç”¨æˆ·æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç é€»è¾‘äº†ã€‚</p><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆçœç•¥äº†æ‹†è§£åŒ…çš„æ­¥éª¤ï¼‰ï¼š</p><img src="/2023/05/31/%E5%AE%89%E5%8D%93fuse%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/0b7beda12f1ffea18de8c62fbfc3c941.gif" alt="img" style="zoom: 67%;">]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“ä¸­çš„æ§åˆ¶åè½¬IOC</title>
    <link href="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/"/>
    <url>/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“ä¸­çš„æ§åˆ¶åè½¬IOC"><a href="#å®‰å“ä¸­çš„æ§åˆ¶åè½¬IOC" class="headerlink" title="å®‰å“ä¸­çš„æ§åˆ¶åè½¬IOC"></a>å®‰å“ä¸­çš„æ§åˆ¶åè½¬IOC</h1><h2 id="1-IOCç®€ä»‹"><a href="#1-IOCç®€ä»‹" class="headerlink" title="1.IOCç®€ä»‹"></a>1.IOCç®€ä»‹</h2><h3 id="1-1-IOCæ˜¯ä»€ä¹ˆ"><a href="#1-1-IOCæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.1 IOCæ˜¯ä»€ä¹ˆ"></a>1.1 IOCæ˜¯ä»€ä¹ˆ</h3><p><strong>Iocâ€”Inversion of Controlï¼Œå³â€œæ§åˆ¶åè½¬â€ï¼Œä¸æ˜¯ä»€ä¹ˆæŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ã€‚</strong>åœ¨Javaå¼€å‘ä¸­ï¼Œ<strong>Iocæ„å‘³ç€å°†ä½ è®¾è®¡å¥½çš„å¯¹è±¡äº¤ç»™å®¹å™¨æ§åˆ¶ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„åœ¨ä½ çš„å¯¹è±¡å†…éƒ¨ç›´æ¥æ§åˆ¶ã€‚</strong>å¦‚ä½•ç†è§£å¥½Iocå‘¢ï¼Ÿç†è§£å¥½Iocçš„å…³é”®æ˜¯è¦æ˜ç¡®â€œè°æ§åˆ¶è°ï¼Œæ§åˆ¶ä»€ä¹ˆï¼Œä¸ºä½•æ˜¯åè½¬ï¼ˆæœ‰åè½¬å°±åº”è¯¥æœ‰æ­£è½¬äº†ï¼‰ï¼Œå“ªäº›æ–¹é¢åè½¬äº†â€ï¼Œé‚£æˆ‘ä»¬æ¥æ·±å…¥åˆ†æä¸€ä¸‹ï¼š</p><p> â— <strong>è°æ§åˆ¶è°ï¼Œæ§åˆ¶ä»€ä¹ˆï¼š</strong>ä¼ ç»ŸJava SEç¨‹åºè®¾è®¡ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨å¯¹è±¡å†…éƒ¨é€šè¿‡newè¿›è¡Œåˆ›å»ºå¯¹è±¡ï¼Œæ˜¯ç¨‹åºä¸»åŠ¨å»åˆ›å»ºä¾èµ–å¯¹è±¡ï¼›è€ŒIoCæ˜¯æœ‰ä¸“é—¨ä¸€ä¸ªå®¹å™¨æ¥åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œå³ç”±Iocå®¹å™¨æ¥æ§åˆ¶å¯¹ è±¡çš„åˆ›å»ºï¼›<strong>è°æ§åˆ¶è°ï¼Ÿå½“ç„¶æ˜¯IoC å®¹å™¨æ§åˆ¶äº†å¯¹è±¡ï¼›æ§åˆ¶ä»€ä¹ˆï¼Ÿé‚£å°±æ˜¯ä¸»è¦æ§åˆ¶äº†å¤–éƒ¨èµ„æºè·å–ï¼ˆä¸åªæ˜¯å¯¹è±¡åŒ…æ‹¬æ¯”å¦‚æ–‡ä»¶ç­‰ï¼‰ã€‚</strong></p><p> â— <strong>ä¸ºä½•æ˜¯åè½¬ï¼Œå“ªäº›æ–¹é¢åè½¬äº†ï¼š</strong>æœ‰åè½¬å°±æœ‰æ­£è½¬ï¼Œä¼ ç»Ÿåº”ç”¨ç¨‹åºæ˜¯ç”±æˆ‘ä»¬è‡ªå·±åœ¨å¯¹è±¡ä¸­ä¸»åŠ¨æ§åˆ¶å»ç›´æ¥è·å–ä¾èµ–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ­£è½¬ï¼›è€Œåè½¬åˆ™æ˜¯ç”±å®¹å™¨æ¥å¸®å¿™åˆ›å»ºåŠæ³¨å…¥ä¾èµ–å¯¹è±¡ï¼›ä¸ºä½•æ˜¯åè½¬ï¼Ÿ<strong>å› ä¸ºç”±å®¹å™¨å¸®æˆ‘ä»¬æŸ¥æ‰¾åŠæ³¨å…¥ä¾èµ–å¯¹è±¡ï¼Œå¯¹è±¡åªæ˜¯è¢«åŠ¨çš„æ¥å—ä¾èµ–å¯¹è±¡ï¼Œæ‰€ä»¥æ˜¯åè½¬ï¼›å“ªäº›æ–¹é¢åè½¬äº†ï¼Ÿä¾èµ–å¯¹è±¡çš„è·å–è¢«åè½¬äº†ã€‚</strong></p><p>ç”¨å›¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œä¼ ç»Ÿç¨‹åºè®¾è®¡å¦‚å›¾ï¼Œéƒ½æ˜¯ä¸»åŠ¨å»åˆ›å»ºç›¸å…³å¯¹è±¡ç„¶åå†ç»„åˆèµ·æ¥ï¼š</p><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image1.png" style="zoom: 80%;"><p>å½“æœ‰äº†IoCçš„å®¹å™¨åï¼Œåœ¨å®¢æˆ·ç«¯ç±»ä¸­ä¸å†ä¸»åŠ¨å»åˆ›å»ºè¿™äº›å¯¹è±¡äº†ï¼Œå¦‚å›¾æ‰€ç¤º:</p><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image2.png" style="zoom: 80%;"><h3 id="1-2-IOCèƒ½åšä»€ä¹ˆ"><a href="#1-2-IOCèƒ½åšä»€ä¹ˆ" class="headerlink" title="1.2 IOCèƒ½åšä»€ä¹ˆ"></a>1.2 IOCèƒ½åšä»€ä¹ˆ</h3><p>IoC ä¸æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œåªæ˜¯ä¸€ç§æ€æƒ³ï¼Œä¸€ä¸ªé‡è¦çš„é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ³•åˆ™ï¼Œå®ƒèƒ½æŒ‡å¯¼æˆ‘ä»¬å¦‚ä½•è®¾è®¡å‡ºæ¾è€¦åˆã€æ›´ä¼˜è‰¯çš„ç¨‹åºã€‚ä¼ ç»Ÿåº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±æˆ‘ä»¬åœ¨ç±»å†…éƒ¨ä¸»åŠ¨åˆ›å»ºä¾èµ–å¯¹è±¡ï¼Œä»è€Œå¯¼è‡´ç±»ä¸ç±»ä¹‹é—´é«˜è€¦åˆï¼Œéš¾äºæµ‹è¯•ï¼›æœ‰äº†IoCå®¹å™¨åï¼ŒæŠŠåˆ›å»ºå’ŒæŸ¥æ‰¾ä¾èµ–å¯¹è±¡çš„æ§åˆ¶æƒäº¤ç»™äº†å®¹å™¨ï¼Œç”±å®¹å™¨è¿›è¡Œæ³¨å…¥ç»„åˆå¯¹è±¡ï¼Œæ‰€ä»¥å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´æ˜¯ æ¾æ•£è€¦åˆï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿æµ‹è¯•ï¼Œåˆ©äºåŠŸèƒ½å¤ç”¨ï¼Œæ›´é‡è¦çš„æ˜¯ä½¿å¾—ç¨‹åºçš„æ•´ä¸ªä½“ç³»ç»“æ„å˜å¾—éå¸¸çµæ´»ã€‚</p><p> å…¶å®<strong>IoCå¯¹ç¼–ç¨‹å¸¦æ¥çš„æœ€å¤§æ”¹å˜ä¸æ˜¯ä»ä»£ç ä¸Šï¼Œè€Œæ˜¯ä»æ€æƒ³ä¸Šï¼Œå‘ç”Ÿäº†â€œä¸»ä»æ¢ä½â€çš„å˜åŒ–ã€‚åº”ç”¨ç¨‹åºåŸæœ¬æ˜¯è€å¤§ï¼Œè¦è·å–ä»€ä¹ˆèµ„æºéƒ½æ˜¯ä¸»åŠ¨å‡ºå‡»ï¼Œä½†æ˜¯åœ¨IoC&#x2F;DIæ€æƒ³ä¸­ï¼Œåº”ç”¨ç¨‹åºå°±å˜æˆè¢«åŠ¨çš„äº†ï¼Œè¢«åŠ¨çš„ç­‰å¾…IoCå®¹å™¨æ¥åˆ›å»ºå¹¶æ³¨å…¥å®ƒæ‰€éœ€è¦çš„èµ„æºäº†ã€‚</strong></p><p>IOCå¾ˆå¥½çš„ä½“ç°äº†é¢å‘å¯¹è±¡è®¾è®¡æ³•åˆ™ä¹‹ä¸€â€”â€” å¥½è±åæ³•åˆ™ï¼šâ€œåˆ«æ‰¾æˆ‘ä»¬ï¼Œæˆ‘ä»¬æ‰¾ä½ â€ï¼›å³ç”±IoCå®¹å™¨å¸®å¯¹è±¡æ‰¾ç›¸åº”çš„ä¾èµ–å¯¹è±¡å¹¶æ³¨å…¥ï¼Œè€Œä¸æ˜¯ç”±å¯¹è±¡ä¸»åŠ¨å»æ‰¾ã€‚</p><h3 id="1-3-SpringIOCåˆ›å»ºå®¹å™¨"><a href="#1-3-SpringIOCåˆ›å»ºå®¹å™¨" class="headerlink" title="1.3 SpringIOCåˆ›å»ºå®¹å™¨"></a>1.3 SpringIOCåˆ›å»ºå®¹å™¨</h3><h4 id="1-3-1-åŸç”Ÿè€¦åˆæ–¹å¼"><a href="#1-3-1-åŸç”Ÿè€¦åˆæ–¹å¼" class="headerlink" title="1.3.1 åŸç”Ÿè€¦åˆæ–¹å¼"></a>1.3.1 åŸç”Ÿè€¦åˆæ–¹å¼</h4><ol><li>åˆ›å»ºæ¥å£Animal</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºå…·ä½“å®ç°ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æˆ‘æ˜¯ä¸€åªå°çŒ«å’ªï¼&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æˆ‘æ˜¯ä¸€åªå°ç‹—ç‹—ï¼&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>åˆ›å»ºServiceå±‚ï¼Œéœ€è¦è°ƒç”¨daoå±‚çš„æ•°æ®</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Animal</span> <span class="hljs-variable">animal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span> &#123;<br>        animal.info();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>æµ‹è¯•ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        userService.getInfo();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image3.png" style="zoom: 80%;"><p>åˆ†æï¼šå‡è®¾æµ‹è¯•ç±»æ˜¯æˆ‘ä»¬ç›®å‰çš„ç”¨æˆ·ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¾—åˆ°çŒ«çš„ä¿¡æ¯ï¼Œéœ€è¦å»Serviceå±‚åˆ›å»ºä¸€ä¸ªçŒ«çš„å®ä¾‹å‡ºæ¥ï¼›å¦‚æœæˆ‘ä»¬éœ€è¦å¾—åˆ°ç‹—çš„ä¿¡æ¯ï¼Œéœ€è¦å»Serviceå±‚åˆ›å»ºä¸€ä¸ªç‹—çš„å®ä¾‹å‡ºæ¥ï¼è¿™æ ·ä»£ç è€¦åˆæ€§å¤ªé«˜ï¼Œç”¨æˆ·çš„éœ€æ±‚è¢«è€¦åˆåœ¨æºç ä¸­ï¼</p><h4 id="1-3-2-SpringIOCåˆ›å»ºå®¹å™¨"><a href="#1-3-2-SpringIOCåˆ›å»ºå®¹å™¨" class="headerlink" title="1.3.2 SpringIOCåˆ›å»ºå®¹å™¨"></a>1.3.2 SpringIOCåˆ›å»ºå®¹å™¨</h4><ol><li>åŸæ¥çš„å®ç°ç±»ä¸­æ„å»ºsetæ–¹æ³•ï¼</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span>&#123;<br><br>    <span class="hljs-keyword">private</span> Animal animal;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAnimal</span><span class="hljs-params">(Animal animal)</span> &#123;<br>        <span class="hljs-built_in">this</span>.animal = animal;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span> &#123;<br>        animal.info();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºbeanå®¹å™¨ç®¡ç†æ–‡ä»¶<code>beans.xml</code></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.amx.dao.Cat&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.amx.dao.Dog&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userservice&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.amx.service.UserServiceImpl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;animal&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;cat&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è¿›å…¥æµ‹è¯•</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       <span class="hljs-comment">// é€šè¿‡ç±»è·¯å¾„è·å–beanså®¹å™¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒcontext</span><br>       <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>       <span class="hljs-comment">// è·å–beanså®¹å™¨ä¸­çš„userserviceå¯¹è±¡</span><br>       <span class="hljs-type">UserService</span> <span class="hljs-variable">userservice</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userservice&quot;</span>);<br>       userservice.getInfo();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦è·å–Catçš„ä¿¡æ¯ï¼Œåªè¦ç”¨æˆ·å»beans.xmlæ–‡ä»¶ä¸­ä¿®æ”¹ä¸€ä¸‹å³å¯ï¼å¦‚æœæˆ‘ä»¬æƒ³è¦è¿‡å»Dogçš„ä¿¡æ¯ï¼Œåªè¦ç”¨æˆ·å»beans.xmlæ–‡ä»¶ä¸­ä¿®æ”¹ä¸ºdogå°±è¡Œäº†ï¼æ‰€æœ‰çš„ä¸»åŠ¨æƒäº¤ç»™äº†ç”¨æˆ·æ‰‹ä¸­ï¼éœ€è¦ä»€ä¹ˆæˆ‘ä»¬å»å®¹å™¨ä¸­æ‹¿å°±è¡Œäº†~</p><h3 id="1-4-IOCå®¹å™¨ã€æ§åˆ¶åè½¬ã€ä¾èµ–æ³¨å…¥"><a href="#1-4-IOCå®¹å™¨ã€æ§åˆ¶åè½¬ã€ä¾èµ–æ³¨å…¥" class="headerlink" title="1.4 IOCå®¹å™¨ã€æ§åˆ¶åè½¬ã€ä¾èµ–æ³¨å…¥"></a>1.4 IOCå®¹å™¨ã€æ§åˆ¶åè½¬ã€ä¾èµ–æ³¨å…¥</h3><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image-20230531000336367.png" alt="image-20230531000336367" style="zoom:80%;"><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image-20230531000351949.png" alt="image-20230531000351949" style="zoom:80%;"><img src="/2023/05/30/%E5%AE%89%E5%8D%93%E4%B8%AD%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%ACIOC/image-20230531000408614.png" alt="image-20230531000408614" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨</title>
    <link href="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/"/>
    <url>/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨"><a href="#å®‰å“å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨" class="headerlink" title="å®‰å“å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨"></a>å®‰å“å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨</h1><blockquote><p>å£°æ˜ï¼šä»¥ä¸‹å†…å®¹æ‘˜å½•è‡ªå„å¤§ç¥çš„åšå®¢ï¼Œç”¨äºè‡ªå·±å­¦ä¹ å¤‡å¿˜ï¼Œååˆ†æ„Ÿæ¿€ï¼</p><ul><li><a href="https://www.jianshu.com/p/a39bc4b3a1a6">https://www.jianshu.com/p/a39bc4b3a1a6</a></li></ul></blockquote><h2 id="1-å†…éƒ¨å­˜å‚¨"><a href="#1-å†…éƒ¨å­˜å‚¨" class="headerlink" title="1.å†…éƒ¨å­˜å‚¨"></a>1.å†…éƒ¨å­˜å‚¨</h2><p>å†…éƒ¨å­˜å‚¨ï¼Œå…¶å®æ˜¯æ‰‹æœºROMä¸Šçš„ä¸€å—å­˜å‚¨åŒºåŸŸï¼Œä¸»è¦ç”¨äºå­˜å‚¨ç³»ç»Ÿä»¥åŠåº”ç”¨ç¨‹åºçš„æ•°æ®ã€‚å†…éƒ¨å­˜å‚¨åœ¨Androidç³»ç»Ÿå¯¹åº”çš„æ ¹ç›®å½•æ˜¯ &#x2F;data&#x2F;data&#x2F;ï¼Œè¿™ä¸ªç›®å½•æ™®é€šç”¨æˆ·æ˜¯æ— æƒè®¿é—®çš„ï¼Œç”¨æˆ·éœ€è¦rootæƒé™æ‰å¯ä»¥æŸ¥çœ‹ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡Android Studioçš„Viewâ€”-Tool Windowsâ€”-Device File Explorerå·¥å…·æ¥æŸ¥çœ‹è¯¥ç›®å½•ï¼Œå†…éƒ¨å­˜å‚¨ç›®å½•çš„å¤§è‡´ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/webp.webp" alt="img" style="zoom: 80%;"><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œ&#x2F;data&#x2F;dataç›®å½•æ˜¯æŒ‰ç…§åº”ç”¨çš„åŒ…åæ¥ç»„ç»‡çš„ï¼Œæ¯ä¸ªåº”ç”¨éƒ½æ˜¯å±äºè‡ªå·±çš„å†…éƒ¨å­˜å‚¨ç›®å½•ï¼Œè€Œä¸”ç›®å½•çš„åç§°å°±æ˜¯è¯¥åº”ç”¨çš„åŒ…åï¼Œè¿™ä¸ªç›®å½•æ˜¯åœ¨å®‰è£…åº”ç”¨çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå½“åº”ç”¨è¢«å¸è½½åï¼Œè¯¥ç›®å½•ä¹Ÿä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨åˆ é™¤ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ å°†æ•°æ®å­˜å‚¨äºå†…éƒ¨å­˜å‚¨ä¸­ï¼Œå…¶å®å°±æ˜¯æŠŠæ•°æ®å­˜å‚¨åˆ°è‡ªå·±åº”ç”¨åŒ…åå¯¹åº”çš„å†…éƒ¨å­˜å‚¨ç›®å½•ä¸­ã€‚æ¯ä¸ªåº”ç”¨çš„å†…éƒ¨å­˜å‚¨ç›®å½•éƒ½æ˜¯ç§æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å†…éƒ¨å­˜å‚¨ç›®å½•ä¸‹çš„æ–‡ä»¶åªèƒ½è¢«åº”ç”¨è‡ªå·±è®¿é—®åˆ°ï¼Œå…¶ä»–åº”ç”¨æ˜¯æ²¡æœ‰æƒé™è®¿é—®çš„ã€‚åº”ç”¨è®¿é—®è‡ªå·±çš„å†…éƒ¨å­˜å‚¨ç›®å½•æ—¶ä¸éœ€è¦ç”³è¯·ä»»ä½•æƒé™ã€‚</p><p>ä¸€ä¸ªåº”ç”¨å…¸å‹çš„å†…éƒ¨å­˜å‚¨ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/webp-1685371597396-3.webp" alt="img" style="zoom:80%;"><p>ç›¸ä¿¡å¾ˆå¤šäººçœ‹åˆ°å†…éƒ¨å­˜å‚¨çš„ç›®å½•ç»“æ„ï¼Œéƒ½æœ‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œæ²¡é”™æˆ‘ä»¬å¹³å¸¸ç»å¸¸å’Œå†…éƒ¨å­˜å‚¨æ‰“äº¤é“ï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸çŸ¥é“ç½¢äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹å†…éƒ¨å­˜å‚¨ç›®å½•ä¸‹å„ä¸ªå­ç›®å½•çš„ä½œç”¨ã€‚</p><ul><li><strong>app_webview</strong>ï¼šä¸»è¦ç”¨äºå­˜å‚¨webviewåŠ è½½è¿‡ç¨‹ä¸­çš„æ•°æ®ï¼Œä¾‹å¦‚Cookieï¼ŒLocalStorageç­‰ã€‚</li><li><strong>cache</strong>ï¼šä¸»è¦ç”¨äºå­˜å‚¨ä½¿ç”¨åº”ç”¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ®ã€‚</li><li><strong>databases</strong>ï¼šä¸»è¦ç”¨äºå­˜å‚¨æ•°æ®åº“ç±»å‹çš„æ•°æ®ã€‚æˆ‘ä»¬å¹³å¸¸åˆ›å»ºçš„æ•°æ®åº“æ–‡ä»¶å°±æ˜¯å­˜å‚¨åœ¨è¿™é‡Œã€‚</li><li><strong>files</strong>ï¼šå¯ä»¥åœ¨è¯¥ç›®å½•ä¸‹å­˜å‚¨é…ç½®æ–‡ä»¶ï¼Œæ•æ„Ÿæ•°æ®ç­‰ã€‚</li><li><strong>shared_prefs</strong>ï¼šç”¨äºå­˜å‚¨SharedPreferenceæ–‡ä»¶ã€‚æˆ‘ä»¬ä½¿ç”¨SharedPreferenceçš„æ—¶å€™åªæŒ‡å®šäº†æ–‡ä»¶åï¼Œå¹¶æ²¡æœ‰æŒ‡å®šå­˜å‚¨è·¯å¾„ï¼Œå…¶å®SPçš„æ–‡ä»¶å°±æ˜¯ä¿å­˜åˆ°äº†è¿™ä¸ªç›®å½•ä¸‹ã€‚</li></ul><p>é‚£ä¹ˆæœ‰å“ªäº›APIå¯ä»¥è·å–åˆ°å†…éƒ¨å­˜å‚¨ç›®å½•å‘¢ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯ä½¿ç”¨Contextç±»æä¾›çš„æ¥å£æ¥è®¿é—®å†…éƒ¨å­˜å‚¨ç›®å½•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>getDataDir()  <span class="hljs-comment">//è·å–çš„ç›®å½•æ˜¯/data/user/0/package_nameï¼Œå³åº”ç”¨å†…éƒ¨å­˜å‚¨çš„æ ¹ç›®å½•</span><br><span class="hljs-number">2.</span>getFilesDir() <span class="hljs-comment">//è·å–çš„ç›®å½•æ˜¯/data/user/0/package_name/filesï¼Œå³åº”ç”¨å†…éƒ¨å­˜å‚¨çš„filesç›®å½•</span><br><span class="hljs-number">3.</span>getCacheDir() <span class="hljs-comment">//è·å–çš„ç›®å½•æ˜¯/data/user/0/package_name/cacheï¼Œå³åº”ç”¨å†…éƒ¨å­˜å‚¨çš„cacheç›®å½•</span><br><span class="hljs-number">4.</span>getDir(String name, <span class="hljs-type">int</span> mode) <span class="hljs-comment">//è·å–çš„ç›®å½•æ˜¯/data/user/0/package_name/app_nameï¼Œå¦‚æœè¯¥ç›®å½•ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç›®å½•ã€‚</span><br></code></pre></td></tr></table></figure><p>è·å–åˆ°å¯¹åº”çš„ç›®å½•åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ç›®å½•ä¸‹çš„æ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šå‘ç°ä»£ç ä¸­è·å–çš„å†…éƒ¨å­˜å‚¨æ ¹ç›®å½•æ˜¯ &#x2F;data&#x2F;user&#x2F;0ï¼Œå¹¶ä¸æ˜¯å‰é¢æåˆ°çš„&#x2F;data&#x2F;dataï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå› ä¸ºåœ¨Android4.2ä»¥åå¢åŠ äº†å¤šç”¨æˆ·çš„åŠŸèƒ½ï¼Œä¸ºäº†é€‚åº”å¤šç”¨æˆ·çš„åŠŸèƒ½ï¼ŒåŸæ¥çš„&#x2F;data&#x2F;data&#x2F;ç›¸å½“äºç›´æ¥é“¾æ¥åˆ°å½“å‰ç”¨æˆ·æ–‡ä»¶å¤¹çš„ï¼Œå˜æˆäº†&#x2F;data&#x2F;user&#x2F;0&#x2F;ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»£ç ä¸­æ‰“å°å‡ºæ¥çš„è·¯å¾„æ˜¯&#x2F;data&#x2F;user&#x2F;0ï¼Œè€Œä¸æ˜¯&#x2F;data&#x2F;dataï¼Œ<strong>è¯´ç™½äº†&#x2F;data&#x2F;dataå’Œ&#x2F;data&#x2F;user&#x2F;0&#x2F;æ˜¯ä¸€ä¸ªä¸œè¥¿</strong>ã€‚</p><p>å†…éƒ¨å­˜å‚¨ç©ºé—´å®¹é‡æœ‰é™ï¼Œå¦‚æœå†…éƒ¨å­˜å‚¨ç©ºé—´è¢«ç”¨å®Œï¼Œç³»ç»Ÿä¼šæŠ¥å†…å­˜ä¸è¶³ã€‚æ‰€ä»¥ï¼Œä¸è¦æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾åˆ°å†…éƒ¨å­˜å‚¨ä¸­ã€‚åœ¨å¼€å‘åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¾ƒæ•æ„Ÿçš„åº”ç”¨æ•°æ®æ”¾åœ¨å†…éƒ¨å­˜å‚¨ä¸­ï¼Œè€Œå…¶ä»–çš„æ•°æ®å¯ä»¥æ”¾åœ¨å¤–éƒ¨å­˜å‚¨ä¸­ã€‚é‚£å¤–éƒ¨å­˜å‚¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥ç€æ¥å­¦ä¹ å¤–éƒ¨å­˜å‚¨ã€‚</p><h2 id="2-å¤–éƒ¨å­˜å‚¨"><a href="#2-å¤–éƒ¨å­˜å‚¨" class="headerlink" title="2.å¤–éƒ¨å­˜å‚¨"></a>2.å¤–éƒ¨å­˜å‚¨</h2><p>æˆ‘ä»¬çŸ¥é“å†…éƒ¨å­˜å‚¨ä¸­çš„æ•°æ®å¯¹åº”ç”¨æ¥è¯´æ˜¯ç§å¯†çš„ï¼Œç”¨æˆ·å’Œå…¶ä»–åº”ç”¨éƒ½æ²¡æœ‰è®¿é—®æƒé™ï¼Œè€Œå¤–éƒ¨å­˜å‚¨ä¸­çš„æ•°æ®æ˜¯å¯ä»¥è¢«å…¶ä»–åº”ç”¨æˆ–ç”¨æˆ·è®¿é—®ç”šè‡³åˆ é™¤çš„ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡USBæ–¹å¼å’ŒPCä¹‹é—´äº¤äº’å¤–éƒ¨å­˜å‚¨ä¸­çš„æ•°æ®ã€‚æˆ‘ä»¬å¹³å¸¸åœ¨Androidæ‰‹æœºçš„æ–‡ä»¶ç®¡ç†å·¥å…·ä¸‹çœ‹åˆ°çš„ç›®å½•å…¶å®å°±æ˜¯å¤–éƒ¨å­˜å‚¨ã€‚åœ¨Android4.4ä»¥å‰ï¼Œå¤–éƒ¨å­˜å‚¨å°±æ˜¯æŒ‡SDå¡ï¼Œæ‰‹æœºè‡ªå¸¦çš„å­˜å‚¨å°±æ˜¯å†…éƒ¨å­˜å‚¨ï¼›ä½†æ˜¯åœ¨Android4.4ä»¥åï¼Œéšç€æ‰‹æœºæœºèº«å­˜å‚¨è¶Šæ¥è¶Šå¤§ï¼Œæ‰‹æœºçš„æœºèº«å­˜å‚¨å·²ç»å¯ä»¥æ»¡è¶³å¤§å¤šæ•°ç”¨æˆ·çš„éœ€æ±‚ï¼Œæ‰€ä»¥å¾ˆå¤šæ‰‹æœºéƒ½ä¸éœ€è¦å†å®‰è£…SDå¡ã€‚æ­¤æ—¶å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨éƒ½ä½äºæ‰‹æœºæœºèº«å­˜å‚¨ä¸Šï¼Œä»–ä»¬åªæ˜¯åŒä¸€ä¸ªå­˜å‚¨ä»‹è´¨ä¸Šçš„ä¸åŒå­˜å‚¨åŒºåŸŸã€‚ä½†æ˜¯å¾ˆå¤šæ‰‹æœºè¿˜æ˜¯ä¿ç•™äº†SDå¡æ’æ§½ï¼Œæ–¹ä¾¿ç”¨æˆ·è‡ªè¡Œæ‹“å±•ã€‚å¦‚æœæ‰‹æœºå®‰è£…äº†SDå¡ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶SDå¡ç›®å½•ä¹Ÿå±äºå¤–éƒ¨å­˜å‚¨ç›®å½•ã€‚è¿™æ—¶æ‰‹æœºéƒ½æœ‰äº†ä¸¤ä¸ªå¤–éƒ¨å­˜å‚¨ç©ºé—´ï¼Œä¸€ä¸ªä½äºæ‰‹æœºæœºèº«å­˜å‚¨ä¸Šï¼Œä¸€ä¸ªä½äºSDå¡ä¸Šã€‚ä½†æ˜¯éšç€æœºèº«å­˜å‚¨è¶Šç´¯è¶Šå¤§ï¼ŒSDå¡ä¸€èˆ¬å¯èƒ½åªé€‚ç”¨äºè½¬ç§»æ–‡ä»¶ï¼Œå¯¹äºä¸€èˆ¬åº”ç”¨æ¥è¯´åº”è¯¥ä¹Ÿä¸ä¼šæŠŠæ•°æ®å†™åˆ°å¤–ç½®çš„SDå¡ä¸Šäº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦ä»¥æœºèº«å­˜å‚¨ä¸ºä¾‹æ¥åˆ†æå¤–éƒ¨å­˜å‚¨ã€‚</p><h3 id="2-1-å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•"><a href="#2-1-å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•" class="headerlink" title="2.1 å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•"></a>2.1 å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•</h3><p>é€šå¸¸æ¥è¯´ï¼Œåº”ç”¨æ¶‰åŠåˆ°çš„æŒä¹…åŒ–æ•°æ®ä¸€èˆ¬åˆ†ä¸ºä¸¤ç±»ï¼šåº”ç”¨ç›¸å…³æ•°æ®å’Œåº”ç”¨æ— å…³æ•°æ®ã€‚å‰è€…æ˜¯æŒ‡åº”ç”¨ä½¿ç”¨çš„æ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œè°ƒè¯•ä¿¡æ¯ï¼Œç¼“å­˜æ–‡ä»¶ç­‰ã€‚å½“åº”ç”¨è¢«å¸è½½ï¼Œè¿™äº›ä¿¡æ¯ä¹Ÿåº”è¯¥è¢«éšä¹‹åˆ é™¤ï¼Œé¿å…å ç”¨ä¸å¿…è¦çš„å­˜å‚¨ç©ºé—´ã€‚ä¾‹å¦‚ä¸‹é¢ä¸¤ç§åœºæ™¯ã€‚</p><ul><li>åœ¨ç”¨æˆ·ä½¿ç”¨åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿçš„æ–‡ä»¶ï¼Œå›¾ç‰‡ï¼Œè§†é¢‘ï¼ŒéŸ³é¢‘ç­‰æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¸å¤ªæ•æ„Ÿä½†æ˜¯å ç”¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œå¸è½½Appæ—¶ä¸å¸Œæœ›è¿™äº›æ•°æ®ç»§ç»­ä¿ç•™åœ¨ç”¨æˆ·æ‰‹æœºä¸­ã€‚</li><li>å½“åº”ç”¨å‘ç”Ÿé—ªé€€æ—¶ï¼Œå¸Œæœ›æŠŠä¸€äº›é—ªé€€ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œè®©ç”¨æˆ·è·å–é—ªé€€ä¿¡æ¯æ–‡ä»¶åé€šè¿‡ç‰¹å®šæ¸ é“å‘é€ç»™å¼€å‘äººå‘˜è¿›è¡Œé—®é¢˜å®šä½ã€‚åŒæ ·çš„ï¼Œè¿™äº›ä¿¡æ¯åœ¨å¸è½½Appåä¹Ÿä¸å¸Œæœ›ç»§ç»­ç•™åœ¨ç”¨æˆ·æ‰‹æœºä¸­ã€‚</li></ul><p>å¯¹äºé—®é¢˜ä¸€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠæ•°æ®å­˜å‚¨åœ¨å†…éƒ¨å­˜å‚¨ä¸­ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å†…éƒ¨å­˜å‚¨ç©ºé—´æœ‰é™ï¼ŒæŠŠè¿™äº›æ•°æ®å­˜å‚¨åˆ°å†…éƒ¨å­˜å‚¨ä¼šæµªè´¹å†…éƒ¨å­˜å‚¨çš„ç©ºé—´ã€‚å¯¹äºé—®é¢˜äºŒï¼Œæ™®é€šç”¨æˆ·ï¼ˆæŒ‡æ²¡æœ‰rootæƒé™çš„ç”¨æˆ·ï¼‰æ— æ³•ç›´æ¥æŸ¥çœ‹å…¶ä¸­çš„æ–‡ä»¶ï¼ŒæŠŠæ•°æ®ç›´æ¥å­˜å‚¨åœ¨å†…éƒ¨å­˜å‚¨ä¸­æ˜¯è¡Œä¸é€šçš„ã€‚è¿™äº›æ•°æ®æœ‰ä¸€ä¸ªå…±åŒç‚¹å°±æ˜¯ä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨æ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸”ä¸å¤ªé€‚åˆäºæ”¾åœ¨å†…éƒ¨å­˜å‚¨ä¸­ã€‚ä¸ºäº†å­˜å‚¨è¿™ç§ç±»å‹çš„æ•°æ®ï¼ŒAndroidè§„å®šæ¥ä¸€ä¸ªä¸“é—¨çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™ä¸ªç©ºé—´è¢«ç§°ä¸ºå¤–éƒ¨ç§æœ‰å­˜å‚¨ç©ºé—´ã€‚å¤–éƒ¨ç§æœ‰å­˜å‚¨ç©ºé—´å±äºå¤–éƒ¨å­˜å‚¨ï¼Œå¯¹äºæŸä¸ªåº”ç”¨æ¥è¯´ï¼Œå¤–éƒ¨ç§æœ‰å­˜å‚¨çš„æ ¹ç›®å½•ï¼ˆè¿™é‡Œæš‚æ—¶ä¸è€ƒè™‘SDå¡ï¼‰æ˜¯ &#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;package_nameï¼Œè¿™ä¸ªç›®å½•æœ‰ç‚¹ç±»ä¼¼äºå†…éƒ¨å­˜å‚¨ç›®å½•ï¼Œéƒ½æ˜¯ä»¥åŒ…åæ¥å‘½åç§æœ‰å­˜å‚¨ç©ºé—´çš„ã€‚å¤–éƒ¨ç§æœ‰å­˜å‚¨ç©ºé—´æœ‰ä»¥ä¸‹ç‰¹ç‚¹</p><ul><li>å†…éƒ¨ç§æœ‰å­˜å‚¨ä¸­çš„æ•°æ®ä¼šéšç€Appçš„å¸è½½ä¸€èµ·åˆ é™¤</li><li>ä»…ä»…å®‰è£…åº”ç”¨ä¸ä¼šåœ¨&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;ç›®å½•ä¸‹ç”Ÿæˆè¯¥åº”ç”¨çš„å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•ï¼Œåªæœ‰åœ¨åº”ç”¨ä¸­è°ƒç”¨APIè®¿é—®å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•æ—¶ï¼Œæ‰ä¼šåˆ›å»ºä»¥package_nameå‘½åçš„ç§æœ‰å­˜å‚¨ç›®å½•ã€‚</li><li>Appåœ¨è®¿é—®è‡ªå·±çš„å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•æ—¶ä¸éœ€è¦ä»»ä½•æƒé™</li><li>è‡ª Android 7.0 å¼€å§‹ï¼Œç³»ç»Ÿå¯¹å¤–éƒ¨å­˜å‚¨ç›®å½•ä¸­ åº”ç”¨ç§æœ‰ç›®å½•çš„è®¿é—®æƒé™è¿›ä¸€æ­¥é™åˆ¶ã€‚å…¶ä»– App æ— æ³•é€šè¿‡ file:&#x2F;&#x2F; è¿™ç§å½¢å¼çš„ Uri ç›´æ¥è¯»å†™å…¶ä»–åº”ç”¨çš„å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡ FileProvider è®¿é—®</li></ul><p>åœ¨ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>getExternalCacheDir() <br><span class="hljs-comment">/*è·å–åˆ°çš„ç›®å½•æ˜¯/storage/emulated/0/Android/data/package_name/cacheï¼Œå¦‚æœè¯¥ç›®å½•ä¸å­˜åœ¨ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç›®å½•ã€‚*/</span><br><span class="hljs-number">2.</span>getExternalFilesDir(String type) <br><span class="hljs-comment">/* 1.å¦‚æœtypeä¸º&quot;&quot;ï¼Œé‚£ä¹ˆè·å–åˆ°çš„ç›®å½•æ˜¯ /storage/emulated/0/Android/data/package_name/files</span><br><span class="hljs-comment">   2.å¦‚æœtypeä¸ä¸ºç©ºï¼Œåˆ™ä¼šåœ¨/storage/emulated/0/Android/data/package_name/filesç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥ä¼ å…¥çš„typeå€¼ä¸ºåç§°çš„ç›®å½•ï¼Œä¾‹å¦‚ä½ å°†typeè®¾ä¸ºäº†testï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»º/storage/emulated/0/Android/data/package_name/files/testç›®å½•ï¼Œè¿™ä¸ªå…¶å®æœ‰ç‚¹ç±»ä¼¼äºå†…éƒ¨å­˜å‚¨getDiræ–¹æ³•ä¼ å…¥çš„nameå‚æ•°ã€‚ä½†æ˜¯androidå®˜æ–¹æ¨èä½¿ç”¨ä»¥ä¸‹çš„typeç±»å‹</span><br><span class="hljs-comment">   public static String DIRECTORY_MUSIC = &quot;Music&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_PODCASTS = &quot;Podcasts&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_RINGTONES = &quot;Ringtones&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_ALARMS = &quot;Alarms&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_NOTIFICATIONS = &quot;Notifications&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_PICTURES = &quot;Pictures&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_MOVIES = &quot;Movies&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DOWNLOADS = &quot;Download&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DCIM = &quot;DCIM&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DOCUMENTS = &quot;Documents&quot;;*/</span><br></code></pre></td></tr></table></figure><h3 id="2-2-å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•"><a href="#2-2-å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•" class="headerlink" title="2.2 å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•"></a>2.2 å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•</h3><p>å¤–éƒ¨å­˜å‚¨ç›®å½•è¿˜æœ‰ä¸€ä¸ªå­˜å‚¨ç©ºé—´å°±æ˜¯å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•ï¼Œé¡¾åæ€ä¹‰ï¼Œå¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•å­˜å‚¨çš„æ•°æ®æ— è®ºå¯¹åº”ç”¨è¿˜æ˜¯ç”¨æˆ·éƒ½æ˜¯å¯è§çš„åº”ç”¨åªè¦æœ‰å¤–éƒ¨è®¿é—®æƒé™ï¼Œå°±å¯ä»¥è¯»å–å¤–éƒ¨å…¬å…±ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚å¤–éƒ¨å…¬å…±ç›®å½•ä¸»è¦å­˜æ”¾å’Œåº”ç”¨æ— å…³çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®åœ¨å¸è½½Appçš„æ—¶å€™ä¸ä¼šè¢«åˆ é™¤ã€‚å¤–éƒ¨å…±æœ‰å­˜å‚¨ç›®å½•æœ‰ä»¥ä¸‹ç‰¹ç‚¹ã€‚</p><ul><li>å½“å¸è½½Appæ—¶ï¼Œå…±æœ‰å­˜å‚¨ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤</li><li>åº”ç”¨åœ¨è®¿é—®å¤–éƒ¨å…¬æœ‰ç›®å½•ä¹‹å‰ï¼Œé¦–å…ˆè¦ç”³è¯·å¤–éƒ¨å­˜å‚¨æƒé™ï¼Œåœ¨Android6.0ä»¥åï¼Œå¤–éƒ¨å­˜å‚¨æƒé™è¿˜è¦åŠ¨æ€ç”³è¯·ã€‚</li><li>ä»»ä½•åº”ç”¨åªè¦æœ‰å¤–éƒ¨å­˜å‚¨æƒé™ï¼Œéƒ½å¯ä»¥è®¿é—®å…±æœ‰å­˜å‚¨ç›®å½•ä¸‹çš„æ•°æ®ã€‚</li></ul><p>åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è®¿é—®å¤–éƒ¨å…¬å…±å­˜å‚¨ç›®å½•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>Environment.getExternalStorageDirectory() <br><span class="hljs-comment">//è·å–åˆ°çš„ç›®å½•æ˜¯/storage/emulated/0,è¿™ä¸ªä¹Ÿæ˜¯å¤–éƒ¨å­˜å‚¨çš„æ ¹ç›®å½•ã€‚</span><br><span class="hljs-number">2.</span>Environment.getExternalStoragePublicDirectory(String type) <br><span class="hljs-comment">/* 1.å¦‚æœtypeä¸º&quot;&quot;ï¼Œé‚£ä¹ˆè·å–åˆ°çš„ç›®å½•æ˜¯å¤–éƒ¨å­˜å‚¨çš„æ ¹ç›®å½•å³  /storage/emulated/0</span><br><span class="hljs-comment">   2.å¦‚æœtypeä¸ä¸ºç©ºï¼Œåˆ™ä¼šåœ¨/storage/emulated/0ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥ä¼ å…¥çš„typeå€¼ä¸ºåç§°çš„ç›®å½•ï¼Œä¾‹å¦‚ä½ å°†typeè®¾ä¸ºäº†testï¼Œé‚£ä¹ˆå°±åœ¨å¤–éƒ¨å­˜å‚¨æ ¹ç›®å½•ä¸‹åˆ›å»ºtestç›®å½•ï¼Œè¿™ä¸ªæ–¹æ³•å’ŒgetExternalFilesDirçš„ç”¨æ³•ä¸€æ ·ã€‚androidå®˜æ–¹æ¨èä½¿ç”¨ä»¥ä¸‹çš„typeç±»å‹ï¼Œæˆ‘ä»¬åœ¨SKå¡çš„æ ¹ç›®å½•ä¸‹ä¹Ÿç»å¸¸å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æŸäº›ç›®å½•ã€‚</span><br><span class="hljs-comment">   public static String DIRECTORY_MUSIC = &quot;Music&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_PODCASTS = &quot;Podcasts&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_RINGTONES = &quot;Ringtones&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_ALARMS = &quot;Alarms&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_NOTIFICATIONS = &quot;Notifications&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_PICTURES = &quot;Pictures&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_MOVIES = &quot;Movies&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DOWNLOADS = &quot;Download&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DCIM = &quot;DCIM&quot;;</span><br><span class="hljs-comment">   public static String DIRECTORY_DOCUMENTS = &quot;Documents&quot;;*/</span><br></code></pre></td></tr></table></figure><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/v2-76c6e06d688756944ccba4a85236dd7b_r.jpg" alt="img" style="zoom:67%;"><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://zhuanlan.zhihu.com/p/165140637%EF%BC%8C%E4%BD%9C%E8%80%85%EF%BC%9A[Bgwan](https://www.zhihu.com/people/qydq)">https://zhuanlan.zhihu.com/p/165140637ï¼Œä½œè€…ï¼š[Bgwan](https://www.zhihu.com/people/qydq)</a></p></blockquote><h2 id="3-å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨å¯¹æ¯”"><a href="#3-å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨å¯¹æ¯”" class="headerlink" title="3.å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨å¯¹æ¯”"></a>3.å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨å¯¹æ¯”</h2><p>è¦åŒºåˆ†å¤–éƒ¨å­˜å‚¨å’Œå†…éƒ¨å­˜å‚¨ï¼Œæˆ‘ä»¬æœ€å¥½ä»é€»è¾‘ä¸Šæ¥ç†è§£è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œè€Œä¸æ˜¯ä»ç‰©ç†ä¸Šã€‚è™½ç„¶åœ¨Android4.4ä»¥å‰ï¼Œé€»è¾‘ä¸Šå’Œç‰©ç†ä¸Šæ˜¯ç»Ÿä¸€çš„ï¼Œä½†æ˜¯Android4.4ä»¥åï¼Œéšç€å¤–ç½®SDå¡çš„ä½¿ç”¨è¶Šæ¥è¶Šå°‘ï¼Œå†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨å’Œç‰©ç†ä»‹è´¨çš„å†…å¤–å°±æ²¡æœ‰ä»»ä½•å…³ç³»äº†ã€‚</p><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/webp-1685373896034-6.webp" alt="img" style="zoom:67%;"><h2 id="4-ç–‘æƒ‘è§£ç­”"><a href="#4-ç–‘æƒ‘è§£ç­”" class="headerlink" title="4.ç–‘æƒ‘è§£ç­”"></a>4.ç–‘æƒ‘è§£ç­”</h2><h3 id="4-1-å†…ç½®çš„å¤–éƒ¨å­˜å‚¨å’ŒSDå¡æœ‰å•¥åŒºåˆ«"><a href="#4-1-å†…ç½®çš„å¤–éƒ¨å­˜å‚¨å’ŒSDå¡æœ‰å•¥åŒºåˆ«" class="headerlink" title="4.1 å†…ç½®çš„å¤–éƒ¨å­˜å‚¨å’ŒSDå¡æœ‰å•¥åŒºåˆ«"></a>4.1 å†…ç½®çš„å¤–éƒ¨å­˜å‚¨å’ŒSDå¡æœ‰å•¥åŒºåˆ«</h3><p>åœ¨4.4ä»¥åçš„ç³»ç»Ÿä¸­ï¼ŒAPIæä¾›äº†è¿™æ ·ä¸€ä¸ªæ–¹æ³•æ¥éå†æ‰‹æœºçš„å¤–éƒ¨å­˜å‚¨è·¯å¾„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">File[] files;<br><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;<br>    files = getExternalFilesDirs(Environment.MEDIA_MOUNTED);<br>    <span class="hljs-keyword">for</span>(File file:files)&#123;<br>        Log.e(<span class="hljs-string">&quot;main&quot;</span>,file);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ çš„æ‰‹æœºæ’äº†SDå¡çš„è¯ï¼Œé‚£ä¹ˆå®ƒæ‰“å°çš„è·¯å¾„å°±æœ‰ä¸¤æ¡äº†ï¼Œä¾‹å¦‚æˆ‘çš„åä¸ºè£è€€7æ’äº†SDå¡ï¼Œå®ƒçš„ç»“æœå¦‚ä¸‹ï¼š</p><ul><li>&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;packname&#x2F;files&#x2F;mounted</li><li>&#x2F;storage&#x2F;B3E4-1711&#x2F;Android&#x2F;data&#x2F;packname&#x2F;files&#x2F;mounted</li></ul><p>å…¶ä¸­&#x2F;storage&#x2F;emulated&#x2F;0ç›®å½•å°±æ˜¯æœºèº«å­˜å‚¨çš„å¤–éƒ¨å­˜å‚¨è·¯å¾„ï¼Œè€Œ&#x2F;storage&#x2F;B3E4-1711&#x2F;å°±æ˜¯SDå¡çš„è·¯å¾„ï¼Œä»–ä»¬ç»Ÿç§°ä¸ºå¤–éƒ¨å­˜å‚¨</p><h3 id="4-2-ä¸»å­˜å‚¨æ˜¯ä»€ä¹ˆ"><a href="#4-2-ä¸»å­˜å‚¨æ˜¯ä»€ä¹ˆ" class="headerlink" title="4.2 ä¸»å­˜å‚¨æ˜¯ä»€ä¹ˆ"></a>4.2 ä¸»å­˜å‚¨æ˜¯ä»€ä¹ˆ</h3><blockquote><p>æ¥æºï¼š<a href="https://fqzhanghao.github.io/post/android-cun-chu-wa-keng-ji/">https://fqzhanghao.github.io/post/android-cun-chu-wa-keng-ji/</a></p></blockquote><p>è¿™ä¸ªPrimaryå’ŒSecondaryæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿå®é™…ä¸Šæœ€å¼€å§‹Androidä¹Ÿæ²¡æœ‰è€ƒè™‘è¿™ä¸ªåŒºåˆ†ï¼Œä½†æ˜¯åæ¥æœ‰ä¸€ä¸ªæƒ…å†µå‘ç”Ÿäº†ï¼Œå°±æ˜¯ä¸Šé¢æ‰€è¯´åˆ°çš„ï¼š</p><p>åæ¥éƒ¨åˆ†æ‰‹æœºå¼€å§‹å°†æœ€åˆå®šä¹‰çš„â€œInternal Storageâ€ï¼Œå³å†…ç½®å­˜å‚¨ï¼Œåˆ†æˆInternalå’ŒExternalä¸¤éƒ¨åˆ†ã€‚</p><p>é‚£ä¹ˆå¦‚æœè¿™ä¸ªæ—¶å€™æ‰‹æœºå†æ’å…¥sdå¡ï¼Œé‚£ä¸æ˜¯æœ‰å¤šä¸ªExternal Storageäº†å—ï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™ï¼Œ<strong>ä»Internal Storageé‡Œé¢åˆ†å‡ºæ¥çš„é‚£å—â€œExternal Storageâ€æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸»å­˜å‚¨(Primary Storage)ï¼Œæ’å…¥çš„å¤–ç½®å‚¨å­˜ç§°ä¹‹ä¸ºå‰¯å­˜å‚¨(Secondary Storage)ã€‚</strong></p><p>ä¸»å­˜å‚¨è·¯å¾„çš„è·å–æ–¹å¼éå¸¸ç®€å•ï¼Œå¯ä»¥é€šè¿‡Environment.getExternalStorageDirectory()æˆ–è€…Context.getExternalFilesDir(null)æ¥è·å–ã€‚</p><p>å‰¯å­˜å‚¨è·¯å¾„åœ¨4.4åŠä»¥ä¸Šçš„Androidç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨Context.getExternalFilesDirs(null)(æ³¨æ„æœ€åå¤šäº†ä¸€ä¸ªâ€™sâ€™)ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚ç¬¬0ä¸ªå°±æ˜¯ä¸»å­˜å‚¨è·¯å¾„ï¼Œç¬¬1ä¸ªæ˜¯å‰¯å­˜å‚¨è·¯å¾„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚ä»4.1ä¹Ÿå¯ä»¥è¯æ˜ï¼ï¼ï¼</p><h3 id="4-3-Adoptable-Storage"><a href="#4-3-Adoptable-Storage" class="headerlink" title="4.3 Adoptable Storage"></a>4.3 Adoptable Storage</h3><p>ç”±äºExternal Storageçš„ç¼ºç‚¹ï¼ˆæœ‰æ—¶ä¸å¯ç”¨ï¼Œå­˜å‚¨å†…å®¹æ²¡æœ‰è¢«ä¿æŠ¤ï¼‰ï¼Œåœ¨6.0ä¹‹åå¤šå‡ºäº†<code>Adoptable</code>å­˜å‚¨æ–¹å¼ã€‚</p><p>å½“Androidç³»ç»Ÿ<code>Adopt</code>äº†ä¸€å—Externalå­˜å‚¨åŒºåŸŸçš„æ—¶å€™ï¼Œå®ƒä¼šè¢«è§†ä¸ºInternal Storageï¼ŒåŒæ—¶ä¼šè¢«æ ¼å¼åŒ–ä¸åŠ å¯†ã€‚æ ¼å¼åŒ–ä¹‹åæ˜¯GPTåˆ†åŒºï¼Œå­˜å‚¨ä¸Šçº¿ä¸º9ZBã€‚</p><p>å½“ä½ åœ¨ä¸€ä¸ªæ”¯æŒ<code>Adoptable Storage</code>çš„æ‰‹æœºä¸Šæ’å…¥ä¸€ä¸ªsdå¡ï¼Œå®ƒä¼šæç¤ºä½ æ˜¯å¦å°†è¿™ä¸ªsdå¡æ ¼å¼åŒ–å¹¶ç”¨ä½œInternal Storageï¼Œæˆ–è€…æ­£å¸¸ä½œä¸ºExternal Storageä½¿ç”¨ã€‚</p><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/731da63df8dcd100f5e720dd758b4710b8122f29.jpg" alt="img" style="zoom:67%;"><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/d7e7c1dcd100baa19d579f474010b912c9fc2e29.jpg" alt="img" style="zoom:67%;"><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/f27bf411728b4710ea542530c4cec3fdfd032329.jpg" alt="img" style="zoom:67%;"><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/85cb4b8b4710b9129cba2e02c4fdfc0393452229.jpg" alt="img" style="zoom:67%;"><img src="/2023/05/29/%E5%AE%89%E5%8D%93%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E5%92%8C%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8/3a517e10b912c8fc96882e31fb039245d7882129.jpg" alt="img" style="zoom: 67%;"><h3 id="4-4-ç§æœ‰å·PrivateVolume"><a href="#4-4-ç§æœ‰å·PrivateVolume" class="headerlink" title="4.4 ç§æœ‰å·PrivateVolume"></a>4.4 ç§æœ‰å·PrivateVolume</h3><p><a href="https://blog.csdn.net/woai110120130/article/details/107701932">https://blog.csdn.net/woai110120130/article/details/107701932</a></p><p>PrivateVolumeåˆ†åŒºç”¨äºå°†å¤–ç½®å­˜å‚¨è½¬ä¸ºå†…ç½®å­˜å‚¨ä½¿ç”¨çš„ï¼Œå¹¶ä¸”PrivateVolumeæ˜¯ä½¿ç”¨å…¨ç›˜åŠ å¯†çš„ã€‚æ‰€ä»¥PrivateVolumeæ˜¯å’ŒAndroidè®¾å¤‡å¼ºç›¸å…³çš„ï¼ŒæŠŠåŒ…å«PrivateVolumeçš„ç£ç›˜ä»‹è´¨æ‹¿åˆ°å…¶ä»–æ‰‹æœºä¸Šæ˜¯æ— æ³•è§£å¯†æŒ‚è½½çš„ã€‚æ‰€ä»¥PrivateVolumeå¿…ç„¶æ˜¯åœ¨Androidè®¾å¤‡ä¸Šæ¥è¿›è¡Œæ ¼å¼åŒ–çš„ã€‚æ¯ä¸ªPrivateVolumeè¿˜å¯¹åº”ä¸€ä¸ªEmulatedVolumeåˆ†åŒºï¼Œè¿™ä¸ªEmulatedVolumeå¯ä»¥ä½œä¸ºä¸»åˆ†åŒºæŒ‚è½½ã€‚ <strong>å¯¹äº&#x2F;dataåˆ†åŒºçš„æŒ‚è½½ä¸ç”±VoldæœåŠ¡æ¥ç®¡ç†</strong>ï¼Œæ‰€ä»¥MountServiceä¼šä¸»åŠ¨æ·»åŠ ä¸€ä¸ªPrivateVolumeæ¥å¯¹åº”&#x2F;dataåˆ†åŒºï¼ŒVoldæœåŠ¡ä¼šä¸»åŠ¨æ·»åŠ ä¸€ä¸ªEmulatedVolumeæ¥å¯¹åº”&#x2F;dataè¿™ä¸ªPrivateVolumeåˆ†åŒºã€‚</p><ul><li>å½“æ²¡æœ‰å…¶ä»–è®¾å¤‡è¢«æ ¼å¼åŒ–ä¸ºPrivateVolumeä¸”è¦æ±‚ä½¿ç”¨Privateåˆ†åŒºæ¥ä½œä¸ºä¸»å­˜å‚¨çš„æ—¶å€™ï¼Œå°±ä½¿ç”¨&#x2F;dataåˆ†åŒºå¯¹åº”çš„EmulatedVolumeæ¥ä½œä¸ºä¸»å¤–ç½®å­˜å‚¨ã€‚</li><li>å½“æˆ‘ä»¬æ ¼å¼åŒ–äº†ä¸€ä¸ªPrivateVolumeçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†ä¸»åˆ†åŒºç§»åŠ¨åˆ°æ–°å¢çš„è¿™ä¸ªPrivateVolumeå¯¹åº”çš„EmulatedVolumeä¸Šã€‚</li></ul><p>EmulatedVolume ä¸ºä¸»åˆ†åŒºçš„æ—¶æ‰ä¼šè¢«æŒ‚è½½ï¼Œä¸€ä¸ªEmulatedVolumeä¸€èˆ¬ä½¿ç”¨PrivateVolumeæŒ‚è½½çš„æ ¹ç›®å½•ä¸‹çš„mediaç›®å½•ï¼Œä½œä¸ºfuseçš„åç«¯ä½¿ç”¨ï¼Œä½¿ç”¨fuseä¸»è¦æ–¹ä¾¿å­˜å‚¨æƒé™çš„ç®¡ç†ï¼Œæä¾›æ›´çµæ´»çš„æƒé™ç®¡ç†æœºåˆ¶ã€‚æˆ‘ä»¬ä¼šåœ¨åé¢è¿˜åˆ†æfuseå®ç°çš„å­˜å‚¨ç›®å½•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹ç£ç›˜çš„æ ¼å¼åŒ–è¿‡ç¨‹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é€»è¾‘å·ç®¡ç†LVM</title>
    <link href="/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/"/>
    <url>/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/</url>
    
    <content type="html"><![CDATA[<h1 id="é€»è¾‘å·ç®¡ç†LVM"><a href="#é€»è¾‘å·ç®¡ç†LVM" class="headerlink" title="é€»è¾‘å·ç®¡ç†LVM"></a>é€»è¾‘å·ç®¡ç†LVM</h1><h2 id="1-ä¸ºä»€ä¹ˆä¼šå‡ºç°é€»è¾‘å·"><a href="#1-ä¸ºä»€ä¹ˆä¼šå‡ºç°é€»è¾‘å·" class="headerlink" title="1.ä¸ºä»€ä¹ˆä¼šå‡ºç°é€»è¾‘å·"></a>1.ä¸ºä»€ä¹ˆä¼šå‡ºç°é€»è¾‘å·</h2><p>æ¯ä¸ªLinuxä½¿ç”¨è€…åœ¨å®‰è£…Linuxæ—¶ éƒ½ä¼šé‡åˆ°è¿™æ ·çš„å›°å¢ƒï¼šåœ¨ä¸ºç³»ç»Ÿåˆ†åŒºæ—¶ï¼Œå¦‚ä½•ç²¾ç¡®è¯„ä¼°å’Œåˆ†é…å„ä¸ªç¡¬ç›˜åˆ†åŒºçš„å®¹é‡ï¼Œå› ä¸ºç³»ç»Ÿç®¡ç†å‘˜ä¸ä½†è¦è€ƒè™‘åˆ°å½“å‰æŸä¸ªåˆ†åŒºéœ€è¦çš„å®¹é‡ï¼Œè¿˜è¦é¢„è§è¯¥åˆ†åŒºä»¥åå¯èƒ½éœ€è¦çš„å®¹é‡çš„æœ€å¤§å€¼ã€‚å› ä¸ºå¦‚æœä¼°è®¡ä¸å‡†ç¡®ï¼Œå½“é‡åˆ°æŸä¸ªåˆ†åŒºä¸å¤Ÿç”¨æ—¶ç®¡ç†å‘˜å¯èƒ½ç”šè‡³è¦å¤‡ä»½æ•´ä¸ªç³»ç»Ÿã€æ¸…é™¤ç¡¬ç›˜ã€é‡æ–°å¯¹ç¡¬ç›˜åˆ†åŒºï¼Œç„¶åæ¢å¤æ•°æ®åˆ°æ–°åˆ†åŒºã€‚</p><p>è™½ç„¶ç°åœ¨æœ‰å¾ˆå¤šåŠ¨æ€è°ƒæ•´ç£ç›˜çš„å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œä¾‹å¦‚Partation Magicç­‰ç­‰ï¼Œä½†æ˜¯å®ƒå¹¶ä¸èƒ½å®Œå…¨è§£å†³é—®é¢˜ï¼Œå› ä¸ºæŸä¸ªåˆ†åŒºå¯èƒ½ä¼šå†æ¬¡è¢«è€—å°½ï¼›å¦å¤–ä¸€ä¸ªæ–¹é¢è¿™éœ€è¦é‡æ–°å¼•å¯¼ç³»ç»Ÿæ‰èƒ½å®ç°ï¼Œå¯¹äºå¾ˆå¤šå…³é”®çš„æœåŠ¡å™¨ï¼Œåœæœºæ˜¯ä¸å¯æ¥å—çš„ï¼Œè€Œä¸”å¯¹äºæ·»åŠ æ–°ç¡¬ç›˜ï¼Œå¸Œæœ›ä¸€ä¸ªèƒ½è·¨è¶Šå¤šä¸ªç¡¬ç›˜é©±åŠ¨å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œåˆ†åŒºè°ƒæ•´ç¨‹åºå°±ä¸èƒ½è§£å†³é—®é¢˜ã€‚</p><p>å› æ­¤å®Œç¾çš„è§£å†³æ–¹æ³•åº”è¯¥æ˜¯åœ¨é›¶åœæœºå‰æä¸‹å¯ä»¥è‡ªå¦‚å¯¹æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°è¿›è¡Œè°ƒæ•´ï¼Œå¯ä»¥æ–¹ä¾¿å®ç°æ–‡ä»¶ç³»ç»Ÿè·¨è¶Šä¸åŒç£ç›˜å’Œåˆ†åŒºã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡é€»è¾‘ç›˜å·ç®¡ç†ï¼ˆLVMï¼ŒLogical Volume Managerï¼‰çš„æ–¹å¼æ¥éå¸¸å®Œç¾çš„å®ç°è¿™ä¸€åŠŸèƒ½ã€‚</p><p>LVMæ˜¯é€»è¾‘ç›˜å·ç®¡ç†ï¼ˆLogical Volume Managerï¼‰çš„ç®€ç§°ï¼Œä»–æ˜¯ç£ç›˜ç®¡ç†çš„å¦ä¸€ç§å·¥å…·ï¼Œå°±ç›®å‰åŸºæœ¬ä¸Šæ‰€æœ‰æ“ä½œç³»ç»Ÿå‡æ”¯æŒï¼ŒLVMæ˜¯å»ºç«‹åœ¨ç¡¬ç›˜å’Œåˆ†åŒºä¹‹ä¸Šçš„ä¸€ä¸ªé€»è¾‘å±‚ï¼Œæ¥æé«˜ç£ç›˜åˆ†åŒºç®¡ç†çš„çµæ´»æ€§ã€‚é€šè¿‡LVMç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è½»æ¾ç®¡ç†ç£ç›˜åˆ†åŒºï¼Œå¦‚ï¼šå°†è‹¥å¹²ä¸ªç£ç›˜åˆ†åŒºè¿æ¥ä¸ºä¸€ä¸ªæ•´å—çš„å·ç»„ï¼ˆvolume groupï¼‰ï¼Œå½¢æˆä¸€ä¸ªå­˜å‚¨æ± ã€‚ç®¡ç†å‘˜å¯ä»¥åœ¨å·ç»„ä¸Šéšæ„åˆ›å»ºé€»è¾‘å·ç»„ï¼ˆlogical volumesï¼‰ï¼Œå¹¶è¿›ä¸€æ­¥åœ¨é€»è¾‘å·ç»„ä¸Šåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿã€‚ç®¡ç†å‘˜é€šè¿‡LVMå¯ä»¥æ–¹ä¾¿çš„è°ƒæ•´å­˜å‚¨å·ç»„çš„å¤§å°ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç£ç›˜å­˜å‚¨æŒ‰ç…§ç»„çš„æ–¹å¼è¿›è¡Œå‘½åã€ç®¡ç†å’Œåˆ†é…ï¼Œä¾‹å¦‚æŒ‰ç…§ä½¿ç”¨ç”¨é€”è¿›è¡Œå®šä¹‰ï¼šâ€œDBdataâ€å’Œâ€œDBSoftâ€ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‰©ç†ç£ç›˜åâ€œsdaâ€å’Œâ€œsdbâ€æˆ–â€hdaâ€å’Œâ€hdbâ€ã€‚è€Œä¸”å½“ç³»ç»Ÿæ·»åŠ äº†æ–°çš„ç£ç›˜ï¼Œé€šè¿‡LVMç®¡ç†å‘˜å°±ä¸å¿…å°†ç£ç›˜çš„æ–‡ä»¶ç§»åŠ¨åˆ°æ–°çš„ç£ç›˜ä¸Šä»¥å……åˆ†åˆ©ç”¨æ–°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥æ‰©å±•æ–‡ä»¶ç³»ç»Ÿè·¨è¶Šç£ç›˜å³å¯ï¼Œæ¶æ„å¯ä»¥å‚è€ƒå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/5f6824ed3294480aa7d2d13a293a3cdf.jpeg" alt="ç£ç›˜ã€åˆ†åŒºã€ç‰©ç†å·ã€å·ç»„ã€é€»è¾‘å·å…³ç³»" style="zoom:67%;"><h2 id="2-LVMåŸºæœ¬ç»“æ„"><a href="#2-LVMåŸºæœ¬ç»“æ„" class="headerlink" title="2.LVMåŸºæœ¬ç»“æ„"></a>2.LVMåŸºæœ¬ç»“æ„</h2><p><strong>ç‰©ç†å­˜å‚¨ä»‹è´¨ï¼ˆThe physical mediaï¼‰</strong></p><p>è¿™é‡ŒæŒ‡ç³»ç»Ÿçš„å­˜å‚¨è®¾å¤‡ï¼šç¡¬ç›˜ï¼Œå¦‚ï¼š&#x2F;dev&#x2F;hdaã€&#x2F;dev&#x2F;sdaç­‰ç­‰ï¼Œæ˜¯å­˜å‚¨ç³»ç»Ÿæœ€ä½å±‚çš„å­˜å‚¨å•å…ƒã€‚</p><p><strong>ç‰©ç†å·ï¼ˆphysicalvolumeï¼‰</strong></p><p>ç‰©ç†å·å°±æ˜¯æŒ‡ç¡¬ç›˜åˆ†åŒºæˆ–ä»é€»è¾‘ä¸Šä¸ç£ç›˜åˆ†åŒºå…·æœ‰åŒæ ·åŠŸèƒ½çš„è®¾å¤‡(å¦‚RAID)ï¼Œæ˜¯LVMçš„åŸºæœ¬å­˜å‚¨é€»è¾‘å—ï¼Œä½†å’ŒåŸºæœ¬çš„ç‰©ç†å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚åˆ†åŒºã€ç£ç›˜ç­‰ï¼‰æ¯”è¾ƒï¼Œå´åŒ…å«æœ‰ä¸LVMç›¸å…³çš„ç®¡ç†å‚æ•°ã€‚</p><p><strong>å·ç»„ï¼ˆVolume Groupï¼‰</strong></p><p>LVMå·ç»„ç±»ä¼¼äºéLVMç³»ç»Ÿä¸­çš„ç‰©ç†ç¡¬ç›˜ï¼Œå…¶ç”±ç‰©ç†å·ç»„æˆã€‚å¯ä»¥åœ¨å·ç»„ä¸Šåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªâ€œLVMåˆ†åŒºâ€ï¼ˆé€»è¾‘å·ï¼‰ï¼ŒLVMå·ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç‰©ç†å·ç»„æˆã€‚</p><p><strong>é€»è¾‘å·ï¼ˆlogicalvolumeï¼‰</strong></p><p>LVMçš„é€»è¾‘å·ç±»ä¼¼äºéLVMç³»ç»Ÿä¸­çš„ç¡¬ç›˜åˆ†åŒºï¼Œåœ¨é€»è¾‘å·ä¹‹ä¸Šå¯ä»¥å»ºç«‹æ–‡ä»¶ç³»ç»Ÿ(æ¯”å¦‚&#x2F;homeæˆ–è€…&#x2F;usrç­‰)ã€‚</p><p><strong>PEï¼ˆphysical extentï¼‰</strong></p><p>æ¯ä¸€ä¸ªç‰©ç†å·è¢«åˆ’åˆ†ä¸ºç§°ä¸ºPE(Physical Extents)çš„åŸºæœ¬å•å…ƒï¼Œå…·æœ‰å”¯ä¸€ç¼–å·çš„PEæ˜¯å¯ä»¥è¢«LVMå¯»å€çš„æœ€å°å•å…ƒã€‚PEçš„å¤§å°æ˜¯å¯é…ç½®çš„ï¼Œé»˜è®¤ä¸º4MBã€‚</p><p><strong>LEï¼ˆlogical extentï¼‰</strong></p><p>é€»è¾‘å·ä¹Ÿè¢«åˆ’åˆ†ä¸ºè¢«ç§°ä¸ºLE(Logical Extents) çš„å¯è¢«å¯»å€çš„åŸºæœ¬å•ä½ã€‚åœ¨åŒä¸€ä¸ªå·ç»„ä¸­ï¼ŒLEçš„å¤§å°å’ŒPEæ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”ä¸€ä¸€å¯¹åº”ã€‚</p><img src="/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/image-20230528220753173.png" alt="image-20230528220753173" style="zoom:67%;"><p>ğŸ¤–<strong>æ³¨æ„ï¼šä¸€ä¸ªé€»è¾‘å·åªèƒ½æ¥è‡ªäºä¸€ä¸ªå·ç»„</strong></p><h2 id="3-LVMç®¡ç†å‘½ä»¤"><a href="#3-LVMç®¡ç†å‘½ä»¤" class="headerlink" title="3.LVMç®¡ç†å‘½ä»¤"></a>3.LVMç®¡ç†å‘½ä»¤</h2><img src="/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/980b51f31966e6d9d5e5245f04c1cedcf46905.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;"><p><img src="https://dl-harmonyos.51cto.com/images/202101/980b51f31966e6d9d5e5245f04c1cedcf46905.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº"></p><p>ä¸»è¦å‘½ä»¤çš„ç”¨æ³•<br>ï¼ˆ1ï¼‰pvcreate è®¾å¤‡å<br>ï¼ˆ2ï¼‰vgcreate -s 8M å·ç»„å ç‰©ç†å·å1 ç‰©ç†å·å2<br>ï¼ˆ3ï¼‰lvcreate -L å¤§å° -n é€»è¾‘å·å å·ç»„å<br>ï¼ˆ4ï¼‰lvextend -L +å¤§å° &#x2F;dev&#x2F;å·ç»„å&#x2F;é€»è¾‘å·å<br>ï¼ˆ5ï¼‰lvreduce â€“L +å¤§å° &#x2F;dev&#x2F;å·ç»„å&#x2F;é€»è¾‘å·å</p><p>å…¶ä½™æ“ä½œè§ï¼š<a href="https://www.cnblogs.com/cloudos/p/9348315.html">https://www.cnblogs.com/cloudos/p/9348315.html</a></p><h2 id="4-LVMåº”ç”¨ç¤ºä¾‹"><a href="#4-LVMåº”ç”¨ç¤ºä¾‹" class="headerlink" title="4.LVMåº”ç”¨ç¤ºä¾‹"></a>4.LVMåº”ç”¨ç¤ºä¾‹</h2><p><strong>éœ€æ±‚æè¿°ï¼š</strong></p><blockquote><p>å…¬å¸çš„é‚®ä»¶æœåŠ¡å™¨ç”±äºç”¨æˆ·æ•°é‡ä¼—å¤šï¼Œé‚®ä»¶å­˜å‚¨éœ€è¦å¤§é‡çš„ç©ºé—´ï¼Œè€ƒè™‘åˆ°åŠ¨æ€æ‰©å®¹çš„éœ€è¦ï¼Œè®¡åˆ’å¢åŠ ä¸¤å—SCSIç¡¬ç›˜å¹¶æ„å»ºLVMé€»è¾‘å·ï¼ŒæŒ‚è½½åˆ°â€œ&#x2F;mailâ€ç›®å½•ä¸“é—¨ç”¨äºå­˜æ”¾é‚®ä»¶æ•°</p></blockquote><p><strong>æ¨èæ­¥éª¤ï¼š</strong></p><blockquote><p>PV -&gt; VG -&gt; LV -&gt; æ ¼å¼åŒ–-&gt;æŒ‚è½½ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ</p></blockquote><img src="https://dl-harmonyos.51cto.com/images/202101/55f57c1699f0f7186137194b65b95fb109435f.png" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;"><p>ç¬¬ä¸€æ­¥ï¼šè½¬åŒ–ç‰©ç†å·<br>ï¼ˆ1ï¼‰ä½¿ç”¨fdiskå‘½ä»¤è§„åˆ’ä¸¤ä¸ªåˆ†åŒºï¼Œç±»å‹è®¾ç½®ä¸ºâ€œ8eâ€ï¼š&#x2F;dev&#x2F;sdb1ã€&#x2F;dev&#x2F;sdc1<br>ï¼ˆ2ï¼‰ä½¿ç”¨pvcreateå‘½ä»¤è½¬æ¢ä¸Šè¿°åˆ†åŒºä¸ºç‰©ç†å·</p><img src="/2023/05/28/%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86LVM/04457b6915ed6816e27022c660e5ff0520395e.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;"><p>ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå·ç»„<br>ï¼ˆ1ï¼‰ä½¿ç”¨vgcreateå‘½ä»¤åˆ›å»ºå·ç»„mail_storeï¼ˆåŒ…æ‹¬ç‰©å·ï¼š&#x2F;dec&#x2F;sdb1ã€&#x2F;dev&#x2F;sdc1ï¼‰</p><img src="https://dl-harmonyos.51cto.com/images/202101/11476c03152237e8f1a533caa7b1aeaecaf618.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom: 67%;"><p>ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºé€»è¾‘å·<br>ï¼ˆ1ï¼‰ä½¿ç”¨lvcreateå‘½ä»¤åˆ›å»ºé€»è¾‘å·mailï¼Œ ä»å·ç»„mail_storeä¸Šåˆ’å‡º60GBç©ºé—´<br>ï¼ˆ2ï¼‰ä½¿ç”¨mkfså‘½ä»¤åˆ›å»ºext4æ–‡ä»¶ç³»ç»Ÿ</p><img src="https://dl-harmonyos.51cto.com/images/202101/094608f00cd07bc6ae6632a3d6eec1b17f5b25.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;"><p>ä¸ºé€»è¾‘å·æ‰©å®¹ï¼š<br>ï¼ˆ1ï¼‰ä½¿ç”¨lvextendå‘½ä»¤ä¸ºé€»è¾‘å·mailæ‰©å……å®¹é‡ï¼Œ ä»å·ç»„mail_storeä¸Šå†åˆ’å‡º10GBç»™é€»è¾‘å·mail<br>ï¼ˆ2ï¼‰ä½¿ç”¨resize2fså‘½ä»¤æ›´æ–°ç³»ç»Ÿè¯†åˆ«çš„æ–‡ä»¶ç³»ç»Ÿå¤§å°</p><img src="https://dl-harmonyos.51cto.com/images/202101/838bfd311007d0d077f1443f83161fdc7833db.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;"><p>ä¸ºé€»è¾‘å·ç¼©å‡<br>ï¼ˆ1ï¼‰ä½¿ç”¨lvreduceå‘½ä»¤ä¸ºé€»è¾‘å· mailç¼©å‡å®¹é‡,å¿…é¡»å…ˆå¸è½½ï¼Œ ä»å·ç»„ mail_store ä¸Šç¼©å°é€»è¾‘å·mailåˆ°10G<br>ï¼ˆ2ï¼‰ä½¿ç”¨resize2fså‘½ä»¤æ›´æ–°ç³»ç»Ÿè¯†åˆ«çš„æ–‡ä»¶ç³»ç»Ÿå¤§å°<br>ï¼ˆ3ï¼‰ä½¿ç”¨fsck å‘½ä»¤æ¸…ç†æ–‡ä»¶ç³»ç»Ÿæ•°æ®ç»“æ„</p><img src="https://dl-harmonyos.51cto.com/images/202101/471b8156850e604a8f9098ea07c682d086fee4.jpg" alt="Linuxå­¦ä¹ ç¬”è®°â€”â€”é€»è¾‘å·ç®¡ç†ï¼ˆLVMï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom:67%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å“ˆå·¥å¤§åˆ˜å®ä¼Ÿè€å¸ˆè®¡ç®—æœºç»„æˆåŸç†</title>
    <link href="/2023/05/22/%E5%93%88%E5%B7%A5%E5%A4%A7%E5%88%98%E5%AE%8F%E4%BC%9F%E8%80%81%E5%B8%88%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/"/>
    <url>/2023/05/22/%E5%93%88%E5%B7%A5%E5%A4%A7%E5%88%98%E5%AE%8F%E4%BC%9F%E8%80%81%E5%B8%88%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="å“ˆå·¥å¤§åˆ˜å®ä¼Ÿè€å¸ˆè®¡ç®—æœºç»„æˆåŸç†"><a href="#å“ˆå·¥å¤§åˆ˜å®ä¼Ÿè€å¸ˆè®¡ç®—æœºç»„æˆåŸç†" class="headerlink" title="å“ˆå·¥å¤§åˆ˜å®ä¼Ÿè€å¸ˆè®¡ç®—æœºç»„æˆåŸç†"></a>å“ˆå·¥å¤§åˆ˜å®ä¼Ÿè€å¸ˆè®¡ç®—æœºç»„æˆåŸç†</h1><ul><li><a href="https://anmuxixixi.github.io/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/">è®¡ç®—æœºç»„æˆåŸç†(ä¸€)è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º_</a></li><li><a href="https://anmuxixixi.github.io/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/">è®¡ç®—æœºç»„æˆåŸç†(ä¸‰)æ€»çº¿_</a></li><li><a href="https://anmuxixixi.github.io/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/">è®¡ç®—æœºç»„æˆåŸç†(å››)å­˜å‚¨å™¨</a></li><li><a href="https://anmuxixixi.github.io/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/">è®¡ç®—æœºç»„æˆåŸç†(äº”)è¾“å…¥è¾“å‡ºç³»ç»Ÿ</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç»„æˆåŸç†(å…­)è®¡ç®—æœºçš„è¿ç®—æ–¹æ³•</title>
    <link href="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/"/>
    <url>/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç»„æˆåŸç†-å…­-è®¡ç®—æœºçš„è¿ç®—æ–¹æ³•"><a href="#è®¡ç®—æœºç»„æˆåŸç†-å…­-è®¡ç®—æœºçš„è¿ç®—æ–¹æ³•" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†(å…­)è®¡ç®—æœºçš„è¿ç®—æ–¹æ³•"></a>è®¡ç®—æœºç»„æˆåŸç†(å…­)è®¡ç®—æœºçš„è¿ç®—æ–¹æ³•</h1><h2 id="1-æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°"><a href="#1-æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°" class="headerlink" title="1.æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°"></a>1.æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°</h2><p>åœ¨è®¡ç®—æœºä¸­å‚ä¸è¿ç®—çš„æ•°æœ‰ä¸¤å¤§ç±»ï¼š<strong>æ— ç¬¦å·æ•°ã€æœ‰ç¬¦å·æ•°</strong></p><h3 id="1-1-æ— ç¬¦å·æ•°"><a href="#1-1-æ— ç¬¦å·æ•°" class="headerlink" title="1.1 æ— ç¬¦å·æ•°"></a>1.1 æ— ç¬¦å·æ•°</h3><p>è®¡ç®—æœºä¸­çš„æ•°å‡æ”¾åœ¨å¯„å­˜å™¨ä¸­,é€šå¸¸ç§°å¯„å­˜å™¨çš„ä½æ•°ä¸ºæœºå™¨å­—é•¿ã€‚æ‰€è°“æ— ç¬¦å·æ•°,å³æ²¡æœ‰ç¬¦å·çš„æ•°,åœ¨å¯„å­˜å™¨ä¸­çš„æ¯ä¸€ä½å‡å¯ç”¨æ¥å­˜æ”¾æ•°å€¼ã€‚å½“å­˜æ”¾æœ‰ç¬¦å·æ•°æ—¶,åˆ™éœ€ç•™å‡ºä½ç½®å­˜æ”¾ç¬¦å·ã€‚å› æ­¤,åœ¨æœºå™¨å­—é•¿ç›¸åŒæ—¶,æ— ç¬¦å·æ•°ä¸æœ‰ç¬¦å·æ•°æ‰€å¯¹åº”çš„æ•°å€¼èŒƒå›´æ˜¯ä¸åŒçš„ã€‚ä»¥æœºå™¨å­—é•¿ä¸º16ä½ä¸ºä¾‹,æ— ç¬¦å·æ•°çš„è¡¨ç¤ºèŒƒå›´ä¸º0 ~65535,è€Œæœ‰ç¬¦å·æ•°çš„è¡¨ç¤ºèŒƒå›´ä¸ºâ€“ 32768 ~ +32767ã€‚</p><h3 id="1-2-æœ‰ç¬¦å·æ•°"><a href="#1-2-æœ‰ç¬¦å·æ•°" class="headerlink" title="1.2 æœ‰ç¬¦å·æ•°"></a>1.2 æœ‰ç¬¦å·æ•°</h3><h4 id="1-2-1-æœºå™¨æ•°ä¸çœŸå€¼"><a href="#1-2-1-æœºå™¨æ•°ä¸çœŸå€¼" class="headerlink" title="1.2.1 æœºå™¨æ•°ä¸çœŸå€¼"></a>1.2.1 æœºå™¨æ•°ä¸çœŸå€¼</h4><p>å¯¹äºæœ‰ç¬¦å·æ•°è€Œè¨€ï¼Œåœ¨è®¡ç®—æœºä¸­ç”¨0-&gt;æ­£ï¼Œ1-&gt;è´Ÿï¼Œç›¸å½“äºç¬¦å·è¢«æ•°å­—åŒ–äº†ï¼Œå¹¶è§„å®šæ”¾åœ¨æœ‰æ•ˆæ•°å­—çš„å‰é¢ï¼Œå³ç»„æˆäº†æœ‰ç¬¦å·æ•°ã€‚</p><p>ä¾‹å¦‚ï¼Œ<strong>æœ‰ç¬¦å·æ•°çš„å°æ•°</strong>è¡¨ç¤ºï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/20190814152551628.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p><strong>æœ‰ç¬¦å·æ•°çš„æ•´æ•°</strong>è¡¨ç¤ºï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/20190814152625574.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><p><strong>æŠŠç¬¦å·æ•°å­—åŒ–</strong>çš„æ•°ç§°ä¸ºæœºå™¨æ•°ï¼Œè€ŒæŠŠå¸¦â€+â€,â€-â€œç¬¦å·çš„æ•°ç§°ä¸ºçœŸå€¼ï¼Œä¸€æ—¦ç¬¦å·æ•°å­—åŒ–åï¼Œç¬¦å·çš„æ•°å€¼å°±å½¢æˆäº†ä¸€ç§æ–°çš„ç¼–ç ã€‚</p><p><strong>åœ¨è¿ç®—è¿‡ç¨‹ä¸­ï¼Œ</strong><br>ç¬¦å·ä½èƒ½å¦å’Œæ•°å€¼éƒ¨åˆ†ä¸€èµ·å‚åŠ è¿ç®—ï¼Ÿ<br>å¦‚æœå‚åŠ è¿ç®—ï¼Œç¬¦å·ä½åˆéœ€ä½œå“ªäº›å¤„ç†ï¼Ÿ<br>è¿™äº›é—®é¢˜éƒ½ä¸ç¬¦å·ä½å’Œæ•°å€¼ä½æ‰€æ„æˆçš„ç¼–ç æœ‰å…³ï¼Œ<strong>è¿™äº›ç¼–ç å°±æ˜¯åŸç ã€åç ã€è¡¥ç ã€ç§»ç ã€‚</strong></p><h4 id="1-2-2-åŸç "><a href="#1-2-2-åŸç " class="headerlink" title="1.2.2 åŸç "></a>1.2.2 åŸç </h4><p>åŸç è¡¨ç¤ºæ³•åˆç§°ä¸º<strong>å¸¦ç¬¦å·çš„ç»å¯¹å€¼è¡¨ç¤º</strong>ï¼Œè§„å®š<strong>æ•´æ•°çš„ç¬¦å·ä½ä¸æ•°å€¼ä¹‹é—´ç”¨é€—å·éš”å¼€</strong>ï¼Œ<strong>å°æ•°çš„ç¬¦å·ä½ä¸æ•°å€¼ä½ä¹‹é—´ç”¨å°æ•°ç‚¹éš”å¼€</strong>ã€‚</p><p>ä¾‹å¦‚ï¼š<br>+0.1011 åŸç :0.1011<br>-0.1011 åŸç :1.1011<br>+1100 åŸç :0,1100<br>-1100 åŸç :1,1100</p><p><strong>æ•´æ•°åŸç çš„å®šä¹‰ä¸ºï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNzA4Nzky,size_16,color_FFFFFF,t_70.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 80%;"><p><strong>å°æ•°åŸç çš„å®šä¹‰ä¸ºï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/20190814154044718.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p><strong>ä¸¾ä¾‹è¯´æ˜ï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/7d202230edd82e99eb5c7c0c0916473a.png" alt="image-20220508105918404" style="zoom:67%;"><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/23cdcb021ddac4aba19ef6bb50b35b20.png" alt="image-20220508110018469" style="zoom: 67%;"><p>åŸç è¡¨ç¤ºç®€å•æ˜äº†,å¹¶æ˜“äºå’ŒçœŸå€¼è½¬æ¢ã€‚ä½†ç”¨åŸç è¿›è¡ŒåŠ å‡è¿ç®—æ—¶,å´å¸¦æ¥äº†è®¸å¤šéº»çƒ¦ã€‚ä¾‹å¦‚,å½“ä¸¤ä¸ªæ“ä½œæ•°ç¬¦å·ä¸åŒä¸”è¦ä½œåŠ æ³•è¿ç®—æ—¶,å…ˆè¦åˆ¤æ–­ä¸¤æ•°ç»å¯¹å€¼å¤§å°,ç„¶åå°†ç»å¯¹å€¼å¤§çš„æ•°å‡å»ç»å¯¹å€¼å°çš„æ•°,ç»“æœçš„ç¬¦å·ä»¥ç»å¯¹å€¼å¤§çš„æ•°ä¸ºå‡†ã€‚è¿ç®—æ­¥éª¤æ—¢å¤æ‚åˆè´¹æ—¶,è€Œä¸”æœ¬æ¥æ˜¯åŠ æ³•è¿ç®—å´è¦ç”¨å‡æ³•å™¨å®ç°ã€‚é‚£ä¹ˆèƒ½å¦åœ¨è®¡ç®—æœºä¸­åªè®¾åŠ æ³•å™¨,åªä½œåŠ æ³•æ“ä½œå‘¢?å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªä¸è´Ÿæ•°ç­‰ä»·çš„æ­£æ•°æ¥ä»£æ›¿è¯¥è´Ÿæ•°,å°±å¯æŠŠå‡æ³•æ“ä½œç”¨åŠ æ³•ä»£æ›¿ã€‚è€Œæœºå™¨æ•°é‡‡ç”¨è¡¥ç æ—¶,å°±èƒ½æ»¡è¶³æ­¤è¦æ±‚ã€‚</p><h4 id="1-2-3-è¡¥ç "><a href="#1-2-3-è¡¥ç " class="headerlink" title="1.2.3 è¡¥ç "></a>1.2.3 è¡¥ç </h4><p>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œå¸¸ä¼šé‡åˆ°â€œè¡¥æ•°â€çš„æ¦‚å¿µã€‚ä¾‹å¦‚ï¼Œæ—¶é’ŸæŒ‡ç¤º6ç‚¹ï¼Œæ¬²ä½¿å®ƒæŒ‡ç¤º3ç‚¹ï¼Œæ—¢å¯æŒ‰ç…§é¡ºæ—¶é’ˆæ–¹å‘å°†åˆ†é’Ÿè½¬9åœˆï¼Œåˆå¯æŒ‰ç…§é€†æ—¶é’ˆæ–¹å‘å°±åˆ†é’ˆè½¬3åœˆï¼Œç»“æœæ˜¯ä¸€è‡´ã€‚å‡è®¾é¡ºæ—¶é’ˆæ–¹å‘è½¬ä¸ºæ­£ï¼Œé€†æ—¶é’ˆæ–¹å‘ä¸ºè´Ÿï¼Œåˆ™æœ‰</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/4b97c15569cc6ba39a00760b724a322e.png" alt="img" style="zoom: 50%;"><p>ç”±äºæ—¶é’Ÿçš„æ—¶é’ˆè½¬ä¸€åœˆèƒ½æŒ‡ç¤º12ä¸ªå°æ—¶,è¿™â€œ12â€åœ¨æ—¶é’Ÿé‡Œæ˜¯ä¸è¢«æ˜¾ç¤ºè€Œè‡ªåŠ¨ä¸¢å¤±çš„,å³15 -12&#x3D;3,æ•…15ç‚¹å’Œ3ç‚¹å‡æ˜¾ç¤º3ç‚¹ã€‚è¿™æ ·-3å’Œ+9å¯¹æ—¶é’Ÿè€Œè¨€å…¶ä½œç”¨æ˜¯ä¸€è‡´çš„ã€‚åœ¨æ•°å­¦ä¸Šç§°12ä¸ºæ¨¡,å†™ä½œmod 12,è€Œç§°ï¼‹9æ˜¯-3ä»¥12ä¸ºæ¨¡çš„è¡¥æ•°,è®°ä½œ</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522225611392.png" alt="image-20230522225611392" style="zoom:67%;"><p>æˆ–è€…è¯´ï¼Œå¯¹æ¨¡12è€Œè¨€ï¼Œ-3å’Œ+9æ˜¯äº’ä¸ºè¡¥æ•°çš„ã€‚åŒç†æœ‰ï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522225718188.png" alt="image-20230522225718188" style="zoom: 67%;"><p>å³å¯¹æ¨¡12è€Œè¨€ï¼Œ+8å’Œ+7åˆ†ä¸º-4å’Œ-5çš„è¡¥æ•°ã€‚å¯è§ï¼Œåªè¦ç¡®å®šäº†â€œæ¨¡â€ï¼Œå°±å¯æ‰¾åˆ°ä¸€ä¸ªä¸è´Ÿæ•°ç­‰ä»·çš„æ­£æ•°ï¼ˆè¯¥æ­£æ•°å³ä¸ºè´Ÿæ•°çš„è¡¥æ•°ï¼‰æ¥ä»£æ›¿æ­¤è´Ÿæ•°ï¼Œè¿™æ ·å°±å¯æŠŠå‡æ³•è¿ç®—ç”¨åŠ æ³•å®ç°ã€‚ä¾‹å¦‚ï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNzA4Nzky,size_16,color_FFFFFF,t_70-1684767570485-15.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><ul><li>ä¸€ä¸ªè´Ÿæ•°å¯ç”¨å®ƒçš„æ­£è¡¥æ•°æ¥ä»£æ›¿ï¼Œè€Œè¿™ä¸ªæ­£è¡¥æ•°å¯ä»¥ç”¨æ¨¡åŠ ä¸Šè´Ÿæ•°æœ¬èº«æ±‚å¾—</li><li>ä¸€ä¸ªæ­£æ•°å’Œä¸€ä¸ªè´Ÿæ•°äº’ä¸ºè¡¥æ•°æ—¶ï¼Œå®ƒä»¬ç»å¯¹å€¼ä¹‹å’Œå³ä¸ºæ¨¡æ•°</li><li>æ­£æ•°çš„è¡¥æ•°å³è¯¥è¡¥æ•°æœ¬èº«ã€‚</li></ul><p>â­<strong>è¡¥æ•°çš„å®šä¹‰ä¸ºï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/2800eed80de4eb89b325dd35c9a6991c.png" alt="img" style="zoom:40%;"><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/08a761ee8df15187290b436eac2f6fb6.png" alt="img" style="zoom: 40%;"><p>ğŸ’Ÿ<strong>æ±‚è¡¥ç çš„å¿«æ·æ–¹å¼</strong>ã€<strong>è¡¥ç çš„æ¨¡&#x3D;æ•°å€¼ä½æ•°+1</strong>ã€‘</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522230946615.png" alt="image-20230522230946615" style="zoom:50%;"><blockquote><p>å¯¹äºå°æ•°è€Œè¨€ï¼Œå°±æ˜¯ç¬¦å·ä½ä¸å˜ï¼Œåé¢çš„åŸç å–å+1</p></blockquote><p>ä¸‹é¢ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522231029116.png" alt="image-20230522231029116" style="zoom: 48%;"><img src="https://img-blog.csdnimg.cn/img_convert/49174e17be37f264204c5e97f817887b.png" alt="img" style="zoom: 33%;"><h4 id="1-2-4-åç "><a href="#1-2-4-åç " class="headerlink" title="1.2.4 åç "></a>1.2.4 åç </h4><p><strong>æ­£æ•°çš„å®šä¹‰ï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522234349056.png" alt="image-20230522234349056" style="zoom: 33%;"><p><strong>å°æ•°çš„å®šä¹‰ï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522234404699.png" alt="image-20230522234404699" style="zoom:33%;"><p>ä¸¾ä¾‹ï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/fb57719b0df2edf16e0b203e7e4db511.png" alt="img" style="zoom: 33%;"><blockquote><ul><li>å¯¹æ­£æ•°è€Œè¨€ï¼Œåç æ˜¯å…¶æœ¬èº«</li><li>å¯¹è´Ÿæ•°è€Œè¨€ï¼Œç¬¦å·ä½ä¸å˜ï¼Œæ•°å€¼ä½æ¯ä¸€ä½å–å</li></ul></blockquote><p>å®é™…ä¸Š,åç ä¹Ÿå¯çœ‹åšæ˜¯mod (2-2^(-n))(å¯¹äºå°æ•°)æˆ–mod (2^(n+1)-1)(å¯¹äºæ•´æ•°)çš„è¡¥ç ã€‚<strong>ä¸è¡¥ç ç›¸æ¯”,ä»…åœ¨æœ«ä½å·®1</strong>,å› æ­¤æœ‰äº›ä¹¦ä¸Šç§°å°æ•°çš„è¡¥ç ä¸º2çš„è¡¥ç ,è€Œç§°å°æ•°çš„åç ä¸º1çš„è¡¥ç ã€‚</p><h4 id="1-2-5-ä¸‰ç§æœºå™¨æ•°çš„å°ç»“"><a href="#1-2-5-ä¸‰ç§æœºå™¨æ•°çš„å°ç»“" class="headerlink" title="1.2.5 ä¸‰ç§æœºå™¨æ•°çš„å°ç»“"></a>1.2.5 ä¸‰ç§æœºå™¨æ•°çš„å°ç»“</h4><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522234915110.png" alt="image-20230522234915110" style="zoom:50%;"><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522234927867.png" alt="image-20230522234927867" style="zoom:50%;"><p><strong>ä¸‹é¢è¿™ä¸ªè§„å¾‹è¦è®°ä½ï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522234938601.png" alt="image-20230522234938601" style="zoom:50%;"><h4 id="1-2-6-ç§»ç "><a href="#1-2-6-ç§»ç " class="headerlink" title="1.2.6 ç§»ç "></a>1.2.6 ç§»ç </h4><p>è¡¥ç é€šå¸¸ä½ å¾ˆéš¾åˆ¤æ–­çœŸå€¼çš„å¸¦ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠè¡¥ç å¹³ç§»æˆéƒ½æ˜¯ä»0å¼€å§‹ï¼Œè¿™æ ·éƒ½å°±å¯ä»¥æ¯”è¾ƒå¤§å°äº†ã€‚</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/e62a7bfd020380910a42d7f8faec3c2f.png" alt="image-20220510154451727" style="zoom: 67%;"><p>ç§»ç çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/b4bf63a93c2fefa9f650653801862921-1684770839332-39.png" alt="image-20220510161827115" style="zoom:33%;"><p>å…¶å®ç§»ç å°±æ˜¯åœ¨çœŸå€¼ä¸ŠåŠ ä¸€ä¸ªå¸¸æ•°2^nã€‚åœ¨æ•°è½´ä¸Šç§»ç æ‰€è¡¨ç¤ºçš„èŒƒå›´æ°å¥½å¯¹åº”äºçœŸå€¼åœ¨æ•°è½´ä¸Šçš„èŒƒå›´å‘è½´çš„æ­£æ–¹å‘ç§»åŠ¨2^nä¸ªå•å…ƒ,å¦‚ä¸Šå›¾æ‰€ç¤º,ç”±æ­¤è€Œå¾—ç§»ç ä¹‹ç§°ã€‚</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNzA4Nzky,size_16,color_FFFFFF,t_70-1684770798778-36.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>è¿›ä¸€æ­¥è§‚å¯Ÿå‘ç°,<strong>åŒä¸€ä¸ªçœŸå€¼çš„ç§»ç å’Œè¡¥ç ä»…å·®ä¸€ä¸ªç¬¦å·ä½</strong>,è‹¥å°†è¡¥ç çš„ç¬¦å·ä½ç”±â€œ0â€æ”¹ä¸ºâ€œ1â€,æˆ–ä»â€œ1â€æ”¹ä¸ºâ€œOâ€,å³å¯å¾—è¯¥çœŸå€¼çš„ç§»ç ã€‚ä¸‹è¡¨åˆ—å‡ºäº†çœŸå€¼ã€è¡¥ç å’Œç§»ç çš„å¯¹åº”å…³ç³»ã€‚</p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/image-20230522235250588.png" alt="image-20230522235250588" style="zoom:50%;"><p><strong>ç§»ç çš„ç‰¹ç‚¹ï¼š</strong></p><img src="/2023/05/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%85%AD-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9A%84%E8%BF%90%E7%AE%97%E6%96%B9%E6%B3%95/861c855d1c3690b159db2e1136862ac7.png" alt="image-20220510164307143" style="zoom: 50%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç»„æˆåŸç†(äº”)è¾“å…¥è¾“å‡ºç³»ç»Ÿ</title>
    <link href="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç»„æˆåŸç†-äº”-è¾“å…¥è¾“å‡ºç³»ç»Ÿ"><a href="#è®¡ç®—æœºç»„æˆåŸç†-äº”-è¾“å…¥è¾“å‡ºç³»ç»Ÿ" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†(äº”)è¾“å…¥è¾“å‡ºç³»ç»Ÿ"></a>è®¡ç®—æœºç»„æˆåŸç†(äº”)è¾“å…¥è¾“å‡ºç³»ç»Ÿ</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h2><h3 id="1-1-å‘å±•æ¦‚å†µ"><a href="#1-1-å‘å±•æ¦‚å†µ" class="headerlink" title="1.1 å‘å±•æ¦‚å†µ"></a>1.1 å‘å±•æ¦‚å†µ</h3><p><strong>ï¼ˆ1ï¼‰æ—©æœŸé˜¶æ®µ</strong></p><p>æ—©æœŸçš„I&#x2F;Oè®¾å¤‡ç§ç±»è¾ƒå°‘ï¼ŒI&#x2F;Oè®¾å¤‡ä¸ä¸»å­˜äº¤æ¢ä¿¡æ¯éƒ½å¿…é¡»é€šè¿‡CPUï¼šã€</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/57eed5f957a849f9ac5ab2be50107f64.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><ul><li>æ¯ä¸ªI&#x2F;Oè®¾å¤‡éƒ½å¿…é¡»é…æœ‰ä¸€å¥—ç‹¬ç«‹çš„é€»è¾‘ç”µè·¯ä¸CPUç›¸è¿ï¼Œ<strong>çº¿è·¯ååˆ†æ•£ä¹±ã€åºæ‚</strong>ã€‚</li><li>è¾“å…¥è¾“å‡ºè¿‡ç¨‹æ˜¯ç©¿æ’åœ¨CPUæ‰§è¡Œç¨‹åºè¿‡ç¨‹ä¹‹ä¸­è¿›è¡Œçš„ï¼Œ<strong>å·¥ä½œæ•ˆç‡ä½</strong>ã€‚</li><li>æ¯ä¸ªI&#x2F;0è®¾å¤‡çš„é€»è¾‘æ§åˆ¶ç”µè·¯ä¸CPUçš„æ§åˆ¶å™¨ç´§å¯†æ„æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œ<strong>å¯æ‰©å±•æ€§ä½</strong>ã€‚</li></ul><p><strong>ï¼ˆ2ï¼‰æ¥å£æ¨¡å—å’ŒDMAé˜¶æ®µ</strong></p><p>è¿™ä¸ªé˜¶æ®µI&#x2F;Oè®¾å¤‡é€šè¿‡æ¥å£æ¨¡å—ä¸ä¸»æœºè¿æ¥ï¼Œè®¡ç®—æœºç³»ç»Ÿé‡‡ç”¨äº†æ€»çº¿ç»“æ„ï¼š</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/b1988599f220489cb0da4cc73805a1ea.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><ul><li>æ•°æ®ç»è¿‡æ¥å£æ—¢èµ·åˆ°ç¼“å†²ä½œç”¨ï¼Œåˆå¯å®Œæˆä¸²å¹¶å˜æ¢ã€‚</li><li>æ¥å£èƒ½æ»¡è¶³ä¸­æ–­è¯·æ±‚å¤„ç†çš„è¦æ±‚ï¼Œä½¿I&#x2F;Oè®¾å¤‡ä¸CPUå¯æŒ‰å¹¶è¡Œæ–¹å¼å·¥ä½œï¼Œå¤§å¤§åœ°æé«˜äº†CPUçš„å·¥ä½œæ•ˆç‡ã€‚</li><li>æ¥å£æŠ€æœ¯è¿˜å¯ä»¥ä½¿å¤šå°I&#x2F;Oè®¾å¤‡åˆ†æ—¶å ç”¨æ€»çº¿ï¼Œä½¿å¤šå°I&#x2F;Oè®¾å¤‡äº’ç›¸ä¹‹é—´ä¹Ÿå¯å®ç°å¹¶è¡Œå·¥ä½œæ–¹å¼ï¼Œæœ‰åˆ©äºæ•´æœºå·¥ä½œæ•ˆç‡çš„æé«˜ã€‚</li></ul><p>ä¸ºäº†è¿›ä¸€æ­¥æé«˜CPUçš„å·¥ä½œæ•ˆç‡ï¼Œåˆå‡ºç°äº†ç›´æ¥å­˜å‚¨å™¨å­˜å–(Direct Memory Access,DMA)æŠ€æœ¯ï¼š</p><ul><li>I&#x2F;Oè®¾å¤‡ä¸ä¸»å­˜ä¹‹é—´æœ‰ä¸€æ¡ç›´æ¥æ•°æ®é€šè·¯ï¼›</li><li>I&#x2F;Oè®¾å¤‡å¯ä»¥ä¸ä¸»å­˜ç›´æ¥äº¤æ¢ä¿¡æ¯ï¼Œä½¿CPUåœ¨I&#x2F;Oè®¾å¤‡ä¸ä¸»å­˜äº¤æ¢ä¿¡æ¯æ—¶èƒ½ç»§ç»­å®Œæˆè‡ªèº«çš„å·¥ä½œï¼Œæ•…èµ„æºåˆ©ç”¨ç‡å¾—åˆ°äº†è¿›ä¸€æ­¥æé«˜ã€‚</li></ul><p><strong>ï¼ˆ3ï¼‰å…·æœ‰é€šé“ç»“æ„çš„é˜¶æ®µ</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/d3f62d3e4e79426c9eefbd41ee0955af.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><ul><li>é€šé“æ˜¯ç”¨æ¥è´Ÿè´£ç®¡ç†I&#x2F;Oè®¾å¤‡ä»¥åŠå®ç°ä¸»å­˜ä¸I&#x2F;Oè®¾å¤‡ä¹‹é—´äº¤æ¢ä¿¡æ¯çš„éƒ¨ä»¶ã€‚</li><li>é€šé“æœ‰ä¸“ç”¨çš„é€šé“æŒ‡ä»¤ï¼Œèƒ½ç‹¬ç«‹åœ°æ‰§è¡Œç”¨é€šé“æŒ‡ä»¤æ‰€ç¼–å†™çš„è¾“å…¥è¾“å‡ºç¨‹åºï¼Œæ˜¯ä»å±äºCPUçš„ä¸€ä¸ªä¸“ç”¨å¤„ç†å™¨ã€‚</li><li>ä¾èµ–é€šé“ç®¡ç†çš„I&#x2F;Oè®¾å¤‡åœ¨ä¸ä¸»æœºäº¤æ¢ä¿¡æ¯æ—¶ï¼ŒCPUä¸ç›´æ¥å‚ä¸ç®¡ç†ï¼Œæ•…æé«˜äº†CPUçš„èµ„æºåˆ©ç”¨ç‡ã€‚</li></ul><p><strong>ï¼ˆ4ï¼‰å…·æœ‰I&#x2F;Oå¤„ç†æœºçš„é˜¶æ®µ</strong></p><p>è¾“å…¥è¾“å‡ºç³»ç»Ÿå‘å±•åˆ°ç¬¬å››é˜¶æ®µï¼Œå‡ºç°äº†I&#x2F;Oå¤„ç†æœºï¼š</p><ul><li>I&#x2F;Oå¤„ç†æœºåˆç§°ä¸ºå¤–å›´å¤„ç†æœº(Peripheral Processor)ï¼›</li><li>å®ƒåŸºæœ¬ç‹¬ç«‹äºä¸»æœºå·¥ä½œï¼Œæ—¢å¯å®ŒæˆI&#x2F;Oé€šé“è¦å®Œæˆçš„I&#x2F;Oæ§åˆ¶ï¼Œåˆå¯å®Œæˆç åˆ¶å˜æ¢ã€æ ¼å¼å¤„ç†ã€æ•°æ®å—æ£€é”™ã€çº é”™ç­‰æ“ä½œã€‚</li><li>å…·æœ‰I&#x2F;Oå¤„ç†æœºçš„è¾“å…¥è¾“å‡ºç³»ç»Ÿä¸CPUå·¥ä½œçš„å¹¶è¡Œæ€§æ›´é«˜ï¼Œè¿™è¯´æ˜I&#x2F;Oç³»ç»Ÿå¯¹ä¸»æœºæ¥è¯´å…·æœ‰æ›´å¤§çš„ç‹¬ç«‹æ€§ã€‚</li></ul><h3 id="1-2-è¾“å…¥è¾“å‡ºç³»ç»Ÿçš„ç»„æˆ"><a href="#1-2-è¾“å…¥è¾“å‡ºç³»ç»Ÿçš„ç»„æˆ" class="headerlink" title="1.2 è¾“å…¥è¾“å‡ºç³»ç»Ÿçš„ç»„æˆ"></a>1.2 è¾“å…¥è¾“å‡ºç³»ç»Ÿçš„ç»„æˆ</h3><p>è¾“å…¥è¾“å‡ºç³»ç»Ÿï¼š</p><ul><li>I&#x2F;Oè½¯ä»¶</li><li>I&#x2F;Oç¡¬ä»¶</li></ul><p><strong>ï¼ˆ1ï¼‰I&#x2F;O è½¯ä»¶</strong></p><p>è¾“å…¥è¾“å‡ºç³»ç»Ÿè½¯ä»¶çš„ä¸»è¦ä»»åŠ¡å¦‚ä¸‹ï¼š</p><ul><li>å°†ç”¨æˆ·ç¼–åˆ¶çš„ç¨‹åºï¼ˆæˆ–æ•°æ®ï¼‰è¾“å…¥ä¸»æœºå†…ã€‚</li><li>å°†è¿ç®—ç»“æœè¾“é€ç»™ç”¨æˆ·ã€‚</li><li>å®ç°è¾“å…¥è¾“å‡ºç³»ç»Ÿä¸ä¸»æœºå·¥ä½œçš„åè°ƒç­‰ã€‚</li></ul><p>ç»„æˆï¼š</p><ul><li>I&#x2F;OæŒ‡ä»¤ï¼šæœºå™¨æŒ‡ä»¤çš„ä¸€ç±»ï¼Œå…¶è®¾å¤‡ç ç›¸å½“äºè®¾å¤‡çš„åœ°å€ï¼Œç”¨äºé€‰æ‹©æŸå°è®¾å¤‡ä¸ä¸»æœºäº¤æ¢ä¿¡æ¯ã€‚</li><li>é€šé“æŒ‡ä»¤ï¼šåˆç§°ä¸ºé€šé“æ§åˆ¶å­—(Channel Control Word,CCW)ï¼Œæ˜¯é€šé“è‡ªèº«çš„æŒ‡ä»¤ï¼Œç”¨æ¥æ‰§è¡ŒI&#x2F;Oæ“ä½œï¼Œå¦‚è¯»ã€å†™ã€ç£å¸¦èµ°å¸¦åŠç£ç›˜æ‰¾é“ç­‰ã€‚</li></ul><p><strong>ï¼ˆ2ï¼‰I&#x2F;O ç¡¬ä»¶</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/cff0204f4b7149fab529243358674241.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><p>è¾“å…¥è¾“å‡ºç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆæ˜¯å¤šç§å¤šæ ·çš„ï¼Œåœ¨å¸¦æœ‰æ¥å£çš„I&#x2F;Oç³»ç»Ÿä¸­ï¼Œä¸€èˆ¬åŒ…æ‹¬ï¼š</p><ul><li>æ¥å£æ¨¡å—</li><li>I&#x2F;Oè®¾å¤‡</li></ul><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ul><li>å…·æœ‰é€šé“çš„I&#x2F;Oç³»ç»Ÿï¼›</li><li>ä¸€ä¸ªé€šé“å¯ä»¥å’Œä¸€ä¸ªä»¥ä¸Šçš„è®¾å¤‡æ§åˆ¶å™¨ç›¸è¿ï¼Œä¸€ä¸ªè®¾å¤‡æ§åˆ¶å™¨åˆå¯ä»¥æ§åˆ¶è‹¥å¹²å°åŒä¸€ç±»å‹çš„è®¾å¤‡ã€‚</li></ul><h3 id="1-3-I-x2F-Oè®¾å¤‡ä¸ä¸»æœºçš„è”ç³»æ–¹å¼"><a href="#1-3-I-x2F-Oè®¾å¤‡ä¸ä¸»æœºçš„è”ç³»æ–¹å¼" class="headerlink" title="1.3 I&#x2F;Oè®¾å¤‡ä¸ä¸»æœºçš„è”ç³»æ–¹å¼"></a>1.3 I&#x2F;Oè®¾å¤‡ä¸ä¸»æœºçš„è”ç³»æ–¹å¼</h3><p>I&#x2F;O è®¾å¤‡ä¸ä¸»æœºäº¤æ¢ä¿¡æ¯æ—¶ï¼Œå…±æœ‰5ç§æ§åˆ¶æ–¹å¼ï¼š</p><ul><li>ç¨‹åºæŸ¥è¯¢æ–¹å¼ï¼šç¨‹åºæŸ¥è¯¢æ–¹å¼æ˜¯ç”±CPUé€šè¿‡ç¨‹åºä¸æ–­æŸ¥è¯¢I&#x2F;Oè®¾å¤‡æ˜¯å¦å·²åšå¥½å‡†å¤‡ï¼Œä»è€Œæ§åˆ¶I&#x2F;Oè®¾å¤‡ä¸ä¸»æœºäº¤æ¢ä¿¡æ¯ã€‚</li><li>ç¨‹åºä¸­æ–­æ–¹å¼ï¼šå½“I&#x2F;Oè®¾å¤‡å‡†å¤‡å°±ç»ªå¹¶å‘ CPUå‘å‡ºä¸­æ–­è¯·æ±‚åæ‰äºˆä»¥å“åº”ã€‚</li><li>ç›´æ¥å­˜å‚¨å™¨å­˜å–æ–¹å¼(DMA)ï¼šä¸»å­˜ä¸I&#x2F;Oè®¾å¤‡ä¹‹é—´æœ‰ä¸€æ¡æ•°æ®é€šè·¯ï¼Œä¸»å­˜ä¸I&#x2F;0è®¾å¤‡äº¤æ¢ä¿¡æ¯æ—¶ï¼Œæ— é¡»è°ƒç”¨ä¸­æ–­æœåŠ¡ç¨‹åºã€‚</li><li>I&#x2F;O é€šé“æ–¹å¼ï¼›</li><li>I&#x2F;Oå¤„ç†æœºæ–¹å¼ã€‚</li></ul><h2 id="2-I-x2F-Oè®¾å¤‡"><a href="#2-I-x2F-Oè®¾å¤‡" class="headerlink" title="2.I&#x2F;Oè®¾å¤‡"></a>2.I&#x2F;Oè®¾å¤‡</h2><h3 id="2-1-I-x2F-Oè®¾å¤‡æ¦‚è¿°"><a href="#2-1-I-x2F-Oè®¾å¤‡æ¦‚è¿°" class="headerlink" title="2.1 I&#x2F;Oè®¾å¤‡æ¦‚è¿°"></a>2.1 I&#x2F;Oè®¾å¤‡æ¦‚è¿°</h3><p>I&#x2F;Oè®¾å¤‡å¤§è‡´å¯åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li>äººæœºäº¤äº’è®¾å¤‡ï¼šÂ·å®ç°æ“ä½œè€…ä¸è®¡ç®—æœºä¹‹é—´äº’ç›¸äº¤æµä¿¡æ¯çš„è®¾å¤‡ã€‚</li><li>è®¡ç®—æœºä¿¡æ¯çš„å­˜å‚¨è®¾å¤‡ï¼šç³»ç»Ÿè½¯ä»¶å’Œå„ç§è®¡ç®—æœºçš„æœ‰ç”¨ä¿¡æ¯ï¼Œå…¶ä¿¡æ¯é‡æå¤§ï¼Œéœ€å­˜å‚¨ä¿ç•™èµ·æ¥ã€‚</li><li>æœºâ€”â€”æœºé€šä¿¡è®¾å¤‡ï¼šå®ç°ä¸€å°è®¡ç®—æœºä¸å…¶ä»–è®¡ç®—æœºæˆ–ä¸å…¶ä»–ç³»ç»Ÿä¹‹é—´å®Œæˆé€šä¿¡ä»»åŠ¡çš„è®¾å¤‡ã€‚</li></ul><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/dcc5b2d6616f4681ae293a882871ea68.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 40%;"><p>ä¸‹é¢æ˜¯ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ä¸­çš„â€œä¸€ä¸ªå…¸å‹ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆâ€</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/image-20230520203459094-1684586104268-1.png" alt="image-20230520203459094" style="zoom:80%;"><p>æ¯ä¸€ä¸ªI&#x2F;Oæ¶‰ç¬”éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªæ§åˆ¶å™¨æˆ–é€‚é…å™¨ä¸I&#x2F;Oæ€»çº¿è¿æ¥èµ·æ¥è€³æœµã€‚æ§åˆ¶å™¨å’Œé€‚é…å™¨çš„åŒºåˆ«åœ¨äºä»–ä»¬çš„ç»„æˆæ–¹å¼ã€‚æ§åˆ¶å™¨æ˜¯I&#x2F;Oè®¾å¤‡æœ¬èº«ä¸­æˆ–æ˜¯ç³»ç»Ÿçš„ä¸»å°åˆ·ç”µè·¯ï¼ˆé€šå¸¸ç§°ä¸ºä¸»æ¿ï¼‰ä¸Šçš„èŠ¯ç‰‡ç»„ï¼Œè€Œé€‚é…å™¨åˆ™æ˜¯ä¸€å—æ’åœ¨ä¸»æ¿æ’æ§½ä¸Šçš„å¡ã€‚æ— è®ºå¦‚ä½•ï¼Œä»–ä»¬çš„åŠŸèƒ½å¦æ˜¯åœ¨I&#x2F;Oæ€»çº¿å’ŒI&#x2F;Oè®¾å¤‡ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚</p><blockquote><p>ä»¥å›¾å½¢é€‚é…å™¨ä¸ºä¾‹ï¼Œè¯´çš„å…¶å®å°±æ˜¯æ˜¾å¡ã€‚æ˜¾å¡å…¨ç§°æ˜¾ç¤ºæ¥å£å¡ï¼Œåˆç§°æ˜¾ç¤ºé€‚é…å™¨ã€‚</p></blockquote><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹æ¨ä¸€æ¶›è€å¸ˆåœ¨æ“ä½œç³»ç»Ÿè¯¾ç¨‹è®²è§£çš„å›¾ç‰‡</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/1684586383766-3.png" alt="img" style="zoom: 67%;"><h3 id="2-2-è¾“å…¥è®¾å¤‡"><a href="#2-2-è¾“å…¥è®¾å¤‡" class="headerlink" title="2.2 è¾“å…¥è®¾å¤‡"></a>2.2 è¾“å…¥è®¾å¤‡</h3><p>è¾“å…¥è®¾å¤‡å®Œæˆè¾“å…¥ç¨‹åºã€æ•°æ®å’Œæ“ä½œå‘½ä»¤ç­‰åŠŸèƒ½ï¼š</p><ul><li>é”®ç›˜ï¼šé€šè¿‡é”®ç›˜ä¸Šçš„å„ä¸ªé”®ï¼ŒæŒ‰æŸç§è§„èŒƒå‘ä¸»æœºè¾“å…¥å„ç§ä¿¡æ¯ï¼Œå¦‚æ±‰å­—ã€å¤–æ–‡ã€æ•°å­—ç­‰ã€‚</li><li>é¼ æ ‡ï¼šæ‰‹æŒå¼çš„å®šä½è®¾å¤‡ï¼Œç”±äºå®ƒæ‹–ç€ä¸€æ ¹é•¿çº¿ä¸æ¥å£ç›¸è¿ï¼Œå¤–å½¢æœ‰ç‚¹åƒè€é¼ ï¼Œæ•…å–åä¸ºé¼ æ ‡ã€‚</li><li>è§¦æ‘¸å±ï¼šæ˜¯ä¸€ç§å¯¹ç‰©ä½“çš„æ¥è§¦æˆ–é è¿‘èƒ½äº§ç”Ÿååº”çš„å®šä½è®¾å¤‡ã€‚æŒ‰åŸç†çš„ä¸åŒï¼Œè§¦æ‘¸å±å¤§è‡´å¯åˆ†ä¸º5ç±»ï¼šç”µé˜»å¼ã€ç”µå®¹å¼ã€è¡¨é¢è¶…å£°æ³¢å¼ã€æ‰«æçº¢å¤–çº¿å¼å’Œå‹æ„Ÿå¼ã€‚</li><li>å…¶ä»–è¾“äººè®¾å¤‡ï¼š<ul><li>å…‰ç¬”ï¼šå¤–å½¢ä¸é’¢ç¬”ç›¸ä¼¼ï¼Œå¤´éƒ¨è£…æœ‰ä¸€ä¸ªé€é•œç³»ç»Ÿï¼Œèƒ½æŠŠè¿›å…¥çš„å…‰ä¼šèšæˆä¸€ä¸ªå…‰ç‚¹ã€‚å…‰ç¬”çš„åç«¯ç”¨å¯¼çº¿è¿åˆ°è®¡ç®—æœºè¾“å…¥ç”µè·¯ä¸Šã€‚</li><li>ç”»ç¬”ä¸å›¾å½¢æ¿ï¼šç”»ç¬”(Stylus)åŒæ ·ä¸ºç¬”çŠ¶ï¼Œä½†å¿…é¡»é…åˆå›¾å½¢æ¿(Tablet)ä½¿ç”¨ã€‚</li><li>å›¾åƒè¾“å…¥è®¾å¤‡ï¼šæœ€ç›´æ¥çš„å›¾åƒè¾“å…¥è®¾å¤‡æ˜¯æ‘„åƒæœº(Camera)ï¼Œå®ƒèƒ½è¢«æ‹æ‘„ç‰©ç»æ•°å­—é‡åŒ–åå˜æˆæ•°å­—å›¾åƒå­˜å…¥ç£å¸¦æˆ–ç£ç›˜ã€‚</li></ul></li></ul><h3 id="2-3-è¾“å‡ºè®¾å¤‡"><a href="#2-3-è¾“å‡ºè®¾å¤‡" class="headerlink" title="2.3 è¾“å‡ºè®¾å¤‡"></a>2.3 è¾“å‡ºè®¾å¤‡</h3><h4 id="2-3-1-æ˜¾ç¤ºè®¾å¤‡"><a href="#2-3-1-æ˜¾ç¤ºè®¾å¤‡" class="headerlink" title="2.3.1 æ˜¾ç¤ºè®¾å¤‡"></a>2.3.1 æ˜¾ç¤ºè®¾å¤‡</h4><hr><ul><li>å­—ç¬¦æ˜¾ç¤ºå™¨ï¼š<ul><li>æ˜¾ç¤ºå­˜å‚¨å™¨ï¼ˆåˆ·æ–°å­˜å‚¨å™¨ï¼‰VRAMï¼šæ˜¾ç¤ºå­˜å‚¨å™¨å­˜æ”¾æ¬²æ˜¾ç¤ºå­—ç¬¦çš„ASCIIç ï¼Œå…¶å®¹é‡ä¸æ˜¾ç¤ºå±èƒ½æ˜¾ç¤ºçš„å­—ç¬¦ä¸ªæ•°æœ‰å…³ã€‚</li><li>å­—ç¬¦å‘ç”Ÿå™¨ï¼šå°†æ¯ä¸ªASCIIå­—ç¬¦ç è½¬å˜ä¸ºä¸€ç»„5Ã—7æˆ–7Ã—9çš„å…‰ç‚¹çŸ©é˜µä¿¡æ¯ã€‚</li><li>CRTæ§åˆ¶å™¨ï¼šå¯æ¥æ”¶æ¥è‡ªCPUçš„æ•°æ®å’Œæ§åˆ¶ä¿¡å·ï¼Œå¹¶ç»™å‡ºè®¿é—®æ˜¾ç¤ºå­˜å‚¨å™¨çš„åœ°å€å’Œè®¿é—®å­—ç¬¦å‘ç”Ÿå™¨çš„å…‰æ …åœ°å€ï¼Œè¿˜èƒ½ç»™å‡ºCRTæ‰€éœ€çš„æ°´å¹³åŒæ­¥å’Œå‚ç›´åŒæ­¥ä¿¡å·ã€‚</li></ul></li><li>å›¾å½¢æ˜¾ç¤ºå™¨ï¼šå›¾å½¢æ˜¾ç¤ºå™¨æ˜¯ç”¨ç‚¹ã€çº¿ï¼ˆç›´çº¿å’Œæ›²çº¿ï¼‰ã€é¢ï¼ˆå¹³é¢å’Œæ›²é¢ï¼‰ç»„åˆæˆå¹³é¢æˆ–ç«‹ä½“å›¾å½¢çš„æ˜¾ç¤ºè®¾å¤‡ï¼›</li><li>å›¾åƒæ˜¾ç¤ºå™¨ï¼šå›¾å½¢æ˜¾ç¤ºå™¨æ‰€æ˜¾ç¤ºçš„å›¾å½¢æ˜¯ç”±è®¡ç®—æœºç”¨ä¸€å®šçš„ç®—æ³•å½¢æˆçš„ç‚¹ã€çº¿ã€é¢ã€é˜´å½±ç­‰ï¼Œæ¥è‡ªä¸»è§‚ä¸–ç•Œï¼Œæ•…åˆç§°ä¸ºä¸»è§‚å›¾åƒæˆ–è®¡ç®—æœºå›¾åƒã€‚</li><li>IBM PCç³»åˆ—å¾®å‹è®¡ç®—æœºçš„æ˜¾ç¤ºæ ‡å‡†ï¼š<ul><li>MDA(Monochrome Display Adapter)æ ‡å‡†ï¼š MDAæ˜¯å•è‰²å­—ç¬¦æ˜¾ç¤ºæ ‡å‡†ï¼Œé‡‡ç”¨9Ã—14ç‚¹é˜µçš„å­—ç¬¦çª—å£ï¼Œæ»¡å±æ˜¾ç¤º80åˆ—ã€25è¡Œå­—ç¬¦ï¼Œå¯¹åº”åˆ†è¾¨ç‡ä¸º720Ã—350åƒç´ ã€‚MDAä¸èƒ½å…¼å®¹å›¾å½¢æ˜¾ç¤ºã€‚</li><li>CGA(Color Graphics Adapter)æ ‡å‡†ï¼š CGAæ˜¯å½©è‰²å›¾å½¢&#x2F;å­—ç¬¦æ˜¾ç¤ºæ ‡å‡†ï¼Œå¯å…¼å®¹å­—ç¬¦å’Œå›¾å½¢ä¸¤ç§æ˜¾ç¤ºæ–¹å¼ã€‚åœ¨å­—ç¬¦æ–¹å¼ä¸‹ï¼Œå­—ç¬¦çª—å£ä¸º8Ã—8ç‚¹é˜µï¼Œæ•…å­—ç¬¦è´¨é‡ä¸å¦‚MDA,ä½†å­—ç¬¦çš„èƒŒæ™¯å¯ä»¥é€‰æ‹©é¢œè‰²ã€‚</li><li>EGA(Enhanced Graphics Adapter)æ ‡å‡†ï¼š EGAæ ‡å‡†é›†ä¸­äº†MDAå’ŒCGAä¸¤ä¸ªæ˜¾ç¤ºæ ‡å‡†çš„ä¼˜ç‚¹ï¼Œå¹¶æœ‰æ‰€å¢å¼ºã€‚å…¶å­—ç¬¦çª—å£ä¸º8Ã—14ç‚¹é˜µï¼Œå­—ç¬¦æ˜¾ç¤ºè´¨é‡ä¼˜äºCGAè€Œæ¥è¿‘MDAã€‚</li><li>VGA(Video Graphics Array)æ ‡å‡†ï¼š VGAæ ‡å‡†åœ¨å­—ç¬¦æ–¹å¼ä¸‹ï¼Œå­—ç¬¦çª—å£ä¸º9Ã—16ç‚¹é˜µï¼Œåœ¨å›¾å½¢æ–¹å¼ä¸‹åˆ†è¾¨ç‡ä¸º640Ã—480åƒç´ ã€ 16ç§é¢œè‰²ï¼Œæˆ–320Ã—200åƒç´ ã€256ç§é¢œè‰²ï¼Œè¿˜æœ‰720Ã—400åƒç´ çš„æ–‡æœ¬æ¨¡å¼ã€‚</li></ul></li></ul><h4 id="2-3-2-æ‰“å°è®¾å¤‡"><a href="#2-3-2-æ‰“å°è®¾å¤‡" class="headerlink" title="2.3.2 æ‰“å°è®¾å¤‡"></a>2.3.2 æ‰“å°è®¾å¤‡</h4><hr><ul><li>ç‚¹é˜µé’ˆå¼æ‰“å°æœºï¼šç»“æ„ç®€å•ã€ä½“ç§¯å°ã€é‡é‡è½»ã€ä»·æ ¼ä½ã€å­—ç¬¦ç§ç±»ä¸å—é™åˆ¶ã€è¾ƒæ˜“å®ç°æ±‰å­—æ‰“å°ï¼Œè¿˜å¯æ‰“å°å›¾å½¢å’Œå›¾åƒã€‚</li><li>æ¿€å…‰æ‰“å°æœºï¼šé‡‡ç”¨äº†æ¿€å…‰æŠ€æœ¯å’Œç…§ç›¸æŠ€æœ¯ï¼Œå°å­—è´¨é‡å¥½ï¼Œåº”ç”¨å¹¿æ³›ã€‚</li><li>å–·å¢¨æ‰“å°æœºï¼šæ˜¯ä¸²è¡Œéå‡»æ‰“å¼æ‰“å°æœºï¼Œå°å­—åŸç†æ˜¯å°†å¢¨æ°´å–·å°„åˆ°æ™®é€šæ‰“å°çº¸ä¸Šã€‚è‹¥é‡‡ç”¨çº¢ã€ç»¿ã€è“ä¸‰è‰²å–·å¢¨å¤´ï¼Œä¾¿å¯å®ç°å½©è‰²æ‰“å°ã€‚</li></ul><h2 id="3-I-x2F-Oæ¥å£"><a href="#3-I-x2F-Oæ¥å£" class="headerlink" title="3.I&#x2F;Oæ¥å£"></a>3.I&#x2F;Oæ¥å£</h2><h3 id="3-1-I-x2F-Oæ¥å£æ¦‚è¿°"><a href="#3-1-I-x2F-Oæ¥å£æ¦‚è¿°" class="headerlink" title="3.1 I&#x2F;Oæ¥å£æ¦‚è¿°"></a>3.1 I&#x2F;Oæ¥å£æ¦‚è¿°</h3><p>æ¥å£å¯ä»¥çœ‹åšæ˜¯ä¸¤ä¸ªç³»ç»Ÿæˆ–ä¸¤ä¸ªéƒ¨ä»¶ä¹‹é—´çš„äº¤æ¥éƒ¨åˆ†ï¼Œå®ƒ<strong>æ—¢å¯ä»¥æ˜¯ä¸¤ç§ç¡¬è®¾å¤‡ä¹‹é—´çš„è¿æ¥ç”µè·¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸¤ä¸ªè½¯ä»¶ä¹‹é—´çš„å…±åŒé€»è¾‘è¾¹ç•Œã€‚</strong></p><p>è®¾ç½®æ¥å£ç†ç”±å¦‚ä¸‹ï¼š</p><ul><li>ä¸€å°æœºå™¨é€šå¸¸é…æœ‰å¤šå°I&#x2F;Oè®¾å¤‡ï¼Œå®ƒä»¬å„è‡ªæœ‰è®¾å¤‡å·ï¼ˆåœ°å€ï¼‰ï¼Œé€šè¿‡æ¥å£å¯å®ç°I&#x2F;0è®¾å¤‡çš„é€‰æ‹©ã€‚</li><li>I&#x2F;Oè®¾å¤‡ç§ç±»ç¹å¤šï¼Œé€Ÿåº¦ä¸ä¸€ï¼Œä¸CPUé€Ÿåº¦ç›¸å·®å¯èƒ½å¾ˆå¤§ï¼Œé€šè¿‡æ¥å£å¯å®ç°æ•°æ®ç¼“å†².</li><li>æœ‰äº›I&#x2F;Oè®¾å¤‡å¯èƒ½ä¸²è¡Œä¼ é€æ•°æ®ï¼Œè€ŒCPUä¸€èˆ¬ä¸ºå¹¶è¡Œä¼ é€ï¼Œé€šè¿‡æ¥å£å¯å®ç°æ•°æ®ä¸²â€”â€”å¹¶æ ¼å¼çš„è½¬æ¢ã€‚</li><li>I&#x2F;Oè®¾å¤‡çš„è¾“äººè¾“å‡ºç”µå¹³å¯èƒ½ä¸CPUçš„è¾“å…¥è¾“å‡ºç”µå¹³ä¸åŒï¼Œé€šè¿‡æ¥å£å¯å®ç°ç”µå¹³è½¬æ¢ã€‚</li><li>CPUå¯åŠ¨I&#x2F;Oè®¾å¤‡å·¥ä½œï¼Œè¦å‘I&#x2F;Oè®¾å¤‡å‘å„ç§æ§åˆ¶ä¿¡å·ï¼Œé€šè¿‡æ¥å£å¯ä¼ é€æ§åˆ¶å‘½ä»¤ã€‚</li><li>I&#x2F;Oè®¾å¤‡éœ€å°†å…¶å·¥ä½œçŠ¶æ€åŠæ—¶å‘CPUæŠ¥å‘Šï¼Œé€šè¿‡æ¥å£å¯ç›‘è§†è®¾å¤‡çš„å·¥ä½œçŠ¶æ€ï¼Œå¹¶å¯ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼Œä¾›CPUæŸ¥è¯¢ã€‚</li></ul><h3 id="3-2-æ¥å£çš„åŠŸèƒ½å’Œç»„æˆ"><a href="#3-2-æ¥å£çš„åŠŸèƒ½å’Œç»„æˆ" class="headerlink" title="3.2 æ¥å£çš„åŠŸèƒ½å’Œç»„æˆ"></a>3.2 æ¥å£çš„åŠŸèƒ½å’Œç»„æˆ</h3><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/fa24e287e4d14e29bc4f22bfb527a47a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:60%;"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºä¸ºæ€»çº¿ç»“æ„çš„è®¡ç®—æœºï¼Œæ¯ä¸€å°I&#x2F;Oè®¾å¤‡éƒ½æ˜¯é€šè¿‡I&#x2F;Oæ¥å£æŒ‚åˆ°ç³»ç»Ÿæ€»çº¿ä¸Šçš„ã€‚å›¾ä¸­çš„I&#x2F;Oæ€»çº¿åŒ…æ‹¬æ•°æ®çº¿ã€è®¾å¤‡é€‰æ‹©çº¿ã€å‘½ä»¤çº¿å’ŒçŠ¶æ€çº¿ã€‚</p><p>æ ¹æ®ä¸Šè¿°è®¾ç½®æ¥å£çš„ç†ç”±ï¼Œå¯å½’çº³å‡ºæ¥å£é€šå¸¸åº”å…·æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ä»¥åŠç›¸åº”çš„ç¡¬ä»¶é…ç½®ï¼š</p><ul><li>é€‰å€åŠŸèƒ½ï¼šå½“è®¾å¤‡é€‰æ‹©çº¿ä¸Šçš„è®¾å¤‡ç ä¸æœ¬è®¾å¤‡ç ç›¸ç¬¦æ—¶ï¼Œåº”å‘å‡ºè®¾å¤‡é€‰ä¸­ä¿¡å·SELï¼›</li><li>ä¼ é€å‘½ä»¤çš„åŠŸèƒ½ï¼šé€šå¸¸åœ¨I&#x2F;Oæ¥å£ä¸­è®¾æœ‰å­˜æ”¾å‘½ä»¤çš„å‘½ä»¤å¯„å­˜å™¨ä»¥åŠå‘½ä»¤è¯‘ç å™¨ï¼Œæ¥å¯¹CPUçš„å‘½ä»¤è¿›è¡Œå“åº”ã€‚</li><li>ä¼ é€æ•°æ®çš„åŠŸèƒ½ï¼šæ¥å£ä¸­é€šå¸¸è®¾æœ‰æ•°æ®ç¼“å†²å¯„å­˜å™¨(Data Buffer Register,DBR)ï¼Œå®ƒç”¨æ¥æš‚å­˜I&#x2F;Oè®¾å¤‡ä¸ä¸»æœºå‡†å¤‡äº¤æ¢çš„ä¿¡æ¯ï¼Œä¸I&#x2F;Oæ€»çº¿ä¸­çš„æ•°æ®çº¿æ˜¯ç›¸è¿çš„ã€‚</li><li>åæ˜ I&#x2F;0è®¾å¤‡å·¥ä½œçŠ¶æ€çš„åŠŸèƒ½ï¼šä¸ºäº†ä½¿CPUèƒ½åŠæ—¶äº†è§£å„I&#x2F;Oè®¾å¤‡çš„å·¥ä½œçŠ¶æ€ï¼Œæ¥å£å†…å¿…é¡»è®¾ç½®ä¸€äº›åæ˜ è®¾å¤‡å·¥ä½œçŠ¶æ€çš„è§¦å‘å™¨ã€‚</li></ul><h3 id="3-3-æ¥å£ç±»å‹"><a href="#3-3-æ¥å£ç±»å‹" class="headerlink" title="3.3 æ¥å£ç±»å‹"></a>3.3 æ¥å£ç±»å‹</h3><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/4439606cc51d4233a82533a8a4638525.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><ul><li>æŒ‰æ•°æ®ä¼ é€æ–¹å¼åˆ†ç±»ï¼š<ul><li>å¹¶è¡Œæ¥å£ï¼šå°†ä¸€ä¸ªå­—èŠ‚ï¼ˆæˆ–ä¸€ä¸ªå­—ï¼‰çš„æ‰€æœ‰ä½åŒæ—¶ä¼ é€ï¼›</li><li>ä¸²è¡Œæ¥å£ï¼šåœ¨è®¾å¤‡ä¸æ¥å£é—´ä¸€ä½ä¸€ä½ä¼ é€ï¼Œç”±äºæ¥å£ä¸ä¸»æœºä¹‹é—´æ˜¯æŒ‰å­—èŠ‚æˆ–å­—å¹¶è¡Œä¼ é€ï¼Œå› æ­¤å¯¹ä¸²è¡Œæ¥å£è€Œè¨€ï¼Œå…¶å†…éƒ¨è¿˜å¿…é¡»è®¾æœ‰ä¸²â€”â€”å¹¶è½¬æ¢è£…ç½®ã€‚</li></ul></li><li>æŒ‰åŠŸèƒ½é€‰æ‹©çš„çµæ´»æ€§åˆ†ç±»ï¼š<ul><li>å¯ç¼–ç¨‹æ¥å£ï¼šå…¶åŠŸèƒ½åŠæ“ä½œæ–¹å¼å¯ç”¨ç¨‹åºæ¥æ”¹å˜æˆ–é€‰æ‹©ï¼›</li><li>ä¸å¯ç¼–ç¨‹æ¥å£ï¼šä¸èƒ½ç”±ç¨‹åºæ¥æ”¹å˜å…¶åŠŸèƒ½ï¼Œä½†å¯é€šè¿‡ç¡¬è¿çº¿é€»è¾‘æ¥å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚</li></ul></li><li>æŒ‰é€šç”¨æ€§åˆ†ç±»ï¼š<ul><li>é€šç”¨æ¥å£ï¼šå¯ä¾›å¤šç§I&#x2F;Oè®¾å¤‡ä½¿ç”¨ï¼›</li><li>ä¸“ç”¨æ¥å£ï¼šä¸ºæŸç±»å¤–è®¾æˆ–æŸç§ç”¨é€”ä¸“é—¨è®¾è®¡çš„ã€‚</li></ul></li><li>æŒ‰æ•°æ®ä¼ é€çš„æ§åˆ¶æ–¹å¼åˆ†ç±»ï¼š<ul><li>ç¨‹åºå‹æ¥å£ï¼šç”¨äºè¿æ¥é€Ÿåº¦è¾ƒæ…¢çš„I&#x2F;Oè®¾å¤‡ï¼Œå¦‚æ˜¾ç¤ºç»ˆç«¯ã€é”®ç›˜ã€æ‰“å°æœºç­‰ï¼›</li><li>DMAå‹æ¥å£ï¼šç”¨äºè¿æ¥é«˜é€ŸI&#x2F;0è®¾å¤‡ï¼Œå¦‚ç£ç›˜ã€ç£å¸¦ç­‰ã€‚</li></ul></li></ul><h2 id="4-ç¨‹åºä¸­æ–­æ–¹å¼"><a href="#4-ç¨‹åºä¸­æ–­æ–¹å¼" class="headerlink" title="4.ç¨‹åºä¸­æ–­æ–¹å¼"></a>4.ç¨‹åºä¸­æ–­æ–¹å¼</h2><h3 id="4-1-I-x2F-Oä¸­æ–­çš„æ¦‚å¿µ"><a href="#4-1-I-x2F-Oä¸­æ–­çš„æ¦‚å¿µ" class="headerlink" title="4.1 I&#x2F;Oä¸­æ–­çš„æ¦‚å¿µ"></a>4.1 I&#x2F;Oä¸­æ–­çš„æ¦‚å¿µ</h3><p><strong>ä¸­æ–­</strong>ï¼šè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œå½“å‡ºç°å¼‚å¸¸æƒ…å†µæˆ–ç‰¹æ®Šè¯·æ±‚æ—¶ï¼Œè®¡ç®—æœºåœæ­¢ç°è¡Œç¨‹åºçš„è¿è¡Œï¼Œè½¬å‘å¯¹è¿™äº›å¼‚å¸¸æƒ…å†µæˆ–ç‰¹æ®Šè¯·æ±‚çš„å¤„ç†ï¼Œå¤„ç†ç»“æŸåå†è¿”å›åˆ°ç°è¡Œç¨‹åºçš„é—´æ–­å¤„ï¼Œç»§ç»­æ‰§è¡ŒåŸç¨‹åºã€‚</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/134f67493baa806ed044c2370cbfdd3d.png" alt="img" style="zoom:67%;"><h3 id="4-2-I-x2F-Oä¸­æ–­çš„äº§ç”Ÿ"><a href="#4-2-I-x2F-Oä¸­æ–­çš„äº§ç”Ÿ" class="headerlink" title="4.2 I&#x2F;Oä¸­æ–­çš„äº§ç”Ÿ"></a>4.2 I&#x2F;Oä¸­æ–­çš„äº§ç”Ÿ</h3><p>åœ¨I&#x2F;Oè®¾å¤‡ä¸ä¸»æœºäº¤æ¢ä¿¡æ¯æ—¶ï¼Œç”±äºè®¾å¤‡æœ¬èº«æœºç”µç‰¹æ€§çš„å½±å“ï¼Œå…¶å·¥ä½œé€Ÿåº¦è¾ƒä½ï¼Œä¸CPUæ— æ³•åŒ¹é…ï¼Œå› æ­¤ï¼ŒCPUå¯åŠ¨è®¾å¤‡åï¼Œå¾€å¾€éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰èƒ½å®ç°ä¸»æœºä¸I&#x2F;Oè®¾å¤‡ä¹‹é—´çš„ä¿¡æ¯äº¤æ¢ã€‚</p><p>å¦‚æœåœ¨è®¾å¤‡å‡†å¤‡çš„åŒæ—¶ï¼ŒCPUä¸ä½œæ— è°“çš„ç­‰å¾…ï¼Œè€Œç»§ç»­æ‰§è¡Œç°è¡Œç¨‹åºï¼Œ<strong>åªæœ‰å½“I&#x2F;Oè®¾å¤‡å‡†å¤‡å°±ç»ªå‘CPUæå‡ºè¯·æ±‚åï¼Œå†æš‚æ—¶ä¸­æ–­CPUç°è¡Œç¨‹åºè½¬å…¥I&#x2F;OæœåŠ¡ç¨‹åºï¼Œè¿™ä¾¿äº§ç”Ÿäº†I&#x2F;Oä¸­æ–­ã€‚</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/8c07a6229bc94849683b1ef307305055.png" alt="img" style="zoom:75%;"><h3 id="4-3-ç¨‹åºä¸­æ–­æ–¹å¼çš„æ¥å£ç”µè·¯"><a href="#4-3-ç¨‹åºä¸­æ–­æ–¹å¼çš„æ¥å£ç”µè·¯" class="headerlink" title="4.3 ç¨‹åºä¸­æ–­æ–¹å¼çš„æ¥å£ç”µè·¯"></a>4.3 ç¨‹åºä¸­æ–­æ–¹å¼çš„æ¥å£ç”µè·¯</h3><p>æœ¬æ–‡å…³äºç”µè·¯éƒ¨åˆ†ä¸åšç ”ç©¶ï¼Œæ•…çœç•¥</p><h2 id="5-DMAæ–¹å¼"><a href="#5-DMAæ–¹å¼" class="headerlink" title="5.DMAæ–¹å¼"></a>5.DMAæ–¹å¼</h2><h3 id="5-1-DMAç§‘æ™®"><a href="#5-1-DMAç§‘æ™®" class="headerlink" title="5.1 DMAç§‘æ™®"></a>5.1 DMAç§‘æ™®</h3><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ä¸€ç‚¹ï¼Œ<strong>MDAæ¥å£å°±æ˜¯ç¬¬3èŠ‚ä¸­æ‰€è¯´çš„I&#x2F;Oæ¥å£ä¸­çš„ä¸€ç§</strong>ã€‚</p><p>æœ‰ä¸€ç§ç‰¹æ®Šçš„IOæ¥å£-DMAæ¥å£ï¼Œå®ƒå¯ä»¥ç”¨DMAæ€»çº¿ä¸ä¸»å­˜ç›´æ¥ç›¸è¿ï¼Œåªè¦CPUå‘Šè¯‰DMAæ¥å£è¦æŠŠæ•°æ®å­˜åœ¨ä¸»å­˜ä¸­çš„å“ªä¸ªåœ°å€DMAæ¥å£å°±ä¼šæ ¹æ®åœ°å€æŠŠæ•°æ®æ”¾è¿›ä¸»å­˜ã€‚</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/image-20230521114406266.png" alt="image-20230521114406266" style="zoom:67%;"><p>å¯¹äºDMAæ¥å£è€Œè¨€ï¼ŒCPUè¿˜éœ€è¦å‘Šè¯‰å®ƒä¸»å­˜åœ°å€ï¼Œå¦‚æœæœ‰å¤šä¸ªDMAæ¥å£ï¼ŒCPUä¾æ—§ä¼šå¾ˆå¿™ç¢Œã€‚ä¸ºäº†è¿›ä¸€æ­¥è§£æ”¾CPUï¼Œ<strong>é€šé“</strong>å¯ä»¥æ¥æ›¿CPUåšä¸€äº›åŸºç¡€æ“ä½œã€‚</p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/image-20230521114538376.png" alt="image-20230521114538376" style="zoom:67%;"><p>å®ƒå°±åƒä¸€ä¸ªä½çº§CPUï¼Œæœ‰è‡ªå·±çš„æŒ‡ä»¤ç³»ç»Ÿâ€”â€”<strong>é€šé“æŒ‡ä»¤</strong>ï¼Œèƒ½å¤Ÿæ‰§è¡Œä¸€äº›æœ‰é™çš„æ“ä½œã€‚å½“å®ƒæ¥æ”¶åˆ°CPUå‘å‡ºçš„IOæŒ‡ä»¤åï¼Œå¯ä»¥æŒ‰ç…§è¦æ±‚å¯åŠ¨IOè®¾å¤‡ï¼Œæˆ–è€…æ‰§è¡Œé€šé“æŒ‡ä»¤â€”â€”å°±åƒCPUçš„å°å¼Ÿã€‚</p><h3 id="5-2-DMAçš„ç‰¹ç‚¹"><a href="#5-2-DMAçš„ç‰¹ç‚¹" class="headerlink" title="5.2 DMAçš„ç‰¹ç‚¹"></a>5.2 DMAçš„ç‰¹ç‚¹</h3><img src="https://img-blog.csdnimg.cn/img_convert/fbff124410ee60a4d3b5fa33c1c8b7ed.png" alt="img" style="zoom: 75%;"><p>ç”±å›¾ä¸­å¯è§ï¼Œç”±äº<strong>ä¸»å­˜å’ŒDMAæ¥å£ä¹‹é—´æœ‰ä¸€æ¡æ•°æ®é€šè·¯</strong>ï¼Œå› æ­¤ä¸»å­˜å’Œè®¾å¤‡äº¤æ¢ä¿¡æ¯æ—¶ï¼Œä¸é€šè¿‡CPUï¼Œä¹Ÿä¸éœ€è¦CPUæš‚åœç°è¡Œç¨‹åºä¸ºè®¾å¤‡æœåŠ¡ï¼Œçœå»äº†ä¿æŠ¤ç°åœºå’Œæ¢å¤ç°åœºï¼Œå› æ­¤å·¥ä½œé€Ÿåº¦æ¯”ç¨‹åºä¸­æ–­æ–¹å¼çš„å·¥ä½œé€Ÿåº¦é«˜ã€‚</p><p>åœ¨DMAæ–¹å¼ä¸­ï¼Œç”±äºDMAæ¥å£ä¸CPUå…±äº«ä¸»å­˜ï¼Œè¿™å°±æœ‰å¯èƒ½å‡ºç°ä¸¤è€…äº‰ç”¨ä¸»å­˜çš„å†²çªã€‚ä¸ºäº†æœ‰æ•ˆåœ°åˆ†æ—¶ä½¿ç”¨ä¸»å­˜ï¼Œé€šå¸¸DMAä¸ä¸»å­˜äº¤æ¢æ•°æ®æ—¶é‡‡ç”¨å¦‚ä¸‹ä¸‰ç§æ–¹æ³•ï¼š</p><p><strong>ï¼ˆ1ï¼‰åœæ­¢CPUè®¿é—®ä¸»å­˜</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/b50da7fe2155210fc105496e47127184.png" alt="img" style="zoom:67%;"><ul><li>æ–¹å¼ï¼šå½“å¤–è®¾è¦æ±‚ä¼ é€ä¸€æ‰¹æ•°æ®æ—¶ï¼Œç”±DMAæ¥å£å‘CPUå‘ä¸€ä¸ªåœæ­¢ä¿¡å·ï¼Œè¦æ±‚CPUæ”¾å¼ƒåœ°å€çº¿æ•°æ®çº¿å’Œæœ‰å…³æ§åˆ¶çº¿çš„ä½¿ç”¨æƒã€‚DMAæ¥å£è·å¾—æ€»çº¿æ§åˆ¶æƒåï¼Œå¼€å§‹è¿›è¡Œæ•°æ®ä¼ é€ï¼Œåœ¨æ•°æ®ä¼ é€ç»“æŸåï¼ŒDMAæ¥å£é€šçŸ¥CPUå¯ä»¥ä½¿ç”¨ä¸»å­˜ï¼Œå¹¶æŠŠæ€»çº¿æ§åˆ¶æƒäº¤å›ç»™CPUã€‚</li><li>ä¼˜ç‚¹ï¼šæ§åˆ¶ç®€å•ï¼Œé€‚ç”¨äºæ•°æ®ä¼ è¾“ç‡å¾ˆé«˜çš„I&#x2F;Oè®¾å¤‡å®ç°æˆç»„æ•°æ®çš„ä¼ é€ã€‚</li><li>ç¼ºç‚¹ï¼šDMAæ¥å£åœ¨è®¿é—®ä¸»å­˜æ—¶ï¼ŒCPUåŸºæœ¬ä¸Šå¤„äºä¸å·¥ä½œçŠ¶æ€æˆ–ä¿æŒåŸçŠ¶æ€ã€‚</li></ul><p><strong>ï¼ˆ2ï¼‰å‘¨æœŸæŒªç”¨ï¼ˆæˆ–å‘¨æœŸçªƒå–ï¼‰</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/cf3ecee8377f2043ddbbde12a780665e.png" alt="img" style="zoom:67%;"><ul><li>æ–¹å¼ï¼šåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæ¯å½“I&#x2F;Oè®¾å¤‡å‘å‡ºDMAè¯·æ±‚æ—¶ï¼ŒI&#x2F;Oè®¾å¤‡ä¾¿æŒªç”¨æˆ–çªƒå–æ€»çº¿å ç”¨æƒä¸€ä¸ªæˆ–å‡ ä¸ªä¸»å­˜å‘¨æœŸï¼Œè€ŒDMAä¸è¯·æ±‚æ—¶ï¼ŒCPUä»ç»§ç»­è®¿é—®ä¸»å­˜ã€‚</li><li>ä¼˜ç‚¹ï¼šè¿™ç§æ–¹å¼æ—¢å®ç°äº†I&#x2F;Oä¼ é€ï¼Œåˆè¾ƒå¥½åœ°å‘æŒ¥äº†ä¸»å­˜ä¸CPUçš„æ•ˆç‡ï¼Œæ˜¯ä¸€ç§å¹¿æ³›é‡‡ç”¨çš„æ–¹æ³•ã€‚</li><li>ç¼ºç‚¹ï¼šæ¯”è¾ƒé€‚åˆäºI&#x2F;Oè®¾å¤‡çš„è¯»&#x2F;å†™å‘¨æœŸå¤§äºä¸»å­˜å‘¨æœŸçš„æƒ…å†µï¼Œå…¶ä»–æƒ…å†µä¸æ¨èä½¿ç”¨ã€‚</li></ul><p><strong>ï¼ˆ3ï¼‰DMAå’ŒCPUäº¤æ›¿è®¿é—®</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/90cdfcdc9f8fd6dd18da25ddd3c15f60.png" alt="img" style="zoom: 67%;"><ul><li>æ–¹å¼ï¼šä¸éœ€è¦æ€»çº¿ä½¿ç”¨æƒçš„ç”³è¯·ã€å»ºç«‹å’Œå½’è¿˜è¿‡ç¨‹ï¼Œæ€»çº¿ä½¿ç”¨æƒæ˜¯é€šè¿‡C1å’ŒC2åˆ†åˆ«æ§åˆ¶çš„ã€‚ CPUä¸DMAæ¥å£å„è‡ªæœ‰ç‹¬ç«‹çš„è®¿å­˜åœ°å€å¯„å­˜å™¨ã€æ•°æ®å¯„å­˜å™¨å’Œè¯»&#x2F;å†™ä¿¡å·ã€‚</li><li>ä¼˜ç‚¹ï¼šCPUæ—¢ä¸åœæ­¢ä¸»ç¨‹åºçš„è¿è¡Œä¹Ÿä¸è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå³å®Œæˆäº† DMAçš„æ•°æ®ä¼ é€ï¼Œæ•ˆç‡è¾ƒé«˜ã€‚</li><li>ç¼ºç‚¹ï¼šç›¸åº”çš„ç¡¬ä»¶é€»è¾‘å¤æ‚ã€‚</li></ul><h3 id="5-3-DMAæ¥å£çš„åŠŸèƒ½å’Œç»„æˆ"><a href="#5-3-DMAæ¥å£çš„åŠŸèƒ½å’Œç»„æˆ" class="headerlink" title="5.3 DMAæ¥å£çš„åŠŸèƒ½å’Œç»„æˆ"></a>5.3 DMAæ¥å£çš„åŠŸèƒ½å’Œç»„æˆ</h3><h4 id="5-3-1-DMAæ¥å£åŠŸèƒ½"><a href="#5-3-1-DMAæ¥å£åŠŸèƒ½" class="headerlink" title="5.3.1 DMAæ¥å£åŠŸèƒ½"></a>5.3.1 DMAæ¥å£åŠŸèƒ½</h4><p>åˆ©ç”¨DMAæ–¹å¼ä¼ é€æ•°æ®æ—¶ï¼ŒDMAæ¥å£åº”å…·æœ‰å¦‚ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p><ul><li>å‘CPUç”³è¯·DMAä¼ é€ã€‚</li><li>åœ¨CPUå…è®¸DMAå·¥ä½œæ—¶ï¼Œå¤„ç†æ€»çº¿æ§åˆ¶æƒçš„è½¬äº¤ï¼Œé¿å…å› è¿›å…¥DMAå·¥ä½œè€Œå½±å“CPUæ­£å¸¸æ´»åŠ¨æˆ–å¼•èµ·æ€»çº¿ç«äº‰ã€‚</li><li>åœ¨DMAæœŸé—´ç®¡ç†ç³»ç»Ÿæ€»çº¿ï¼Œæ§åˆ¶æ•°æ®ä¼ é€ã€‚</li><li>ç¡®å®šæ•°æ®ä¼ é€çš„èµ·å§‹åœ°å€å’Œæ•°æ®é•¿åº¦ï¼Œä¿®æ­£æ•°æ®ä¼ é€è¿‡ç¨‹ä¸­çš„æ•°æ®åœ°å€å’Œæ•°æ®é•¿åº¦ã€‚</li><li>åœ¨æ•°æ®å—ä¼ é€ç»“æŸæ—¶ï¼Œç»™å‡ºDMAæ“ä½œå®Œæˆçš„ä¿¡å·ã€‚</li></ul><h4 id="5-3-2-DMAæ¥å£åŸºæœ¬ç»„æˆ"><a href="#5-3-2-DMAæ¥å£åŸºæœ¬ç»„æˆ" class="headerlink" title="5.3.2 DMAæ¥å£åŸºæœ¬ç»„æˆ"></a>5.3.2 DMAæ¥å£åŸºæœ¬ç»„æˆ</h4><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/daa49d98c2cb0b40b1e8ead9503f8cd0.png" alt="img" style="zoom:67%;"><ul><li>ä¸»å­˜åœ°å€å¯„å­˜å™¨(AR) ï¼šç”¨äºå­˜æ”¾ä¸»å­˜ä¸­éœ€è¦äº¤æ¢æ•°æ®çš„åœ°å€ã€‚</li><li>å­—è®¡æ•°å™¨(WC) ï¼šç”¨äºè®°å½•ä¼ é€æ•°æ®çš„æ€»å­—æ•°ï¼Œé€šå¸¸ä»¥äº¤æ¢å­—æ•°çš„è¡¥ç å€¼é¢„ç½®ã€‚</li><li>æ•°æ®ç¼“å†²å¯„å­˜å™¨(BR) ï¼šç”¨äºæš‚å­˜æ¯æ¬¡ä¼ é€çš„æ•°æ®ã€‚</li><li>DMAæ§åˆ¶é€»è¾‘ï¼š è´Ÿè´£ç®¡ç†DMAçš„ä¼ é€è¿‡ç¨‹ï¼Œç”±æ§åˆ¶ç”µè·¯ã€æ—¶åºç”µè·¯åŠå‘½ä»¤çŠ¶æ€æ§åˆ¶å¯„å­˜å™¨ç­‰ç»„æˆã€‚</li><li>ä¸­æ–­æœºæ„ï¼šå½“å­—è®¡æ•°å™¨æº¢å‡ºï¼ˆå…¨â€œ0â€ï¼‰æ—¶ï¼Œè¡¨ç¤ºä¸€æ‰¹æ•°æ®äº¤æ¢å®Œåï¼Œç”±â€œæº¢å‡ºä¿¡å·â€é€šè¿‡ä¸­æ–­æœºæ„å‘CPUæå‡ºä¸­æ–­è¯·æ±‚ï¼Œè¯·æ±‚CPUä½œDMAæ“ä½œçš„åå¤„ç†ã€‚</li><li>è®¾å¤‡åœ°å€å¯„å­˜å™¨(DAR) ï¼šå­˜æ”¾I&#x2F;Oè®¾å¤‡çš„è®¾å¤‡ç æˆ–è¡¨ç¤ºè®¾å¤‡ä¿¡æ¯å­˜å‚¨åŒºçš„å¯»å€ä¿¡æ¯ï¼Œå¦‚ç£ç›˜æ•°æ®æ‰€åœ¨çš„åŒºå·ç›˜é¢å·å’ŒæŸ±é¢å·ã€‚</li></ul><h3 id="5-4-DMAçš„å·¥ä½œè¿‡ç¨‹"><a href="#5-4-DMAçš„å·¥ä½œè¿‡ç¨‹" class="headerlink" title="5.4 DMAçš„å·¥ä½œè¿‡ç¨‹"></a>5.4 DMAçš„å·¥ä½œè¿‡ç¨‹</h3><p>DMAçš„æ•°æ®ä¼ é€è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ul><li>é¢„å¤„ç†</li><li>æ•°æ®ä¼ é€</li><li>åå¤„ç†</li></ul><h4 id="5-4-1-é¢„å¤„ç†"><a href="#5-4-1-é¢„å¤„ç†" class="headerlink" title="5.4.1 é¢„å¤„ç†"></a>5.4.1 é¢„å¤„ç†</h4><ul><li>ç»™DMAæ§åˆ¶é€»è¾‘æŒ‡æ˜æ•°æ®ä¼ é€æ–¹å‘æ˜¯è¾“å…¥ï¼ˆå†™ä¸»å­˜ï¼‰è¿˜æ˜¯è¾“å‡ºï¼ˆè¯»ä¸»å­˜ï¼‰ã€‚</li><li>å‘DMAè®¾å¤‡åœ°å€å¯„å­˜å™¨é€å…¥è®¾å¤‡å·ï¼Œå¹¶å¯åŠ¨è®¾å¤‡ã€‚</li><li>å‘DMAä¸»å­˜åœ°å€å¯„å­˜å™¨é€å…¥äº¤æ¢æ•°æ®çš„ä¸»å­˜èµ·å§‹åœ°å€ã€‚</li><li>å¯¹å­—è®¡æ•°å™¨èµ‹äºˆäº¤æ¢æ•°æ®çš„ä¸ªæ•°ã€‚</li></ul><h4 id="5-4-2-æ•°æ®ä¼ é€"><a href="#5-4-2-æ•°æ®ä¼ é€" class="headerlink" title="5.4.2 æ•°æ®ä¼ é€"></a>5.4.2 æ•°æ®ä¼ é€</h4><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/a6000fe130974f4789bb1051dc38156c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><p><strong>ä»¥è¾“å…¥ä¸ºä¾‹ï¼š</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/image-20230521124247578.png" alt="image-20230521124247578" style="zoom: 25%;"><ol><li>IOè®¾å¤‡å°†æ•°æ®å­˜å‚¨åˆ°æ•°æ®å­˜å‚¨å¯„å­˜å™¨BR</li><li>å­˜å…¥æ•°æ®åï¼ŒIOè®¾å¤‡é€šè¿‡è®¾å¤‡è¯·æ±‚ä¿¡å·DREQå‘Šè¯‰DMAæ¥å£å·²ç»å‡†å¤‡å¥½äº†</li><li>DMAæ§åˆ¶é€»è¾‘å‘CPUç”³è¯·æ€»çº¿æ§åˆ¶</li><li>CPUå‘å‡ºä¿¡å·å‘Šè¯‰DMAæ§åˆ¶é€»è¾‘æ­¤æ—¶å·²ç»æ”¾å¼ƒäº†æ€»çº¿çš„å ç”¨å’Œæ§åˆ¶</li><li>æ­¤æ—¶è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œå°±è¦ç»™å‡ºä¸»å­˜çš„åœ°å€ã€‚åœ°å€å¯„å­˜å™¨ARå­˜æ”¾äº†è¦è®¿é—®ä¸»å­˜çš„åœ°å€ï¼Œä½¿å¾—ç³»ç»Ÿæ€»çº¿ä¸­çš„åœ°å€æ€»çº¿æœ‰æ•ˆ</li><li>DMAæ§åˆ¶å™¨ç»™å‡ºè®¾å¤‡åº”ç­”ä¿¡å·ï¼Œæ­¤æ—¶å·²ç»å¼€å§‹ä¼ è¾“æ•°æ®äº†</li><li>DMAæ§åˆ¶å™¨å‘å‡ºå¯¹å†…å­˜çš„è¯»å†™æ§åˆ¶æŒ‡ä»¤ï¼Œ åŒæ—¶BRå¯„å­˜å™¨æŠŠæ•°æ®é€šè¿‡ä¼ è¾“çº¿é€åˆ°æ•°æ®æ€»çº¿ä¸Š</li><li>æ­¤è¿‡ç¨‹AR+1ï¼ŒWC+1</li><li>â€¦.</li><li>å½“WCæº¢å‡ºï¼Œä¼ è¾“ç»“æŸ</li></ol><hr><p><strong>ä»¥è¾“å‡ºä¸ºä¾‹ï¼š</strong></p><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/7ae608e212abd526ea9e3611cdbf51bb.png" alt="img" style="zoom:67%;"><ol><li>æŠŠBRä¸­æ•°æ®é€åˆ°è®¾å¤‡ä¸­</li><li>è®¾å¤‡å‘å‡ºDREQå‘Šè¯‰DMAæ§åˆ¶å™¨æ­¤æ—¶BRå·²ç»ç©ºäº†ï¼Œå¯ä»¥æ¥æ”¶ä¸‹ä¸€ä¸ªæ•°æ®äº†</li><li>DMAå‘CPUå‘å‡ºå¯¹æ€»çº¿å’Œå†…å­˜çš„æ§åˆ¶è¯·æ±‚</li><li>CPUå‘DMAæ§åˆ¶å™¨å‘å‡ºåº”ç­”ä¿¡å·ã€æ­¤æ—¶ç³»ç»Ÿæ€»çº¿å’Œå†…å­˜çš„æ§åˆ¶æƒéƒ½è½¬ç§»åˆ°äº†DMAæ¥å£ã€‘</li><li>ARé€šè¿‡åœ°å€çº¿å‘Šè¯‰å†…å­˜è®¿é—®åœ°å€</li><li>DMAæ§åˆ¶å™¨å‘è®¾å¤‡å‘å‡ºDACKåº”ç­”ä¿¡å·ï¼Œå‘Šè¯‰è®¾å¤‡å·²ç»å¼€å§‹æ–°çš„æ•°æ®ä¼ è¾“äº†</li><li>ä¸»å­˜ä¸­çš„æ•°æ®é€šè¿‡æ•°æ®çº¿å†æ¬¡å†™å…¥åˆ°BRä¸­</li><li>åŒæ—¶ä¿®æ”¹AR+1ï¼ŒWC+1</li><li>â€¦ã€åˆ¤æ–­ä¼ è¾“æ˜¯å¦ç»“æŸï¼Œå¦‚æœæ²¡æœ‰ç»“æŸï¼Œç»§ç»­å¾ªç¯æ‰§è¡Œã€‘</li><li>WCæº¢å‡ºï¼Œä¼ è¾“ç»“æŸ</li></ol><hr><h4 id="5-4-3-åå¤„ç†"><a href="#5-4-3-åå¤„ç†" class="headerlink" title="5.4.3 åå¤„ç†"></a>5.4.3 åå¤„ç†</h4><p>å½“DMAçš„ä¸­æ–­è¯·æ±‚å¾—åˆ°å“åº”åï¼ŒCPUåœæ­¢åŸç¨‹åºçš„æ‰§è¡Œï¼Œè½¬å»æ‰§è¡Œä¸­æ–­æœåŠ¡ç¨‹åºï¼Œæ‰§è¡ŒDMAçš„ç»“æŸå·¥ä½œï¼š</p><ul><li>æ ¡éªŒé€å…¥ä¸»å­˜çš„æ•°æ®æ˜¯å¦æ­£ç¡®ï¼›</li><li>å†³å®šæ˜¯å¦ç»§ç»­ç”¨DMAä¼ é€å…¶ä»–æ•°æ®å—ï¼Œè‹¥ç»§ç»­ä¼ é€ï¼Œåˆ™åˆè¦å¯¹DMAæ¥å£è¿›è¡Œåˆå§‹åŒ–ï¼Œè‹¥ä¸éœ€è¦ä¼ é€ï¼Œåˆ™åœæ­¢å¤–è®¾ï¼›</li><li>æµ‹è¯•åœ¨ä¼ é€è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿé”™è¯¯ï¼Œè‹¥å‡ºé”™ï¼Œåˆ™è½¬é”™è¯¯è¯Šæ–­åŠå¤„ç†é”™è¯¯ç¨‹åºã€‚</li></ul><h3 id="5-5-DMAæ¥å£ç±»å‹"><a href="#5-5-DMAæ¥å£ç±»å‹" class="headerlink" title="5.5 DMAæ¥å£ç±»å‹"></a>5.5 DMAæ¥å£ç±»å‹</h3><h4 id="5-5-1-é€‰æ‹©å‹DMAæ¥å£"><a href="#5-5-1-é€‰æ‹©å‹DMAæ¥å£" class="headerlink" title="5.5.1 é€‰æ‹©å‹DMAæ¥å£"></a>5.5.1 é€‰æ‹©å‹DMAæ¥å£</h4><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/102fc43b2c1c4a7b9709c59811da028e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>åœ¨ç‰©ç†ä¸Šå¯è¿æ¥å¤šä¸ªè®¾å¤‡ï¼Œåœ¨é€»è¾‘ä¸Šåªå…è®¸è¿æ¥ä¸€ä¸ªè®¾å¤‡ï¼Œå³åœ¨æŸä¸€æ®µæ—¶é—´å†…ï¼ŒDMAæ¥å£åªèƒ½ä¸ºä¸€ä¸ªè®¾å¤‡æœåŠ¡ï¼›</li><li>å…³é”®æ˜¯åœ¨é¢„å¤„ç†æ—¶å°†æ‰€é€‰è®¾å¤‡çš„è®¾å¤‡å·é€å…¥è®¾å¤‡åœ°å€å¯„å­˜å™¨ã€‚</li></ul><h4 id="5-5-2-å¤šè·¯å‹DMAæ¥å£"><a href="#5-5-2-å¤šè·¯å‹DMAæ¥å£" class="headerlink" title="5.5.2 å¤šè·¯å‹DMAæ¥å£"></a>5.5.2 å¤šè·¯å‹DMAæ¥å£</h4><img src="/2023/05/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%BA%94-%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E7%B3%BB%E7%BB%9F/22f2e2f319714d9193b6c95807f6ab9d.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>å¤šè·¯å‹DMAæ¥å£ä¸ä»…åœ¨ç‰©ç†ä¸Šå¯ä»¥è¿æ¥å¤šä¸ªè®¾å¤‡ï¼Œè€Œä¸”åœ¨é€»è¾‘ä¸Šä¹Ÿå…è®¸å¤šä¸ªè®¾å¤‡åŒæ—¶å·¥ä½œï¼Œå„ä¸ªè®¾å¤‡é‡‡ç”¨å­—èŠ‚äº¤å‰çš„æ–¹å¼é€šè¿‡DMAæ¥å£è¿›è¡Œæ•°æ®ä¼ é€ã€‚</li><li>è¿™ç±»æ¥å£ç‰¹åˆ«é€‚åˆäºåŒæ—¶ä¸ºå¤šä¸ªæ•°æ®ä¼ è¾“ç‡ä¸ååˆ†é«˜çš„è®¾å¤‡æœåŠ¡ã€‚</li></ul><h3 id="5-6-DMAæ–¹å¼å’Œç¨‹åºä¸­æ–­æ–¹å¼æ¯”è¾ƒ"><a href="#5-6-DMAæ–¹å¼å’Œç¨‹åºä¸­æ–­æ–¹å¼æ¯”è¾ƒ" class="headerlink" title="5.6 DMAæ–¹å¼å’Œç¨‹åºä¸­æ–­æ–¹å¼æ¯”è¾ƒ"></a>5.6 DMAæ–¹å¼å’Œç¨‹åºä¸­æ–­æ–¹å¼æ¯”è¾ƒ</h3><table><thead><tr><th></th><th>ä¸­æ–­æ–¹å¼</th><th>DMAæ–¹å¼</th></tr></thead><tbody><tr><td>æ•°æ®ä¼ é€</td><td>ç¨‹åº</td><td>ç¡¬ä»¶</td></tr><tr><td>å“åº”æ—¶é—´</td><td>æŒ‡ä»¤æ‰§è¡Œç»“æŸ</td><td>å­˜å–å‘¨æœŸç»“æŸ</td></tr><tr><td>å¤„ç†å¼‚å¸¸æƒ…å†µ</td><td>èƒ½</td><td>ä¸èƒ½</td></tr><tr><td>ä¸­æ–­è¯·æ±‚</td><td>ä¼ é€æ•°æ®</td><td>åå¤„ç†</td></tr><tr><td>ä¼˜å…ˆçº§</td><td>ä½</td><td>é«˜</td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºé…ç½®ä¸€æœ¬é€š</title>
    <link href="/2023/05/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%85%8D%E7%BD%AE%E4%B8%80%E6%9C%AC%E9%80%9A/"/>
    <url>/2023/05/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%85%8D%E7%BD%AE%E4%B8%80%E6%9C%AC%E9%80%9A/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºé…ç½®ä¸€æœ¬é€š"><a href="#è®¡ç®—æœºé…ç½®ä¸€æœ¬é€š" class="headerlink" title="è®¡ç®—æœºé…ç½®ä¸€æœ¬é€š"></a>è®¡ç®—æœºé…ç½®ä¸€æœ¬é€š</h1><h2 id="1-CPU"><a href="#1-CPU" class="headerlink" title="1.CPU"></a>1.CPU</h2><ul><li><strong>Intel CPUåç¼€å«ä¹‰</strong></li></ul><h2 id="2-å†…å­˜"><a href="#2-å†…å­˜" class="headerlink" title="2.å†…å­˜"></a>2.å†…å­˜</h2><ul><li>â­<a href="https://www.bilibili.com/video/BV1vP411c7pt/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">æ¢ç´¢ä¸»å†…å­˜ï¼Œä»¥DDR5ä¸ºä¾‹</a></li><li><a href="https://zhuanlan.zhihu.com/p/113187707">DDR4å¯»å€åŸç†</a></li><li><a href="https://www.bilibili.com/video/BV1Yg4y1E786/?spm_id_from=333.880.my_history.page.click&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">ä½ çš„å†…å­˜æ˜¯é©¬ç”²æ¡å—ï¼Ÿä½ çŸ¥é“é©¬ç”²æœ‰ä»€ä¹ˆä½œç”¨å—ï¼Ÿ</a></li></ul><h2 id="3-ä¸»æ¿"><a href="#3-ä¸»æ¿" class="headerlink" title="3.ä¸»æ¿"></a>3.ä¸»æ¿</h2><ul><li><a href="https://www.douyin.com/user/self?modal_id=7085253674473180447&showTab=like">åç¡•ä¸»æ¿æ€ä¹ˆåˆ’åˆ†</a></li></ul><h2 id="4-ç¡¬ç›˜"><a href="#4-ç¡¬ç›˜" class="headerlink" title="4.ç¡¬ç›˜"></a>4.ç¡¬ç›˜</h2><ul><li><a href="https://www.douyin.com/video/7180506336273173792">æœºæ¢°ç¡¬ç›˜çš„ç»“æ„åŸç†</a></li><li><a href="https://www.douyin.com/video/7180231042966506785">æœºæ¢°ç¡¬ç›˜çš„å·¥ä½œåŸç†</a></li><li><a href="https://www.douyin.com/video/7223806080290196792">æœºæ¢°ç¡¬ç›˜æ˜¯å¦‚ä½•åˆ¶é€ çš„</a></li><li><a href="https://www.douyin.com/user/self?modal_id=7163175761438919973&showTab=like">å›ºæ€ç¡¬ç›˜çš„å·¥ä½œåŸç†</a></li><li>â­<a href="https://www.bilibili.com/video/BV1Qv411t7ZL/?spm_id_from=333.999.0.0&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">ç¡¬ç›˜çš„SATA M.2 NGFF NVMEæ˜¯ä»€ä¹ˆæ„æ€ï¼Œè¯¦è§£ç¡¬ç›˜çš„æ€»çº¿åè®®ä¸æ¥å£</a></li><li>ã€PCIeç³»åˆ—ä¸€ã€‘<a href="https://www.bilibili.com/video/BV1n4411m7HX/?spm_id_from=333.999.0.0&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">PCIeåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿä»–åœ¨ç”µè„‘é‡Œæ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</a></li><li>ã€PCIeç³»åˆ—äºŒã€‘<a href="https://www.bilibili.com/video/BV1cJ411K7HW/?spm_id_from=333.788&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">è¯¦è§£ä¸»æ¿å—æ¡¥èŠ¯ç‰‡ç»„çš„åŠŸèƒ½å’Œä½œç”¨</a></li></ul><h2 id="5-ç”µæº"><a href="#5-ç”µæº" class="headerlink" title="5.ç”µæº"></a>5.ç”µæº</h2><ul><li><a href="https://www.bilibili.com/video/BV1mD4y1D77y/?spm_id_from=333.999.0.0&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">ä»€ä¹ˆæ˜¯æ¨¡ç»„ç”µæºï¼Ÿä»–å’Œæ™®é€šç”µæºæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ¨¡ç»„ç”µæºå®šåˆ¶çº¿åˆæ˜¯ä»€ä¹ˆä¸œè¥¿</a></li><li><a href="https://www.bilibili.com/video/BV1bT4y1E777/?spm_id_from=333.788&vd_source=0a2a531b678f5afe0a34f933b2fbdcb4">ç”µæºçš„é‡‘é“¶é“œç‰ŒæŒ‡çš„æ˜¯ä»€ä¹ˆå‚æ•°ï¼Ÿé‡‘ç‰Œç”µæºæ¯”é“œç‰Œå¥½å—ï¼Ÿè¯¦è§£ç”µæº80PLUSè®¤è¯</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¡¬ç›˜çš„æ¥å£ã€åè®®ã€æ€»çº¿</title>
    <link href="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/"/>
    <url>/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¡¬ç›˜çš„æ¥å£ã€åè®®ã€æ€»çº¿"><a href="#ç¡¬ç›˜çš„æ¥å£ã€åè®®ã€æ€»çº¿" class="headerlink" title="ç¡¬ç›˜çš„æ¥å£ã€åè®®ã€æ€»çº¿"></a>ç¡¬ç›˜çš„æ¥å£ã€åè®®ã€æ€»çº¿</h1><p>å½“æˆ‘ä»¬è´­ä¹°å›ºæ€ç¡¬ç›˜çš„æ—¶å€™ï¼Œå¸¸å¸¸ä¼šçœ‹åˆ°ä»¥ä¸‹çš„å†…å®¹ï¼š</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/image-20230509225117077-1683643878529-1.png" alt="image-20230509225117077" style="zoom:67%;"><p>M.2å›ºæ€ç¡¬ç›˜ NVMeåè®®ï¼ŒPCIe4.0 Ã—4åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/image-20230509225501897.png" alt="image-20230509225501897" style="zoom:80%;"><p>åˆæˆ–è€…è‡ªå·±åœ¨DIYç”µè„‘é…ç½®çš„æ—¶å€™ç¡¬ç›˜ä¼šé€‰æ‹©ä¸Šè¿°é…ç½®</p><h2 id="1-æ€»çº¿ã€åè®®ã€æ¥å£"><a href="#1-æ€»çº¿ã€åè®®ã€æ¥å£" class="headerlink" title="1.æ€»çº¿ã€åè®®ã€æ¥å£"></a>1.æ€»çº¿ã€åè®®ã€æ¥å£</h2><h3 id="1-1-æ€»çº¿"><a href="#1-1-æ€»çº¿" class="headerlink" title="1.1 æ€»çº¿"></a>1.1 æ€»çº¿</h3><p>æ€»çº¿æ˜¯è®¡ç®—æœºå„ç§åŠŸèƒ½éƒ¨ä»¶ä¹‹é—´ä¼ é€ä¿¡æ¯çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼Œå®ƒæ˜¯ç”±å¯¼çº¿ç»„æˆçš„ä¼ è¾“çº¿æŸã€‚æ€»çº¿æ˜¯ä¸€ç§å†…éƒ¨ç»“æ„ï¼Œå®ƒæ˜¯CPUã€å†…å­˜ã€è¾“å…¥ã€è¾“å‡ºè®¾å¤‡ä¼ é€’ä¿¡æ¯çš„å…¬ç”¨é€šé“ï¼Œä¸»æœºçš„å„ä¸ªéƒ¨ä»¶é€šè¿‡æ€»çº¿ç›¸è¿æ¥ï¼Œå¤–éƒ¨è®¾å¤‡é€šè¿‡ç›¸åº”çš„æ¥å£ç”µè·¯å†ä¸æ€»çº¿ç›¸è¿æ¥ï¼Œä»è€Œå½¢æˆäº†è®¡ç®—æœºç¡¬ä»¶ç³»ç»Ÿã€‚</p><p>æ€»çº¿æœ‰ä¸€å®šçš„æ‰¿è½½èƒ½åŠ›ä¸Šé™ï¼Œæˆ‘ä»¬æŠŠæ€»çº¿åœ¨å•ä½æ—¶é—´å†…ä¼ è¾“çš„æ•°æ®é‡ç§°ä¸ºæ€»çº¿çš„å¸¦å®½ã€‚å¸¸è§çš„ä¸‰ç§æ€»çº¿åŠå…¶ç†è®ºæœ€å¤§å¸¦å®½å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>æ€»çº¿åç§°</th><th>åº”ç”¨åœºåˆ</th><th>ä¼ è¾“é€Ÿç‡</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SATAæ€»çº¿</td><td>æ°‘ç”¨</td><td>600MB&#x2F;s</td><td>ç›®å‰SATAæ€»çº¿çš„ç‰ˆæœ¬ä¸ºSATA3.0</td></tr><tr><td>PCIeæ€»çº¿</td><td>æ°‘ç”¨</td><td>è§ä¸‹è¡¨</td><td>ç›®å‰PCIeæ€»çº¿çš„ç‰ˆæœ¬ä¸ºPCIe3.0å’ŒPCIe4.0</td></tr><tr><td>SASæ€»çº¿</td><td>æœåŠ¡å™¨</td><td>1.2GB&#x2F;s</td><td>ä¸»è¦ç”¨äºæœåŠ¡å™¨ç¡¬ç›˜ï¼Œæ¶ˆè´¹çº§å¸‚åœºä¸å¸¸è§</td></tr></tbody></table><p>å½“å‰é«˜ç«¯çš„M.2å›ºæ€ç¡¬ç›˜å·²ç»æ”¯æŒPCIe 5.0</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/6b2e06dd569540b1ab30437a4581b00e.jpeg" alt="img" style="zoom:67%;"><h3 id="1-2-åè®®"><a href="#1-2-åè®®" class="headerlink" title="1.2 åè®®"></a>1.2 åè®®</h3><p>åè®®æ˜¯ç‰©ç†è®¾å¤‡ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶çš„â€œè§„åˆ™â€ï¼Œå…¶å†…å®¹ä¸»è¦åŒ…æ‹¬è®¾å¤‡é—´å¦‚ä½•ç›¸äº’è¯†åˆ«ã€å¦‚ä½•å»ºç«‹é“¾æ¥ã€ä½¿ç”¨çš„è®¯å·ç±»å‹ã€æ•°æ®çš„ç¼–ç è§£ç æ–¹å¼ã€æ•°æ®ä¼ è¾“çš„ç±»å‹ã€æ•°æ®ä¼  è¾“çš„æ–¹å¼ä»¥åŠç‰©ç†å±‚é¢ä¸Šçš„ç”µå‹ã€ç”µæµã€ä¿æŒæ—¶é—´å’Œæˆªæ­¢æ—¶é—´ç­‰ã€‚</p><p>åªæœ‰å½“ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´çš„åè®®ç›¸åŒæˆ–è€…ç›¸å®¹æ—¶ï¼Œæ‰å¯ä»¥æ­£å¸¸è¿›è¡Œé€šè®¯ã€‚ä¸åŒåè®®èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§ä¼ è¾“é€Ÿç‡ä¹Ÿä¸åŒã€‚</p><p>ç›®å‰å¸‚åœºä¸Šç¡¬ç›˜æ‰€ä½¿ç”¨çš„çš„åè®®ä¸»è¦æœ‰å››ç§ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>åè®®åç§°</th><th>åº”ç”¨åœºåˆ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>IDE</td><td>æ°‘ç”¨</td><td>æ—©æœŸç¡¬ç›˜æ‰€ä½¿ç”¨çš„åè®®ï¼Œç›®å‰åŸºæœ¬è§ä¸åˆ°äº†</td></tr><tr><td>AHCI</td><td>æ°‘ç”¨</td><td>æœºæ¢°ç¡¬ç›˜ã€SATAå›ºæ€ç¡¬ç›˜å’Œæå°‘æ•°PCIeå›ºæ€ç¡¬ç›˜ä½¿ç”¨æ­¤åè®®</td></tr><tr><td>NVMe</td><td>æ°‘ç”¨</td><td>ç›®å‰ä¸»æµçš„PCIeå›ºæ€ç¡¬ç›˜ä½¿ç”¨æ­¤åè®®ï¼Œä¹Ÿæ˜¯æ¶ˆè´¹çº§å¸‚åœºä¸Šæœ€å¸¸è§çš„</td></tr><tr><td>SCSI</td><td>æœåŠ¡å™¨</td><td>å¸¸è§äºä¼ä¸šçº§å›ºæ€ç¡¬ç›˜ï¼Œæ¶ˆè´¹çº§å¸‚åœºä¸å¸¸è§</td></tr></tbody></table><h3 id="1-3-æ¥å£"><a href="#1-3-æ¥å£" class="headerlink" title="1.3 æ¥å£"></a>1.3 æ¥å£</h3><p>ç›¸å¯¹äºå‰é¢è¾ƒéš¾ç†è§£çš„æ€»çº¿ä¸åè®®ï¼Œæ¥å£é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç¡¬ç›˜ä¸ä¸»æ¿è¿æ¥çš„ç‰©ç†æ¥å£ã€‚ç›®å‰ç¡¬ç›˜æ¥å£ç§ç±»è¾ƒå¤šï¼Œåœ¨è¿™é‡Œæ¯”è¾ƒä¸»è¦çš„ä¸‰ç§åˆ†åˆ«ä¸ºSATAæ¥å£ã€M.2æ¥å£å’ŒU.2æ¥å£ï¼Œå…¶ä»–æ¥å£ç±»å‹ä»…åšäº†è§£å³å¯ã€‚å„ç§æ¥å£åŠå…¶è§„æ ¼ç”±ä¸‹è¡¨ç»™å‡ºï¼š</p><table><thead><tr><th>ç‰©ç†æ¥å£</th><th>é€šä¿¡é€šé“</th><th>ä¼ è¾“æ•°æ®åè®®</th><th>ä½“ç§¯</th><th>æè¿°</th></tr></thead><tbody><tr><td>SATA3</td><td>SATA</td><td>AHCIæˆ–è€…ATA</td><td>å¤§</td><td>ä¸»æµï¼Œé€Ÿåº¦6Gbpsï¼Œä¸æ”¯æŒNVMeæ ‡å‡†ï¼Œä½“ç§¯ä¹Ÿæ¯”è¾ƒå¤§ï¼Œå°±æ˜¯æŠ€æœ¯æˆç†Ÿï¼Œä½†æ˜¯é€Ÿåº¦æ…¢</td></tr><tr><td>mSATAï¼ˆè¢«æ·˜æ±°ï¼‰</td><td>SATA</td><td>AHCIæˆ–è€…ATA</td><td>å°</td><td>å°±æ˜¯ä¸ºäº†SATAå°å‹åŒ–ï¼Œä½†æ˜¯è¿˜æ˜¯SATAé€šé“ï¼Œæ‰€ä»¥éœ€è¦SATAä¸»æ§<br>Tipsï¼šç‰©ç†æ¥å£ä¸Šå’Œmini PCI-Eæ¥å£ä¸€æ ·</td></tr><tr><td>SATA - E (ä¸å’‹åœ°)</td><td>PCI-E x2</td><td>NVMeåè®®</td><td>å¤§</td><td>ä¸ºäº†è§£å†³ä¸Šé¢mSATAçš„åç»§é—®é¢˜ï¼Œå°±ç›´æ¥é‡‡ç”¨äº†PCI-Eé€šé“ï¼Œä½†æ˜¯ç”¨çš„å¾ˆå°‘</td></tr><tr><td>U.2</td><td>SATA + PCI-E x2, x4</td><td>NVMeåè®®</td><td>å¤§</td><td>ä¸Šé¢çš„SATA-Eå†å‡çº§ï¼Œæ”¯æŒäº†NVMeåè®®ï¼Œå¸¦å®½ä¹Ÿè¾¾åˆ°äº†32Gbpsï¼Œä½†æ˜¯ç”±äºç°åœ¨å¾ˆå¤šä¸»æ¿ä¸Šæ²¡æœ‰U.2æ¥å£ï¼Œæ‰€ä»¥å¾ˆå¤šéƒ½æ˜¯ç”¨çš„U.2è½¬M.2çš„è½¬æ¥å¡</td></tr><tr><td><strong>M.2</strong></td><td>SATA + PCI-E x2, x4</td><td>NVMeåè®®</td><td>å°</td><td>å–ä»£mSATAï¼Œ<strong>åŒæ—¶å…¼å®¹SATAå’ŒPCI-Eé€šé“</strong>ï¼Œéå¸¸çš„ä¸»æµï¼Œç°åœ¨å…¨é¢è½¬å‘PCIe 3.0 x4 é€šé“ï¼Œç†è®ºå¸¦å®½è¾¾åˆ°äº†32Gbps</td></tr><tr><td>PCI-E</td><td>PCI-E x2, x4</td><td>NVMeåè®®</td><td>å¤§</td><td>è·Ÿæ˜¾å¡ç±»ä¼¼ï¼Œè§„æ ¼å¤§å°ä¹Ÿæœ‰å¤šç§ï¼Œç›®å‰ç›´æ¥èµ°PCI-Eæ¥å£çš„ç¡¬ç›˜è¿˜ä¸æ˜¯å¾ˆå¤šï¼Œå±äºé«˜ç«¯</td></tr></tbody></table><h2 id="2-M-2æ¥å£çœŸå®çš„æ ·å­"><a href="#2-M-2æ¥å£çœŸå®çš„æ ·å­" class="headerlink" title="2.M.2æ¥å£çœŸå®çš„æ ·å­"></a>2.M.2æ¥å£çœŸå®çš„æ ·å­</h2><p>ç°åœ¨çš„ä¸»æ¿ä¸Šä¸€èˆ¬M.2å›ºæ€éƒ½æ•£çƒ­ç‰‡ï¼Œéœ€è¦æˆ‘ä»¬æ‹†å¼€æ•£çƒ­ç‰‡</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/image-20230509232115580.png" alt="image-20230509232115580" style="zoom: 33%;"><p>æ‹†å¼€æ•£çƒ­ç‰‡åï¼Œå°±å¯ä»¥çœ‹åˆ°çœŸå®çš„M.2æ¥å£äº†</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/image-20230509232202877.png" alt="image-20230509232202877" style="zoom:50%;"><p>å°†M.2å›ºæ€çš„é‡‘æ‰‹æŒ‡å¯¹å‡†M.2æ¥å£ï¼Œæ’å…¥åå³å¯ï¼š</p><img src="/2023/05/09/%E7%A1%AC%E7%9B%98%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%81%E5%8D%8F%E8%AE%AE%E3%80%81%E6%80%BB%E7%BA%BF/image-20230509232344100.png" alt="image-20230509232344100" style="zoom: 50%;">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç»„æˆåŸç†(å››)å­˜å‚¨å™¨</title>
    <link href="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/"/>
    <url>/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç»„æˆåŸç†-å››-å­˜å‚¨å™¨"><a href="#è®¡ç®—æœºç»„æˆåŸç†-å››-å­˜å‚¨å™¨" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†(å››)å­˜å‚¨å™¨"></a>è®¡ç®—æœºç»„æˆåŸç†(å››)å­˜å‚¨å™¨</h1><blockquote><p>å£°æ˜ï¼šæœ¬æ–‡å¤§éƒ¨åˆ†å†…å®¹è½¬è½½è‡ª<strong>ä¸æ–­å‰è¿›çš„çš®å¡ä¸˜</strong>ï¼Œæ„Ÿè°¢è¾›è‹¦æ•´ç†çš„æˆæœ</p><p>åŸæ–‡åœ°å€ï¼š<a href="https://blog.csdn.net/qq_52797170/article/details/124472835">https://blog.csdn.net/qq_52797170/article/details/124472835</a></p></blockquote><p>[TOC]</p><h3 id="1-1-å­˜å‚¨å™¨åˆ†ç±»"><a href="#1-1-å­˜å‚¨å™¨åˆ†ç±»" class="headerlink" title="1.1 å­˜å‚¨å™¨åˆ†ç±»"></a>1.1 å­˜å‚¨å™¨åˆ†ç±»</h3><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/3b068c358f4340b580f7f0727c2e0804.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h4 id="1-1-1-æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»"><a href="#1-1-1-æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»" class="headerlink" title="1.1.1 æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»"></a>1.1.1 æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»</h4><ul><li>åŠå¯¼ä½“å­˜å‚¨å™¨ TTLã€MOS æ˜“å¤±</li><li>ç£è¡¨é¢å­˜å‚¨å™¨ ç£å¤´ã€è½½ç£ä½“ éæ˜“å¤±</li><li>ç£èŠ¯å­˜å‚¨å™¨ ç¡¬ç£ææ–™ã€ç¯çŠ¶å…ƒä»¶ éæ˜“å¤±</li><li>å…‰ç›˜å­˜å‚¨å™¨ æ¿€å…‰ã€ç£å…‰ææ–™ éæ˜“å¤±</li></ul><h4 id="1-1-2-æŒ‰è¯»å–æ–¹å¼åˆ†ç±»"><a href="#1-1-2-æŒ‰è¯»å–æ–¹å¼åˆ†ç±»" class="headerlink" title="1.1.2 æŒ‰è¯»å–æ–¹å¼åˆ†ç±»"></a>1.1.2 æŒ‰è¯»å–æ–¹å¼åˆ†ç±»</h4><p>â‘ å­˜å–æ—¶é—´å’Œå­˜å–å•å…ƒä½ç½®æ— å…³(éšæœºè®¿é—®)</p><ul><li>éšæœºå­˜å‚¨å™¨(RAM)<ul><li>å­˜å‚¨å™¨ä¸­ä»»ä½•å­˜å‚¨å•å…ƒçš„å†…å®¹éƒ½èƒ½è¢«éšæœºå­˜å–ï¼Œå’Œå­˜å–æ—¶é—´å’Œå­˜å‚¨å•å…ƒçš„ç‰©ç†ä½ç½®æ— å…³ï¼Œè¿™ç§å­˜å‚¨å™¨å«åšéšæœºå­˜å‚¨å™¨</li><li>éšæœºå­˜å‚¨å™¨åœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­å¯è¯»å¯å†™</li></ul></li><li>åªè¯»å­˜å‚¨å™¨(ROM)<ul><li>åœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­åªè¯»</li></ul></li></ul><p>â‘¡å­˜å–æ—¶é—´å’Œå­˜å–å•å…ƒä½ç½®æœ‰å…³(ä¸²è¡Œè®¿é—®)</p><ul><li>é¡ºåºå­˜å–å­˜å‚¨å™¨ ç£å¸¦<ul><li>å­˜å‚¨å™¨åªèƒ½æŒ‰ç…§æŸç§é¡ºåºæ¥å­˜å–ï¼Œé‚£ä¹ˆè¿™ç§å­˜å‚¨å™¨å°±æ˜¯é¡ºåºå­˜å–å­˜å‚¨å™¨ï¼Œå®ƒçš„å­˜å–å‘¨æœŸè¾ƒé•¿</li></ul></li><li>ç›´æ¥å­˜å–å­˜å‚¨å™¨ ç£ç›˜<ul><li>æ²¿ç€ç£é“æ–¹å‘é¡ºåºå­˜å–ï¼Œå‚ç›´åŠå¾„æ–¹å‘éšæœºå­˜å–</li></ul></li></ul><p>â‘¢æŒ‰ç…§åœ¨è®¡ç®—æœºä¸­çš„ä½œç”¨åˆ†ç±»<br><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/878f6fcb0db84f4890a7e594f3cb6786.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"></p><h3 id="1-2-å­˜å‚¨å™¨çš„å±‚æ¬¡ç»“æ„"><a href="#1-2-å­˜å‚¨å™¨çš„å±‚æ¬¡ç»“æ„" class="headerlink" title="1.2 å­˜å‚¨å™¨çš„å±‚æ¬¡ç»“æ„"></a>1.2 å­˜å‚¨å™¨çš„å±‚æ¬¡ç»“æ„</h3><h4 id="1-2-1-å­˜å‚¨å™¨çš„ä¸‰ä¸ªä¸»è¦ç‰¹æ€§çš„å…³ç³»"><a href="#1-2-1-å­˜å‚¨å™¨çš„ä¸‰ä¸ªä¸»è¦ç‰¹æ€§çš„å…³ç³»" class="headerlink" title="1.2.1 å­˜å‚¨å™¨çš„ä¸‰ä¸ªä¸»è¦ç‰¹æ€§çš„å…³ç³»"></a>1.2.1 å­˜å‚¨å™¨çš„ä¸‰ä¸ªä¸»è¦ç‰¹æ€§çš„å…³ç³»</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/340ca3c5d3554a91b7e48c5998e9cbe6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 80%;"><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/332deb6cf51f4ad39270d8e96a1c18c3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;"><h4 id="1-2-2-ç¼“å­˜-ä¸»å­˜å±‚æ¬¡å’Œä¸»å­˜-è¾…å­˜å±‚æ¬¡"><a href="#1-2-2-ç¼“å­˜-ä¸»å­˜å±‚æ¬¡å’Œä¸»å­˜-è¾…å­˜å±‚æ¬¡" class="headerlink" title="1.2.2 ç¼“å­˜-ä¸»å­˜å±‚æ¬¡å’Œä¸»å­˜-è¾…å­˜å±‚æ¬¡"></a>1.2.2 ç¼“å­˜-ä¸»å­˜å±‚æ¬¡å’Œä¸»å­˜-è¾…å­˜å±‚æ¬¡</h4><p>è®¡ç®—æœºçš„ä¸»æœºç”±CPUå’Œä¸»å­˜å‚¨å™¨æ„æˆ<br>CPUå¯ä»¥ä»ä¸»å­˜ä¸­è¯»å–ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æŠŠä¿¡æ¯å­˜åˆ°ä¸»å­˜ä¸­ï¼Œä½†æ˜¯ä¸»å­˜çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¨‹åºè¶³å¤Ÿå¤§çš„è¯ï¼Œä¸»å­˜æ˜¯å­˜ä¸ä¸‹çš„ï¼Œéœ€è¦è¾…åŠ©å­˜å‚¨å™¨å¸®å¿™å­˜å‚¨ï¼Œä¸è¿‡ç¨‹åºçš„è¿è¡Œè¿˜æ˜¯å¾—é€šè¿‡ä¸»å­˜</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/04816fd2fb45456baf26a7dafd1430dd.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;"><h2 id="2-ä¸»å­˜å‚¨å™¨"><a href="#2-ä¸»å­˜å‚¨å™¨" class="headerlink" title="2.ä¸»å­˜å‚¨å™¨"></a>2.ä¸»å­˜å‚¨å™¨</h2><h3 id="2-1-ä¸»å­˜å‚¨å™¨æ¦‚è¿°"><a href="#2-1-ä¸»å­˜å‚¨å™¨æ¦‚è¿°" class="headerlink" title="2.1 ä¸»å­˜å‚¨å™¨æ¦‚è¿°"></a>2.1 ä¸»å­˜å‚¨å™¨æ¦‚è¿°</h3><h4 id="2-1-1-ä¸»å­˜çš„åŸºæœ¬ç»„æˆ"><a href="#2-1-1-ä¸»å­˜çš„åŸºæœ¬ç»„æˆ" class="headerlink" title="2.1.1 ä¸»å­˜çš„åŸºæœ¬ç»„æˆ"></a>2.1.1 ä¸»å­˜çš„åŸºæœ¬ç»„æˆ</h4><p>ä»å‰é¢çš„åªæ˜¯æ¥çœ‹ï¼Œå­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆå¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230505235435737.png" alt="image-20230505235435737" style="zoom: 67%;"><ul><li>åŸºæœ¬ä¸Šä¸»å­˜ç”±ä¸‰éƒ¨åˆ†ç»„æˆ å­˜å‚¨ä½“ åœ°å€å¯„å­˜å™¨ æ•°æ®å¯„å­˜å™¨</li><li>å¯„å­˜å™¨ä¹Ÿæ˜¯å­˜å‚¨å™¨ ç”¨æ¥å­˜æ”¾æ•°æ®</li><li>ä¸€ä¸ªè¯»å–æ“ä½œå°±åƒæ˜¯ä»èœé¸Ÿé©¿ç«™æ‹¿å¿«é€’ä¸€æ ·ï¼Œæˆ‘éœ€è¦æä¾›å–ä»¶ç ç»™åº—å‘˜ï¼ˆæ•°æ®åœ°å€ï¼‰ï¼Œç„¶åä»è´§æ¶ï¼ˆå­˜å‚¨ä½“ï¼‰ä¸­æ‰¾åˆ°å¿«é€’ï¼Œæ”¾åœ¨æŸœå°ï¼ˆæ•°æ®å¯„å­˜å™¨ä¸­ï¼‰æˆ‘æ¥å–èµ°</li><li>ä¸€ä¸ªå†™å…¥æ“ä½œåˆ™å’Œå–å¿«é€’ç¨å¾®ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦å…ˆç»™åœ°å€å¯„å­˜å™¨ä¸€ä¸ªåœ°å€ï¼Œç„¶åæŠŠæ•°æ®ç»™æ•°æ®å¯„å­˜å™¨ï¼Œè¿™æ ·ä¸»å­˜å°±ä¼šå¸®æˆ‘ä»¬æŠŠæ•°æ®å†™å…¥å­˜å‚¨ä½“ã€‚</li></ul><p>è¿™ä¸€ç« èŠ‚æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»ä¸»å­˜å‚¨å™¨çš„ç»“æ„ï¼š</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230506000027708.png" alt="image-20230506000027708" style="zoom: 40%;"><p>ä¸»å­˜ç”±å­˜å‚¨ä½“(ç¨‹åºï¼ŒæŒ‡ä»¤ï¼Œæ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨å­˜å‚¨ä½“ä¸­)ï¼ŒMARï¼ŒMDRæ„æˆã€‚</p><p>MARå½“ä¸­ä¿å­˜äº†æˆ‘ä»¬è¦è®¿é—®çš„é‚£ä¸ªå­˜å‚¨å•å…ƒçš„åœ°å€ï¼Œå¿…é¡»è¦è¿›è¡Œè¯‘ç å™¨è¯‘ç ä»¥åï¼Œæˆ‘ä»¬æ‰å¯ä»¥é€‰å®šæŒ‡å®šçš„å­˜å‚¨å•å…ƒï¼›MDRä¸­ä¿å­˜äº†æˆ‘ä»¬è¯»å‡ºæˆ–è€…å†™å…¥çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®æ˜¯è¯»å‡ºè¿˜æ˜¯å†™å…¥éœ€è¦é€šè¿‡è¯»å†™ç”µè·¯å’Œæ§åˆ¶ç”µè·¯æ¥æ§åˆ¶</p><ul><li>å¦‚æœæ˜¯å†™å…¥çš„è¯ï¼Œåˆ™æŠŠæ•°æ®ä»MDRé€å…¥æŒ‡å®šçš„å­˜å‚¨ä½“çš„å­˜å‚¨å•å…ƒä¸­</li><li>å¦‚æœæ˜¯è¯»å‡ºçš„è¯ï¼Œé‚£ä¹ˆå­˜å‚¨å•å…ƒçš„å†…å®¹å°±ä¼šè¢«é€åˆ°MDRä¸­</li></ul><p>æ–¹å‘çš„æ§åˆ¶æ˜¯ç”±è¯»å†™ç”µè·¯æ¥æ§åˆ¶çš„ã€‚</p><h4 id="2-1-2-ä¸»å­˜ä¸CPUä¹‹é—´çš„å…³ç³»"><a href="#2-1-2-ä¸»å­˜ä¸CPUä¹‹é—´çš„å…³ç³»" class="headerlink" title="2.1.2 ä¸»å­˜ä¸CPUä¹‹é—´çš„å…³ç³»"></a>2.1.2 ä¸»å­˜ä¸CPUä¹‹é—´çš„å…³ç³»</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230506000218365.png" alt="image-20230506000218365" style="zoom: 40%;"><p>æ•°æ®æ€»çº¿å®ŒæˆCPUå’Œä¸»å­˜çš„ä¿¡æ¯ä¼ è¾“<br>åœ°å€æ€»çº¿ç»™å‡ºè¦è®¿é—®çš„å†…å­˜å•å…ƒçš„åœ°å€</p><h4 id="2-1-3-ä¸»å­˜ä¸­å­˜å‚¨å•å…ƒåœ°å€çš„åˆ†é…"><a href="#2-1-3-ä¸»å­˜ä¸­å­˜å‚¨å•å…ƒåœ°å€çš„åˆ†é…" class="headerlink" title="2.1.3 ä¸»å­˜ä¸­å­˜å‚¨å•å…ƒåœ°å€çš„åˆ†é…"></a>2.1.3 ä¸»å­˜ä¸­å­˜å‚¨å•å…ƒåœ°å€çš„åˆ†é…</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/88abe0b5048349bdb560acdf4a42ff48.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å‡è®¾å­˜å‚¨å­—é•¿ä¸º32ä½(å¯¹å­˜å‚¨å™¨çš„æŸä¸€ä¸ªå•å…ƒè¿›è¡Œè¯»æˆ–å†™çš„è¯ï¼Œä¸€æ¬¡æœ€å¤šè¯»æˆ–å†™32ä½0ï¼Œ1)ï¼Œä¸»å­˜çš„ç¼–å€å•ä½æ˜¯å­—èŠ‚ï¼Œæ¯ä¸€ä¸ªå­—èŠ‚éƒ½æœ‰è‡ªå·±çš„åœ°å€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­˜å‚¨å­—æ˜¯32ä½ï¼Œä¸€ä¸ªå­—èŠ‚æ˜¯å…«ä½ï¼Œéƒ½æœ‰è‡ªå·±çš„åœ°å€ã€‚<br>é‚£ä¹ˆ12345678Hè¿™ä¸ªæ•°æ®æ€ä¹ˆåœ¨ä¸»å­˜å‚¨å™¨ä¸­è¿›è¡Œå­˜å‚¨ï¼Ÿ</p><ul><li>ä¸€ç§æ–¹æ³•æ˜¯é«˜ä½å­—èŠ‚åœ°å€ä½œä¸ºå­˜å‚¨å™¨çš„åœ°å€(å­—åœ°å€)ï¼Œè¿™ç§æ–¹å¼ä¹Ÿå«å¤§ç«¯æ–¹å¼</li><li>ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½ä½å­—èŠ‚ä½œä¸ºå­—åœ°å€ï¼Œè¿™ç§æ–¹å¼å«åšå°ç«¯æ–¹å¼</li></ul><h4 id="2-1-4-ä¸»å­˜çš„æŠ€æœ¯æŒ‡æ ‡"><a href="#2-1-4-ä¸»å­˜çš„æŠ€æœ¯æŒ‡æ ‡" class="headerlink" title="2.1.4 ä¸»å­˜çš„æŠ€æœ¯æŒ‡æ ‡"></a>2.1.4 ä¸»å­˜çš„æŠ€æœ¯æŒ‡æ ‡</h4><p>â‘ å­˜å‚¨å®¹é‡ï¼šä¸»å­˜å­˜æ”¾äºŒè¿›åˆ¶ä»£ç çš„æ€»ä½æ•°<br>â‘¡å­˜å‚¨é€Ÿåº¦</p><ul><li>å­˜å–æ—¶é—´(ä»å­˜å‚¨å™¨ç»™å‡ºåœ°å€åˆ°è·å¾—ç¨³å®šçš„è¾“å…¥è¾“å‡º) å­˜å‚¨å™¨çš„è®¿é—®æ—¶é—´<ul><li>è¯»å‡ºæ—¶é—´ å†™å…¥æ—¶é—´</li></ul></li><li>å­˜å–å‘¨æœŸ<ul><li>è¿ç»­ä¸¤æ¬¡ç‹¬ç«‹çš„å­˜å‚¨å™¨æ“ä½œ(è¯»æˆ–å†™)æ‰€éœ€çš„æœ€å°é—´éš”æ—¶é—´</li><li>å­˜å–å‘¨æœŸä¸€èˆ¬å¤§äºå­˜å–æ—¶é—´</li></ul></li></ul><p>â‘¢å­˜å‚¨å™¨å¸¦å®½</p><ul><li>å•ä½æ—¶é—´å†…å­˜å‚¨å™¨å­˜å–çš„ä¿¡æ¯é‡ï¼Œç”¨å­—&#x2F;ç§’ã€å­—èŠ‚&#x2F;ç§’æˆ–ä½&#x2F;ç§’è¡¨ç¤º</li><li>è¡¡é‡æ•°æ®ä¼ è¾“é€Ÿç‡çš„é‡è¦æŒ‡æ ‡ï¼Œå†³å®šäº†ä»¥å­˜å‚¨å™¨ä¸ºä¸­å¿ƒçš„è®¡ç®—æœºç³»ç»Ÿè·å¾—ä¿¡æ¯çš„é€Ÿåº¦ï¼Œæ˜¯æ”¹å–„æœºå™¨æ€§èƒ½ç“¶é¢ˆçš„ä¸€ä¸ªå…³é”®å› ç´ </li></ul><h3 id="2-2-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡ç®€ä»‹"><a href="#2-2-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡ç®€ä»‹" class="headerlink" title="2.2 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡ç®€ä»‹"></a>2.2 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡ç®€ä»‹</h3><h4 id="2-2-1-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„åŸºæœ¬ç»“æ„"><a href="#2-2-1-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„åŸºæœ¬ç»“æ„" class="headerlink" title="2.2.1 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„åŸºæœ¬ç»“æ„"></a>2.2.1 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„åŸºæœ¬ç»“æ„</h4><ul><li>é‡‡ç”¨è¶…å¤§è§„æ¨¡é›†æˆç”µè·¯åˆ¶é€ å·¥è‰ºï¼Œåœ¨ä¸€ä¸ªèŠ¯ç‰‡å†…é›†æˆå…·æœ‰è®°å¿†åŠŸèƒ½çš„å­˜å‚¨çŸ©é˜µã€è¯‘ç é©±åŠ¨ç”µè·¯å’Œè¯»&#x2F;å†™ç”µè·¯ç­‰</li><li>è¯‘ç é©±åŠ¨ï¼šæŠŠåœ°å€æ€»çº¿é€è¿‡æ¥çš„åœ°å€ä¿¡å·ç¿»è¯‘æˆå¯¹åº”å­˜å‚¨å•å…ƒçš„é€‰æ‹©ä¿¡å·</li><li>è¯»å†™ç”µè·¯ï¼šåŒ…æ‹¬è¯»å†™æ”¾å¤§å™¨å’Œå†™å…¥ç”µè·¯ï¼Œç”¨äºå®Œæˆè¯»å†™æ“ä½œ</li></ul><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230507213936324.png" alt="image-20230507213936324" style="zoom:67%;"><p>å­˜å‚¨èŠ¯ç‰‡é€šè¿‡åœ°å€æ€»çº¿ã€æ•°æ®æ€»çº¿å’Œæ§åˆ¶æ€»çº¿ä¸å¤–éƒ¨è¿æ¥</p><ul><li>åœ°å€çº¿ï¼šå•å‘è¾“å…¥ï¼Œå…¶ä½æ•°ä¸èŠ¯ç‰‡å®¹é‡æœ‰å…³</li><li>æ•°æ®çº¿ï¼šåŒå‘è¾“å…¥&#x2F;è¾“å‡ºï¼Œå…¶ä½æ•°ä¸èŠ¯ç‰‡å¯ä¸€æ¬¡è¯»å‡ºæˆ–å†™å…¥çš„æ•°æ®æœ‰å…³</li></ul><blockquote><p>åœ°å€çº¿å’Œæ•°æ®çº¿çš„ä½å®½ï¼Œå…±åŒååº”äº†å­˜å‚¨èŠ¯ç‰‡çš„å®¹é‡ã€‚ä¾‹å¦‚ï¼šåœ°å€çº¿10æ ¹ï¼Œæ•°æ®çº¿4æ ¹ï¼Œåˆ™è¡¨ç¤ºå­˜å‚¨èŠ¯ç‰‡çš„å­˜å‚¨å•å…ƒä¸º2^10ï¼Œæ¯ä¸ªå•å…ƒçš„æ•°æ®å®½åº¦ä¸º4ä½ï¼Œåˆ™èŠ¯ç‰‡çš„å®¹é‡ä¸º2^10 * 4b &#x3D; 4Kb</p></blockquote><ul><li>æ§åˆ¶çº¿ï¼šä¸»è¦æœ‰è¯»å†™æ§åˆ¶çº¿å’Œç‰‡é€‰çº¿2ç§ï¼š<ul><li>è¯»å†™æ§åˆ¶çº¿ï¼šå†³å®šèŠ¯ç‰‡è¿›è¡Œè¯»è¿˜æ˜¯å†™ï¼Œå¯ä»¥è¯»å†™åˆ†å¼€2æ ¹çº¿ï¼Œä¹Ÿå¯ä»¥åˆç”¨ä¸€æ ¹</li><li>ç‰‡é€‰çº¿ï¼šç”¨æ¥åœ¨å­˜å‚¨çŸ©é˜µä¸­é€‰æ‹©å­˜å‚¨èŠ¯ç‰‡ï¼Œå¯èƒ½æœ‰å¤šæ ¹çº¿</li></ul></li></ul><h4 id="2-2-2-å­˜å‚¨èŠ¯ç‰‡ç‰‡é€‰çº¿çš„ä½œç”¨"><a href="#2-2-2-å­˜å‚¨èŠ¯ç‰‡ç‰‡é€‰çº¿çš„ä½œç”¨" class="headerlink" title="2.2.2 å­˜å‚¨èŠ¯ç‰‡ç‰‡é€‰çº¿çš„ä½œç”¨"></a>2.2.2 å­˜å‚¨èŠ¯ç‰‡ç‰‡é€‰çº¿çš„ä½œç”¨</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230507214503803.png" alt="image-20230507214503803" style="zoom:67%;"><p>åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡å®ƒçš„ç‰‡é€‰çº¿ä¸€èˆ¬æœ‰2ä¸­æ ‡è¯†æ–¹å¼ï¼Œ<br>$$<br>\overline{\text{CS}}ã€\overline{\text{CE}}<br>$$<br>ä¸Šé¢çš„ä¸€æ¨ªè¡¨ç¤ºä½ç”µå¹³æœ‰æ•ˆï¼ŒCSæ˜¯èŠ¯ç‰‡é€‰æ‹©çš„ç¼©å†™ã€‚</p><blockquote><p><strong>16K Ã— 1ä½</strong>è¯´æ˜èŠ¯ç‰‡çš„å­˜å‚¨å®¹é‡æ˜¯16Kï¼Œæ¯ä¸€ä¸ªå­˜å‚¨å•å…ƒä¿å­˜1ä½ä¿¡æ¯ã€‚<br>å¦‚æœæˆ‘ä»¬ç”¨8ä¸ªè¿™æ ·çš„èŠ¯ç‰‡ï¼Œå¯¹8ä¸ªèŠ¯ç‰‡åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè¿™8ä¸ªèŠ¯ç‰‡æ„æˆä¸€ç»„ï¼Œè¿™8ä¸ªèŠ¯ç‰‡å°±æ„æˆäº†16K Ã— 8ä½çš„å­˜å‚¨å™¨<br>ä¸ºäº†æ»¡è¶³é¢˜ç›®çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°±åº”è¯¥å¸ƒç½®4ç»„è¿™æ ·çš„èŠ¯ç‰‡ã€‚<br>æ¯ä¸€ç»„çš„8ä¸ªèŠ¯ç‰‡è¦åŒæ—¶è¿›è¡Œå·¥ä½œ<br>æ¥ä¸‹æ¥å¯¹åœ°å€ç©ºé—´è¿›è¡Œåˆ’åˆ†<br>ç¬¬ä¸€ç»„èŠ¯ç‰‡: 0åˆ°16K-1<br>ç¬¬äºŒç»„èŠ¯ç‰‡:16Kåˆ°32K-1<br>ç¬¬ä¸‰ç»„èŠ¯ç‰‡:32Kåˆ°48K-1<br>ç¬¬å››ç»„èŠ¯ç‰‡:48Kåˆ°64K-1<br>å¦‚æœæˆ‘ä»¬è¦è®¿é—®çš„åœ°å€æ˜¯65535ï¼Œä¹Ÿå°±æ˜¯64K-1ï¼ŒæŒ‰ç…§æˆ‘ä»¬åˆ’åˆ†çš„è§„åˆ™ï¼Œå®ƒåº”è¯¥åœ¨ç¬¬å››ç»„èŠ¯ç‰‡ï¼Œæ­¤8ç‰‡çš„ç‰‡é€‰æœ‰æ•ˆã€‚ç‰‡é€‰ä¿¡å·çœ‹åˆ°è¿™ä¸ªåœ°å€åï¼Œå°±é€‰æ‹©ç¬¬å››ç»„èŠ¯ç‰‡ï¼Œå…¶ä»–ä¸‰ç»„èŠ¯ç‰‡çš„ç‰‡é€‰ä¿¡å·æ˜¯æ— æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯é«˜ç”µå¹³ï¼Œæœ€åä¸€ç»„å¯¹åº”çš„ä¿¡å·æ˜¯ä½ç”µå¹³ï¼Œä¹Ÿå°±æ˜¯æœ‰æ•ˆçš„ã€‚<br>ç‰‡é€‰ä¿¡å·çš„ä½œç”¨æ˜¯è®©æŸä¸ªèŠ¯ç‰‡æˆ–è€…æŸäº›èŠ¯ç‰‡åŒæ—¶è¿›è¡Œå·¥ä½œã€‚</p></blockquote><h4 id="2-2-3-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„è¯‘ç é©±åŠ¨æ–¹å¼"><a href="#2-2-3-åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„è¯‘ç é©±åŠ¨æ–¹å¼" class="headerlink" title="2.2.3 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„è¯‘ç é©±åŠ¨æ–¹å¼"></a>2.2.3 åŠå¯¼ä½“å­˜å‚¨èŠ¯ç‰‡çš„è¯‘ç é©±åŠ¨æ–¹å¼</h4><p>è¯‘ç é©±åŠ¨æ–¹å¼å°±æ˜¯è¯´ï¼Œç»™å‡ºå­˜å‚¨å•å…ƒçš„åœ°å€åï¼Œæ€ä¹ˆæ‰¾åˆ°æŒ‡å®šçš„å­˜å‚¨å•å…ƒï¼Œå¯ä»¥æœ‰ä¸¤ç§æ–¹å¼æ¥æ‰¾åˆ°æŒ‡å®šçš„å­˜å‚¨å•å…ƒï¼Œ</p><p><strong>ï¼ˆ1ï¼‰çº¿é€‰æ³•</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/a2e5a6340fda4db982f1d4179089a578.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;"><p>ç»™å‡ºA0åˆ°A3å››ä½åœ°å€ï¼Œè¯´æ˜æœ‰16ä¸ªå­˜å‚¨å•å…ƒï¼Œæ¯ä¸€ä¸ªå­˜å‚¨å•å…ƒæœ‰å¤šå°‘ä½ï¼Œå°±éœ€è¦çœ‹æ•°æ®çº¿ï¼Œæ•°æ®çº¿æ˜¯ä»D0åˆ°D7ï¼Œè¯´æ˜æœ‰8ä½ï¼Œè¿™ä¸ªå­˜å‚¨å™¨æ˜¯16Ã—8</p><p>æ¥ä¸‹æ¥çœ‹çœ‹å·¥ä½œè¿‡ç¨‹ï¼š</p><p>å¦‚æœç»™å‡ºçš„åœ°å€æ˜¯å…¨0ï¼Œè¢«è¯‘ç åçš„ä¿¡å·åªæœ‰0çš„è¿™æ ¹çº¿æ˜¯æœ‰æ•ˆçš„ï¼Œå…¶ä»–çš„çº¿æ˜¯æ— æ•ˆçš„ã€‚å¦‚æœç°åœ¨è¿›è¡Œçš„æ˜¯è¯»æ“ä½œï¼Œè¯»ä¿¡å·ä¼šæ§åˆ¶ç”µè·¯çš„é€šè·¯æ‰“å¼€ï¼Œä½¿æ•°æ®å¯ä»¥ä»å­˜å‚¨çŸ©é˜µé€åˆ°æ•°æ®æ€»çº¿ä¸Šï¼Œåªæœ‰ç»™å®šçš„å•å…ƒæ‰å¯ä»¥æ•°æ®çš„è¾“å‡º</p><blockquote><p>è¿™ç§æ–¹æ³•å¯¹å®¹é‡ç¨å¾®å¤§ä¸€ç‚¹çš„èŠ¯ç‰‡æ¥è¯´æ˜¯ä¸åˆé€‚çš„</p></blockquote><p><strong>ï¼ˆ2ï¼‰é‡åˆæ³•</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/db1d4fe8d41843e19a4d0ca6b8b53a79.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;"><p>çº¿æ€§æ³•è¿›è¡Œå¸ƒå±€çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æŠŠå®ƒå¸ƒå±€æˆçº¿æ€§æ•°ç»„ï¼Œé‡åˆæ³•è¿›è¡Œå¸ƒå±€çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æŠŠå®ƒå¸ƒå±€æˆäºŒç»´é˜µåˆ—</p><blockquote><p>è¡Œåœ°å€å’Œåˆ—åœ°å€éƒ½åªèƒ½æœ‰ä¸€æ¡çº¿æ˜¯æœ‰æ•ˆçš„ï¼ŒDDR4å’ŒDDR5çš„åŸç†éƒ½æ˜¯åŸºäºè¿™ä¸ª</p></blockquote><h3 id="2-3-éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰"><a href="#2-3-éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰" class="headerlink" title="2.3 éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰"></a>2.3 éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰</h3><p>RAMåˆ†ä¸ºé™æ€RAM(SRAM)å’ŒåŠ¨æ€RAM(DRAM)ï¼š</p><ul><li>åŠ¨æ€RAMæ˜¯åˆ©ç”¨ç”µå®¹å­˜å‚¨ç”µè·çš„æ–¹å¼å­˜å‚¨æ•°æ®çš„ï¼›</li><li>é™æ€RAMæ˜¯åˆ©ç”¨è§¦å‘å™¨çš„ç¨³æ€ç‰¹æ€§æ¥å­˜å‚¨æ•°æ®çš„ï¼›</li></ul><hr><p>RAM æœ‰ç‚¹åƒâ€œå†…å­˜â€ï¼Œå®é™…ä¸Šæ¶µç›–äº†å‡ ç§ä¸åŒçš„ç±»å‹ã€‚å¤§å¤šæ•°äººåœ¨è®¨è®º RAM æˆ–å†…å­˜æ—¶ï¼Œä»–ä»¬å®é™…ä¸Šè°ˆè®ºçš„å†…å®¹åœ¨æŠ€æœ¯ä¸Šæ˜¯ DRAMï¼ˆåŠ¨æ€éšæœºå­˜å–å†…å­˜ï¼‰ï¼Œæˆ–è€…æ›´å‡†ç¡®åœ°è¯´å¯¹äºç°ä»£ç³»ç»Ÿ <strong>SDRAM</strong>ï¼ˆåŒæ­¥åŠ¨æ€éšæœºå­˜å–å†…å­˜ï¼‰æ›´ä¸ºå‡†ç¡®ã€‚é™¤äº†æŠ€æœ¯æ€§ä¹‹å¤–ï¼Œæœ¯è¯­å¹¶ä¸é‡è¦ï¼Œä½†çŸ¥é“è¿™äº›æœ¯è¯­é€šä¿—åœ°è¯´å¯ä»¥ç›¸äº’äº¤æ¢æ˜¯æœ‰ç”¨çš„ã€‚</p><p>ç›®å‰é”€å”®çš„æœ€å¸¸è§çš„ RAM ç±»å‹æ˜¯ DDR4ï¼Œå°½ç®¡è¾ƒæ—§çš„ç³»ç»Ÿå¯èƒ½ä½¿ç”¨ DDR2 æˆ– DDR3ã€‚è¿™äº›ç®€å•åœ°è¡¨ç¤ºåœ¨ç‰¹å®šç³»ç»Ÿä¸­ä½¿ç”¨çš„ RAM çš„ç”Ÿæˆï¼Œæ¯ä¸ªè¿ç»­çš„ç³»ç»Ÿé€šè¿‡æ›´å¤§çš„å¸¦å®½æä¾›æ›´å¿«çš„é€Ÿåº¦ â€“ æ›´é«˜çš„å…†èµ«ï¼ˆMHzï¼‰ç­‰çº§ã€‚æ¯ä»£äººéƒ½çœ‹åˆ°èº«ä½“çš„å˜åŒ–ï¼Œæ‰€ä»¥ä¸èƒ½äº’æ¢ã€‚</p><p>å¦ä¸€ä¸ªå¸¸è§æœ¯è¯­ï¼Œç‰¹åˆ«æ˜¯åœ¨è§†é¢‘æ¸¸æˆé¢†åŸŸæ˜¯ VRAM æˆ–è§†é¢‘ RAMã€‚è™½ç„¶ VRAM æœ¬èº«å°±æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œä½†å®ƒç°åœ¨ç”¨äºï¼ˆæŠ€æœ¯ä¸Šé”™è¯¯åœ°ï¼‰è¡¨ç¤ºå¯ç”¨äºå›¾å½¢èŠ¯ç‰‡æˆ–å†…ç½®äºå›¾å½¢å¡çš„å†…å­˜ã€‚è¿™å®é™…ä¸Šç§°ä¸ºå›¾å½¢ DDR SDRAMï¼Œæˆ–æ›´å¸¸è§çš„ GDDRã€‚å¤§å¤šæ•°ç°ä»£æ˜¾å¡éƒ½ä¼šä½¿ç”¨ GDDR5ï¼Œå°½ç®¡æœ‰äº›ä½¿ç”¨æ›´æ–°çš„ GDDR5X æ ‡å‡†ï¼Œè€Œæœªæ¥çš„å‡ ä»£ç”šè‡³å¯èƒ½ä¼šæ­é… GDDR6 å†…å­˜ã€‚</p><p>ä¸€äº›å°ä¼—å›¾å½¢å¡é‡‡ç”¨ç§°ä¸ºé«˜å¸¦å®½å†…å­˜ï¼ˆHBM å’Œ HBM2ï¼‰çš„ç‹¬ç‰¹å½¢å¼çš„å†…å­˜ ï¼Œè™½ç„¶å®ƒé€šå¸¸å¾ˆæ˜‚è´µï¼Œä½†ä¾›åº”é—®é¢˜æ„å‘³ç€å®ƒæ²¡æœ‰è¢«å¹¿æ³›é‡‡ç”¨ï¼Œå®ƒå…·æœ‰ä¸€äº›ç‹¬ç‰¹çš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><h3 id="2-4-åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰"><a href="#2-4-åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰" class="headerlink" title="2.4 åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰"></a>2.4 åªè¯»å­˜å‚¨å™¨ï¼ˆROMï¼‰</h3><p>ROMçš„å‘å±•å†ç¨‹ï¼š</p><ul><li>æ—©æœŸçš„åªè¯»å­˜å‚¨å™¨â€”â€“åœ¨å‚å®¶å°±å†™å¥½äº†å†…å®¹</li><li>æ”¹è¿›1â€”â€”â€“ç”¨æˆ·å¯ä»¥è‡ªå·±å†™ï¼Œä¸è¿‡æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œå¦‚æœè¦ä¿®æ”¹ç¨‹åºå°±å¾—é‡æ–°ä¹°èŠ¯ç‰‡ï¼ŒåŸæœ‰çš„èŠ¯ç‰‡çš„æ•°æ®ä¸èƒ½å¤Ÿæ“¦é™¤</li><li>æ”¹è¿›2â€”â€”å¯ä»¥å¤šæ¬¡å†™â€”â€”å¹¶ä¸”å¯ä»¥å¯¹ä¿¡æ¯è¿›è¡Œæ“¦é™¤(æ—©æœŸçš„æ—¶å€™ï¼Œé‚£äº›å¯ä»¥æ“¦é™¤ä¿¡æ¯çš„èŠ¯ç‰‡çš„è®¾å¤‡è¦å•ç‹¬è´­ä¹°ï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿)</li><li>æ”¹è¿›3â€”â€”ç”µå¯æ“¦å†™â€”â€“éœ€è¦ç‰¹å®šè®¾å¤‡</li><li>æ”¹è¿›4â€”â€”ç”µå¯æ“¦å†™â€”â€”ç›´æ¥è¿æ¥åˆ°è®¡ç®—æœºä¸Š</li></ul><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/bcf1404027e6445eb5a94b473f236bab.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h4 id="2-4-1-æ©è†œROMï¼ˆMROMï¼‰â€”â€”åªå¯è¯»"><a href="#2-4-1-æ©è†œROMï¼ˆMROMï¼‰â€”â€”åªå¯è¯»" class="headerlink" title="2.4.1 æ©è†œROMï¼ˆMROMï¼‰â€”â€”åªå¯è¯»"></a>2.4.1 æ©è†œROMï¼ˆMROMï¼‰â€”â€”åªå¯è¯»</h4><p>è¿™ç§ROMæ˜¯ç”±åˆ¶é€ å‚å®¶åˆ©ç”¨ä¸€ç§æ©è†œæŠ€æœ¯å†™å…¥ç¨‹åºçš„ï¼Œæ©è†œROMåˆ¶æˆåï¼Œç”¨æˆ·ä¸èƒ½ä¿®æ”¹ï¼Œæ ¹æ®åˆ¶é€ å·¥è‰ºå¯ä»¥å°†å®ƒä»¬åˆ†ä¸ºMOSå‹å’ŒåŒæå‹ä¸¤ç§ã€‚MOSå‹ROMåŠŸè€—å°ã€é€Ÿåº¦æ…¢ï¼Œé€‚ç”¨äºä¸€èˆ¬å¾®æœºç³»ç»Ÿï¼›è€ŒåŒæå‹åˆ™é€Ÿåº¦å¿«ã€åŠŸè€—å¤§ï¼Œé€‚ç”¨äºé€Ÿåº¦è¾ƒé«˜çš„è®¡ç®—æœºç³»ç»Ÿã€‚</p><h4 id="2-4-2-PROM-ä¸€æ¬¡æ€§ç¼–ç¨‹"><a href="#2-4-2-PROM-ä¸€æ¬¡æ€§ç¼–ç¨‹" class="headerlink" title="2.4.2 PROM (ä¸€æ¬¡æ€§ç¼–ç¨‹)"></a>2.4.2 PROM (ä¸€æ¬¡æ€§ç¼–ç¨‹)</h4><p>å¯ç¼–ç¨‹åªè¯»å­˜å‚¨å™¨ ï¼ˆè‹±è¯­ï¼šProgrammable read-only memoryï¼‰ï¼Œç¼©å†™ä¸º PROM æˆ– FPROMï¼Œæ˜¯ä¸€ç§ç”µè„‘å­˜å‚¨è®°å¿†æ™¶ç‰‡ï¼Œå®ƒå…è®¸ä½¿ç”¨ç§°ä¸ºPROMç¼–ç¨‹å™¨çš„ç¡¬ä»¶å°†æ•°æ®å†™å…¥è®¾å¤‡ä¸­ã€‚åœ¨PROMè¢«ç¼–ç¨‹åï¼Œå®ƒå°±åªèƒ½ä¸“ç”¨é‚£äº›æ•°æ®ï¼Œå¹¶ä¸”ä¸èƒ½è¢«å†ç¼–ç¨‹ï¼Œè¿™ç§è®°å¿†ä½“ç”¨ä½œæ°¸ä¹…å­˜æ”¾ç¨‹å¼ä¹‹ç”¨ã€‚é€šå¸¸ä¼šç”¨äºç”µå­æ¸¸æˆæœºã€æˆ–ç”µå­è¯å…¸è¿™ç±»å¯ç¿»è¯‘è¯­è¨€çš„äº§å“ä¹‹ä¸Šã€‚</p><p>é‡‡ç”¨ç ´åæ€§ç¼–ç¨‹ï¼Œä¸”åªèƒ½ç¼–ç¨‹ä¸€æ¬¡ï¼Œå¦‚æœç¼–ç¨‹æœ‰é”™è¯¯ï¼Œåªèƒ½é‡æ–°è´­ä¹°èŠ¯ç‰‡ã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N3YWRpYW4yMDA4,size_16,color_FFFFFF,t_70.png" alt="img" style="zoom:33%;"><h4 id="2-4-3-EPROM-å¤šæ¬¡æ€§ç¼–ç¨‹"><a href="#2-4-3-EPROM-å¤šæ¬¡æ€§ç¼–ç¨‹" class="headerlink" title="2.4.3 EPROM (å¤šæ¬¡æ€§ç¼–ç¨‹ )"></a>2.4.3 EPROM (å¤šæ¬¡æ€§ç¼–ç¨‹ )</h4><p>EPROMé‡‡ç”¨Nå‹æ²Ÿé“æµ®åŠ¨æ …MOSç”µè·¯ï¼Œéœ€è¦ä¿å­˜0ï¼ŒDç«¯åŠ æ­£ç”µå‹ï¼Œå½¢æˆæµ®åŠ¨æ …ï¼Œéœ€è¦ä¿å­˜1ï¼ŒDç«¯ä¸åŠ æ­£ç”µå‹ï¼Œä¸å½¢æˆæµ®åŠ¨æ …ã€‚</p><p>ç¼–ç¨‹å®Œæˆåï¼ŒEPROMåªèƒ½ç”¨å¼ºç´«å¤–çº¿ç…§å°„æ¥æ“¦é™¤ã€‚é€šè¿‡å°è£…é¡¶éƒ¨èƒ½çœ‹è§ç¡…ç‰‡çš„é€æ˜çª—å£ï¼Œå¾ˆå®¹æ˜“è¯†åˆ«EPROMï¼Œè¿™ä¸ªçª—å£åŒæ—¶ç”¨æ¥è¿›è¡Œç´«å¤–çº¿æ“¦é™¤ã€‚å¯ä»¥å°†EPROMçš„ç»ç’ƒçª—å¯¹å‡†é˜³å…‰ç›´å°„ä¸€æ®µæ—¶é—´å°±å¯ä»¥æ“¦é™¤ã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N3YWRpYW4yMDA4,size_16,color_FFFFFF,t_70-1683468907249-13.png" alt="img" style="zoom: 33%;"><h4 id="2-4-4-EEPROM-å¤šæ¬¡æ€§ç¼–ç¨‹"><a href="#2-4-4-EEPROM-å¤šæ¬¡æ€§ç¼–ç¨‹" class="headerlink" title="2.4.4 EEPROM (å¤šæ¬¡æ€§ç¼–ç¨‹ )"></a>2.4.4 EEPROM (å¤šæ¬¡æ€§ç¼–ç¨‹ )</h4><p>EEPROM (Electrically Erasable Programmable read only memory)æ˜¯æŒ‡å¸¦ç”µå¯æ“¦å¯ç¼–ç¨‹åªè¯»å­˜å‚¨å™¨ã€‚æ˜¯ä¸€ç§æ‰ç”µåæ•°æ®ä¸ä¸¢å¤±çš„å­˜å‚¨èŠ¯ç‰‡ã€‚ EEPROM å¯ä»¥åœ¨ç”µè„‘ä¸Šæˆ–ä¸“ç”¨è®¾å¤‡ä¸Šæ“¦é™¤å·²æœ‰ä¿¡æ¯ï¼Œé‡æ–°ç¼–ç¨‹ã€‚ä¸€èˆ¬ç”¨åœ¨å³æ’å³ç”¨ã€‚</p><p>å¸¸ç”¨åœ¨æ¥å£å¡ä¸­ï¼Œç”¨æ¥å­˜æ”¾ç¡¬ä»¶è®¾ç½®æ•°æ®ã€‚</p><p>ä¹Ÿå¸¸ç”¨åœ¨é˜²æ­¢è½¯ä»¶éæ³•æ‹·è´çš„â€ç¡¬ä»¶é”â€ä¸Šé¢ã€‚</p><p>EEPROMçš„ç‰¹ç‚¹ï¼š</p><ul><li>ç”µå¯æ“¦å†™</li><li>å±€éƒ¨æ“¦å†™</li><li>å…¨éƒ¨æ“¦å†™</li></ul><h4 id="2-4-5-Flash-Memory-é—ªé€Ÿå‹å­˜å‚¨å™¨"><a href="#2-4-5-Flash-Memory-é—ªé€Ÿå‹å­˜å‚¨å™¨" class="headerlink" title="2.4.5 Flash Memory (é—ªé€Ÿå‹å­˜å‚¨å™¨)"></a>2.4.5 Flash Memory (é—ªé€Ÿå‹å­˜å‚¨å™¨)</h4><p>å¿«é—ªå­˜å‚¨å™¨ï¼ˆè‹±è¯­ï¼šflash memoryï¼‰ï¼Œæ˜¯ä¸€ç§ç”µå­å¼å¯æ¸…é™¤ç¨‹åºåŒ–åªè¯»å­˜å‚¨å™¨çš„å½¢å¼ï¼Œå…è®¸åœ¨æ“ä½œä¸­è¢«å¤šæ¬¡æ“¦æˆ–å†™çš„å­˜å‚¨å™¨ã€‚è¿™ç§ç§‘æŠ€ä¸»è¦ç”¨äºä¸€èˆ¬æ€§æ•°æ®å­˜å‚¨ï¼Œä»¥åŠåœ¨è®¡ç®—æœºä¸å…¶ä»–æ•°å­—äº§å“é—´äº¤æ¢ä¼ è¾“æ•°æ®ï¼Œå¦‚å‚¨å­˜å¡ä¸Uç›˜ã€‚</p><p>é—ªå­˜æ˜¯ä¸€ç§éæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼Œå³æ–­ç”µæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚å› ä¸ºé—ªå­˜ä¸åƒRAMï¼ˆéšæœºå­˜å–å­˜å‚¨å™¨ï¼‰ä¸€æ ·ä»¥å­—èŠ‚ä¸ºå•ä½æ”¹å†™æ•°æ®ï¼Œå› æ­¤ä¸èƒ½å–ä»£RAMã€‚</p><p>é—ªå­˜å¡ï¼ˆFlash Cardï¼‰æ˜¯åˆ©ç”¨é—ªå­˜ï¼ˆFlash Memoryï¼‰æŠ€æœ¯è¾¾åˆ°å­˜å‚¨ç”µå­ä¿¡æ¯çš„å­˜å‚¨å™¨ï¼Œä¸€èˆ¬åº”ç”¨åœ¨æ•°ç ç›¸æœºï¼ŒæŒä¸Šç”µè„‘ï¼ŒMP3ç­‰å°å‹æ•°ç äº§å“ä¸­ä½œä¸ºå­˜å‚¨ä»‹è´¨ï¼Œæ‰€ä»¥æ ·å­å°å·§ï¼Œæœ‰å¦‚ä¸€å¼ å¡ç‰‡ï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºé—ªå­˜å¡ã€‚</p><h3 id="2-5-å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥"><a href="#2-5-å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥" class="headerlink" title="2.5 å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥"></a>2.5 å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥</h3><p>CPUæ‰§è¡Œçš„æŒ‡ä»¤éœ€è¦çš„æ•°æ®éƒ½ä¿å­˜åœ¨ä¸»å­˜å‚¨å™¨ä¸­ï¼Œè¿è¡Œçš„ç»“æœä¹Ÿä¿å­˜åœ¨ä¸»å­˜å‚¨å™¨ä¸­ï¼Œæ‰€ä»¥CPUå’Œå­˜å‚¨å™¨è¦è¿›è¡Œæ­£ç¡®çš„è¿æ¥ï¼Œæ‰èƒ½å®ç°ä»–ä»¬ä¹‹é—´ä¿¡æ¯çš„äº¤æ¢</p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒCPUçš„åœ°å€çº¿æ¯”è¾ƒå¤šï¼Œå¯»å€èŒƒå›´ä¹Ÿæ¯”è¾ƒå¤§ã€‚è¦æ„æˆä¸»å­˜å‚¨å™¨ï¼Œéœ€è¦å¤šä¸ªå­˜å‚¨èŠ¯ç‰‡å…±åŒç»„æˆã€‚</p><h4 id="2-5-1-å­˜å‚¨å™¨å®¹é‡çš„æ‰©å±•"><a href="#2-5-1-å­˜å‚¨å™¨å®¹é‡çš„æ‰©å±•" class="headerlink" title="2.5.1 å­˜å‚¨å™¨å®¹é‡çš„æ‰©å±•"></a>2.5.1 å­˜å‚¨å™¨å®¹é‡çš„æ‰©å±•</h4><p>å•ç‰‡å­˜å‚¨èŠ¯ç‰‡çš„å®¹é‡æœ‰é™ï¼Œéœ€è¦å°†è‹¥å¹²å­˜å‚¨èŠ¯ç‰‡è¿åœ¨ä¸€èµ·ç»„æˆå…·æœ‰è¶³å¤Ÿå®¹é‡çš„å­˜å‚¨å™¨ï¼Œæ‰€éœ€èŠ¯ç‰‡æ•°é‡çš„è®¡ç®—å…¬å¼ï¼š</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/e17c0a8d820143eb953d6bf14339cffc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:50%;"><p>ä½æ‰©å±•ï¼šå¢åŠ å­˜å‚¨å™¨çš„æ¨ªå‘å®¹é‡<br>å­—æ‰©å±•ï¼šå¢åŠ å­˜å‚¨å™¨çš„çºµå‘å®¹é‡</p><p><strong>ï¼ˆ1ï¼‰ä½æ‰©å±•(ä¸ºäº†å¢åŠ å­˜å‚¨å­—é•¿)</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230507230536721.png" alt="image-20230507230536721" style="zoom: 50%;"><p>ç”¨2ç‰‡1KÃ—4ä½çš„å­˜å‚¨èŠ¯ç‰‡ç»„æˆ1KÃ—8ä½çš„å­˜å‚¨å™¨</p><p>ä¸¤ä¸ªèŠ¯ç‰‡è¦èƒ½åŒæ—¶å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¦æŠŠä¸¤ä¸ªèŠ¯ç‰‡çš„ç‰‡é€‰ç”¨ç›¸åŒä¿¡å·è¿æ¥</p><blockquote><p>åœ°å€çº¿å’Œæ§åˆ¶çº¿å…¬ç”¨<br>æ•°æ®çº¿å•ç‹¬åˆ†å¼€</p></blockquote><p><strong>ï¼ˆ2ï¼‰å­—æ‰©å±•(å¢åŠ å­˜å‚¨å­—çš„æ•°é‡)</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230507230753703.png" alt="image-20230507230753703" style="zoom:50%;"><blockquote><p>åœ°å€çº¿å’Œæ•°æ®çº¿å…¬ç”¨<br>è¯»å†™æ§åˆ¶çº¿å…¬ç”¨<br>ç‰‡é€‰ä½¿èƒ½æ§åˆ¶çº¿ç‹¬ç«‹ï¼Œé€šè¿‡åœ°å€çš„é«˜ä½å­—æ®µè¿›è¡Œè¯‘ç å†³å®š</p></blockquote><p>å¯¹ç¬¬ä¸€ä¸ªèŠ¯ç‰‡æ¥è¯´ï¼Œå®ƒç”¨çš„åœ°å€çº¿æ˜¯A0~A9ï¼Œå¦‚æœA10ä¸º0ï¼Œæˆ‘ä»¬å°±é€‰æ‹©ç¬¬ä¸€ä¸ªèŠ¯ç‰‡ï¼ŒA10å¦‚æœä¸º1.æˆ‘ä»¬å°±é€‰æ‹©ç¬¬äºŒä¸ªèŠ¯ç‰‡ï¼ŒA10å°±æ˜¯æˆ‘ä»¬çš„ç‰‡é€‰ä¿¡å·</p><p>ä»00000000000 ~ 01111111111ï¼Œè¿™1Kçš„å­˜å‚¨ç©ºé—´åˆ†é…ç»™ç¬¬ä¸€ä¸ªèŠ¯ç‰‡</p><p>ä»10000000000 ~ 11111111111 ï¼Œè¿™1Kçš„å­˜å‚¨ç©ºé—´åˆ†é…ç»™ç¬¬äºŒä¸ªèŠ¯ç‰‡</p><p><strong>ï¼ˆ3ï¼‰å­—ã€ä½æ‰©å±•</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/fdfd8ac372a8451dade364a7eba263c9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>é€šè¿‡A10,A11æ¥åˆ¤æ–­æˆ‘ä»¬è¦è®¿é—®çš„èŠ¯ç‰‡æ˜¯å“ªä¸€ç»„<br>00é€‰æ‹©ç¬¬ä¸€ç»„èŠ¯ç‰‡<br>01é€‰æ‹©ç¬¬äºŒç»„èŠ¯ç‰‡<br>10é€‰æ‹©ç¬¬ä¸‰ç»„èŠ¯ç‰‡<br>11é€‰æ‹©ç¬¬å››ç»„èŠ¯ç‰‡</p><h4 id="2-5-2-å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥"><a href="#2-5-2-å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥" class="headerlink" title="2.5.2 å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥"></a>2.5.2 å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥</h4><ul><li>å­˜å‚¨èŠ¯ç‰‡ä¸CPUèŠ¯ç‰‡ç›¸è¿ï¼Œä¸»è¦æ³¨æ„ç‰‡ä¸ç‰‡ä¹‹é—´çš„ä¸‰ç§ä¿¡å·çº¿çš„è¿æ¥</li><li>åœ°å€çº¿çš„è¿æ¥<ul><li>CPUçš„åœ°å€çº¿ä¸€èˆ¬æ¯”å­˜å‚¨èŠ¯ç‰‡çš„åœ°å€çº¿å¤š</li><li>CPUåœ°å€çº¿çš„ä½ä½çº¿ä¸å­˜å‚¨èŠ¯ç‰‡çš„åœ°å€çº¿ç›¸è¿</li><li>CPUåœ°å€çº¿çš„é«˜ä½çº¿æˆ–ç”¨äºå­˜å‚¨æ‰©å±•ï¼Œæˆ–ç”¨äºç‰‡é€‰ç­‰å…¶ä»–ç”¨é€”</li></ul></li><li>æ•°æ®çº¿çš„è¿æ¥<ul><li>å­˜å‚¨èŠ¯ç‰‡çš„æ•°æ®çº¿åº”ä¸CPUçš„æ•°æ®çº¿æ•°é‡ç›¸åŒï¼Œè‹¥å­˜å‚¨èŠ¯ç‰‡æ•°æ®çº¿ä¸å¤Ÿï¼Œéœ€å¯¹å…¶è¿›è¡Œä½æ‰©å±•</li></ul></li><li>è¯»å†™å‘½ä»¤æ§åˆ¶çº¿çš„è¿æ¥<ul><li>CPUçš„è¯»å†™å‘½ä»¤çº¿ä¸€èˆ¬å¯ä»¥ç›´æ¥è¿åˆ°å­˜å‚¨èŠ¯ç‰‡çš„è¯»å†™æ§åˆ¶å™¨ï¼Œé€šå¸¸é«˜ç”µå¹³ä¸ºè¯»ï¼Œä½ç”µå¹³ä¸ºå†™</li><li>è‹¥è¯»å†™å‘½ä»¤çº¿åˆ†å¼€ï¼Œåˆ™åˆ†åˆ«è¿åˆ°å¯¹åº”çš„èŠ¯ç‰‡æ§åˆ¶ç«¯</li></ul></li><li>ç‰‡é€‰çº¿çš„è¿æ¥<ul><li>CPUä¸å­˜å‚¨èŠ¯ç‰‡æ­£ç¡®å·¥ä½œçš„å…³é”®</li><li>ç‰‡é€‰æœ‰æ•ˆä¿¡å·ä¸CPUçš„è®¿å­˜æ§åˆ¶ä¿¡å·MREQï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰æœ‰å…³ï¼Œæµ·åŸŸåœ°å€çº¿ï¼ˆä¸€èˆ¬ä¸ºé«˜ä½çº¿ï¼‰æœ‰å…³</li><li>é€šå¸¸éœ€è¦ç”¨åˆ°ä¸€äº›é€»è¾‘ç”µè·¯æ¥äº§ç”Ÿç‰‡é€‰ä¿¡å·ï¼Œå¦‚è¯‘ç å™¨å’Œé—¨ç”µè·¯</li></ul></li><li>åˆç†é€‰æ‹©å­˜å‚¨èŠ¯ç‰‡<ul><li>å­˜å‚¨èŠ¯ç‰‡ç±»å‹ï¼ˆRAMæˆ–ROMï¼‰å’Œæ•°é‡çš„é€‰æ‹©</li><li>ROMï¼šé€šå¸¸ç”¨äºå­˜æ”¾ç³»ç»Ÿç¨‹åºã€æ ‡å‡†å‡½æ•°åº“æˆ–å„ç±»å¸¸æ•°ç­‰</li><li>RAMï¼šç”¨äºç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œä¸ºç”¨æˆ·ç¼–ç¨‹è€Œè®¾ç½®</li><li>è€ƒè™‘èŠ¯ç‰‡æ•°é‡æ—¶ï¼Œåº”å°½é‡ä½¿è¿çº¿ç®€å•æ–¹ä¾¿</li></ul></li><li>å…¶ä»–è€ƒè™‘ï¼Œå¦‚æ—¶åºé…åˆã€é€Ÿåº¦ã€è´Ÿè½½ç­‰</li></ul><p>ã€<strong>ä¾‹é¢˜1</strong>ã€‘</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/680eeb03576f492486b0aeddd407ada5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:90%;"><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/c4112880392d4101a60d444103db1470.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:90%;"><p>â‘ å†™å‡ºå¯¹åº”çš„äºŒè¿›åˆ¶åœ°å€ç ã€CPUä½åœ°å€çº¿å¯¹åº”å­˜å‚¨å™¨åœ°å€çº¿ã€‘</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230508232722251.png" alt="image-20230508232722251" style="zoom: 50%;"><p>æˆ‘ä»¬å¯ä»¥çœ‹æˆå‡ºA15åˆ°A11æ˜¯å›ºå®šçš„ï¼ŒA10åˆ°A0æ˜¯è¿ç»­çš„åœ°å€ï¼Œä»å…¨0åˆ°å…¨1ï¼Œä¸€å…±æ˜¯2KÃ—8ä½ï¼Œè¿™éƒ¨åˆ†å­˜æ”¾ç³»ç»Ÿç¨‹åºã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230508232750023.png" alt="image-20230508232750023" style="zoom:50%;"><p>ä»¬å¯ä»¥çœ‹æˆå‡ºA15åˆ°A10æ˜¯å›ºå®šçš„ï¼ŒA9åˆ°A0æ˜¯è¿ç»­çš„åœ°å€ï¼Œä»å…¨0åˆ°å…¨1ï¼Œä¸€å…±æ˜¯1KÃ—8ä½ï¼Œè¿™éƒ¨åˆ†å­˜æ”¾ç”¨æˆ·ç¨‹åºï¼Œ1KÃ—8ä½æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤ä¸ª1KÃ—4ä½çš„èŠ¯ç‰‡ã€‚</p><p>â‘¡èŠ¯ç‰‡çš„é€‰æ‹©</p><ul><li>å¯¹åº”ç³»ç»Ÿç¨‹åºåŒºï¼Œæˆ‘ä»¬åº”è¯¥é€‰æ‹©ROM,ç”¨1ç‰‡2KÃ—8</li><li>ç”¨æˆ·ç¨‹åºåŒºè¦å¯è¯»å¯å†™ï¼Œé€‰æ‹©RAMï¼Œç”¨2ç‰‡1KÃ—4</li></ul><p>â‘¢åˆ†é…åœ°å€çº¿</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/1f00a8fe5b1b4e0db3a7d48a82f165f5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>â‘£ç¡®å®šç‰‡é€‰ä¿¡å·</p><p>æ ¹æ®74138è¯‘ç é€»è¾‘å…³ç³»ï¼Œå¿…é¡»ä¿è¯æ§åˆ¶ç«¯G1ä¸ºé«˜ç”µå¹³ï¼ŒG2Aå’ŒG2Bä¸ºä½ç”µå¹³ï¼Œè¯‘ç å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œ</p><p>A15å§‹ç»ˆä¸ºä½ã€A14å§‹ç»ˆä¸ºé«˜ï¼Œåˆ†åˆ«æ¥G2Aå’ŒG1ï¼›è€ŒMREQä½ç”µå¹³æœ‰æ•ˆï¼Œæ¥G2B<br>å‰©ä¸‹A13ã€A12ã€A11ï¼Œåˆ†åˆ«æ¥è¯‘ç å™¨çš„è¾“å…¥ç«¯Cã€Bã€Aè¯‘ç ç»“æœä¸º4ï¼ˆY4æœ‰æ•ˆï¼‰ï¼Œé€‰ä¸­ROMï¼›è¯‘ç ç»“æœä¸º5ï¼ˆY5æœ‰æ•ˆï¼‰ï¼Œä¸A10ä¸€èµ·é€šè¿‡ä¸é—¨ï¼Œéƒ½ä¸ºä½ç”µå¹³æœ‰æ•ˆæ—¶ï¼Œé€‰ä¸­2ç‰‡RAMã€‚<br><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230508232909198.png" alt="image-20230508232909198" style="zoom: 67%;"></p><p>ã€<strong>ä¾‹é¢˜2</strong>ã€‘</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/2ad6f7d4165b44b1b875a976a9977ca0.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/c8552a74c7cd4bedbb02d9d1e24f7400.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/4d9d942d74874f0199486b4e71a2dad7.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h3 id="2-6-å­˜å‚¨å™¨çš„æ ¡éªŒ"><a href="#2-6-å­˜å‚¨å™¨çš„æ ¡éªŒ" class="headerlink" title="2.6 å­˜å‚¨å™¨çš„æ ¡éªŒ"></a>2.6 å­˜å‚¨å™¨çš„æ ¡éªŒ</h3><p>ç¼–ç çš„æ£€æµ‹èƒ½åŠ›å’Œçº é”™èƒ½åŠ›ä¸ä»»æ„ä¸¤ç»„åˆæ³•ä»£ç ä¹‹é—´äºŒè¿›åˆ¶ä½çš„æœ€å°‘å·®å¼‚æ•°æœ‰å…³</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/87a0b27134564de98358e5fa09ff5030.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¦‚æœå‡ºé”™åçš„ä»£ç ä¾ç„¶æ˜¯åˆæ³•ä»£ç ï¼Œè®¡ç®—æœºå‹æ ¹æ£€æµ‹ä¸å‡ºå‡ºé”™çš„ä»£ç </p><blockquote><p>ç¼–ç çš„æœ€å°è·ç¦»å°±æ˜¯æŒ‡ä»»æ„çš„ä¸¤ç»„åˆæ³•ä»£ç ä¹‹é—´äºŒè¿›åˆ¶ä½æ•°çš„æœ€å°‘å·®å¼‚</p><p>ç¼–ç çš„çº é”™ï¼Œæ ¡é”™èƒ½åŠ›å’Œç¼–ç çš„æœ€å°è·ç¦»æœ‰å…³</p></blockquote><h3 id="2-7-æé«˜è®¿å­˜é€Ÿåº¦çš„æªæ–½"><a href="#2-7-æé«˜è®¿å­˜é€Ÿåº¦çš„æªæ–½" class="headerlink" title="2.7 æé«˜è®¿å­˜é€Ÿåº¦çš„æªæ–½"></a>2.7 æé«˜è®¿å­˜é€Ÿåº¦çš„æªæ–½</h3><ul><li>é‡‡ç”¨é«˜é€Ÿå™¨ä»¶ï¼Œè®©å†…å­˜é€Ÿåº¦æ›´å¿«</li><li>é‡‡ç”¨å±‚æ¬¡ç»“æ„Cache-ä¸»å­˜ï¼ŒæŠŠå¸¸ç”¨ä¿¡æ¯æ”¾åœ¨Cacheä¸­ï¼ŒCacheç”±é™æ€RAMåšçš„ï¼Œé€Ÿåº¦å¿«ï¼Œé›†æˆåº¦é«˜ï¼ŒåŠŸè€—ä½</li><li>è°ƒæ•´ä¸»å­˜ç»“æ„</li><li>é«˜æ€§èƒ½å­˜å‚¨èŠ¯ç‰‡</li></ul><h4 id="2-7-1-è°ƒæ•´ä¸»å­˜ç»“æ„"><a href="#2-7-1-è°ƒæ•´ä¸»å­˜ç»“æ„" class="headerlink" title="2.7.1 è°ƒæ•´ä¸»å­˜ç»“æ„"></a>2.7.1 è°ƒæ•´ä¸»å­˜ç»“æ„</h4><p><strong>ï¼ˆ1ï¼‰å•ä½“å¤šå­—ç³»ç»Ÿ</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/698fd0d23bc14441a2c0f2a3eb30bb8c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><blockquote><p>å…³äºå­˜å‚¨å­—é•¿ï¼Œæœºå™¨å­—é•¿ï¼š<a href="https://blog.csdn.net/weixin_45609535/article/details/124323238">https://blog.csdn.net/weixin_45609535/article/details/124323238</a></p><ul><li>å­˜å‚¨å­—é•¿ï¼šä¸€ä¸ªå­˜å‚¨å•å…ƒä¸­äºŒè¿›åˆ¶ä»£ç çš„ä½æ•°ï¼ˆé€šå¸¸å’ŒMDRä½æ•°ç›¸åŒï¼‰</li><li>æœºå™¨å­—é•¿ï¼šCPUè¿›è¡Œä¸€æ¬¡æ•´æ•°è¿ç®—æ‰€èƒ½å¤„ç†çš„äºŒè¿›åˆ¶æ•°æ®çš„ä½æ•°</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œå•ç‹¬è¯´å­—æˆ–å­—é•¿æ—¶ï¼Œå¾€å¾€æŒ‡çš„æ˜¯ æœºå™¨å­—ï¼Œå…¶å­—é•¿å³ä¸ºè®¡ç®—æœºä¸€æ¬¡èƒ½ç›´æ¥å¤„ç†çš„äºŒè¿›åˆ¶æ•°æ®çš„ä½æ•°ï¼Œè¿™ä¸ªä¸»è¦å–å†³äºCPUå†…éƒ¨æ•°æ®æ€»çº¿çš„ä½å®½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ¬¡èƒ½ä¼ è¾“å¤šå°‘æ•°æ®åˆ°CPUä¸­è¿›è¡Œå¤„ç†ã€‚æ¯”å¦‚8086çš„CPUå†…éƒ¨æ•°æ®æ€»çº¿çš„å®½åº¦ä¸º16ä½ï¼Œå³è¯´æ˜8086æ˜¯16ä½æœºï¼Œæ‰€ä»¥å…¶å­—é•¿ä¸º16ã€‚åŒç†ï¼Œ32ä½æœºå…¶æœºå™¨å­—é•¿ä¸º32ï¼Œ64ä½æœºå…¶æœºå™¨å­—é•¿ä¸º64.</p></blockquote><p>å‡è®¾CPUæ˜¯16ä½ï¼Œå­˜å‚¨å™¨çš„å­˜å‚¨å­—é•¿æ˜¯64ä½ï¼ŒCPUæ¯ä¸€æ¬¡è®¿é—®å­˜å‚¨å™¨ï¼Œéƒ½å¯ä»¥è®¿é—®å‡º4ä¸ªæœºå™¨å­—ï¼Œè¿™4ä¸ªæœºå™¨å­—ï¼Œæ¯ä¸€ä¸ªéƒ½å¯ä»¥æ˜¯ä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œåˆæˆ–è€…æ˜¯é•¿åº¦ä¸º16çš„æ•°æ®ã€‚</p><p>CPUä¸€æ¬¡æŠŠè¿™å››ä¸ªå€¼å–å‡ºæ”¾åœ¨æ•°æ®å¯„å­˜å™¨ä¸­ï¼Œä¸‹ä¸€æ¬¡åœ¨ç”¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥æŠŠéœ€è¦ä½¿ç”¨çš„æŒ‡ä»¤æˆ–æ•°æ®å–èµ°ï¼Œç”¨è¿™ç§æ–¹æ³•å¯ä»¥å¢åŠ å­˜å‚¨å™¨çš„å¸¦å®½ã€‚</p><p>ä½†æ˜¯è¿™ç§æ–¹æ³•ä¹Ÿæœ‰é—®é¢˜ï¼Œå‡è®¾ç°åœ¨CPUè¦å‘å­˜å‚¨å™¨ä¸­æŸä¸€å…±ä¸ªå­˜å‚¨å•å…ƒå†™ä¸€å…±é•¿åº¦ä¸º16çš„å­—ï¼Œå®ƒè¦å…ˆæŠŠå­—å†™åˆ°å•å­—é•¿å¯„å­˜å™¨ä¸­ï¼Œç„¶åå†å†™å…¥åˆ°4ä¸ªå­—é•¿çš„æ•°æ®å¯„å­˜å™¨ä¸­ï¼Œä¹‹åå†å†™åˆ°å­˜å‚¨å™¨ä¸­ã€‚è¿™æ ·äº§ç”Ÿçš„é—®é¢˜å°±æ˜¯ï¼Œæˆ‘ä»¬å¯èƒ½åªéœ€è¦å†™ä¸€ä¸ª16ä½ï¼Œä½†æ˜¯å…¶ä»–çš„48ä½ä¹Ÿä¼šå†™åˆ°ç»™å®šçš„å­˜å‚¨å•å…ƒä¸­ï¼Œè¿™å°±ä¼šé€ æˆç»™å®šçš„å­˜å‚¨å­—æœ‰48ä½è¢«ä¿®æ”¹äº†ï¼Œè¿™ä¸ªä¿®æ”¹å¯èƒ½æ˜¯é”™è¯¯çš„ä¿®æ”¹.</p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬è¦å–å‡ºçš„æ•°æ®æˆ–æŒ‡ä»¤ä¸æ˜¯è¿ç»­çš„å­˜æ”¾åœ¨ç›¸é‚»çš„æŒ‡ä»¤ä¸­çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å–å‡ºçš„æŒ‡ä»¤å¯èƒ½å°±åªæœ‰ä¸€æ¡æ˜¯æœ‰ç”¨çš„ï¼Œå…¶ä»–çš„æŒ‡ä»¤å¹¶æ²¡æœ‰ç”¨<br>å‡ºç°è¿™äº›é—®é¢˜çš„åŸå› ï¼šè™½ç„¶æ¯ä¸€ä¸ªå­˜å‚¨å•å…ƒåŒ…æ‹¬å››ä¸ªæœºå™¨å­—ï¼Œä½†æ˜¯è¿™å››ä¸ªæœºå™¨å­—å­˜å–çš„æ—¶å€™æ˜¯ä»¥æ•´ä½“çš„æ–¹å¼è¿›è¡Œå­˜å–çš„</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¤šä½“å¹¶è¡Œçš„æ–¹å¼</p><p><strong>ï¼ˆ2ï¼‰å¤šä½“å¹¶è¡Œç³»ç»Ÿ</strong> </p><ul><li>é«˜ä½äº¤å‰ é¡ºåºç¼–å€</li></ul><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/3c693c78095844c6a4103cbada1d6208.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><p>é«˜ä½äº¤å‰ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼Œä¼ è¿›æ¥çš„åœ°å€ä¸€ç›´æ˜¯è¿ç»­çš„ï¼Œ é‚£ä¹ˆåŒä¸€ä¸ªå­˜å‚¨ä½“ä¼šå¾ˆç¹å¿™ï¼Œå…¶ä½™çš„å­˜å‚¨ä½“ä¼šå¾ˆé—²ã€‚</p><ul><li>ä½ä½äº¤å‰ å„ä¸ªä½“è½®æµç¼–å€</li></ul><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/83d98363c63b4d0fb49bf0cb3832384f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><p>ä½ä½äº¤å‰çš„ç‰¹ç‚¹ï¼šåœ¨ä¸æ”¹å˜å­˜å–å‘¨æœŸçš„å‰æä¸‹ï¼Œå¢åŠ å­˜å‚¨å™¨çš„å¸¦å®½</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/d90eac5675564a52ba022f172125991e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 50%;"><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/be5b2e83b30d4c498ed95023a22cfb4e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h4 id="2-7-2-é«˜æ€§èƒ½å­˜å‚¨èŠ¯ç‰‡"><a href="#2-7-2-é«˜æ€§èƒ½å­˜å‚¨èŠ¯ç‰‡" class="headerlink" title="2.7.2 é«˜æ€§èƒ½å­˜å‚¨èŠ¯ç‰‡"></a>2.7.2 é«˜æ€§èƒ½å­˜å‚¨èŠ¯ç‰‡</h4><p>ï¼ˆ1ï¼‰SDRAMï¼ˆåŒæ­¥DRAM)</p><blockquote><p>åœ¨ç³»ç»Ÿæ—¶é’Ÿçš„æ§åˆ¶ä¸‹è¿›è¡Œè¯»å‡ºå’Œå†™å…¥<br>CPUæ— éœ€ç­‰å¾…</p></blockquote><p>ï¼ˆ2ï¼‰RDRAM</p><blockquote><p>ä¸»è¦è§£å†³å­˜å‚¨å™¨å¸¦å®½é—®é¢˜</p></blockquote><p>ï¼ˆ3ï¼‰å¸¦Cacheçš„DRAM</p><blockquote><p>åœ¨DRAMçš„èŠ¯ç‰‡å†…é›†æˆäº†ä¸€ä¸ªç”±SRAMç»„æˆçš„Cache,æœ‰åˆ©äºçŒå‘å¼è¯»å–</p></blockquote><h2 id="3-é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨"><a href="#3-é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨" class="headerlink" title="3.é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨"></a>3.é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨</h2><h3 id="3-1-æ¦‚è¿°"><a href="#3-1-æ¦‚è¿°" class="headerlink" title="3.1 æ¦‚è¿°"></a>3.1 æ¦‚è¿°</h3><h4 id="3-1-1-ä½¿ç”¨çš„åŸå› "><a href="#3-1-1-ä½¿ç”¨çš„åŸå› " class="headerlink" title="3.1.1 ä½¿ç”¨çš„åŸå› "></a>3.1.1 ä½¿ç”¨çš„åŸå› </h4><p>Cacheæ˜¯ä¸ºäº†é¿å…CPUç©ºç­‰ç°è±¡ã€‚</p><p>CPUç©ºç­‰ç°è±¡ï¼šIOè®¾å¤‡ä¸cpuéƒ½éœ€è¦è®¿é—®å†…å­˜ï¼ŒIOè®¾å¤‡ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå› æ­¤cpuéœ€è¦ç­‰å¾…IOè®¿é—®å†…å­˜ä»è€Œå‡ºç°ç©ºç­‰ç°è±¡ã€‚å°†çƒ­ç‚¹æ•°æ®ç¼“å­˜åœ¨Cacheä¸­å¯ä»¥æœ‰æ•ˆé¿å…cpuç©ºç­‰ç°è±¡ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è®¿é—®æ•°æ®.</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/v2-56946c0f3d889d93bcf280f418abc75c_720w.webp" alt="img" style="zoom:67%;"><blockquote><p>CPUçš„é¢‘ç‡ä¹ŸåŸºæœ¬å®ç°äº†æ¯18ä¸ªæœˆç¿»ä¸€ç•ªï¼Œä½†æ˜¯å†…å­˜çš„é€Ÿåº¦ä¸€ç›´éƒ½æ²¡æ€ä¹ˆæé«˜ã€‚ä¸‹å›¾æ›²çº¿æè¿°äº†20ä¸–çºªå20å¹´CPUé€Ÿåº¦å’Œå†…å­˜é€Ÿåº¦ä¹‹é—´çš„â€œå‰ªåˆ€å·®â€ã€‚</p></blockquote><h4 id="3-1-2-Cacheçš„å·¥ä½œåŸç†"><a href="#3-1-2-Cacheçš„å·¥ä½œåŸç†" class="headerlink" title="3.1.2 Cacheçš„å·¥ä½œåŸç†"></a>3.1.2 Cacheçš„å·¥ä½œåŸç†</h4><p><strong>(1)ä¸»å­˜å’Œç¼“å­˜çš„ç¼–å€</strong><br>æˆ‘ä»¬æŠŠä¸»å­˜å’ŒCacheåˆ†æˆå¤§å°ç›¸ç­‰çš„å—ï¼Œä¸»å­˜æœ‰Må—ï¼ŒCacheæœ‰Cå—ã€‚ä¸»å­˜çš„å®¹é‡è¿œå¤§äºCacheçš„å®¹é‡ï¼Œå³M&gt;&gt;C</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/a90bc042b0a24a77af0e8e842e189871.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>å¦‚æœæˆ‘ä»¬æŠŠä¸»å­˜å’ŒCacheåˆ†æˆè‹¥å¹²å—ï¼Œé‚£ä¹ˆCPUç»™å‡ºçš„å†…å­˜åœ°å€å°±å¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å—å†…åç§»åœ°å€ï¼Œå®ƒçš„ä½æ•°å†³å®šå—çš„å¤§å°ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªå—åŒ…å«16ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”å†…å­˜çš„ç¼–å€å•ä½æ˜¯å­—èŠ‚ï¼Œé‚£ä¹ˆå—å†…åœ°å€éƒ¨åˆ†å°±æ˜¯4ä½ï¼Œå‰©ä½™éƒ¨åˆ†å°±æ˜¯ä¸»å­˜å—å·ã€‚<br>ä¸€ä¸ªå—åœ¨å†…å­˜å’ŒCacheä¹‹é—´ä¼ é€çš„æ—¶å€™ï¼Œæ˜¯æ•´ä½“è¿›è¡Œä¼ é€ï¼Œå—å†…å­—èŠ‚é¡ºåºä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>å†…å­˜çš„å—å†…åœ°å€éƒ¨åˆ†å’ŒCacheçš„å—å†…åœ°å€éƒ¨åˆ†çš„å€¼æ˜¯å®Œå…¨ç›¸åŒçš„</strong>ã€‚</p><p>Cacheä¸­çš„æ ‡è®°ï¼Œæ ‡è®°äº†ä¸»å­˜å—å’ŒCacheå—ä¹‹é—´çš„å…³ç³»ã€‚å¦‚æœä¸€ä¸ªä¸»å­˜å—è°ƒå…¥Cacheå—ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠä¸»å­˜å—å·å†™åˆ°æ ‡è®°å½“ä¸­ã€‚å°†æ¥CPUç»™å‡ºä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå®ƒå¸Œæœ›åœ¨Cacheä¸­è®¿é—®åˆ°è¿™ä¸ªæ•°æ®ï¼Œå®ƒè¦é¦–å…ˆç¡®è®¤è¿™ä¸ªå—æ˜¯å¦å·²ç»é€åˆ°äº†Cacheä¸­ï¼Œå®ƒå°±éœ€è¦æ‹¿ç»™å‡ºåœ°å€çš„ä¸»å­˜å—å·å’ŒCacheä¸­çš„æ ‡è®°è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå’ŒæŸä¸€ä¸ªæ ‡è®°åˆšå¥½ç›¸ç­‰ï¼Œå¹¶ä¸”è¿™ä¸ªCacheå—æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªå—é‡Œé¢å°±ä¿å­˜äº†åœ¨å†…å­˜ä¸­è¦è®¿é—®çš„ä¿¡æ¯ï¼Œå®ƒå°±å¯ä»¥ç›´æ¥ä»Cacheä¸­è·å–è¿™äº›ä¿¡æ¯ï¼Œå®ƒçš„é€Ÿåº¦å°±ä¼šå¤§å¤§æé«˜</p><p>ä¸»å­˜å’Œç¼“å­˜æ˜¯æŒ‰ç…§å—æ¥å­˜å‚¨çš„ï¼Œ<strong>å—çš„å¤§å°ç›¸åŒ</strong></p><p><strong>ï¼ˆ2ï¼‰å‘½ä¸­å’Œæœªå‘½ä¸­</strong></p><p>ç¼“å­˜æœ‰Cå—ï¼Œä¸»å­˜æœ‰Må—ï¼ŒM&gt;&gt;Cï¼Œä¸»å­˜ä¸­åªèƒ½æœ‰éƒ¨åˆ†å—è¢«ç¼“å­˜åˆ°äº†Cacheä¸­ã€‚</p><p>åœ¨CPUè®¿é—®ä¸»å­˜æ—¶ï¼Œå¦‚æœè¦è®¿é—®çš„ä¸»å­˜å—å·²ç»è°ƒå…¥ç¼“å­˜ä¸­ï¼Œå®ƒçš„ç¼“å­˜èƒ½å–åˆ°ç›¸åº”çš„æ•°æ®ï¼Œå°±è¯´<strong>å‘½ä¸­</strong><br>å‘½ä¸­ï¼Œå°±è¯´æ˜ä¸»å­˜å—å’Œç¼“å­˜å—å»ºç«‹äº†å¯¹åº”å…³ç³»ï¼Œå¯ä»¥ç”¨æ ‡è®°è®°å½•ä¸æŸç¼“å­˜å—å»ºç«‹äº†å¯¹åº”å…³ç³»çš„ä¸»å­˜å—å·</p><p>å¦‚æœè¦è®¿é—®çš„ä¸»å­˜å—æ²¡æœ‰è°ƒå…¥ç¼“å­˜ï¼Œé‚£ä¹ˆå°±è¯´æœªå‘½ä¸­</p><p><strong>ï¼ˆ3ï¼‰Cacheå‘½ä¸­ç‡</strong></p><p>å‘½ä¸­ç‡ï¼š å°±æ˜¯åœ¨Cacheä¸­è®¿é—®åˆ°CPUè¦è®¿é—®çš„å­—å—çš„æ¦‚ç‡ã€‚è®¾Ncè¡¨ç¤ºè®¿é—®Cacheçš„æ€»å‘½ä¸­æ¬¡æ•°ï¼ŒNmæœªè®¿é—®ä¸»å­˜çš„æ€»æ¬¡æ•°ï¼Œå³æœªå‘½ä¸­æ¬¡æ•°ã€‚å‘½ä¸­ç‡h&#x3D;Nc&#x2F;(Nc+Nm)<br>å‘½ä¸­ç‡ä¸Cacheçš„å®¹é‡å’Œå—é•¿æœ‰å…³ã€‚</p><p>ä¸€èˆ¬æ¯å—å¯ä»¥å–4~8ä¸ªå­—<br>å—é•¿å–ä¸€ä¸ªå­˜å–å‘¨æœŸå†…ä»ä¸»å­˜è°ƒå‡ºçš„ä¿¡æ¯é•¿åº¦<br>Cache-ä¸»å­˜ç³»ç»Ÿçš„æ•ˆç‡<br>æ•ˆç‡eå’Œå‘½ä¸­ç‡æœ‰å…³</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/b4e11ed8f331496d8c5dc3a04dcb1f4c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h4 id="3-1-3-Cacheçš„åŸºæœ¬ç»“æ„"><a href="#3-1-3-Cacheçš„åŸºæœ¬ç»“æ„" class="headerlink" title="3.1.3 Cacheçš„åŸºæœ¬ç»“æ„"></a>3.1.3 Cacheçš„åŸºæœ¬ç»“æ„</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/ffaf706f08dc479e9e20a0e117842888.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>CPUè¦è®¿é—®å†…å­˜çš„è¯ï¼Œå®ƒè¦ç»™å‡ºåœ°å€ï¼ŒåŒ…æ‹¬å—å·å’Œå—å†…åœ°å€ï¼Œç”±äºCacheå’Œä¸»å­˜ä¹‹é—´æ˜¯ä»¥å—ä¸ºåŸºæœ¬å•ä½ä¼ è¾“æ•°æ®çš„ï¼Œæ‰€ä»¥ä¸»å­˜çš„å—å†…åœ°å€å¯ä»¥ç›´æ¥é€åˆ°Cacheçš„å—å†…åœ°å€,æˆ–è€…å½¢æˆCacheçš„å—å†…åœ°å€</p><p>æˆ‘ä»¬åˆ©ç”¨å—å·åœ¨Cacheçš„åœ°å€æ˜ å°„å˜æ¢æœºæ„ä¸­ï¼Œå»ç¡®è®¤æ˜¯å¦å‘ç”Ÿå‘½ä¸­ã€‚å¦‚æœå‘ç”Ÿå‘½ä¸­çš„è¯ï¼Œéœ€è¦ç»™å‡ºå½“å‰çš„å†…å­˜å—ä¿å­˜åœ¨å“ªä¸€ä¸ªCacheå—ä¸­ã€‚å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œå°±éœ€è¦æŸ¥ä¸€ä¸‹ï¼ŒCacheä¸­æ˜¯å¦è¿˜æœ‰ç©ºé—´å¯ä»¥å­˜å…¥ä¸»å­˜å—ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±è®¿é—®ä¸»å­˜ï¼ŒæŠŠä¸»å­˜å—è£…åˆ°Cacheå—ä¸­ï¼›å¦‚æœæ²¡æœ‰ç©ºé—´çš„è¯ï¼Œé‚£ä¹ˆä¸»å­˜å—è£…å…¥çš„é‚£äº›Cacheå—éƒ½æ˜¯æ»¡çš„ï¼Œæˆ‘ä»¬å°±è¦å¯ç”¨Cacheæ›¿æ¢æœºæ„ï¼Œç”±Cacheçš„æ›¿æ¢æœºæ„æ ¹æ®æ›¿æ¢ç®—æ³•ï¼Œæ¥ç®—å‡ºå“ªä¸€äº›å—è¦ä»Cacheä¸­é€€å‡ºï¼Œå†™å›åˆ°ä¸»å­˜ï¼Œæˆ–è€…ç›´æ¥ä½œåºŸï¼Œå¹¶ä¸”æŠŠä¸»å­˜ä¸­è¦ç”¨çš„å—å†™å…¥åˆ°Cacheå—ä¸­ï¼Œè¿™å°±æ˜¯Cacheæ›¿æ¢æœºæ„è¦åšçš„</p><p><strong>åœ°å€æ˜ å°„:</strong></p><blockquote><p>ä¸»å­˜ä¸­çš„ä¸€ä¸ªå—å¦‚æœè¦æ”¾åˆ°Cacheä¸­ï¼Œå®ƒå¯ä»¥è¢«æ”¾åˆ°Cacheçš„å“ªä¸€ä¸ªå—æˆ–å“ªä¸€äº›å—ä¸­ã€‚</p></blockquote><p><strong>å˜æ¢:</strong></p><blockquote><p>æŠŠä¸»å­˜çš„å—å·è½¬å˜æˆç›¸åº”çš„Cacheå—å·ï¼Œæˆ–è€…æŠŠä¸»å­˜çš„åœ°å€è½¬å˜æˆç›¸åº”çš„Cacheçš„åœ°å€ï¼Œç„¶ååœ¨Cacheä¸­æ‰¾åˆ°ç›¸åº”çš„ä¸»å­˜å—è¿›è¡Œè®¿é—®</p><p>åœ¨ä¸»å­˜å’ŒCacheä¹‹é—´æ˜¯æœ‰ä¸€æ¡ç›´æ¥é€šè·¯çš„ï¼Œé€šè¿‡è¿™æ¡é€šè·¯ï¼Œå¯ä»¥å®Œæˆä¸»å­˜å’ŒCacheä¹‹é—´çš„ä¿¡æ¯äº¤æ¢</p></blockquote><p>æˆ‘ä»¬çš„ä¿¡æ¯<strong>ä»¥å—ä¸ºåŸºæœ¬å•ä½</strong>ä¿å­˜åœ¨Cacheå­˜å‚¨ä½“ä¸­</p><h4 id="3-1-4-Cacheçš„è¯»å†™æ“ä½œ"><a href="#3-1-4-Cacheçš„è¯»å†™æ“ä½œ" class="headerlink" title="3.1.4 Cacheçš„è¯»å†™æ“ä½œ"></a>3.1.4 Cacheçš„è¯»å†™æ“ä½œ</h4><p><strong>ï¼ˆ1ï¼‰è¯»æ“ä½œ</strong></p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/81fed2d01dfb457cbadd8f86bcff86cd.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><p>è¯»æ“ä½œæ˜¯ç”±CPUå‘å‡ºçš„ï¼ŒCPUå‘å‡ºè¿™ä¸ªè®¿é—®åœ°å€ï¼Œç”±Cacheçš„åœ°å€æ˜ å°„å’Œå˜æ¢æ¥ç¡®è®¤æ˜¯å¦å‘ç”Ÿå‘½ä¸­ã€‚å¦‚æœå‘½ä¸­ï¼Œå°±ç›´æ¥ä»Cacheå–å‡ºä¿¡æ¯ã€‚è‹¥æœªå‘½ä¸­ï¼Œåˆ™éœ€å…ˆåˆ¤æ–­ï¼ŒCacheæ˜¯å¦å·²æ»¡ï¼Œå³æ˜¯å¦å¯ä»¥ç›´æ¥å°†ä¸»å­˜ä¸­å¯¹åº”çš„å—è£…å…¥Cacheï¼Œè‹¥æ˜¯ï¼Œåˆ™è®¿é—®ä¸»å­˜ï¼Œé€šè¿‡æ•°æ®æ€»çº¿å…ˆå°†æŒ‡ä»¤å’Œæ•°æ®ä¼ é€ç»™CPUï¼Œå†é€šè¿‡ç›´æ¥é€šè·¯ï¼Œå°†æŒ‡ä»¤å’Œæ•°æ®ä¼ é€ç»™Cacheç¼“å­˜ã€‚å¦‚æœCacheå·²æ»¡ï¼Œåˆ™éœ€è¦é€šè¿‡Cacheæ›¿æ¢æœºæ„æ¥è®¿é—®ä¸»å­˜å¹¶æ›¿æ¢Cacheä¸­çš„æŸä¸€ä¸ªå—ã€‚<br><strong>ï¼ˆ2ï¼‰å†™æ“ä½œ</strong></p><p>è¯»æ“ä½œæ˜¯ä¸ä¼šå¯¹å†…å­˜ä¸­ä¿¡æ¯è¿›è¡Œä¿®æ”¹çš„ï¼Œä½†æ˜¯å†™æ“ä½œå¯èƒ½é€ æˆ<strong>ä¸»å­˜å’ŒCacheä¸­çš„ä¿¡æ¯ä¸ä¸€è‡´</strong>ã€‚</p><p>å†™æ“ä½œéœ€è¦è§£å†³Cacheå’Œä¸»å­˜çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨å†™ç›´è¾¾æ³•å’Œå†™å›æ³•</p><ul><li>å†™ç›´è¾¾æ³•<ul><li>å†™æ“ä½œæ—¶æ•°æ®æ—¢å†™å…¥Cache,åˆå†™å…¥ä¸»å­˜</li><li>å†™æ“ä½œæ—¶é—´å°±æ˜¯è®¿é—®ä¸»å­˜çš„æ—¶é—´,Cacheå—é€€å‡ºæ—¶ï¼Œä¸éœ€è¦å¯¹ä¸»å­˜æ‰§è¡Œå†™æ“ä½œï¼Œæ›´æ–°ç­–ç•¥æ¯”è¾ƒå®¹æ˜“å®ç°</li></ul></li><li>å†™å›æ³•<ul><li>å†™æ“ä½œæ—¶åªæŠŠæ•°æ®å†™å…¥Cacheè€Œä¸å†™å…¥ä¸»å­˜</li><li>å½“Cacheæ•°æ®è¢«æ›¿æ¢å‡ºå»æ—¶æ‰å†™å›ä¸»å­˜</li></ul></li></ul><h4 id="3-1-5-Cacheçš„æ”¹è¿›"><a href="#3-1-5-Cacheçš„æ”¹è¿›" class="headerlink" title="3.1.5 Cacheçš„æ”¹è¿›"></a>3.1.5 Cacheçš„æ”¹è¿›</h4><ul><li>å¢åŠ Cacheçš„çº§æ•°ï¼šç¦»CPUæ¯”è¾ƒè¿‘çš„åœ¨CPUå†…éƒ¨é›†æˆL1ç¼“ï¼ŒL2ç¼“å­˜ï¼Œåœ¨ä¸»æ¿ä¸Šé›†æˆL3ç¼“å­˜</li><li>ç»Ÿä¸€ç¼“å­˜å’Œåˆ†ç«‹ç¼“å­˜ï¼šæŒ‡ä»¤Cacheå’Œæ•°æ®Cacheåˆ†å¼€</li></ul><h3 id="3-2-Cache-ä¸»å­˜ä¹‹é—´çš„åœ°å€æ˜ å°„"><a href="#3-2-Cache-ä¸»å­˜ä¹‹é—´çš„åœ°å€æ˜ å°„" class="headerlink" title="3.2 Cache-ä¸»å­˜ä¹‹é—´çš„åœ°å€æ˜ å°„"></a>3.2 Cache-ä¸»å­˜ä¹‹é—´çš„åœ°å€æ˜ å°„</h3><h4 id="3-2-1-ä»€ä¹ˆæ˜¯å†…å­˜å—"><a href="#3-2-1-ä»€ä¹ˆæ˜¯å†…å­˜å—" class="headerlink" title="3.2.1 ä»€ä¹ˆæ˜¯å†…å­˜å—"></a>3.2.1 ä»€ä¹ˆæ˜¯å†…å­˜å—</h4><p><strong>å­—</strong>ï¼šæŒ‡å­˜æ”¾åœ¨ä¸€ä¸ªå­˜å‚¨å•å…ƒä¸­çš„äºŒè¿›åˆ¶ä»£ç ç»„åˆ</p><p><strong>å­—å—ï¼š</strong>å­˜å‚¨åœ¨è¿ç»­çš„å­˜å‚¨å•å…ƒä¸­è€Œè¢«çœ‹æˆä¸€ä¸ªå•å…ƒçš„ä¸€ç»„å­—</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514203908166.png" alt="image-20230514203908166" style="zoom: 33%;"><p>å­—çš„åœ°å€åŒ…å«2ä¸ªéƒ¨åˆ†ï¼Œå‰mä½ä¸ºæŒ‡å®šå­—å—çš„åœ°å€ï¼Œåbä½æŒ‡å®šå­—åœ¨å­—å—ä¸­çš„åœ°å€</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514204043280.png" alt="image-20230514204043280" style="zoom: 50%;">$$2^m = Mï¼Œ2^b = B$$<img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514204208280.png" alt="image-20230514204208280" style="zoom: 50%;"><p><strong>æœºå™¨å­—é•¿ï¼š</strong>CPUè¿›è¡Œä¸€æ¬¡æ•´æ•°è¿ç®—æ‰€èƒ½å¤„ç†çš„äºŒè¿›åˆ¶æ•°æ®çš„ä½æ•°ã€‚å­—é•¿æ˜¯ç”±CPUçš„ç±»å‹æ‰€å†³å®šï¼Œä¸åŒçš„è®¡ç®—æœºç³»ç»Ÿçš„å­—é•¿æ˜¯ä¸åŒçš„ï¼Œå¸¸è§çš„æœ‰8ä½ã€16ä½ã€32ä½ã€64ä½ç­‰ï¼Œå­—é•¿è¶Šé•¿ï¼Œè®¡ç®—æœºä¸€æ¬¡å¤„ç†çš„ä¿¡æ¯ä½å°±è¶Šå¤šï¼Œç²¾åº¦å°±è¶Šé«˜ï¼Œ</p><p><strong>å­˜å‚¨å­—é•¿ï¼š</strong>ä¸€ä¸ªå­˜å‚¨å•å…ƒä¸­äºŒè¿›åˆ¶ä»£ç çš„ä½æ•°ï¼ˆé€šå¸¸å’ŒMDRä½æ•°ç›¸åŒï¼‰</p><h4 id="3-2-2-ç›´æ¥æ˜ å°„"><a href="#3-2-2-ç›´æ¥æ˜ å°„" class="headerlink" title="3.2.2 ç›´æ¥æ˜ å°„"></a>3.2.2 ç›´æ¥æ˜ å°„</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514210212152.png" alt="image-20230514210212152" style="zoom: 50%;"><p>ä»¥<strong>å­—å—</strong>ä¸ºå•ä½å°†å†…å­˜å’Œç¼“å­˜åˆ†å‰²ä¸ºæ•°ç»„ï¼Œå†…å­˜å‘ç¼“å­˜å½¢æˆå¤šå¯¹ä¸€çš„ç›´æ¥æ˜ å°„å…³ç³»ï¼Œå†…å­˜ä¸­çš„ä¸€ä¸ªå­—å—èƒ½å¤Ÿæ˜ å°„åˆ°ç¼“å­˜ä¸­çš„ç´¢å¼•æ˜¯ç¡®å®šçš„ã€‚å¦‚å¯¹äºåªæœ‰8ä¸ªå­—å—çš„ç¼“å­˜ï¼Œ21 å·å†…å­˜å—å†…å®¹åœ¨ç¼“å­˜å—ä¸­çš„è¯ï¼Œå®ƒä¸€å®šåœ¨ 5 å·ç¼“å­˜å—ï¼ˆ21 mod 8 &#x3D; 5ï¼‰ä¸­ã€‚</p><p>ä½†æ˜¯è¿™ç§æ˜ å°„åˆé‡æ–°å¸¦æ¥ä¸€ç§é—®é¢˜ï¼Œå›¾ä¸­5,13,21,29éƒ½èƒ½æ˜ å°„åˆ°ç¼“å­˜5ä¸Šï¼Œæˆ‘ä»¬æ€ä¹ˆç¡®å®šæˆ‘è¦21çš„æ—¶å€™æ‹¿åˆ°çš„ä¸æ˜¯å…¶ä»–å‘¢ï¼Ÿ</p><p>é€šå¸¸æˆ‘ä»¬ä¼šæŠŠç¼“å­˜å—çš„æ•°é‡è®¾ç½®æˆ 2 çš„ N æ¬¡æ–¹ï¼Œé‚£ä¹ˆå†…å­˜çš„å­—å—æ•°é‡ä¹Ÿä¸€å®šæ˜¯ç¼“å­˜çš„äºŒæ¬¡æ–¹å€ï¼Œå¦‚8 ä¸ªç¼“å­˜å­—å—ï¼Œå°±æ˜¯ 2 çš„ 3 æ¬¡æ–¹ï¼Œ32ä¸ªå†…å­˜å­—å—å°±æ˜¯ 2 çš„ 5 æ¬¡æ–¹ï¼Œæˆ‘ä»¬åœ¨é€šè¿‡å†…å­˜åœ°å€çš„è·å–ç¼“å­˜æ•°æ®æ—¶å€™ï¼Œåªéœ€è¦æ‹¿åˆ°æ®µåœ°å€çš„ä½ä¸‰ä½ï¼Œå°±èƒ½ç¡®å®šç¼“å­˜ç´¢å¼•ï¼Œå†æ ¹æ®å­—å—ä¸­çš„åç§»é‡å°±èƒ½æ‹¿åˆ°å”¯ä¸€å¯¹åº”çš„å­—èŠ‚ï¼Œé“ç†å°±æ˜¯è¿™ä¹ˆä¸ªé“ç†ã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514210350969.png" alt="image-20230514210350969" style="zoom:50%;"><p>é‚£è¿™ä¸ªå­—æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå°±éœ€è¦å¼•å…¥å¦ä¸€ä¸ªæ¦‚å¿µâ€ç»„æ ‡è®°â€</p><p>è¿™ä¸ªç»„æ ‡è®°ä¼šè®°å½•ï¼Œå½“å‰ç¼“å­˜å—å†…å­˜å‚¨çš„æ•°æ®å¯¹åº”çš„å†…å­˜å—ï¼Œè€Œç¼“å­˜å—æœ¬èº«çš„åœ°å€è¡¨ç¤ºè®¿é—®åœ°å€çš„ä½ N ä½ã€‚å°±åƒä¸Šé¢çš„ä¾‹å­ï¼Œ21 çš„ä½ 3 ä½ 101ï¼Œç¼“å­˜å—æœ¬èº«çš„åœ°å€å·²ç»æ¶µç›–äº†å¯¹åº”çš„ä¿¡æ¯ã€å¯¹åº”çš„ç»„æ ‡è®°ï¼Œæˆ‘ä»¬åªéœ€è¦è®°å½• 21 å‰©ä½™çš„é«˜ 2 ä½çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ 10 å°±å¯ä»¥äº†ã€‚</p><p>é™¤äº†ç»„æ ‡è®°ä¿¡æ¯ä¹‹å¤–ï¼Œç¼“å­˜å—ä¸­è¿˜æœ‰ä¸¤ä¸ªæ•°æ®ã€‚ä¸€ä¸ªè‡ªç„¶æ˜¯ä»ä¸»å†…å­˜ä¸­åŠ è½½æ¥çš„å®é™…å­˜æ”¾çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯æœ‰æ•ˆä½ç”¨äºå­˜æ”¾ç¼“å­˜å—ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆçš„ã€‚å¦‚æœæœ‰æ•ˆä½æ˜¯ 0ï¼Œæ— è®ºå…¶ä¸­çš„ç»„æ ‡è®°å’Œ å®é™…çš„æ•°æ®å†…å®¹æ˜¯ä»€ä¹ˆï¼ŒCPU éƒ½ä¸ä¼šç®¡è¿™äº›æ•°æ®ï¼Œè€Œè¦ç›´æ¥è®¿é—®å†…å­˜ï¼Œé‡æ–°åŠ è½½æ•°æ®ã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514210507419.png" alt="image-20230514210507419" style="zoom:50%;"><p><strong>é‡ç‚¹æ¥äº†ï¼Œ</strong>æ•´ä½“è¿›è¡Œä¸¾ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ª64ä½çš„CPUï¼Œå†…å­˜åœ°å€çº¿å®½åº¦ä¸º40ä½ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå†…å­˜åœ°å€å¯ä»¥æœ‰40ä½ï¼Œå‡è®¾ä¸€ä¸ªå­—å—æœ‰64Bï¼Œå³64å­—èŠ‚ï¼Œå†…å­˜å¤§å°ä¸º8Gï¼Œç¼“å­˜å¤§å°ä¸º8Mã€‚</p><p>ç”±äºå†…å­˜å¤§å°ä¸º8Gï¼Œå³2çš„33æ¬¡æ–¹å­—èŠ‚ï¼Œåˆ™æœ€å°‘éœ€è¦33ä½åœ°å€å¯ç¡®å®šå”¯ä¸€å­—èŠ‚ã€‚å…¶ä¸­64Bä¸ºä¸€ä¸ªå­—å—ï¼Œæƒ³è¦ç¡®å®šå”¯ä¸€å­—èŠ‚éœ€è¦6ä½åœ°å€ï¼Œå³2çš„6æ¬¡æ–¹ï¼Œæ‰€ä»¥åç§»é‡éœ€è¦6ä½ï¼›ç¼“å­˜å¤§å°æ˜¯8M,å³2çš„23æ¬¡æ–¹å­—èŠ‚ï¼Œä½†æ˜¯åˆå› ä¸ºä¸€ä¸ªå­—å—æ˜¯64B,æ‰€ä»¥ç¼“å­˜è¡Œæ•°æ˜¯2çš„23æ¬¡æ–¹é™¤ä»¥2çš„6æ¬¡æ–¹ï¼Œæ‰€ä»¥éœ€è¦17ä½æ¥ç¡®å®šå”¯ä¸€å­—å—ï¼Œå³ç´¢å¼•ä½æ•°ä¸º17ï¼›ç¼“å­˜8Må’Œå†…å­˜8Gç›¸å·®2çš„10æ¬¡æ–¹å€ï¼Œæ‰€ä»¥ç»„æ ‡è®°éœ€è¦10ä½ï¼Œé«˜ä½è¡¥0ã€‚</p><p><strong>æ‰€ä»¥ä¸€ä¸ªå†…å­˜åœ°å€çš„è®¿é—®ï¼Œå°±ä¼šç»å†è¿™æ · 4 ä¸ªæ­¥éª¤ï¼š</strong></p><p><strong>1.æ ¹æ®å†…å­˜åœ°å€ä¸­æ®µåœ°å€(å­—å—åœ°å€ä¸ºæ®µåœ°å€)çš„ä½ä½ï¼Œè®¡ç®—åœ¨ ç¼“å­˜ä¸­çš„ç´¢å¼•ï¼›</strong></p><p><strong>2.åˆ¤æ–­æœ‰æ•ˆä½ï¼Œç¡®è®¤ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ‰æ•ˆçš„ï¼›</strong></p><p><strong>3.å¯¹æ¯”å†…å­˜è®¿é—®åœ°å€çš„é«˜ä½ï¼Œå’Œç¼“å­˜ä¸­çš„ç»„æ ‡è®°ï¼Œç¡®è®¤ç¼“å­˜ä¸­çš„æ•°æ®å°±æ˜¯æˆ‘ä»¬è¦è®¿é—®çš„å†…å­˜æ•°æ®</strong></p><p><strong>4.æ ¹æ®å†…å­˜åœ°å€çš„ åç§»é‡ï¼Œä»å­—å—ä¸­è¯»å–å¸Œæœ›è¯»å–åˆ°çš„å­—èŠ‚ã€‚</strong></p><p>å¦‚æœåœ¨ 2ã€3 è¿™ä¸¤ä¸ªæ­¥éª¤ä¸­ï¼ŒCPU å‘ç°ï¼Œç¼“å­˜ä¸­çš„æ•°æ®å¹¶ä¸æ˜¯è¦è®¿é—®çš„å†…å­˜åœ°å€çš„æ•°æ®ï¼Œé‚£ CPU å°±ä¼šè®¿é—®å†…å­˜ï¼Œå¹¶æŠŠå¯¹åº”çš„ å†…å­˜ä¸­çš„æ•°æ®å­—å—æ›´æ–°åˆ°å¯¹åº”çš„ç¼“å­˜ä¸­ï¼ŒåŒæ—¶æ›´æ–°å¯¹åº”çš„æœ‰æ•ˆä½å’Œç»„æ ‡è®°çš„æ•°æ®ã€‚</p><h4 id="3-2-3-å…¨ç›¸è”æ˜ å°„"><a href="#3-2-3-å…¨ç›¸è”æ˜ å°„" class="headerlink" title="3.2.3 å…¨ç›¸è”æ˜ å°„"></a>3.2.3 å…¨ç›¸è”æ˜ å°„</h4><p>å…¨ç›¸è¿æ˜ å°„æ–¹å¼æ¯”è¾ƒçµæ´»ï¼Œä¸»å­˜çš„å„å—å¯ä»¥æ˜ å°„åˆ°ç¼“å­˜çš„ä»»ä¸€å—ä¸­ï¼Œç¼“å­˜çš„åˆ©ç”¨ç‡é«˜ï¼Œå­—å—å†²çªæ¦‚ç‡ä½ï¼Œåªè¦æ·˜æ±°ç¼“å­˜ä¸­çš„æŸä¸€å—ï¼Œå³å¯è°ƒå…¥ä¸»å­˜çš„ä»»ä¸€å—ã€‚ä½†æ˜¯ï¼Œç”±äºç¼“å­˜æ¯”è¾ƒç”µè·¯çš„è®¾è®¡å’Œå®ç°æ¯”è¾ƒå›°éš¾ï¼Œè¿™ç§æ–¹å¼åªé€‚åˆäºå°å®¹é‡ç¼“å­˜é‡‡ç”¨ã€‚</p><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/image-20230514211224104.png" alt="image-20230514211224104" style="zoom:50%;"><h4 id="3-2-4-ç»„ç›¸è”æ˜ å°„"><a href="#3-2-4-ç»„ç›¸è”æ˜ å°„" class="headerlink" title="3.2.4 ç»„ç›¸è”æ˜ å°„"></a>3.2.4 ç»„ç›¸è”æ˜ å°„</h4><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/edc32409f52f4bb08f24ae66a214b1f4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>ä¸»å­˜å‚¨å™¨ä¸­çš„å­—å—ä¹Ÿè¿›è¡Œåˆ†åŒºï¼Œæ¯ä¸ªåŒºçš„å¤§å°å’ŒCacheä¸­çš„ç»„æ•°ç›¸åŒï¼ŒCacheè¢«åˆ†æˆå‡ ç»„ï¼Œä¸»å­˜å‚¨å™¨çš„æ¯ä¸€ä¸ªåŒºå°±åŒ…å«å¤šå°‘å—</p><blockquote><p>ä¾‹å¦‚ä¸»å­˜ä¸­çš„å­—å—0ï¼Œå¯ä»¥å­˜æ”¾åˆ°ç¼“å­˜ä¸­ç¬¬0ç»„çš„å…¶ä»–ç©ºä½™ä½ç½®</p><p>ä¾‹å¦‚å­—å—2^(c-r)å¯ä»¥å­˜æ”¾åˆ°ç¼“å­˜ä¸­ç¬¬2^(c-r)-1ç»„çš„å…¶ä½™ç©ºä½™ä½ç½®</p></blockquote><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/9d7cf85354b64dd3bc0816759c0fb788.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h3 id="3-3-ç½®æ¢ç®—æ³•"><a href="#3-3-ç½®æ¢ç®—æ³•" class="headerlink" title="3.3 ç½®æ¢ç®—æ³•"></a>3.3 ç½®æ¢ç®—æ³•</h3><img src="/2023/05/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E5%9B%9B-%E5%AD%98%E5%82%A8%E5%99%A8/2a1fc2de6ff347d5bdb50ab4a7603b13.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç»„æˆåŸç†(ä¸‰)æ€»çº¿</title>
    <link href="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/"/>
    <url>/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç»„æˆåŸç†-ä¸‰-æ€»çº¿"><a href="#è®¡ç®—æœºç»„æˆåŸç†-ä¸‰-æ€»çº¿" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†(ä¸‰)æ€»çº¿"></a>è®¡ç®—æœºç»„æˆåŸç†(ä¸‰)æ€»çº¿</h1><h2 id="1-æ€»çº¿çš„åŸºæœ¬æ¦‚å¿µ"><a href="#1-æ€»çº¿çš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.æ€»çº¿çš„åŸºæœ¬æ¦‚å¿µ"></a>1.æ€»çº¿çš„åŸºæœ¬æ¦‚å¿µ</h2><p>é¦–å…ˆæˆ‘ä»¬æå‡ºä¸€ä¸ªé—®é¢˜ï¼šé‚£å°±æ˜¯ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ€»çº¿ï¼ŸåŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬çš„è®¡ç®—æœºä¸­æœ‰è®¸å¤šçš„è®¾å¤‡ï¼Œå¦‚æœä½¿ç”¨åˆ†æ•£è¿æ¥ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´äº’ç›¸è¿æ¥ï¼Œé‚£æ ·ä¼šé€ æˆå¤§é‡çš„çº¿è·¯è¿æ¥ï¼Œè€Œä¸”è¿˜ä¸åˆ©äºæ·»åŠ åˆ å‡è®¾å¤‡ã€‚ä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼ŒæŠŠæˆ‘ä»¬çš„æˆ¿å­æƒ³æˆä¸€ä¸ªè®¾å¤‡ï¼Œå…¬è·¯æƒ³æˆçº¿è·¯ï¼Œå¦‚æœæ¯å®¶æ¯æˆ·éƒ½ä¸€ä¸€è¿æ¥ï¼Œæˆ¿å­å°‘çš„æ—¶å€™è¿˜å¥½ï¼Œä½†æ˜¯ä¸€æ—¦æˆ¿å­ä¸€å¤šèµ·æ¥ï¼Œå°±å¾ˆéº»çƒ¦äº†ã€‚æ‰€ä»¥æˆ‘ä»¬è®¾è®¡å‡ºæ¥äº†æ€»çº¿è¿™æ ·çš„æ–¹å¼ï¼Œä»–å°±ç›¸å½“äºä¸€æ¡é è¿‘å¤§å®¶çš„å¤§é©¬è·¯ï¼Œæ¯å®¶æ¯æˆ·é€šè¿‡è¿™æ¡é©¬è·¯å»é€šä¿¡å°±å¥½äº†ï¼Œè¿™æ ·æ—¢ç®€å•ï¼Œåˆä¾¿æ·ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹æœ‰å…³æ€»çº¿çš„ä»‹ç»ï¼šæ€»çº¿æ˜¯è¿æ¥å¤šä¸ªéƒ¨ä»¶çš„ä¿¡æ¯ä¼ è¾“çº¿ï¼Œæ˜¯å„éƒ¨ä»¶å…±äº«çš„ä¼ è¾“ä»‹è´¨ï¼Œ<u><strong>æ¯ä¸€æ¬¡åªå…è®¸ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´è¿›è¡Œé€šä¿¡</strong></u>ã€‚è€Œä¸”åœ¨æ€»çº¿ä¸­ï¼Œä¿¡æ¯ä¼ é€’æ–¹å¼åˆ†ä¸ºä¸²è¡Œå’Œå¹¶è¡Œä¸¤ç§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå¯¹å…¶è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä¸€äº›æ€»çº¿ç»“æ„ã€‚</p><p><strong>å•æ€»çº¿</strong></p><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åªæœ‰ä¸€æ ¹æ€»çº¿ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/613fe30e19094fe4841a2557469a2846.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p><strong>åŒæ€»çº¿</strong></p><p>åŒæ€»çº¿å‘¢ï¼Œæˆ‘ä»¬æš‚æ—¶å±•ç¤ºä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯é¢å‘CPUï¼Œå¦å¤–ä¸€ç§å°±æ˜¯ä»¥å¯„å­˜å™¨ä¸ºä¸­å¿ƒã€‚æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å§ï¼</p><ul><li><strong>é¢å‘CPU</strong></li></ul><p>è¿™ç§é¢å‘CPUçš„æ–¹å¼å‘¢ï¼Œè™½ç„¶ä½¿å¾—CPUä¸ä¸»å­˜ä¹‹é—´é€šä¿¡æ›´å¿«ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è®¾å¤‡ä¸ä¸»å­˜ä¹‹é—´è®¿é—®éœ€è¦é€šè¿‡CPUï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œäºæ˜¯æˆ‘ä»¬è®¾è®¡å‡ºæ¥äº†ä»¥å­˜å‚¨å™¨ä¸ºä¸­å¿ƒçš„ç»“æ„ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/6354160da5894ff6acf183ababc24c79.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><ul><li><strong>ä»¥å­˜å‚¨å™¨ä¸ºä¸­å¿ƒ</strong></li></ul><p>å­˜å‚¨å™¨ä¸ºä¸­å¿ƒçš„ç»“æ„æ˜¯åœ¨å•æ€»çº¿åŸºç¡€ä¸Šåˆå¼€è¾Ÿå‡ºçš„ä¸€æ¡ CPU ä¸ä¸»å­˜ä¹‹é—´çš„æ€»çº¿ï¼Œç§°ä¸ºå­˜å‚¨æ€»çº¿ã€‚è¿™ç»„æ€»çº¿é€Ÿåº¦é«˜ï¼Œåªä¾›ä¸»å­˜ä¸ CPU ä¹‹é—´ä¼ è¾“ä¿¡æ¯ã€‚è¿™æ ·æ—¢æé«˜äº†ä¼ è¾“æ•ˆç‡ï¼Œåˆå‡è½»äº†ç³»ç»Ÿæ€»çº¿çš„è´Ÿæ‹…ï¼Œè¿˜ä¿ç•™äº† I&#x2F;0 è®¾å¤‡ä¸å­˜å‚¨å™¨äº¤æ¢ä¿¡æ¯æ—¶ä¸ç»è¿‡ CPU çš„ç‰¹ç‚¹</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/51fe1d5096414559a5b004cc6fb8ae7b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><h2 id="2-æ€»çº¿çš„åˆ†ç±»"><a href="#2-æ€»çº¿çš„åˆ†ç±»" class="headerlink" title="2.æ€»çº¿çš„åˆ†ç±»"></a>2.æ€»çº¿çš„åˆ†ç±»</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€çœ‹æ€»çº¿çš„åˆ†ç±»ï¼Œå½“ç„¶äº†ï¼Œæ ¹æ®ä¸åŒçš„åˆ†ç±»åŸåˆ™ï¼Œä¹Ÿå°±èƒ½åˆ†æˆä¸åŒçš„ç§ç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ˜¯æŒ‰ç…§è¿æ¥éƒ¨ä»¶æ¥è¿›è¡Œåˆ†ç±»çš„ã€‚</p><p><strong>ç‰‡å†…æ€»çº¿</strong></p><p>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œç‰‡å†…æ€»çº¿æ˜¯æŒ‡èŠ¯ç‰‡å†…éƒ¨çš„æ€»çº¿ï¼Œå¦‚åœ¨ CPU èŠ¯ç‰‡å†…éƒ¨ï¼Œå¯„å­˜å™¨ä¸å¯„å­˜å™¨ä¹‹é—´ã€å¯„å­˜å™¨ä¸ç®—é€»å•è¿œ ALU ä¹‹é—´éƒ½ç”±ç‰‡å†…æ€»çº¿è¿æ¥ã€‚</p><p><strong>ç³»ç»Ÿæ€»çº¿</strong></p><p>ç³»ç»Ÿæ€»çº¿æ˜¯æŒ‡ CPU ã€ä¸»å­˜ã€ I&#x2F;O è®¾å¤‡ï¼ˆé€šè¿‡ I&#x2F;Oæ¥å£ï¼‰å„å¤§éƒ¨ä»¶ä¹‹é—´çš„ä¿¡æ¯ä¼ è¾“çº¿ã€‚ç”±äºè¿™äº›éƒ¨ä»¶é€šå¸¸éƒ½å®‰æ”¾åœ¨ä¸»æ¿æˆ–å„ä¸ªæ’ä»¶æ¿ä¸Šï¼Œæ•…åˆç§°æ¿çº§æ€»çº¿æˆ–æ¿é—´æ€»çº¿ã€‚æŒ‰ç³»ç»Ÿæ€»çº¿ä¼ è¾“ä¿¡æ¯çš„ä¸åŒï¼Œåˆå¯åˆ†ä¸ºä¸‰ç±»ï¼šæ•°æ®æ€»çº¿ã€åœ°å€æ€»çº¿å’Œæ§åˆ¶æ€»çº¿ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸€è¿›è¡Œä»‹ç»ã€‚</p><p><strong>ï¼ˆ1ï¼‰æ•°æ®æ€»çº¿</strong></p><p>é¡¾åæ€ä¹‰ï¼Œæ•°æ®æ€»çº¿å°±æ˜¯ç”¨æ¥ä¼ è¾“æ•°æ®çš„ï¼Œå¹¶ä¸”å®ƒæ˜¯åŒå‘ä¼ è¾“æ€»çº¿ï¼Œå…¶ä½æ•°ä¸æœºå™¨å­—é•¿ã€å­˜å‚¨å­—é•¿æœ‰å…³ã€‚æ•°æ®æ€»çº¿çš„ä½æ•°ç§°ä¸ºæ•°æ®æ€»çº¿å®½åº¦ï¼Œå®ƒæ˜¯è¡¡é‡ç³»ç»Ÿæ€§èƒ½çš„ä¸€ä¸ªé‡è¦å‚æ•°ã€‚</p><p><strong>ï¼ˆ2ï¼‰åœ°å€æ€»çº¿</strong></p><p>åœ°å€æ€»çº¿ä¸»è¦ç”¨æ¥æŒ‡å‡ºæ•°æ®æ€»çº¿ä¸Šçš„æºæ•°æ®æˆ–ç›®çš„æ•°æ®åœ¨ä¸»å­˜å•å…ƒçš„åœ°å€æˆ– I&#x2F;O è®¾å¤‡çš„åœ°å€ã€‚</p><p><strong>ï¼ˆ3ï¼‰æ§åˆ¶æ€»çº¿</strong></p><p>ç”±äºæ•°æ®æ€»çº¿ã€åœ°å€æ€»çº¿éƒ½æ˜¯è¢«æŒ‚åœ¨æ€»çº¿ä¸Šçš„æ‰€æœ‰éƒ¨ä»¶å…±äº«çš„ï¼Œå¦‚ä½•ä½¿å„éƒ¨ä»¶èƒ½åœ¨ä¸åŒæ—¶åˆ»å æœ‰æ€»çº¿ä½¿ç”¨æƒï¼Œéœ€ä¾é æ§åˆ¶æ€»çº¿æ¥å®Œæˆï¼Œå› æ­¤æ§åˆ¶æ€»çº¿æ˜¯ç”¨æ¥å‘å‡ºå„ç§æ§åˆ¶ä¿¡å·çš„ä¼ è¾“çº¿ã€‚é€šå¸¸å¯¹ä»»ä¸€æ§åˆ¶çº¿è€Œè¨€ï¼Œå®ƒçš„ä¼ è¾“æ˜¯å•å‘çš„ã€‚è€Œä¸”æ§åˆ¶ä¿¡å·æ—¢æœ‰è¾“å‡ºï¼Œåˆæœ‰è¾“å…¥ã€‚å¸¸è§çš„æ§åˆ¶ä¿¡å·å¦‚ï¼šæ€»çº¿è¯·æ±‚ï¼Œä¸­æ–­è¯·æ±‚ç­‰ç­‰ã€‚</p><p><strong>é€šä¿¡æ€»çº¿</strong></p><p>è¿™ç±»æ€»çº¿ç”¨äº<strong>è®¡ç®—æœºç³»ç»Ÿä¹‹é—´</strong>æˆ–è®¡ç®—æœºç³»ç»Ÿä¸å…¶ä»–ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ã€‚ä¸»è¦åˆ†ä¸ºä¸²è¡Œé€šä¿¡å’Œå¹¶è¡Œé€šä¿¡ã€‚ä¸²è¡Œé€šä¿¡æ˜¯æŒ‡æ•°æ®åœ¨å•æ¡ä½å®½çš„ä¼ è¾“çº¿ä¸Šï¼Œä¸€ä½ä¸€ä½åœ°æŒ‰é¡ºåºåˆ†æ—¶ä¼ é€ã€‚å¹¶è¡Œé€šä¿¡æ˜¯æŒ‡æ•°æ®åœ¨å¤šæ¡å¹¶è¡Œä½å®½çš„ä¼ è¾“çº¿ä¸Šï¼ŒåŒæ—¶ç”±æºä¼ é€åˆ°ç›®çš„åœ°ï¼Œé€‚å®œè¿‘è·ç¦»çš„ä¼ è¾“ã€‚</p><h2 id="3-æ€»çº¿ç‰¹æ€§åŠæ€§èƒ½æŒ‡æ ‡"><a href="#3-æ€»çº¿ç‰¹æ€§åŠæ€§èƒ½æŒ‡æ ‡" class="headerlink" title="3.æ€»çº¿ç‰¹æ€§åŠæ€§èƒ½æŒ‡æ ‡"></a>3.æ€»çº¿ç‰¹æ€§åŠæ€§èƒ½æŒ‡æ ‡</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹æ€»çº¿ç‰¹æ€§ã€æ€§èƒ½æŒ‡æ ‡å’Œæ€»çº¿æ ‡å‡†ã€‚</p><h3 id="3-1-æ€»çº¿ç‰¹æ€§"><a href="#3-1-æ€»çº¿ç‰¹æ€§" class="headerlink" title="3.1 æ€»çº¿ç‰¹æ€§"></a>3.1 æ€»çº¿ç‰¹æ€§</h3><p>æˆ‘ä»¬ç°åœ¨å°†ä»‹ç»ä¸€ä¸‹å…³äºæ€»çº¿çš„ä¸€äº›ç‰¹æ€§ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€»çº¿çš„ç‰©ç†ç»“æ„ã€‚</p><p>å›¾ä¸­ CPU ã€ä¸»å­˜ã€ I&#x2F;O è¿™äº›æ’æ¿ï¼ˆåˆç§°æ’å¡ï¼‰é€šè¿‡æ’å¤´ä¸æ°´å¹³æ–¹å‘æ€»çº¿æ’æ§½è¿æ¥ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/773c1c371d2d4b739b9eb3114b54c52e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p><strong>æœºæ¢°ç‰¹æ€§</strong></p><blockquote><p>æœºæ¢°ç‰¹æ€§æ˜¯æŒ‡æ€»çº¿åœ¨æœºæ¢°è¿æ¥æ–¹å¼ä¸Šçš„ä¸€äº›æ€§èƒ½ï¼Œå¦‚æ’å¤´ä¸æ’åº§ä½¿ç”¨çš„æ ‡å‡†ï¼Œå®ƒä»¬çš„<strong>å‡ ä½•å°ºå¯¸</strong>ã€<strong>å½¢çŠ¶</strong>ã€<strong>ç®¡è„šæ•°</strong>ä»¥åŠ<strong>æ’åˆ—çš„é¡ºåº</strong>ï¼Œæ¥å¤´å¤„çš„å¯é æ¥è§¦ç­‰ã€‚</p></blockquote><p><strong>ç”µæ°”ç‰¹æ€§</strong></p><blockquote><p>ç”µæ°”ç‰¹æ€§ä¸»è¦æ˜¯æŒ‡æ€»çº¿çš„æ¯ä¸€æ ¹ä¼ è¾“çº¿ä¸Šä¿¡å·çš„<strong>ä¼ é€’æ–¹å‘</strong>å’Œ<strong>æœ‰æ•ˆçš„ç”µå¹³èŒƒå›´</strong>ã€‚</p></blockquote><p><strong>åŠŸèƒ½ç‰¹æ€§</strong></p><blockquote><p>åŠŸèƒ½ç‰¹æ€§æ˜¯æŒ‡æ€»çº¿ä¸­æ¯æ ¹ä¼ è¾“çº¿çš„åŠŸèƒ½ï¼Œä¸»è¦åŒ…å«<strong>æ•°æ®ã€åœ°å€å’Œæ§åˆ¶æ€»çº¿</strong>ç­‰ç­‰ã€‚</p></blockquote><p><strong>æ—¶é—´ç‰¹æ€§</strong></p><blockquote><p>ä¸»è¦æ¶‰åŠçš„å°±æ˜¯ä¿¡å·çš„æ—¶åºå…³ç³»ï¼Œä¹Ÿå¯ä»¥è¯´æ€»çº¿ä¸­çš„ä»»ä¸€æ ¹çº¿åœ¨ä»€ä¹ˆæ—¶é—´å†…æœ‰æ•ˆã€‚</p></blockquote><p><strong>æ€§èƒ½æŒ‡æ ‡</strong></p><blockquote><p>æ€§èƒ½æŒ‡æ ‡çš„è¯ï¼Œå…¶å®å°±æ˜¯è¡¡é‡æ€»çº¿èƒ½åŠ›çš„ä¸€ä¸ªåˆ¤æ–­æ ‡å‡†ï¼Œå…·ä½“æˆ‘ä»¬å°±æ¥çœ‹çœ‹å§ï¼</p><ol><li>æ€»çº¿å®½åº¦ï¼šé€šå¸¸æ˜¯æŒ‡æ•°æ®æ€»çº¿çš„æ ¹æ•°ã€‚</li><li>æ€»çº¿å¸¦å®½ï¼šæ€»çº¿å¸¦å®½å¯ç†è§£ä¸ºæ€»çº¿çš„æ•°æ®ä¼ è¾“é€Ÿç‡ï¼Œå³å•ä½æ—¶é—´å†…æ€»çº¿ä¸Šä¼ è¾“æ•°æ®çš„ä½æ•°ï¼Œé€šå¸¸ç”¨æ¯ç§’ä¼ è¾“ä¿¡æ¯çš„å­—èŠ‚æ•°æ¥è¡¡é‡ï¼Œå•ä½å¯ç”¨ MBps ï¼ˆå…†å­—èŠ‚æ¯ç§’ï¼‰è¡¨ç¤ºã€‚</li><li>æ—¶é’ŸåŒæ­¥ï¼å¼‚æ­¥ï¼šæ€»çº¿ä¸Šçš„æ•°æ®ä¸æ—¶é’ŸåŒæ­¥å·¥ä½œçš„æ€»çº¿ç§°ä¸ºåŒæ­¥æ€»çº¿ï¼Œä¸æ—¶é’Ÿä¸åŒæ­¥å·¥ä½œ çš„æ€»çº¿ç§°ä¸ºå¼‚æ­¥æ€»çº¿ã€‚</li><li>æ€»çº¿å¤ç”¨ï¼šä¸€æ¡ä¿¡å·çº¿ä¸Šåˆ†æ—¶ä¼ é€ä¸¤ç§ä¿¡å·ã€‚</li><li>ä¿¡å·çº¿æ•°ï¼šåœ°å€æ€»çº¿ã€æ•°æ®æ€»çº¿å’Œæ§åˆ¶æ€»çº¿ä¸‰ç§æ€»çº¿æ•°çš„æ€»å’Œã€‚</li><li>æ€»çº¿æ§åˆ¶æ–¹å¼ï¼šåŒ…æ‹¬çªå‘å·¥ä½œã€è‡ªåŠ¨é…ç½®ã€ä»²è£æ–¹å¼ã€é€»è¾‘æ–¹å¼ã€è®¡æ•°æ–¹å¼ç­‰ã€‚</li><li>å…¶ä»–æŒ‡æ ‡ï¼šå¦‚è´Ÿè½½èƒ½åŠ›ã€ç”µæºç”µå‹ï¼ˆæ˜¯é‡‡ç”¨ 5V è¿˜æ˜¯ 3.3 V) ã€æ€»çº¿å®½åº¦èƒ½å¦æ‰©å±•ç­‰ã€‚</li></ol></blockquote><h3 id="3-2-æ€»çº¿æ ‡å‡†"><a href="#3-2-æ€»çº¿æ ‡å‡†" class="headerlink" title="3.2 æ€»çº¿æ ‡å‡†"></a>3.2 æ€»çº¿æ ‡å‡†</h3><p>æ€»çº¿æ ‡å‡†çš„è¯ï¼Œæœ‰è®¸è®¸å¤šå¤šæ ‡å‡†ï¼Œå¦‚ï¼šISA æ€»çº¿ã€ EISA æ€»çº¿ã€ VESAæ€»çº¿ã€ PCI æ€»çº¿ã€ AGP æ€»çº¿ã€RS-232C æ€»çº¿å’ŒUSB æ€»çº¿ç­‰ç­‰ï¼Œæˆ‘ä»¬å‘¢ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»ï¼Œä¹¦ä¸Šéƒ½æœ‰ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/image-20230503200015897.png" alt="image-20230503200015897" style="zoom:80%;"><h2 id="4-æ€»çº¿ç»“æ„"><a href="#4-æ€»çº¿ç»“æ„" class="headerlink" title="4.æ€»çº¿ç»“æ„"></a>4.æ€»çº¿ç»“æ„</h2><p><strong>å•æ€»çº¿</strong></p><p>å•æ€»çº¿æ˜¯å°† CPU ã€ä¸»å­˜ã€ I&#x2F;O è®¾å¤‡éƒ½æŒ‚åœ¨ä¸€ç»„æ€»çº¿ä¸Šï¼Œå…è®¸ I&#x2F;O è®¾å¤‡ä¹‹é—´ã€ I&#x2F;O è®¾å¤‡ä¸ CPU ä¹‹é—´æˆ– I&#x2F;O è®¾å¤‡ä¸ä¸»å­˜ä¹‹é—´ç›´æ¥äº¤æ¢ä¿¡æ¯ã€‚ä¹‹å‰ç®€å•ä»‹ç»è¿‡ä¸€ä¸‹ï¼Œåœ¨æ­¤å°±ä¸å†èµ˜è¿°äº†ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/613fe30e19094fe4841a2557469a2846.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p><strong>å¤šæ€»çº¿</strong></p><p>å¯¹äºå¤šæ€»çº¿ç»“æ„ï¼Œä¸»è¦åŒ…æ‹¬åŒæ€»çº¿ã€ä¸‰æ€»çº¿ã€å››æ€»çº¿ç»“æ„ç­‰ç­‰ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€ä»‹ç»å§ï¼</p><ul><li><strong>åŒæ€»çº¿</strong></li></ul><p>åŒæ€»çº¿ç»“æ„çš„ç‰¹ç‚¹æ˜¯å°†é€Ÿåº¦è¾ƒä½çš„ I&#x2F;0 è®¾å¤‡ä»å•æ€»çº¿ä¸Šåˆ†ç¦»å‡ºæ¥ï¼Œå½¢æˆä¸»å­˜æ€»çº¿ä¸ I&#x2F;0 çº¿åˆ†å¼€çš„ç»“æ„ã€‚æœ‰ç‚¹ç±»ä¼¼äºé¢å‘CPUçš„åŒæ€»çº¿æ¨¡å¼ï¼Œä½†ä¸æ˜¯ã€‚é€šé“å¯ä»¥è¯´æ˜¯å…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„å¤„ç†å™¨ï¼Œç”±é€šé“å¯¹I&#x2F;Oç»Ÿä¸€ç®¡ç†ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/0202a9c954724fed9f996289f5a03aa3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><ul><li><strong>ä¸‰æ€»çº¿</strong></li></ul><p>å¦‚æœå°†é€Ÿç‡ä¸åŒçš„ I&#x2F;0 è®¾å¤‡è¿›è¡Œåˆ†ç±»ï¼Œç„¶åå°†å®ƒä»¬è¿æ¥åœ¨ä¸åŒçš„é€šé“ä¸Šï¼Œé‚£ä¹ˆè®¡ç®—æœºç³»ç»Ÿçš„ å·¥ä½œæ•ˆç‡å°†ä¼šæ›´é«˜ï¼Œç”±æ­¤å‘å±•æˆå¤šæ€»çº¿ç»“æ„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä¸¤ç§ä¸‰æ€»çº¿æ¨¡å¼ã€‚</p><p>è¿™ç§å°±æ˜¯å°†é«˜é€ŸI&#x2F;Oè®¾å¤‡é€šè¿‡DMAæŒ‚æ¥åˆ°ä¸»å­˜ä¸Šé¢ï¼Œè¿™æ ·è®¾å¤‡å¯ä»¥å¿«é€Ÿä»ä¸»å­˜é‡Œé¢è·å¾—æ•°æ®ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/b4d4877086664979bd1a14f498780269.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>å¦å¤–ä¸€ç§ç»“æ„å°±æ˜¯é€šè¿‡ä¸€ä¸ªCacheå»ä¿å­˜CPUæ‰€éœ€çš„æ•°æ®ã€‚ä¹Ÿå¯ä»¥è¾¾åˆ°é«˜é€Ÿå­˜å‚¨çš„ä½œç”¨ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/e0ce68ecbb7f4051904205511ce2fb0c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><ul><li><strong>å››æ€»çº¿</strong></li></ul><p>ä¸ºäº†è¿›ä¸€æ­¥æé«˜ I&#x2F;0 è®¾å¤‡çš„æ€§èƒ½ï¼Œä½¿å…¶æ›´å¿«åœ°å“åº”å‘½ä»¤ï¼Œåˆå‡ºç°äº†å››æ€»çº¿ç»“æ„ï¼Œè¿™ç§ç»“æ„å¯¹é«˜é€Ÿè®¾å¤‡è€Œè¨€ï¼Œå…¶è‡ªèº«çš„å·¥ä½œå¯ä»¥å¾ˆå°‘ä¾èµ– CPU ï¼ŒåŒæ—¶å®ƒä»¬åˆæ¯”æ‰©å±•æ€»çº¿ä¸Šçš„è®¾å¤‡æ›´è´´è¿‘ CPU ï¼Œå¯è§å¯¹äºé«˜æ€§èƒ½è®¾å¤‡ä¸ CPU æ¥è¯´ï¼Œå„è‡ªçš„æ•ˆç‡å°†è·å¾—æ›´å¤§çš„æé«˜ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/8f75c6b3c9224a7abaf0609f512f52a3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><h2 id="5-æ€»çº¿æ§åˆ¶"><a href="#5-æ€»çº¿æ§åˆ¶" class="headerlink" title="5.æ€»çº¿æ§åˆ¶"></a>5.æ€»çº¿æ§åˆ¶</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»çš„å°±æ˜¯å…³äºæ€»çº¿æ§åˆ¶çš„ç›¸å…³å†…å®¹ï¼Œä¸»è¦åŒ…æ‹¬åˆ¤ä¼˜æ§åˆ¶å’Œé€šä¿¡æ§åˆ¶ï¼Œè€Œä¸”è¿™ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯æˆ‘ä»¬çš„é‡éš¾ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¼šç€é‡è¿›è¡Œè®²è§£ã€‚</p><h3 id="5-1-æ€»çº¿åˆ¤ä¼˜æ§åˆ¶"><a href="#5-1-æ€»çº¿åˆ¤ä¼˜æ§åˆ¶" class="headerlink" title="5.1 æ€»çº¿åˆ¤ä¼˜æ§åˆ¶"></a>5.1 æ€»çº¿åˆ¤ä¼˜æ§åˆ¶</h3><p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®è®¾å¤‡æ˜¯å¦å¯¹æ€»çº¿æœ‰æ§åˆ¶æƒï¼Œæˆ‘ä»¬æŠŠå…¶åˆ†ä¸ºä¸»è®¾å¤‡å’Œä»è®¾å¤‡ã€‚ä¸»è®¾å¤‡å¯¹æ€»çº¿æœ‰æ§åˆ¶æƒï¼Œä»è®¾å¤‡åªèƒ½å“åº”ä»ä¸»è®¾å¤‡å‘æ¥çš„æ€»çº¿å‘½ä»¤ï¼Œå¯¹æ€»çº¿æ²¡æœ‰æ§åˆ¶æƒã€‚æ€»çº¿åˆ¤ä¼˜ä¹Ÿåˆ†ä¸ºé›†ä¸­å¼å’Œåˆ†å¸ƒå¼ä¸¤ç§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¸€ä¸€è¿›è¡Œä»‹ç»ã€‚</p><p><strong>ï¼ˆ1ï¼‰é“¾å¼æŸ¥è¯¢</strong></p><p>é“¾å¼æŸ¥è¯¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è·Ÿä¸€æ¡é“¾å­ä¸€æ ·ï¼Œä¸€ä¸ªä¸€ä¸ªæŸ¥è¯¢è¿‡å»ã€‚æ§åˆ¶æ€»çº¿ä¸­æœ‰3æ ¹çº¿ç”¨äºæ€»çº¿æ§åˆ¶ï¼ˆBS æ€»çº¿å¿™ã€ BR æ€»çº¿è¯·æ±‚ã€ BG æ€»çº¿åŒæ„ï¼‰ï¼Œå…¶ä¸­æ€»çº¿åŒæ„ä¿¡å· BG æ˜¯ä¸²è¡Œåœ°ä»ä¸€ä¸ª I&#x2F;O æ¥å£é€åˆ°ä¸‹ ä¸€ä¸ª I&#x2F;O æ¥å£ã€‚</p><p>å…·ä½“æ“ä½œå°±æ˜¯ï¼ŒBGä¸€ä¸ªä¸€ä¸ªå»æŸ¥è¯¢æœ‰æ²¡æœ‰è®¾å¤‡å‘é€æ€»çº¿è¯·æ±‚BRï¼Œå½“å‘ç°äº†æœ‰ä¹‹åï¼Œè¿™ä¸ªè®¾å¤‡å°±ä¼šå‘é€æ€»çº¿å¿™ä¿¡å·BSï¼Œè¿™æ ·å°±å æœ‰äº†æ€»çº¿ï¼Œç„¶åä¸‹ä¸€æ¬¡ä¹Ÿæ˜¯å¦‚æ­¤å¾ªç¯ã€‚</p><p><strong>è¿™æ ·çš„è¯åªéœ€å¾ˆå°‘å‡ æ ¹çº¿å°±èƒ½æŒ‰ä¸€å®šä¼˜å…ˆæ¬¡åºå®ç°æ€»çº¿æ§åˆ¶ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“æ‰©å……è®¾å¤‡ï¼Œä½†å¯¹ç”µè·¯æ•…éšœå¾ˆæ•æ„Ÿï¼Œä¸”ä¼˜å…ˆçº§åˆ«ä½çš„è®¾å¤‡å¯èƒ½å¾ˆéš¾è·å¾—è¯·æ±‚ã€‚</strong></p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/ab9830421e654f7e86135b64524d0819.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p><strong>ï¼ˆ2ï¼‰è®¡æ•°å™¨å®šæ—¶æŸ¥è¯¢</strong></p><p>æ¥ä¸‹æ¥ä»‹ç»çš„æ˜¯è®¡æ•°å™¨å®šæ—¶æŸ¥è¯¢ï¼Œä¸é“¾å¼æŸ¥è¯¢ç›¸æ¯”ï¼Œå¤šäº†ä¸€ç»„è®¾å¤‡åœ°å€çº¿ï¼Œå°‘äº†ä¸€æ ¹æ€»çº¿åŒæ„çº¿ BG ã€‚æ€»çº¿æ§åˆ¶éƒ¨ä»¶æ¥åˆ°ç”± BR é€æ¥çš„æ€»çº¿è¯·æ±‚ä¿¡å·åï¼Œåœ¨æ€»çº¿æœªè¢«ä½¿ç”¨ (BS&#x3D; 0) çš„æƒ…å†µä¸‹ï¼Œæ€»çº¿æ§åˆ¶éƒ¨ä»¶ä¸­çš„è®¡æ•°å™¨å¼€å§‹è®¡æ•°ï¼Œå¹¶é€šè¿‡è®¾å¤‡åœ°å€çº¿ï¼Œå‘å„è®¾å¤‡å‘å‡ºä¸€ç»„åœ°å€ä¿¡å·ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥è‡ªå·±è®¾å®šä¼˜å…ˆçº§ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¾ªç¯çš„æ–¹å¼å»ä¸€ä¸€éå†è®¾å¤‡ï¼ˆæ¯æ­¤ä»ä¸­æ–­ç‚¹å¼€å§‹è®¡æ•°ï¼‰ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/7ddaf3e0cf9c4b03b01f7c3dcfe28e65.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p><strong>ï¼ˆ3ï¼‰ç‹¬ç«‹è¯·æ±‚æ–¹å¼</strong></p><p>ç‹¬ç«‹è¯·æ±‚æ–¹å¼å°±æ˜¯æ¯ä¸ªè®¾å¤‡éƒ½ä¸æ€»çº¿æ§åˆ¶éƒ¨ä»¶ç›¸è¿ï¼Œå½“è®¾å¤‡è¦æ±‚ä½¿ç”¨æ€»çº¿æ—¶ï¼Œä¾¿å‘å‡ºè¯¥è®¾å¤‡çš„è¯·æ±‚ä¿¡å·ã€‚æ€»çº¿æ§åˆ¶éƒ¨ä»¶ä¸­æœ‰ä¸€æ’é˜Ÿç”µè·¯ï¼Œå¯æ ¹æ®ä¼˜å…ˆæ¬¡åºç¡®å®šå“åº”å“ªä¸€å°è®¾å¤‡çš„è¯·æ±‚ã€‚</p><p><strong>è¿™ç§æ–¹å¼çš„ç‰¹ç‚¹æ˜¯ï¼šå“åº”é€Ÿåº¦å¿«ï¼Œä¼˜å…ˆæ¬¡åºæ§åˆ¶çµæ´»ï¼Œä½†æ§åˆ¶çº¿æ•°é‡å¤šï¼Œæ€»çº¿æ§åˆ¶æ›´å¤æ‚</strong></p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/79ce24c525704529bfb267f452147ec7.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><h3 id="5-2-æ€»çº¿é€šä¿¡æ§åˆ¶"><a href="#5-2-æ€»çº¿é€šä¿¡æ§åˆ¶" class="headerlink" title="5.2 æ€»çº¿é€šä¿¡æ§åˆ¶"></a>5.2 æ€»çº¿é€šä¿¡æ§åˆ¶</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦ä»‹ç»çš„å°±æ˜¯æ€»çº¿é€šä¿¡æ§åˆ¶äº†ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥è§£å†³é€šä¿¡åŒæ–¹åè°ƒé…åˆçš„é—®é¢˜çš„ã€‚ä¸€å…±åˆ†ä¸º4ä¸ªé˜¶æ®µï¼Œ<strong>ç”³è¯·åˆ†é…ã€å¯»å€ã€ä¼ è¾“å’Œç»“æŸ</strong>é˜¶æ®µã€‚é€šä¿¡æ–¹å¼ä¹Ÿåˆšå¥½æ˜¯å››ç§ï¼Œåˆ†ä¸ºåŒæ­¥ã€å¼‚æ­¥ã€åŠåŒæ­¥å’Œåˆ†ç¦»å¼å››ç§ï¼Œå¥½äº†ï¼Œå°±è®©æˆ‘ä»¬å¼€å§‹å§ï¼</p><p><strong>åŒæ­¥é€šä¿¡</strong></p><p>é€šä¿¡åŒæ–¹ç”±ç»Ÿä¸€æ—¶æ ‡æ§åˆ¶æ•°æ®ä¼ é€ç§°ä¸ºåŒæ­¥é€šä¿¡ã€‚æ—¶æ ‡é€šå¸¸ç”± CPU çš„æ€»çº¿æ§åˆ¶éƒ¨ä»¶å‘å‡ºï¼Œé€åˆ°æ€»çº¿ä¸Šçš„æ‰€æœ‰éƒ¨ä»¶ï¼›ä¹Ÿå¯ä»¥ç”±æ¯ä¸ªéƒ¨ä»¶å„è‡ªçš„æ—¶åºå‘ç”Ÿå™¨å‘å‡ºï¼Œä½†å¿…é¡»ç”±æ€»çº¿æ§åˆ¶éƒ¨ä»¶å‘å‡ºçš„æ—¶é’Ÿä¿¡å·å¯¹å®ƒä»¬è¿›è¡ŒåŒæ­¥ã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/1cba2e60495944e1bb4a6e3e8a5fc2a4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>å¯¹äºè¯»å‘½ä»¤ï¼Œå…¶ä¼ è¾“å‘¨æœŸå¦‚ä¸‹ï¼š</p><ol><li>T1ä¸»æ¨¡å—å‘åœ°å€ã€‚</li><li>T2ä¸»æ¨¡å—å‘è¯»å‘½ä»¤ã€‚</li><li>T3ä»æ¨¡å—æä¾›æ•°æ®ã€‚</li><li>T4ä¸»æ¨¡å—æ’¤é”€è¯»å‘½ä»¤ï¼Œä»æ¨¡å—æ’¤é”€æ•°æ®ã€‚</li></ol><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/2e3ea8616cd84012ba6a804194bc61bb.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 67%;"><p>å¯¹äºå†™å‘½ä»¤ï¼Œå…¶ä¼ è¾“å‘¨æœŸå¦‚ä¸‹ï¼š</p><ol><li>T1ä¸»æ¨¡å—å‘åœ°å€ã€‚</li><li>T1.5ä¸»æ¨¡å—å‘è¯»å‘½ä»¤ã€‚</li><li>T2ä»æ¨¡å—æä¾›æ•°æ®ã€‚</li><li>T4ä¸»æ¨¡å—æ’¤é”€è¯»å‘½ä»¤ï¼Œä»æ¨¡å—æ’¤é”€æ•°æ®ã€‚</li></ol><p><strong>ç‰¹ç‚¹</strong></p><p>è¿™ç§é€šä¿¡çš„ä¼˜ç‚¹æ˜¯è§„å®šæ˜ç¡®ã€ç»Ÿä¸€ï¼Œæ¨¡å—é—´çš„é…åˆç®€å•ä¸€è‡´ã€‚å…¶ç¼ºç‚¹æ˜¯ä¸»ã€ä»æ¨¡å—æ—¶é—´é…åˆå±äºå¼ºåˆ¶æ€§â€åŒæ­¥â€ï¼Œå¿…é¡»åœ¨é™å®šæ—¶é—´å†…å®Œæˆè§„å®šçš„è¦æ±‚ã€‚å¹¶ä¸”å¯¹æ‰€æœ‰ä»æ¨¡å—éƒ½ç”¨åŒä¸€é™æ—¶ï¼Œè¿™å°±åŠ¿å¿…é€ æˆï¼Œå¯¹å„ä¸ç›¸åŒé€Ÿåº¦çš„éƒ¨ä»¶è€Œè¨€ï¼Œå¿…é¡»æŒ‰æœ€æ…¢é€Ÿåº¦çš„éƒ¨ä»¶æ¥è®¾è®¡å…¬å…±æ—¶é’Ÿï¼Œä¸¥é‡å½±å“æ€»çº¿çš„å·¥ä½œæ•ˆç‡ï¼Œä¹Ÿç»™è®¾è®¡å¸¦æ¥äº†å±€é™æ€§ï¼Œç¼ºä¹çµæ´»æ€§ã€‚</p><p>æ‰€ä»¥åŒæ­¥é€šä¿¡ä¸€èˆ¬ç”¨åƒæ€»çº¿é•¿åº¦è¾ƒçŸ­ã€å„éƒ¨ä»¶å­˜å–æ—¶é—´æ¯”è¾ƒä¸€è‡´çš„åœºåˆã€‚è€Œä¸”ï¼Œæ€»çº¿ä¼ è¾“å‘¨æœŸè¶ŠçŸ­ï¼Œæ•°æ®çº¿çš„ä½æ•°è¶Šå¤šï¼Œç›´æ¥å½±å“æ€»çº¿çš„æ•°æ®ä¼ è¾“ç‡</p><p><strong>å¼‚æ­¥é€šä¿¡</strong></p><p>å¼‚æ­¥é€šä¿¡å…‹æœäº†åŒæ­¥é€šä¿¡çš„ç¼ºç‚¹ï¼Œå…è®¸å„æ¨¡å—é€Ÿåº¦çš„ä¸ä¸€è‡´æ€§ï¼Œç»™è®¾è®¡è€…å……åˆ†çš„çµæ´»æ€§å’Œé€‰æ‹©ä½™åœ°ã€‚ä»–æ˜¯æ˜¯é‡‡ç”¨åº”ç­”æ–¹å¼ï¼ˆåˆç§°æ¡æ‰‹æ–¹å¼ï¼‰ï¼Œå³å½“ä¸»æ¨¡å—å‘å‡ºè¯·æ±‚ (Request) ä¿¡å·æ—¶ï¼Œä¸€ç›´ç­‰å¾…ä»æ¨¡å—åé¦ˆå›æ¥â€œå“åº” â€ä¿¡å·åæ‰å¼€å§‹é€šä¿¡ã€‚åº”ç­”æ–¹å¼å¯åˆ†ä¸ºä¸äº’é”ã€åŠäº’é”å’Œå…¨äº’é”ä¸‰ç§ç±»å‹ã€‚</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œé‡‡ç”¨å‡ºç§Ÿè½¦çš„ä¾‹å­å»å¸®åŠ©å¤§å®¶ç†è§£è¿™ä¸‰ç§æ–¹å¼çš„åŒºåˆ«ï¼Œè¯·å¤§å®¶æƒ³åƒè‡ªå·±åœ¨å’Œå‡ºç§Ÿè½¦å¸æœºäº¤æµã€‚</p><ul><li><strong>ä¸äº’é”</strong></li></ul><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/7b92eb35ab61481b969a2ad6e55b5e91.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>è¿™å°±æ˜¯ç¬¬ä¸€ç§æƒ…å†µï¼Œçƒ­æƒ…å¸æœºä¸é«˜å†·ä¹˜å®¢ï¼Œé¦–å…ˆå¸æœºè¯¢é—®ï¼šä½ å»å“ªå•Šï¼Ÿï¼ˆè¯·æ±‚ä¿¡å·ï¼‰ã€‚ä½†æ˜¯ä¹˜å®¢ä¸å›ç­”ï¼Œè¿™ä¸ªæ—¶å€™å¸æœºåªèƒ½æŒ‰ç…§æ‰“è½¦è½¯ä»¶çš„åœ°å€å°†ä¹˜å®¢å®‰å…¨é€è¾¾ï¼Œæˆ–è€…åªèƒ½è®©ä»–ä¸‹è½¦äº†ã€‚</p><ul><li><strong>åŠäº’é”</strong></li></ul><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/568e2b35a6504802b387c71e7fda1a3b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:80%;"><p>è¿™ä¸ªå±äºç¬¬äºŒç§æƒ…å†µï¼Œé«˜å†·å¸æœºä¸çƒ­æƒ…ä¹˜å®¢ï¼Œé¦–å…ˆå¸æœºè¯¢é—®ï¼šä½ å»å“ªå•Šï¼Ÿï¼ˆè¯·æ±‚ä¿¡å·ï¼‰ã€‚ä¹˜å®¢å›ç­”ï¼šæœºåœºï¼ˆå›ç­”ä¿¡å·ï¼‰ã€‚è¿™ä¸ªæ—¶å€™å¸æœºä¾¿ä¸å†å›ç­”ã€‚è¿™ç§æƒ…å†µçœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä¼šç…§æˆä¸€ä¸ªæƒ…å†µï¼Œå°±æ˜¯é¡¾å®¢æ€•å¸æœºæ²¡å¬æ¸…æ¥šï¼Œä¾¿ä¸€ç›´å›ç­”ã€‚</p><ul><li><strong>å…¨äº’é”</strong></li></ul><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/c878e28825d349879bd6135713629034.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom: 80%;"><p>è¿™ä¸ªå±äºç¬¬ä¸‰ç§æƒ…å†µï¼Œçƒ­æƒ…å¸æœºä¸çƒ­æƒ…ä¹˜å®¢ï¼Œé¦–å…ˆå¸æœºè¯¢é—®ï¼šä½ å»å“ªå•Šï¼Ÿï¼ˆè¯·æ±‚ä¿¡å·ï¼‰ã€‚ä¹˜å®¢å›ç­”ï¼šæœºåœºï¼ˆå›ç­”ä¿¡å·ï¼‰ã€‚è¿™ä¸ªæ—¶å€™å¸æœºä¾¿å›ç­”ï¼šå¥½å˜ã€‚è¿™ç§æƒ…å†µå°±æ¯”è¾ƒå®Œç¾äº†ã€‚</p><p><strong>åŠåŒæ­¥é€šä¿¡</strong></p><p>åŠåŒæ­¥é€šä¿¡æ—¢ä¿ç•™äº†åŒæ­¥é€šä¿¡çš„åŸºæœ¬ç‰¹ç‚¹ï¼Œå¦‚æ‰€æœ‰çš„åœ°å€ã€å‘½ä»¤ã€æ•°æ®ä¿¡å·çš„å‘å‡ºæ—¶é—´ï¼Œéƒ½ä¸¥æ ¼å‚ç…§ç³»ç»Ÿæ—¶é’Ÿçš„æŸä¸ªå‰æ²¿å¼€å§‹ï¼Œè€Œæ¥æ”¶æ–¹éƒ½é‡‡ç”¨ç³»ç»Ÿæ—¶é’Ÿåæ²¿æ—¶åˆ»æ¥è¿›è¡Œåˆ¤æ–­è¯†åˆ«ï¼›åŒæ—¶åˆåƒå¼‚æ­¥é€šä¿¡é‚£æ ·ï¼Œå…è®¸ä¸åŒé€Ÿåº¦çš„æ¨¡å—å’Œè°åœ°å·¥ä½œã€‚</p><img src="/2023/05/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%89-%E6%80%BB%E7%BA%BF/c1283df227924e94a74ae78bd9062b45.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;"><p>å…¶å®å°±æ˜¯åŠ äº†ä¸€ä¸ªç­‰å¾…ä¿¡å·ï¼Œä»¥ä¾¿äºä¸åŒé€Ÿåº¦çš„æ¨¡å—èƒ½ä¸€èµ·å·¥ä½œã€‚å¯¹äºè¯»å‘½ä»¤ï¼Œå…¶ä¼ è¾“å‘¨æœŸå¦‚ä¸‹ï¼š</p><ol><li>T1ä¸»æ¨¡å—å‘åœ°å€ã€‚</li><li>T2ä¸»æ¨¡å—å‘è¯»å‘½ä»¤ã€‚</li><li>TWAIT ~ TWAITä¸ºä½ç”µå¹³æ—¶ï¼Œè¿›å…¥ç­‰å¾…ï¼Œå…«çš„å®½åº¦ä¸ çš„å®½åº¦ä¸€è‡´ã€‚</li><li>T3ä»æ¨¡å—æä¾›æ•°æ®ã€‚</li><li>T4ä¸»æ¨¡å—æ’¤é”€è¯»å‘½ä»¤ï¼Œä»æ¨¡å—æ’¤é”€æ•°æ®ã€‚</li></ol><p>ç„¶åè¾“å‡ºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸Šé¢ä¸‰ç§é€šä¿¡çš„å…±åŒç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>ä¸»æ¨¡å—å‘åœ°å€ã€å‘½ä»¤ å ç”¨æ€»çº¿</li><li>ä»æ¨¡å—å‡†å¤‡æ•°æ® ä¸å ç”¨æ€»çº¿</li><li>ä»æ¨¡å—å‘ä¸»æ¨¡å—å‘æ•°æ® å ç”¨æ€»çº¿</li></ul><p>äºæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬è®¾è®¡å‡ºæ¥äº†åˆ†ç¦»å¼é€šä¿¡ã€‚å……åˆ†æŒ–æ˜ç³»ç»Ÿæ€»çº¿æ¯ä¸ªç¬é—´çš„æ½œåŠ›ã€‚</p><p><strong>åˆ†ç¦»å¼é€šä¿¡</strong></p><p>æˆ‘ä»¬ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªå‘¨æœŸï¼š</p><ul><li>ä¸»æ¨¡å—ç”³è¯·å ç”¨æ€»çº¿ï¼Œä½¿ç”¨å®Œåæ—¢æ”¾å¼ƒæ€»çº¿çš„ä½¿ç”¨æƒã€‚</li><li>ä»æ¨¡å—ç”³è¯·å ç”¨æ€»çº¿ï¼Œå°†å„ç±»å­¦ä¹ ä¼ è¾“åˆ°æ€»çº¿ä¸Šã€‚</li></ul><p><strong>ç‰¹ç‚¹</strong></p><ol><li>å„æ¨¡å—æ¬²å ç”¨æ€»çº¿ä½¿ç”¨æƒéƒ½å¿…é¡»æå‡ºç”³è¯·ã€‚</li><li>åœ¨å¾—åˆ°æ€»çº¿ä½¿ç”¨æƒåï¼Œä¸»æ¨¡å—åœ¨é™å®šçš„æ—¶é—´å†…å‘å¯¹æ–¹ä¼ é€ä¿¡æ¯ï¼Œé‡‡ç”¨åŒæ­¥æ–¹å¼ä¼ é€ï¼Œä¸å†ç­‰å¾…å¯¹æ–¹çš„å›ç­”ä¿¡å·ã€‚</li><li>å„æ¨¡å—åœ¨å‡†å¤‡æ•°æ®çš„è¿‡ç¨‹ä¸­éƒ½ä¸å ç”¨æ€»çº¿ï¼Œä½¿æ€»çº¿å¯æ¥å—å…¶ä»–æ¨¡å—çš„è¯·æ±‚ã€‚</li><li>æ€»çº¿è¢«å ç”¨æ—¶éƒ½åœ¨åšæœ‰æ•ˆå·¥ä½œï¼Œæˆ–è€…é€šè¿‡å®ƒå‘é€å‘½ä»¤ï¼Œæˆ–è€…é€šè¿‡å®ƒä¼ é€æ•°æ®ï¼Œä¸å­˜åœ¨ç©ºé—²ç­‰å¾…æ—¶é—´ï¼Œå……åˆ†åœ°åˆ©ç”¨äº†æ€»çº¿çš„æœ‰æ•ˆå ç”¨ï¼Œä»è€Œå®ç°äº†æ€»çº¿åœ¨å¤šä¸ªä¸»ã€ä»æ¨¡å—é—´è¿›è¡Œä¿¡æ¯äº¤å‰é‡å å¹¶è¡Œå¼ä¼ é€ï¼Œè¿™å¯¹å¤§å‹è®¡ç®—æœºç³»ç»Ÿæ˜¯æä¸ºé‡è¦çš„ã€‚</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è½¦æœºMCUçŸ¥è¯†æ¢³ç†</title>
    <link href="/2023/05/03/%E8%BD%A6%E6%9C%BAMCU%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/"/>
    <url>/2023/05/03/%E8%BD%A6%E6%9C%BAMCU%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="è½¦æœºMCUçŸ¥è¯†æ¢³ç†"><a href="#è½¦æœºMCUçŸ¥è¯†æ¢³ç†" class="headerlink" title="è½¦æœºMCUçŸ¥è¯†æ¢³ç†"></a>è½¦æœºMCUçŸ¥è¯†æ¢³ç†</h1><blockquote><p>å£°æ˜ï¼šè½¬è½½è‡ª<a href="https://www.eet-china.com/mp/a191448.html">https://www.eet-china.com/mp/a191448.html</a></p><p>ä»…åšä¸ªäººå­¦ä¹ ç¬”è®°ä½¿ç”¨</p></blockquote><p>ä¸€è¾†ä¼ ç»Ÿç‡ƒæ²¹è½¦éœ€è¦å¤§çº¦500åˆ°600é¢—èŠ¯ç‰‡ï¼Œè½»æ··æ±½è½¦å¤§çº¦éœ€è¦1000é¢—ï¼Œæ’ç”µæ··åŠ¨å’Œçº¯ç”µåŠ¨æ±½è½¦åˆ™éœ€è¦è‡³å°‘2000é¢—èŠ¯ç‰‡ã€‚è¿™æ„å‘³ç€ï¼Œéšç€æ™ºèƒ½ç”µåŠ¨æ±½è½¦çš„é£é€Ÿå‘å±•ï¼Œä¸ä½†å…ˆè¿›åˆ¶ç¨‹çš„èŠ¯ç‰‡éœ€æ±‚é‡è¶Šæ¥è¶Šå¤§ï¼Œä¼ ç»ŸèŠ¯ç‰‡çš„éœ€æ±‚é‡ä¹Ÿå°†ç»§ç»­æå‡ã€‚MCUå°±æ˜¯è¿™æ ·ï¼Œé™¤äº†å•è½¦æ­è½½çš„æ•°é‡åœ¨ä¸æ–­å¢é•¿ï¼ŒåŸŸæ§åˆ¶å™¨ä¹Ÿå¸¦æ¥äº†å¯¹é«˜å®‰å…¨ã€é«˜å¯é ã€é«˜ç®—åŠ›MCUçš„æ–°éœ€æ±‚å¢é•¿ã€‚</p><p>MCUï¼ŒMicrocontroller Unitï¼Œä¸­æ–‡ç§°å•ç‰‡å¾®å‹è®¡ç®—æœº&#x2F;å¾®æ§åˆ¶å™¨&#x2F;å•ç‰‡æœºï¼Œå°†CPUã€å­˜å‚¨å™¨ã€å¤–å›´åŠŸèƒ½æ•´åˆåœ¨å•ä¸€èŠ¯ç‰‡ä¸Šï¼Œå½¢æˆå…·æœ‰æ§åˆ¶åŠŸèƒ½çš„èŠ¯ç‰‡çº§è®¡ç®—æœºï¼Œä¸»è¦ç”¨äºå®ç°ä¿¡å·å¤„ç†å’Œæ§åˆ¶ï¼Œæ˜¯æ™ºèƒ½æ§åˆ¶ç³»ç»Ÿçš„æ ¸å¿ƒã€‚</p><p>MCUä¸æˆ‘ä»¬çš„ç”Ÿæ´»å·¥ä½œæ¯æ¯ç›¸å…³ï¼Œå¦‚æ±½è½¦ç”µå­ã€å·¥ä¸šã€è®¡ç®—æœºä¸ç½‘ç»œã€æ¶ˆè´¹ç”µå­ã€å®¶ç”µã€ç‰©è”ç½‘ç­‰ï¼Œå…¶ä¸­æ±½è½¦ç”µå­æ˜¯æœ€å¤§çš„å¸‚åœºï¼Œä»å…¨çƒè§’åº¦çœ‹å æ¯”è¾¾åˆ°äº†33%ã€‚</p><h2 id="MCUç»“æ„"><a href="#MCUç»“æ„" class="headerlink" title="MCUç»“æ„"></a>MCUç»“æ„</h2><p>MCUä¸»è¦ç”±ä¸­å¤®å¤„ç†å™¨CPUã€å­˜å‚¨å™¨ï¼ˆROMå’ŒRAMï¼‰ã€è¾“å…¥è¾“å‡ºI&#x2F;Oæ¥å£ã€ä¸²è¡Œå£ã€è®¡æ•°å™¨ç­‰æ„æˆã€‚</p><img src="/2023/05/03/%E8%BD%A6%E6%9C%BAMCU%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/MBXY-CR-abdcd2d763896a6c675eba8495147cd2.png" alt="img" style="zoom: 60%;"><p><strong>CPUï¼š</strong>Central Processing Unitï¼Œä¸­å¤®å¤„ç†å™¨ï¼Œæ˜¯ MCU å†…éƒ¨çš„æ ¸å¿ƒéƒ¨ä»¶ï¼Œè¿ç®—éƒ¨ä»¶èƒ½å®Œæˆæ•°æ®çš„ç®—æœ¯é€»è¾‘è¿ç®—ã€ä½å˜é‡å¤„ç†å’Œæ•°æ®ä¼ é€æ“ä½œï¼Œæ§åˆ¶éƒ¨ä»¶åˆ™æŒ‰ç…§ä¸€å®šæ—¶åºåè°ƒå·¥ä½œï¼Œåˆ†æå¹¶æ‰§è¡ŒæŒ‡ä»¤ã€‚</p><p><strong>ROMï¼š</strong>Read-Only Memoryï¼Œæ˜¯ç¨‹åºå­˜å‚¨å™¨ï¼Œç”¨æ¥å­˜æ”¾ç”±åˆ¶é€ å‚å®¶å†™å¥½çš„ç¨‹åºï¼Œä¿¡æ¯ä»¥éç ´åæ–¹å¼è¯»å–ï¼Œå­˜å‚¨æ•°æ®æ‰ç”µåä¸æ¶ˆå¤±ï¼ŒMCUæŒ‰ç…§äº‹å…ˆç¼–å†™å¥½çš„ç¨‹åºæ‰§è¡Œã€‚</p><p><strong>RAMï¼š</strong>Random Access Memoryï¼Œæ˜¯æ•°æ®å­˜å‚¨å™¨ï¼Œä¸ CPU ç›´æ¥è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œæ‰ç”µåè¯¥æ•°æ®ä¸èƒ½ä¿æŒã€‚åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥éšæ—¶å†™å…¥ã€è¯»å‡ºï¼Œé€šå¸¸ä½œä¸ºæ“ä½œç³»ç»Ÿæˆ–å…¶ä»–æ­£åœ¨è¿è¡Œä¸­ç¨‹åºçš„ä¸´æ—¶æ•°æ®å­˜å‚¨ä»‹è´¨ã€‚</p><p><strong>CPUå’ŒMCUçš„å…³ç³»ï¼š</strong></p><p>CPUæ˜¯è¿ç®—æ§åˆ¶çš„æ ¸å¿ƒã€‚MCUé™¤äº†CPUä¹‹å¤–ï¼Œè¿˜åŒ…å«ROMæˆ–RAMç­‰ï¼Œæ˜¯èŠ¯ç‰‡çº§èŠ¯ç‰‡ã€‚å¸¸è§çš„è¿˜æœ‰SoCï¼ˆSystem on Chipï¼‰ï¼Œä¸­æ–‡ç§°ç‰‡ä¸Šç³»ç»Ÿï¼Œæ˜¯ç³»ç»Ÿçº§èŠ¯ç‰‡ï¼Œå¯å­˜æ”¾å¹¶è¿è¡Œç³»ç»Ÿçº§åˆ«çš„ä»£ç ï¼Œè¿è¡ŒQNXã€Linux ç­‰æ“ä½œç³»ç»Ÿï¼ŒåŒ…å«å¤šä¸ªå¤„ç†å™¨å•å…ƒï¼ˆCPU+GPU+DSP+NPU+å­˜å‚¨+æ¥å£å•å…ƒï¼‰</p><h2 id="MCUçš„ä½æ•°"><a href="#MCUçš„ä½æ•°" class="headerlink" title="MCUçš„ä½æ•°"></a>MCUçš„ä½æ•°</h2><p>ä½æ•°æ˜¯æŒ‡MCUæ¯æ¬¡å¤„ç†æ•°æ®çš„å®½åº¦ï¼Œä½æ•°è¶Šé«˜æ„å‘³ç€MCUæ•°æ®å¤„ç†èƒ½åŠ›å°±è¶Šå¼ºï¼Œç›®å‰æœ€ä¸»è¦çš„æ˜¯8ã€16ã€32ä½ä¸‰ç§ï¼Œå…¶ä¸­32ä½å æ¯”æœ€å¤šä¸”å¢é•¿è¿…é€Ÿã€‚</p><img src="/2023/05/03/%E8%BD%A6%E6%9C%BAMCU%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/MBXY-CR-705bbb7f06192297ec5f0fc5c931f0ae.png" alt="img" style="zoom:80%;"><p>åœ¨æ±½è½¦ç”µå­åº”ç”¨ä¸­ï¼Œ8ä½MCUæˆæœ¬ä½ã€ä¾¿äºå¼€å‘ï¼Œç›®å‰ä¸»è¦åº”ç”¨åœ¨ç›¸å¯¹ç®€å•çš„æ§åˆ¶é¢†åŸŸï¼Œå¦‚ç…§æ˜ã€é›¨åˆ·ã€è½¦çª—ã€åº§æ¤…å’Œè½¦é—¨ç­‰è½¦èº«åŸŸæ§åˆ¶ã€‚è€Œå¯¹äºç›¸å¯¹å¤æ‚çš„é¢†åŸŸï¼Œå¦‚ä»ªè¡¨æ˜¾ç¤ºã€è½¦è½½å¨±ä¹ä¿¡æ¯ç³»ç»Ÿã€åŠ¨åŠ›æ§åˆ¶ç³»ç»Ÿã€åº•ç›˜ã€é©¾é©¶è¾…åŠ©ç³»ç»Ÿç­‰ï¼Œåˆ™ä»¥32ä½çš„ä¸ºä¸»ï¼Œä¸”éšç€æ±½è½¦ç”µåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€ç½‘è”åŒ–çš„è¿­ä»£è¿›åŒ–ï¼Œå¯¹MCUçš„è¿ç®—èƒ½åŠ›è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚</p><table><thead><tr><th>ä½æ•°</th><th>è½¦ç›¸å…³æ¨¡å—</th><th>æ—¶é—´</th><th>ä»·æ ¼ï¼ˆç¾å…ƒï¼‰</th></tr></thead><tbody><tr><td>8ä½</td><td>ä½ç«¯æ§åˆ¶åŠŸèƒ½ï¼šè½¦ä½“çš„å„ä¸ªæ¬¡ç³»ç»Ÿï¼Œå¦‚é£æ‰‡æ§åˆ¶ã€ç©ºè°ƒæ§åˆ¶ã€é›¨åˆ·ã€å¤©çª—ã€è½¦çª—å‡é™ã€ä½é˜¶ä»ªè¡¨æ¿ã€é›†çº¿ç›’ã€åº§æ¤… æ§åˆ¶ã€é—¨æ§æ¨¡å—ç­‰ä½é˜¶æ§åˆ¶åŠŸèƒ½ã€‚</td><td>1980-1983å¹´</td><td>&lt;1</td></tr><tr><td>16ä½</td><td>ä¸­ç«¯æ§åˆ¶åŠŸèƒ½ï¼šâ‘  åŠ¨åŠ›ä¼ åŠ¨ç³»ç»Ÿï¼Œå¦‚å¼•æ“æ§åˆ¶ã€é½¿è½®ä¸ç¦»åˆå™¨æ§åˆ¶ï¼Œå’Œç”µå­å¼æ¶¡è½®ç³»ç»Ÿç­‰ï¼›â‘¡ åº•ç›˜æœºæ„ï¼Œå¦‚æ‚¬åŠç³»ç»Ÿã€ç”µå­å¼åŠ¨åŠ›æ–¹å‘ç›˜ã€æ‰­åŠ›åˆ†æ•£æ§åˆ¶ã€ç”µå­å¸®è¾…ã€ç”µå­åˆ¹è½¦ç­‰</td><td>1983-80å¹´ä»£æœ«</td><td>1 ~ 5</td></tr><tr><td>32ä½</td><td>é«˜ç«¯æ§åˆ¶åŠŸèƒ½ï¼šL1&#x2F;L2æ™ºèƒ½é©¾é©¶åŠŸèƒ½ä¸­æ‰®æ¼”é‡è¦è§’è‰²ï¼Œå¦‚ä»ªè¡¨ç›˜æ§åˆ¶ã€è½¦èº«æ§åˆ¶ã€å¤šåª’ä½“ä¿¡æ¯ç³»ç»Ÿã€å¼•æ“æ§åˆ¶ï¼Œä»¥åŠæ–°å…´çš„æ™ºèƒ½æ€§å’Œå®æ—¶æ€§çš„å®‰å…¨ç³»ç»ŸåŠåŠ¨åŠ›ç³»ç»Ÿï¼ˆé¢„ç¢°æ’ã€ACCã€é©¾é©¶è¾…åŠ©ç³»ç»Ÿã€ç”µå­ç¨³å®šç¨‹åºã€X-by-wire ç­‰ï¼‰</td><td>1990å¹´ä»£è‡³ä»Š</td><td>5~10ï¼Œéƒ¨åˆ†&gt;10</td></tr></tbody></table><h2 id="MCUè½¦è§„è®¤è¯"><a href="#MCUè½¦è§„è®¤è¯" class="headerlink" title="MCUè½¦è§„è®¤è¯"></a>MCUè½¦è§„è®¤è¯</h2><p>MCUä¾›åº”å•†åœ¨è¿›å…¥OEMçš„ä¾›åº”é“¾ä½“ç³»å‰ï¼Œä¸€èˆ¬éœ€è¦å®Œæˆä¸‰å¤§è®¤è¯ï¼šè®¾è®¡é˜¶æ®µè¦éµå¾ªåŠŸèƒ½å®‰å…¨æ ‡å‡† ISO 26262ï¼Œæµç‰‡å’Œå°è£…é˜¶æ®µè¦éµå¾ªAEC-Q001~004å’ŒIATF16949ï¼Œä»¥åŠåœ¨è®¤è¯æµ‹è¯•é˜¶æ®µè¦éµå¾ªAEC-Q100&#x2F;Q104ã€‚</p><p>å…¶ä¸­ï¼ŒISO 26262å®šä¹‰äº†ASILå››ä¸ªå®‰å…¨ç­‰çº§ï¼Œä»ä½åˆ°é«˜åˆ†åˆ«ä¸ºAã€Bã€Cå’ŒDï¼›AEC-Q100 åˆ†ä¸ºå››ä¸ªå¯é æ€§ç­‰çº§ï¼Œä»ä½åˆ°é«˜åˆ†åˆ«ä¸º 3ã€2ã€1å’Œ0ã€‚AEC-Q100 ç³»åˆ—è®¤è¯ä¸€èˆ¬éœ€è¦1-2å¹´çš„æ—¶é—´ï¼Œè€ŒISO 26262çš„è®¤è¯éš¾åº¦æ›´å¤§ï¼Œå‘¨æœŸæ›´é•¿ã€‚</p><h2 id="MCUåœ¨æ™ºèƒ½ç”µåŠ¨æ±½è½¦äº§ä¸šçš„åº”ç”¨"><a href="#MCUåœ¨æ™ºèƒ½ç”µåŠ¨æ±½è½¦äº§ä¸šçš„åº”ç”¨" class="headerlink" title="MCUåœ¨æ™ºèƒ½ç”µåŠ¨æ±½è½¦äº§ä¸šçš„åº”ç”¨"></a>MCUåœ¨æ™ºèƒ½ç”µåŠ¨æ±½è½¦äº§ä¸šçš„åº”ç”¨</h2><p>MCUåœ¨æ±½è½¦äº§ä¸šä¸­åº”ç”¨å¹¿æ³›ï¼Œå¦‚å‰è¡¨ï¼Œä»è½¦èº«é™„ä»¶ã€åŠ¨åŠ›ç³»ç»Ÿã€åº•ç›˜ã€è½¦è½½ä¿¡æ¯å¨±ä¹åˆ°æ™ºèƒ½é©¾é©¶ç­‰æ¿å—éƒ½ä¼šç”¨åˆ°ã€‚éšç€æ™ºèƒ½ç”µåŠ¨æ±½è½¦æ—¶ä»£çš„å‘å±•ï¼ŒMCUäº§å“éœ€æ±‚ä¼šè¶Šæ¥è¶Šæ—ºç››ã€‚</p><p><strong>ç”µåŠ¨åŒ–ï¼š</strong></p><p>1ã€ç”µæ± ç®¡ç†ç³»ç»ŸBMSï¼šBMSéœ€è¦å¯¹å……æ”¾ç”µã€æ¸©åº¦ã€ç”µæ± é—´å‡è¡¡è¿›è¡Œæ§åˆ¶ï¼Œä¸»æ§æ¿éœ€è¦ä¸€é¢—MCUï¼Œæ¯ä¸ªä»æ§æ¿ä¹Ÿéœ€è¦ä¸€é¢—MCUï¼›</p><p>2ã€æ•´è½¦æ§åˆ¶å™¨VCUï¼šç”µåŠ¨æ±½è½¦èƒ½é‡ç®¡ç†éœ€è¦å¢åŠ ä¸€ä¸ªæ•´è½¦æ§åˆ¶å™¨ï¼ŒåŒæ—¶éœ€è¦é…å¤‡32ä½é«˜é˜¶MCUï¼Œæ•°é‡æ ¹æ®å„å‚çš„æ–¹æ¡ˆä¸åŒè€Œä¸åŒï¼›</p><p>3ã€å¼•æ“æ§åˆ¶å™¨&#x2F;å˜é€Ÿç®±æ§åˆ¶å™¨ï¼šå­˜é‡æ›¿æ¢ï¼Œç”µåŠ¨æ±½è½¦é€†å˜å™¨æ§åˆ¶MCUæ›¿ä»£æ²¹è½¦çš„å¼•æ“æ§åˆ¶å™¨ï¼Œç”±äºç”µæœºè½¬é€Ÿè¾ƒé«˜ï¼Œéœ€è¦ç»è¿‡å‡é€Ÿå™¨å‡é€Ÿï¼Œå…¶é…å¤‡çš„MCUæ§åˆ¶èŠ¯ç‰‡æ›¿æ¢äº†æ²¹è½¦çš„å˜é€Ÿç®±æ§åˆ¶å™¨ã€‚</p><p><strong>æ™ºèƒ½åŒ–ï¼š</strong></p><p>1ã€ç›®å‰å›½å†…æ±½è½¦å¸‚åœºè¿˜æ˜¯å¤„äºL2é«˜é€Ÿæ¸—é€çš„é˜¶æ®µï¼ŒåŸºäºç»¼åˆæˆæœ¬å’Œæ€§èƒ½çš„è€ƒé‡ï¼ŒOEMæ–°å¢ADASåŠŸèƒ½ä»æ²¿ç”¨åˆ†å¸ƒå¼æ¶æ„ï¼Œéšç€è£…è½½ç‡çš„æå‡ï¼Œå¤„ç†ä¼ æ„Ÿå™¨ä¿¡æ¯çš„MCUéšä¹‹å¢åŠ ã€‚</p><p>2ã€ç”±äºåº§èˆ±åŠŸèƒ½æ—¥ç›Šå¢å¤šï¼Œæ›´é«˜æ–°èƒ½çš„èŠ¯ç‰‡ä½œç”¨è¶Šæ¥è¶Šé‡è¦ï¼Œå¯¹åº”çš„MCUåœ°ä½æœ‰æ‰€ä¸‹é™ã€‚</p><h2 id="å·¥è‰ºåˆ¶é€ "><a href="#å·¥è‰ºåˆ¶é€ " class="headerlink" title="å·¥è‰ºåˆ¶é€ "></a>å·¥è‰ºåˆ¶é€ </h2><p>MCUæœ¬èº«å¯¹ç®—åŠ›è¦æ±‚ä¼˜å…ˆï¼Œå¯¹å…ˆè¿›åˆ¶ç¨‹è¦æ±‚ä¸é«˜ï¼ŒåŒæ—¶å…¶å†…ç½®çš„åµŒå…¥å¼å­˜å‚¨è‡ªèº«ä¹Ÿé™åˆ¶äº†MCUåˆ¶ç¨‹çš„æå‡ï¼Œå› æ­¤å½“å‰è½¦è§„MCUå·¥è‰ºèŠ‚ç‚¹ä¸»è¦æ˜¯åœ¨40nmåŠä»¥ä¸Šçš„æˆç†Ÿåˆ¶ç¨‹ï¼Œéƒ¨åˆ†æ¯”è¾ƒå…ˆè¿›çš„è½¦ç”¨MCUäº§å“é‡‡ç”¨äº†28nmåˆ¶ç¨‹ã€‚è½¦è§„èŠ¯ç‰‡çš„è§„æ ¼ä¸»è¦æ˜¯8è‹±å¯¸æ™¶åœ†ï¼Œéƒ¨åˆ†å‚å•†å°¤å…¶IDMå¼€å§‹å‘12è‹±å¯¸å¹³å°è¿ç§»ã€‚</p><p><strong>ç›®å‰28nmå’Œ40nmå·¥è‰ºæ˜¯å¸‚åœºä¸»æµã€‚</strong></p><h2 id="å›½å†…å¤–å…¸å‹è½¦ä¼"><a href="#å›½å†…å¤–å…¸å‹è½¦ä¼" class="headerlink" title="å›½å†…å¤–å…¸å‹è½¦ä¼"></a>å›½å†…å¤–å…¸å‹è½¦ä¼</h2><p>ç›¸è¾ƒäºæ¶ˆè´¹å’Œå·¥ä¸šçº§MCUï¼Œè½¦è§„çº§MCUå¯¹è¿è¡Œç¯å¢ƒã€å¯é æ€§å’Œä¾›è´§å‘¨æœŸçš„è¦æ±‚è¾ƒé«˜ï¼Œæ­¤å¤–è½¦è§„çº§MCUè®¤è¯é—¨æ§›æ¯”è¾ƒé«˜ï¼Œè®¤è¯æ—¶é—´é•¿ã€è¿›å…¥éš¾åº¦å¤§ï¼Œæ‰€ä»¥æ•´ä½“çœ‹MCUå¸‚åœºæ ¼å±€è¾ƒä¸ºé›†ä¸­ï¼Œ2021å¹´ä¸–ç•Œå‰äº”åçš„MCUä¼ä¸šå æ¯”å°±è¾¾82%ä¹‹å¤šã€‚</p><table><thead><tr><th>åºå·</th><th>ä¼ä¸š</th><th>å›½åˆ«</th><th>2021å¹´é”€å”®é¢ï¼ˆäº¿ç¾å…ƒï¼‰</th><th>2021å¹´å¸‚åœºä»½é¢</th></tr></thead><tbody><tr><td>1</td><td>NXP</td><td>è·å…°</td><td>37.95</td><td>18.8%</td></tr><tr><td>2</td><td>å¾®èŠ¯</td><td>ç¾å›½</td><td>35.84</td><td>17.8%</td></tr><tr><td>3</td><td>ç‘è¨</td><td>æ—¥æœ¬</td><td>34.2</td><td>17%</td></tr><tr><td>4</td><td>ST</td><td>æ„å¤§åˆ©</td><td>33.74</td><td>16.7%</td></tr><tr><td>5</td><td>è‹±é£å‡Œ</td><td>å¾·å›½</td><td>23.78</td><td>11.8%</td></tr></tbody></table><p>ç›®å‰ï¼Œä¸­å›½è½¦è§„çº§MCUè¿˜å¤„åœ¨å¯¼å…¥æœŸï¼Œä¾›åº”é“¾æœ¬åœŸåŒ–ã€å›½äº§æ›¿ä»£åŒ–æ½œåŠ›å·¨å¤§ã€‚</p><table><thead><tr><th>åºå·</th><th>ä¼ä¸š</th><th>èŠ¯ç‰‡</th><th>é‡äº§é¦–æ¬¾é€šè¿‡æ—¶é—´</th></tr></thead><tbody><tr><td>1</td><td>æ¯”äºšè¿ªåŠå¯¼ä½“</td><td>è½¦è§„çº§è§¦æ§MCUã€è½¦è§„çº§é€šç”¨MCUåŠç”µæ± ç®¡ç†MCU</td><td>2018å¹´</td></tr><tr><td>2</td><td>æ°å‘ç§‘æŠ€ï¼ˆå››ç»´å›¾æ–°å­å…¬å¸ï¼‰</td><td>ABSã€BMSç­‰æ ¸å¿ƒåŠŸèƒ½ã€è½¦èº«æ§åˆ¶</td><td>2018å¹´</td></tr><tr><td>3</td><td>èŠ¯æµ·ç§‘æŠ€</td><td>è½¦èº«ç”µå­ã€æ™ºèƒ½åº§èˆ±</td><td>2020å¹´</td></tr><tr><td>4</td><td>èˆªé¡ºèŠ¯ç‰‡</td><td>æ±½è½¦å‰è£…</td><td>2019å¹´</td></tr><tr><td>5</td><td>èŠ¯æ—ºå¾®ç”µå­</td><td>æ±½è½¦ç…§æ˜ã€è½¦çª—æ§åˆ¶ã€ç©ºè°ƒé¢æ¿</td><td>2019å¹´</td></tr><tr><td>6</td><td>å›½èŠ¯ç§‘æŠ€</td><td>è½¦è½½T-BOXå®‰å…¨å•å…ƒã€è½¦è½½è¯Šæ–­ç³»ç»Ÿå®‰å…¨å•å…ƒã€C-V2Xé€šä¿¡å®‰å…¨åº”ç”¨</td><td>2019å¹´</td></tr><tr><td>7</td><td>èŠ¯é©°ç§‘æŠ€</td><td>æ±½è½¦æ˜¾ç¤ºç±»åº”ç”¨</td><td>2019å¹´</td></tr><tr><td>8</td><td>èµ›è…¾å¾®ç”µå­</td><td>å°¾ç¯æµæ°´ç¯ã€è½¦è½½æ— çº¿å……ç”µã€è½¦çª—æ§åˆ¶</td><td>2019å¹´</td></tr></tbody></table><h2 id="SOCä¸MCUçš„åŒºåˆ«"><a href="#SOCä¸MCUçš„åŒºåˆ«" class="headerlink" title="SOCä¸MCUçš„åŒºåˆ«"></a>SOCä¸MCUçš„åŒºåˆ«</h2><ul><li><p>MCU</p></li><li><ul><li><p>&#x3D;Micro Control Unit&#x3D;&#x3D;Micro Controller&#x3D;Microcontroller&#x3D;Microcontroller Unit</p></li><li><p>ç‰¹ç‚¹</p></li><li><ul><li><p>å¤æ‚åº¦</p></li><li><ul><li>æ¯”CPUé«˜ï¼Œæ¯”SoCä½</li></ul></li><li><p>è¿è¡Œç³»ç»Ÿ</p></li><li><ul><li>ç®€å•ç³»ç»Ÿ</li><li>ä¸€èˆ¬ä¸æ”¯æŒè¿è¡Œå¤šä»»åŠ¡çš„å¤æ‚ç³»ç»Ÿï¼ˆæ¯”å¦‚(åµŒå…¥å¼)Linuxï¼‰</li></ul></li></ul></li></ul></li><li><p>SoC</p></li><li><ul><li><p>&#x3D;System On Chip&#x3D;System On a Chip&#x3D;ç³»ç»Ÿçº§èŠ¯ç‰‡&#x3D;ç‰‡ä¸Šç³»ç»Ÿ</p></li><li><p>æ€»ç»“</p></li><li><ul><li><p>å¤æ‚åº¦</p></li><li><ul><li>æ¯”CPUé«˜ï¼Œæ¯”MCUé«˜</li></ul></li><li><p>è¿è¡Œç³»ç»Ÿ</p></li><li><ul><li>èƒ½æ”¯æŒè¿è¡Œå¤šä»»åŠ¡çš„å¤æ‚ç³»ç»Ÿï¼ˆæ¯”å¦‚(åµŒå…¥å¼)Linuxï¼‰</li></ul></li><li><p>æ€»ä½“å¤æ‚åº¦&#x3D;é›†æˆåŠŸèƒ½çš„ä¸°å¯Œç¨‹åº¦</p></li><li><ul><li>CPU &lt; MCU &lt; SoC</li></ul></li><li><p>èŠ¯ç‰‡å¹³å‡ä»·æ ¼</p></li><li><ul><li>CPU &lt; MCU &lt; SoC</li></ul></li></ul></li></ul></li></ul><blockquote><p>SOCæ˜¯å¤šäº†ä¸ªç®€å•çš„æ“ä½œç³»ç»Ÿå—?</p></blockquote><p>å¦‚æœä»…ä»…æ˜¯ä» MCUå’ŒSoCæ‰€èƒ½æ”¯æŒçš„æ“ä½œç³»ç»Ÿçš„è§’åº¦æ¥è¯´ï¼ŒåŸºæœ¬ä¸Šè¯´ï¼šæ˜¯çš„ã€‚</p><ul><li><p>MCUï¼šè¿è¡Œçš„å¾€å¾€æ˜¯è£¸ç³»ç»Ÿ</p></li><li><ul><li><p>ä»£ç ç›´æ¥æ“ä½œç‰©ç†å­˜å‚¨ç©ºé—´</p></li><li><ul><li>æ§åˆ¶å¤–éƒ¨è®¾å¤‡</li></ul></li></ul></li><li><p>SoC</p></li><li><ul><li><p>ç³»ç»Ÿå¤æ‚åº¦ä¸€èˆ¬æ¯”è¾ƒé«˜</p></li><li><p>è¿è¡Œçš„å…¸å‹å¦‚åµŒå…¥å¼Linuxç³»ç»Ÿ</p></li><li><ul><li>åŒ…æ‹¬è¡ç”Ÿå‡ºçš„Androidç³»ç»Ÿç­‰</li></ul></li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>è½¦æœºæ‰«ç›²</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç»„æˆåŸç†(ä¸€)è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º</title>
    <link href="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/"/>
    <url>/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç»„æˆåŸç†-ä¸€-è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º"><a href="#è®¡ç®—æœºç»„æˆåŸç†-ä¸€-è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†(ä¸€)è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º"></a>è®¡ç®—æœºç»„æˆåŸç†(ä¸€)è®¡ç®—æœºç³»ç»Ÿæ¦‚è®º</h1><h2 id="1-è®¡ç®—æœºç³»ç»Ÿç®€ä»‹"><a href="#1-è®¡ç®—æœºç³»ç»Ÿç®€ä»‹" class="headerlink" title="1.è®¡ç®—æœºç³»ç»Ÿç®€ä»‹"></a>1.è®¡ç®—æœºç³»ç»Ÿç®€ä»‹</h2><h2 id="2-è®¡ç®—æœºçš„åŸºæœ¬ç»„æˆ"><a href="#2-è®¡ç®—æœºçš„åŸºæœ¬ç»„æˆ" class="headerlink" title="2.è®¡ç®—æœºçš„åŸºæœ¬ç»„æˆ"></a>2.è®¡ç®—æœºçš„åŸºæœ¬ç»„æˆ</h2><h3 id="2-0-å†¯è¯ºä¾æ›¼è®¡ç®—æœºå†å²"><a href="#2-0-å†¯è¯ºä¾æ›¼è®¡ç®—æœºå†å²" class="headerlink" title="2.0 å†¯è¯ºä¾æ›¼è®¡ç®—æœºå†å²"></a>2.0 å†¯è¯ºä¾æ›¼è®¡ç®—æœºå†å²</h3><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/a825a9ed08e2a58a5d9d462c5d8de1a4.png" alt="img" style="zoom:80%;"><p>å†¯è¯ºä¾æ›¼è®¡ç®—æœºç®€ç§°ä¸ºEDVAC(Electronic Discrete Variable Automatic Computer)ä¹Ÿå«æ™®æ—æ–¯é¡¿ä½“ç³»ç»“æ„ï¼ˆPrincetionarchitectureï¼‰ï¼Œå› ä¸ºå†¯è¯ºä¾æ›¼æ˜¯æ™®æ—æ–¯é¡¿å¤§å­¦æ•™æˆã€‚</p><p>EDVACæ˜¯ä¸–ç•Œä¸Šç¬¬ä¸€å°å­˜å‚¨ç¨‹åºè®¡ç®—æœº(ä¹Ÿæœ‰è¯´æ³•æ˜¯ç”µå­æ•°å­—å¼è®¡ç®—æœº)ï¼Œæˆä¸ºæ‰€æœ‰ç°ä»£è®¡ç®—æœºçš„åŸå‹å’ŒèŒƒæœ¬ï¼Œå®ƒè¢«å»ºé€ äº 1940å¹´.ã€‚å®ƒæ˜¯æœ€æ—©çš„å¤§å‹äºŒè¿›åˆ¶ç³»ç»Ÿä¸­å¤®å¤„ç†å™¨è®¡ç®—æœºï¼Œè€Œä¸æ˜¯åè¿›åˆ¶ç³»ç»Ÿã€‚å»ºé€ äº19ä¸–çºª40å¹´ä»£,EDVAC è®¾è®¡äº1944å¹´,åœ¨è¿™ä¹‹å‰å®ƒè¢«å®‰è£…åœ¨ç¾å›½å†›é˜Ÿçš„å¼¹é“å­¦ç ”ç©¶å®éªŒå®¤ï¼Œè¯¥å®éªŒå®¤å»ºé€ äº1940å¹´ï¼˜æœˆï¼Œä½äºé©¬é‡Œå…°å·ã€‚</p><p>ä½œä¸ºä¸€ä¸ªäºŒè¿›åˆ¶åºåˆ—çš„è®¡ç®—æœºï¼ŒEDVACç”¨äºåŠ å·¥æ•°å­¦çš„è®¡ç®—ï¼Œè¿ç»­çš„å¤§è‡´å†…å­˜å®¹é‡æ˜¯5.5kbï¼ŒEDVACè¢«ç”¨äºä½œä¸ºæ•°æ®çš„åª’ä»‹å­˜è´®ç£å¸¦ï¼Œæ¯å¤©è¿è¡Œæ—¶é—´è¶…è¿‡ï¼’&#x3D;ï¼ä¸ªå°æ—¶ï¼ŒEDVAC äº1960å¹´è¢«BRLESCï¼ˆBallistic Research Laboratories Electronic Scientific Computerï¼‰æ›¿æ¢æˆæ›´å¤§çš„å†…å­˜å’Œæ›´å¿«çš„å“åº”æ—¶é—´ã€‚</p><p>å†¯Â·è¯ºä¾æ›¼ä½“åˆ¶çš„ä¸»è¦æ€æƒ³åŒ…æ‹¬ï¼š<br> ï¼ˆ1ï¼‰é‡‡ç”¨äºŒè¿›åˆ¶ä»£ç å½¢å¼è¡¨ç¤ºä¿¡æ¯ï¼ˆæ•°æ®ã€æŒ‡ä»¤ï¼‰ï¼›<br> ï¼ˆ2ï¼‰é‡‡ç”¨å­˜å‚¨ç¨‹åºå·¥ä½œæ–¹å¼ï¼ˆå†¯Â·è¯ºä¾æ›¼æ€æƒ³æœ€æ ¸å¿ƒçš„æ¦‚å¿µï¼‰ï¼›<br> ï¼ˆ3ï¼‰è®¡ç®—æœºç¡¬ä»¶ç³»ç»Ÿç”±äº”å¤§éƒ¨ä»¶ï¼ˆè¿ç®—å™¨ã€æ§åˆ¶å™¨ã€å­˜å‚¨å™¨ã€è¾“å…¥è®¾å¤‡å’Œè¾“å‡ºè®¾å¤‡ï¼‰ç»„æˆã€‚</p><blockquote><p>ğŸª¶æŒ‰ç…§å†¯è¯ºä¾æ›¼ä½“è´¨çš„æ€æƒ³ï¼Œè¿ç®—å™¨æ˜¯å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„æ ¸å¿ƒï¼Œè®¡ç®—å™¨å°±æ˜¯ç”¨æ¥è¿›è¡Œå¤æ‚çš„è®¡ç®—ï¼Œè‡³äºè¿è¡Œå“ªä¸€ç§è®¡ç®—æ˜¯åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ç­‰ç­‰å–å†³äºæ§åˆ¶å™¨ï¼Œå‘Šè¯‰æ§åˆ¶å™¨è¦æ‰§è¡Œä»€ä¹ˆæŒ‡ä»¤ç”±å®ƒå»è¿›è¡Œæ§åˆ¶ã€‚é‚£ä¹ˆè¿ç®—çš„ä¸­é—´ç»“æœï¼Œè¿ç®—çš„åˆå§‹å€¼ï¼Œè¿ç®—çš„æœ€ç»ˆç»“æœéœ€è¦æœ‰ä¸€ä¸ªå®¹å™¨è¿›è¡Œç››æ”¾å°±æ˜¯å­˜å‚¨å™¨ã€‚</p></blockquote><h3 id="2-1-å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„ç‰¹ç‚¹"><a href="#2-1-å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„ç‰¹ç‚¹" class="headerlink" title="2.1 å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„ç‰¹ç‚¹"></a>2.1 å†¯è¯ºä¾æ›¼è®¡ç®—æœºçš„ç‰¹ç‚¹</h3><ol><li>è®¡ç®—æœºç”±äº”å¤§éƒ¨ä»¶ç»„æˆï¼ˆå­˜å‚¨å™¨ã€è¿ç®—å™¨ã€æ§åˆ¶å™¨ã€è¾“å…¥è®¾å¤‡ã€è¾“å‡ºè®¾å¤‡ï¼‰</li><li>æŒ‡ä»¤å’Œæ•°æ®ä»¥åŒç­‰åœ°ä½å­˜äºå­˜å‚¨å™¨ï¼Œå¯æŒ‰åœ°å€å¯»å€</li><li>æŒ‡ä»¤å’Œæ•°æ®ç”¨äºŒè¿›åˆ¶è¡¨ç¤º</li><li>æŒ‡ä»¤ç”±æ“ä½œç å’Œåœ°å€ç ç»„æˆ</li><li>å­˜å‚¨ç¨‹åº</li><li>ä»¥è¿ç®—å™¨ä¸ºæ ¸å¿ƒ</li></ol><h3 id="2-2-ç°ä»£è®¡ç®—æœºç¡¬ä»¶æ¡†å›¾"><a href="#2-2-ç°ä»£è®¡ç®—æœºç¡¬ä»¶æ¡†å›¾" class="headerlink" title="2.2 ç°ä»£è®¡ç®—æœºç¡¬ä»¶æ¡†å›¾"></a>2.2 ç°ä»£è®¡ç®—æœºç¡¬ä»¶æ¡†å›¾</h3><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501225515506.png" alt="image-20230501225515506" style="zoom: 80%;"><blockquote><p>å†…å­˜ä¹Ÿè¢«ç§°ä¸ºä¸»å­˜ï¼Œè€Œè¾…å­˜æŒ‡çš„æ˜¯è®¡ç®—æœºçš„å¤–éƒ¨å­˜å‚¨ã€ä¾‹å¦‚ï¼Œç¡¬ç›˜ã€Uç›˜ã€è½¯ç›˜ä»¥åŠå…‰ç›˜ç­‰ç­‰</p></blockquote><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501224841832.png" alt="image-20230501224841832" style="zoom:80%;"><p>å¯¹äºåƒå†¯è¯ºä¾æ›¼ä½“ç³»è¿™ç§å¤æ‚çš„ç³»ç»Ÿï¼Œéœ€è¦æœ‰ä¸€ä¸ªç³»ç»Ÿå¤æ‚æ€§ç®¡ç†çš„æ–¹æ³•ï¼ˆ3â€™Yï¼‰</p><ul><li>å±‚æ¬¡åŒ–ï¼ˆHierachyï¼‰ï¼šå°†è¢«è®¾è®¡çš„ç³»ç»Ÿåˆ’åˆ†ä¸ºå¤šä¸ªæ¨¡å—æˆ–å­æ¨¡å—</li><li>ç³»ç»ŸåŒ–ï¼ˆModularityï¼‰ï¼šæœ‰æ˜ç¡®å®šä¹‰çš„åŠŸèƒ½å’Œæ¥å£</li><li>è§„åˆ™æ€§ï¼ˆregularityï¼‰ï¼šæ¨¡å—æ›´å®¹æ˜“è¢«é‡ç”¨</li></ul><blockquote><p>è¿™è¾¹çš„æ€æƒ³è¿œè¿œä¸æ­¢ç”¨äºè®¾è®¡å†¯è¯ºä¾æ›¼ä½“ç³»ï¼Œå¯¹äºæ—¥å¸¸å·¥ä½œä¸­å„ç§æ¡†æ¶çš„ç†è§£å’Œè®¾è®¡æ„ä¹‰ä¹Ÿæ˜¯éå‡¡çš„ã€‚</p></blockquote><h3 id="2-3-è®¡ç®—æœºçš„å·¥ä½œæ­¥éª¤"><a href="#2-3-è®¡ç®—æœºçš„å·¥ä½œæ­¥éª¤" class="headerlink" title="2.3 è®¡ç®—æœºçš„å·¥ä½œæ­¥éª¤"></a>2.3 è®¡ç®—æœºçš„å·¥ä½œæ­¥éª¤</h3><h4 id="2-3-1-ç¼–ç¨‹ä¸¾ä¾‹"><a href="#2-3-1-ç¼–ç¨‹ä¸¾ä¾‹" class="headerlink" title="2.3.1 ç¼–ç¨‹ä¸¾ä¾‹"></a>2.3.1 ç¼–ç¨‹ä¸¾ä¾‹</h4><p>è®¡ç®—ï¼šax^2 + bx + c çš„å€¼</p><p><strong>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼šç›´æ¥è®¡ç®—</strong></p><blockquote><p>å– x åˆ°è¿ç®—å™¨ä¸­</p><p>ä¹˜ä»¥ x åœ¨è¿ç®—å™¨ä¸­</p><p>ä¹˜ä»¥ a åœ¨è¿ç®—å™¨ä¸­</p><p>å­˜ ax^2 åˆ°å­˜å‚¨å™¨ä¸­</p><p>å– b åˆ°è¿ç®—å™¨ä¸­</p><p>ä¹˜ä»¥ x åœ¨è¿ç®—å™¨ä¸­</p><p>åŠ  ax^2 åœ¨è¿ç®—å™¨ä¸­</p><p>åŠ  c åœ¨è¿ç®—å™¨ä¸­</p></blockquote><p><strong>ç¬¬äºŒç§æ–¹æ¡ˆï¼šå˜å½¢åè®¡ç®—</strong>   <strong>(ax+b)x+c</strong></p><blockquote><p>å– x åˆ°è¿ç®—å™¨ä¸­</p><p>ä¹˜ä»¥ a åœ¨è¿ç®—å™¨ä¸­</p><p>åŠ  b åœ¨è¿ç®—å™¨ä¸­</p><p>ä¹˜ä»¥ x åœ¨è¿ç®—å™¨ä¸­</p><p>åŠ  c åœ¨è¿ç®—å™¨ä¸­</p></blockquote><p>å¯¹äºåŒä¸€å°è®¡ç®—æœºè€Œè¨€ï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆéœ€è¦8æ¡æŒ‡ä»¤ï¼Œç¬¬äºŒç§æ–¹æ¡ˆåªéœ€è¦5æ¡æŒ‡ä»¤ï¼Œæ˜¾ç„¶ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯æ›´å¿«çš„ï¼Œå¯¹äºå­˜å‚¨ç©ºé—´çš„è¦æ±‚ä¹Ÿæ˜¯æ›´å°‘çš„ã€‚</p><h4 id="2-3-2-æŒ‡ä»¤æ ¼å¼"><a href="#2-3-2-æŒ‡ä»¤æ ¼å¼" class="headerlink" title="2.3.2 æŒ‡ä»¤æ ¼å¼"></a>2.3.2 æŒ‡ä»¤æ ¼å¼</h4><p>ä»¥å–æ•°æŒ‡ä»¤ä¸ºä¾‹ï¼š</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501232421591.png" alt="image-20230501232421591" style="zoom:80%;"><p>å…¶ä»–çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>è¡¨ç¤º</th></tr></thead><tbody><tr><td>å–æ•° Î±</td><td>[Î±] -&gt; ACC</td></tr><tr><td>å­˜æ•° Î²</td><td>[ACC] -&gt; Î²</td></tr><tr><td>åŠ  Î³</td><td>[ACC] + [Î³] -&gt; ACC</td></tr><tr><td>ä¹˜ Î´</td><td>[ACC] Ã— [Î´] -&gt; ACC</td></tr><tr><td>æ‰“å° Ïƒ</td><td>[Ïƒ] -&gt; æ‰“å°æœº</td></tr></tbody></table><p>é‚£ä¹ˆæˆ‘ä»¬è®¡ç®—ax^2 + bx  + c çš„ç¨‹åºæ¸…å•ä¸ºï¼š</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501232836557.png" alt="image-20230501232836557" style="zoom:80%;"><h4 id="2-3-3-å­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆ"><a href="#2-3-3-å­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆ" class="headerlink" title="2.3.3 å­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆ"></a>2.3.3 å­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆ</h4><p>ä¸»å­˜å‚¨å™¨ç”± <u>å­˜å‚¨ä½“ã€MARã€MDR</u> ç»„æˆï¼š</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501232931011.png" alt="image-20230501232931011" style="zoom:80%;"><p><strong>å­˜å‚¨ä½“</strong>çš„ç»„æˆä¸ç”Ÿæ´»ä¾‹å­å¯¹åº”å¦‚ä¸‹ï¼š</p><p>å­˜å‚¨ä½“ â€” å­˜å‚¨å•å…ƒ â€” å­˜å‚¨å…ƒä»¶</p><p> å¤§æ¥¼   â€”  æˆ¿é—´        â€” åºŠä½</p><ul><li>å­˜å‚¨å•å…ƒï¼šå­˜æ”¾ä¸€ä¸²äºŒè¿›åˆ¶ä»£ç </li><li>å­˜å‚¨å­—ï¼šå­˜å‚¨å•å…ƒä¸­äºŒè¿›åˆ¶ä»£ç çš„ç»„åˆ</li><li>å­˜å‚¨å­—é•¿ï¼šå­˜å‚¨å•å…ƒä¸­äºŒè¿›åˆ¶ä»£ç çš„ä½æ•°ï¼Œæ¯ä¸ªå­˜å‚¨å•å…ƒèµ‹äºˆä¸€ä¸ªåœ°å€å·</li></ul><p><strong>MARï¼š</strong>å…¨ç§° memory data registerï¼Œä¸»å­˜æ•°æ®å¯„å­˜å™¨ï¼ŒMDRç”¨æ¥ä¿å­˜è¦è¢«å†™å…¥åœ°å€å•å…ƒæˆ–è€…ä»åœ°å€å•å…ƒè¯»å…¥çš„æ•°æ®ã€‚</p><p><strong>MDRï¼š</strong>å…¨ç§°memory address registerï¼Œä¸»å­˜åœ°å€å¯„å­˜å™¨ï¼ŒMARç”¨æ¥ä¿å­˜æ•°æ®è¢«ä¼ è¾“åˆ°çš„ä½ç½®çš„åœ°å€æˆ–è€…æ•°æ®æ¥æºä½ç½®çš„åœ°å€ã€‚</p><h4 id="2-3-4-è¿ç®—å™¨çš„åŸºæœ¬ç»„æˆåŠæ“ä½œè¿‡ç¨‹"><a href="#2-3-4-è¿ç®—å™¨çš„åŸºæœ¬ç»„æˆåŠæ“ä½œè¿‡ç¨‹" class="headerlink" title="2.3.4 è¿ç®—å™¨çš„åŸºæœ¬ç»„æˆåŠæ“ä½œè¿‡ç¨‹"></a>2.3.4 è¿ç®—å™¨çš„åŸºæœ¬ç»„æˆåŠæ“ä½œè¿‡ç¨‹</h4><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235216541.png" alt="image-20230501235216541" style="zoom:80%;"><p>â‘ åŠ æ³•æ“ä½œè¿‡ç¨‹</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235302879.png" alt="image-20230501235302879" style="zoom: 67%;"><p>â‘¡å‡æ³•æ“ä½œè¿‡ç¨‹</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235446223.png" alt="image-20230501235446223" style="zoom:67%;"><p>â‘¢ä¹˜æ³•æ“ä½œè¿‡ç¨‹</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235504985.png" alt="image-20230501235504985" style="zoom: 67%;"><blockquote><p>é«˜ä½å­˜æ”¾äºACCå¯„å­˜å™¨ï¼Œä½ä½å­˜æ”¾äºMQå¯„å­˜å™¨</p></blockquote><p>â‘£é™¤æ³•æ“ä½œè¿‡ç¨‹</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235547197.png" alt="image-20230501235547197" style="zoom: 67%;"><h4 id="2-3-5-æ§åˆ¶å™¨çš„åŸºæœ¬ç»„æˆ"><a href="#2-3-5-æ§åˆ¶å™¨çš„åŸºæœ¬ç»„æˆ" class="headerlink" title="2.3.5 æ§åˆ¶å™¨çš„åŸºæœ¬ç»„æˆ"></a>2.3.5 æ§åˆ¶å™¨çš„åŸºæœ¬ç»„æˆ</h4><p>æ§åˆ¶å™¨CUä¸»è¦ç”±IRå¯„å­˜å™¨ã€PCå¯„å­˜å™¨ç»„æˆï¼›å®Œæˆä¸€æ¡æŒ‡ä»¤éœ€è¦æœ‰ä¸‰æ­¥ï¼šPCå–æŒ‡ä»¤ã€IRåˆ†ææŒ‡ä»¤ã€CUæ§åˆ¶å•å…ƒæ‰§è¡ŒæŒ‡ä»¤ã€‚</p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230501235624624.png" alt="image-20230501235624624" style="zoom: 67%;"><h4 id="2-3-6-ä¸»æœºå®Œæˆä¸€æ¡æŒ‡ä»¤çš„è¿‡ç¨‹"><a href="#2-3-6-ä¸»æœºå®Œæˆä¸€æ¡æŒ‡ä»¤çš„è¿‡ç¨‹" class="headerlink" title="2.3.6 ä¸»æœºå®Œæˆä¸€æ¡æŒ‡ä»¤çš„è¿‡ç¨‹"></a>2.3.6 ä¸»æœºå®Œæˆä¸€æ¡æŒ‡ä»¤çš„è¿‡ç¨‹</h4><p><strong>ï¼ˆ1ï¼‰ä»¥å–æŒ‡ä»¤ä¸ºä¾‹</strong></p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230503150830396.png" alt="image-20230503150830396" style="zoom: 67%;"><ul><li><p>å…ˆè¦åšçš„æ˜¯æ‹¿åˆ°å–æ•°æŒ‡ä»¤ï¼ŒPCä¸­å­˜å‚¨äº†ä¸‹ä¸€æ¡è¦æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€</p><ul><li><p>PCå°†æŒ‡ä»¤çš„åœ°å€é€ç»™MAR</p></li><li><p>MARå†é€ç»™å­˜å‚¨ä½“</p></li><li><p>å­˜å‚¨ä½“å°†å…·ä½“çš„æŒ‡ä»¤é€åˆ°MDRä¸­</p></li><li><p>å°†å–å‡ºæ¥çš„æŒ‡ä»¤é€åˆ°IRè¿›è¡Œåˆ†æ</p></li><li><p>å°†æŒ‡ä»¤çš„æ“ä½œç éƒ¨åˆ†äº¤ç»™CUæ§åˆ¶å•å…ƒ</p></li></ul></li><li><p>ç„¶åæ‹¿åˆ°å…·ä½“çš„æ•°å€¼ï¼Œæ‰€ä»¥ä¼ é€’å…·ä½“æ•°å€¼çš„åœ°å€</p><ul><li>å› ä¸ºIRåˆ†ææŒ‡ä»¤åï¼Œé‡Œé¢æœ‰æ“ä½œç å’Œåœ°å€ç ï¼Œæ“ä½œç è¡¨æ˜äº†æ˜¯å–æ•°æŒ‡ä»¤ï¼Œå·²ç»å‘Šè¯‰äº†CUã€‚ç°åœ¨è¦æŠŠå…·ä½“æ•°å€¼çš„å–å‡ºæ¥ã€‚IRå§æ•°å€¼çš„åœ°å€ä¼ é€’åˆ°MAR</li><li>MARå†ä¼ ç»™å­˜å‚¨ä½“</li><li>å­˜å‚¨ä½“å°†å…·ä½“çš„æ•°å€¼å–å‡ºæ¥æ”¾åˆ°MDRä¸­</li><li>MDRå°†æ•°å€¼ä¼ åˆ°ACCå¯„å­˜å™¨ä¸­</li></ul></li></ul><p><strong>ï¼ˆ2ï¼‰ä»¥å­˜æ•°æŒ‡ä»¤ä¸ºä¾‹</strong></p><img src="/2023/05/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E4%B8%80-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/image-20230503151910628.png" alt="image-20230503151910628" style="zoom:67%;"><ul><li>PCä¸­å­˜å‚¨äº†ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€<ul><li>PCå°†æŒ‡ä»¤çš„åœ°å€ä¼ ç»™MAR</li><li>MARå°†åœ°å€ä¼ ç»™å­˜å‚¨ä½“M</li><li>å­˜å‚¨ä½“Må°†å…·ä½“çš„æŒ‡ä»¤ä¼ ç»™MDR</li><li>MDRå°†å…·ä½“çš„æŒ‡ä»¤ä¼ ç»™IRè¿›è¡Œåˆ†æ</li><li>å°†æŒ‡ä»¤çš„æ“ä½œç éƒ¨åˆ†äº¤ç»™CUæ§åˆ¶å•å…ƒ</li></ul></li><li>ç„¶åå°±è¦å­˜å…·ä½“çš„æ•°å€¼äº†<ul><li>IRå°†è¦å­˜çš„æ•°å€¼çš„å…·ä½“åœ°å€ä¼ ç»™MAR</li><li>MARä¼ ç»™å­˜å‚¨ä½“</li><li>ACCå¯„å­˜å™¨å°†å…·ä½“çš„æ•°å€¼ä¼ ç»™MDR</li><li>MDRå°†æ•°å€¼ä¼ ç»™å­˜å‚¨ä½“è¿›è¡Œä¿å­˜</li></ul></li></ul><p><strong>ï¼ˆ3ï¼‰ax^2+bx+cç¨‹åºçš„è¿è¡Œè¿‡ç¨‹</strong></p><ul><li>å°†ç¨‹åºé€šè¿‡è¾“å…¥è®¾å¤‡é€è‡³è®¡ç®—æœº</li><li>ç¨‹åºé¦–åœ°å€ -&gt; PC</li><li>å¯åŠ¨ç¨‹åºè¿è¡Œ</li><li>å–æŒ‡ä»¤ PC -&gt; MAR -&gt; M -&gt; MDR -&gt; IRï¼Œ (PC)+1-&gt;PC</li><li>åˆ†ææŒ‡ä»¤  OP(IR) -&gt; CU</li><li>æ‰§è¡ŒæŒ‡ä»¤  Ad(IR) -&gt; MAR -&gt; M -&gt; MDR -&gt; ACC</li><li>â€¦</li><li>â€¦</li><li>æ‰“å°ç»“æœ</li><li>åœæœº</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>DeviceMapperé©±åŠ¨</title>
    <link href="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/"/>
    <url>/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="DeviceMapperé©±åŠ¨"><a href="#DeviceMapperé©±åŠ¨" class="headerlink" title="DeviceMapperé©±åŠ¨"></a>DeviceMapperé©±åŠ¨</h1><h2 id="1-é©±åŠ¨çš„ioctlæ¥å£"><a href="#1-é©±åŠ¨çš„ioctlæ¥å£" class="headerlink" title="1.é©±åŠ¨çš„ioctlæ¥å£"></a>1.é©±åŠ¨çš„ioctlæ¥å£</h2><h3 id="1-0-ioctlå‘½ä»¤è¡Œæ‰«ç›²"><a href="#1-0-ioctlå‘½ä»¤è¡Œæ‰«ç›²" class="headerlink" title="1.0 ioctlå‘½ä»¤è¡Œæ‰«ç›²"></a>1.0 ioctlå‘½ä»¤è¡Œæ‰«ç›²</h3><p>åœ¨è¿›è¡Œioctlæ—¶ï¼Œæˆ‘ä»¬ä¼šä¼ é€’cmdï¼Œè¯¥cmdç”±32ä½ç»„æˆï¼š</p><blockquote><p>ç¬¬ä¸€ä¸ªåˆ†åŒºï¼š0-7ï¼Œå‘½ä»¤çš„ç¼–å·ï¼ŒèŒƒå›´æ˜¯0-255<br>ç¬¬äºŒä¸ªåˆ†åŒºï¼š8-15ï¼Œå‘½ä»¤çš„å¹»æ•°<br>ç¬¬ä¸‰ä¸ªåˆ†åŒºï¼š16-29ï¼Œè¡¨ç¤ºä¼ é€’çš„æ•°æ®çš„å¤§å°<br>ç¬¬å››åˆ†åŒºï¼š30-31ï¼Œä»£è¡¨è¯»å†™çš„æ–¹å‘</p><p>ç¬¬ä¸€å’Œç¬¬äºŒåˆ†åŒºï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†å‘½ä»¤ï¼Œä¸èƒ½æœ‰ä¸¤ä¸ªå®Œå…¨ä¸€æ ·çš„â€œä¸€+äºŒâ€<br>ç¬¬å››åˆ†åŒºï¼š00ï¼šæ²¡æœ‰æ•°æ®ä¼ é€’ï¼›10ï¼šç”¨æˆ·ä»é©±åŠ¨è¯»æ•°æ®ï¼›01ï¼šç”¨æˆ·å‘é©±åŠ¨å†™æ•°æ®ï¼›11ï¼šå…ˆå†™æ•°æ®åˆ°é©±åŠ¨å†æŠŠæ•°æ®è¯»å‡ºæ¥</p></blockquote><p>å¦‚æœè‡ªå·±å»ç»„åˆè¿™ä¸ªcmdæ¯”è¾ƒè´¹äº‹ä¸”å®¹æ˜“æé”™ï¼Œæ‰€ä»¥Linuxæä¾›äº†ç›¸åº”çš„å®ç»™æˆ‘ä»¬å»ç»„åˆcmdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">_IO(type,nr)   æ²¡æœ‰æ•°æ®ä¼ é€’çš„å‘½ä»¤<br>_IOR(type, nr, size)  ä»é©±åŠ¨ä¸­è¯»å–æ•°æ®çš„å‘½ä»¤<br>_IOW(type, nr, size)  å‘é©±åŠ¨ä¸­å†™å…¥æ•°æ®çš„å‘½ä»¤<br>_IOWR(type, nr, size) äº¤æ¢æ•°æ®çš„å‘½ä»¤<br><br>// typeè¡¨ç¤ºæ•°æ®çš„å¹»æ•°ï¼Œ8-15ä½<br>// nrå‘½ä»¤çš„ç¼–å·ï¼Œ0-7ä½<br>// sizeå‚æ•°ä¼ é€’çš„å¤§å°ï¼Œä¼ é€’çš„æ˜¯æ•°æ®ç±»å‹ï¼šå¦‚æœä¼ é€’4å­—èŠ‚ï¼Œå¯ä»¥å†™æˆint<br></code></pre></td></tr></table></figure><p>å†…æ ¸æ‹¿åˆ°è¿™äº›cmdï¼Œé¦–å…ˆè¦å¯¹ç»„åˆåçš„cmdè¿›è¡Œè§£æï¼Œæ‰çŸ¥é“å¯¹åº”çš„åŠ¨ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">_IOC_DIR(nr)   è·å¾—æ–¹å‘<br>_IOC_TYPE(nr)  è·å¾—å¹»æ•°<br>_IOC_NR(nr)    è·å¾—ç¼–å·<br>_IOC_SIZE(nr)  è·å¾—å¤§å°<br></code></pre></td></tr></table></figure><h3 id="1-1-å†…æ ¸ç©ºé—´ioctlç©ºé—´å®šä¹‰"><a href="#1-1-å†…æ ¸ç©ºé—´ioctlç©ºé—´å®šä¹‰" class="headerlink" title="1.1 å†…æ ¸ç©ºé—´ioctlç©ºé—´å®šä¹‰"></a>1.1 å†…æ ¸ç©ºé—´ioctlç©ºé—´å®šä¹‰</h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé©±åŠ¨çš„è®¾å¤‡æ“ä½œé›†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> _<span class="hljs-title">ctl_fops</span> =</span> &#123;<br>.open = nonseekable_open,<br>.unlocked_ioctl = dm_ctl_ioctl,<br>.compat_ioctl = dm_compat_ctl_ioctl,<br>.owner = THIS_MODULE,<br>.llseek  = noop_llseek,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”¨æˆ·ç©ºé—´è°ƒç”¨ioctlæ¥å£ï¼Œä¼šè°ƒç”¨é©±åŠ¨çš„<code>unlocked_ioctl</code>ï¼Œå¯¹åº”çš„å‡½æ•°ä¸º<code>dm_ctl_ioctl</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">dm_ctl_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, uint command, ulong u)</span><br>&#123;<br><span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>)ctl_ioctl(command, (<span class="hljs-keyword">struct</span> dm_ioctl __user *)u);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ctl_ioctl</span><span class="hljs-params">(uint command, <span class="hljs-keyword">struct</span> dm_ioctl __user *user)</span><br>&#123;<br>    <span class="hljs-comment">// è·å¾—commandçš„NRç¼–å·</span><br>    cmd = _IOC_NR(command);<br>    <br>fn = lookup_ioctl(cmd, &amp;ioctl_flags);<br>    <span class="hljs-comment">// æ‰§è¡Œcmdå¯¹åº”çš„å¤„ç†å‡½æ•°</span><br>    <span class="hljs-keyword">if</span> (!fn) &#123;<br>DMWARN(<span class="hljs-string">&quot;dm_ctl_ioctl: unknown command 0x%x&quot;</span>, command);<br><span class="hljs-keyword">return</span> -ENOTTY;<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> ioctl_fn <span class="hljs-title function_">lookup_ioctl</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">int</span> *ioctl_flags)</span><br>&#123;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">int</span> cmd;<br><span class="hljs-type">int</span> flags;<br>ioctl_fn fn;<br>&#125; _ioctls[] = &#123;<br>        <span class="hljs-comment">// ...</span><br>&#123;DM_DEV_CREATE_CMD, IOCTL_FLAGS_NO_PARAMS, dev_create&#125;,<br>&#123;DM_DEV_REMOVE_CMD, IOCTL_FLAGS_NO_PARAMS, dev_remove&#125;,<br>&#123;DM_DEV_RENAME_CMD, <span class="hljs-number">0</span>, dev_rename&#125;,<br>&#123;DM_DEV_SUSPEND_CMD, IOCTL_FLAGS_NO_PARAMS, dev_suspend&#125;,<br>&#123;DM_DEV_STATUS_CMD, IOCTL_FLAGS_NO_PARAMS, dev_status&#125;,<br>&#123;DM_DEV_WAIT_CMD, <span class="hljs-number">0</span>, dev_wait&#125;,<br><span class="hljs-comment">// ...</span><br>&#125;;<br><br><span class="hljs-keyword">return</span> _ioctls[cmd].fn;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šéå†ioctlsé‡Œé¢å®šä¹‰çš„å‘½ä»¤è¡Œï¼Œä¸€ä¸ªä¸ªè¿›è¡ŒæŸ¥æ‰¾å¯¹æ¯”ï¼ŒåŒ¹é…åˆ°ä¹‹åå°†å¯¹åº”çš„å¤„ç†å‡½æ•°è¿”å›ã€‚ä¾‹å¦‚åŒ¹é…åˆ° <strong>DM_DEV_CREATE_CMD</strong> åï¼Œå°†<strong>dev_create</strong>è¿”å›ï¼Œç„¶ååœ¨ <strong>ctl_ioctl</strong> æ‰§è¡Œ <strong>fn</strong> ä¹Ÿå°±æ˜¯ <strong>dev_create</strong>ã€‚</p><h3 id="1-2-ç”¨æˆ·ç©ºé—´è°ƒç”¨ioctl"><a href="#1-2-ç”¨æˆ·ç©ºé—´è°ƒç”¨ioctl" class="headerlink" title="1.2 ç”¨æˆ·ç©ºé—´è°ƒç”¨ioctl"></a>1.2 ç”¨æˆ·ç©ºé—´è°ƒç”¨ioctl</h3><p>è¿™æ˜¯ç”¨æˆ·ç©ºé—´ï¼ˆinitè¿›ç¨‹ï¼‰å‘å†…æ ¸å‘é€çš„åˆ›å»ºè®¾å¤‡çš„ioctlï¼Œå…¶ä¸­cmdä¸ºDM_DEV_CREATE</p><img src="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/image-20230425220018537.png" alt="image-20230425220018537" style="zoom:50%;"><p>æˆ‘ä»¬ç ”ç©¶ä¸€ä¸ªè¿™ä¸ªDM_DEV_CREATEçš„ç»„æˆï¼š</p><img src="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/image-20230425222337318.png" alt="image-20230425222337318" style="zoom: 67%;"><p>è¯¥cmdå‘Šè¯‰å†…æ ¸æˆ‘ä»¬æ˜¯åŒå‘äº¤äº’æ•°æ®çš„ï¼Œä¸”NRå·ä¸º3ï¼Œä¼ è¾“æ•°æ®çš„å¤§å°ä¸ºstruct dm_ioctlçš„å¤§å°ã€‚</p><h2 id="2-DeviceMapperä¸­çš„æ•°æ®ç»“æ„"><a href="#2-DeviceMapperä¸­çš„æ•°æ®ç»“æ„" class="headerlink" title="2.DeviceMapperä¸­çš„æ•°æ®ç»“æ„"></a>2.DeviceMapperä¸­çš„æ•°æ®ç»“æ„</h2><h3 id="2-1-hash-cell"><a href="#2-1-hash-cell" class="headerlink" title="2.1 hash_cell"></a>2.1 hash_cell</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// drivers\md\dm-ioctl.c</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hash_cell</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">name_list</span>;</span>  <span class="hljs-comment">// è¡¨ç¤ºnameçš„åŒå‘é“¾è¡¨ï¼ŒåŒä¸€ä¸ªHashå€¼çš„å½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">uuid_list</span>;</span>  <span class="hljs-comment">// è¡¨ç¤ºuuidçš„åŒå‘é“¾è¡¨ï¼ŒåŒä¸€ä¸ªHashå€¼çš„å½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨</span><br><br><span class="hljs-type">char</span> *name;   <span class="hljs-comment">// å½“å‰mapped deviceçš„name</span><br><span class="hljs-type">char</span> *uuid;   <span class="hljs-comment">// å½“å‰mapped deviceçš„uuid</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mapped_device</span> *<span class="hljs-title">md</span>;</span>  <span class="hljs-comment">// å…·ä½“çš„mapped_device</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_table</span> *<span class="hljs-title">new_map</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><img src="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/image-20230425235406381.png" alt="image-20230425235406381" style="zoom:80%;"><h2 id="2-åˆ›å»ºè®¾å¤‡"><a href="#2-åˆ›å»ºè®¾å¤‡" class="headerlink" title="2.åˆ›å»ºè®¾å¤‡"></a>2.åˆ›å»ºè®¾å¤‡</h2><p>å‰é¢å¯ä»¥çœ‹åˆ°ç”¨æˆ·ç©ºé—´ä¼ é€’è¿›æ¥DM_DEV_CREATEæƒ³è¦åˆ›å»ºdmè®¾å¤‡ï¼Œå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dev_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dm_ioctl *param, <span class="hljs-type">size_t</span> param_size)</span><br>&#123;<br><span class="hljs-type">int</span> r, m = DM_ANY_MINOR;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mapped_device</span> *<span class="hljs-title">md</span>;</span><br><br>    <span class="hljs-comment">// 2.1èŠ‚å»æ£€æŸ¥ä¼ è¿›æ¥çš„å‚æ•°ä¸­çš„nameæ˜¯å¦åˆæ³•</span><br>r = check_name(param-&gt;name);<br>    <br>    <span class="hljs-comment">// ç”¨æˆ·ç©ºé—´æ²¡æœ‰ä¼ é€’flagï¼Œæ‰€ä»¥mçš„å€¼ä»ç„¶æ˜¯DM_ANY_MINOR</span><br>    <span class="hljs-comment">// ä¼šå½±å“åˆ°2.2.1èŠ‚</span><br>    <span class="hljs-keyword">if</span> (param-&gt;flags &amp; DM_PERSISTENT_DEV_FLAG)<br>m = MINOR(huge_decode_dev(param-&gt;dev));<br><br>    <span class="hljs-comment">// 2.2èŠ‚ç”¨æ¥åˆ›å»ºdmè®¾å¤‡</span><br>r = dm_create(m, &amp;md);<br><span class="hljs-keyword">if</span> (r)<br><span class="hljs-keyword">return</span> r;<br><br>r = dm_hash_insert(param-&gt;name, *param-&gt;uuid ? param-&gt;uuid : <span class="hljs-literal">NULL</span>, md);<br><span class="hljs-keyword">if</span> (r) &#123;<br>dm_put(md);<br>dm_destroy(md);<br><span class="hljs-keyword">return</span> r;<br>&#125;<br><br>param-&gt;flags &amp;= ~DM_INACTIVE_PRESENT_FLAG;<br><br>__dev_status(md, param);<br><br>dm_put(md);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å¼•ç”¨**<a href="https://blog.csdn.net/feelabclihu/article/details/120232172">å†…æ ¸å·¥åŒ </a>**æ€»ç»“çš„å›¾ç‰‡ï¼š</p></blockquote><img src="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/ec3e80a0f0a490eb7d77c6dbaa8f3df6.png" alt="img" style="zoom:80%;"><h3 id="2-1-checknameæ£€æŸ¥åå­—æ˜¯å¦åˆæ³•"><a href="#2-1-checknameæ£€æŸ¥åå­—æ˜¯å¦åˆæ³•" class="headerlink" title="2.1 checknameæ£€æŸ¥åå­—æ˜¯å¦åˆæ³•"></a>2.1 checknameæ£€æŸ¥åå­—æ˜¯å¦åˆæ³•</h3><p>é¦–å…ˆæˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹param-&gt;nameä»ä½•è€Œæ¥ï¼Œåœ¨1.2ä¸­è°ƒç”¨ioctlä¹‹å‰ä¼šåˆå§‹åŒ–éœ€è¦ä¼ é€’çš„æ•°æ®ï¼Œæ­¤æ—¶param-&gt;nameä¹Ÿå°±æ˜¯åœ¨åˆå§‹åŒ–æ•°æ®æ—¶çš„io-&gt;nameï¼Œå³ç±»ä¼¼system_aè¿™ç§ã€‚</p><img src="/2023/04/25/DeviceMapper%E9%A9%B1%E5%8A%A8/image-20230425225647715.png" alt="image-20230425225647715" style="zoom: 50%;"><p>åªè¦ä¼ è¿›æ¥çš„åˆ†åŒºåä¸å«æœ‰<code>/</code>ï¼Œé‚£ä¹ˆåå­—å°±æ˜¯åˆæ³•çš„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_name</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(name, <span class="hljs-string">&#x27;/&#x27;</span>)) &#123;<br>DMWARN(<span class="hljs-string">&quot;invalid device name&quot;</span>);<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-dm-createåˆ›å»ºdmè®¾å¤‡"><a href="#2-2-dm-createåˆ›å»ºdmè®¾å¤‡" class="headerlink" title="2.2 dm_createåˆ›å»ºdmè®¾å¤‡"></a>2.2 dm_createåˆ›å»ºdmè®¾å¤‡</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">dm_create</span><span class="hljs-params">(<span class="hljs-type">int</span> minor, <span class="hljs-keyword">struct</span> mapped_device **result)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mapped_device</span> *<span class="hljs-title">md</span>;</span><br><br>md = alloc_dev(minor);<br><span class="hljs-keyword">if</span> (!md)<br><span class="hljs-keyword">return</span> -ENXIO;<br><br>dm_sysfs_init(md);<br><br>*result = md;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="2-2-1-alloc-devåˆ†é…è®¾å¤‡"><a href="#2-2-1-alloc-devåˆ†é…è®¾å¤‡" class="headerlink" title="2.2.1 alloc_devåˆ†é…è®¾å¤‡"></a>2.2.1 alloc_devåˆ†é…è®¾å¤‡</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> mapped_device *<span class="hljs-title function_">alloc_dev</span><span class="hljs-params">(<span class="hljs-type">int</span> minor)</span><br>&#123;<br>    <span class="hljs-comment">// ç”¨æˆ·ç©ºé—´æ²¡æœ‰ä¼ é€’param-&gt;flagsæ‰€ä»¥</span><br>    <span class="hljs-comment">// å‰é¢æ²¡æœ‰è®¾ç½®minorå·ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯DM_ANY_MINOR</span><br><span class="hljs-keyword">if</span> (minor == DM_ANY_MINOR)<br>        <span class="hljs-comment">// minorå€¼ä¼šä¾æ¬¡å¾€ä¸‹è¿è¡Œ</span><br>        <span class="hljs-comment">// åœ¨next_free_minoré‡Œé¢idræœºåˆ¶ä¼šåˆ†é…ç»™minorä¸€ä¸ªæœªå ç”¨çš„æœ€å°å€¼</span><br>        <span class="hljs-comment">// ä»0å¼€å§‹</span><br>r = next_free_minor(&amp;minor);<br><span class="hljs-keyword">else</span><br>r = specific_minor(minor);<br>   <br>    <span class="hljs-comment">// æ­¤å¤„åˆå§‹åŒ–MapperDeviceå„ç§mutexå’Œlist</span><br>    <br>    <span class="hljs-comment">// è°ƒç”¨blk_queue_make_requestæ³¨å†Œmapped deviceå¯¹åº”çš„è¯·æ±‚é˜Ÿåˆ—dm_make_request</span><br>    dm_init_md_queue(md);<br>    <br>    <span class="hljs-comment">// </span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-dm-hash-insertæ’å…¥å“ˆå¸Œç—›"><a href="#2-3-dm-hash-insertæ’å…¥å“ˆå¸Œç—›" class="headerlink" title="2.3 dm_hash_insertæ’å…¥å“ˆå¸Œç—›"></a>2.3 dm_hash_insertæ’å…¥å“ˆå¸Œç—›</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dm_hash_insert</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *uuid, <span class="hljs-keyword">struct</span> mapped_device *md)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hash_cell</span> *<span class="hljs-title">cell</span>, *<span class="hljs-title">hc</span>;</span><br><br>cell = alloc_cell(name, uuid, md);<br><br>down_write(&amp;_hash_lock);<br>hc = __get_name_cell(name);<br><span class="hljs-keyword">if</span> (hc) &#123;<br>dm_put(hc-&gt;md);<br><span class="hljs-keyword">goto</span> bad;<br>&#125;<br><br>list_add(&amp;cell-&gt;name_list, _name_buckets + hash_str(name));<br><br><span class="hljs-keyword">if</span> (uuid) &#123;<br>hc = __get_uuid_cell(uuid);<br><span class="hljs-keyword">if</span> (hc) &#123;<br>list_del(&amp;cell-&gt;name_list);<br>dm_put(hc-&gt;md);<br><span class="hljs-keyword">goto</span> bad;<br>&#125;<br>list_add(&amp;cell-&gt;uuid_list, _uuid_buckets + hash_str(uuid));<br>&#125;<br>dm_get(md);<br><br>dm_set_mdptr(md, cell);<br><br>up_write(&amp;_hash_lock);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxé©±åŠ¨â€”â€”platformè®¾å¤‡é©±åŠ¨å®éªŒ</title>
    <link href="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/"/>
    <url>/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxé©±åŠ¨â€”â€”platformè®¾å¤‡é©±åŠ¨å®éªŒ"><a href="#Linuxé©±åŠ¨â€”â€”platformè®¾å¤‡é©±åŠ¨å®éªŒ" class="headerlink" title="Linuxé©±åŠ¨â€”â€”platformè®¾å¤‡é©±åŠ¨å®éªŒ"></a>Linuxé©±åŠ¨â€”â€”platformè®¾å¤‡é©±åŠ¨å®éªŒ</h1><blockquote><p>æœ¬æ–‡ä¸ºå­¦ä¹ æ­£ç‚¹åŸå­é©±åŠ¨æ‰€åšç¬”è®°ï¼Œä»…ä¾›æœ¬äººå¤ä¹ æŸ¥é˜…ä½¿ç”¨ï¼Œè¯·å‹¿å•†ç”¨</p><p>ä¾µæƒåˆ é™¤ï¼</p></blockquote><h2 id="1-Linuxé©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚"><a href="#1-Linuxé©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚" class="headerlink" title="1.Linuxé©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚"></a>1.Linuxé©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚</h2><h3 id="1-1-é©±åŠ¨çš„åˆ†éš”å’Œåˆ†ç¦»"><a href="#1-1-é©±åŠ¨çš„åˆ†éš”å’Œåˆ†ç¦»" class="headerlink" title="1.1 é©±åŠ¨çš„åˆ†éš”å’Œåˆ†ç¦»"></a>1.1 é©±åŠ¨çš„åˆ†éš”å’Œåˆ†ç¦»</h3><p>å¯¹äº Linux è¿™æ ·ä¸€ä¸ªæˆç†Ÿã€åºå¤§ã€å¤æ‚çš„æ“ä½œç³»ç»Ÿï¼Œä»£ç çš„é‡ç”¨æ€§éå¸¸é‡è¦ï¼Œå¦åˆ™çš„è¯å°±ä¼šåœ¨ Linux å†…æ ¸ä¸­å­˜åœ¨å¤§é‡æ— æ„ä¹‰çš„é‡å¤ä»£ç ã€‚å°¤å…¶æ˜¯é©±åŠ¨ç¨‹åºï¼Œå› ä¸ºé©±åŠ¨ç¨‹åºå ç”¨äº† Linux å†…æ ¸ä»£ç é‡çš„å¤§å¤´ï¼Œå¦‚æœä¸å¯¹é©±åŠ¨ç¨‹åºåŠ ä»¥ç®¡ç†ï¼Œä»»ç”±é‡å¤çš„ä»£ç è‚†æ„å¢åŠ ï¼Œé‚£ä¹ˆç”¨ä¸äº†å¤šä¹… Linux å†…æ ¸çš„æ–‡ä»¶æ•°é‡å°±åºå¤§åˆ°æ— æ³•æ¥å—çš„åœ°æ­¥ã€‚ </p><p>å‡å¦‚ç°åœ¨æœ‰ä¸‰ä¸ªå¹³å° Aã€B å’Œ Cï¼Œè¿™ä¸‰ä¸ªå¹³å°(è¿™é‡Œçš„å¹³å°è¯´çš„æ˜¯ SOC)ä¸Šéƒ½æœ‰ MPU6050 è¿™ä¸ª I2Cæ¥å£çš„å…­è½´ä¼ æ„Ÿå™¨ï¼ŒæŒ‰ç…§æˆ‘ä»¬å†™è£¸æœº I2C é©±åŠ¨çš„æ—¶å€™çš„æ€è·¯ï¼Œæ¯ä¸ªå¹³å°éƒ½æœ‰ä¸€ä¸ª MPU6050 çš„é©±åŠ¨ï¼Œå› æ­¤ç¼–å†™å‡ºæ¥çš„æœ€ç®€å•çš„é©±åŠ¨æ¡†æ¶å¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181633524.png" alt="image-20230422181633524" style="zoom:80%;"><p>æ¯ç§å¹³å°ä¸‹éƒ½æœ‰ä¸€ä¸ªä¸»æœºé©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨ï¼Œä¸»æœºé©±åŠ¨è‚¯å®šæ˜¯å¿…é¡»è¦çš„ï¼Œæ¯•ç«Ÿä¸åŒçš„å¹³å°å…¶ I2C æ§åˆ¶å™¨ä¸åŒã€‚ä½†æ˜¯å³ä¾§çš„è®¾å¤‡é©±åŠ¨å°±æ²¡å¿…è¦æ¯ä¸ªå¹³å°éƒ½å†™ä¸€ä¸ªï¼Œ å› ä¸ºä¸ç®¡å¯¹äºé‚£ä¸ª SOC æ¥è¯´ï¼ŒMPU6050 éƒ½æ˜¯ä¸€æ ·ï¼Œé€šè¿‡ I2C æ¥å£è¯»å†™æ•°æ®å°±è¡Œäº†ï¼Œåªéœ€è¦ä¸€ä¸ª MPU6050 çš„é©±åŠ¨ç¨‹åºå³å¯ã€‚å¦‚æœå†æ¥å‡ ä¸ª I2C è®¾å¤‡ï¼Œæ¯”å¦‚ AT24C02ã€FT5206(ç”µå®¹è§¦æ‘¸å±) ç­‰ï¼Œå¦‚æœæŒ‰ç…§ä¸Šå›¾çš„å†™æ³•ï¼Œé‚£ä¹ˆè®¾å¤‡ç«¯çš„é©±åŠ¨å°†ä¼šé‡å¤çš„ç¼–å†™å¥½å‡ æ¬¡ã€‚æ˜¾ç„¶åœ¨ Linux é©±åŠ¨ç¨‹åºä¸­è¿™ç§å†™æ³•æ˜¯ä¸æ¨èçš„ï¼Œæœ€å¥½çš„åšæ³•å°±æ˜¯æ¯ä¸ªå¹³å°çš„ I2C æ§åˆ¶å™¨éƒ½æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ (ä¹Ÿå«åšä¸»æœºé©±åŠ¨)ï¼Œæ¯ä¸ªè®¾å¤‡çš„è¯ä¹Ÿåªæä¾›ä¸€ä¸ªé©±åŠ¨ç¨‹åº(è®¾å¤‡é©±åŠ¨)ï¼Œæ¯ä¸ªè®¾å¤‡é€šè¿‡ç»Ÿä¸€çš„ I2C æ¥å£é©±åŠ¨æ¥è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§ç®€åŒ–é©±åŠ¨æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ä¸‰ç§å¹³å°ä¸‹çš„ MPU6050 é©±åŠ¨ æ¡†æ¶å°±å¯ä»¥ç®€åŒ–ä¸ºï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181657643.png" alt="image-20230422181657643" style="zoom:80%;"><p>è¿™ä¸ªå°±æ˜¯é©±åŠ¨çš„åˆ†éš”ï¼Œä¹Ÿå°±æ˜¯å°†ä¸»æœºé©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨åˆ†éš”å¼€æ¥ï¼Œæ¯”å¦‚ I2Cã€SPI ç­‰ç­‰éƒ½ä¼šé‡‡ç”¨é©±åŠ¨åˆ†éš”çš„æ–¹å¼æ¥ç®€åŒ–é©±åŠ¨çš„å¼€å‘ã€‚åœ¨å®é™…çš„é©±åŠ¨å¼€å‘ä¸­ï¼Œä¸€èˆ¬ I2C ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨å·²ç»ç”±åŠå¯¼ä½“å‚å®¶ç¼–å†™å¥½äº†ï¼Œè€Œè®¾å¤‡é©±åŠ¨ä¸€èˆ¬ä¹Ÿç”±è®¾å¤‡å™¨ä»¶çš„å‚å®¶ç¼–å†™å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›è®¾å¤‡ä¿¡æ¯å³å¯ï¼Œæ¯”å¦‚ I2C è®¾å¤‡çš„è¯æä¾›è®¾å¤‡è¿æ¥åˆ°äº†å“ªä¸ª I2C æ¥å£ä¸Šï¼ŒI2C çš„é€Ÿåº¦æ˜¯å¤šå°‘ç­‰ç­‰ã€‚ç›¸å½“äºå°†è®¾å¤‡ä¿¡æ¯ä»è®¾å¤‡é©±åŠ¨ä¸­å‰¥ç¦»å¼€æ¥ï¼Œé©±åŠ¨ä½¿ç”¨æ ‡å‡†æ–¹æ³•å»è·å–åˆ°è®¾å¤‡ä¿¡æ¯(æ¯”å¦‚ä»è®¾å¤‡æ ‘ä¸­è·å–åˆ°è®¾å¤‡ä¿¡æ¯)ï¼Œç„¶åæ ¹æ®è·å–åˆ°çš„è®¾å¤‡ä¿¡æ¯æ¥åˆå§‹åŒ–è®¾å¤‡ã€‚ è¿™æ ·å°±ç›¸å½“äºé©±åŠ¨åªè´Ÿè´£é©±åŠ¨ï¼Œè®¾å¤‡åªè´Ÿè´£è®¾å¤‡ï¼Œæƒ³åŠæ³•å°†ä¸¤è€…è¿›è¡ŒåŒ¹é…å³å¯ã€‚è¿™ä¸ªå°±æ˜¯ Linux ä¸­çš„æ€»çº¿(bus)ã€é©±åŠ¨(driver)å’Œè®¾å¤‡(device)æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„é©±åŠ¨åˆ†ç¦»ã€‚æ€»çº¿å°±æ˜¯é©±åŠ¨å’Œè®¾å¤‡ä¿¡æ¯çš„æœˆè€ï¼Œè´Ÿè´£ç»™ä¸¤è€…ç‰µçº¿æ­æ¡¥ï¼Œå¦‚å›¾æ‰€ç¤º</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181717547.png" alt="image-20230422181717547" style="zoom:80%;"><p>å½“æˆ‘ä»¬å‘ç³»ç»Ÿæ³¨å†Œä¸€ä¸ªé©±åŠ¨çš„æ—¶å€™ï¼Œæ€»çº¿å°±ä¼šåœ¨å³ä¾§çš„è®¾å¤‡ä¸­æŸ¥æ‰¾ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä¸ä¹‹åŒ¹é…çš„è®¾å¤‡ï¼Œå¦‚æœæœ‰çš„è¯å°±å°†ä¸¤è€…è”ç³»èµ·æ¥ã€‚åŒæ ·çš„ï¼Œå½“å‘ç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªè®¾å¤‡çš„æ—¶å€™ï¼Œæ€»çº¿å°±ä¼šåœ¨å·¦ä¾§çš„é©±åŠ¨ä¸­æŸ¥æ‰¾çœ‹æœ‰æ²¡æœ‰ä¸ä¹‹åŒ¹é…çš„è®¾å¤‡ï¼Œæœ‰çš„è¯ä¹Ÿè”ç³»èµ·æ¥ã€‚Linux å†…æ ¸ä¸­å¤§é‡çš„é©±åŠ¨ç¨‹åºéƒ½é‡‡ç”¨æ€»çº¿ã€é©±åŠ¨å’Œè®¾å¤‡æ¨¡å¼ï¼Œæˆ‘ä»¬ä¸€ä¼šè¦é‡ç‚¹è®²è§£çš„ platform é©±åŠ¨å°±æ˜¯è¿™ä¸€æ€æƒ³ä¸‹çš„äº§ç‰©ã€‚</p><h3 id="1-2-é©±åŠ¨çš„åˆ†å±‚"><a href="#1-2-é©±åŠ¨çš„åˆ†å±‚" class="headerlink" title="1.2 é©±åŠ¨çš„åˆ†å±‚"></a>1.2 é©±åŠ¨çš„åˆ†å±‚</h3><p>ä¸Šä¸€å°èŠ‚è®²äº†é©±åŠ¨çš„åˆ†éš”ä¸åˆ†ç¦»ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹é©±åŠ¨çš„åˆ†å±‚ï¼Œå¤§å®¶åº”è¯¥å¬è¯´è¿‡ç½‘ç»œçš„ 7 å±‚æ¨¡å‹ï¼Œä¸åŒçš„å±‚è´Ÿè´£ä¸åŒçš„å†…å®¹ã€‚åŒæ ·çš„ï¼ŒLinux ä¸‹çš„é©±åŠ¨å¾€å¾€ä¹Ÿæ˜¯åˆ†å±‚çš„ï¼Œåˆ†å±‚çš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†åœ¨ä¸åŒçš„å±‚å¤„ç†ä¸åŒçš„å†…å®¹ã€‚ä»¥å…¶ä»–ä¹¦ç±æˆ–è€…èµ„æ–™å¸¸å¸¸ä½¿ç”¨åˆ°çš„input(è¾“å…¥å­ç³»ç»Ÿï¼Œåé¢ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚è¯¦ç»†çš„è®²è§£)ä¸ºä¾‹ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹é©±åŠ¨çš„åˆ†å±‚ã€‚input å­ç³»ç»Ÿè´Ÿè´£ç®¡ç†æ‰€æœ‰è·Ÿè¾“å…¥æœ‰å…³çš„é©±åŠ¨ï¼ŒåŒ…æ‹¬é”®ç›˜ã€é¼ æ ‡ã€è§¦æ‘¸ç­‰ï¼Œæœ€åº•å±‚çš„å°±æ˜¯è®¾å¤‡åŸå§‹é©±åŠ¨ï¼Œè´Ÿè´£è·å–è¾“å…¥è®¾å¤‡çš„åŸå§‹å€¼ï¼Œè·å–åˆ°çš„è¾“å…¥äº‹ä»¶ä¸ŠæŠ¥ç»™ input æ ¸å¿ƒå±‚ã€‚input æ ¸å¿ƒå±‚ä¼šå¤„ç†å„ç§ IO æ¨¡å‹ï¼Œå¹¶ä¸”æä¾› file_operations æ“ä½œé›†åˆã€‚æˆ‘ä»¬åœ¨ç¼–å†™è¾“å…¥è®¾å¤‡é©±åŠ¨çš„æ—¶å€™åªéœ€è¦å¤„ç†å¥½è¾“å…¥äº‹ä»¶çš„ä¸ŠæŠ¥å³å¯ï¼Œè‡³äºå¦‚ä½•å¤„ç†è¿™äº›ä¸ŠæŠ¥çš„è¾“å…¥äº‹ä»¶é‚£æ˜¯ä¸Šå±‚å»è€ƒè™‘çš„ï¼Œæˆ‘ä»¬ä¸ç”¨ç®¡ã€‚å¯ä»¥çœ‹å‡ºå€ŸåŠ©åˆ†å±‚æ¨¡å‹å¯ä»¥æå¤§çš„ç®€åŒ–æˆ‘ä»¬çš„é©±åŠ¨ç¼–å†™ï¼Œå¯¹äºé©±åŠ¨ç¼–å†™æ¥è¯´éå¸¸çš„å‹å¥½ã€‚</p><h2 id="2-platformå¹³å°é©±åŠ¨æ¨¡å‹ç®€ä»‹"><a href="#2-platformå¹³å°é©±åŠ¨æ¨¡å‹ç®€ä»‹" class="headerlink" title="2.platformå¹³å°é©±åŠ¨æ¨¡å‹ç®€ä»‹"></a>2.platformå¹³å°é©±åŠ¨æ¨¡å‹ç®€ä»‹</h2><p>å‰é¢æˆ‘ä»¬è®²äº†è®¾å¤‡é©±åŠ¨çš„åˆ†ç¦»ï¼Œå¹¶ä¸”å¼•å‡ºäº†æ€»çº¿(bus)ã€é©±åŠ¨(driver)å’Œè®¾å¤‡(device)æ¨¡å‹ï¼Œæ¯”å¦‚ I2Cã€SPIã€USB ç­‰æ€»çº¿ã€‚ä½†æ˜¯åœ¨ SOC ä¸­æœ‰äº›å¤–è®¾æ˜¯æ²¡æœ‰æ€»çº¿è¿™ä¸ªæ¦‚å¿µçš„ï¼Œä½†æ˜¯åˆè¦ä½¿ç”¨æ€»çº¿ã€é©±åŠ¨å’Œè®¾å¤‡æ¨¡å‹è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼ŒLinux æå‡ºäº† platform è¿™ä¸ªè™šæ‹Ÿæ€»çº¿ï¼Œç›¸åº”çš„å°±æœ‰platform_driver å’Œ platform_deviceã€‚</p><h3 id="2-1-platformæ€»çº¿"><a href="#2-1-platformæ€»çº¿" class="headerlink" title="2.1 platformæ€»çº¿"></a>2.1 platformæ€»çº¿</h3><p>Linuxç³»ç»Ÿå†…æ ¸ä½¿ç”¨bus_type ç»“æ„ä½“è¡¨ç¤ºæ€»çº¿ï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;device.hï¼Œ bus_type ç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181844577.png" alt="image-20230422181844577" style="zoom: 80%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181859954.png" alt="image-20230422181859954" style="zoom:80%;"><p>ç¬¬ 10 è¡Œï¼Œmatch å‡½æ•°ï¼Œæ­¤å‡½æ•°å¾ˆé‡è¦ï¼Œå•è¯ match çš„æ„æ€å°±æ˜¯â€œåŒ¹é…ã€ç›¸é…â€ï¼Œå› æ­¤æ­¤å‡½æ•°å°±æ˜¯å®Œæˆè®¾å¤‡å’Œé©±åŠ¨ä¹‹é—´åŒ¹é…çš„ï¼Œæ€»çº¿å°±æ˜¯ä½¿ç”¨ match å‡½æ•°æ¥æ ¹æ®æ³¨å†Œçš„è®¾å¤‡æ¥æŸ¥æ‰¾å¯¹åº”çš„é©±åŠ¨ï¼Œæˆ–è€…æ ¹æ®æ³¨å†Œçš„é©±åŠ¨æ¥æŸ¥æ‰¾ç›¸åº”çš„è®¾å¤‡ï¼Œå› æ­¤æ¯ä¸€æ¡æ€»çº¿éƒ½å¿…é¡»å®ç°æ­¤å‡½æ•°ã€‚match å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼šdev å’Œ drvï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸º device å’Œ device_driver ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡å’Œé©±åŠ¨ã€‚ </p><p>platform æ€»çº¿æ˜¯ bus_type çš„ä¸€ä¸ªå…·ä½“å®ä¾‹ï¼Œå®šä¹‰åœ¨æ–‡ä»¶ drivers&#x2F;base&#x2F;platform.cï¼Œplatform æ€»çº¿å®šä¹‰å¦‚ä¸‹ï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422181937298.png" alt="image-20230422181937298" style="zoom:80%;"><p>platform_bus_type å°±æ˜¯ platform å¹³å°æ€»çº¿ï¼Œå…¶ä¸­ platform_match å°±æ˜¯åŒ¹é…å‡½æ•°ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é©±åŠ¨å’Œè®¾å¤‡æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼Œplatform_match å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ drivers&#x2F;base&#x2F;platform.c ä¸­ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182023491.png" alt="image-20230422182023491" style="zoom: 50%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182043518.png" alt="image-20230422182043518" style="zoom:50%;"><p>é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…æœ‰å››ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥çœ‹ä¸€ä¸‹ï¼š </p><ol><li>ç¬¬ 11~12 è¡Œï¼Œç¬¬ä¸€ç§åŒ¹é…æ–¹å¼ï¼Œ OF ç±»å‹çš„åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡æ ‘é‡‡ç”¨çš„åŒ¹é…æ–¹å¼ï¼Œ of_driver_match_device å‡½æ•°å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;of_device.h ä¸­ã€‚device_driver ç»“æ„ä½“(è¡¨ç¤ºè®¾å¤‡é©±åŠ¨)ä¸­æœ‰ä¸ªåä¸ºof_match_tableçš„æˆå‘˜å˜é‡ï¼Œæ­¤æˆå‘˜å˜é‡ä¿å­˜ç€é©±åŠ¨çš„compatibleåŒ¹é…è¡¨ï¼Œè®¾å¤‡æ ‘ä¸­çš„æ¯ä¸ªè®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§ä¼šå’Œ of_match_table è¡¨ä¸­çš„æ‰€æœ‰æˆå‘˜æ¯”è¾ƒï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸åŒçš„æ¡ç›®ï¼Œå¦‚æœæœ‰çš„è¯å°±è¡¨ç¤ºè®¾å¤‡å’Œæ­¤é©±åŠ¨åŒ¹é…ï¼Œè®¾å¤‡å’Œé©±åŠ¨åŒ¹é…æˆåŠŸä»¥å probe å‡½æ•° å°±ä¼šæ‰§è¡Œã€‚</li><li>ç¬¬ 15~16 è¡Œï¼Œç¬¬äºŒç§åŒ¹é…æ–¹å¼ï¼ŒACPI åŒ¹é…æ–¹å¼</li><li>ç¬¬ 19~20 è¡Œï¼Œç¬¬ä¸‰ç§åŒ¹é…æ–¹å¼ï¼Œid_table åŒ¹é…ï¼Œæ¯ä¸ª platform_driver ç»“æ„ä½“æœ‰ä¸€ä¸ª id_tableæˆå‘˜å˜é‡ï¼Œé¡¾åæ€ä¹‰ï¼Œä¿å­˜äº†å¾ˆå¤š id ä¿¡æ¯ã€‚è¿™äº› id ä¿¡æ¯å­˜æ”¾ç€è¿™ä¸ª platformd é©±åŠ¨æ‰€æ”¯æŒçš„é©±åŠ¨ç±»å‹ã€‚</li><li>ç¬¬ 23 è¡Œï¼Œç¬¬å››ç§åŒ¹é…æ–¹å¼ï¼Œå¦‚æœç¬¬ä¸‰ç§åŒ¹é…æ–¹å¼çš„ id_table ä¸å­˜åœ¨çš„è¯å°±ç›´æ¥æ¯”è¾ƒé©±åŠ¨å’Œè®¾å¤‡çš„ name å­—æ®µï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±åŒ¹é…æˆåŠŸ</li></ol><p>å¯¹äºæ”¯æŒè®¾å¤‡æ ‘çš„ Linux ç‰ˆæœ¬å·ï¼Œä¸€èˆ¬è®¾å¤‡é©±åŠ¨ä¸ºäº†å…¼å®¹æ€§éƒ½æ”¯æŒè®¾å¤‡æ ‘å’Œæ— è®¾å¤‡æ ‘ä¸¤ç§åŒ¹é…æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯ç¬¬ä¸€ç§åŒ¹é…æ–¹å¼ä¸€èˆ¬éƒ½ä¼šå­˜åœ¨ï¼Œç¬¬ä¸‰ç§å’Œç¬¬å››ç§åªè¦å­˜åœ¨ä¸€ç§å°±å¯ä»¥ï¼Œä¸€èˆ¬ç”¨çš„æœ€å¤šçš„è¿˜æ˜¯ç¬¬å››ç§ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ¯”è¾ƒé©±åŠ¨å’Œè®¾å¤‡çš„ name å­—æ®µï¼Œæ¯•ç«Ÿè¿™ç§æ–¹å¼æœ€ç®€å•äº†ã€‚ </p><h3 id="2-2-platformé©±åŠ¨"><a href="#2-2-platformé©±åŠ¨" class="headerlink" title="2.2 platformé©±åŠ¨"></a>2.2 platformé©±åŠ¨</h3><p>platform_driver ç»“æ„ä½“è¡¨ç¤º platformé©±åŠ¨ï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶include&#x2F;linux&#x2F;platform_device.h ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182124773.png" alt="image-20230422182124773" style="zoom: 50%;"><p>ç¬¬ 2 è¡Œï¼Œprobe å‡½æ•°ï¼Œå½“é©±åŠ¨ä¸è®¾å¤‡åŒ¹é…æˆåŠŸä»¥å probe å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œéå¸¸é‡è¦çš„å‡½æ•°ï¼ï¼ ä¸€èˆ¬é©±åŠ¨çš„æä¾›è€…ä¼šç¼–å†™ï¼Œå¦‚æœè‡ªå·±è¦ç¼–å†™ä¸€ä¸ªå…¨æ–°çš„é©±åŠ¨ï¼Œé‚£ä¹ˆ probe å°±éœ€è¦è‡ªè¡Œå®ç°ã€‚ </p><p>ç¬¬ 7 è¡Œï¼Œdriver æˆå‘˜ï¼Œä¸º device_driver ç»“æ„ä½“å˜é‡ï¼ŒLinux å†…æ ¸é‡Œé¢å¤§é‡ä½¿ç”¨åˆ°äº†é¢å‘å¯¹è±¡çš„æ€ç»´ï¼Œdevice_driver ç›¸å½“äºåŸºç±»ï¼Œæä¾›äº†æœ€åŸºç¡€çš„é©±åŠ¨æ¡†æ¶ã€‚plaform_driver ç»§æ‰¿äº†è¿™ä¸ªåŸºç±»ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šåˆæ·»åŠ äº†ä¸€äº›ç‰¹æœ‰çš„æˆå‘˜å˜é‡ã€‚</p><p>ç¬¬ 8 è¡Œï¼Œid_table è¡¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€å°èŠ‚è®²è§£ platform æ€»çº¿åŒ¹é…é©±åŠ¨å’Œè®¾å¤‡çš„æ—¶å€™é‡‡ç”¨çš„ ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œid_table æ˜¯ä¸ªè¡¨( ä¹Ÿå°±æ˜¯æ•°ç»„) ï¼Œæ¯ä¸ªå…ƒç´ çš„ç±»å‹ä¸º platform_device_idï¼Œ platform_device_id ç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182200143.png" alt="image-20230422182200143" style="zoom:50%;"><p>device_driver ç»“æ„ä½“å®šä¹‰åœ¨ include&#x2F;linux&#x2F;device.hï¼Œdevice_driver ç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182225859.png" alt="image-20230422182225859" style="zoom: 67%;"><p>ç¬¬ 10 è¡Œï¼Œof_match_table å°±æ˜¯é‡‡ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™é©±åŠ¨ä½¿ç”¨çš„åŒ¹é…è¡¨ï¼ŒåŒæ ·æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªåŒ¹é…é¡¹éƒ½ä¸º of_device_id ç»“æ„ä½“ç±»å‹ï¼Œæ­¤ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;mod_devicetable.h ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182255603.png" alt="image-20230422182255603" style="zoom: 67%;"><p>ç¬¬ 4 è¡Œçš„ compatible éå¸¸é‡è¦ï¼Œå› ä¸ºå¯¹äºè®¾å¤‡æ ‘è€Œè¨€ï¼Œå°±æ˜¯é€šè¿‡è®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å€¼å’Œ of_match_table ä¸­æ¯ä¸ªé¡¹ç›®çš„ compatible æˆå‘˜å˜é‡è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰ç›¸ç­‰çš„å°±è¡¨ç¤ºè®¾å¤‡å’Œæ­¤é©±åŠ¨åŒ¹é…æˆåŠŸã€‚ </p><p>åœ¨ç¼–å†™ platform é©±åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ª platform_driver ç»“æ„ä½“å˜é‡ï¼Œç„¶åå®ç°ç»“æ„ä½“ä¸­çš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œé‡ç‚¹æ˜¯å®ç°åŒ¹é…æ–¹æ³•ä»¥åŠ probe å‡½æ•°ã€‚å½“é©±åŠ¨å’Œè®¾å¤‡åŒ¹é…æˆåŠŸä»¥å probeå‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œå…·ä½“çš„é©±åŠ¨ç¨‹åºåœ¨ probe å‡½æ•°é‡Œé¢ç¼–å†™ï¼Œæ¯”å¦‚å­—ç¬¦è®¾å¤‡é©±åŠ¨ç­‰ç­‰ã€‚ å½“æˆ‘ä»¬å®šä¹‰å¹¶åˆå§‹åŒ–å¥½ platform_driver ç»“æ„ä½“å˜é‡ä»¥åï¼Œéœ€è¦åœ¨é©±åŠ¨å…¥å£å‡½æ•°é‡Œé¢è°ƒç”¨ platform_driver_register å‡½æ•°å‘ Linux å†…æ ¸æ³¨å†Œä¸€ä¸ª platform é©±åŠ¨ï¼Œplatform_driver_register å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">platform_driver_register</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_driver *driver)</span><br></code></pre></td></tr></table></figure><p><strong>driver</strong>ï¼šè¦æ³¨å†Œçš„ platform é©±åŠ¨ã€‚ </p><p><strong>è¿”å›å€¼ï¼š</strong>è´Ÿæ•°ï¼Œå¤±è´¥ï¼›0ï¼ŒæˆåŠŸã€‚ </p><p>è¿˜éœ€è¦åœ¨é©±åŠ¨å¸è½½å‡½æ•°ä¸­é€šè¿‡ platform_driver_unregister å‡½æ•°å¸è½½ platform é©±åŠ¨ï¼Œplatform_driver_unregister å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">platform_driver_unregister</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_driver *drv)</span><br></code></pre></td></tr></table></figure><p><strong>drv</strong>ï¼šè¦å¸è½½çš„ platform é©±åŠ¨ã€‚ </p><p><strong>è¿”å›å€¼ï¼š</strong>æ— ã€‚ </p><p>platform é©±åŠ¨æ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182725425.png" alt="image-20230422182725425" style="zoom:67%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182655339.png" alt="image-20230422182655339" style="zoom: 67%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182746084.png" alt="image-20230422182746084" style="zoom:67%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182802093.png" alt="image-20230422182802093" style="zoom:67%;"><p>ç¬¬ 1~27 è¡Œï¼Œä¼ ç»Ÿçš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œæ‰€è°“çš„ platform é©±åŠ¨å¹¶ä¸æ˜¯ç‹¬ç«‹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€å—è®¾å¤‡é©±åŠ¨å’Œç½‘ç»œè®¾å¤‡é©±åŠ¨ä¹‹å¤–çš„å…¶ä»–ç§ç±»çš„é©±åŠ¨ã€‚platform åªæ˜¯ä¸ºäº†é©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚è€Œæå‡ºæ¥ çš„ä¸€ç§æ¡†æ¶ï¼Œå…¶é©±åŠ¨çš„å…·ä½“å®ç°è¿˜æ˜¯éœ€è¦å­—ç¬¦è®¾å¤‡é©±åŠ¨ã€å—è®¾å¤‡é©±åŠ¨æˆ–ç½‘ç»œè®¾å¤‡é©±åŠ¨ã€‚</p><p>ç¬¬ 33~39 è¡Œï¼Œxxx_probe å‡½æ•°ï¼Œå½“é©±åŠ¨å’Œè®¾å¤‡åŒ¹é…æˆåŠŸä»¥åæ­¤å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œä»¥å‰åœ¨é©±åŠ¨å…¥å£ init å‡½æ•°é‡Œé¢ç¼–å†™çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºå°±å…¨éƒ¨æ”¾åˆ°æ­¤ probe å‡½æ•°é‡Œé¢ã€‚æ¯”å¦‚æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€æ·»åŠ  cdevã€åˆ›å»ºç±»ç­‰ç­‰ã€‚ </p><p>ç¬¬ 41~47 è¡Œï¼Œxxx_remove å‡½æ•°ï¼Œplatform_driver ç»“æ„ä½“ä¸­çš„ remove æˆå‘˜å˜é‡ï¼Œå½“å…³é—­ platform è®¾å¤‡é©±åŠ¨çš„æ—¶å€™æ­¤å‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œä»¥å‰åœ¨é©±åŠ¨å¸è½½ exit å‡½æ•°é‡Œé¢è¦åšçš„äº‹æƒ…å°±æ”¾åˆ°æ­¤å‡½æ•°ä¸­æ¥ã€‚ æ¯”å¦‚ï¼Œä½¿ç”¨ iounmap é‡Šæ”¾å†…å­˜ã€åˆ é™¤ cdevï¼Œæ³¨é”€è®¾å¤‡å·ç­‰ç­‰ã€‚ </p><p>ç¬¬ 50~53 è¡Œï¼Œxxx_of_match åŒ¹é…è¡¨ï¼Œå¦‚æœä½¿ç”¨è®¾å¤‡æ ‘çš„è¯å°†é€šè¿‡æ­¤åŒ¹é…è¡¨è¿›è¡Œé©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…ã€‚ç¬¬ 51 è¡Œè®¾ç½®äº†ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œæ­¤åŒ¹é…é¡¹çš„ compatible å€¼ä¸ºâ€œxxx-gpioâ€ï¼Œå› æ­¤å½“è®¾å¤‡æ ‘ä¸­è®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å€¼ä¸ºâ€œxxx-gpioâ€çš„æ—¶å€™æ­¤è®¾å¤‡å°±ä¼šä¸æ­¤é©±åŠ¨åŒ¹é…ã€‚ç¬¬ 52 è¡Œæ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œof_device_id è¡¨æœ€åä¸€ä¸ªåŒ¹é…é¡¹å¿…é¡»æ˜¯ç©ºçš„ã€‚ </p><p>ç¬¬ 58 ~ 65 è¡Œï¼Œå®šä¹‰ä¸€ä¸ª platform_driver ç»“æ„ä½“å˜é‡ xxx_driverï¼Œè¡¨ç¤º platform é©±åŠ¨ï¼Œç¬¬ 59 ~ 62è¡Œè®¾ç½® paltform_driver ä¸­çš„ device_driver æˆå‘˜å˜é‡çš„ name å’Œ of_match_table è¿™ä¸¤ä¸ªå±æ€§ã€‚å…¶ä¸­name å±æ€§ç”¨äºä¼ ç»Ÿçš„é©±åŠ¨ä¸è®¾å¤‡åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥é©±åŠ¨å’Œè®¾å¤‡çš„ name å­—æ®µæ˜¯ä¸æ˜¯ç›¸åŒã€‚of_match_table å±æ€§å°±æ˜¯ç”¨äºè®¾å¤‡æ ‘ä¸‹çš„é©±åŠ¨ä¸è®¾å¤‡æ£€æŸ¥ã€‚å¯¹äºä¸€ä¸ªå®Œæ•´çš„é©±åŠ¨ç¨‹åºï¼Œå¿…é¡»æä¾›æœ‰è®¾å¤‡æ ‘å’Œæ— è®¾å¤‡æ ‘ä¸¤ç§åŒ¹é…æ–¹æ³•ã€‚æœ€å 63 å’Œ 64 è¿™ä¸¤è¡Œè®¾ç½® probe å’Œ remove è¿™ä¸¤æˆå‘˜å˜é‡ã€‚ </p><p>ç¬¬68~71è¡Œï¼Œé©±åŠ¨å…¥å£å‡½æ•°ï¼Œè°ƒç”¨platform_driver_registerå‡½æ•°å‘Linuxå†…æ ¸æ³¨å†Œä¸€ä¸ªplatformé©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å®šä¹‰çš„ xxx_driver ç»“æ„ä½“å˜é‡ã€‚ </p><p>ç¬¬ 74~77 è¡Œï¼Œé©±åŠ¨å‡ºå£å‡½æ•°ï¼Œè°ƒç”¨ platform_driver_unregister å‡½æ•°å¸è½½å‰é¢æ³¨å†Œçš„ platformé©±åŠ¨ã€‚</p><p>æ€»ä½“æ¥è¯´ï¼Œplatform é©±åŠ¨è¿˜æ˜¯ä¼ ç»Ÿçš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ã€å—è®¾å¤‡é©±åŠ¨æˆ–ç½‘ç»œè®¾å¤‡é©±åŠ¨ï¼Œåªæ˜¯å¥—ä¸Šäº†ä¸€å¼ â€œplatformâ€çš„çš®ï¼Œç›®çš„æ˜¯ä¸ºäº†ä½¿ç”¨æ€»çº¿ã€é©±åŠ¨å’Œè®¾å¤‡è¿™ä¸ªé©±åŠ¨æ¨¡å‹æ¥å®ç°é©±åŠ¨çš„åˆ†ç¦»ä¸åˆ†å±‚ã€‚</p><h3 id="2-3-platformè®¾å¤‡"><a href="#2-3-platformè®¾å¤‡" class="headerlink" title="2.3 platformè®¾å¤‡"></a>2.3 platformè®¾å¤‡</h3><p>platform é©±åŠ¨å·²ç»å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ platform è®¾å¤‡ï¼Œå¦åˆ™çš„è¯å•å•ä¸€ä¸ªé©±åŠ¨ä¹Ÿåšä¸äº†ä»€ä¹ˆã€‚platform_device è¿™ä¸ªç»“æ„ä½“è¡¨ç¤º platform è®¾å¤‡ï¼Œè¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„ï¼Œå¦‚æœå†…æ ¸æ”¯æŒè®¾å¤‡æ ‘çš„è¯å°±ä¸è¦å†ä½¿ç”¨ platform_device æ¥æè¿°è®¾å¤‡äº†ï¼Œå› ä¸ºæ”¹ç”¨è®¾å¤‡æ ‘å»æè¿°äº†ã€‚å½“ç„¶äº†ï¼Œä½ å¦‚æœ ä¸€å®šè¦ç”¨ platform_device æ¥æè¿°è®¾å¤‡ä¿¡æ¯çš„è¯ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚platform_device ç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include&#x2F;linux&#x2F;platform_device.h ä¸­ï¼Œç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182845233.png" alt="image-20230422182845233" style="zoom:67%;"><p>ç¬¬ 23 è¡Œï¼Œname è¡¨ç¤ºè®¾å¤‡åå­—ï¼Œè¦å’Œæ‰€ä½¿ç”¨çš„ platform é©±åŠ¨çš„ name å­—æ®µç›¸åŒï¼Œå¦åˆ™çš„è¯è®¾å¤‡å°±æ— æ³•åŒ¹é…åˆ°å¯¹åº”çš„é©±åŠ¨ã€‚æ¯”å¦‚å¯¹åº”çš„ platform é©±åŠ¨çš„ name å­—æ®µä¸ºâ€œxxx-gpioâ€ï¼Œé‚£ä¹ˆæ­¤ nameå­—æ®µä¹Ÿè¦è®¾ç½®ä¸ºâ€œxxx-gpioâ€ã€‚ </p><p>ç¬¬ 27 è¡Œï¼Œnum_resources è¡¨ç¤ºèµ„æºæ•°é‡ï¼Œä¸€èˆ¬ä¸ºç¬¬ 28 è¡Œ resource èµ„æºçš„å¤§å°ã€‚ </p><p>ç¬¬ 28 è¡Œï¼Œresource è¡¨ç¤ºèµ„æºï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡ä¿¡æ¯ï¼Œæ¯”å¦‚å¤–è®¾å¯„å­˜å™¨ç­‰ã€‚Linux å†…æ ¸ä½¿ç”¨ resourceç»“æ„ä½“è¡¨ç¤ºèµ„æºï¼Œresource ç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182902179.png" alt="image-20230422182902179" style="zoom:67%;"><p>start å’Œ end åˆ†åˆ«è¡¨ç¤ºèµ„æºçš„èµ·å§‹å’Œç»ˆæ­¢ä¿¡æ¯ï¼Œå¯¹äºå†…å­˜ç±»çš„èµ„æºï¼Œå°±è¡¨ç¤ºå†…å­˜èµ·å§‹å’Œç»ˆæ­¢åœ°å€ï¼Œname è¡¨ç¤ºèµ„æºåå­—ï¼Œflags è¡¨ç¤ºèµ„æºç±»å‹ï¼Œå¯é€‰çš„èµ„æºç±»å‹éƒ½å®šä¹‰åœ¨äº†æ–‡ä»¶include&#x2F;linux&#x2F;ioport.h é‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422182933077.png" alt="image-20230422182933077" style="zoom:67%;"><p>åœ¨ä»¥å‰ä¸æ”¯æŒè®¾å¤‡æ ‘çš„Linuxç‰ˆæœ¬ä¸­ï¼Œç”¨æˆ·éœ€è¦ç¼–å†™platform_deviceå˜é‡æ¥æè¿°è®¾å¤‡ä¿¡æ¯ï¼Œ ç„¶åä½¿ç”¨ platform_device_register å‡½æ•°å°†è®¾å¤‡ä¿¡æ¯æ³¨å†Œåˆ° Linux å†…æ ¸ä¸­ï¼Œæ­¤å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">platform_device_register</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span> <br></code></pre></td></tr></table></figure><p><strong>pdev</strong>ï¼šè¦æ³¨å†Œçš„ platform è®¾å¤‡ã€‚ </p><p><strong>è¿”å›å€¼ï¼š</strong>è´Ÿæ•°ï¼Œå¤±è´¥ï¼›0ï¼ŒæˆåŠŸ</p><p>å¦‚æœä¸å†ä½¿ç”¨ platform çš„è¯å¯ä»¥é€šè¿‡ platform_device_unregister å‡½æ•°æ³¨é”€æ‰ç›¸åº”çš„ platform è®¾å¤‡ï¼Œplatform_device_unregister å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">platform_device_unregister</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span><br></code></pre></td></tr></table></figure><p><strong>pdev</strong>ï¼šè¦æ³¨é”€çš„ platform è®¾å¤‡ã€‚ </p><p><strong>è¿”å›å€¼ï¼š</strong>æ— ã€‚ </p><p>platform è®¾å¤‡ä¿¡æ¯æ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼š </p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422183014879.png" alt="image-20230422183014879" style="zoom:67%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422183030672.png" alt="image-20230422183030672" style="zoom:67%;"><p>ç¬¬ 7~18 è¡Œï¼Œæ•°ç»„ xxx_resources è¡¨ç¤ºè®¾å¤‡èµ„æºï¼Œä¸€å…±æœ‰ä¸¤ä¸ªèµ„æºï¼Œåˆ†åˆ«ä¸ºè®¾å¤‡å¤–è®¾ 1 å’Œå¤–è®¾ 2 çš„å¯„å­˜å™¨ä¿¡æ¯ã€‚å› æ­¤ flags éƒ½ä¸º IORESOURCE_MEMï¼Œè¡¨ç¤ºèµ„æºä¸ºå†…å­˜ç±»å‹çš„ã€‚ </p><p>ç¬¬ 21~26 è¡Œï¼Œplatform è®¾å¤‡ç»“æ„ä½“å˜é‡ï¼Œæ³¨æ„ name å­—æ®µè¦å’Œæ‰€ä½¿ç”¨çš„é©±åŠ¨ä¸­çš„ name å­—æ®µä¸€è‡´ï¼Œå¦åˆ™é©±åŠ¨å’Œè®¾å¤‡æ— æ³•åŒ¹é…æˆåŠŸã€‚num_resources è¡¨ç¤ºèµ„æºå¤§å°ï¼Œå…¶å®å°±æ˜¯æ•°ç»„ xxx_resourcesçš„å…ƒç´ æ•°é‡ï¼Œè¿™é‡Œç”¨ ARRAY_SIZE æ¥æµ‹é‡ä¸€ä¸ªæ•°ç»„çš„å…ƒç´ ä¸ªæ•°ã€‚ </p><p>ç¬¬ 29~32 è¡Œï¼Œè®¾å¤‡æ¨¡å—åŠ è½½å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­è°ƒç”¨ platform_device_register å‘ Linux å†…æ ¸æ³¨å†Œ platform è®¾å¤‡ã€‚</p><p>ç¬¬ 35~38 è¡Œï¼Œè®¾å¤‡æ¨¡å—å¸è½½å‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­è°ƒç”¨ platform_device_unregister ä» Linux å†…æ ¸ä¸­å¸è½½ platform è®¾å¤‡ã€‚</p><p>ç¤ºä¾‹ä»£ç ä¸»è¦æ˜¯åœ¨ä¸æ”¯æŒè®¾å¤‡æ ‘çš„ Linux ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„ï¼Œå½“ Linux å†…æ ¸æ”¯æŒäº†è®¾å¤‡æ ‘ä»¥åå°±ä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å»æ³¨å†Œ platform è®¾å¤‡äº†ã€‚å› ä¸ºè®¾å¤‡ä¿¡æ¯éƒ½æ”¾åˆ°äº†è®¾å¤‡æ ‘ä¸­å»æè¿°ï¼Œ Linux å†…æ ¸å¯åŠ¨çš„æ—¶å€™ä¼šä»è®¾å¤‡æ ‘ä¸­è¯»å–è®¾å¤‡ä¿¡æ¯ï¼Œç„¶åå°†å…¶ç»„ç»‡æˆ platform_device å½¢å¼ï¼Œè‡³äºè®¾å¤‡æ ‘åˆ° platform_device çš„å…·ä½“è¿‡ç¨‹å°±ä¸å»è¯¦ç»†çš„è¿½ç©¶äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ä¸€ä¸‹ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šåšå®¢è¯¦ç»†çš„è®²è§£äº†æ•´ä¸ªè¿‡ç¨‹ã€‚</p><p>å…³äº platform ä¸‹çš„æ€»çº¿ã€é©±åŠ¨å’Œè®¾å¤‡å°±è®²è§£åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±ä½¿ç”¨ platform é©±åŠ¨æ¡†æ¶æ¥ç¼–å†™ä¸€ä¸ª LED ç¯é©±åŠ¨ï¼Œæœ¬ç« æˆ‘ä»¬ä¸ä½¿ç”¨è®¾å¤‡æ ‘æ¥æè¿°è®¾å¤‡ä¿¡æ¯ï¼Œæˆ‘ä»¬é‡‡ç”¨è‡ªå®šä¹‰platform_deviceè¿™ç§â€œå¤è€â€æ–¹å¼æ¥ç¼–å†™LEDçš„è®¾å¤‡ä¿¡æ¯ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬æ¥ç¼–å†™è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±æŒæ¡äº†æ— è®¾å¤‡æ ‘å’Œæœ‰è®¾å¤‡æ ‘è¿™ä¸¤ç§ platform é©±åŠ¨çš„å¼€å‘æ–¹å¼ã€‚</p><h2 id="3-å®éªŒç¨‹åºç¼–å†™"><a href="#3-å®éªŒç¨‹åºç¼–å†™" class="headerlink" title="3.å®éªŒç¨‹åºç¼–å†™"></a>3.å®éªŒç¨‹åºç¼–å†™</h2><h3 id="3-1-æ— è®¾å¤‡æ ‘çš„platformé©±åŠ¨ç¼–å†™"><a href="#3-1-æ— è®¾å¤‡æ ‘çš„platformé©±åŠ¨ç¼–å†™" class="headerlink" title="3.1 æ— è®¾å¤‡æ ‘çš„platformé©±åŠ¨ç¼–å†™"></a>3.1 æ— è®¾å¤‡æ ‘çš„platformé©±åŠ¨ç¼–å†™</h3><p>æ–°å»ºåä¸º leddevice.c å’Œ leddriver.c è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«ä¸º LED ç¯çš„ platform è®¾å¤‡æ–‡ä»¶å’Œ LED ç¯çš„ platform çš„é©±åŠ¨æ–‡ä»¶</p><p><code>leddevice.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ide.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/of_gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/timer.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/irq.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/mach/map.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/io.h&gt;</span></span><br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * å¯„å­˜å™¨åœ°å€å®šä¹‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CCM_CCGR1_BASE              (0X020C406C)        </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SW_MUX_GPIO1_IO03_BASE      (0X020E0068)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SW_PAD_GPIO1_IO03_BASE      (0X020E02F4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIO1_DR_BASE               (0X0209C000)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIO1_GDIR_BASE             (0X0209C004)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REGISTER_LENGTH             4</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">led_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev)</span><br>&#123;<br>        printk(<span class="hljs-string">&quot;led device released!\r\n&quot;</span>);        <br>&#125;<br><br><span class="hljs-comment">/*  </span><br><span class="hljs-comment"> * è®¾å¤‡èµ„æºä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯LED0æ‰€ä½¿ç”¨çš„æ‰€æœ‰å¯„å­˜å™¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> <span class="hljs-title">led_resources</span>[] =</span> &#123;<br>        [<span class="hljs-number">0</span>] = &#123;<br>                .start         = CCM_CCGR1_BASE,<br>                .end         = (CCM_CCGR1_BASE + REGISTER_LENGTH - <span class="hljs-number">1</span>),<br>                .flags         = IORESOURCE_MEM,<br>        &#125;,        <br>        [<span class="hljs-number">1</span>] = &#123;<br>                .start        = SW_MUX_GPIO1_IO03_BASE,<br>                .end        = (SW_MUX_GPIO1_IO03_BASE + REGISTER_LENGTH - <span class="hljs-number">1</span>),<br>                .flags        = IORESOURCE_MEM,<br>        &#125;,<br>        [<span class="hljs-number">2</span>] = &#123;<br>                .start        = SW_PAD_GPIO1_IO03_BASE,<br>                .end        = (SW_PAD_GPIO1_IO03_BASE + REGISTER_LENGTH - <span class="hljs-number">1</span>),<br>                .flags        = IORESOURCE_MEM,<br>        &#125;,<br>        [<span class="hljs-number">3</span>] = &#123;<br>                .start        = GPIO1_DR_BASE,<br>                .end        = (GPIO1_DR_BASE + REGISTER_LENGTH - <span class="hljs-number">1</span>),<br>                .flags        = IORESOURCE_MEM,<br>        &#125;,<br>        [<span class="hljs-number">4</span>] = &#123;<br>                .start        = GPIO1_GDIR_BASE,<br>                .end        = (GPIO1_GDIR_BASE + REGISTER_LENGTH - <span class="hljs-number">1</span>),<br>                .flags        = IORESOURCE_MEM,<br>        &#125;,<br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * platformè®¾å¤‡ç»“æ„ä½“ </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> <span class="hljs-title">leddevice</span> =</span> &#123;<br>        .name = <span class="hljs-string">&quot;imx6ul-amx-led&quot;</span>,<br>        .id = <span class="hljs-number">-1</span>,<br>        .dev = &#123;<br>                .release = &amp;led_release,<br>        &#125;,<br>        .num_resources = ARRAY_SIZE(led_resources),<br>        .resource = led_resources,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">leddevice_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> platform_device_register(&amp;leddevice);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">leddevice_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        platform_device_unregister(&amp;leddevice);<br>&#125;<br><br>module_init(leddevice_init);<br>module_exit(leddevice_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;anmuxixixi&quot;</span>);<br></code></pre></td></tr></table></figure><p><code>leddriver.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ide.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/of_gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/timer.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/irq.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/mach/map.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/io.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDDEV_CNT      1           <span class="hljs-comment">/* è®¾å¤‡å·é•¿åº¦         */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDDEV_NAME     <span class="hljs-string">&quot;platled&quot;</span>   <span class="hljs-comment">/* è®¾å¤‡åå­—         */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDOFF          0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDON           1</span><br><br><span class="hljs-comment">/* å¯„å­˜å™¨å */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __iomem *IMX6U_CCM_CCGR1;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __iomem *SW_MUX_GPIO1_IO03;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __iomem *SW_PAD_GPIO1_IO03;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __iomem *GPIO1_DR;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __iomem *GPIO1_GDIR;<br><br><span class="hljs-comment">/* leddevè®¾å¤‡ç»“æ„ä½“ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">leddev_dev</span>&#123;</span><br>        <span class="hljs-type">dev_t</span> devid;                        <span class="hljs-comment">/* è®¾å¤‡å· */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">cdev</span>;</span>                <span class="hljs-comment">/* cdev */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span> *<span class="hljs-keyword">class</span>;</span>        <span class="hljs-comment">/* ç±» */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">device</span>;</span>        <span class="hljs-comment">/* è®¾å¤‡ */</span><br>        <span class="hljs-type">int</span> major;                                <span class="hljs-comment">/* ä¸»è®¾å¤‡å· */</span>                <br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">leddev_dev</span> <span class="hljs-title">leddev</span>;</span>         <span class="hljs-comment">/* ledè®¾å¤‡ */</span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">led0_switch</span><span class="hljs-params">(u8 sta)</span><br>&#123;<br>        u32 val = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(sta == LEDON)&#123;<br>                val = readl(GPIO1_DR);<br>                val &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);        <br>                writel(val, GPIO1_DR);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sta == LEDOFF)&#123;<br>                val = readl(GPIO1_DR);<br>                val|= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);        <br>                writel(val, GPIO1_DR);<br>        &#125;        <br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *filp)</span><br>&#123;<br>        filp-&gt;private_data = &amp;leddev; <span class="hljs-comment">/* è®¾ç½®ç§æœ‰æ•°æ®  */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">led_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> cnt, <span class="hljs-type">loff_t</span> *offt)</span><br>&#123;<br>        <span class="hljs-type">int</span> retvalue;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> databuf[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ledstat;<br><br>        retvalue = copy_from_user(databuf, buf, cnt);<br>        <span class="hljs-keyword">if</span>(retvalue &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> -EFAULT;<br>        &#125;<br><br>        ledstat = databuf[<span class="hljs-number">0</span>];                <span class="hljs-comment">/* è·å–çŠ¶æ€å€¼ */</span><br>        <span class="hljs-keyword">if</span>(ledstat == LEDON) &#123;<br>                led0_switch(LEDON);                <span class="hljs-comment">/* æ‰“å¼€LEDç¯ */</span><br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ledstat == LEDOFF) &#123;<br>                led0_switch(LEDOFF);        <span class="hljs-comment">/* å…³é—­LEDç¯ */</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* è®¾å¤‡æ“ä½œå‡½æ•° */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">led_fops</span> =</span> &#123;<br>        .owner = THIS_MODULE,<br>        .open = led_open,<br>        .write = led_write,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *dev)</span><br>&#123;        <br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> ressize[<span class="hljs-number">5</span>];<br>        u32 val = <span class="hljs-number">0</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> *<span class="hljs-title">ledsource</span>[5];</span><br><br>        printk(<span class="hljs-string">&quot;led driver and device has matched!\r\n&quot;</span>);<br>        <span class="hljs-comment">/* 1ã€è·å–èµ„æº */</span><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>                ledsource[i] = platform_get_resource(dev, IORESOURCE_MEM, i); <span class="hljs-comment">/* ä¾æ¬¡MEMç±»å‹èµ„æº */</span><br>                <span class="hljs-keyword">if</span> (!ledsource[i]) &#123;<br>                        dev_err(&amp;dev-&gt;dev, <span class="hljs-string">&quot;No MEM resource for always on\n&quot;</span>);<br>                        <span class="hljs-keyword">return</span> -ENXIO;<br>                &#125;<br>                ressize[i] = resource_size(ledsource[i]);        <br>        &#125;        <br><br>        <span class="hljs-comment">/* 2ã€åˆå§‹åŒ–LED */</span><br>        <span class="hljs-comment">/* å¯„å­˜å™¨åœ°å€æ˜ å°„ */</span><br>         IMX6U_CCM_CCGR1 = ioremap(ledsource[<span class="hljs-number">0</span>]-&gt;start, ressize[<span class="hljs-number">0</span>]);<br>        SW_MUX_GPIO1_IO03 = ioremap(ledsource[<span class="hljs-number">1</span>]-&gt;start, ressize[<span class="hljs-number">1</span>]);<br>          SW_PAD_GPIO1_IO03 = ioremap(ledsource[<span class="hljs-number">2</span>]-&gt;start, ressize[<span class="hljs-number">2</span>]);<br>        GPIO1_DR = ioremap(ledsource[<span class="hljs-number">3</span>]-&gt;start, ressize[<span class="hljs-number">3</span>]);<br>        GPIO1_GDIR = ioremap(ledsource[<span class="hljs-number">4</span>]-&gt;start, ressize[<span class="hljs-number">4</span>]);<br>        <br>        val = readl(IMX6U_CCM_CCGR1);<br>        val &amp;= ~(<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">26</span>);                                <span class="hljs-comment">/* æ¸…é™¤ä»¥å‰çš„è®¾ç½® */</span><br>        val |= (<span class="hljs-number">3</span> &lt;&lt; <span class="hljs-number">26</span>);                                <span class="hljs-comment">/* è®¾ç½®æ–°å€¼ */</span><br>        writel(val, IMX6U_CCM_CCGR1);<br><br>        <span class="hljs-comment">/* è®¾ç½®GPIO1_IO03å¤ç”¨åŠŸèƒ½ï¼Œå°†å…¶å¤ç”¨ä¸ºGPIO1_IO03 */</span><br>        writel(<span class="hljs-number">5</span>, SW_MUX_GPIO1_IO03);<br>        writel(<span class="hljs-number">0x10B0</span>, SW_PAD_GPIO1_IO03);<br><br>        <span class="hljs-comment">/* è®¾ç½®GPIO1_IO03ä¸ºè¾“å‡ºåŠŸèƒ½ */</span><br>        val = readl(GPIO1_GDIR);<br>        val &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);                        <span class="hljs-comment">/* æ¸…é™¤ä»¥å‰çš„è®¾ç½® */</span><br>        val |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);                        <span class="hljs-comment">/* è®¾ç½®ä¸ºè¾“å‡º */</span><br>        writel(val, GPIO1_GDIR);<br><br>        <span class="hljs-comment">/* é»˜è®¤å…³é—­LED1 */</span><br>        val = readl(GPIO1_DR);<br>        val |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>) ;        <br>        writel(val, GPIO1_DR);<br>        <br>        <span class="hljs-comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ */</span><br>        <span class="hljs-comment">/*1ã€åˆ›å»ºè®¾å¤‡å· */</span><br>        <span class="hljs-keyword">if</span> (leddev.major) &#123;                <span class="hljs-comment">/*  å®šä¹‰äº†è®¾å¤‡å· */</span><br>                leddev.devid = MKDEV(leddev.major, <span class="hljs-number">0</span>);<br>                register_chrdev_region(leddev.devid, LEDDEV_CNT, LEDDEV_NAME);<br>        &#125; <span class="hljs-keyword">else</span> &#123;                                                <span class="hljs-comment">/* æ²¡æœ‰å®šä¹‰è®¾å¤‡å· */</span><br>                alloc_chrdev_region(&amp;leddev.devid, <span class="hljs-number">0</span>, LEDDEV_CNT, LEDDEV_NAME);        <span class="hljs-comment">/* ç”³è¯·è®¾å¤‡å· */</span><br>                leddev.major = MAJOR(leddev.devid);        <span class="hljs-comment">/* è·å–åˆ†é…å·çš„ä¸»è®¾å¤‡å· */</span><br>        &#125;<br>        <br>        <span class="hljs-comment">/* 2ã€åˆå§‹åŒ–cdev */</span><br>        leddev.cdev.owner = THIS_MODULE;<br>        cdev_init(&amp;leddev.cdev, &amp;led_fops);<br>        <br>        <span class="hljs-comment">/* 3ã€æ·»åŠ ä¸€ä¸ªcdev */</span><br>        cdev_add(&amp;leddev.cdev, leddev.devid, LEDDEV_CNT);<br><br>        <span class="hljs-comment">/* 4ã€åˆ›å»ºç±» */</span><br>        leddev.class = class_create(THIS_MODULE, LEDDEV_NAME);<br>        <span class="hljs-keyword">if</span> (IS_ERR(leddev.class)) &#123;<br>                <span class="hljs-keyword">return</span> PTR_ERR(leddev.class);<br>        &#125;<br><br>        <span class="hljs-comment">/* 5ã€åˆ›å»ºè®¾å¤‡ */</span><br>        leddev.device = device_create(leddev.class, <span class="hljs-literal">NULL</span>, leddev.devid, <span class="hljs-literal">NULL</span>, LEDDEV_NAME);<br>        <span class="hljs-keyword">if</span> (IS_ERR(leddev.device)) &#123;<br>                <span class="hljs-keyword">return</span> PTR_ERR(leddev.device);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *dev)</span><br>&#123;<br>    <span class="hljs-comment">/* å–æ¶ˆè™šæ‹Ÿåœ°å€æ˜ å°„ */</span><br>        iounmap(IMX6U_CCM_CCGR1);<br>        iounmap(SW_MUX_GPIO1_IO03);<br>        iounmap(SW_PAD_GPIO1_IO03);<br>        iounmap(GPIO1_DR);<br>        iounmap(GPIO1_GDIR);<br><br>        cdev_del(&amp;leddev.cdev); <span class="hljs-comment">/* åˆ é™¤cdev */</span><br>        unregister_chrdev_region(leddev.devid, LEDDEV_CNT); <span class="hljs-comment">/* æ³¨é”€è®¾å¤‡å· */</span><br>        device_destroy(leddev.class, leddev.devid);<br>        class_destroy(leddev.class);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* platformé©±åŠ¨ç»“æ„ä½“ */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">led_driver</span> =</span> &#123;<br>        .driver                = &#123;<br>                .name        = <span class="hljs-string">&quot;imx6ul-amx-led&quot;</span>,      <span class="hljs-comment">/* é©±åŠ¨åå­—ï¼Œç”¨äºå’Œè®¾å¤‡åŒ¹é… */</span><br>        &#125;,<br>        .probe                = led_probe,<br>        .remove                = led_remove,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">leddriver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> platform_driver_register(&amp;led_driver);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">leddriver_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        platform_driver_unregister(&amp;led_driver);<br>&#125;<br><br>module_init(leddriver_init);<br>module_exit(leddriver_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;anmuxixixi&quot;</span>);<br></code></pre></td></tr></table></figure><p><code>platledAPP.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;unistd.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sys/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sys/stat.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;fcntl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDOFF         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDON         1</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @description          : mainä¸»ç¨‹åº</span><br><span class="hljs-comment"> * @param - argc         : argvæ•°ç»„å…ƒç´ ä¸ªæ•°</span><br><span class="hljs-comment"> * @param - argv         : å…·ä½“å‚æ•°</span><br><span class="hljs-comment"> * @return               : 0 æˆåŠŸ;å…¶ä»– å¤±è´¥</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>        <span class="hljs-type">int</span> fd, retvalue;<br>        <span class="hljs-type">char</span> *filename;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> databuf[<span class="hljs-number">2</span>];<br>        <br>        <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">3</span>)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error Usage!\r\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        filename = argv[<span class="hljs-number">1</span>];<br><br>        <span class="hljs-comment">/* æ‰“å¼€ledé©±åŠ¨ */</span><br>        fd = open(filename, O_RDWR);<br>        <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;file %s open failed!\r\n&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <br>        databuf[<span class="hljs-number">0</span>] = atoi(argv[<span class="hljs-number">2</span>]);        <span class="hljs-comment">/* è¦æ‰§è¡Œçš„æ“ä½œï¼šæ‰“å¼€æˆ–å…³é—­ */</span><br>        retvalue = write(fd, databuf, <span class="hljs-keyword">sizeof</span>(databuf));<br>        <span class="hljs-keyword">if</span>(retvalue &lt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LED Control Failed!\r\n&quot;</span>);<br>                close(fd);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        retvalue = close(fd); <span class="hljs-comment">/* å…³é—­æ–‡ä»¶ */</span><br>        <span class="hljs-keyword">if</span>(retvalue &lt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;file %s close failed!\r\n&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/f557da58-4767-47d8-8f40-51ff98a7debb.png" alt="image-20230422183030672" style="zoom:67%;"><h3 id="3-2-è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨ç¼–å†™"><a href="#3-2-è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨ç¼–å†™" class="headerlink" title="3.2 è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨ç¼–å†™"></a>3.2 è®¾å¤‡æ ‘ä¸‹çš„platformé©±åŠ¨ç¼–å†™</h3><p><strong>1ã€åœ¨è®¾å¤‡æ ‘ä¸­åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</strong></p><p>ç›´æ¥ä½¿ç”¨<code>7.4.1</code>ä¸­çš„è®¾å¤‡æ ‘</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/267c8f85-c684-44e6-aacb-f3456432144d.png" alt="image-20230422183030672" style="zoom:67%;"><p>æ³¨æ„compatible å±æ€§å€¼ä¸ºâ€œfsl,gpioledâ€ï¼Œå› æ­¤ä¸€ä¼šåœ¨ç¼–å†™ platform é©±åŠ¨çš„æ—¶å€™ of_match_table å±æ€§è¡¨ä¸­è¦æœ‰â€œfsl,gpioledâ€ã€‚ </p><p><strong>2ã€ç¼–å†™ platform é©±åŠ¨çš„æ—¶å€™è¦æ³¨æ„å…¼å®¹å±æ€§</strong></p><p>ä¸Šä¸€ç« å·²ç»è¯¦ç»†çš„è®²è§£è¿‡äº†ï¼Œåœ¨ä½¿ç”¨è®¾å¤‡æ ‘çš„æ—¶å€™ platform é©±åŠ¨ä¼šé€šè¿‡ of_match_table æ¥ ä¿å­˜å…¼å®¹æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯è¡¨æ˜æ­¤é©±åŠ¨å…¼å®¹å“ªäº›è®¾å¤‡ã€‚æ‰€ä»¥ï¼Œof_match_table å°†ä¼šå°¤ä¸ºé‡è¦ï¼Œæ¯”å¦‚æœ¬ä¾‹ç¨‹çš„ platform é©±åŠ¨ä¸­ platform_driver å°±å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ‰€ç¤ºè®¾ç½®ï¼š</p><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422183516606.png" alt="image-20230422183516606" style="zoom:80%;"><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20230422183536714.png" alt="image-20230422183536714" style="zoom:80%;"><p>ç¬¬ 1~4 è¡Œï¼Œof_device_id è¡¨ï¼Œä¹Ÿå°±æ˜¯é©±åŠ¨çš„å…¼å®¹è¡¨ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ ä¸º of_device_id ç±»å‹ã€‚æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå…¼å®¹å±æ€§ï¼Œè¡¨ç¤ºå…¼å®¹çš„è®¾å¤‡ï¼Œä¸€ä¸ªé©±åŠ¨å¯ä»¥è·Ÿå¤šä¸ªè®¾å¤‡åŒ¹é…ã€‚è¿™é‡Œæˆ‘ä»¬ä»…ä»…åŒ¹é…äº†ä¸€ä¸ªè®¾å¤‡ï¼Œé‚£åˆ›å»ºçš„ gpioled è¿™ä¸ªè®¾å¤‡ã€‚ç¬¬ 2 è¡Œçš„ compatible å€¼ä¸ºâ€œatkalpha-gpioledâ€ï¼Œé©±åŠ¨ä¸­çš„ compatible å±æ€§å’Œè®¾å¤‡ä¸­çš„ compatible å±æ€§ç›¸åŒ¹é…ï¼Œå› æ­¤é©±åŠ¨ä¸­å¯¹åº”çš„ probe å‡½æ•°å°±ä¼šæ‰§è¡Œã€‚æ³¨æ„ç¬¬ 3 è¡Œæ˜¯ä¸€ä¸ªç©ºå…ƒç´ ï¼Œåœ¨ç¼–å†™ of_device_id çš„æ—¶å€™æœ€åä¸€ä¸ªå…ƒç´ ä¸€å®šè¦ä¸ºç©ºï¼ </p><p>ç¬¬ 6 è¡Œï¼Œé€šè¿‡ MODULE_DEVICE_TABLE å£°æ˜ä¸€ä¸‹ leds_of_match è¿™ä¸ªè®¾å¤‡åŒ¹é…è¡¨ã€‚ </p><p>ç¬¬ 11 è¡Œï¼Œè®¾ç½® platform_driver ä¸­çš„ of_match_table åŒ¹é…è¡¨ä¸ºä¸Šé¢åˆ›å»ºçš„ leds_of_matchï¼Œè‡³æ­¤æˆ‘ä»¬å°±è®¾ç½®å¥½äº† platform é©±åŠ¨çš„åŒ¹é…è¡¨äº†ã€‚</p><p><strong>3ã€ç¼–å†™ platform é©±åŠ¨</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/ide.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/of_gpio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/timer.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/irq.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/mach/map.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/io.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDDEV_CNT                 1               <span class="hljs-comment">/* è®¾å¤‡å·é•¿åº¦ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDDEV_NAME                <span class="hljs-string">&quot;dtsplatled&quot;</span>    <span class="hljs-comment">/* è®¾å¤‡åå­— */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDOFF                     0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEDON                      1</span><br><br><span class="hljs-comment">/* leddevè®¾å¤‡ç»“æ„ä½“ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">leddev_dev</span>&#123;</span><br>        <span class="hljs-type">dev_t</span> devid;                                <span class="hljs-comment">/* è®¾å¤‡å· */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">cdev</span>;</span>                        <span class="hljs-comment">/* cdev */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span> *<span class="hljs-keyword">class</span>;</span>                <span class="hljs-comment">/* ç±» */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">device</span>;</span>                <span class="hljs-comment">/* è®¾å¤‡ */</span><br>        <span class="hljs-type">int</span> major;                                        <span class="hljs-comment">/* ä¸»è®¾å¤‡å· */</span>        <br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_node</span> *<span class="hljs-title">node</span>;</span>        <span class="hljs-comment">/* LEDè®¾å¤‡èŠ‚ç‚¹ */</span><br>        <span class="hljs-type">int</span> led0;                                        <span class="hljs-comment">/* LEDç¯GPIOæ ‡å· */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">leddev_dev</span> <span class="hljs-title">leddev</span>;</span>                 <span class="hljs-comment">/* ledè®¾å¤‡ */</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">led0_switch</span><span class="hljs-params">(u8 sta)</span><br>&#123;<br>        <span class="hljs-keyword">if</span> (sta == LEDON )<br>        gpio_set_value(leddev.led0, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sta == LEDOFF)<br>                gpio_set_value(leddev.led0, <span class="hljs-number">1</span>);        <br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *filp)</span><br>&#123;<br>        filp-&gt;private_data = &amp;leddev; <span class="hljs-comment">/* è®¾ç½®ç§æœ‰æ•°æ®  */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">led_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> cnt, <span class="hljs-type">loff_t</span> *offt)</span><br>&#123;<br>        <span class="hljs-type">int</span> retvalue;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> databuf[<span class="hljs-number">2</span>];<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ledstat;<br><br>        retvalue = copy_from_user(databuf, buf, cnt);<br>        <span class="hljs-keyword">if</span>(retvalue &lt; <span class="hljs-number">0</span>) &#123;<br><br>                printk(<span class="hljs-string">&quot;kernel write failed!\r\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> -EFAULT;<br>        &#125;<br>        <br>        ledstat = databuf[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (ledstat == LEDON) &#123;<br>                led0_switch(LEDON);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ledstat == LEDOFF) &#123;<br>                led0_switch(LEDOFF);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* è®¾å¤‡æ“ä½œå‡½æ•° */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">led_fops</span> =</span> &#123;<br>        .owner = THIS_MODULE,<br>        .open = led_open,<br>        .write = led_write,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *dev)</span><br>&#123;        <br>        printk(<span class="hljs-string">&quot;led driver and device was matched!\r\n&quot;</span>);<br>        <span class="hljs-comment">/* 1ã€è®¾ç½®è®¾å¤‡å· */</span><br>        <span class="hljs-keyword">if</span> (leddev.major) &#123;<br>                leddev.devid = MKDEV(leddev.major, <span class="hljs-number">0</span>);<br>                register_chrdev_region(leddev.devid, LEDDEV_CNT, LEDDEV_NAME);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                alloc_chrdev_region(&amp;leddev.devid, <span class="hljs-number">0</span>, LEDDEV_CNT, LEDDEV_NAME);<br>                leddev.major = MAJOR(leddev.devid);<br>        &#125;<br><br>        <span class="hljs-comment">/* 2ã€æ³¨å†Œè®¾å¤‡ */</span><br>        cdev_init(&amp;leddev.cdev, &amp;led_fops);<br>        cdev_add(&amp;leddev.cdev, leddev.devid, LEDDEV_CNT);<br><br>        <span class="hljs-comment">/* 3ã€åˆ›å»ºç±» */</span><br>        leddev.class = class_create(THIS_MODULE, LEDDEV_NAME);<br>        <span class="hljs-keyword">if</span> (IS_ERR(leddev.class)) &#123;<br>                <span class="hljs-keyword">return</span> PTR_ERR(leddev.class);<br>        &#125;<br><br>        <span class="hljs-comment">/* 4ã€åˆ›å»ºè®¾å¤‡ */</span><br>        leddev.device = device_create(leddev.class, <span class="hljs-literal">NULL</span>, leddev.devid, <span class="hljs-literal">NULL</span>, LEDDEV_NAME);<br>        <span class="hljs-keyword">if</span> (IS_ERR(leddev.device)) &#123;<br>                <span class="hljs-keyword">return</span> PTR_ERR(leddev.device);<br>        &#125;<br><br>        <span class="hljs-comment">/* 5ã€åˆå§‹åŒ–IO */</span><br>        leddev.node = of_find_node_by_path(<span class="hljs-string">&quot;/gpioled&quot;</span>);<br>        <span class="hljs-keyword">if</span> (leddev.node == <span class="hljs-literal">NULL</span>)&#123;<br>                printk(<span class="hljs-string">&quot;gpioled node nost find!\r\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> -EINVAL;<br>        &#125; <br>        <br>        leddev.led0 = of_get_named_gpio(leddev.node, <span class="hljs-string">&quot;led-gpio&quot;</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (leddev.led0 &lt; <span class="hljs-number">0</span>) &#123;<br>                printk(<span class="hljs-string">&quot;can&#x27;t get led-gpio\r\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> -EINVAL;<br>        &#125;<br><br>        gpio_request(leddev.led0, <span class="hljs-string">&quot;led0&quot;</span>);<br>        gpio_direction_output(leddev.led0, <span class="hljs-number">1</span>); <span class="hljs-comment">/* led0 IOè®¾ç½®ä¸ºè¾“å‡ºï¼Œé»˜è®¤é«˜ç”µå¹³        */</span><br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">led_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *dev)</span><br>&#123;<br>        printk(<span class="hljs-string">&quot;led remove\r\n&quot;</span>);<br>        gpio_set_value(leddev.led0, <span class="hljs-number">1</span>);         <span class="hljs-comment">/* å¸è½½é©±åŠ¨çš„æ—¶å€™å…³é—­LED */</span><br>        gpio_free(leddev.led0);                                <span class="hljs-comment">/* é‡Šæ”¾IO */</span><br><br>        cdev_del(&amp;leddev.cdev);                                <span class="hljs-comment">/*  åˆ é™¤cdev */</span><br>        unregister_chrdev_region(leddev.devid, LEDDEV_CNT); <span class="hljs-comment">/* æ³¨é”€è®¾å¤‡å· */</span><br>        device_destroy(leddev.class, leddev.devid);<br>        class_destroy(leddev.class);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* åŒ¹é…åˆ—è¡¨ */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">of_device_id</span> <span class="hljs-title">led_of_match</span>[] =</span> &#123;<br>        &#123; .compatible = <span class="hljs-string">&quot;fsl,gpioled&quot;</span>&#125;,<br>        &#123; <span class="hljs-comment">/* Sentinel */</span> &#125;,<br>&#125;;<br><br><span class="hljs-comment">/* platformé©±åŠ¨ç»“æ„ä½“ */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">led_driver</span> =</span> &#123;<br>        .driver = &#123;<br>                .name = <span class="hljs-string">&quot;imx6ul-amx-led&quot;</span>,      <span class="hljs-comment">/* é©±åŠ¨åå­—ï¼Œç”¨äºå’Œè®¾å¤‡åŒ¹é… */</span><br>                .of_match_table = led_of_match, <span class="hljs-comment">/* è®¾å¤‡æ ‘åŒ¹é…è¡¨ */</span><br>        &#125;,<br>        .probe = led_probe,<br>        .remove = led_remove,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">dtsleddriver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> platform_driver_register(&amp;led_driver);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">dtsleddriver_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        platform_driver_unregister(&amp;led_driver);<br>&#125;<br><br>module_init(dtsleddriver_init);<br>module_exit(dtsleddriver_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;anmuxixixi&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/2023/04/22/Linux%E9%A9%B1%E5%8A%A8%E2%80%94%E2%80%94platform%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/fde6442f-8f21-42ad-9a4d-c5e7f2f9d54e.png" alt="image-20230422183030672" style="zoom:67%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
      <category>linuxé©±åŠ¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxè®¾å¤‡æ¨¡å‹ä¹‹äºŒ:sysfs</title>
    <link href="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%8C-sysfs/"/>
    <url>/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%8C-sysfs/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxè®¾å¤‡æ¨¡å‹ä¹‹äºŒ-sysfs"><a href="#Linuxè®¾å¤‡æ¨¡å‹ä¹‹äºŒ-sysfs" class="headerlink" title="Linuxè®¾å¤‡æ¨¡å‹ä¹‹äºŒ:sysfs"></a>Linuxè®¾å¤‡æ¨¡å‹ä¹‹äºŒ:sysfs</h1><blockquote><p>è½¬è½½è‡ªï¼š<a href="http://www.wowotech.net/device_model/dm_sysfs.html">http://www.wowotech.net/device_model/dm_sysfs.html</a></p><p>ä½œä¸ºè‡ªå·±çš„å­¦ä¹ ç¬”è®°</p></blockquote><p><strong>Sysfs</strong> æ˜¯Linux 2.6æ‰€æä¾›çš„ä¸€ç§è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸ä»…å¯ä»¥æŠŠè®¾å¤‡ï¼ˆdevicesï¼‰å’Œé©±åŠ¨ç¨‹åºï¼ˆdriversï¼‰çš„ä¿¡æ¯ä»å†…æ ¸è¾“å‡ºåˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å¯¹è®¾å¤‡å’Œé©±åŠ¨ç¨‹åºåšè®¾ç½®ã€‚</p><h2 id="1-åˆè¯†sys-æ–‡ä»¶ç³»ç»Ÿ"><a href="#1-åˆè¯†sys-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.åˆè¯†sys æ–‡ä»¶ç³»ç»Ÿ"></a>1.åˆè¯†sys æ–‡ä»¶ç³»ç»Ÿ</h2><p>ç®€å•çš„è¯´ï¼Œsysfsæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å†…æ ¸ä¿¡æ¯ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ã€‚</p><p>sysfså¯ä»¥çœ‹æˆä¸proc,devfså’ŒdevptyåŒç±»åˆ«çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¥æ–‡ä»¶ç³»ç»Ÿæ˜¯è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æ›´æ–¹ä¾¿å¯¹ç³»ç»Ÿè®¾å¤‡è¿›è¡Œç®¡ç†ã€‚å®ƒå¯ä»¥äº§ç”Ÿä¸€ä¸ªåŒ…å«æ‰€æœ‰ç³»ç»Ÿç¡¬ä»¶å±‚æ¬¡è§†å›¾ï¼Œä¸æä¾›è¿›ç¨‹å’ŒçŠ¶æ€ä¿¡æ¯çš„procæ–‡ä»¶ç³»ç»Ÿååˆ†ç±»ä¼¼ã€‚</p><p>sysfsæŠŠè¿æ¥åœ¨ç³»ç»Ÿä¸Šçš„è®¾å¤‡å’Œæ€»çº¿ç»„ç»‡æˆä¸ºä¸€ä¸ªåˆ†çº§çš„æ–‡ä»¶ï¼Œå®ƒä»¬å¯ä»¥ç”±ç”¨æˆ·ç©ºé—´å­˜å–ï¼Œå‘ç”¨æˆ·ç©ºé—´å¯¼å‡ºå†…æ ¸çš„æ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬çš„å±æ€§ã€‚sysfsçš„ä¸€ä¸ªç›®çš„å°±æ˜¯å±•ç¤ºè®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­å„ç»„ä»¶çš„å±‚æ¬¡å…³ç³»ï¼Œå…¶é¡¶çº§ç›®å½•åŒ…æ‹¬block,bus,drivers,class,powerå’Œfirmwareç­‰.</p><p>sysfsæä¾›ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—å¯ä»¥æ˜¾å¼çš„æè¿°å†…æ ¸å¯¹è±¡ã€å¯¹è±¡å±æ€§åŠå¯¹è±¡é—´å…³ç³»ã€‚sysfsæœ‰ä¸¤ç»„æ¥å£ï¼Œä¸€ç»„é’ˆå¯¹å†…æ ¸ï¼Œç”¨äºå°†è®¾å¤‡æ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¦ä¸€ç»„é’ˆå¯¹ç”¨æˆ·ç¨‹åºï¼Œç”¨äºè¯»å–æˆ–æ“ä½œè¿™äº›è®¾å¤‡ã€‚ä¸‹è¡¨æè¿°äº†å†…æ ¸ä¸­çš„sysfsè¦ç´ åŠå…¶åœ¨ç”¨æˆ·ç©ºé—´çš„è¡¨ç°ï¼š</p><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%8C-sysfs/image-20230416210112684.png" alt="image-20230416210112684" style="zoom:80%;"><h2 id="2-sysfs-ä¸-x2F-sys"><a href="#2-sysfs-ä¸-x2F-sys" class="headerlink" title="2.sysfs ä¸ &#x2F;sys"></a>2.sysfs ä¸ &#x2F;sys</h2><p>sysfs æ–‡ä»¶ç³»ç»Ÿæ€»æ˜¯è¢«æŒ‚è½½åœ¨ &#x2F;sys æŒ‚è½½ç‚¹ä¸Šã€‚è™½ç„¶åœ¨è¾ƒæ—©æœŸçš„2.6å†…æ ¸ç³»ç»Ÿä¸Šå¹¶æ²¡æœ‰è§„å®š sysfs çš„æ ‡å‡†æŒ‚è½½ä½ç½®ï¼Œå¯ä»¥æŠŠ sysfs æŒ‚è½½åœ¨ä»»ä½•ä½ç½®ï¼Œä½†è¾ƒè¿‘çš„2.6å†…æ ¸ä¿®æ­£äº†è¿™ä¸€è§„åˆ™ï¼Œè¦æ±‚ <strong>sysfs æ€»æ˜¯æŒ‚è½½åœ¨ &#x2F;sys ç›®å½•</strong>ä¸Šã€‚</p><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%BA%8C-sysfs/webp" alt="img" style="zoom:100%;"><h2 id="3-sysfså’ŒKobjectçš„å…³ç³»"><a href="#3-sysfså’ŒKobjectçš„å…³ç³»" class="headerlink" title="3.sysfså’ŒKobjectçš„å…³ç³»"></a>3.sysfså’ŒKobjectçš„å…³ç³»</h2><p>æ¯ä¸€ä¸ªKobjectï¼Œéƒ½ä¼šå¯¹åº”sysfsä¸­çš„ä¸€ä¸ªç›®å½•ã€‚å› æ­¤åœ¨å°†Kobjectæ·»åŠ åˆ°Kernelæ—¶ï¼Œcreate_diræ¥å£ä¼šè°ƒç”¨sysfsæ–‡ä»¶ç³»ç»Ÿçš„åˆ›å»ºç›®å½•æ¥å£ï¼Œåˆ›å»ºå’ŒKobjectå¯¹åº”çš„ç›®å½•ï¼Œç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//lib/kobject.c </span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">create_dir</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobj)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_type</span> *<span class="hljs-title">ktype</span> =</span> get_ktype(kobj);<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_ns_type_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">int</span> error;<br><br>error = sysfs_create_dir_ns(kobj, kobject_namespace(kobj));<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">return</span> error;<br><br>error = populate_dir(kobj);<br><span class="hljs-keyword">if</span> (error) &#123;<br>sysfs_remove_dir(kobj);<br><span class="hljs-keyword">return</span> error;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ktype) &#123;<br>error = sysfs_create_groups(kobj, ktype-&gt;default_groups);<br><span class="hljs-keyword">if</span> (error) &#123;<br>sysfs_remove_dir(kobj);<br><span class="hljs-keyword">return</span> error;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @kobj-&gt;sd may be deleted by an ancestor going away.  Hold an</span><br><span class="hljs-comment"> * extra reference so that it stays until @kobj is gone.</span><br><span class="hljs-comment"> */</span><br>sysfs_get(kobj-&gt;sd);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If @kobj has ns_ops, its children need to be filtered based on</span><br><span class="hljs-comment"> * their namespace tags.  Enable namespace support on @kobj-&gt;sd.</span><br><span class="hljs-comment"> */</span><br>ops = kobj_child_ns_ops(kobj);<br><span class="hljs-keyword">if</span> (ops) &#123;<br>BUG_ON(ops-&gt;type &lt;= KOBJ_NS_TYPE_NONE);<br>BUG_ON(ops-&gt;type &gt;= KOBJ_NS_TYPES);<br>BUG_ON(!kobj_ns_type_registered(ops-&gt;type));<br><br>sysfs_enable_ns(kobj-&gt;sd);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="4-attribute"><a href="#4-attribute" class="headerlink" title="4.attribute"></a>4.attribute</h2><h3 id="4-1-attributeçš„åŠŸèƒ½æ¦‚è¿°"><a href="#4-1-attributeçš„åŠŸèƒ½æ¦‚è¿°" class="headerlink" title="4.1 attributeçš„åŠŸèƒ½æ¦‚è¿°"></a>4.1 attributeçš„åŠŸèƒ½æ¦‚è¿°</h3><p>åœ¨sysfsä¸­ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰attributeçš„æ¦‚å¿µå‘¢ï¼Ÿå…¶å®å®ƒæ˜¯å¯¹åº”kobjectè€Œè¨€çš„ï¼ŒæŒ‡çš„æ˜¯kobjectçš„â€œå±æ€§â€ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œsysfsä¸­çš„ç›®å½•æè¿°äº†kobjectï¼Œè€Œkobjectæ˜¯ç‰¹å®šæ•°æ®ç±»å‹å˜é‡ï¼ˆå¦‚struct deviceï¼‰çš„ä½“ç°ã€‚å› æ­¤kobjectçš„å±æ€§ï¼Œå°±æ˜¯è¿™äº›å˜é‡çš„å±æ€§ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ï¼Œåç§°ã€ä¸€ä¸ªå†…éƒ¨å˜é‡ã€ä¸€ä¸ªå­—ç¬¦ä¸²ç­‰ç­‰ã€‚è€Œattributeï¼Œåœ¨sysfsæ–‡ä»¶ç³»ç»Ÿä¸­æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼æä¾›çš„ï¼Œå³ï¼škobjectçš„æ‰€æœ‰å±æ€§ï¼Œéƒ½åœ¨å®ƒå¯¹åº”çš„sysfsç›®å½•ä¸‹ä»¥æ–‡ä»¶çš„å½¢å¼å‘ˆç°ã€‚è¿™äº›æ–‡ä»¶ä¸€èˆ¬æ˜¯å¯è¯»ã€å†™çš„ï¼Œè€Œkernelä¸­å®šä¹‰äº†è¿™äº›å±æ€§çš„æ¨¡å—ï¼Œä¼šæ ¹æ®ç”¨æˆ·ç©ºé—´çš„è¯»å†™æ“ä½œï¼Œè®°å½•å’Œè¿”å›è¿™äº›attributeçš„å€¼ã€‚</p><p><strong>æ€»ç»“ä¸€ä¸‹ï¼šæ‰€è°“çš„attibuteï¼Œå°±æ˜¯å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´è¿›è¡Œä¿¡æ¯äº¤äº’çš„ä¸€ç§æ–¹æ³•ã€‚ä¾‹å¦‚æŸä¸ªdriverå®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œå´å¸Œæœ›ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ä¿®æ”¹è¯¥å˜é‡ï¼Œä»¥æ§åˆ¶driverçš„è¿è¡Œè¡Œä¸ºï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¯¥å˜é‡ä»¥sysfs attributeçš„å½¢å¼å¼€æ”¾å‡ºæ¥ã€‚</strong></p><p>Linuxå†…æ ¸ä¸­ï¼Œattributeåˆ†ä¸ºæ™®é€šçš„attributeå’ŒäºŒè¿›åˆ¶attributeï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//include/linux/sysfs.h </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><span class="hljs-type">umode_t</span>mode;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span><br><span class="hljs-type">bool</span>ignore_lockdep:<span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock_class_key</span>*<span class="hljs-title">key</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock_class_key</span><span class="hljs-title">skey</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bin_attribute</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span><span class="hljs-title">attr</span>;</span><br><span class="hljs-type">size_t</span>size;<br><span class="hljs-type">void</span>*private;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *(*<span class="hljs-title">f_mapping</span>)(<span class="hljs-title">void</span>);</span><br><span class="hljs-type">ssize_t</span> (*read)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> kobject *, <span class="hljs-keyword">struct</span> bin_attribute *,<br><span class="hljs-type">char</span> *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">size_t</span>);<br><span class="hljs-type">ssize_t</span> (*write)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> kobject *, <span class="hljs-keyword">struct</span> bin_attribute *,<br> <span class="hljs-type">char</span> *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">size_t</span>);<br><span class="hljs-type">int</span> (*mmap)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> kobject *, <span class="hljs-keyword">struct</span> bin_attribute *attr,<br>    <span class="hljs-keyword">struct</span> vm_area_struct *vma);<br>&#125;;<br></code></pre></td></tr></table></figure><p>struct attributeä¸ºæ™®é€šçš„attributeï¼Œä½¿ç”¨è¯¥attributeç”Ÿæˆçš„sysfsæ–‡ä»¶ï¼Œåªèƒ½ç”¨å­—ç¬¦ä¸²çš„å½¢å¼è¯»å†™ï¼ˆåé¢ä¼šè¯´ä¸ºä»€ä¹ˆï¼‰ã€‚è€Œstruct bin_attributeåœ¨struct attributeçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†readã€writeç­‰å‡½æ•°ï¼Œå› æ­¤å®ƒæ‰€ç”Ÿæˆçš„sysfsæ–‡ä»¶å¯ä»¥ç”¨ä»»ä½•æ–¹å¼è¯»å†™ã€‚</p><p>è¯´å®ŒåŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬è¦é—®ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>Kernelæ€ä¹ˆæŠŠattributeå˜æˆsysfsä¸­çš„æ–‡ä»¶å‘¢ï¼Ÿ</li><li>ç”¨æˆ·ç©ºé—´å¯¹sysfsçš„æ–‡ä»¶è¿›è¡Œçš„è¯»å†™æ“ä½œï¼Œæ€ä¹ˆä¼ é€’ç»™Kernelå‘¢ï¼Ÿ</li></ul><p>ä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªè¿‡ç¨‹ã€‚</p><h3 id="4-2-attibuteæ–‡ä»¶çš„åˆ›å»º"><a href="#4-2-attibuteæ–‡ä»¶çš„åˆ›å»º" class="headerlink" title="4.2 attibuteæ–‡ä»¶çš„åˆ›å»º"></a>4.2 attibuteæ–‡ä»¶çš„åˆ›å»º</h3><p>åœ¨linuxå†…æ ¸ä¸­ï¼Œattibuteæ–‡ä»¶çš„åˆ›å»ºæ˜¯ç”±fs&#x2F;sysfs&#x2F;dir.c ä¸­sysfs_create_dir_nsæ¥å£å®Œæˆçš„ï¼Œè¯¥æ¥å£çš„å®ç°æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ï¼Œå¤§å¤šæ˜¯æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ“ä½œï¼Œå’Œè®¾å¤‡æ¨¡å‹æ²¡æœ‰å¤ªå¤šçš„å…³ç³»ï¼Œè¿™é‡Œå…ˆç•¥è¿‡ä¸æã€‚</p><h3 id="4-3-attibuteæ–‡ä»¶çš„readå’Œwrite"><a href="#4-3-attibuteæ–‡ä»¶çš„readå’Œwrite" class="headerlink" title="4.3 attibuteæ–‡ä»¶çš„readå’Œwrite"></a>4.3 attibuteæ–‡ä»¶çš„readå’Œwrite</h3><p>çœ‹åˆ°4.1ç« èŠ‚struct attributeçš„åŸå‹æ—¶ï¼Œä¹Ÿè®¸æˆ‘ä»¬ä¼šçŠ¯å˜€å’•ï¼Œè¯¥ç»“æ„å¾ˆç®€å•å•Šï¼Œnameè¡¨ç¤ºæ–‡ä»¶åç§°ï¼Œmodeè¡¨ç¤ºæ–‡ä»¶æ¨¡å¼ï¼Œå…¶å®ƒçš„å­—æ®µéƒ½æ˜¯å†…æ ¸ç”¨äºdebug Kernel Lockçš„ï¼Œé‚£æ–‡ä»¶æ“ä½œçš„æ¥å£åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><p>ä¸ç€æ€¥ï¼Œæˆ‘ä»¬å»fs&#x2F;sysfsç›®å½•ä¸‹çœ‹çœ‹sysfsç›¸å…³çš„ä»£ç é€»è¾‘ã€‚</p><p>æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œéƒ½ä¼šå®šä¹‰ä¸€ä¸ªstruct file_operationså˜é‡ï¼Œç”¨äºæè¿°æœ¬æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œæ¥å£ï¼Œsysfsä¹Ÿä¸ä¾‹å¤–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* kernfs read callback for regular sysfs files with pre-alloc */</span><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sysfs_kf_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kernfs_open_file *of, <span class="hljs-type">char</span> *buf,</span><br><span class="hljs-params">     <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> pos)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> *<span class="hljs-title">ops</span> =</span> sysfs_file_ops(of-&gt;kn);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> *<span class="hljs-title">kobj</span> =</span> of-&gt;kn-&gt;parent-&gt;priv;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If buf != of-&gt;prealloc_buf, we don&#x27;t know how</span><br><span class="hljs-comment"> * large it is, so cannot safely pass it to -&gt;show</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (pos || WARN_ON_ONCE(buf != of-&gt;prealloc_buf))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> ops-&gt;show(kobj, of-&gt;kn-&gt;priv, buf);<br>&#125;<br><br><span class="hljs-comment">/* kernfs write callback for regular sysfs files */</span><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sysfs_kf_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kernfs_open_file *of, <span class="hljs-type">char</span> *buf,</span><br><span class="hljs-params">      <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> pos)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> *<span class="hljs-title">ops</span> =</span> sysfs_file_ops(of-&gt;kn);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> *<span class="hljs-title">kobj</span> =</span> of-&gt;kn-&gt;parent-&gt;priv;<br><br><span class="hljs-keyword">if</span> (!count)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">return</span> ops-&gt;store(kobj, of-&gt;kn-&gt;priv, buf, count);<br>&#125;<br></code></pre></td></tr></table></figure><p>attributeæ–‡ä»¶çš„readæ“ä½œï¼Œä¼šç”±VFSè½¬åˆ°sysfs_file_operationsçš„readï¼ˆä¹Ÿå°±æ˜¯sysfs_read_fileï¼‰æ¥å£ä¸Šï¼Œè®©æˆ‘ä»¬å¤§æ¦‚çœ‹ä¸€ä¸‹è¯¥æ¥å£çš„å¤„ç†é€»è¾‘ã€‚</p><h2 id="5-sysfsåœ¨è®¾å¤‡æ¨¡å‹ä¸­çš„åº”ç”¨æ€»ç»“"><a href="#5-sysfsåœ¨è®¾å¤‡æ¨¡å‹ä¸­çš„åº”ç”¨æ€»ç»“" class="headerlink" title="5.sysfsåœ¨è®¾å¤‡æ¨¡å‹ä¸­çš„åº”ç”¨æ€»ç»“"></a>5.sysfsåœ¨è®¾å¤‡æ¨¡å‹ä¸­çš„åº”ç”¨æ€»ç»“</h2><p>è®©æˆ‘ä»¬é€šè¿‡è®¾å¤‡æ¨¡å‹class.cä¸­æœ‰å…³sysfsçš„å®ç°ï¼Œæ¥æ€»ç»“ä¸€ä¸‹sysfsçš„åº”ç”¨æ–¹å¼ã€‚</p><p>é¦–å…ˆï¼Œåœ¨class.cä¸­ï¼Œå®šä¹‰äº†Classæ‰€éœ€çš„ktypeä»¥åŠsysfs_opsç±»å‹çš„å˜é‡ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//drivers/base/class.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> <span class="hljs-title">class_sysfs_ops</span> =</span> &#123;<br>.show   = class_attr_show,<br>.store   = class_attr_store,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_type</span> <span class="hljs-title">class_ktype</span> =</span> &#123;<br>.sysfs_ops= &amp;class_sysfs_ops,<br>.release= class_release,<br>.child_ns_type= class_child_ns_type,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ‰€æœ‰class_typeçš„Kobjectä¸‹é¢çš„attributeæ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œéƒ½ä¼šäº¤ç»™class_attr_showå’Œclass_attr_storeä¸¤ä¸ªæ¥å£å¤„ç†ã€‚ä»¥class_attr_showä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//drivers/base/class.c </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> to_class_attr(_attr) container_of(_attr, struct class_attribute, attr)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">class_attr_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobj, <span class="hljs-keyword">struct</span> attribute *attr,</span><br><span class="hljs-params">       <span class="hljs-type">char</span> *buf)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">class_attribute</span> *<span class="hljs-title">class_attr</span> =</span> to_class_attr(attr);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">subsys_private</span> *<span class="hljs-title">cp</span> =</span> to_subsys_private(kobj);<br><span class="hljs-type">ssize_t</span> ret = -EIO;<br><br><span class="hljs-keyword">if</span> (class_attr-&gt;show)<br>ret = class_attr-&gt;show(cp-&gt;class, class_attr, buf);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ¥å£ä½¿ç”¨container_ofä»struct attributeç±»å‹çš„æŒ‡é’ˆä¸­å–å¾—ä¸€ä¸ªclassæ¨¡å—çš„è‡ªå®šä¹‰æŒ‡é’ˆï¼šstruct class_attributeï¼Œè¯¥æŒ‡é’ˆä¸­åŒ…å«äº†classæ¨¡å—è‡ªèº«çš„showå’Œstoreæ¥å£ã€‚ä¸‹é¢æ˜¯struct class_attributeçš„å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//include/linux/device/class.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">class_attribute</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span> <span class="hljs-title">attr</span>;</span><br><span class="hljs-type">ssize_t</span> (*show)(<span class="hljs-keyword">struct</span> class *class, <span class="hljs-keyword">struct</span> class_attribute *attr,<br><span class="hljs-type">char</span> *buf);<br><span class="hljs-type">ssize_t</span> (*store)(<span class="hljs-keyword">struct</span> class *class, <span class="hljs-keyword">struct</span> class_attribute *attr,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> count);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å› æ­¤ï¼Œæ‰€æœ‰éœ€è¦ä½¿ç”¨attributeçš„æ¨¡å—ï¼Œéƒ½ä¸ä¼šç›´æ¥å®šä¹‰struct attributeå˜é‡ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œè¯¥æ•°æ®ç»“æ„çš„ä¸€ä¸ªæˆå‘˜æ˜¯struct attributeç±»å‹çš„å˜é‡ï¼Œå¹¶æä¾›showå’Œstoreå›è°ƒå‡½æ•°ã€‚ç„¶ååœ¨è¯¥æ¨¡å—ktypeæ‰€å¯¹åº”çš„struct sysfs_opså˜é‡ä¸­ï¼Œå®ç°è¯¥æœ¬æ¨¡å—æ•´ä½“çš„showå’Œstoreå‡½æ•°ï¼Œå¹¶åœ¨è¢«è°ƒç”¨æ—¶ï¼Œè½¬æ¥åˆ°è‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼ˆstruct class_attributeï¼‰ä¸­çš„showå’Œstoreå‡½æ•°ä¸­ã€‚è¿™æ ·ï¼Œæ¯ä¸ªatrributeæ–‡ä»¶ï¼Œå®é™…ä¸Šå¯¹åº”åˆ°ä¸€ä¸ªè‡ªå®šä¹‰æ•°æ®ç»“æ„å˜é‡ä¸­äº†ã€‚</strong></p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxè®¾å¤‡æ¨¡å‹ä¹‹ä¸€:Kobject</title>
    <link href="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/"/>
    <url>/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxè®¾å¤‡æ¨¡å‹ä¹‹ä¸€-Kobject"><a href="#Linuxè®¾å¤‡æ¨¡å‹ä¹‹ä¸€-Kobject" class="headerlink" title="Linuxè®¾å¤‡æ¨¡å‹ä¹‹ä¸€:Kobject"></a>Linuxè®¾å¤‡æ¨¡å‹ä¹‹ä¸€:Kobject</h1><p>æ¯ä¸€ä¸ªkobjectå¯¹è±¡éƒ½ä¼šå…³è”ä¸€ä¸ªsysfsæ–‡ä»¶ç›®å½•ï¼Œæœ¬èŠ‚é‡ç‚¹å…³æ³¨å¦‚ä½•å°†kobjectå¯¹è±¡ä¸sysfsæ–‡ä»¶ç³»ç»Ÿå…³è”èµ·æ¥ï¼Œå…³æ³¨kobjectå¯¹è±¡é»˜è®¤çš„å±æ€§æ–‡ä»¶æ“ä½œæ¥å£</p><h2 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1.æ•°æ®ç»“æ„"></a>1.æ•°æ®ç»“æ„</h2><h3 id="1-1-kobject"><a href="#1-1-kobject" class="headerlink" title="1.1 kobject"></a>1.1 kobject</h3><ul><li>kobjectä»£è¡¨å†…æ ¸å¯¹è±¡ï¼Œç»“æ„ä½“æœ¬èº«ä¸å•ç‹¬ä½¿ç”¨ï¼Œè€Œæ˜¯åµŒå¥—åœ¨å…¶ä»–é«˜å±‚ç»“æ„ä¸­ï¼Œç”¨äºç»„ç»‡æˆæ‹“æ‰‘å…³ç³»ï¼›</li><li>sysfsæ–‡ä»¶ç³»ç»Ÿä¸­ä¸€ä¸ªç›®å½•å¯¹åº”ä¸€ä¸ªkobject</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/kobject.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;       <span class="hljs-comment">// è®¾å¤‡çš„åå­—</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">entry</span>;</span>   <span class="hljs-comment">// ç”¨äºé“¾æ¥ç›®å½•</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span>*<span class="hljs-title">parent</span>;</span> <span class="hljs-comment">// çˆ¶äº²èŠ‚ç‚¹</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset</span>*<span class="hljs-title">kset</span>;</span>       <span class="hljs-comment">// æ‰€å±çš„kset</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_type</span>*<span class="hljs-title">ktype</span>;</span>  <span class="hljs-comment">// å¯¹åº”çš„ktypeæ“ä½œ</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kernfs_node</span>*<span class="hljs-title">sd</span>;</span>    <span class="hljs-comment">// è¯¥kobjectå¯¹è±¡åœ¨sysfsæ–‡ä»¶ç³»ç»Ÿä¸­æ‰€å¯¹åº”çš„æ–‡ä»¶ç›®å½•</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span><span class="hljs-title">kref</span>;</span>       <span class="hljs-comment">// å¼•ç”¨è®¡æ•°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_KOBJECT_RELEASE</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">delayed_work</span><span class="hljs-title">release</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> state_initialized:<span class="hljs-number">1</span>;   <span class="hljs-comment">// æ˜¯å¦åˆå§‹åŒ–æ ‡å¿—</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> state_in_sysfs:<span class="hljs-number">1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> state_add_uevent_sent:<span class="hljs-number">1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> state_remove_uevent_sent:<span class="hljs-number">1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> uevent_suppress:<span class="hljs-number">1</span>;<br>&#125;;<br><br></code></pre></td></tr></table></figure><p>kobjectåªæ˜¯ä¸€ä¸ªé€šç”¨å¯¹è±¡çš„è¡¨ç¤ºï¼ˆç±»ä¼¼C++ä¸­çš„åŸºç±»ï¼‰ï¼Œå®ƒæŠ½è±¡å‡ºä¸€äº›é€šç”¨çš„å±æ€§ï¼ˆå¦‚å¼•ç”¨è®¡æ•°ï¼‰ä»¥åŠé€šç”¨æ¥å£ï¼Œå®ƒé€šå¸¸æ˜¯è¢«å…¶ä»–æ•°æ®ç»“æ„ï¼ˆç»“æ„ä½“ï¼‰æ‰€åŒ…å«ï¼ˆç»§æ‰¿kobjectï¼‰ï¼Œè€Œæ¯ä¸ªå¤–å›´æ•°æ®ç»“æ„å„è‡ªå®Œæˆè¿™äº›æ¥å£çš„å†…éƒ¨å®ç°ï¼Œæ‰€ä»¥ä¼šè¡¨ç°å‡ºä¸åŒçš„å±æ€§ï¼Œå› æ­¤æˆ‘ä»¬æ›´å…³å¿ƒkobjectçš„å¤–å›´æ•°æ®æ¥å£ã€‚</p><h3 id="1-2-kset"><a href="#1-2-kset" class="headerlink" title="1.2 kset"></a>1.2 kset</h3><ul><li>ksetæ˜¯åŒ…å«å¤šä¸ªkobjectçš„é›†åˆï¼›</li><li>å¦‚æœéœ€è¦åœ¨sysfsçš„ç›®å½•ä¸­åŒ…å«å¤šä¸ªå­ç›®å½•ï¼Œé‚£éœ€è¦å°†å®ƒå®šä¹‰æˆä¸€ä¸ªksetï¼›</li><li>ksetç»“æ„ä½“ä¸­åŒ…å«struct kobjectå­—æ®µï¼Œå¯ä»¥ä½¿ç”¨è¯¥å­—æ®µé“¾æ¥åˆ°æ›´ä¸Šä¸€å±‚çš„ç»“æ„ï¼Œç”¨äºæ„å»ºæ›´å¤æ‚çš„æ‹“æ‰‘ç»“æ„ï¼›</li><li>sysfsä¸­çš„è®¾å¤‡ç»„ç»‡ç»“æ„å¾ˆå¤§ç¨‹åº¦ä¸Šæ ¹æ®ksetç»„ç»‡çš„ï¼Œ&#x2F;sys&#x2F;busç›®å½•å°±æ˜¯ä¸€ä¸ªksetå¯¹è±¡ï¼Œåœ¨Linuxè®¾å¤‡æ¨¡å‹ä¸­ï¼Œæ³¨å†Œè®¾å¤‡æˆ–é©±åŠ¨æ—¶å°±å°†kobjectæ·»åŠ åˆ°å¯¹åº”çš„ksetä¸­</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span> <span class="hljs-comment">//å±äºè¿™ä¸ªksetçš„kobjectä»¬çš„é“¾è¡¨</span><br><span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span> <span class="hljs-comment">//åµŒå…¥åˆ°è¯¥ksetçš„kobjectï¼Œè¯¥objå¯ä»¥ç”¨äºè¡¨ç¤ºè¯¥ksetå¯¹è±¡</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset_uevent_ops</span> *<span class="hljs-title">uevent_ops</span>;</span> <span class="hljs-comment">//å¤„ç†kobjectçš„è¯·æ±‚</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æƒ³ç»Ÿä¸€ç®¡ç†æœ‰äº›ç±»ä¼¼å±æ€§çš„kobjectsæ—¶ï¼Œå¯ä»¥å°†å®ƒä»¬åŠ å…¥åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œæ–¹ä¾¿è¿›è¡Œç®¡ç†ï¼Œæ¯”å¦‚å½“çƒ­æ’æ‹”äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥åˆ°è¯¥é›†åˆä¸­çš„æ‰€æœ‰kobjectsï¼›</p><hr><p>åœ¨linuxç³»ç»Ÿä¸­ï¼Œå½“ç³»ç»Ÿçš„ç¯å¢ƒå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚æ·»åŠ ksetåˆ°ç³»ç»Ÿï¼Œç§»åŠ¨kobjectéƒ½ä¼šä»å†…æ ¸ç©ºé—´å‘é€åˆ°ç”¨æˆ·æ§ä»¶ï¼Œè¿™ä¸ªæ˜¯çƒ­æ’æ‹”äº‹ä»¶ï¼Œé‚£ä¹ˆç›¸åº”çš„å¤„ç†ç¨‹åºä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ªå¤„ç†ç¨‹åºä¼šè°ƒç”¨åŠ è½½é©±åŠ¨ï¼Œåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ç­‰æ¥å“åº”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset_uevent_ops</span> &#123;</span><br>    <span class="hljs-type">int</span> (* <span class="hljs-type">const</span> filter)(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj);<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *(* <span class="hljs-type">const</span> name)(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj);<br>    <span class="hljs-type">int</span> (* <span class="hljs-type">const</span> uevent)(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj,<br>         <span class="hljs-keyword">struct</span> kobj_uevent_env *env);<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™ä¸‰ä¸ªå‡½æ•°æœ‰ä»€ä¹ˆä½œç”¨ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰</p><ol><li>filter:å†³å®šäº†æ˜¯å¦ä¼šå°†çƒ­æ’æ‹”äº‹ä»¶ä¼ é€’åˆ°ç”¨æˆ·æ§ä»¶ã€‚è¿”å›0ï¼Œä¸ä¼ é€’ï¼Œè¿”å›1ï¼Œä¼ é€’</li><li>name:ç”¨äºå°†å­—ç¬¦ä¸²ä¼ é€’ç»™ç”¨æˆ·æ§ä»¶çš„çƒ­æ’æ‹”å¤„ç†ç¨‹åº</li><li>uevent:å°†ç”¨æˆ·ç©ºé—´éœ€è¦çš„å‚æ•°æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚</li></ol><h3 id="1-3-ktype"><a href="#1-3-ktype" class="headerlink" title="1.3 ktype"></a>1.3 ktype</h3><ul><li>kobj_typeç”¨äºè¡¨å¾kobjectçš„ç±»å‹ï¼ŒæŒ‡å®šäº†åˆ é™¤kobjectæ—¶è¦è°ƒç”¨çš„å‡½æ•°ï¼Œkobjectç»“æ„ä½“ä¸­æœ‰struct krefå­—æ®µç”¨äºå¯¹kobjectè¿›è¡Œå¼•ç”¨è®¡æ•°ï¼Œ<u>å½“è®¡æ•°å€¼ä¸º0æ—¶ï¼Œå°±ä¼šè°ƒç”¨kobj_typeä¸­çš„releaseå‡½æ•°å¯¹kobjectè¿›è¡Œé‡Šæ”¾</u>ï¼Œè¿™ä¸ªå°±æœ‰ç‚¹ç±»ä¼¼äºC++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆäº†ï¼›</li><li>kobj_typeæŒ‡å®šäº†é€šè¿‡sysfsæ˜¾ç¤ºæˆ–ä¿®æ”¹æœ‰å…³kobjectçš„ä¿¡æ¯æ—¶è¦å¤„ç†çš„æ“ä½œï¼Œå®é™…æ˜¯è°ƒç”¨show&#x2F;storeå‡½æ•°ï¼›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*include/linux/kobject.h*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_type</span> &#123;</span><br><span class="hljs-comment">/* å¤„ç†å¯¹è±¡ç»ˆç»“çš„å›è°ƒå‡½æ•°ã€‚è¯¥æ¥å£åº”è¯¥ç”±å…·ä½“å¯¹è±¡è´Ÿè´£å¡«å……ã€‚ */</span><br><span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> kobject *kobj);<br><span class="hljs-comment">/* è¯¥ç±»å‹kobjçš„sysfsæ“ä½œæ¥å£ã€‚ */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> *<span class="hljs-title">sysfs_ops</span>;</span><br><span class="hljs-comment">/* è¯¥ç±»å‹kobjè‡ªå¸¦çš„ç¼ºçœå±æ€§ï¼ˆæ–‡ä»¶ï¼‰ï¼Œè¿™äº›å±æ€§æ–‡ä»¶åœ¨æ³¨å†Œkobjæ—¶ï¼Œç›´æ¥popä¸ºè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚ */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">default_groups</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_ns_type_operations</span> *(*<span class="hljs-title">child_ns_type</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> *<span class="hljs-title">kobj</span>);</span><br><span class="hljs-comment">/*child_ns_type/namespace æ˜¯ æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ç›¸å…³ï¼‰ç•¥*/</span><br><span class="hljs-type">const</span> <span class="hljs-type">void</span> *(*namespace)(<span class="hljs-keyword">struct</span> kobject *kobj);<br><span class="hljs-type">void</span> (*get_ownership)(<span class="hljs-keyword">struct</span> kobject *kobj, <span class="hljs-type">kuid_t</span> *uid, <span class="hljs-type">kgid_t</span> *gid);<br>&#125;;<br><br><span class="hljs-comment">/*include/linux/sysfs.h*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> &#123;</span><br><span class="hljs-type">ssize_t</span>(*show)(<span class="hljs-keyword">struct</span> kobject *, <span class="hljs-keyword">struct</span> attribute *, <span class="hljs-type">char</span> *);<br><span class="hljs-type">ssize_t</span>(*store)(<span class="hljs-keyword">struct</span> kobject *, <span class="hljs-keyword">struct</span> attribute *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">size_t</span>);<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><span class="hljs-type">umode_t</span>mode;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span><br><span class="hljs-type">bool</span>ignore_lockdep:<span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock_class_key</span>*<span class="hljs-title">key</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock_class_key</span><span class="hljs-title">skey</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="1-4-ç»“æ„å…³ç³»"><a href="#1-4-ç»“æ„å…³ç³»" class="headerlink" title="1.4 ç»“æ„å…³ç³»"></a>1.4 ç»“æ„å…³ç³»</h3><p>å°†ä¸Šé¢çš„æ•°æ®ç»“æ„æ‹¿ä¸€å¼ å›¾æ¥è¯´æ˜ï¼š</p><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/v2-be1ccc5fabbf8ff59e2838a48981f6ca_720w.webp" alt="img" style="zoom:100%;"><p>ä¸ºäº†æ›´å½¢è±¡çš„è¯´æ˜è¿™å‡ ä¸ªç»“æ„ä½“çš„å…³ç³»ï¼Œå†æ¥ä¸€å¼ å›¾ï¼š</p><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/490784b4d4adafe608af685e06803945519d316a.png@942w_596h_progressive.webp" alt="å›¾ç‰‡" style="zoom:80%;"><ul><li>ksetæ—¢æ˜¯kobjectçš„é›†åˆï¼Œæœ¬èº«åˆæ˜¯ä¸€ä¸ªkobjectï¼Œè¿›è€Œå¯ä»¥æ·»åŠ åˆ°å…¶ä»–çš„é›†åˆä¸­ï¼Œä»è€Œå°±å¯ä»¥æ„å»ºæˆå¤æ‚çš„æ‹“æ‰‘ç»“æ„ï¼Œæ»¡è¶³&#x2F;sysæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ç»„ç»‡éœ€æ±‚ï¼›</li></ul><h2 id="2-ç¤ºä¾‹"><a href="#2-ç¤ºä¾‹" class="headerlink" title="2.ç¤ºä¾‹"></a>2.ç¤ºä¾‹</h2><blockquote><p>å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/554838012">https://zhuanlan.zhihu.com/p/554838012</a></p></blockquote><h3 id="2-1-kobjectç¤ºä¾‹"><a href="#2-1-kobjectç¤ºä¾‹" class="headerlink" title="2.1 kobjectç¤ºä¾‹"></a>2.1 kobjectç¤ºä¾‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span>        <span class="hljs-comment">// module_init  module_exit</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span>          <span class="hljs-comment">// __init   __exit</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sysfs.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/stat.h&gt;</span> </span><br><br><span class="hljs-comment">//MODULE_xxxè¿™ç§å®ä½œç”¨æ˜¯ç”¨æ¥æ·»åŠ æ¨¡å—æè¿°ä¿¡æ¯</span><br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);                <span class="hljs-comment">// æè¿°æ¨¡å—çš„è®¸å¯è¯</span><br>MODULE_AUTHOR(<span class="hljs-string">&quot;pp&quot;</span>);                  <span class="hljs-comment">// æè¿°æ¨¡å—çš„ä½œè€…</span><br>MODULE_VERSION(<span class="hljs-string">&quot;0.1&quot;</span>);                <span class="hljs-comment">// æè¿°æ¨¡å—çš„ç‰ˆæœ¬</span><br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;module kobject&quot;</span>);   <span class="hljs-comment">// æè¿°æ¨¡å—çš„ä»‹ç»ä¿¡æ¯</span><br>MODULE_ALIAS(<span class="hljs-string">&quot;alias kobject&quot;</span>);          <span class="hljs-comment">// æè¿°æ¨¡å—çš„åˆ«åä¿¡æ¯</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">obj_test_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">kobj_test_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject,<span class="hljs-keyword">struct</span> attribute *attr,<span class="hljs-type">char</span> *buf)</span>;<br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">kobj_test_store</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject,<span class="hljs-keyword">struct</span> attribute *attr,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf,<span class="hljs-type">size_t</span> count)</span>;<br><br><br><span class="hljs-comment">//æ–‡ä»¶ï¼šæ–‡ä»¶å+æ–‡ä»¶æƒé™</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span> <span class="hljs-title">test_attr</span> =</span>&#123;<br>    .name = <span class="hljs-string">&quot;kobj_config&quot;</span>,<br>    .mode = S_IRWXUGO,<br>&#125;;<br><span class="hljs-comment">//å±æ€§(æŒ‡é’ˆæ•°ç»„),ä¸€ä¸ªæŒ‡é’ˆä»£ç ä¸€ä¸ªæ–‡ä»¶ï¼Œæœ‰å‡ ä¸ªä»£è¡¨å‡ ä¸ªæ–‡ä»¶</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute</span> *<span class="hljs-title">def_attrs</span>[]=</span>&#123;<br>    &amp;test_attr,<br>    <span class="hljs-literal">NULL</span>,<br>&#125;;<br><br><span class="hljs-comment">//è¯»å†™æ–‡ä»¶æ—¶ä¼šè°ƒç”¨show/storeæ–¹æ³•</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysfs_ops</span> <span class="hljs-title">obj_test_sysops</span> =</span> <br>&#123;<br>    .show = kobj_test_show,<br>    .store = kobj_test_store,<br>&#125;;<br><br><span class="hljs-comment">//important</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobj_type</span> <span class="hljs-title">ktype</span> =</span><br>&#123;<br>    .release = obj_test_release,<br>    .sysfs_ops =&amp;obj_test_sysops,<br>    .default_attrs = def_attrs,<br>&#125;;<br><br><span class="hljs-comment">//releaseå½“è®¡æ•°ä¸º0æ—¶è°ƒç”¨</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">obj_test_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;eric_test: release .\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//è¯»</span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">kobj_test_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject,<span class="hljs-keyword">struct</span> attribute *attr,<span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;have show.\n&quot;</span>);<br>    printk(<span class="hljs-string">&quot;attrname:%s.\n&quot;</span>,attr-&gt;name);<br>    <span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">&quot;%s\n&quot;</span>,attr-&gt;name);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">strlen</span>(attr-&gt;name)+<span class="hljs-number">2</span>;<br>&#125;<br><span class="hljs-comment">//å†™</span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">kobj_test_store</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kobject *kobject,<span class="hljs-keyword">struct</span> attribute *attr,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf,<span class="hljs-type">size_t</span> count)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;have store\n&quot;</span>);<br>    printk(<span class="hljs-string">&quot;write:%s\n&quot;</span>,buf);<br>    <span class="hljs-keyword">return</span> count;<br>&#125;<br><br><span class="hljs-comment">//</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span>  __init <span class="hljs-title function_">kobj_test_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;kobject test init.\n&quot;</span>);<br>    <span class="hljs-comment">//åˆå§‹åŒ–kobect,å¹¶å°†å…¶æ³¨å†Œåˆ°linuxç³»ç»Ÿ</span><br>    <span class="hljs-comment">//ktypeè®°å½•äº†kobjectå¯¹è±¡çš„å±æ€§å’ŒåŠ¨ä½œ</span><br>    <span class="hljs-comment">//NULLè¡¨ç¤ºåœ¨sysæ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç›®å½•åä¸ºkobject_test</span><br>    kobject_init_and_add(&amp;kobj,&amp;ktype,<span class="hljs-literal">NULL</span>,<span class="hljs-string">&quot;kobject_test&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit  <span class="hljs-title function_">kobj_test_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(<span class="hljs-string">&quot;kobject test exit.\n&quot;</span>);<br>    kobject_del(&amp;kobj);<br>&#125;<br><br>module_init(kobj_test_init);<br>module_exit(kobj_test_exit);<br></code></pre></td></tr></table></figure><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/v2-7c44487b5c3c07dc7f2b0873c75836fc_720w.webp" alt="img" style="zoom: 100%;"><h3 id="2-2-ksetç¤ºä¾‹"><a href="#2-2-ksetç¤ºä¾‹" class="headerlink" title="2.2 ksetç¤ºä¾‹"></a>2.2 ksetç¤ºä¾‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span>        <span class="hljs-comment">// module_init  module_exit</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span>          <span class="hljs-comment">// __init   __exit</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sysfs.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/stat.h&gt;</span> </span><br><br><span class="hljs-comment">//MODULE_xxxè¿™ç§å®ä½œç”¨æ˜¯ç”¨æ¥æ·»åŠ æ¨¡å—æè¿°ä¿¡æ¯</span><br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);                <span class="hljs-comment">// æè¿°æ¨¡å—çš„è®¸å¯è¯</span><br>MODULE_AUTHOR(<span class="hljs-string">&quot;pp&quot;</span>);                  <span class="hljs-comment">// æè¿°æ¨¡å—çš„ä½œè€…</span><br>MODULE_VERSION(<span class="hljs-string">&quot;0.1&quot;</span>);                <span class="hljs-comment">// æè¿°æ¨¡å—çš„ç‰ˆæœ¬</span><br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;module kset&quot;</span>);   <span class="hljs-comment">// æè¿°æ¨¡å—çš„ä»‹ç»ä¿¡æ¯</span><br>MODULE_ALIAS(<span class="hljs-string">&quot;alias kset&quot;</span>);          <span class="hljs-comment">// æè¿°æ¨¡å—çš„åˆ«åä¿¡æ¯</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset</span> <span class="hljs-title">kset_p</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset</span> <span class="hljs-title">kset_c</span>;</span><br><br><span class="hljs-comment">//äº‹ä»¶1ï¼šæœ€å…ˆè°ƒç”¨ï¼Œè‹¥è¿”å›0åˆ™äº‹ä»¶2,3ä¸è°ƒç”¨</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">kset_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj)</span><br>&#123;<br>        printk(<span class="hljs-string">&quot;Filter: kobj %s.\n&quot;</span>,kobj-&gt;name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-comment">//äº‹ä»¶2ï¼šè¿”å›bufåˆ°ç”¨æˆ·ç©ºé—´</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">kset_name</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj)</span><br>&#123;<br>        <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>];<br>        printk(<span class="hljs-string">&quot;Name: kobj %s.\n&quot;</span>,kobj-&gt;name);<br>        <span class="hljs-built_in">sprintf</span>(buf,<span class="hljs-string">&quot;%s&quot;</span>,<span class="hljs-string">&quot;kset_name&quot;</span>);<br>        <span class="hljs-keyword">return</span> buf;<br>&#125;<br><span class="hljs-comment">//äº‹ä»¶3ï¼šè¿”å›äº‹ä»¶åˆ°ç”¨æˆ·ç©ºé—´</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">kset_uevent</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kset *kset, <span class="hljs-keyword">struct</span> kobject *kobj,<span class="hljs-keyword">struct</span> kobj_uevent_env *env)</span><br>&#123;<br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>        printk(<span class="hljs-string">&quot;uevent: kobj %s.\n&quot;</span>,kobj-&gt;name);<br><br>        <span class="hljs-keyword">while</span>( i &lt; env-&gt;envp_idx)&#123;<br>                printk(<span class="hljs-string">&quot;%s.\n&quot;</span>,env-&gt;envp[i]);<br>                i++;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//å¯¹åŸºç±»ç›®å½•è¿›è¡Œç»‘å®šäº‹ä»¶</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kset_uevent_ops</span> <span class="hljs-title">uevent_ops</span> =</span> <br>&#123;<br>        .filter = kset_filter,<br>        .name   = kset_name,<br>        .uevent = kset_uevent,<br>&#125;;<br><br><span class="hljs-comment">////////////////////////</span><br><span class="hljs-comment">//åŸºç±»ç›®å½•åˆ›å»ºã€å­ç›®å½•åˆ›å»º</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">kset_test_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>        printk(<span class="hljs-string">&quot;kset test init.\n&quot;</span>);<br>        kobject_set_name(&amp;kset_p.kobj,<span class="hljs-string">&quot;kset_p&quot;</span>);<br>        <span class="hljs-comment">//è¯¥çˆ¶ç›®å½•æ·»åŠ äº‹ä»¶opsï¼Œå½“åœ¨è¯¥ç›®å½•ä¸‹æœ‰æ“ä½œæ—¶ä¾æ¬¡è°ƒç”¨:filterã€nameã€uevent</span><br>        kset_p.uevent_ops = &amp;uevent_ops; <br>        kset_register(&amp;kset_p);<br><br>        kobject_set_name(&amp;kset_c.kobj,<span class="hljs-string">&quot;kset_c&quot;</span>);<br>        <span class="hljs-comment">//æ ¸å¿ƒ:kset_cçš„ç›®å½•æ˜¯kset_p,è¯¥è¡Œä¸ºç”±äºå¯¹çˆ¶ç›®å½•æœ‰ç»“æ„çš„å˜åŒ–ä¼šè§¦å‘çƒ­æ’æ‹”äº‹ä»¶</span><br>        kset_c.kobj.kset = &amp;kset_p;<br>        kset_register(&amp;kset_c);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kset_test_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br><br>        <span class="hljs-title function_">printk</span><span class="hljs-params">(<span class="hljs-string">&quot;kset test exit.\n&quot;</span>)</span>;<br>        kset_unregister(&amp;kset_p);<br>        kset_unregister(&amp;kset_c);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>module_init(kset_test_init);<br>module_exit(kset_test_exit);<br></code></pre></td></tr></table></figure><img src="/2023/04/16/Linux%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%80-Kobject/v2-2d811337bd84748619c45bce0df52082_720w.webp" alt="img" style="zoom:100%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kconfigå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Kconfigå­¦ä¹ ç¬”è®°"><a href="#Kconfigå­¦ä¹ ç¬”è®°" class="headerlink" title="Kconfigå­¦ä¹ ç¬”è®°"></a>Kconfigå­¦ä¹ ç¬”è®°</h1><h2 id="1-menuconfigé…ç½®ç•Œé¢"><a href="#1-menuconfigé…ç½®ç•Œé¢" class="headerlink" title="1.menuconfigé…ç½®ç•Œé¢"></a>1.menuconfigé…ç½®ç•Œé¢</h2><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2021051320123770.png" alt="å†…æ ¸é€‰é¡¹é…ç½®ç•Œé¢" style="zoom: 67%;"><p><strong>1ã€å­èœå• â€”&gt;</strong></p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/20210513201339224.png" alt=" " style="zoom:80%;"><p>è¡¨ç¤ºæœ‰å­èœå•ï¼ŒæŒ‰ä¸‹å›è½¦å¯ä»¥è¿›å…¥å­èœå•ã€‚</p><p><strong>2ã€ä¸­æ‹¬å· []</strong></p><p>åœ¨æ¯ä¸€ä¸ªé€‰é¡¹å‰éƒ½æœ‰ä¸ªæ‹¬å·ï¼Œæœ‰çš„æ˜¯ä¸­æ‹¬å·ï¼Œæœ‰çš„æ˜¯å°–æ‹¬å·ï¼Œè¿˜æœ‰çš„æ˜¯åœ†æ‹¬å·ã€‚</p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/20210513201528165.png" alt=" " style="zoom:80%;"><p>[] è¡¨ç¤ºè¯¥é€‰é¡¹åªæœ‰ä¸¤ç§é€‰é¡¹ï¼Œä¸­æ‹¬å·ä¸­è¦ä¹ˆæ˜¯ç©ºï¼Œè¦ä¹ˆæ˜¯â€œ*â€ï¼›</p><blockquote><p>ä½¿ç”¨ â€œç©ºæ ¼â€ é”®è¿›è¡Œåˆ‡æ¢</p></blockquote><p><strong>3ã€å°–æ‹¬å· &lt;&gt;</strong></p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/20210513201546900.png" alt=" " style="zoom:80%;"><p>&lt;&gt;é€‰æ‹©ç›¸åº”çš„é…ç½®æ—¶ï¼Œæœ‰3ç§é€‰æ‹©ï¼Œå®ƒä»¬ä»£è¡¨çš„å«ä¹‰åˆ†åˆ«å¦‚ä¸‹ã€‚</p><blockquote><ul><li>*ï¼šå°†è¯¥åŠŸèƒ½ç¼–è¯‘è¿›å†…æ ¸ã€‚ </li><li>ç©ºï¼šä¸å°†è¯¥åŠŸèƒ½ç¼–è¯‘è¿›å†…æ ¸ã€‚ </li><li>Mï¼šå°†è¯¥åŠŸèƒ½ç¼–è¯‘æˆå¯ä»¥åœ¨éœ€è¦æ—¶åŠ¨æ€æ’å…¥åˆ°å†…æ ¸ä¸­çš„æ¨¡å—ã€‚</li></ul></blockquote><blockquote><p> ä½¿ç”¨ â€œç©ºæ ¼â€ é”®è¿›è¡Œåˆ‡æ¢</p></blockquote><p><strong>4ã€æ¨¡å—é…ç½®åœ†æ‹¬å· ()</strong></p><p>è€Œåœ†æ‹¬å·çš„å†…å®¹æ˜¯è¦ä½ åœ¨æ‰€æä¾›çš„å‡ ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ä¸€é¡¹ã€‚</p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/20210513202030189.png" alt=" " style="zoom:80%;"><h2 id="2-Kconfigè¯­æ³•"><a href="#2-Kconfigè¯­æ³•" class="headerlink" title="2.Kconfigè¯­æ³•"></a>2.Kconfigè¯­æ³•</h2><h3 id="2-1-Kconfigç±»å‹"><a href="#2-1-Kconfigç±»å‹" class="headerlink" title="2.1 Kconfigç±»å‹"></a>2.1 Kconfigç±»å‹</h3><p>é…ç½®é€‰é¡¹çš„ç±»å‹ï¼šâ€boolâ€&#x2F;â€œtristateâ€&#x2F;â€œstringâ€&#x2F;â€œhexâ€&#x2F;â€œintâ€</p><p>æ¯ä¸ªconfigèœå•é¡¹éƒ½è¦æœ‰ç±»å‹å®šä¹‰</p><ul><li>boolï¼šå¸ƒå°”ç±»å‹</li><li>tristateä¸‰æ€ï¼šå†…å»ºã€æ¨¡å—ã€ç§»é™¤</li><li>stringï¼šå­—ç¬¦ä¸²</li><li>hexï¼šåå…­è¿›åˆ¶</li><li>intï¼šæ•´å‹</li></ul><h3 id="2-2-mainmenu"><a href="#2-2-mainmenu" class="headerlink" title="2.2 mainmenu"></a>2.2 mainmenu</h3><p>é¡¾åæ€ä¹‰ mainmenu å°±æ˜¯ä¸»èœå•ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥â€œmake menuconfigâ€ä»¥åæ‰“å¼€çš„é»˜è®¤ç•Œé¢ï¼Œåœ¨é¡¶å±‚ Kconfig ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">mainmenu <span class="hljs-string">&quot;Linux/$ARCH $KERNELVERSION Kernel Configuration&quot;</span><br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>Linux/$ARCH $KERNELVERSION Kernel Configuration</code>çš„ä¸»èœå•ï¼Œå…¶ä¸­$ARCHä¸ºæˆ‘ä»¬è‡ªå·±exportæˆ–è€…å†™æ­»åœ¨é¡¶å±‚Makefileä¸­çš„ä¸º<code>arm</code>ï¼Œ$KERNELVERSION&#x3D;4.1.15ï¼Œå› æ­¤ä¸»èœå•åä¸º<code>Linux/arm 4.1.15 Kernel Configuration</code></p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230409165121922.png" alt="image-20230409165121922" style="zoom:80%;"><h3 id="2-3-è°ƒç”¨å…¶ä»–ç›®å½•ä¸‹çš„Kconfigæ–‡ä»¶"><a href="#2-3-è°ƒç”¨å…¶ä»–ç›®å½•ä¸‹çš„Kconfigæ–‡ä»¶" class="headerlink" title="2.3 è°ƒç”¨å…¶ä»–ç›®å½•ä¸‹çš„Kconfigæ–‡ä»¶"></a>2.3 è°ƒç”¨å…¶ä»–ç›®å½•ä¸‹çš„Kconfigæ–‡ä»¶</h3><p>å’Œ makefile ä¸€æ ·ï¼ŒKconfig ä¹Ÿå¯ä»¥è°ƒç”¨å…¶ä»–å­ç›®å½•ä¸­çš„ Kconfig æ–‡ä»¶ï¼Œè°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">source <span class="hljs-string">&quot;xxx/Kconfig&quot;</span> //xxx ä¸ºå…·ä½“çš„ç›®å½•åï¼Œç›¸å¯¹è·¯å¾„<br></code></pre></td></tr></table></figure><p>åœ¨é¡¶å±‚ Kconfig ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">source <span class="hljs-string">&quot;drivers/amx_drivers/Kconfig&quot;</span><br><br>source <span class="hljs-string">&quot;arch/$SRCARCH/Kconfig&quot;</span><br></code></pre></td></tr></table></figure><h3 id="2-4-menu-x2F-endemenuæ¡ç›®"><a href="#2-4-menu-x2F-endemenuæ¡ç›®" class="headerlink" title="2.4 menu&#x2F;endemenuæ¡ç›®"></a>2.4 menu&#x2F;endemenuæ¡ç›®</h3><p>menu ç”¨äºç”Ÿæˆèœå•ï¼Œendmenu å°±æ˜¯èœå•ç»“æŸæ ‡å¿—ï¼Œè¿™ä¸¤ä¸ªä¸€èˆ¬æ˜¯æˆå¯¹å‡ºç°çš„ã€‚åœ¨é¡¶å±‚<code>init/Kconfig</code> ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile">menu <span class="hljs-string">&quot;General setup&quot;</span><br><br>config BROKEN<br>bool<br><br>config BROKEN_ON_SMP<br>bool<br>depends on BROKEN || !SMP<br>default y<br><br><span class="hljs-comment"># ....</span><br><br>endmenu<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç å—å°±æ˜¯ä¸€ä¸ªå­èœå•ï¼Œç¬¬1è¡Œçš„<code>menu &quot;General setup</code>è¡¨ç¤ºè‡ªèœå•<code>General Setup</code></p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230409165838486.png" alt="image-20230409165838486" style="zoom:80%;"><h3 id="2-5-configæ¡ç›®"><a href="#2-5-configæ¡ç›®" class="headerlink" title="2.5 configæ¡ç›®"></a>2.5 configæ¡ç›®</h3><p>åœ¨ä¸€äº›<code>menu/endmenu</code> ä»£ç å—ä¸­æœ‰å¤§é‡çš„ <strong>config xxx</strong> ä»£ç å—ï¼Œä¹Ÿå°±æ˜¯configæ¡ç›®ã€‚</p><p>configåŸºæœ¬ç»“æ„ä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile">config option<br>    type <span class="hljs-string">&quot;xxx&quot;</span>       //ç®€å•æè¿°<br>    depends on xxx //ä¾èµ–é€‰é¡¹ï¼Œå¯é€‰<br>    default xxx      //åˆå§‹å€¼<br>    help              //å¸®åŠ©ä¿¡æ¯<br>        xxxxxxxxxxxxxxx<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥ä¸‹é¢çš„configä¸ºä¾‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile">config LOCALVERSION<br>string <span class="hljs-string">&quot;Local version - append to kernel release&quot;</span><br>help<br>  Append an extra string to the end of your kernel version.<br>  This will show up when you type uname, for example.<br>  The string you set here will be appended after the contents <br>  of any files with a filename matching localversion* in your<br>  object and source tree, in that order.  Your total string <br>  can be a maximum of 64 characters.<br>  <br>config LOCALVERSION_AUTO<br>bool <span class="hljs-string">&quot;Automatically append version information to the version string&quot;</span><br>default y<br></code></pre></td></tr></table></figure><p>configåé¢è·Ÿç€ <strong>LOCALVERSION</strong> å°±æ˜¯é…ç½®é¡¹åå­—ã€‚å‡å¦‚æˆ‘ä»¬æ˜¯èƒ½äº†LOCALVERSION è¿™ä¸ªåŠŸèƒ½ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨.config æ–‡ä»¶ä¸­ç”Ÿæˆ LOCALVERSIONã€‚</p><p>config å…³é”®å­—ä¸‹é¢çš„è¿™å‡ è¡Œæ˜¯é…ç½®é¡¹å±æ€§ã€‚å±æ€§é‡Œé¢æè¿°äº†é…ç½®é¡¹çš„ç±»å‹ã€è¾“å…¥æç¤ºã€ä¾èµ–å…³ç³»ã€å¸®åŠ©ä¿¡æ¯å’Œé»˜è®¤å€¼ç­‰ã€‚</p><ul><li>ç¬¬ä¸€è¡Œè¡¨ç¤ºLOCALVERSIONçš„å˜é‡ç±»å‹ä¸º string</li><li>ç¬¬äºŒè¡Œhelpè¡¨ç¤ºå¸®åŠ©ä¿¡æ¯ï¼Œå‘Šè¯‰æˆ‘ä»¬é…ç½®é¡¹çš„å«ä¹‰ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹â€œhâ€æˆ–â€œ?â€å¼¹å‡ºæ¥çš„å¸®åŠ©ç•Œé¢å°±æ˜¯ help çš„å†…å®¹ã€‚</li><li>LOCALVERSION_AUTOçš„ç¬¬ä¸€è¡Œè¡¨ç¤ºLOCALVERSION_AUTOæ˜¯boolç±»å‹ï¼Œå¯ä»¥é€šè¿‡ç©ºæ ¼é”® <strong>ä½¿èƒ½</strong> æˆ– <strong>ç¦æ­¢</strong> LOCALVERSION_AUTOã€‚</li><li>default y è¡¨ç¤º LOCALVERSION_AUTOçš„é»˜è®¤å€¼ä¸º <strong>y</strong>ï¼Œæ‰€ä»¥ä¸Šä¸€è¡Œä¼šé»˜è®¤é€‰ä¸­</li></ul><h3 id="2-6-depends-on-å’Œ-select"><a href="#2-6-depends-on-å’Œ-select" class="headerlink" title="2.6 depends on å’Œ select"></a>2.6 depends on å’Œ select</h3><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs make">config USER_RETURN_NOTIFIER<br>bool<br>depends on HAVE_USER_RETURN_NOTIFIER<br><br>config GPIO_ALTERA<br>tristate <span class="hljs-string">&quot;Altera GPIO&quot;</span><br>depends on OF_GPIO<br>select GPIO_GENERIC<br>select GPIOLIB_IRQCHIP<br></code></pre></td></tr></table></figure><ul><li>depend on è¯´æ˜ USER_RETURN_NOTIFIER ä¾èµ–äº HAVE_USER_RETURN_NOTIFIERã€‚ä¹Ÿå°±æ˜¯è¯´ HAVE_USER_RETURN_NOTIFIERé€‰ä¸­ä»¥å USER_RETURN_NOTIFIER æ‰èƒ½è¢«é€‰ä¸­</li><li>select è¡¨ç¤ºæ–¹å‘ä¾èµ–ï¼Œå½“é€‰ä¸­ GPIO_ALTERA ä»¥åï¼ŒGPIO_GENERICã€GPIOLIB_IRQCHIP è¿™ä¸¤ä¸ªé€‰ä¸­ä¹Ÿä¼šè¢«é€‰ä¸­</li></ul><h3 id="2-7-choice-x2F-endchoice"><a href="#2-7-choice-x2F-endchoice" class="headerlink" title="2.7 choice&#x2F;endchoice"></a>2.7 choice&#x2F;endchoice</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># arch\arm\Kconfig</span><br><br>choice<br>prompt <span class="hljs-string">&quot;ARM system type&quot;</span><br>default ARCH_VERSATILE if !MMU<br>default ARCH_MULTIPLATFORM if MMU<br><br>config ARCH_MULTIPLATFORM<br>bool <span class="hljs-string">&quot;Allow multiple platforms to be selected&quot;</span><br>depends on MMU<br>select ARCH_WANT_OPTIONAL_GPIOLIB<br>select ARM_HAS_SG_CHAIN<br><span class="hljs-comment"># ...</span><br><br>config ARCH_REALVIEW<br>bool <span class="hljs-string">&quot;ARM Ltd. RealView family&quot;</span><br>select ARCH_WANT_OPTIONAL_GPIOLIB<br>select PLAT_VERSATILE_SCHED_CLOCK<br><span class="hljs-comment"># ...</span><br>help<br>  This enables support for ARM Ltd RealView boards.<br>  <br>  <span class="hljs-comment">#.....</span><br>endchoice<br></code></pre></td></tr></table></figure><p>choice&#x2F;endchoice ä»£ç æ®µå®šä¹‰äº†ä¸€ç»„å¯é€‰æ‹©é¡¹ï¼Œå°†å¤šä¸ªç±»ä¼¼çš„é…ç½®é¡¹ç»„åˆåœ¨ä¸€èµ·ï¼Œä¾›ç”¨æˆ·å•é€‰æˆ–è€…å¤šé€‰ã€‚ä¸Šé¢çš„ç±»å‹å°±æ˜¯è®©ç”¨æˆ·é€‰æ‹©å¤„ç†å™¨æ¶æ„ï¼Œå¯ä»¥ä» ARCH_MULTIPLATFORMã€ARCH_REALVIEWä¸­è¿›è¡Œé€‰æ‹©ã€‚</p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230409172626588.png" alt="image-20230409172626588" style="zoom:80%;"><h3 id="2-8-menuconfig"><a href="#2-8-menuconfig" class="headerlink" title="2.8 menuconfig"></a>2.8 menuconfig</h3><p>menuconfig å’Œ menu å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯ menuconfig æ˜¯ä¸ªå¸¦é€‰é¡¹çš„èœå•ï¼Œå…¶ä¸€èˆ¬ç”¨æ³•ä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">menuconfig MODULES<br>bool <span class="hljs-string">&quot;èœå•&quot;</span><br>if MODULEs<br>...<br><span class="hljs-keyword">endif</span> <span class="hljs-comment"># MODULES</span><br></code></pre></td></tr></table></figure><p>ç¬¬ 1 è¡Œï¼Œå®šä¹‰äº†ä¸€ä¸ªå¯é€‰çš„èœå• MODULESï¼Œåªæœ‰é€‰ä¸­äº† MODULES ç¬¬ 3~5 è¡Œ if åˆ° endif ä¹‹é—´çš„å†…å®¹æ‰ä¼šæ˜¾ç¤ºã€‚åœ¨é¡¶å±‚ Kconfig ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs makefile">menuconfig INPUT_TOUCHSCREEN<br>bool <span class="hljs-string">&quot;Touchscreens&quot;</span><br>help<br>  Say Y here, and a list of supported touchscreens will be &#x27;<br>  displayed.This option doesn&#x27;t affect the kernel.<br>  If unsure, say Y.<br><br>if INPUT_TOUCHSCREEN<br><br>config OF_TOUCHSCREEN<br>def_tristate INPUT<br>depends on INPUT &amp;&amp; OF<br><br>config TOUCHSCREEN_88PM860X<br>tristate <span class="hljs-string">&quot;Marvell 88PM860x touchscreen&quot;</span><br>depends on MFD_88PM860X<br>help<br>  Say Y here if you have a 88PM860x PMIC and want to enable<br>  support for the built-in touchscreen.<br><span class="hljs-comment"># ...</span><br><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230409173721763.png" alt="image-20230409173721763" style="zoom:80%;"><p>Touchscreenså‰é¢æœ‰[]ï¼Œè¯´æ˜è¿™ä¸ªèœå•æ˜¯å¯é€‰çš„ï¼Œå½“é€‰ä¸­è¿™ä¸ªèœå•ä»¥åå°±å¯ä»¥è¿›å…¥åˆ°å­é€‰é¡¹ä¸­ã€‚</p><h3 id="2-6-comment"><a href="#2-6-comment" class="headerlink" title="2.6 comment"></a>2.6 comment</h3><p>commentç”¨äºæ³¨é‡Šï¼Œä¹Ÿå°±æ˜¯åœ¨å›¾å½¢åŒ–ç•Œé¢ä¸­æ˜¾ç¤ºä¸€è¡Œæ³¨é‡Š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># arch\arm\Kconfig</span><br><br>comment <span class="hljs-string">&quot;CPU Core family selection&quot;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥æ³¨é‡Šç‹¬å ä¸€è¡Œ</p><img src="/2023/04/09/Kconfig%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230409174046599.png" alt="image-20230409174046599" style="zoom:80%;"><h2 id="3-Kconfigé”®ç›˜æ“ä½œ"><a href="#3-Kconfigé”®ç›˜æ“ä½œ" class="headerlink" title="3.Kconfigé”®ç›˜æ“ä½œ"></a>3.Kconfigé”®ç›˜æ“ä½œ</h2><ol><li>ä¸¤ä¸‹ <code>ESC</code> è¿”å›ä¸Šä¸€çº§</li><li>æŒ‰<code>H</code> æˆ–è€… <code>?</code> å¯ä»¥æŸ¥çœ‹æç¤ºä¿¡æ¯</li><li>æŒ‰ <code>ç©ºæ ¼</code> å¯ä»¥åˆ‡æ¢çŠ¶æ€</li><li>æŒ‰ <code>/</code> å¯ä»¥å¿«é€Ÿæœç´¢CONFIGå®</li></ol>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå†…æ ¸ç¼–è¯‘make defconfig</title>
    <link href="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/"/>
    <url>/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸ç¼–è¯‘make-defconfig"><a href="#Linuxå†…æ ¸ç¼–è¯‘make-defconfig" class="headerlink" title="Linuxå†…æ ¸ç¼–è¯‘make defconfig"></a>Linuxå†…æ ¸ç¼–è¯‘make defconfig</h1><blockquote><p><strong>å£°æ˜ï¼š</strong>æœ¬æ–‡éƒ¨åˆ†å†…å®¹å¼•è‡ªæ­£ç‚¹åŸå­ï¼Œå…¶èµ„æ–™å®Œæ•´ï¼Œè®²è§£æ¸…æ™°ï¼Œéå¸¸æ„Ÿè°¢ï¼</p></blockquote><p>åœ¨å†…æ ¸ç¼–è¯‘æ—¶ï¼Œæœ‰å„ç§é…ç½®æ–¹å¼å¯ä¾›è¿›è¡Œé€‰æ‹©ï¼Œå¸¸è§çš„æœ‰å›¾å½¢åŒ–ç•Œé¢<code>make menuconfig</code>ï¼Œæœ‰<code>make XXX_defconfig</code>ã€‚ä»Šå¤©ä»¥NXPå®˜æ–¹çš„å†…æ ¸ä¸ºä¾‹ï¼Œè®°å½•ä¸€ä¸‹ç¼–è¯‘é»˜è®¤é…ç½®æ–‡ä»¶<strong>make imx_v7_mfg_defconfig</strong></p><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/v2-28887f831d79f4d3abf8b153616528d0_720w.webp" alt="img" style="zoom:80%;"><h2 id="1-make-defconfigåœ¨MakefileåŒ¹é…è¿‡ç¨‹"><a href="#1-make-defconfigåœ¨MakefileåŒ¹é…è¿‡ç¨‹" class="headerlink" title="1.make defconfigåœ¨MakefileåŒ¹é…è¿‡ç¨‹"></a>1.make defconfigåœ¨MakefileåŒ¹é…è¿‡ç¨‹</h2><h3 id="1-1-é¡¶å±‚MakefileåŒ¹é…"><a href="#1-1-é¡¶å±‚MakefileåŒ¹é…" class="headerlink" title="1.1 é¡¶å±‚MakefileåŒ¹é…"></a>1.1 é¡¶å±‚MakefileåŒ¹é…</h3><p>å½“æˆ‘ä»¬æ‰§è¡Œ <strong>make imx_v7_mfg_defconfig</strong> æ—¶ï¼Œå¯¹åº”äºé¡¶å±‚makefileä¸­çš„<code>%config</code>ç›®æ ‡ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">%config: scripts_basic outputmakefile FORCE</span><br><span class="hljs-variable">$(Q)</span><span class="hljs-variable">$(MAKE)</span> <span class="hljs-variable">$(build)</span>=scripts/kconfig <span class="hljs-variable">$@</span><br></code></pre></td></tr></table></figure><p>â€œ%configâ€ä¾èµ–scripts_basicã€outputmakefile å’Œ FORCEï¼Œâ€œ%configâ€çœŸæ­£æœ‰æ„ä¹‰çš„ä¾èµ–å°±åªæœ‰ scripts_basicï¼Œ</p><p>scripts_basic çš„è§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">scripts_basic:</span><br><span class="hljs-variable">$(Q)</span><span class="hljs-variable">$(MAKE)</span> <span class="hljs-variable">$(build)</span>=scripts/basic<br><span class="hljs-variable">$(Q)</span>rm -f .tmp_quiet_recordmcount<br></code></pre></td></tr></table></figure><p>build å®šä¹‰åœ¨æ–‡ä»¶ scripts&#x2F;Kbuild.include ä¸­ï¼Œå€¼ä¸º build :&#x3D; -f $(srctree)&#x2F;scripts&#x2F;Makefile.build objï¼Œå› æ­¤å±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">scripts_basic:</span><br>    @make -f ./scripts/Makefile.build obj=scripts/basic  //ä¹Ÿå¯ä»¥æ²¡æœ‰@ï¼Œè§†é…ç½®è€Œå®š<br>    @rm -f . tmp_quiet_recordmcount //ä¹Ÿå¯ä»¥æ²¡æœ‰@<br></code></pre></td></tr></table></figure><p>æ¥ç€å›åˆ°ç›®æ ‡â€œ%configâ€å¤„ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">%config: scripts_basic outputmakefile FORCE</span><br><span class="hljs-variable">$(Q)</span><span class="hljs-variable">$(MAKE)</span> <span class="hljs-variable">$(build)</span>=scripts/kconfig <span class="hljs-variable">$@</span><br></code></pre></td></tr></table></figure><p>å°†å‘½ä»¤å±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">@make -f ./scripts/Makefile.build obj=scripts/kconfig imx_v7_mfg_defconfig<br></code></pre></td></tr></table></figure><h3 id="1-2-Makefile-buildè„šæœ¬è§£æ"><a href="#1-2-Makefile-buildè„šæœ¬è§£æ" class="headerlink" title="1.2 Makefile.buildè„šæœ¬è§£æ"></a>1.2 Makefile.buildè„šæœ¬è§£æ</h3><p>ä»ä¸Šä¸€å°èŠ‚å¯çŸ¥ï¼Œâ€œmake xxx_defconfigâ€œé…ç½® Linux çš„æ—¶å€™å¦‚ä¸‹ä¸¤è¡Œå‘½ä»¤ä¼šæ‰§è¡Œè„šæœ¬scripts&#x2F;Makefile.buildï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">@make -f ./scripts/Makefile.build obj=scripts/basic<br>@make -f ./scripts/Makefile.build obj=scripts/kconfig xxx_defconfig<br></code></pre></td></tr></table></figure><h4 id="1-2-1-scripts-basic"><a href="#1-2-1-scripts-basic" class="headerlink" title="1.2.1 scripts_basic"></a>1.2.1 scripts_basic</h4><p>scripts_basic ç›®æ ‡å¯¹åº”çš„å‘½ä»¤ä¸ºï¼š@make -f .&#x2F;scripts&#x2F;Makefile.build obj&#x3D;scripts&#x2F;basicã€‚æ‰“å¼€æ–‡ä»¶ scripts&#x2F;Makefile.buildï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># The filename Kbuild has precedence over Makefile</span><br>kbuild-dir := <span class="hljs-variable">$(<span class="hljs-built_in">if</span> $(<span class="hljs-built_in">filter</span> /%,<span class="hljs-variable">$(src)</span>)</span>,<span class="hljs-variable">$(src)</span>,<span class="hljs-variable">$(srctree)</span>/<span class="hljs-variable">$(src)</span>)<br>kbuild-file := <span class="hljs-variable">$(<span class="hljs-built_in">if</span> $(<span class="hljs-built_in">wildcard</span> $(kbuild-<span class="hljs-built_in">dir</span>)</span>/Kbuild),$(kbuild-dir)/Kbuild,$(kbuild-dir)/Makefile)<br><span class="hljs-keyword">include</span> $(kbuild-file)<br></code></pre></td></tr></table></figure><p>å°† kbuild-dir å±•å¼€åä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">kbuild-dir=./scripts/basic<br></code></pre></td></tr></table></figure><p>å°† kbuild-file å±•å¼€åä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">kbuild-file= ./scripts/basic/Makefile<br></code></pre></td></tr></table></figure><p>æœ€åä¸€è¡Œå±•å¼€ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-keyword">include</span> ./scripts/basic/Makefile<br></code></pre></td></tr></table></figure><p>ç»§ç»­åˆ†æ scripts&#x2F;Makefile.buildï¼Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">__build: $(if <span class="hljs-variable">$(KBUILD_BUILTIN)</span>,$(builtin-target) $(lib-target) $(extra-y)) \</span><br> <span class="hljs-variable">$(<span class="hljs-built_in">if</span> <span class="hljs-variable">$(KBUILD_MODULES)</span>,$(obj-m)</span> $(modorder-target)) \<br> $(subdir-ym) <span class="hljs-variable">$(always)</span><br>@:<br></code></pre></td></tr></table></figure><p>__build æ˜¯é»˜è®¤ç›®æ ‡ï¼Œå› ä¸ºå‘½ä»¤â€œ@make -f .&#x2F;scripts&#x2F;Makefile.build obj&#x3D;scripts&#x2F;basicâ€æ²¡æœ‰æŒ‡å®šç›®æ ‡ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨åˆ°é»˜è®¤ç›®æ ‡__buildã€‚åœ¨é¡¶å±‚ Makefile ä¸­ï¼ŒKBUILD_BUILTIN ä¸º 1ï¼ŒKBUILD_MODULES ä¸ºç©ºï¼Œå› æ­¤å±•å¼€åç›®æ ‡__build ä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">__build:$(builtin-target) $(lib-target) $(extra-y)) $(subdir-ym) <span class="hljs-variable">$(always)</span></span><br>@:<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºç›®æ ‡__build æœ‰ 5 ä¸ªä¾èµ–ï¼šbuiltin-targetã€lib-targetã€extra-yã€subdir-ym å’Œ alwaysã€‚è¿™ 5 ä¸ªä¾èµ–çš„å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">builtin-target =<br>lib-target =<br>extra-y =<br>subdir-ym =<br>always = scripts/basic/fixdep scripts/basic/bin2c<br></code></pre></td></tr></table></figure><p>åªæœ‰ always æœ‰æ•ˆï¼Œå› æ­¤__build æœ€ç»ˆä¸ºï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">__build: scripts/basic/fixdep scripts/basic/bin2c</span><br>@<br></code></pre></td></tr></table></figure><p>__build ä¾èµ–äº scripts&#x2F;basic&#x2F;fixdep å’Œ scripts&#x2F;basic&#x2F;bin2cï¼Œæ‰€ä»¥è¦å…ˆå°† scripts&#x2F;basic&#x2F;fixdep å’Œ scripts&#x2F;basic&#x2F;bin2c.c è¿™ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘æˆ fixdep å’Œ bin2cã€‚</p><p>ğŸ˜ ç»¼ä¸Šæ‰€è¿°ï¼Œscripts_basic ç›®æ ‡çš„ä½œç”¨å°±æ˜¯ç¼–è¯‘å‡º <strong>scripts&#x2F;basic&#x2F;fixdep</strong> å’Œ <strong>scripts&#x2F;basic&#x2F;bin2c</strong> è¿™ä¸¤ä¸ªè½¯ä»¶ã€‚</p><h4 id="1-2-2-config"><a href="#1-2-2-config" class="headerlink" title="1.2.2 %config"></a>1.2.2 %config</h4><p>%config ç›®æ ‡ å¯¹åº”çš„å‘½ä»¤ä¸º ï¼š @make -f .&#x2F;scripts&#x2F;Makefile.build obj&#x3D;scripts&#x2F;kconfig xxx_defconfigï¼Œæ­¤å‘½ä»¤ä¼šä½¿ç”¨åˆ°çš„å„ä¸ªå˜é‡å€¼å¦‚ä¸‹</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">src= scripts/kconfig<br>kbuild-dir = ./scripts/kconfig<br>kbuild-file = ./scripts/kconfig/Makefile<br><span class="hljs-keyword">include</span> ./scripts/kconfig/Makefile<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼ŒMakefile.build ä¼šè¯»å– scripts&#x2F;kconfig&#x2F;Makefile ä¸­çš„å†…å®¹ï¼Œæ­¤æ–‡ä»¶æœ‰å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">%_defconfig: <span class="hljs-variable">$(obj)</span>/conf</span><br><span class="hljs-variable">$(Q)</span><span class="hljs-variable">$&lt;</span> <span class="hljs-variable">$(silent)</span> --defconfig=arch/<span class="hljs-variable">$(SRCARCH)</span>/configs/<span class="hljs-variable">$@</span> <span class="hljs-variable">$(Kconfig)</span><br></code></pre></td></tr></table></figure><p>ç›®æ ‡%_defconfig ä¸ xxx_defconfig åŒ¹é…ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œè¿™æ¡è§„åˆ™ï¼Œå°†å…¶å±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">%_defconfig: scripts/kconfig/conf</span><br>@scripts/kconfig/conf --defconfig=arch/arm/configs/%_defconfig Kconfig<br></code></pre></td></tr></table></figure><p><code>%__defconfig</code> ä¼šä¾èµ–äºscripts&#x2F;kconfig&#x2F;confï¼Œæ‰€ä»¥ä¼šå…ˆç¼–è¯‘scripts&#x2F;kconfig&#x2F;confï¼Œç„¶åè°ƒç”¨è¿™ä¸ªäºŒè¿›åˆ¶ï¼Œç”Ÿæˆæœ€ç»ˆçš„<code>.config</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ç¬¬äºŒç« çš„å†…å®¹ã€‚</p><h2 id="2-æœ€ç»ˆè°ƒç”¨confäºŒè¿›åˆ¶ï¼Œç”Ÿæˆ-configæ–‡ä»¶"><a href="#2-æœ€ç»ˆè°ƒç”¨confäºŒè¿›åˆ¶ï¼Œç”Ÿæˆ-configæ–‡ä»¶" class="headerlink" title="2.æœ€ç»ˆè°ƒç”¨confäºŒè¿›åˆ¶ï¼Œç”Ÿæˆ.configæ–‡ä»¶"></a>2.æœ€ç»ˆè°ƒç”¨confäºŒè¿›åˆ¶ï¼Œç”Ÿæˆ.configæ–‡ä»¶</h2><p>å½“æ‰§è¡Œ<strong>make imx_v7_mfg_defconfig</strong>æ—¶ï¼Œæœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨äºŒè¿›åˆ¶confï¼Œå»ç”Ÿæˆ.configæ–‡ä»¶</p><p>ğŸ¨ <strong>confäºŒè¿›åˆ¶æ˜¯ç”±conf.cç¼–è¯‘è€Œæ¥</strong></p><blockquote><p>æ‰€ä»¥æœ€ç»ˆè°ƒç”¨çš„å‘½ä»¤ä¸º<code>scripts/kconfig/conf --defconfig=arch/../configs/imx_v7_mfg_defconfig Kconfig</code>ï¼Œå°±æ˜¯è°ƒç”¨<strong>conf.c</strong>æ–‡ä»¶çš„mainå‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ä¼ é€’ç»™conf.cæ—¶çš„mainå‡½æ•°çš„<strong>argv[0]&#x3D;scripts&#x2F;kconfig&#x2F;conf</strong>ï¼Œ<strong>argv[1]&#x3D;â€“defconfig&#x3D;arch&#x2F;arm&#x2F;configs&#x2F;imx_v7_mfg_defconfig</strong>ï¼Œ<strong>argv[2]&#x3D;Kconfig</strong>ã€‚</p></blockquote><p>å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹conf.cçš„mainå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// scripts/kconfig/conf.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">option</span> <span class="hljs-title">long_opts</span>[] =</span> &#123;<br>&#123;<span class="hljs-string">&quot;oldaskconfig&quot;</span>,    no_argument,       <span class="hljs-literal">NULL</span>, oldaskconfig&#125;,<br>&#123;<span class="hljs-string">&quot;oldconfig&quot;</span>,       no_argument,       <span class="hljs-literal">NULL</span>, oldconfig&#125;,<br>&#123;<span class="hljs-string">&quot;silentoldconfig&quot;</span>, no_argument,       <span class="hljs-literal">NULL</span>, silentoldconfig&#125;,<br>&#123;<span class="hljs-string">&quot;defconfig&quot;</span>,       optional_argument, <span class="hljs-literal">NULL</span>, defconfig&#125;,<br>&#123;<span class="hljs-string">&quot;savedefconfig&quot;</span>,   required_argument, <span class="hljs-literal">NULL</span>, savedefconfig&#125;,<br>&#123;<span class="hljs-string">&quot;allnoconfig&quot;</span>,     no_argument,       <span class="hljs-literal">NULL</span>, allnoconfig&#125;,<br>&#123;<span class="hljs-string">&quot;allyesconfig&quot;</span>,    no_argument,       <span class="hljs-literal">NULL</span>, allyesconfig&#125;,<br>&#123;<span class="hljs-string">&quot;allmodconfig&quot;</span>,    no_argument,       <span class="hljs-literal">NULL</span>, allmodconfig&#125;,<br>&#123;<span class="hljs-string">&quot;alldefconfig&quot;</span>,    no_argument,       <span class="hljs-literal">NULL</span>, alldefconfig&#125;,<br>&#123;<span class="hljs-string">&quot;randconfig&quot;</span>,      no_argument,       <span class="hljs-literal">NULL</span>, randconfig&#125;,<br>&#123;<span class="hljs-string">&quot;listnewconfig&quot;</span>,   no_argument,       <span class="hljs-literal">NULL</span>, listnewconfig&#125;,<br>&#123;<span class="hljs-string">&quot;olddefconfig&quot;</span>,    no_argument,       <span class="hljs-literal">NULL</span>, olddefconfig&#125;,<br>&#123;<span class="hljs-string">&quot;oldnoconfig&quot;</span>,     no_argument,       <span class="hljs-literal">NULL</span>, olddefconfig&#125;,<br>&#123;<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>&#125;<br>&#125;;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> ac, <span class="hljs-type">char</span> **av)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *progname = av[<span class="hljs-number">0</span>];<br><span class="hljs-type">int</span> opt;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, *defconfig_file = <span class="hljs-literal">NULL</span> <span class="hljs-comment">/* gcc uninit */</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">tmpstat</span>;</span><br><br>    <span class="hljs-comment">// é€šè¿‡getopt_longå»è§£æä¼ è¿›æ¥çš„å‚æ•°</span><br>    <span class="hljs-comment">// ä¼ è¿›æ¥æ—¶æœ‰ä¸€ä¸ª--defconfigï¼Œæ‰€ä»¥ä»optionåˆ—è¡¨é‡Œé¢åŒ¹é…åˆ°çš„æ˜¯defconfig(æšä¸¾å€¼ä¸º8)</span><br><span class="hljs-keyword">while</span> ((opt = getopt_long(ac, av, <span class="hljs-string">&quot;s&quot;</span>, long_opts, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">-1</span>) &#123;<br>input_mode = (<span class="hljs-keyword">enum</span> input_mode)opt;<br><span class="hljs-keyword">switch</span> (opt) &#123;<br>            <span class="hljs-keyword">case</span> defconfig:<br>            <span class="hljs-keyword">case</span> savedefconfig:<br>                defconfig_file = optarg;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>&#125;<br><br>name = av[optind];  <span class="hljs-comment">// åå­—ä¸ºKconfig</span><br>conf_parse(name);  <span class="hljs-comment">// è§£æKconfig</span><br><br><span class="hljs-keyword">switch</span> (input_mode) &#123;<br>        <span class="hljs-keyword">case</span> defconfig:<br>            <span class="hljs-comment">// å‰é¢åœ¨whileå¾ªç¯è§£æå‚æ•°æ—¶ï¼Œ defconfig_fileä¸ºarch/arm/configs/imx_v7_mfg_defconfig</span><br>            <span class="hljs-keyword">if</span> (!defconfig_file)<br>                defconfig_file = conf_get_default_confname();<br>         <br>            <span class="hljs-keyword">if</span> (conf_read(defconfig_file)) &#123;<br>                <span class="hljs-built_in">printf</span>(_(<span class="hljs-string">&quot;***\n&quot;</span><br>                    <span class="hljs-string">&quot;*** Can&#x27;t find default configuration \&quot;%s\&quot;!\n&quot;</span><br>                    <span class="hljs-string">&quot;***\n&quot;</span>), defconfig_file);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>&#125;<br><br><span class="hljs-keyword">switch</span> (input_mode) &#123;<br>        <span class="hljs-keyword">case</span> defconfig:<br>            conf_set_all_new_symbols(def_default);<br>            <span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (sync_kconfig) &#123;<br>        <span class="hljs-comment">// ....</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input_mode != listnewconfig) &#123;<br><span class="hljs-keyword">if</span> (conf_write(<span class="hljs-literal">NULL</span>)) &#123;<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, _(<span class="hljs-string">&quot;\n*** Error during writing of the configuration.\n\n&quot;</span>));<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-conf-parseè§£æKconfig"><a href="#2-1-conf-parseè§£æKconfig" class="headerlink" title="2.1 conf_parseè§£æKconfig"></a>2.1 conf_parseè§£æKconfig</h3><p>è°ƒç”¨<code>conf_parse(name)</code>ä»<code>$(srctree)</code>ç›®å½•ä¸‹ä¾æ¬¡æŸ¥æ‰¾åä¸º<code>Kconfig</code>çš„æ–‡ä»¶ï¼Œç„¶åå°†å–å¾—çš„ä¿¡æ¯å­˜æ”¾åˆ°é“¾è¡¨ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// scripts\kconfig\zconf.tab.c_shipped</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">conf_parse</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> *<span class="hljs-title">sym</span>;</span><br><span class="hljs-type">int</span> i;<br><br>zconf_initscan(name);<br><br>sym_init();<br>_menu_init();<br>rootmenu.prompt = menu_add_prompt(P_MENU, <span class="hljs-string">&quot;Linux Kernel Configuration&quot;</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-keyword">if</span> (getenv(<span class="hljs-string">&quot;ZCONF_DEBUG&quot;</span>))<br>zconfdebug = <span class="hljs-number">1</span>;<br>zconfparse();<br><span class="hljs-keyword">if</span> (zconfnerrs)<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!modules_sym)<br>modules_sym = sym_find( <span class="hljs-string">&quot;n&quot;</span> );<br><br>rootmenu.prompt-&gt;text = _(rootmenu.prompt-&gt;text);<br>rootmenu.prompt-&gt;text = sym_expand_string_value(rootmenu.prompt-&gt;text);<br><br>menu_finalize(&amp;rootmenu);<br><br>sym_set_change_count(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-conf-read-defconfig-file-è¯»å–é…ç½®æ–‡ä»¶"><a href="#2-2-conf-read-defconfig-file-è¯»å–é…ç½®æ–‡ä»¶" class="headerlink" title="2.2 conf_read(defconfig_file)è¯»å–é…ç½®æ–‡ä»¶"></a>2.2 conf_read(defconfig_file)è¯»å–é…ç½®æ–‡ä»¶</h3><h3 id="2-3-conf-writeå¾€-configå†™é…ç½®"><a href="#2-3-conf-writeå¾€-configå†™é…ç½®" class="headerlink" title="2.3 conf_writeå¾€.configå†™é…ç½®"></a>2.3 conf_writeå¾€.configå†™é…ç½®</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">conf_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>FILE *out;<br>    <br>dirname[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (name &amp;&amp; name[<span class="hljs-number">0</span>]) &#123;<br><span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-keyword">else</span><br>basename = conf_get_configname();<br><br><span class="hljs-built_in">sprintf</span>(newname, <span class="hljs-string">&quot;%s%s&quot;</span>, dirname, basename);  <span class="hljs-comment">// newnameä¸º.config</span><br>env = getenv(<span class="hljs-string">&quot;KCONFIG_OVERWRITECONFIG&quot;</span>);  <span class="hljs-comment">// è·å–KCONFIG_OVERWRITECONFIGå¤±è´¥</span><br><span class="hljs-keyword">if</span> (!env || !*env) &#123;<br><span class="hljs-built_in">sprintf</span>(tmpname, <span class="hljs-string">&quot;%s.tmpconfig.%d&quot;</span>, dirname, (<span class="hljs-type">int</span>)getpid());  <span class="hljs-comment">// ä¸´æ—¶æ–‡ä»¶ä¸º.tmpconfig.[@pid]</span><br>out = fopen(tmpname, <span class="hljs-string">&quot;w&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>*tmpname = <span class="hljs-number">0</span>;<br>out = fopen(newname, <span class="hljs-string">&quot;w&quot;</span>);<br>&#125;<br><br>    <span class="hljs-comment">// 2.3.1èŠ‚</span><br>conf_write_heading(out, &amp;kconfig_printer_cb, <span class="hljs-literal">NULL</span>);<br><br><br>    <span class="hljs-comment">// è·å–rootmenué¦–é¡µçš„menu.list</span><br>    <span class="hljs-comment">// å°±æ˜¯æˆ‘ä»¬make_menuconfigçœ‹åˆ°çš„é¦–é¡µæ‰€æœ‰é¡¹</span><br>menu = rootmenu.<span class="hljs-built_in">list</span>;<br><span class="hljs-keyword">while</span> (menu) &#123;<br>        <span class="hljs-comment">// symå°±æ˜¯è§£æåSymbol</span><br>sym = menu-&gt;sym;<br><span class="hljs-keyword">if</span> (!sym) &#123;<br><span class="hljs-comment">// ...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(sym-&gt;flags &amp; SYMBOL_CHOICE)) &#123;<br>sym_calc_value(sym);<br>sym-&gt;flags &amp;= ~SYMBOL_WRITE;<br><span class="hljs-comment">// 2.3.2èŠ‚</span><br>conf_write_symbol(out, sym, &amp;kconfig_printer_cb, <span class="hljs-literal">NULL</span>);<br>&#125;<br>&#125;<br>fclose(out);<br><br>    <span class="hljs-comment">// å°†tmpnameé‡å‘½åä¸º.config</span><br>    <span class="hljs-comment">// 2.3.4èŠ‚</span><br><span class="hljs-keyword">if</span> (*tmpname) &#123;<br><span class="hljs-built_in">strcat</span>(dirname, basename);<br><span class="hljs-built_in">strcat</span>(dirname, <span class="hljs-string">&quot;.old&quot;</span>);<br>rename(newname, dirname);<br><span class="hljs-keyword">if</span> (rename(tmpname, newname))<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br>conf_message(_(<span class="hljs-string">&quot;configuration written to %s&quot;</span>), newname);  <span class="hljs-comment">// åœ¨ç¼–è¯‘æ—¥å¿—é‡Œé¢æ‰“å°configuration written to .config</span><br><br>sym_set_change_count(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-0-çœŸæ­£å‘æŒ¥å†™æ–‡ä»¶çš„å‡½æ•°kconfig-printer-cb"><a href="#2-3-0-çœŸæ­£å‘æŒ¥å†™æ–‡ä»¶çš„å‡½æ•°kconfig-printer-cb" class="headerlink" title="2.3.0 çœŸæ­£å‘æŒ¥å†™æ–‡ä»¶çš„å‡½æ•°kconfig_printer_cb"></a>2.3.0 çœŸæ­£å‘æŒ¥å†™æ–‡ä»¶çš„å‡½æ•°kconfig_printer_cb</h4><p>kconfig_printer_cbä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œä¸€ä¸ªç”¨æ¥å†™æ³¨é‡Šï¼Œä¸€ä¸ªç”¨æ¥å†™é…ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">conf_printer</span> <span class="hljs-title">kconfig_printer_cb</span> =</span><br>&#123;<br>.print_symbol = kconfig_print_symbol,   <span class="hljs-comment">// å†™é…ç½®çš„å‡½æ•°</span><br>.print_comment = kconfig_print_comment, <span class="hljs-comment">// å†™æ³¨é‡Šçš„å‡½æ•°</span><br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">kconfig_print_symbol</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">struct</span> symbol *sym, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *value, <span class="hljs-type">void</span> *arg)</span><br>&#123;<br><br><span class="hljs-keyword">switch</span> (sym-&gt;type) &#123;<br><span class="hljs-keyword">case</span> S_BOOLEAN:<br><span class="hljs-keyword">case</span> S_TRISTATE:<br>        <span class="hljs-comment">// å¦‚æœå€¼ä¸ºn</span><br><span class="hljs-keyword">if</span> (*value == <span class="hljs-string">&#x27;n&#x27;</span>) &#123;<br><span class="hljs-type">bool</span> skip_unset = (arg != <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">// å¾€.configé‡Œé¢å†™# CONFIG_XXX is not set</span><br><span class="hljs-keyword">if</span> (!skip_unset)<br><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot;# %s%s is not set\n&quot;</span>,<br>    CONFIG_, sym-&gt;name);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot;%s%s=%s\n&quot;</span>, CONFIG_, sym-&gt;name, value);  <span class="hljs-comment">// å¾€.configä¸­å†™é…ç½®ï¼Œæ ¼å¼ä¸ºCONFIG_XXX=XXX</span><br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">kconfig_print_comment</span><span class="hljs-params">(FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *value, <span class="hljs-type">void</span> *arg)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *p = value;<br><span class="hljs-type">size_t</span> l;<br><br><span class="hljs-keyword">for</span> (;;) &#123;<br>l = <span class="hljs-built_in">strcspn</span>(p, <span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot;#&quot;</span>);<br><span class="hljs-keyword">if</span> (l) &#123;<br><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot; &quot;</span>);<br>xfwrite(p, l, <span class="hljs-number">1</span>, fp);<br>p += l;<br>&#125;<br><span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">if</span> (*p++ == <span class="hljs-string">&#x27;\0&#x27;</span>)<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409212854271.png" alt="image-20230409212854271" style="zoom:80%;"><p>æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼š</p><p>å‡å¦‚æˆ‘ä»¬åœ¨<strong>Kconfig</strong>ä¸­è®¾ç½®<code>AMX_FONT</code>ä¸ºyï¼Œè€Œåœ¨<strong>imx_v7_mfg_defconig</strong>è®¾ç½®ä¸ºn</p><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409212629006.png" alt="image-20230409212629006" style="zoom:50%;"><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409212745735.png" alt="image-20230409212745735" style="zoom:50%;"><p>é€šè¿‡<code>make imx_v7_mfg_defconig</code>ååœ¨<code>.config</code>ä¸­æœ€ç»ˆä¸º <strong># CONFIG_AMX_FONT is not set</strong></p><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409212910588.png" alt="image-20230409212910588" style="zoom:67%;"><h4 id="2-3-1-conf-write-headingå‡½æ•°å‘-configå†™å¤´éƒ¨æ³¨é‡Š"><a href="#2-3-1-conf-write-headingå‡½æ•°å‘-configå†™å¤´éƒ¨æ³¨é‡Š" class="headerlink" title="2.3.1 conf_write_headingå‡½æ•°å‘.configå†™å¤´éƒ¨æ³¨é‡Š"></a>2.3.1 conf_write_headingå‡½æ•°å‘.configå†™å¤´éƒ¨æ³¨é‡Š</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">conf_write_heading:<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">conf_write_heading</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">struct</span> conf_printer *printer, <span class="hljs-type">void</span> *printer_arg)</span><br>&#123;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>];<br><br><span class="hljs-built_in">snprintf</span>(buf, <span class="hljs-keyword">sizeof</span>(buf),<br>    <span class="hljs-string">&quot;\n&quot;</span><br>    <span class="hljs-string">&quot;Automatically generated file; DO NOT EDIT.\n&quot;</span><br>    <span class="hljs-string">&quot;%s\n&quot;</span>,<br>    rootmenu.prompt-&gt;text);<br><br>printer-&gt;print_comment(fp, buf, printer_arg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™è¾¹çš„rootmenuå°±æ˜¯æ ¹ç›®å½•ä¸‹çš„<strong>Kconfig</strong>ï¼Œå…¶promptå€¼ä¸º<code>Linux/$ARCH $KERNELVERSION Kernel Configuration</code></p><p>å› æ­¤æœ€ç»ˆå†™å…¥çš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409152128232.png" alt="image-20230409152128232" style="zoom: 67%;"><h4 id="2-3-2-conf-write-symbolå‡½æ•°å‘-configå†™é…ç½®é¡¹"><a href="#2-3-2-conf-write-symbolå‡½æ•°å‘-configå†™é…ç½®é¡¹" class="headerlink" title="2.3.2 conf_write_symbolå‡½æ•°å‘.configå†™é…ç½®é¡¹"></a>2.3.2 conf_write_symbolå‡½æ•°å‘.configå†™é…ç½®é¡¹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">conf_write_symbol:<br>    <br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">conf_write_symbol</span><span class="hljs-params">(FILE *fp, <span class="hljs-keyword">struct</span> symbol *sym,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> conf_printer *printer, <span class="hljs-type">void</span> *printer_arg)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *str;<br><br>    <span class="hljs-comment">// åˆ¤æ–­å†™å…¥çš„Symbolå€¼</span><br><span class="hljs-keyword">switch</span> (sym-&gt;type) &#123;<br><span class="hljs-keyword">case</span> S_OTHER:<br><span class="hljs-keyword">case</span> S_UNKNOWN:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> S_STRING:<br>str = sym_get_string_value(sym);<br>str = sym_escape_string_value(str);<br>printer-&gt;print_symbol(fp, sym, str, printer_arg);<br><span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)str);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br>str = sym_get_string_value(sym);<br>        <span class="hljs-comment">// æŒ‰ç…§2.3.0ä¸­çš„è§„åˆ™å¾€.configä¸­å†™å†…å®¹</span><br>printer-&gt;print_symbol(fp, sym, str, printer_arg);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœè¾“å…¥çš„æ˜¯stringç±»å‹ï¼Œç›´æ¥è·å–stringç±»å‹çš„å€¼ï¼Œç„¶åå†™å…¥configä¸­</li></ul><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409213953366.png" alt="image-20230409213953366" style="zoom:67%;"><img src="/2023/04/09/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91make-defconfig/image-20230409213825095.png" alt="image-20230409213825095" style="zoom: 50%;"><ul><li>å¦‚æœæ˜¯å…¶ä»–ç±»å‹ï¼Œæ¯”å¦‚boolç±»å‹å’Œtristateï¼Œè·å–å€¼ç„¶åå†™å…¥.config</li></ul><h4 id="2-3-4-é‡å‘½å-config"><a href="#2-3-4-é‡å‘½å-config" class="headerlink" title="2.3.4 é‡å‘½å.config"></a>2.3.4 é‡å‘½å.config</h4><p>å…¶å®å‰é¢ä¸€ç›´æ˜¯å¾€<code>.tmpconfig.[@pid]</code>é‡Œé¢å†™é…ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (*tmpname) &#123;<br>    <span class="hljs-built_in">strcat</span>(dirname, basename);<br>    <span class="hljs-built_in">strcat</span>(dirname, <span class="hljs-string">&quot;.old&quot;</span>);<br>    rename(newname, dirname);<br>    <span class="hljs-keyword">if</span> (rename(tmpname, newname))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>dirnameä¸º <code>.config.old</code></p></li><li><p>å°†ä¹‹å‰çš„ <strong>.config</strong> æ–‡ä»¶é‡å‘½åä¸º <strong>.config.old</strong></p></li><li><p>å°†<strong>tmpname</strong> é‡å‘½åä¸ºæ–°çš„configä¸º <strong>.config</strong></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥</title>
    <link href="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/"/>
    <url>/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥"><a href="#æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥" class="headerlink" title="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥"></a>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿâ€”â€”é“¾æ¥</h1><blockquote><p>å£°æ˜ï¼šæœ¬æ–‡ä¸ºå­¦ä¹ è®¡ç®—æœºç³»ç»Ÿçš„ç¬”è®°ï¼Œä¾›è‡ªå·±å¤ä¹ ä½¿ç”¨ï¼›æŒ‰ç…§<strong>yaaangmin</strong>çš„githubå£°æ˜ï¼Œè¯·å‹¿è¿›è¡Œå•†ç”¨</p><p>æ‰€æœ‰å†…å®¹å‡æ•´ç†è‡ªï¼š<strong>yaaangmin</strong></p><p>å…¶githubåœ°å€ä¸ºï¼š<a href="https://github.com/yangminz/bcst_csapp">https://github.com/yangminz/bcst_csapp</a></p></blockquote><h2 id="1-å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼"><a href="#1-å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼" class="headerlink" title="1.å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼"></a>1.å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬è€ƒè™‘ä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿï¼ˆFile System)ä¸Šçš„æ–‡ä»¶ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ–‡ä»¶éƒ½æ˜¯æŒä¹…åœ°å‚¨å­˜åœ¨ç£ç›˜ç­‰è®¾å¤‡ä¸Šçš„ï¼Œä½†å®ƒçš„å®è´¨ä»ç„¶æ˜¯äºŒè¿›åˆ¶åºåˆ—ã€‚åªè¦æˆ‘ä»¬å¯¹åºåˆ—è¿›è¡Œæ°å½“çš„æè¿°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—æƒ³è¦çš„å…¨éƒ¨ä¿¡æ¯ã€‚ä¸ºäº†å°†æŸä¸€æ–‡ä»¶çš„äºŒè¿›åˆ¶ä¸²ä¸å…¶ä»–æ–‡ä»¶çš„äºŒè¿›åˆ¶ä¸²åŒºåˆ«å¼€ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šè¿™ä¸€æ–‡ä»¶çš„ç±»å‹ä¸å¤§å°ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨æ–‡ä»¶äºŒè¿›åˆ¶ä¸²çš„èµ·å§‹åœ°å€ï¼Œä¹Ÿå³é¦–éƒ¨ï¼ˆHeader)ã€‚</p><h3 id="1-1-ELF-Header"><a href="#1-1-ELF-Header" class="headerlink" title="1.1 ELF Header"></a>1.1 ELF Header</h3><p>å¯¹äºELFï¼Œé¦–éƒ¨çš„ä¿¡æ¯åŒ…æ‹¬æ–‡ä»¶ç±»å‹ã€æœºå™¨ç±»å‹ç­‰ä¿¡æ¯ã€‚åœ¨Linuxè¯»å–ELFæ–‡ä»¶æ—¶ï¼ŒLinuxå°†ELF Headerä»Byteç¿»è¯‘ä¸ºå†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405210514169.png" alt="image-20230405210514169" style="zoom:80%;"><p>æ•°æ®ç»“æ„<strong>Elf64_Ehdr</strong>åŒ…å«äº†å¾ˆå¤šä¿¡æ¯ï¼Œä½†å¯¹æˆ‘ä»¬è€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“Header æ˜¯å¦‚ä½•å®šä½åˆ°èŠ‚å¤´è¡¨( Section Header Table,SHT)çš„ã€‚Headerä¸­çš„ Elf64_Ehdr.e_shoff æ˜¯SHTå¯¹ELFèµ·å§‹åœ°å€çš„Byteåç½®ï¼ŒElf64_Ehdr.e_shentsizeæè¿°SHTæ¯ä¸€é¡¹çš„Byteå¤§å°ï¼ŒElf64_Ehdr.e_shentnum æè¿° SHTæè¿°è¡¨é¡¹çš„æ•°é‡ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åä¸¤é¡¹è®¡ç®—å‡ºSHTçš„å¤§å°ã€‚Headerä¸­çš„Elf64_Ehdr.e_shstrndxåˆ™æ˜¯SHTä¸­ä¸€ä¸ªç‰¹æ®ŠèŠ‚<strong>å­—ç¬¦ä¸²</strong>è¡¨çš„æ®µç´¢å¼•ï¼ŒHeaderå¯ä»¥å€Ÿæ­¤è®¡ç®—ELFä¸­æ¯ä¸€é¡¹çš„å­—ç¬¦ä¸²ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405210554302.png" alt="image-20230405210554302" style="zoom: 80%;"><p>æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä½¿æˆ‘ä»¬æ´è§ELFæ–‡ä»¶çš„æ•°æ®ç»“æ„ï¼Œè€ƒè™‘å¦‚ä¸‹çš„elf.cæºæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-type">long</span> data1 = <span class="hljs-number">0xdddddddd11111111</span>;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> data2 = <span class="hljs-number">0xdddddddd22222222</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> &#123;&#125;;<br><span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> &#123;&#125;;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨gccç¼–è¯‘å¾—åˆ°å®ƒçš„ELFæ–‡ä»¶ï¼š<code>gcc -c elf.c -o elf.o</code>ï¼Œå…¶ä¸­-cçš„å«ä¹‰æ˜¯ä»…ç¼–è¯‘æºæ–‡ä»¶ç”ŸæˆELFæ–‡ä»¶ï¼Œä½†ä¸å¯¹ELFæ–‡ä»¶è¿›è¡Œé“¾æ¥ã€‚ç”ŸæˆELFæ–‡ä»¶ä»¥åï¼Œåˆ©ç”¨hexdumpæŸ¥çœ‹ELFæ–‡ä»¶<code>elf.o</code>çš„å†…å®¹ã€‚</p><p>hexdumpè·å¾—elf.oçš„äºŒè¿›åˆ¶å†…å®¹åï¼ŒæŒ‰ç…§Elf64_Ehdrçš„ç»“æ„æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥è§£è¯»ELFçš„Headerã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—åˆ°sizeof(Elf64_Ehdr) &#x3D; 64Byteï¼Œå› æ­¤Headerå æ®ELFæ–‡ä»¶çš„ä½64Byteã€‚è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†elf.oçš„Headerï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405211548347.png" alt="image-20230405211548347" style="zoom:80%;"><p>èµ·å§‹ä½ç½®çš„16Bytesä¸º Magic Number,åœ¨è¿™ä¹‹ååç§»2+2+4+8+8&#x3D;24Bytes,å¤§å°ä¸º8Bytesçš„æ•°æ®ä¸ºElf64_Ehdr.e_shoffï¼Œä¹Ÿå³SHTèµ·å§‹åœ°å€å¯¹ELFæ–‡ä»¶çš„åç§»ï¼Œæ•°å€¼ä¸º 0x00000000000002b0ã€‚åœ¨è¿™ä¹‹åï¼Œå¯¹Elf64_Ehdr.e_shoffåç§»ä¸º4Bytes çš„ä½ç½®å‚¨å­˜äº†ELFæ–‡ä»¶Headerçš„å¤§å°ï¼šElf64_Ehdr.e_ehsize &#x3D;0x0040ã€‚å†ä¹‹å2+2&#x3D;4 Byteså³ Elf64_Ehdr.e_shentsizeï¼Œä¹Ÿå³ä¸ºSHTæ¯ä¸€é¡¹çš„å¤§å°ï¼Œæ•°å€¼ä¸º0x0040ã€‚æœ€åä¸¤ä¸ª2Bytesçš„æ•°åˆ†åˆ«æ˜¯ Elf64_Ehdr.e_shnum &#x3D; 0x000bä»¥åŠElf64_Ehdr.e_shstrndx &#x3D; 0x000aã€‚</p><h3 id="1-2-èŠ‚å¤´è¡¨SHT"><a href="#1-2-èŠ‚å¤´è¡¨SHT" class="headerlink" title="1.2 èŠ‚å¤´è¡¨SHT"></a>1.2 èŠ‚å¤´è¡¨SHT</h3><p>SHTæè¿°äº†ELFä¸­ä¸åŒçš„<strong>èŠ‚(Section)<strong>ï¼ŒåŒ…æ‹¬</strong>æ•°æ®èŠ‚(.data)<strong>ã€</strong>ä»£ç èŠ‚(.textï¼‰</strong>ç­‰ã€‚è¿™äº›Sectionä¸­çš„æ•°æ®æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ï¼ŒæŒ‰ç…§Section çš„ç»„ç»‡å†™å…¥åˆ°ç£ç›˜ä¸Šçš„ELFæ–‡ä»¶ä¸­ã€‚SHTçš„æ¯ä¸€é¡¹å¯ä»¥è¢«æ•°æ®ç»“æ„Elf64_Shdræ‰€æï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212130069.png" alt="image-20230405212130069" style="zoom: 80%;"><p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡SHTæ‰¾åˆ°ELFå†…çš„ä»»ä¸€Sectionï¼Œå¸¸è§çš„Sectionæœ‰.textï¼Œ.dataï¼Œ.rodataï¼Œ.bssï¼Œ.symtabï¼Œ.rel.txtï¼Œ.rel.dataï¼Œ.strtabï¼Œå®ƒä»¬å¯ä»¥è¢«Elf64_Shdr.sh_nameç¡®å®šï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212311898.png" alt="image-20230405212311898" style="zoom:80%;"><p>åœ¨elf.oçš„Headerä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°SHTè·ç¦»ELFæ–‡ä»¶çš„èµ·å§‹ä½ç½®åç§»ä¸º688Byteï¼Œå¹¶ä¸”æ¯ä¸€é¡¹çš„å¤§å°ä¸º64Byteï¼Œå…±11é¡¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°SHTå¯¹åº”çš„äºŒè¿›åˆ¶æ®µã€‚ä½†ç”±äºè¿™æ®µä»£ç å¤ªé•¿äº†ï¼Œå› æ­¤åªæˆªå–äº†.textå’Œ.dataè¿™ä¸¤èŠ‚ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212446493.png" alt="image-20230405212446493"><p>å’Œè§£æHeaderä¸€æ ·ï¼Œå¯¹äºSHTçš„æ¯ä¸€ä¸ªè¡¨é¡¹ï¼ŒæŒ‰ç…§ç»“æ„Elf64_Shdr é€ä¸ª Byteè§£æï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†.textå¯¹ ELFæ–‡ä»¶çš„åç§»: .sh_offset &#x3D; 0x0000000000000040ã€.dataå¯¹ELFæ–‡ä»¶çš„åç§»ä¸º0x0000000000000050ã€‘ã€‚å›å¿†èµ·æˆ‘ä»¬å…ˆå‰å¾—çŸ¥Header çš„å¤§å°å°±æ˜¯0x40ï¼Œä¹Ÿå³64 Bytesï¼Œå› æ­¤.textæ‰€å¤„çš„ä½ç½®æ­£æ˜¯Headerä¹‹åã€‚å¹¶ä¸”ï¼Œå®ƒçš„å¤§å°ä¸º.sh_size &#x3D;0x000000000000000eã€å®é™…ä¸Šä¸ºäº†å¯¹é½ï¼Œä¼šè¿›è¡Œè¡¥é›¶ã€‘ï¼Œå°±è¯´æ˜func1()ä¸ func2()ä¸¤ä¸ªå‡½æ•°å æ®äº†14 Bytes(ä½†ç›®å‰æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ¯ä¸€ä¸ªå‡½æ•°çš„çœŸæ­£ä½ç½®)ã€‚å¯¹äº.dataï¼Œæˆ‘ä»¬å¯ä»¥åŒæ ·è¿›è¡Œè§£æã€‚readelf -s elf.o ä¼šç»™æˆ‘ä»¬ç›¸åŒçš„ç»“è®ºï¼ˆæˆ‘ä»¬çœç•¥äº†å…¶ä»–è¡¨é¡¹)ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒSHTä¸­æ€»å­˜åœ¨[o]é¡¹ï¼Œå®ƒè¢«è§†ä¸ºæœªå®šä¹‰çš„ç¬¦å·æ‰€åœ¨Sectionï¼ŒSHN_UNDEFï¼Œä¹Ÿå°±æ˜¯0ã€‚åŒæ—¶ï¼Œè¿™ä¸€SHTè¡¨é¡¹çš„å€¼æ€»æ˜¯64 Bytesçš„0:</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405212718033.png" alt="image-20230405212718033" style="zoom:80%;"><h3 id="1-3-ç¬¦å·è¡¨"><a href="#1-3-ç¬¦å·è¡¨" class="headerlink" title="1.3 ç¬¦å·è¡¨"></a>1.3 ç¬¦å·è¡¨</h3><p>æœ€åï¼Œæˆ‘ä»¬è¦å®šä½åˆ°æ¯ä¸€ä¸ªç¬¦å·åœ¨ELFä¸­æ‰€å¤„çš„ä½ç½®ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªç‰¹åˆ«çš„Sectionï¼Œ<code>symtab</code>ï¼Œä¹Ÿå°±æ˜¯<strong>ç¬¦å·è¡¨</strong>(Symbol Table)ã€‚ç¬¦å·è¡¨è¢«ç”¨æ¥æè¿°.cæºæ–‡ä»¶ä¸­å¯ä»¥<strong>è¢«å…¶ä»–ELFä½¿ç”¨çš„ç¬¦å·</strong>ã€‚å¯¹äºä»€ä¹ˆæ˜¯ç¬¦å·Symbolï¼Œå…¶å®æœ‰å¿…è¦å…ˆä»ç¼–è¯‘å™¨çš„è§’åº¦å»è§‚å¯Ÿ.cæºæ–‡ä»¶ã€‚è¿™éƒ¨åˆ†å·¥ä½œä¸»è¦æ˜¯ç¼–è¯‘ä¸­è¯­ä¹‰åˆ†æ(Semantic Analysis)çš„è¿‡ç¨‹ï¼Œé€šè¿‡è¯­æ³•ä¸­çš„ç¯å¢ƒ(Environment)å’ŒèŒƒå›´(Scope)æ¥è¿›è¡Œç®¡ç†ã€‚å…¶ä¸­Environmentæ˜ å°„åœ¨ç¼–è¯‘å™¨ä¸­ä¹Ÿè¢«ç§°ä¸ºç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¾ˆå¿«ä¾¿èƒ½å‘ç°<strong>ç¼–è¯‘å’Œé“¾æ¥è¯­å¢ƒä¸‹çš„ç¬¦å·è¡¨å…¶å®æ˜¯å«ä¹‰ç›¸åŒçš„</strong>ã€‚</p><p>è€ƒè™‘èµ‹å€¼è¯­å¥<code>int a = 0xaaaaaaaa</code>ï¼Œåœ¨è¿™é‡Œï¼Œç»ˆç»“ç¬¦aå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„å·¦å€¼ï¼Œå…¶å®å®ƒä¼šè¢«å¤„ç†ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼›ç»ˆç»“ç¬¦0xaaaaaaaaæ˜¯æˆ‘ä»¬æ‰€è¯´çš„å³å€¼ï¼Œè¢«å¤„ç†ä¸ºæ•°å€¼ã€‚å½“æˆ‘ä»¬åœ¨åœ¨.cæºæ–‡ä»¶ä¸­å¼•ç”¨ç»ˆç»“ç¬¦aæ—¶ï¼Œå…¶å®åšäº†ä¸¤éƒ¨æ˜ å°„(Two-Stage Mapping)ï¼›</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405192412069.png" alt="image-20230405192412069" style="zoom:67%;"><p>åœ¨Cè¯­è¨€ä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå‡½æ•°ã€å˜é‡ï¼‰æœ‰å®ƒå¯è§çš„Scopeï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨Scopeå†…ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å¯ä»¥è¢«å¼•ç”¨çš„ã€‚è€Œåœ¨ä¸åŒçš„Scopeå†…ï¼ŒEnvironmentæœªå¿…ç›¸åŒã€‚æˆ‘ä»¬ä»”ç»†è€ƒè™‘Cè¯­è¨€çš„è¯­æ³•ï¼Œå¾ˆå®¹æ˜“å‘ç°æºæ–‡ä»¶å¯ä»¥è¢«åŒºåˆ†ä¸ºä¸åŒçš„**å—(Block)**ï¼Œå®ƒä»¬é€šå¸¸è¢«ä¸€ç»„èŠ±æ‹¬å·<code>&#123;&#125;</code>æ‰€åŒ…å›´ï¼Œå¤©ç„¶åœ°å¯¹åº”ä¸€é¢—æœ‰å…³Blockçš„æ ‘ï¼ˆè€ƒè™‘æœ€å¤–å±‚ä¸ºæ ¹èŠ‚ç‚¹ï¼‰ã€‚</p><p>å‡è®¾å½“å‰æœ‰ä¸€ä¸ª<code>.c</code>æ–‡ä»¶ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> g_var_init = <span class="hljs-number">0xffffffff</span>;<br><span class="hljs-type">int</span> g_var_uninit;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func_undef</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">func_def</span><span class="hljs-params">(<span class="hljs-type">int</span> func_param)</span><br>&#123;<br>    <span class="hljs-type">int</span> func_var = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span> <br>    &#123;<br>        <span class="hljs-type">int</span> loop_var = <span class="hljs-number">1</span>;<br>        func_var += <span class="hljs-number">1</span>;<br>        g_var_init += <span class="hljs-number">1</span>;<br>        <br>        func_undef();<br>    &#125; <span class="hljs-keyword">while</span> (func_var &lt; func_param)<br>&#125;<br><br>voud <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    func_def();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸åº”çš„ï¼Œè€ƒè™‘å®ƒçš„Blockæ ‘ï¼Œä»¥åŠæ¯ä¸€ä¸ªBlockå†…å¯è§çš„å¯¹è±¡ï¼š</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405193201163.png" alt="image-20230405193201163" style="zoom: 80%;"><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯å½“è¿›å…¥ä¸€ä¸ªsub-blockä»¥å‰ï¼Œsub-blockä¼šå¤åˆ¶å½“å‰blockçš„environmentï¼ŒåŒæ—¶ï¼Œåœ¨sub-blockä»¥å†…ï¼Œæ–°å®šä¹‰çš„å˜é‡ã€ä¼ å…¥å‡½æ•°çš„å‚æ•°ï¼Œä¹Ÿéƒ½ä¼šè¢«è§†ä¸ºåœ¨sub-blockå†…æ–°çš„æ˜ å°„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿›å…¥æ–°çš„sub-blockæ—¶ï¼Œå¯ä»¥æ›´æ–°Environmentï¼Œä»è€Œå®ç°äº†å¯¹Environmentçš„ç»´æŠ¤ã€‚</p><p>æˆ‘ä»¬å·²çŸ¥<strong>Cè¯­è¨€ä¸å…è®¸åœ¨å‡½æ•°å†…å®šä¹‰å‡½æ•°</strong>ï¼Œè¿™ä¸ªç®€å•çš„äº‹å®å°†æ•´ä¸ª.cæºæ–‡ä»¶åˆ†ä¸ºæ‰å¹³çš„ä¸¤å±‚ï¼š<strong>å‡½æ•°å†…éƒ¨ï¼ˆInternalï¼‰ã€å‡½æ•°å¤–éƒ¨ï¼ˆExternalï¼‰</strong>ï¼Œå¦‚ä¸‹å›¾ã€‚æˆ‘ä»¬å·²çŸ¥å‡½æ•°Scopeå†…çš„æ•°æ®å®åœ¨Run-Time Stackä¸Šåˆ†é…çš„ï¼Œå› æ­¤å‡½æ•°å†…Scopeçš„Enviromentæ˜ å°„åˆ°æ ˆã€‚è€Œå‡½æ•°å¤–éƒ¨ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æœ¬èº«ä»¥åŠå…¨å±€å˜é‡ï¼Œä»–ä»¬çš„Environmentéœ€è¦æˆ‘ä»¬é¢å¤–ç»´æŠ¤ï¼Œè¿™ä¹Ÿå°±æ˜¯ç¼–è¯‘å™¨åœ¨ELFæ–‡ä»¶ä¸­ç”Ÿæˆçš„ç¬¦å·è¡¨ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405193923601.png" alt="image-20230405193923601" style="zoom:80%;"><p>å› æ­¤,<strong>å¤–éƒ¨</strong>çš„å‡½æ•°ä¸å˜é‡æ˜¯<strong>å¯¹é“¾æ¥å¯è§çš„</strong>ï¼Œä¹Ÿå› æ­¤å®ƒä»¬èƒ½å¤Ÿè¢«å…¶ä»–ELFæ–‡ä»¶æ‰€å¼•ç”¨ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨é“¾æ¥æ—¶æ‰€è¯´çš„ç¬¦å·â€”â€”ä¸€ä¸ªå‡½æ•°(Function)ï¼Œä¸€ä¸ªå…¨å±€å˜é‡(Global Variable)ï¼Œæˆ–ä¸€ä¸ªé™æ€å˜é‡(Static Variable)ã€‚</p><p>æ ¹æ®æˆ‘ä»¬å¯¹ç¬¦å·çš„ç†è§£ï¼ŒæŒ‰ç…§å®šä¹‰å’Œå¼•ç”¨ï¼Œå¯ä»¥å°†ç¬¦å·åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ã€‚å‡å®šsource1.cæ˜¯æˆ‘ä»¬å½“å‰å¯è§çš„æºæ–‡ä»¶ï¼Œsource2.cæ˜¯è¢«é“¾æ¥çš„ELFçš„æºæ–‡ä»¶ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195017042.png" alt="image-20230405195017042" style="zoom:80%;"><p>å…¶ä¸­è¢«staticä¿®é¥°çš„ï¼Œè¢«ç§°ä¸ºå±€éƒ¨ç¬¦å·(Local Symbolã€‰æˆ–é™æ€ç¬¦å·(Static Symbol)ï¼Œåªå¯¹åŒä¸€æºæ–‡ä»¶ä¸­çš„å‡½æ•°å¯è§ã€‚åœ¨æœ¬åœ°æœ‰å®šä¹‰ï¼Œä½†æ²¡æœ‰è¢«staticä¿®é¥°çš„ï¼Œæ˜¯æ™®é€šçš„å…¨å±€ç¬¦å·(Global Symbol)ï¼Œå¯¹é“¾æ¥ä¸­æ‰€æœ‰çš„æºæ–‡ä»¶å¯è§ã€‚è¢«<strong>extern</strong>ä¿®é¥°çš„ï¼Œè¯´æ˜åœ¨å½“å‰çš„æºæ–‡ä»¶ä¸­æ²¡æœ‰å®šä¹‰ï¼Œè€Œåªåœ¨ extern å¤„æœ‰å£°æ˜ï¼Œæ–¹ä¾¿å½“å‰æºæ–‡ä»¶ä¸­çš„å‡½æ•°å¯¹å®ƒè¿›è¡Œå¼•ç”¨ã€‚</p><p>å…¨å±€ç¬¦å·  æˆ‘ä»¬è€ƒå¯Ÿelf.oä¸­çš„ä¾‹å­ï¼Œdata1ä¸data2æ˜¯ä½œä¸ºå˜é‡çš„ç¬¦å·ï¼Œfunc1ä¸func2æ˜¯ä½œä¸ºå‡½æ•°çš„ç¬¦å·ï¼Œå®ƒä»¬æ˜¯å…¸å‹çš„å…¨å±€ç¬¦å·ã€‚æˆ‘ä»¬æ¥è§‚å¯Ÿå…¨å±€ç¬¦å·æ˜¯æ€æ ·åœ¨ELFè¢«æ‰¾åˆ°çš„ã€‚ä»ELF Headerè®¡ç®—åç§»é‡åˆ°Section Header Tableï¼Œå½“æˆ‘ä»¬è¯»å–åˆ°è¡¨é¡¹ä¸º<code>.symtab</code>æ—¶ï¼Œå°±å¼€å§‹å¤„ç†ç¬¦å·è¡¨ï¼Œç¬¦å·è¡¨è¡¨é¡¹çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\uapi\linux\elf.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">elf64_sym</span> &#123;</span><br>  Elf64_Word st_name;<span class="hljs-comment">/* Symbol name, index in string tbl */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Type and binding attributes */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_other;<span class="hljs-comment">/* No defined meaning, 0 */</span><br>  Elf64_Half st_shndx;<span class="hljs-comment">/* Associated section index */</span><br>  Elf64_Addr st_value;<span class="hljs-comment">/* Value of the symbol */</span><br>  Elf64_Xword st_size;<span class="hljs-comment">/* Associated symbol size */</span><br>&#125; Elf64_Sym;<br></code></pre></td></tr></table></figure><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195558160.png" alt="image-20230405195558160" style="zoom: 80%;"><p>æŸ¥çœ‹SHT</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195628645.png" alt="image-20230405195628645" style="zoom:60%;"><p><code>.symtab</code>æ—¶elf.o SHTä¸­çš„ [8] è¡¨é¡¹ï¼Œå®ƒå¯¹äºELFæ–‡ä»¶çš„åç§»ä¸º 0x000000e0ï¼Œå æ®0x120Byteï¼Œå¹¶ä¸”.symtabä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æœ‰å›ºå®šçš„å¤§å°ï¼ŒElf64_Shdr.sh_entrsize &#x3D; 0x0000000000000018ã€‚</p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405195923966.png" alt="image-20230405195923966" style="zoom: 67%;"><p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å¾—åˆ°.symtabä¸€å…±æœ‰12é¡¹ã€‚å¹¶ä¸”å››é¡¹å…³äºdata1ï¼Œdata2ï¼Œfunc1ï¼Œfunc2ï¼š</p><p>é€šè¿‡<code>hexdump -C elf.o</code>åï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs shell">00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|<br>00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|<br>00000020  00 00 00 00 00 00 00 00  a8 02 00 00 00 00 00 00  |................|<br>00000030  00 00 00 00 40 00 00 00  00 00 40 00 0b 00 0a 00  |....@.....@.....|<br>00000040  55 48 89 e5 90 5d c3 55  48 89 e5 90 5d c3 00 00  |UH...].UH...]...|<br>00000050  11 11 11 11 dd dd dd dd  22 22 22 22 dd dd dd dd  |........&quot;&quot;&quot;&quot;....|<br>00000060  00 47 43 43 3a 20 28 55  6f 73 20 38 2e 33 2e 30  |.GCC: (Uos 8.3.0|<br>00000070  2e 33 2d 33 2b 72 65 62  75 69 6c 64 29 20 38 2e  |.3-3+rebuild) 8.|<br>00000080  33 2e 30 00 00 00 00 00  14 00 00 00 00 00 00 00  |3.0.............|<br>00000090  01 7a 52 00 01 78 10 01  1b 0c 07 08 90 01 00 00  |.zR..x..........|<br>000000a0  1c 00 00 00 1c 00 00 00  00 00 00 00 07 00 00 00  |................|<br>000000b0  00 41 0e 10 86 02 43 0d  06 42 0c 07 08 00 00 00  |.A....C..B......|<br>000000c0  1c 00 00 00 3c 00 00 00  00 00 00 00 07 00 00 00  |....&lt;...........|<br>000000d0  00 41 0e 10 86 02 43 0d  06 42 0c 07 08 00 00 00  |.A....C..B......|<br>000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000000f0  00 00 00 00 00 00 00 00  01 00 00 00 04 00 f1 ff  |................|<br>00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000110  00 00 00 00 03 00 01 00  00 00 00 00 00 00 00 00  |................|<br>00000120  00 00 00 00 00 00 00 00  00 00 00 00 03 00 02 00  |................|<br>00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000140  00 00 00 00 03 00 03 00  00 00 00 00 00 00 00 00  |................|<br>00000150  00 00 00 00 00 00 00 00  00 00 00 00 03 00 05 00  |................|<br>00000160  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000170  00 00 00 00 03 00 06 00  00 00 00 00 00 00 00 00  |................|<br>00000180  00 00 00 00 00 00 00 00  00 00 00 00 03 00 04 00  |................|<br>00000190  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000001a0  07 00 00 00 11 00 02 00  00 00 00 00 00 00 00 00  |................|<br>000001b0  08 00 00 00 00 00 00 00  0d 00 00 00 11 00 02 00  |................|<br>000001c0  08 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000001d0  13 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  |................|<br>000001e0  07 00 00 00 00 00 00 00  19 00 00 00 12 00 01 00  |................|<br>000001f0  07 00 00 00 00 00 00 00  07 00 00 00 00 00 00 00  |................|<br>00000200  00 65 6c 66 2e 63 00 64  61 74 61 31 00 64 61 74  |.elf.c.data1.dat|<br>00000210  61 32 00 66 75 6e 63 31  00 66 75 6e 63 32 00 00  |a2.func1.func2..|<br>00000220  20 00 00 00 00 00 00 00  02 00 00 00 02 00 00 00  | ...............|<br>00000230  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|<br>00000240  02 00 00 00 02 00 00 00  07 00 00 00 00 00 00 00  |................|<br>00000250  00 2e 73 79 6d 74 61 62  00 2e 73 74 72 74 61 62  |..symtab..strtab|<br>00000260  00 2e 73 68 73 74 72 74  61 62 00 2e 74 65 78 74  |..shstrtab..text|<br>00000270  00 2e 64 61 74 61 00 2e  62 73 73 00 2e 63 6f 6d  |..data..bss..com|<br>00000280  6d 65 6e 74 00 2e 6e 6f  74 65 2e 47 4e 55 2d 73  |ment..note.GNU-s|<br>00000290  74 61 63 6b 00 2e 72 65  6c 61 2e 65 68 5f 66 72  |tack..rela.eh_fr|<br>000002a0  61 6d 65 00 00 00 00 00  00 00 00 00 00 00 00 00  |ame.............|<br>000002b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>*<br>000002e0  00 00 00 00 00 00 00 00  1b 00 00 00 01 00 00 00  |................|<br>000002f0  06 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000300  40 00 00 00 00 00 00 00  0e 00 00 00 00 00 00 00  |@...............|<br>00000310  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000320  00 00 00 00 00 00 00 00  21 00 00 00 01 00 00 00  |........!.......|<br>00000330  03 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000340  50 00 00 00 00 00 00 00  10 00 00 00 00 00 00 00  |P...............|<br>00000350  00 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>00000360  00 00 00 00 00 00 00 00  27 00 00 00 08 00 00 00  |........&#x27;.......|<br>00000370  03 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000380  60 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |`...............|<br>00000390  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>000003a0  00 00 00 00 00 00 00 00  2c 00 00 00 01 00 00 00  |........,.......|<br>000003b0  30 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |0...............|<br>000003c0  60 00 00 00 00 00 00 00  24 00 00 00 00 00 00 00  |`.......$.......|<br>000003d0  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>000003e0  01 00 00 00 00 00 00 00  35 00 00 00 01 00 00 00  |........5.......|<br>000003f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000400  84 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000410  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000420  00 00 00 00 00 00 00 00  4a 00 00 00 01 00 00 00  |........J.......|<br>00000430  02 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000440  88 00 00 00 00 00 00 00  58 00 00 00 00 00 00 00  |........X.......|<br>00000450  00 00 00 00 00 00 00 00  08 00 00 00 00 00 00 00  |................|<br>00000460  00 00 00 00 00 00 00 00  45 00 00 00 04 00 00 00  |........E.......|<br>00000470  40 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |@...............|<br>00000480  20 02 00 00 00 00 00 00  30 00 00 00 00 00 00 00  | .......0.......|<br>00000490  08 00 00 00 06 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000004a0  18 00 00 00 00 00 00 00  01 00 00 00 02 00 00 00  |................|<br>000004b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>000004c0  e0 00 00 00 00 00 00 00  20 01 00 00 00 00 00 00  |........ .......|<br>000004d0  09 00 00 00 08 00 00 00  08 00 00 00 00 00 00 00  |................|<br>000004e0  18 00 00 00 00 00 00 00  09 00 00 00 03 00 00 00  |................|<br>000004f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000500  00 02 00 00 00 00 00 00  1f 00 00 00 00 00 00 00  |................|<br>00000510  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>00000520  00 00 00 00 00 00 00 00  11 00 00 00 03 00 00 00  |................|<br>00000530  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|<br>00000540  50 02 00 00 00 00 00 00  54 00 00 00 00 00 00 00  |P.......T.......|<br>00000550  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|<br>*<br>00000568<br></code></pre></td></tr></table></figure><p><strong>ä»¥data1ä¸ºä¾‹ï¼Œä»‹ç»å…¶åœ¨ç¬¦å·è¡¨ä¸­çš„å„ç§å«ä¹‰ï¼š</strong></p><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405200137407.png" alt="image-20230405200137407" style="zoom:80%;"><ul><li>æ ¹æ®Elf64_Sym.st_nameå¯ä»¥æŸ¥åˆ°ç¬¦å·åœ¨å­—ç¬¦è¡¨ä¸­çš„åå­—ï¼Œst_name&#x3D;0x7ï¼Œä»å­—ç¬¦ä¸²è¡¨åç§»0x7Byteï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ç»ˆç»“ç¬¦00(<code>\0</code>)ï¼Œæ‰€å¾—åˆ°çš„å­—ç¬¦ä¸²ä¸ºï¼š<u>64 61 74 61 31 00</u>ï¼Œè½¬è¯‘ä¸ºASCIIç çš„å­—ç¬¦ä¸ºâ€™dâ€™,â€™aâ€™,â€™tâ€™,â€™aâ€™,â€™1â€™,â€™\0â€™ã€‚</li></ul><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405200642983.png" alt="image-20230405200642983" style="zoom:80%;"><ul><li>ç¬¦å·data1çš„Sectionç´¢å¼•ä¸ºElf64_Sym.st_index &#x3D; 0x2ï¼Œé‚£ä¹ˆåœ¨SHTä¸­ï¼Œç¼–å·ä¸º[2] çš„è¡¨é¡¹æ˜¯ <code>.data</code>èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬ç¡®å®šäº†data1æ‰€åœ¨çš„Sectionã€‚å†æ ¹æ®Elf64_Sym.st_value&#x3D;0x0ï¼Œæˆ‘ä»¬çŸ¥é“data1å¯¹<code>.data</code>èŠ‚çš„åç§»ä¸º0ï¼Œåˆ°æ­¤ä¸ºæ­¢æ˜¯Environmentæ˜ å°„ã€‚ç”±ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¾—åˆ°data1å æ®Elf64_Sym.st_size &#x3D; 0x8 Byteã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå®Œæˆäº†Typeçš„æ˜ å°„ï¼Œå¯ä»¥è·å¾—data1çš„æ•°å€¼äº†ï¼šã€.dataèŠ‚çš„åç§»é‡ä¸º0x50ï¼Œä¸”data1å¯¹.dataåç§»ä¸º0ï¼Œdata1æ•°å€¼å æ®8å­—èŠ‚ã€‘</li></ul><img src="/2023/04/05/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E2%80%94%E2%80%94%E9%93%BE%E6%8E%A5/image-20230405201014924.png" alt="image-20230405201014924" style="zoom:80%;">]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ,ç¼–è¯‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶</title>
    <link href="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶"><a href="#Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶" class="headerlink" title="Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶"></a>Linuxæ¨¡å—åŠ è½½æ—¶çš„ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶</h1><blockquote><p>å‚è€ƒï¼š<a href="https://www.jb51.cc/python/3860648.html">https://www.jb51.cc/python/3860648.html</a></p></blockquote><p>Linux çš„è¿…é€Ÿå‘å±•è‡´ä½¿ç›¸é‚»ç‰ˆæœ¬çš„å†…æ ¸ä¹‹é—´äº¦å­˜åœ¨è¾ƒå¤§çš„å·®å¼‚ï¼Œå³åœ¨ç‰ˆæœ¬è¡¥ä¸å·ï¼ˆPatch Levelï¼Œå³å†…æ ¸ç‰ˆæœ¬å·çš„ç¬¬å››ä½æ•°ï¼‰ç›¸é‚»çš„å†…æ ¸ä¹‹é—´ã€‚ä¸ºæ­¤ Linux çš„å¼€å‘è€…ä¸ºäº†ä¿è¯å†…æ ¸çš„ç¨³å®šï¼ŒLinux åœ¨åŠ è½½æ¨¡å—åˆ°å†…æ ¸æ—¶å¯¹æ¨¡å—é‡‡ç”¨äº†ç‰ˆæœ¬æ ¡éªŒæœºåˆ¶ã€‚å½“è¢«æœŸæœ›åŠ è½½æ¨¡å—çš„ç³»ç»Ÿç¯å¢ƒä¸æ¨¡å—çš„æ„å»ºç¯å¢ƒç›¸å·¦æ—¶ï¼Œé€šå¸¸ä¼šå‡ºç°å¦‚æ¸…å• 1 æ‰€ç¤ºçš„è£…è½½æ¨¡å—å¤±è´¥ã€‚</p><h2 id="1-æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥"><a href="#1-æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥" class="headerlink" title="1.æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥"></a>1.æ¨¡å—åŠ è½½æ ¡éªŒå¤±è´¥</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å½“æ¨¡å—åŠ è½½æ—¶å€™çš„æŠ¥é”™ä¿¡æ¯ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402204428316.png" alt="image-20230402204428316" style="zoom:100%;"><p>æ¨¡å— hello.ko æ„å»ºæ—¶çš„ç¯å¢ƒä¸å½“å‰ç³»ç»Ÿä¸ä¸€è‡´ï¼Œå¯¼è‡´å·¥å…· insmod åœ¨å°è¯•è£…è½½æ¨¡å— hello.ko åˆ°å†…æ ¸æ—¶å¤±è´¥ã€‚hello.ko æ˜¯ä¸€ä¸ªä»…ä½¿ç”¨äº†å‡½æ•° printk çš„æ™®é€šæ¨¡å—ï¼ˆã€‚æˆ‘ä»¬é€šè¿‡å‘½ä»¤ dmesgè·å–æ¨¡å—è£…è½½å¤±è´¥çš„å…·ä½“åŸå› ã€‚ä»æ—¥å¿—æ‰“å°çš„<code>disagree about version of sysmbol module layout</code>å¯ä»¥çœ‹å‡ºï¼Œæ¨¡å— hello.ko è£…è½½å¤±è´¥æ˜¯ç”±äº<strong>æ¨¡å—ä¸­ module_layout çš„å¯¼å‡ºç¬¦å·çš„ç‰ˆæœ¬ä¿¡æ¯ä¸å½“å‰å†…æ ¸ä¸­çš„ä¸ç¬¦</strong>ã€‚</p><p>å‡½æ•° module_layout è¢«å®šä¹‰åœ¨å†…æ ¸æ¨¡å—ç‰ˆæœ¬é€‰é¡¹ MODVERSIONSï¼ˆå³å†…æ ¸å¯è£…è½½æ¨¡å—çš„ç‰ˆæœ¬æ ¡éªŒé€‰é¡¹ï¼‰ä¹‹åã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># kernel\module.c</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MODVERSIONS</span><br><span class="hljs-comment">/* Generate the signature for all relevant module structures here.</span><br><span class="hljs-comment"> * If these change, we don&#x27;t want to try to parse the module. */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">module_layout</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> module *mod,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> modversion_info *ver,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> kernel_param *kp,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> kernel_symbol *ks,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> tracepoint * <span class="hljs-type">const</span> *tp)</span><br>&#123;<br>&#125;<br>EXPORT_SYMBOL(module_layout);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ¯”å¯¹å†…æ ¸çš„module_layout å’Œ å¤–éƒ¨æ¨¡å—çš„module_layoutå€¼å‘¢ï¼Ÿ</p><h3 id="1-1-æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module-layoutçš„CRC"><a href="#1-1-æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module-layoutçš„CRC" class="headerlink" title="1.1 æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module_layoutçš„CRC"></a>1.1 æ¯”å¯¹å†…æ ¸ä¸æ¨¡å—module_layoutçš„CRC</h3><p>å†…æ ¸çš„<code>module_layout</code>çš„CRCå€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å†…æ ¸ç¼–è¯‘çš„<code>Module.symvers</code>æ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat Module.symvers | grep module_layout<br></code></pre></td></tr></table></figure><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402194808674.png" alt="image-20230402194808674" style="zoom:100%;"><p>å¤–éƒ¨æ¨¡å—<code>module_layout</code>çš„CRCå€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡modprodeæŸ¥çœ‹ç¼–è¯‘å‡ºçš„koæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">modprobe --dump-versions xxx.ko | grep module_layout<br></code></pre></td></tr></table></figure><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402194909699.png" alt="image-20230402194909699" style="zoom:100%;"><blockquote><p>å¯ä»¥çœ‹åˆ°å†…æ ¸ä¸å¤–éƒ¨æ¨¡å—çš„module_layoutå€¼æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>insmodæˆ–è€…modprobeåŠ è½½chrdevbase.ko</strong></p></blockquote><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/8d71df88-4caa-436c-b5eb-72d2a53f2b31.png"><h3 id="1-2-Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ"><a href="#1-2-Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ" class="headerlink" title="1.2 Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ"></a>1.2 Linuxå¯¹äºæ¨¡å—çš„ä¸¤å±‚æ£€éªŒ</h3><p>inux å¯¹å¯è£…è½½æ¨¡å—é‡‡å–äº†ä¸¤å±‚éªŒè¯ï¼š<strong>æ¨¡å—çš„ CRC å€¼æ ¡éªŒ</strong>å’Œ <strong>vermagic çš„æ£€æŸ¥</strong>ã€‚</p><p>å…¶ä¸­æ¨¡å— CRC å€¼æ ¡éªŒé’ˆå¯¹æ¨¡å—ï¼ˆå†…æ ¸ï¼‰å¯¼å‡ºç¬¦å·ï¼Œæ˜¯ä¸€ç§ç®€å•çš„ ABIï¼ˆå³ Application Binary Interfaceï¼‰ä¸€è‡´æ€§æ£€æŸ¥ï¼Œç¬¬ä¸€èŠ‚å¼€å¤´çš„ hello.ko åŠ è½½å¤±è´¥çš„æ ¹æœ¬åŸå› å°±æ˜¯æ²¡æœ‰é€šè¿‡ CRC å€¼æ ¡éªŒï¼ˆå³ module_layout çš„ CRC å€¼ä¸å½“å‰å†…æ ¸ä¸­çš„ä¸ç¬¦ï¼‰ã€‚</p><p>è€Œæ¨¡å— vermagicï¼ˆå³ Version Magic Stringï¼‰åˆ™ä¿å­˜äº†æ¨¡å—ç¼–è¯‘æ—¶çš„å†…æ ¸ç‰ˆæœ¬ä»¥åŠ SMP ç­‰é…ç½®ä¿¡æ¯ï¼Œå½“æ¨¡å— vermagic ä¸ä¸»æœºä¿¡æ¯ä¸ç›¸ç¬¦æ—¶äº¦å°†ç»ˆæ­¢æ¨¡å—çš„åŠ è½½ã€‚</p><h2 id="2-æ¨¡å—çš„CRCå€¼æ ¡éªŒ"><a href="#2-æ¨¡å—çš„CRCå€¼æ ¡éªŒ" class="headerlink" title="2.æ¨¡å—çš„CRCå€¼æ ¡éªŒ"></a>2.æ¨¡å—çš„CRCå€¼æ ¡éªŒ</h2><p>é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸€ä¸‹CTCå€¼æ ¡éªŒåœ¨å“ªé‡Œæ·»åŠ ï¼Œåˆæ˜¯å¦‚ä½•è¿›è¡Œæ ¡éªŒçš„</p><h3 id="2-1-æ·»åŠ æ¨¡å—çš„CRCå€¼"><a href="#2-1-æ·»åŠ æ¨¡å—çš„CRCå€¼" class="headerlink" title="2.1 æ·»åŠ æ¨¡å—çš„CRCå€¼"></a>2.1 æ·»åŠ æ¨¡å—çš„CRCå€¼</h3><p>å½“æˆ‘ä»¬åœ¨ç¼–è¯‘å†…æ ¸æ¨¡å—æ—¶ï¼Œä¼šç”Ÿæˆè®¸å¤šçš„ä¸­é—´æ–‡ä»¶ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402205606535.png" alt="image-20230402205606535" style="zoom:80%;"><p>å…¶ä¸­<strong>chrdevbase.mod.c</strong>æ˜¯åœ¨æ¨¡å—æºæ–‡ä»¶chrdevbase.cåŸºç¡€ä¸Šè¿›è¡Œçš„æ‰©å±•ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402205711705.png" alt="image-20230402205711705" style="zoom:67%;"><blockquote><p>ğŸ¤º <strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçº¢è‰²åœˆå‡ºæ¥çš„å°±æ˜¯å„ä¸ªç¬¦å·ï¼Œå‰é¢çš„16è¿›åˆ¶æ•°å­—å°±æ˜¯æ¯ä¸ªç¬¦å·å¯¹åº”çš„CRCå€¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œmodule_layoutå¯¹åº”çš„CRCå€¼å°±æ˜¯0xfa985410ï¼Œä¸1.1èŠ‚çœ‹åˆ°çš„æ˜¯ä¸€æ ·çš„ï¼</p></blockquote><p>é‚£ä¹ˆchrdevbase.mod.cåœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­ï¼Œ ä¼šè°ƒç”¨modpostæ·»åŠ å„ç§ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€æ­¥å°±æ˜¯æ·»åŠ ç‰ˆæœ¬å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// scripts\mod\modpost.h</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-keyword">for</span> (mod = modules; mod; mod = mod-&gt;next) &#123;<br>err |= add_versions(&amp;buf, mod);<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_versions</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buffer *b, <span class="hljs-keyword">struct</span> module *mod)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> *<span class="hljs-title">s</span>, *<span class="hljs-title">exp</span>;</span><br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">for</span> (s = mod-&gt;unres; s; s = s-&gt;next) &#123;<br><span class="hljs-built_in">exp</span> = find_symbol(s-&gt;name);<br>s-&gt;module = <span class="hljs-built_in">exp</span>-&gt;module;<br>s-&gt;crc_valid = <span class="hljs-built_in">exp</span>-&gt;crc_valid;<br>s-&gt;crc = <span class="hljs-built_in">exp</span>-&gt;crc;<br>&#125;<br><br>buf_printf(b, <span class="hljs-string">&quot;\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;static const struct modversion_info ____versions[]\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;__used\n&quot;</span>);<br>buf_printf(b, <span class="hljs-string">&quot;__attribute__((section(\&quot;__versions\&quot;))) = &#123;\n&quot;</span>);<br><br><span class="hljs-keyword">for</span> (s = mod-&gt;unres; s; s = s-&gt;next) &#123;<br><span class="hljs-keyword">if</span> (!s-&gt;module)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!s-&gt;crc_valid) &#123;<br>warn(<span class="hljs-string">&quot;\&quot;%s\&quot; [%s.ko] has no CRC!\n&quot;</span>,<br>s-&gt;name, mod-&gt;name);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>        <span class="hljs-comment">// æ·»åŠ å„ä¸ªç¬¦å·SYSBOLå¯¹åº”çš„CRCå€¼</span><br>buf_printf(b, <span class="hljs-string">&quot;\t&#123; %#8x, __VMLINUX_SYMBOL_STR(%s) &#125;,\n&quot;</span>, s-&gt;crc, s-&gt;name);<br>&#125;<br><br>buf_printf(b, <span class="hljs-string">&quot;&#125;;\n&quot;</span>);<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>å“‡å“¦ï¼Œä»è¿™é‡Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œæœ€ç»ˆç”Ÿæˆçš„chrdevbase.mod.cã€æˆ–chrdevbase.koã€‘æ˜¯é€šè¿‡add_versionæ·»åŠ çš„ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402210324480.png" alt="image-20230402210324480" style="zoom:80%;"><h3 id="2-2-é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼"><a href="#2-2-é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼" class="headerlink" title="2.2 é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼"></a>2.2 é€šè¿‡objdumpåæ±‡ç¼–åæŸ¥çœ‹versionsçš„å€¼</h3><p>æˆ‘ä»¬åœ¨ä¸Šè¿°<code>cat chrdevbase.mod.c</code>ä¸­å¯ä»¥çœ‹åˆ°å‡ ä¸ªsectionï¼Œå¦‚ .modinfoã€.gnu.linkonce.this_module å’Œ __versionsã€‚<u>Linux ä½¿ç”¨ GCC ä¸­çš„å£°æ˜å‡½æ•°å±æ€§ <code>__attribute__ </code>å®Œæˆå¯¹æ¨¡å—çš„ç‰ˆæœ¬ä¿¡æ¯é™„åŠ </u>ã€‚</p><p>é€šè¿‡<code>objdump --section=__versions -s chrdevbase.ko</code>çš„å€¼æŸ¥çœ‹å½“å‰æ¨¡å—çš„ç‰ˆæœ¬versionå€¼</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402211313240.png" alt="image-20230402211313240" style="zoom:50%;"><p>å¯ä»¥çœ‹åˆ°å½“å‰æ¨¡å—çš„module_layoutä¹ŸåŒ¹é…ä¸Šäº†ï¼Œå¦å¤–çš„å‡ ä¸ªå€¼ï¼Œå¦‚<code>__unregister_chrdev</code>ä¹Ÿå¯¹åº”äº†ä¸Šè¿°çš„CRCå€¼</p><h3 id="2-3-åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC"><a href="#2-3-åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC" class="headerlink" title="2.3 åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC"></a>2.3 åŠ è½½æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½•æ—¶æ£€éªŒCRC</h3><p>ğŸ¥‡ğŸ¥ˆğŸ¥‰ <strong>æ¨¡å— CRC å€¼æ ¡éªŒæŸ¥çœ‹çš„æ˜¯å°±æ˜¯æ¨¡å— __versions å°èŠ‚çš„å†…å®¹ï¼Œæ¨¡å—çš„ CRC æ ¡éªŒè¿‡ç¨‹åœ¨å‡½æ•° setup_load_info ä¸­å®Œæˆ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel\module.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> module *<span class="hljs-title function_">setup_load_info</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> load_info *info, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">/* Check module struct version now, before we try to use module. */</span><br><span class="hljs-keyword">if</span> (!check_modstruct_version(info-&gt;sechdrs, info-&gt;index.vers, mod))<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOEXEC);<br><br><span class="hljs-keyword">return</span> mod;<br>&#125;<br><br><span class="hljs-comment">//--------------------------------------------------------</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_modstruct_version</span><span class="hljs-params">(Elf_Shdr *sechdrs, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> versindex, <span class="hljs-keyword">struct</span> module *mod)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *crc;<br><br><span class="hljs-keyword">if</span> (!find_symbol(VMLINUX_SYMBOL_STR(module_layout), <span class="hljs-literal">NULL</span>,&amp;crc, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>))<br>        BUG();<br><span class="hljs-keyword">return</span> check_version(sechdrs, versindex, VMLINUX_SYMBOL_STR(module_layout), mod, crc, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-comment">//--------------------------------------------------------</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_version</span><span class="hljs-params">(Elf_Shdr *sechdrs, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> versindex, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symname, <span class="hljs-keyword">struct</span> module *mod, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *crc, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> module *crc_owner)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, num_versions;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">modversion_info</span> *<span class="hljs-title">versions</span>;</span><br><br><br>versions = (<span class="hljs-type">void</span> *) sechdrs[versindex].sh_addr;<br>num_versions = sechdrs[versindex].sh_size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> modversion_info);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num_versions; i++) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(versions[i].name, symname) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (versions[i].crc == maybe_relocated(*crc, crc_owner))<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>pr_debug(<span class="hljs-string">&quot;Found checksum %lX vs module %lX\n&quot;</span>,<br>       maybe_relocated(*crc, crc_owner), versions[i].crc);<br><span class="hljs-keyword">goto</span> bad_version;<br>&#125;<br><br>pr_warn(<span class="hljs-string">&quot;%s: no symbol version for %s\n&quot;</span>, mod-&gt;name, symname);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>bad_version:<br>pr_warn(<span class="hljs-string">&quot;%s: disagrees about version of symbol %s\n&quot;</span>,<br>       mod-&gt;name, symname);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æˆ‘çš„å¤©ï¼Œç»ˆäºçœ‹åˆ°äº†ç¬¬1èŠ‚æŠ¥é”™çš„æŠ¥é”™çš„æ¥æºå•¦ï¼</strong></p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230402213008474.png" alt="image-20230402213008474" style="zoom:80%;"><h3 id="2-4-ä¸ºä»€ä¹ˆmodule-layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–"><a href="#2-4-ä¸ºä»€ä¹ˆmodule-layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–" class="headerlink" title="2.4 ä¸ºä»€ä¹ˆmodule_layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–"></a>2.4 ä¸ºä»€ä¹ˆmodule_layoutå¯¼å‡ºçš„ç¬¦å·ä¼šå‘ç”Ÿå˜åŒ–</h3><p>æ ¹æ®é™„å½•2ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¯¼å‡ºçš„ç¬¦å·å¦‚æœæ˜¯å‡½æ•°æ—¶ï¼Œå¦‚æœCRCå€¼å‘ç”Ÿäº†æ”¹å˜ï¼Œå¯èƒ½æ˜¯<strong>å‚æ•°å˜åŒ–</strong>æˆ–è€…<strong>è¿”å›å€¼å˜åŒ–</strong>ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å°†<strong>module_layout</strong>çš„å‚æ•°è¿›è¡Œå˜åŒ–ï¼Œç¼–è¯‘åæŸ¥çœ‹å…¶CRCå€¼</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405235046404.png" alt="image-20230405235046404" style="zoom: 50%;"><blockquote><p>æˆ‘ä»¬åœ¨å‚æ•°ä¸­æ·»åŠ äº†<code>int num</code>ï¼Œå‘ç°å€¼å˜åŒ–æˆäº†<code>0x5d01a2ac</code></p></blockquote><p>å°†<strong>module_layout</strong>çš„å‚æ•°æ¢å¤æˆåŸæ ·ï¼Œé‡æ–°ç¼–è¯‘</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405235204648.png" alt="image-20230405235204648" style="zoom:50%;"><blockquote><p>å¯ä»¥çœ‹åˆ°åˆæ¢å¤æˆäº†åŸæ¥çš„1.1èŠ‚ä¸­çš„å€¼</p></blockquote><h3 id="2-5-module-layout-å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ"><a href="#2-5-module-layout-å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ" class="headerlink" title="2.5 module_layout å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ"></a>2.5 module_layout å®Œå…¨ä¸€æ ·çš„ä¸¤ä»½kernelä»£ç ï¼Œç”ŸæˆCRCå€¼ä¸ä¸€æ ·ï¼Ÿ</h3><p>å½“æˆ‘ä»¬åœ¨module.cä¸­<code>EXPORT_SYMBOL(module_layout)</code>ä¹‹åï¼Œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå®ä¼šè¢«æ›¿æ¢æˆä¸‹é¢çš„å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\export.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __CRC_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">extern __visible void *__crc_##sym __attribute__((weak));\</span><br><span class="hljs-meta">static const unsigned long __kcrctab_##sym\</span><br><span class="hljs-meta">__used\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;___kcrctab&quot;</span> sec <span class="hljs-string">&quot;+&quot;</span> #sym), unused))\</span><br><span class="hljs-meta">= (unsigned long) &amp;__crc_##sym;</span><br><br><span class="hljs-comment">/* For every exported symbol, place a struct in the __ksymtab section */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __EXPORT_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">extern typeof(sym) sym;\</span><br><span class="hljs-meta">__CRC_SYMBOL(sym, sec)\</span><br><span class="hljs-meta">static const char __kstrtab_##sym[]\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;__ksymtab_strings&quot;</span>), aligned(1))) \</span><br><span class="hljs-meta">= VMLINUX_SYMBOL_STR(sym);\</span><br><span class="hljs-meta">extern const struct kernel_symbol __ksymtab_##sym;\</span><br><span class="hljs-meta">__visible const struct kernel_symbol __ksymtab_##sym\</span><br><span class="hljs-meta">__used\</span><br><span class="hljs-meta">__attribute__((section(<span class="hljs-string">&quot;___ksymtab&quot;</span> sec <span class="hljs-string">&quot;+&quot;</span> #sym), unused))\</span><br><span class="hljs-meta">= &#123; (unsigned long)&amp;sym, __kstrtab_##sym &#125;</span><br></code></pre></td></tr></table></figure><p>EXPORT_SYMBOL(sym)çš„è¿™ä¸€æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯é’ˆå¯¹æ¨¡å—ç‰ˆæœ¬æ ¡éªŒæœºåˆ¶ï¼Œç”Ÿæˆäº†æŸä¸ªç¬¦å·ç›¸åº”çš„3ä¸ªæ®µçš„å€¼ã€‚æ®µ<code>__ksymtab</code>ä¿å­˜äº†ç¬¦å·çš„åœ°å€å’Œåå­—ï¼Œæ®µ<code>__ksymtab_strings</code>æ˜¯æ®µåå­—çš„å®é™…å­˜å‚¨ä½ç½®ï¼Œæ®µ<code>__kcrctab</code>ä¿å­˜äº†ç¬¦å·crcå€¼çš„åœ°å€ã€‚</p><p>å¯è§EXPORT_SYMBOL(sym)å®å£°æ˜ä»¥åï¼Œç¬¦å·çš„åœ°å€åå­—å’ŒCRCå€¼éƒ½æœ‰äº†ï¼Œå·²ç»ç¬¦åˆç‰ˆæœ¬æ ¡éªŒçš„éœ€è¦äº†ã€‚å¯è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œç¬¦å·å®é™…çš„crcå€¼æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿå®ä¸­å¼•ç”¨äº†ä¸€ä¸ªå¤–éƒ¨å˜é‡<code>extern void *__crc_##sym attribute((weak));</code>ï¼Œ<code>__crc##sym</code>æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p><p>__crc##symæ˜¯åœ¨ç¼–è¯‘.oæ—¶å€™åšçš„ï¼ŒæŸ¥çœ‹å†…æ ¸çš„makefileï¼Œmakefile.buildæ–‡ä»¶å®šä¹‰äº†.oçš„ç”Ÿæˆè§„åˆ™ï¼š<br><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406225635425.png" alt="image-20230405235204648" style="zoom: 67%;"></p><p>è€Œå½“CONFIG_MODVERSIONS&#x3D;y æ—¶ï¼Œ cmd_cc_o_c ä¼šå°†file.c ç¼–è¯‘æˆ.tmp_file.oè€Œä¸æ˜¯file.o ã€‚cmd_modversions ä¼šæ£€æŸ¥.tmp_file.o æ˜¯å¦åŒ…å«<code>__ksymtab</code> ï¼Œä¹Ÿå°±æ˜¯è¯´file.c æ˜¯å¦åŒ…å«EXPORT_SYMBOL(xxx)ï¼›å¦‚æœæ²¡æœ‰__ksymtab ï¼Œ cmd_modversions ä¼šå°†.tmp_file.o ç›´æ¥æ›´åä¸ºfile.o ã€‚å¦‚æœç¡®å®åŒ…å«__ksymtab ï¼Œ cmd_modversions ä¼šé€šè¿‡genksyms äº§ç”Ÿxxxx ( export symbol )çš„ç¬¦å·ç­¾å( checksum )ï¼Œç„¶åè°ƒç”¨linker é‡æ–°æŠŠè¿™äº›ç¬¦å·ä»¥åŠè¿™äº›ç¬¦å·çš„checksumé“¾æ¥è¿›file.oã€‚</p><p>å¯è§ç¬¦å·çš„CRCå€¼_crc##symï¼Œæ˜¯åœ¨ç¼–è¯‘.oæ—¶ï¼Œç”±genksymsè„šæœ¬ç”Ÿæˆçš„ã€‚</p><p>é€šè¿‡readelfå‘½ä»¤å¯ä»¥ï¼ŒæŸ¥çœ‹å†…æ ¸ä¸­å…³äºç‰ˆæœ¬æ£€æŸ¥çš„ä¸‰ä¸ªæ®µ<code>__ksymtab</code>ã€<code>__ksymtab_strings</code>ã€<code>__kcrctab</code>ï¼š</p><p><img src="/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406231443917.png" alt="image-20230406231443917"></p><p>å¦‚æœmodule_layoutåœ¨ç¬¦å·è¡¨ä¸­åœ°å€ä¸åŒï¼Œåˆ™ç¼–è¯‘ç”ŸæˆåæœŸå¯¹åº”çš„CRCå€¼æ˜¯ä¸åŒçš„ï¼ï¼</p><p>ğŸ¤– <strong>å¦‚æœä¸¤ä»½å®Œå…¨ä¸€æ ·çš„module_layoutä»£ç ï¼Œä½†æ˜¯ç”Ÿæˆçš„CRCå€¼ä¸åŒ</strong>  -&gt; é‚£ä¹ˆï¼Œå¿…å®šæ˜¯module_layoutåœ¨ç¬¦å·è¡¨ä¸­çš„ä½ç½®ä¸åŒï¼Œä¹Ÿå°±æ˜¯åœ¨module_layoutä¹‹å‰è‚¯å®šEXPORT_SYMBOLäº†å…¶ä»–çš„ç¬¦å·ï¼Œå¯¼è‡´module_layoutåœ¨å¯¹åº”çš„ç¬¦å·è¡¨ä¸­ä½ç½®ä¸åŒ</p><h2 id="3-æ¨¡å—çš„vermagicæ£€éªŒ"><a href="#3-æ¨¡å—çš„vermagicæ£€éªŒ" class="headerlink" title="3.æ¨¡å—çš„vermagicæ£€éªŒ"></a>3.æ¨¡å—çš„vermagicæ£€éªŒ</h2><h3 id="3-1-å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„"><a href="#3-1-å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„" class="headerlink" title="3.1 å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„"></a>3.1 å†…æ ¸ç‰ˆæœ¬æ˜¯å¦‚ä½•ç”Ÿæˆçš„</h3><p>inuxç‰ˆæœ¬ï¼šåœ¨<code>include/generated/utsrelease.h</code>ä¸­å®šä¹‰ï¼Œæ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š**#define UTS_RELEASE â€œ4.1.15â€**ï¼Œutsrelease.hæ˜¯kernelç¼–è¯‘åè‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”¨æˆ·æ›´æ”¹é‡Œé¢çš„å†…å®¹ä¸ä¼šæœ‰æ•ˆæœã€‚</p><h3 id="3-2-æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„"><a href="#3-2-æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„" class="headerlink" title="3.2 æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„"></a>3.2 æ¨¡å—çš„vermagicæ˜¯å¦‚ä½•ç”Ÿæˆçš„</h3><p>åœ¨<code>include/linux/vermagic.h</code>ä¸­å®šä¹‰æœ‰VERMAGIC_STRINGï¼ŒVERMAGIC_STRINGä¸ä»…åŒ…å«å†…æ ¸ç‰ˆæœ¬å·ï¼Œè¿˜åŒ…å«æœ‰ å†…æ ¸ä½¿ç”¨çš„gccç‰ˆæœ¬ï¼ŒSMPä¸PREEMPTç­‰é…ç½®ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> VERMAGIC_STRING \</span><br><span class="hljs-meta">UTS_RELEASE <span class="hljs-string">&quot; &quot;</span>\</span><br><span class="hljs-meta">MODULE_VERMAGIC_SMP MODULE_VERMAGIC_PREEMPT \</span><br><span class="hljs-meta">MODULE_VERMAGIC_MODULE_UNLOAD MODULE_VERMAGIC_MODVERSIONS\</span><br><span class="hljs-meta">MODULE_ARCH_VERMAGIC</span><br></code></pre></td></tr></table></figure><p>æ¨¡å—åœ¨ç¼–è¯‘æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å±å¹•ä¸Šä¼šæ˜¾ç¤ºâ€MODPOSTâ€ã€‚åœ¨æ­¤é˜¶æ®µï¼ŒVERMAGIC_STRINGä¼šæ·»åŠ åˆ°æ¨¡å—çš„modinfoæ®µã€‚åœ¨å†…æ ¸æºç ç›®å½•ä¸‹scripts\mod\modpost.cæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°æ¨¡å—åç»­å¤„ç†éƒ¨åˆ†çš„ä»£ç ã€‚</p><p>æ¨¡å—ç¼–è¯‘ç”Ÿæˆåï¼Œé€šè¿‡<code>modinfo xxx.ko</code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ­¤æ¨¡å—çš„vermagicç­‰ä¿¡æ¯ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230406233259580.png" alt="image-20230406233259580" style="zoom: 80%;"><h3 id="3-3-å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic"><a href="#3-3-å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic" class="headerlink" title="3.3 å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic"></a>3.3 å¦‚ä½•æ ¡éªŒæ¨¡å—çš„vermagic</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* kernel/module.c */</span> <br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_modinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> module *mod,<span class="hljs-keyword">struct</span> load_info *info)</span> <br>&#123; <br> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *modmagic = get_modinfo(info,<span class="hljs-string">&quot;vermagic&quot;</span>); <br> ... <br> &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!same_magic(modmagic,vermagic,info-&gt;index.vers)) &#123; <br>   ... <br> &#125; <br> ... <br> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é™„å½•1ï¼šmodule-symvers-æ–‡ä»¶çš„å†…å®¹"><a href="#é™„å½•1ï¼šmodule-symvers-æ–‡ä»¶çš„å†…å®¹" class="headerlink" title="é™„å½•1ï¼šmodule.symvers æ–‡ä»¶çš„å†…å®¹"></a>é™„å½•1ï¼šmodule.symvers æ–‡ä»¶çš„å†…å®¹</h2><p>å¦‚æœæ‰“å¼€è¯¥æ–‡ä»¶åçœ‹åˆ°çš„ç¬¦å·CRCå€¼éƒ½æ˜¯0x00000000ï¼Œé‚£æ˜¯å› ä¸ºä½ åœ¨é…ç½®çš„æ—¶å¹¶æ²¡æœ‰è®¾ç½® <code>CONFIG_MODVERSIONS</code>ã€‚ä¸€æ—¦è®¾ç½®è¿‡è¿™ä¸ªé…ç½®é€‰é¡¹ï¼Œå°±æ„å‘³ç€æ‰“å¼€äº†å†…æ ¸çš„ <strong>Module versioning</strong>åŠŸèƒ½ã€‚Module versioning åŠŸèƒ½åº”ç”¨åœ¨æˆ‘ä»¬ä½¿ç”¨æ¨¡å—çš„åœºåˆã€‚</p><p>å¦‚æœModule versioningåŠŸèƒ½è¢«æ‰“å¼€çš„è¯ï¼Œå®ƒä¼šä»¥æ¯ä¸ªå¯¼å‡ºç¬¦å·çš„CåŸå‹å£°æ˜ä½œä¸ºè¾“å…¥ï¼Œè®¡ç®—å‡ºå¯¹åº”çš„CRCæ ¡éªŒå€¼ï¼Œä¿å­˜åœ¨æ–‡ä»¶ Module.symvers ä¸­ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå†…æ ¸åœ¨åé¢è¦åŠ è½½ä½¿ç”¨æ¨¡å—çš„æ—¶å€™ï¼Œä¼šä¸¤ç›¸æ¯”è¾ƒæ¨¡å—ä¸­çš„CRCå€¼å’Œä¿å­˜ä¸‹æ¥çš„CRCå€¼ï¼Œå¦‚æœå‘ç°ä¸ç›¸ç­‰ï¼Œå†…æ ¸å°±æ‹’ç»åŠ è½½è¿™ä¸ªæ¨¡å—ã€‚</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230403230704333.png" alt="image-20230403230704333" style="zoom:100%;"><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230403231013373.png" alt="image-20230403231013373" style="zoom:100%;"><h2 id="é™„å½•2ï¼šCRCæœºåˆ¶"><a href="#é™„å½•2ï¼šCRCæœºåˆ¶" class="headerlink" title="é™„å½•2ï¼šCRCæœºåˆ¶"></a>é™„å½•2ï¼šCRCæœºåˆ¶</h2><blockquote><p><a href="https://zhuanlan.zhihu.com/p/414290127?utm_id=0">https://zhuanlan.zhihu.com/p/414290127?utm_id=0</a></p></blockquote><p>å†…æ ¸æ¨¡å—ç¬¦å·CRCç”Ÿæˆç›¸å…³ä»£ç åœ¨scripts&#x2F;genksyms&#x2F;ç›®å½•ä¸‹é¢ï¼Œæ³¨æ„å…¶ä¸­é™¤äº†cä»£ç ä¼šè¿›è¡Œè§£æä¹‹å¤–ï¼Œlex.lå’Œparse.yä¹Ÿä¼šè¿›è¡Œåˆæ­¥çš„è§£æã€‚CRCå³cyclic redundancy checkï¼Œç”¨äºé”™è¯¯æ£€æŸ¥ã€‚åªæœ‰å½“å†…å®¹ä¿æŒä¸å˜çš„æ—¶å€™ï¼ŒCRCæ‰ä¼šä¿æŒä¸å˜ã€‚å†…æ ¸æ¨¡å—ä¸»è¦å¯¹å¯¼å‡ºçš„ç¬¦å·ï¼ˆEXPORT_SYMBOLï¼‰åšæ£€æŸ¥ï¼Œè¦æ±‚ä¿æŒä¸¤ä¸ªä¸€è‡´æ€§ï¼š</p><ol><li>æ¥å£ä¸€è‡´ï¼šå˜é‡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›å€¼ç±»å‹åæ²¡æœ‰å˜åŒ–ï¼Œè‹¥æ˜¯ç»“æ„ä½“ï¼Œå…¶å†…éƒ¨æ‰€æœ‰æˆå‘˜ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼›</li><li>è¯­ä¹‰ä¸€è‡´ï¼šç»“æ„ä½“æˆå‘˜å˜é‡åä¸èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå‡½æ•°å‚æ•°åæ— éœ€ä¿æŒä¸€è‡´ã€‚</li></ol><h3 id="CRCåŸºæœ¬å‡½æ•°"><a href="#CRCåŸºæœ¬å‡½æ•°" class="headerlink" title="CRCåŸºæœ¬å‡½æ•°"></a>CRCåŸºæœ¬å‡½æ•°</h3><p>linuxé¢„å…ˆå®šä¹‰äº†256ä¸ªï¼ˆ0xffï¼‰crctabï¼Œå³ç”¨äºå¼‚æˆ–æ“ä½œçš„åŸºï¼Œå¹¶ä»¥32ä½ä¸ºå•ä½æ¥åšCRCæ“ä½œï¼Œç›¸å…³å†…æ ¸æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">partial_crc32_one</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> crc)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> crctab32[(crc ^ c) &amp; <span class="hljs-number">0xff</span>] ^ (crc &gt;&gt; <span class="hljs-number">8</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">partial_crc32</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> crc)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (*s)<br>        crc = partial_crc32_one(*s++, crc);<br>    <span class="hljs-keyword">return</span> crc;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">crc32</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> partial_crc32(s, <span class="hljs-number">0xffffffff</span>) ^ <span class="hljs-number">0xffffffff</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹æ˜¯ä»åˆå§‹å­—ç¬¦å¼€å§‹åˆ°æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²éƒ½ç”¨ç›¸åŒçš„æ“ä½œè®¡ç®—crcå€¼ï¼Œç›´åˆ°å­—ç¬¦ä¸²ç»“æŸï¼Œå¾—åˆ°æœ€ç»ˆçš„CRCå€¼ã€‚</p><p>å¯¹EXPORT_SYMBOLçš„ç¬¦å·è¿›è¡Œcrcè°ƒç”¨å¹¶ä¸ç”±scripts&#x2F;genksyms&#x2F;ä¸­çš„cä»£ç ç›´æ¥å‘èµ·ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æœŸçš„è¯­æ³•ç”Ÿæˆæ—¶ç”±bisonçš„semantic actionså‘èµ·ï¼Œç›¸å…³ç”Ÿæˆè§„åˆ™å¦‚ä¸‹ï¼ˆåœ¨scripts&#x2F;genksyms&#x2F;parse.yï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">export_definition:<br>    EXPORT_SYMBOL_KEYW <span class="hljs-string">&#x27;(&#x27;</span> IDENT <span class="hljs-string">&#x27;)&#x27;</span> <span class="hljs-string">&#x27;;&#x27;</span><br>        &#123; export_symbol((*$<span class="hljs-number">3</span>)-&gt;<span class="hljs-built_in">string</span>); $$ = $<span class="hljs-number">5</span>; &#125;<br>    ;<br></code></pre></td></tr></table></figure><p>å³ç¢°åˆ°EXPROT_SYMBOLå…³é”®è¯æ—¶ï¼Œè°ƒç”¨genksyms.cé‡Œçš„export_symbolï¼Œç”Ÿæˆcrcå€¼ã€‚</p><h3 id="CRCè®¡ç®—ä¸¾ä¾‹"><a href="#CRCè®¡ç®—ä¸¾ä¾‹" class="headerlink" title="CRCè®¡ç®—ä¸¾ä¾‹"></a>CRCè®¡ç®—ä¸¾ä¾‹</h3><p><strong>åŸºæœ¬ç±»å‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> abcde;<br>EXPORT_SYMBOL(abcde);<br></code></pre></td></tr></table></figure><p>å¯¹äºç¬¦å·abcdeï¼Œè®¡ç®—è¿‡ç¨‹æ˜¯ï¼š</p><ol><li>partial_crc32(â€œunsignedâ€, 0xffffffff) â‡’ 0xa9df1ba</li><li>partial_crc32_one(â€œ â€œ, 0xa9df1ba) â‡’ 0x10d0e7ab</li><li>partial_crc32(â€œintâ€, 0x10d0e7ab) â‡’ 0xa9d106cd</li><li>partial_crc32_one(â€œ â€œ, 0xa9d106cd) â‡’ 0xde124fc3</li><li>partial_crc32(â€œabcdeâ€, 0xde124fc3) â‡’ 0x2e7e6a97</li><li>partial_crc32_one(â€œ â€œ, 0x2e7e6a97) â‡’ 0x552b5845</li><li>0x552b5845 ^ 0xffffffff â‡’ 0xaad4a7ba</li></ol><p>æœ€ç»ˆï¼Œabcdeçš„crcå€¼å³ä¸º0xaad4a7baï¼Œå¯ä»¥é€šè¿‡Module.symversæŸ¥çœ‹å¾—åˆ°ã€‚</p><p>å¯ä»¥å‘ç°ï¼Œä»¥ä¸Šæ¯æ­¥ç›¸å½“äºæŠŠå˜é‡å£°æ˜çš„æ¯ä¸ªç¬¦å·ä¾æ¬¡è®¡ç®—äº†ä¸€écrc32å€¼ï¼Œä¸”æ¯ä¸ªç¬¦å·è®¡ç®—åï¼Œéƒ½ä¼šä¸ç©ºæ ¼çš„crcå“ˆå¸Œå€¼åšå¼‚æˆ–ï¼Œæœ€åå°†ç»“æœçš„å€¼å–0xffffffffçš„å¼‚æˆ–ï¼Œå³æ˜¯æœ€ç»ˆç¬¦å·çš„crcå€¼ï¼Œå³å¦‚ä¸‹è¿‡ç¨‹ï¼š</p><img src="/2023/04/02/Linux%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%97%B6%E7%9A%84%E7%89%88%E6%9C%AC%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6/image-20230405234653884.png" alt="image-20230405234653884" style="zoom:80%;"><p>å¦‚æœå˜é‡æ˜¯ä¸ªæ•°ç»„æˆ–è€…æŒ‡é’ˆï¼Œåˆ™å¯¹äºåˆ†å·å‰çš„æ‰€æœ‰ç¬¦å·è¿›è¡Œå¦‚ä¸Šè®¡ç®—ï¼ŒåŒ…æ‹¬æ•°ç»„å¤§å°ç­‰ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„åŸºæœ¬ç±»å‹ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>å˜é‡çš„ç±»å‹å‘ç”Ÿæ”¹å˜</li><li>æ•°ç»„å˜é‡çš„å¤§å°å‘ç”Ÿæ”¹å˜</li></ul><p><strong>å‡½æ•°</strong></p><p>è‹¥å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">test_fun</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">char</span> b)</span>;<br>EXPORT_SYMBOL(test_fun);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆCRCè®¡ç®—å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> -&gt; test_fun -&gt; ( -&gt;<br>    <span class="hljs-type">int</span> -&gt; , -&gt;<br>    <span class="hljs-type">char</span> -&gt; , -&gt;<br>)<br></code></pre></td></tr></table></figure><p>æ­¤å¤„å˜é‡ç±»å‹ä½¿ç”¨åŸºç¡€å˜é‡ä»¥ä¾¿ç†è§£ï¼Œå¦‚æœæ˜¯ç¬¦åˆå˜é‡ï¼Œåˆ™éœ€è¦æŒ‰ç…§éœ€æ±‚å±•å¼€ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„å‡½æ•°ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>å‡½æ•°çš„è¿”å›å€¼ç±»å‹å‘ç”Ÿå˜åŒ–ï¼›</li><li>å‚æ•°çš„ç±»å‹å‘ç”Ÿå˜åŒ–ï¼›</li><li>å‚æ•°åå­—å‘ç”Ÿå˜åŒ–ä¸å½±å“CRCå€¼ã€‚</li></ul><p><strong>ç»“æ„ä½“</strong></p><p>è‹¥å®šä¹‰å¦‚ä¸‹å¤åˆç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_struct</span> &#123;</span><br>        <span class="hljs-type">int</span> a;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> my_int;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">test_struct</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_struct</span> <span class="hljs-title">bb</span>;</span><br>        my_int cc;<br>&#125;;<br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">test_struct</span> *<span class="hljs-title">abcde</span>;</span><br></code></pre></td></tr></table></figure><p>å¯¹äºabcdeï¼Œå…¶ç±»å‹struct test_structåŒ…å«å¦ä¸€ä¸ªç»“æ„ä½“struct my_structå’Œtypedefåçš„å˜é‡ï¼Œåˆ™è®¡ç®—çš„æ—¶å€™ï¼Œéœ€è¦ä¾æ¬¡å¯¹å¦‚ä¸‹å˜é‡è¿›è¡Œè®¡ç®—ï¼š\</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> â†’ <span class="hljs-title">test_struct</span> â†’ &#123;</span> â†’ <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> â†’ <span class="hljs-title">my_struct</span> â†’ &#123;</span> â†’ <br>        <span class="hljs-type">int</span> â†’ a â†’ ; â†’ <br>    &#125; â†’ bb â†’ ; â†’ <br>        <span class="hljs-keyword">typedef</span> â†’ <span class="hljs-type">int</span> â†’ my_int â†’ cc â†’ ; â†’ <br>&#125; â†’ * â†’ abcde<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯å…³äºstructæˆ–è€…typedefåçš„ç±»å‹ï¼Œå…¶ä¸ç›´æ¥åˆ©ç”¨ç±»å‹åæ¥è¿›è¡Œè®¡ç®—ï¼Œè€Œæ˜¯é€’å½’å±•å¼€è¯¥ç±»å‹çš„å®šä¹‰ï¼Œå¯¹å®šä¹‰ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œå†æ¬¡è®¡ç®—ï¼Œæœ€åå¾—å‡ºè®¡ç®—çš„ç»“æœã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtypedefè®¡ç®—ä¸åŸºæœ¬ç±»å‹ç±»ä¼¼ï¼Œä½†æ˜¯structè®¡ç®—æ—¶ï¼Œå…¶ä¸­çš„æ¯ä¸ªå˜é‡åçš„åˆ†å·éƒ½çº³å…¥è®¡ç®—èŒƒå›´ã€‚</p><p>å¯¹äºå¯¼å‡ºçš„ç»“æ„ä½“ï¼Œä¼šäº§ç”ŸCRCå€¼ä¸åŒçš„åŸå› æœ‰ï¼š</p><ul><li>ç»“æ„ä½“å†…å˜é‡å‘ç”Ÿå˜åŒ–ï¼ŒåŒ…æ‹¬å˜é‡ç±»å‹ã€å˜é‡åå­—ï¼›</li><li>ç»“æ„ä½“å†…æˆå‘˜çš„é¡ºåºå‘ç”Ÿæ”¹å˜</li><li>è‹¥æœ‰typedefï¼Œå…¶å¯¹åº”çš„åå­—æˆ–è€…ç±»å‹å‘ç”Ÿå˜åŒ–ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileä¸­çš„includeå…³é”®å­—</title>
    <link href="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/"/>
    <url>/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileä¸­çš„includeå…³é”®å­—"><a href="#Makefileä¸­çš„includeå…³é”®å­—" class="headerlink" title="Makefileä¸­çš„includeå…³é”®å­—"></a>Makefileä¸­çš„includeå…³é”®å­—</h1><blockquote><p>ğŸª¶ <strong>æ‘˜å½•è‡ª</strong>ï¼š<a href="https://juejin.cn/post/7150700142817968158#heading-2">https://juejin.cn/post/7150700142817968158#heading-2</a></p></blockquote><h2 id="include-çš„æ¦‚å¿µ"><a href="#include-çš„æ¦‚å¿µ" class="headerlink" title="include çš„æ¦‚å¿µ"></a>include çš„æ¦‚å¿µ</h2><p>makefile ä¸­å¯ä»¥ä½¿ç”¨ <code>include</code> æŒ‡ä»¤æ¥åŒ…å«å¦ä¸€ä¸ªæ–‡ä»¶ã€‚ å½“ <code>make</code> è¯†åˆ«åˆ° <code>include</code> æŒ‡ä»¤æ—¶ï¼Œ<u>ä¼šæš‚åœè¯»å…¥å½“å‰çš„ makefile æ–‡ä»¶</u>ï¼Œå¹¶è½¬è€Œè¯»å…¥ <code>include</code> æŒ‡å®šçš„æ–‡ä»¶ï¼Œä¹‹åå†ç»§ç»­è¯»å–æœ¬æ–‡ä»¶çš„å‰©ä½™å†…å®¹ã€‚</p><h2 id="includeçš„ä½¿ç”¨"><a href="#includeçš„ä½¿ç”¨" class="headerlink" title="includeçš„ä½¿ç”¨"></a>includeçš„ä½¿ç”¨</h2><p>æœ¬å°èŠ‚å®éªŒæ¶‰åŠåˆ°çš„æ–‡ä»¶åŒ…æ‹¬ï¼š</p><ul><li>inc_a</li><li>inc_b</li><li>makefile</li></ul><p><code>inc_a</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for makefile</span><br><br>vari_c=<span class="hljs-string">&quot;vari_c from inc_a&quot;</span><br></code></pre></td></tr></table></figure><p><code>makefile</code> æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Make"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_a<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>åœ¨ Terminal ä¸­æ‰§è¡Œ <code>make</code> å‘½ä»¤å¹¶è§‚å¯Ÿè¾“å‡ºç»“æœã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330234842191.png" alt="image-20230330234842191" style="zoom:80%;"><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºæ¥ makefile å·²ç»æˆåŠŸåŒ…å«äº† <code>inc_a</code> æ–‡ä»¶ï¼Œå¹¶ä¸”æ­£ç¡®è·å–åˆ°äº† <code>vari_c</code> å˜é‡ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ <code>include</code> æŒ‡ç¤ºç¬¦æ‰€æŒ‡ç¤ºçš„æ–‡ä»¶åå¯ä»¥æ˜¯ä»»ä½• shell èƒ½å¤Ÿè¯†åˆ«çš„æ–‡ä»¶åï¼Œè¿™è¡¨æ˜ <code>include</code> è¿˜å¯ä»¥æ”¯æŒåŒ…å«é€šé…ç¬¦çš„æ–‡ä»¶åã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„å®éªŒä¸­è¿›è¡ŒéªŒè¯ã€‚</p><p><code>inc_b</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for makefile</span><br><br>vari_d=<span class="hljs-string">&quot;vari_d from inc_b&quot;</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ makefileï¼Œä½¿ç”¨é€šé…ç¬¦åŒæ—¶åŒ…å« <code>inc_a</code> å’Œ <code>inc_b</code> æ–‡ä»¶ã€‚ ä¿®æ”¹åçš„ makefile å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_*<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br>    @echo <span class="hljs-variable">$(vari_d)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼šmakefile ä¸­ä¿®æ”¹äº†ä¸¤å¤„ï¼Œç¬¬ä¸€å¤„æ˜¯ <code>inc_a</code> ä¿®æ”¹ä¸ºäº† <code>inc_*</code>ï¼Œç¬¬äºŒå¤„æ˜¯åœ¨ <code>all</code> ä¸­æ–°å¢äº† <code>@echo $(vari_d)</code> ã€‚å› ä¸ºåœ¨ <code>inc_b</code> ä¸­æˆ‘ä»¬å®šä¹‰äº†å˜é‡ <code>vari_d</code>ï¼Œåœ¨ makefile ä¸­æˆ‘ä»¬éœ€è¦å¯¹å…¶å€¼è¿›è¡Œè¾“å‡ºã€‚</p></blockquote><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤,è¾“å‡ºç»“æœå¦‚å›¾ï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235057222.png" alt="image-20230330235057222" style="zoom:80%;"><p>ç”±æ­¤è¯´æ˜ <code>inc_a</code> ä¸ <code>inc_b</code> éƒ½è¢«åŒ…å«è¿›äº† makefile æ–‡ä»¶ä¸­ã€‚</p><h2 id="include-æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„"><a href="#include-æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„" class="headerlink" title="include æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„"></a>include æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„</h2><p>å½“ include æŒ‡ç¤ºç¬¦åŒ…å«çš„æ–‡ä»¶ä¸åŒ…å«ç»å¯¹è·¯å¾„ï¼Œä¸”åœ¨å½“å‰è·¯å¾„ä¸‹ä¹Ÿæ— æ³•å¯»æ‰¾åˆ°æ—¶ï¼Œmake ä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§å¯»æ‰¾æ–‡ä»¶ï¼š</p><ol><li><code>-I</code> æŒ‡å®šçš„ç›®å½•</li><li><code>/usr/gnu/include</code></li><li><code>/usr/local/include</code></li><li><code>/usr/include</code></li><li>æŒ‡å®š makefile çš„ include è·¯å¾„</li></ol><p>ä¿®æ”¹ <code>makefile</code>ï¼Œä¸å†æŒ‡å®š <code>inc_a</code> å’Œ <code>inc_b</code> çš„ç›¸å¯¹è·¯å¾„ï¼Œæ­¤æ—¶ makefile æ–‡ä»¶çš„å†…å®¹æ˜¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># this is a basic makefile</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;original vari a&quot;</span><br>vari_b=<span class="hljs-string">&quot;original vari b&quot;</span><br><br><span class="hljs-keyword">include</span> inc_*<br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br>    @echo <span class="hljs-variable">$(vari_b)</span><br>    @echo <span class="hljs-variable">$(vari_c)</span><br>    @echo <span class="hljs-variable">$(vari_d)</span><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>å½“å‰ç›®å½•ç»“æ„ä¸ºï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235800533.png" alt="image-20230330235800533" style="zoom:80%;"><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤ï¼Œè§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¦‚æœå‘ç°æœ‰é”™è¯¯äº§ç”Ÿã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235517959.png" alt="image-20230330235517959" style="zoom:80%;"><p>å¯ä»¥çœ‹åˆ° makefile æ— æ³•æ‰¾åˆ° <code>inc_a</code> å’Œ <code>inc_b</code> æ–‡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>make -I</code> å‘½ä»¤æ¥æŒ‡å®šæœå¯»è·¯å¾„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make -I ./include_demo/<br></code></pre></td></tr></table></figure><p>Terminal è¾“å‡ºç»“æœå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235727451.png" alt="image-20230330235727451" style="zoom:80%;"><p>å‘ç°è¾“å‡ºç»“æœä¾ç„¶æ˜¯é”™è¯¯çš„ã€‚å› ä¸ºä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡º <code>make</code> æ˜¯åœ¨æŸ¥æ‰¾åä¸º <code>inc_*</code> çš„æ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ makefile æ–‡ä»¶ä¸­çš„ <code>include</code> è¡Œã€‚</p><figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs M">include inc_a inc_b<br></code></pre></td></tr></table></figure><p>Terminal çš„è¾“å‡ºç»“æœå¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230330235905294.png" alt="image-20230330235905294" style="zoom:80%;"><p>è¯´æ˜ç¨‹åºå¾—åˆ°äº†æ­£ç¡®çš„æ‰§è¡Œã€‚</p><blockquote><p>å¯è§ä¸ä½¿ç”¨é€šé…ç¬¦çš„æƒ…å†µä¸‹<code>include</code>é…åˆ<code>-I</code>é€‰é¡¹æ‰èƒ½å¾—åˆ°é¢„æœŸæ•ˆæœã€‚</p></blockquote><h2 id="includeçš„å¤„ç†ç»†èŠ‚"><a href="#includeçš„å¤„ç†ç»†èŠ‚" class="headerlink" title="includeçš„å¤„ç†ç»†èŠ‚"></a>includeçš„å¤„ç†ç»†èŠ‚</h2><p>å‰é¢æåˆ° <code>make</code> è¯»å…¥ makefile æ—¶é‡è§ <code>include</code> æŒ‡ç¤ºç¬¦ä¼šæš‚åœè¯»å…¥å½“å‰æ–‡ä»¶ï¼Œè½¬è€Œè¯»å…¥ <code>include</code> æŒ‡å®šçš„æ–‡ä»¶ï¼Œä¹‹åæ‰ç»§ç»­è¯»å…¥å½“å‰æ–‡ä»¶ã€‚</p><p>makefile æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this makefile is test for include process</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>:all clean</span><br><br>vari_a=<span class="hljs-string">&quot;vari_a @ 1st&quot;</span><br><br><span class="hljs-keyword">include</span> ./include_demo/c_inc<br><br>vari_a += <span class="hljs-string">&quot; @2nd ...&quot;</span><br><br><span class="hljs-section">all:</span><br>    @echo <span class="hljs-variable">$(vari_a)</span><br><br><span class="hljs-section">clean:</span><br></code></pre></td></tr></table></figure><p>ä» makefile å†…å®¹ä¸Šå¯ä»¥çœ‹å‡º makefile è§„åˆ™çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆå®šä¹‰å˜é‡ <code>vari_a</code>ï¼Œç„¶åå†å¼•å…¥æ–‡ä»¶ <code>c_inc</code>ï¼Œæœ€åä¿®æ”¹å˜é‡ <code>vari_a</code>ã€‚</p><p><code>c_inc</code> æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#this is a include file for include process</span><br><br>vari_a=<span class="hljs-string">&quot;vari_a from c_inc&quot;</span><br></code></pre></td></tr></table></figure><p>ä»ä¸­å¯ä»¥çœ‹å‡ºåœ¨ <code>c_inc</code> æ–‡ä»¶ä¸­ä¹Ÿå¯¹ <code>vari_a</code> å˜é‡è¿›è¡Œäº†å®šä¹‰ã€‚</p><p>æ‰§è¡Œ <code>make</code> å‘½ä»¤è§‚å¯Ÿè¾“å‡ºç»“æœã€‚</p><img src="/2023/03/30/Makefile%E4%B8%AD%E7%9A%84include%E5%85%B3%E9%94%AE%E5%AD%97/image-20230331000240966.png" alt="image-20230331000240966" style="zoom:80%;"><p>è¿™è¯´æ˜ <code>vari_a</code> åœ¨ <code>include</code> è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹äº†ï¼Œå¹¶ä¸”åœ¨å…¶åæ·»åŠ äº†å­—ç¬¦ä¸² <code>@2nd ...</code>ï¼Œç»“æœä¸é¢„æœŸä¸­ <code>make</code> å¤„ç† <code>include</code> æŒ‡ç¤ºç¬¦çš„è¡Œä¸ºä¸€è‡´</p>]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileçš„æ‰§è¡Œé¡ºåº</title>
    <link href="/2023/03/30/Makefile%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/"/>
    <url>/2023/03/30/Makefile%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileçš„æ‰§è¡Œé¡ºåº"><a href="#Makefileçš„æ‰§è¡Œé¡ºåº" class="headerlink" title="Makefileçš„æ‰§è¡Œé¡ºåº"></a>Makefileçš„æ‰§è¡Œé¡ºåº</h1><blockquote><p>ğŸª¶ æ‘˜å½•è‡ªï¼š<a href="https://blog.csdn.net/qq_35524916/article/details/77131555?spm=1001.2014.3001.5506">https://blog.csdn.net/qq_35524916/article/details/77131555?spm=1001.2014.3001.5506</a></p></blockquote><p><strong>åœ¨linuxä¸‹ï¼Œmakefileçš„æ‰§è¡Œå®é™…ä¸Šåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µè¿›è¡Œ</strong></p><ul><li>ç¬¬ä¸€é˜¶æ®µï¼šè¯»å–æ‰€æœ‰çš„makefileæ–‡ä»¶ï¼ˆåŒ…æ‹¬â€œMAKEFILESâ€å˜é‡æŒ‡å®šçš„ã€æŒ‡ç¤ºç¬¦â€œincludeâ€æŒ‡å®šçš„ã€ä»¥åŠå‘½ä»¤è¡Œé€‰é¡¹â€œ-fï¼ˆâ€“fileï¼‰â€æŒ‡å®šçš„makefileæ–‡ä»¶ï¼‰ï¼Œå†…å»ºçš„å˜é‡ã€æ˜ç¡®è§„åˆ™å’Œéšå«è§„åˆ™ï¼Œå¹¶å»ºç«‹æ‰€æœ‰ç›®æ ‡å’Œä¾èµ–ä¹‹é—´çš„ä¾èµ–å…³ç³»ç»“æ„é“¾è¡¨ã€‚</li><li>ç¬¬äºŒé˜¶æ®µï¼šæ ¹æ®ç¬¬ä¸€é˜¶æ®µå·²ç»å»ºç«‹çš„ä¾èµ–å…³ç³»ç»“æ„é“¾è¡¨å†³å®šå“ªäº›ç›®æ ‡éœ€è¦æ›´æ–°ï¼Œå¹¶ä½¿ç”¨å¯¹åº”çš„è§„åˆ™æ¥é‡å»ºè¿™äº›ç›®æ ‡ã€‚</li></ul><p><strong>makeçš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</strong></p><ol><li>ä¾æ¬¡è¯»å–å˜é‡â€œMAKEFILESâ€å®šä¹‰çš„makefileæ–‡ä»¶åˆ—è¡¨</li><li>è¯»å–å·¥ä½œç›®å½•ä¸‹çš„makefileæ–‡ä»¶ï¼ˆç¼ºçœçš„æ˜¯æ ¹æ®å‘½åçš„æŸ¥æ‰¾é¡ºåºâ€œGNUmakefileâ€ï¼Œâ€œmakefileâ€ï¼Œâ€œMakefileâ€ï¼Œé¦–å…ˆæ‰¾åˆ°é‚£ä¸ªå°±è¯»å–é‚£ä¸ªï¼‰</li><li>ä¾æ¬¡è¯»å–å·¥ä½œç›®å½•makefileæ–‡ä»¶ä¸­ä½¿ç”¨æŒ‡ç¤ºç¬¦â€œincludeâ€åŒ…å«çš„æ–‡ä»¶</li><li>æŸ¥æ‰¾é‡å»ºæ‰€æœ‰å·²è¯»å–çš„makefileæ–‡ä»¶çš„è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ä¸€ä¸ªç›®æ ‡æ˜¯å½“å‰è¯»å–çš„æŸä¸€ä¸ªmakefileæ–‡ä»¶ï¼Œåˆ™æ‰§è¡Œæ­¤è§„åˆ™é‡å»ºæ­¤makefileæ–‡ä»¶ï¼Œå®Œæˆä»¥åä»ç¬¬ä¸€æ­¥å¼€å§‹é‡æ–°æ‰§è¡Œï¼‰</li><li>åˆå§‹åŒ–å˜é‡å€¼å¹¶å±•å¼€é‚£äº›éœ€è¦ç«‹å³å±•å¼€çš„å˜é‡å’Œå‡½æ•°å¹¶æ ¹æ®é¢„è®¾æ¡ä»¶ç¡®å®šæ‰§è¡Œåˆ†æ”¯</li><li>æ ¹æ®â€œç»ˆæç›®æ ‡â€ä»¥åŠå…¶ä»–ç›®æ ‡çš„ä¾èµ–å…³ç³»å»ºç«‹ä¾èµ–å…³ç³»é“¾è¡¨</li><li>æ‰§è¡Œé™¤â€œç»ˆæç›®æ ‡â€ä»¥å¤–çš„æ‰€æœ‰çš„ç›®æ ‡çš„è§„åˆ™ï¼ˆè§„åˆ™ä¸­å¦‚æœä¾èµ–æ–‡ä»¶ä¸­ä»»ä¸€ä¸ªæ–‡ä»¶çš„æ—¶é—´æˆ³æ¯”ç›®æ ‡æ–‡ä»¶æ–°ï¼Œåˆ™ä½¿ç”¨è§„åˆ™æ‰€å®šä¹‰çš„å‘½ä»¤é‡å»ºç›®æ ‡æ–‡ä»¶ï¼‰</li><li>æ‰§è¡Œâ€œç»ˆæç›®æ ‡â€æ‰€åœ¨çš„è§„åˆ™</li></ol>]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefileä¸­çš„shellå‡½æ•°</title>
    <link href="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/"/>
    <url>/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Makefileä¸­çš„shellå‡½æ•°"><a href="#Makefileä¸­çš„shellå‡½æ•°" class="headerlink" title="Makefileä¸­çš„shellå‡½æ•°"></a>Makefileä¸­çš„shellå‡½æ•°</h1><p>shellå‡½æ•°ä¸åŒäºé™¤â€œwildcardâ€å‡½æ•°ä¹‹å¤–çš„å…¶å®ƒå‡½æ•°ã€‚makeå¯ä»¥ä½¿ç”¨å®ƒæ¥å’Œå¤–éƒ¨é€šä¿¡ã€‚</p><p>å‡½æ•°åŠŸèƒ½ï¼šå‡½æ•°â€œshellâ€æ‰€å®ç°çš„åŠŸèƒ½å’Œshellä¸­çš„å¼•ç”¨ï¼ˆ&#96;&#96;ï¼‰ç›¸åŒï¼Œå®ç°å¯¹å‘½ä»¤çš„æ‰©å±•ã€‚è¿™å°±æ„å‘³ç€éœ€è¦ä¸€ä¸ªshell å‘½ä»¤ä½œä¸ºæ­¤å‡½æ•°çš„å‚æ•°ï¼Œå‡½æ•°çš„è¿”å›ç»“æœæ˜¯æ­¤å‘½ä»¤åœ¨shellä¸­çš„æ‰§è¡Œç»“æœã€‚makeä»…ä»…å¯¹å®ƒçš„è¿”å›ç»“æœè¿›è¡Œå¤„ç†ï¼›makeå°†å‡½æ•°è¿”å›ç»“æœä¸­çš„æ‰€æœ‰æ¢è¡Œç¬¦ï¼ˆâ€œ\nâ€ï¼‰æˆ–è€…ä¸€å¯¹â€œ\n\râ€æ›¿æ¢ä¸ºå•ç©ºæ ¼ï¼›å¹¶å»æ‰æœ«å°¾çš„å›è½¦ç¬¦å·ï¼ˆâ€œ\nâ€ï¼‰æˆ–è€…â€œ\n\râ€ã€‚è¿›è¡Œå‡½æ•°å±•å¼€å¼æ—¶ï¼Œå®ƒæ‰€è°ƒç”¨çš„å‘½ä»¤ï¼ˆå®ƒçš„å‚æ•°ï¼‰å¾—åˆ°æ‰§è¡Œã€‚é™¤å¯¹å®ƒçš„å¼•ç”¨å‡ºç°åœ¨è§„åˆ™çš„å‘½ä»¤è¡Œå’Œé€’å½’å˜é‡çš„å®šä¹‰ä¸­ä»¥å¤–ï¼Œå…¶å®ƒå†³å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œmakeæ˜¯åœ¨è¯»å–è§£æMakefileæ—¶å®Œæˆå¯¹å‡½æ•°shellçš„å±•å¼€ã€‚</p><p>ğŸ¤º <strong>è¿”å›å€¼</strong>ï¼šå‡½æ•°â€œshellâ€çš„å‚æ•°ï¼ˆä¸€ä¸ªshellå‘½ä»¤ï¼‰åœ¨<strong>shellç¯å¢ƒä¸­çš„æ‰§è¡Œç»“æœ</strong>ã€‚</p><p>å‡½æ•°è¯´æ˜ï¼šæ³¨æ„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ–°ç”Ÿæˆä¸€ä¸ª Shell ç¨‹åºæ¥æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥ä½ è¦æ³¨æ„å…¶è¿è¡Œæ€§èƒ½ï¼Œå¦‚æœä½ çš„ Makefile ä¸­æœ‰ä¸€äº›æ¯”è¾ƒå¤æ‚çš„è§„åˆ™ï¼Œå¹¶å¤§é‡ä½¿ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå¯¹äºä½ çš„ç³»ç»Ÿæ€§èƒ½æ˜¯æœ‰å®³çš„ã€‚ç‰¹åˆ«æ˜¯ Makefile çš„éšæ™¦çš„è§„åˆ™å¯èƒ½ä¼šè®©ä½ çš„ shell å‡½æ•°æ‰§è¡Œçš„æ¬¡æ•°æ¯”ä½ æƒ³åƒçš„å¤šå¾—å¤šã€‚</p><p>ğŸ¼ <strong>ç¤ºä¾‹1ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> cat foo.txt)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">foo.txt</span><br>hello amx!<br>I love codiing.<br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222716788.png" alt="image-20230329222716788" style="zoom:80%;"><blockquote><p>å°†æ¢è¡Œç¬¦å½“åšç©ºæ ¼è¿›è¡Œè¿æ¥</p></blockquote><p>ğŸ¼ <strong>ç¤ºä¾‹2ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> echo *.c)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222846872.png" alt="image-20230329222846872" style="zoom:90%;"><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329222921766.png" alt="image-20230329222921766" style="zoom:80%;"><p>ğŸ¼ <strong>ç¤ºä¾‹3ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">contents := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> sh test.sh hello)</span><br><span class="hljs-variable">$(info <span class="hljs-variable">$(contents)</span>)</span><br><span class="hljs-section">all:</span><br>@echo <span class="hljs-string">&quot;make all&quot;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>test.sh</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>name=&quot;amx&quot;<br>echo $&#123;name&#125;<br>echo $0<br>echo $1<br>echo &quot;ChatGpt4.0&quot;<br></code></pre></td></tr></table></figure><img src="/2023/03/29/Makefile%E4%B8%AD%E7%9A%84shell%E5%87%BD%E6%95%B0/image-20230329224038930.png" alt="image-20230329224038930" style="zoom:90%;">]]></content>
    
    
    <categories>
      
      <category>Makefileå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kernelä¸­__attribute__å±æ€§</title>
    <link href="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/"/>
    <url>/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="kernelä¸­-attribute-å±æ€§"><a href="#kernelä¸­-attribute-å±æ€§" class="headerlink" title="kernelä¸­__attribute__å±æ€§"></a>kernelä¸­__attribute__å±æ€§</h1><blockquote><p>ğŸ§ <strong>å‚è€ƒ</strong>ï¼š<a href="https://www.eet-china.com/mp/a192020.html">https://www.eet-china.com/mp/a192020.html</a></p></blockquote><h2 id="1-å®éªŒç¨‹åº"><a href="#1-å®éªŒç¨‹åº" class="headerlink" title="1.å®éªŒç¨‹åº"></a>1.å®éªŒç¨‹åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((constructor)) beforeMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Before main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Main!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œï¼š<code>gcc test.c -o test</code></p><p>è¾“å‡ºç»“æœï¼š</p><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328225545088.png" alt="image-20230328225545088" style="zoom:80%;"><blockquote><p>ä¸ºä»€ä¹ˆæœ€å¼€å§‹æ‰§è¡Œçš„ä¸æ˜¯mainå‡½æ•°ï¼Ÿæ€ä¹ˆå’Œæˆ‘ä»¬åˆšå¼€å§‹å­¦ä¹ Cç¨‹åºæ—¶è¯´çš„ä¸ä¸€æ ·å‘¢ï¼Ÿä»è¿è¡Œç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥beforeMainæ˜¯åœ¨è¿›å…¥mainå‡½æ•°ä¹‹å‰è¢«è°ƒç”¨çš„ï¼Œè¿™å¯¹äºCè¯­è¨€çš„åˆå­¦è€…æ¥è¯´ä¼¼ä¹æœ‰ç‚¹éš¾ä»¥ç†è§£ã€‚ç©¶ç«Ÿæ˜¯è°è°ƒç”¨çš„beforeMainå‘¢ï¼Ÿæ€ä¹ˆè¿˜æ²¡æœ‰è¿›å…¥mainå°±å¯ä»¥æœ‰ä»£ç è¢«æ‰§è¡Œå‘¢ï¼Ÿ</p></blockquote><p>å¸¦ç€ä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç”¨-vå‚æ•°æ¥æ˜¾ç¤ºç¼–è¯‘è¿‡ç¨‹è¾“å‡ºç»“æœ<code>gcc test.c -o test -v</code>ï¼šï¼Œå…¶ä¸­è¾“å‡ºéƒ¨åˆ†å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/<br>LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/8/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/8/../../../:/lib/:/usr/lib/<br>COLLECT_GCC_OPTIONS=&#x27;-o&#x27; &#x27;test&#x27; &#x27;-v&#x27; &#x27;-mtune=generic&#x27; &#x27;-march=x86-64&#x27;<br> /usr/lib/gcc/x86_64-linux-gnu/8/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/8/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper -plugin-opt=-fresolution=/tmp/ccxW7QBR.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crt1.o /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/8/crtbegin.o -L/usr/lib/gcc/x86_64-linux-gnu/8 -L/usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/8/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/8/../../.. /tmp/ccboZUZT.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/8/crtend.o /usr/lib/gcc/x86_64-linux-gnu/8/../../../x86_64-linux-gnu/crtn.o<br>COLLECT_GCC_OPTIONS=&#x27;-o&#x27; &#x27;test&#x27; &#x27;-v&#x27; &#x27;-mtune=generic&#x27; &#x27;-march=x86-64&#x27;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328225732402.png" alt="image-20230328225732402" style="zoom:100%;"><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œåœ¨é“¾æ¥ç”Ÿæˆæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œæœ‰å¾ˆå¤šçš„Cåº“äºŒè¿›åˆ¶æ–‡ä»¶å‚ä¸è¿›æ¥ã€‚è€Œæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶é™¤äº†æˆ‘ä»¬ç¼–å†™çš„è¿™ä¸ªç®€å•çš„Cä»£ç ä»¥å¤–ï¼Œè¿˜æœ‰å¤§é‡çš„Cåº“æ–‡ä»¶å‚ä¸äº†é“¾æ¥ï¼Œå¹¶åŒ…å«åœ¨äº†æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚è¿™ä¸ªé“¾æ¥çš„è¿‡ç¨‹ï¼Œæ˜¯ç”±é“¾æ¥å™¨ldçš„é“¾æ¥è„šæœ¬æ¥å†³å®šçš„ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šé“¾æ¥è„šæœ¬ï¼Œä¼šé»˜è®¤ä½¿ç”¨ldçš„é»˜è®¤è„šæœ¬ã€‚</p><p>é€šè¿‡<strong>ld -verbose</strong>å‘½ä»¤æ¥æŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">using internal linker script:<br>==================================================<br>/* Script for -z combreloc -z separate-code: combine and sort reloc sections with separate code segment */<br>/* Copyright (C) 2014-2018 Free Software Foundation, Inc.<br>   Copying and distribution of this script, with or without modification,<br>   are permitted in any medium without royalty provided the copyright<br>   notice and this notice are preserved.  */<br>OUTPUT_FORMAT(&quot;elf64-x86-64&quot;, &quot;elf64-x86-64&quot;,<br>              &quot;elf64-x86-64&quot;)<br>OUTPUT_ARCH(i386:x86-64)<br>ENTRY(_start)<br>SEARCH_DIR(&quot;=/usr/local/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu64&quot;); SEARCH_DIR(&quot;=/usr/local/lib64&quot;); SEARCH_DIR(&quot;=/lib64&quot;); SEARCH_DIR(&quot;=/usr/lib64&quot;); SEARCH_DIR(&quot;=/usr/local/lib&quot;); SEARCH_DIR(&quot;=/lib&quot;); SEARCH_DIR(&quot;=/usr/lib&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib64&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib&quot;);<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢è¾“å‡ºå¯ä»¥çœ‹å‡ºè¿™é‡Œå®šä¹‰äº†è¾“å‡ºçš„æ–‡ä»¶æ ¼å¼ã€ç›®æ ‡æœºå™¨çš„ç±»å‹ï¼Œä»¥åŠé‡è¦çš„ä¿¡æ¯å’Œç¨‹åºçš„å…¥å£ENTRYï¼ˆ_startï¼‰ã€‚</p><blockquote><p>æˆ‘ä»¬çš„ä¾‹å­ä¸­beforeMainå‡½æ•°ä½¿ç”¨çš„gccæ‰©å±•å±æ€§<code>__attribute__ï¼ˆï¼ˆconstructorï¼‰ï¼‰</code>å°±æ˜¯å°†å‡½æ•°å¯¹åº”çš„æŒ‡ä»¤å½’å±äº.ctors sectionéƒ¨åˆ†ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">.ctors          :<br>&#123;<br>  /* gcc uses crtbegin.o to find the start of<br>     the constructors, so we make sure it is<br>     first.  Because this is a wildcard, it<br>     doesn&#x27;t matter if the user does not<br>     actually link against crtbegin.o; the<br>     linker won&#x27;t look for a file to match a<br>     wildcard.  The wildcard also means that it<br>     doesn&#x27;t matter which directory crtbegin.o<br>     is in.  */<br>  KEEP (*crtbegin.o(.ctors))<br>  KEEP (*crtbegin?.o(.ctors))<br>  /* We don&#x27;t want to include the .ctor section from<br>     the crtend.o file until after the sorted ctors.<br>     The .ctor section from the crtend file contains the<br>     end of ctors marker and it must be last */<br>  KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .ctors))<br>  KEEP (*(SORT(.ctors.*)))<br>  KEEP (*(.ctors))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-attribute-constructor-å±æ€§"><a href="#2-attribute-constructor-å±æ€§" class="headerlink" title="2._attribute_((constructor))å±æ€§"></a>2._<em>attribute</em>_((constructor))å±æ€§</h2><blockquote><p>The constructor attribute causes the function to be called automatically before execution enters main (). æ„é€ å‡½æ•°å±æ€§ä½¿å‡½æ•°åœ¨æ‰§è¡Œè¿›å…¥mainï¼ˆï¼‰ä¹‹å‰è‡ªåŠ¨è¢«è°ƒç”¨</p></blockquote><p>GNU Cçš„ä¸€å¤§ç‰¹è‰²å°±æ˜¯<code>__attribute__</code>æœºåˆ¶ã€‚<code>__attribute__</code>å¯ä»¥è®¾ç½®å‡½æ•°å±æ€§ï¼ˆFunction Attribute ï¼‰ã€å˜é‡å±æ€§ï¼ˆVariable Attribute ï¼‰å’Œç±»å‹å±æ€§ï¼ˆType Attribute ï¼‰ã€‚<code>__attribute__</code>å†™æ³•æ˜¯<code>__attribute__</code>å‰åéƒ½æœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”åé¢ä¼šç´§è·Ÿä¸€å¯¹åŸæ‹¬å¼§ï¼Œæ‹¬å¼§é‡Œé¢æ˜¯ç›¸åº”çš„<code>__attribute__</code>å‚æ•°ã€‚<code>__attribute__</code>æ ¼å¼ä¸º<code>__attribute__((attribute-list))</code></p><p>å°±æ˜¯æŒ‡åœ¨å‡½æ•°ä¸Šæ–¹åŠ ä¸Š<code>__attribute__((constructor))</code>å¯ä»¥è®©è¿™ä¸ªå‡½æ•°åœ¨mainå‡½æ•°æ‰§è¡Œå‰è¿è¡Œ</p><p><strong>ä½œç”¨ï¼š<code>__attribute__((constructor))</code>å¯ä»¥æå‰åˆå§‹åŒ–ä¸€äº›åœ¨mainå‡½æ•°ä¸­ç”¨åˆ°çš„ä¸œè¥¿ï¼Œä¾¿äºæˆ‘ä»¬åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚</strong></p><p><strong>å¸¦æœ‰ä¼˜å…ˆçº§çš„å‚æ•°</strong></p><p>æˆ‘ä»¬è¿˜å¯ä»¥ç»™å±æ€§è®¾ç½®ä¼˜å…ˆçº§ï¼Œçœ‹ä¸‹é¢ç¤ºä¾‹ä»£ç :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span><br><br>static void __attribute__ ((constructor(101))) beforeMain1(void)<br>&#123;<br>    printf(&quot;Before main...1\n&quot;);<br>&#125;<br>static void __attribute__ ((constructor(102))) beforeMain2(void)<br>&#123;<br>    printf(&quot;Before main...2\n&quot;);<br>&#125;<br>static void __attribute__ ((constructor(103))) beforeMain3(void)<br>&#123;<br>    printf(&quot;Before main...3\n&quot;);<br>&#125;<br><br>int main(void)<br>&#123;<br>    printf(&quot;Main!\n&quot;);<br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328230224517.png" alt="image-20230328230224517" style="zoom:100%;"><h2 id="3-attribute-destructor-å±æ€§"><a href="#3-attribute-destructor-å±æ€§" class="headerlink" title="3._attribute_((destructor))å±æ€§"></a>3._<em>attribute</em>_((destructor))å±æ€§</h2><p>æŸ¥é˜…äº†GNUçš„æ–‡æ¡£ä½ è¿˜ä¼šå‘ç°æœ‰æåŠè¿™ä¹ˆä¸€ä¸ªå†™æ³•<code>__attribute__((destructor))</code>ï¼Œæ–‡æ¡£ä¸­å…³äºè¿™ä¸¤ä¸ªç”¨æ³•çš„è¯´æ˜å¦‚ä¸‹:</p><blockquote><p>The constructor attribute causes the function to be called automatically before execution enters main (). Similarly, the destructor attribute causes the function to be called automatically after main () completes or exit () is called. Functions with these attributes are useful for initializing data that is used implicitly during the execution of the program.</p></blockquote><blockquote><p>åŒç†, destructorè®©ç³»ç»Ÿåœ¨main()å‡½æ•°é€€å‡ºæˆ–è€…è°ƒç”¨äº†exit()ä¹‹å,è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((constructor)) beforeMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Before main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __attribute__ ((destructor)) afterMain(<span class="hljs-type">void</span>)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After main...\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Main!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328230504826.png" alt="image-20230328230504826" style="zoom:100%;"><h2 id="4-å°ç»“"><a href="#4-å°ç»“" class="headerlink" title="4.å°ç»“"></a>4.å°ç»“</h2><p>Cç¨‹åºä¸­<code>__attribute__ ((constructor))</code>å’Œ<code>__attribute__ ((destructor))</code>ç±»ä¼¼äºC++ç±»ä¸­æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚åœ¨mainå‡½æ•°ä¹‹å‰ï¼Œæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œä¾¿äºæˆ‘ä»¬åšä¸€äº›å‡†å¤‡å·¥ä½œï¼›åœ¨main()å‡½æ•°é€€å‡ºæˆ–è€…è°ƒç”¨äº†exit()ä¹‹åè°ƒç”¨ã€‚å¤šä¸ªå‡½æ•°æ—¶ï¼ŒGCCä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‚æ•°å«ä¼˜å…ˆçº§ï¼ŒconstructoræŒ‰ä»å°åˆ°å¤§ï¼Œdestructorå‡½æ•°ç›¸å<code> void __attribute__((constructor(5)) initFunction1(void); void __attribute__((constructor(10)) initFunction2(void);</code></p><h2 id="5-attributeç”¨äºåŠ è½½åŠ¨æ€åº“"><a href="#5-attributeç”¨äºåŠ è½½åŠ¨æ€åº“" class="headerlink" title="5.attributeç”¨äºåŠ è½½åŠ¨æ€åº“"></a>5.attributeç”¨äºåŠ è½½åŠ¨æ€åº“</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">Shared objects may <span class="hljs-keyword">export</span> functions using the<br><br>__attribute__((constructor)) and __attribute__((destructor))<br>function attributes.  Constructor functions are executed before<br>dlopen() returns, and destructor functions are executed before<br>dlclose() returns.  A shared object may <span class="hljs-keyword">export</span> multiple<br>constructors and destructors, and priorities can be associated<br>with each function to determine the order in which they are<br>executed.  See the gcc info pages (under <span class="hljs-string">&quot;Function attributes&quot;</span>)<br>for further information.<br></code></pre></td></tr></table></figure><p>å‡½æ•°è®¾ç½®__attribute__((constructor))å±æ€§ï¼Œåœ¨dlopenæ—¶ï¼Œä¼šå…ˆè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p>è®¾ç½®__attribute__((destructor))å±æ€§ï¼Œåœ¨dlcloseæ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p><p>å®éªŒç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>__attribute__((constructor)) <span class="hljs-type">void</span> <span class="hljs-title function_">test_init</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world\n&quot;</span>);<br>&#125;<br><br>__attribute__((destructor)) <span class="hljs-type">void</span> <span class="hljs-title function_">test_fini</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bye world\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;test\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc -fPIC -shared test.c -o  libtest.so<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// main.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span><span class="hljs-params">(*testFunc)</span><span class="hljs-params">()</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">void</span> *handle = dlopen(<span class="hljs-string">&quot;./libtest.so&quot;</span>, RTLD_LAZY);<br>    <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;handle is null, %s\n&quot;</span>, dlerror());<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------\n&quot;</span>);<br>    testFunc f = (testFunc)dlsym(handle, <span class="hljs-string">&quot;test&quot;</span>);<br>    <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;f is null\n&quot;</span>);<br>    &#125;<br><br>    f();<br>    dlclose(handle);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc main.c -ldl -O0 -g -o main<br></code></pre></td></tr></table></figure><img src="/2023/03/28/kernel%E4%B8%AD-attribute-%E5%B1%9E%E6%80%A7/image-20230328234128499.png" alt="image-20230328234128499" style="zoom:100%;">]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start</title>
    <link href="/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/"/>
    <url>/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“initè¿›ç¨‹ç³»åˆ—-1-ctl-interface-start"><a href="#å®‰å“initè¿›ç¨‹ç³»åˆ—-1-ctl-interface-start" class="headerlink" title="å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start"></a>å®‰å“initè¿›ç¨‹ç³»åˆ—(1)ctl.interface_start</h1><blockquote><p>ğŸ¤– <strong>èƒŒæ™¯</strong>ï¼šä¸ºä»€ä¹ˆä¼šæœ‰ctl.interface_startè¿™ä¸ªå±æ€§ï¼Œå› ä¸ºå®‰å“æœ‰äº†åŠ¨æ€HALçš„æ¦‚å¿µï¼Œå…·ä½“å¯ä»¥å‚è§æˆ‘çš„å¦å¤–ä¸€ç¯‡<a href="https://anmuxixixi.github.io/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/">åšå®¢</a></p></blockquote><h2 id="1-å“ªé‡Œä¼šå»è°ƒç”¨ctl-interface-start"><a href="#1-å“ªé‡Œä¼šå»è°ƒç”¨ctl-interface-start" class="headerlink" title="1.å“ªé‡Œä¼šå»è°ƒç”¨ctl.interface_start"></a>1.å“ªé‡Œä¼šå»è°ƒç”¨ctl.interface_start</h2><p>ä¸ºä»€ä¹ˆä¸€ç›´å¼ºè°ƒèƒŒæ™¯çš„é‡è¦æ€§ï¼Œå¦‚æœè„±ç¦»çš„èƒŒæ™¯ï¼Œçœ‹ä»£ç çš„å®ç°æ˜¯ç—›è‹¦çš„ï¼Œæ˜¯æ¢¦æ¸¸çš„ï¼Œæ˜¯æ— ç”¨åŠŸğŸ–</p><p>å°±å¥½æ¯”è¿™é‡Œï¼Œå¦‚æœä¸çŸ¥é“ctl.interface_startå‡ºç°çš„èƒŒæ™¯ï¼Œå°±ä¸çŸ¥é“å“ªé‡Œè°ƒç”¨äº†<code>ctl.interface_start</code>ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåœ¨æŸä¸€ä¸ªAndroidç‰ˆæœ¬é‡Œé¢çªç„¶å‡ºç°äº†å®ƒã€‚</p><p>å¥½äº†ï¼Œä»èƒŒæ™¯æ¥çœ‹æ˜¯ä¸ºäº†å®ç°HALçš„åŠ¨æ€å¯åŠ¨ï¼Œæ¯”å¦‚WIFIæˆ‘ä»¬ä¸ç”¨çš„æ—¶å€™ï¼ŒWIFIç›¸åº”çš„HALéœ€è¦è‡ªåŠ¨å…³é—­ï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªHALçš„åŠ¨æ€å¯åŠ¨ï¼Œç”¨çš„æ—¶å€™å¼€ï¼Œæœ€å¤§ç¨‹åº¦çš„èŠ‚çœç³»ç»Ÿèµ„æºã€‚</p><blockquote><p>ğŸ¨ <strong>å£°æ˜</strong>ï¼šé‚£æˆ‘ä»¬ä»¥CameraHALä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æï¼ã€æœ¬äººä¸æ˜¯ä¸“ä¸šæCameraçš„ï¼Œæ•…å‚è€ƒ<a href="https://blog.csdn.net/liujun3512159/article/details/124702217%E3%80%91">https://blog.csdn.net/liujun3512159/article/details/124702217ã€‘</a></p><p>å¦å¤–ï¼Œå…³äºHALçš„å¯åŠ¨æµç¨‹ï¼Œæˆ‘ä¹Ÿä¼šå†™ä¸€ç¯‡è¯¦å°½çš„åšå®¢ä¾›è‡ªå·±å¤ä¹ å’Œå¤§å®¶å‚è€ƒï¼</p></blockquote><p>clientéœ€è¦è·å–halæœåŠ¡ï¼Œä¸€èˆ¬éƒ½ä¼šè°ƒç”¨servicemanagerå»getservice</p><img src="/2023/03/24/%E5%AE%89%E5%8D%93init%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97-1-ctl-interface-start/image-20230324225335198-1679669618537-1-1679669619970-3.png" alt="image-20230324225335198" style="zoom:80%;"><p>å½“clientå‘hwservicemanagerè·å–æœåŠ¡çš„æ—¶å€™ï¼Œå‘ç°æ‰¾ä¸åˆ°è¯¥æœåŠ¡ï¼Œé‚£ä¹ˆä¼šå»è°ƒç”¨<strong>tryStartService</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\hwservicemanager\ServiceManager.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">tryStartService</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; fqName, <span class="hljs-type">const</span> std::string&amp; name)</span> </span>&#123;<br>    <span class="hljs-keyword">using</span> ::android::base::SetProperty;<br><br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Since &quot;</span> &lt;&lt; fqName &lt;&lt; <span class="hljs-string">&quot;/&quot;</span> &lt;&lt; name<br>              &lt;&lt; <span class="hljs-string">&quot; is not registered, trying to start it as a lazy HAL.&quot;</span>;<br><br>    std::<span class="hljs-built_in">thread</span>([=] &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">&quot;ctl.interface_start&quot;</span>, fqName + <span class="hljs-string">&quot;/&quot;</span> + name)) &#123;<br>            <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Tried to start &quot;</span> &lt;&lt; fqName &lt;&lt; <span class="hljs-string">&quot;/&quot;</span> &lt;&lt; name<br>                      &lt;&lt; <span class="hljs-string">&quot; as a lazy service, but was unable to. Usually this happens when a &quot;</span><br>                         <span class="hljs-string">&quot;service is not installed, but if the service is intended to be used as a &quot;</span><br>                         <span class="hljs-string">&quot;lazy service, then it may be configured incorrectly.&quot;</span>;<br>        &#125;<br>    &#125;).<span class="hljs-built_in">detach</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è®¾ç½®å±æ€§å€¼ï¼Œkeyä¸º<code>ctl.interface_start</code>ï¼Œvalueä¸º<code>fqName + &quot;/&quot; + name</code>ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“initè¿›è¡Œæ•è·åˆ°ç³»ç»Ÿå±æ€§å€¼å˜åŒ–ä»¥åä¼šè°ƒç”¨<strong>HandlePropertySet</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">HandlePropertySet</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; value,</span></span><br><span class="hljs-params"><span class="hljs-function">                           <span class="hljs-type">const</span> std::string&amp; source_context, <span class="hljs-type">const</span> ucred&amp; cr,</span></span><br><span class="hljs-params"><span class="hljs-function">                           SocketConnection* socket, std::string* error)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">&quot;ctl.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">SendControlMessage</span>(name.<span class="hljs-built_in">c_str</span>() + <span class="hljs-number">4</span>, value, cr.pid, socket, error);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“å±æ€§å€¼ä»¥ctl.å¼€å¤´ï¼Œè°ƒç”¨SendControlMessage</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\property_service.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> <span class="hljs-title">SendControlMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; msg, <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">pid_t</span> pid,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   SocketConnection* socket, std::string* error)</span> </span>&#123;<br>    <span class="hljs-comment">// è°ƒç”¨QueueControlMessage</span><br>    <span class="hljs-type">bool</span> queue_success = <span class="hljs-built_in">QueueControlMessage</span>(msg, name, pid, fd);<br><br>    <span class="hljs-keyword">return</span> PROP_SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">QueueControlMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message, <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">pid_t</span> pid, <span class="hljs-type">int</span> fd)</span> </span>&#123;<br>    pending_control_messages.<span class="hljs-built_in">push</span>(&#123;message, name, pid, fd&#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¾€<code>pending_control_messages</code>æ”¾äº†<code>message, name, pid, fd</code>è¿™äº›é‡è¦çš„ä¿¡æ¯ï¼ï¼ï¼</p><p>æŒ‰ç…§initçš„è®¾è®¡æ€æƒ³ï¼Œç±»ä¼¼äºrcæ–‡ä»¶ä¸­serviceçš„å¤„ç†æ–¹å¼ï¼æ—¢ç„¶å‘pending_control_messagesæ”¾äº†ä¸€æ¡ä¿¡æ¯å¾…å¤„ç†ï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰ä¸€ä¸ªåœ°æ–¹ä¸“é—¨æ¶ˆè´¹pending_control_messagesä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ç†è§£è¿™é‡Œè¿ç”¨äº†<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</strong>è®¾è®¡æ¨¡å¼ï¼ŒğŸ§ç­”æ¡ˆåœ¨ç¬¬3èŠ‚ï¼</p><h2 id="2-initè¿›ç¨‹å¯åŠ¨åç»­"><a href="#2-initè¿›ç¨‹å¯åŠ¨åç»­" class="headerlink" title="2.initè¿›ç¨‹å¯åŠ¨åç»­"></a>2.initè¿›ç¨‹å¯åŠ¨åç»­</h2><p>Android Sä»å®è§‚æ¥çœ‹ï¼Œinitè¿›ç¨‹æ€»å…±åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œæœ€åä¸€ä¸ªé˜¶æ®µä¹Ÿå°±æ˜¯<strong>SecondStageMain</strong>ï¼Œå½“SecondStageMainæ‰€æœ‰ä»£ç æ‰§è¡Œç»“æŸï¼Œinitè¿›ç¨‹åŸºæœ¬å°±ç»“æŸäº†ï¼Œä½†ä¸ä»£è¡¨initè¿›ç¨‹å•¥ä¹Ÿä¸å¹²äº†ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå…³é”®çš„<u><strong>whileå¾ªç¯</strong></u>ï¼Œä¼šä¸€ç›´ç›‘å¬æ˜¯å¦æ”¶åˆ°ctlMsgä¿¡æ¯ï¼ï¼ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsShuttingDown</span>()) &#123;<br>            <span class="hljs-built_in">HandleControlMessages</span>();<br>            <span class="hljs-built_in">SetUsbController</span>();<br>        &#125;<br>    &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆå¤„ç†CtlMsgä¿¡æ¯çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ç”¨ç†ä¼šä¸ctl.interface_startçš„è”ç³».</p><h2 id="3-HandleControlMessages-æ€ä¹ˆå¤„ç†CtlMsg"><a href="#3-HandleControlMessages-æ€ä¹ˆå¤„ç†CtlMsg" class="headerlink" title="3.HandleControlMessages:æ€ä¹ˆå¤„ç†CtlMsg"></a>3.HandleControlMessages:æ€ä¹ˆå¤„ç†CtlMsg</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\init.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">HandleControlMessages</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// å½“pending_control_messagesä¸ä¸ºç©ºçš„æ—¶å€™</span><br>    <span class="hljs-keyword">if</span> (!pending_control_messages.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">auto</span> control_message = pending_control_messages.<span class="hljs-built_in">front</span>();<br>        pending_control_messages.<span class="hljs-built_in">pop</span>();<br>        <span class="hljs-comment">// å…³é”®çœ‹è¿™é‡Œï¼Œè¿™é‡Œå›å»è°ƒç”¨HandleControlMessageå¤„ç†ç›¸å…³çš„ä¿¡æ¯</span><br>        <span class="hljs-type">bool</span> success = <span class="hljs-built_in">HandleControlMessage</span>(control_message.message, control_message.name,<br>                                            control_message.pid);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ä¸ºå…³é”®çš„æ˜¯HandleControlMessageï¼Œå®ƒè´Ÿè´£å¤„ç†æ¯ä¸€æ¡å…·ä½“çš„CtlMsg</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">HandleControlMessage</span><span class="hljs-params">(std::string_view message, <span class="hljs-type">const</span> std::string&amp; name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">pid_t</span> from_pid)</span> </span>&#123;<br>    <span class="hljs-comment">// è·å–è¿›ç¨‹çš„çš„cmdline_pathï¼Œè¿™é‡Œcamerahalä¼ è¿›æ¥çš„åº”è¯¥æ˜¯hwservicemanagerå¯¹åº”çš„pid</span><br>    <span class="hljs-comment">// åŒæ—¶è·å–çš„cmdline_pathå°±æ˜¯hwservicemangerè¿™ä¸ªå­—ç¬¦ä¸²</span><br>    std::string cmdline_path = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;proc/%d/cmdline&quot;</span>, from_pid);<br>    std::string process_cmdline;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadFileToString</span>(cmdline_path, &amp;process_cmdline)) &#123;<br>        std::<span class="hljs-built_in">replace</span>(process_cmdline.<span class="hljs-built_in">begin</span>(), process_cmdline.<span class="hljs-built_in">end</span>(), <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>);<br>        process_cmdline = <span class="hljs-built_in">Trim</span>(process_cmdline);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        process_cmdline = <span class="hljs-string">&quot;unknown process&quot;</span>;<br>    &#125;<br><br>    Service* service = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">auto</span> action = message;<br>    <span class="hljs-comment">// å¦‚æœactionä»¥interface_å¼€å¤´ï¼Œå°±å»ServiceListä¸­å¯»æ‰¾</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ConsumePrefix</span>(&amp;action, <span class="hljs-string">&quot;interface_&quot;</span>)) &#123;<br>        service = ServiceList::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">FindInterface</span>(name);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        service = ServiceList::<span class="hljs-built_in">GetInstance</span>().<span class="hljs-built_in">FindService</span>(name);<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–æˆ‘ä»¬è¦æ‰§è¡Œsigstop_on,oneshot_on,....,start,stop,...ä¸­çš„ä¸€ç§</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; map = <span class="hljs-built_in">GetControlMessageMap</span>();<br>    <span class="hljs-comment">// æ˜¾ç„¶è¿™é‡Œæ‰¾åˆ°çš„æ˜¯start</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> it = map.<span class="hljs-built_in">find</span>(action);<br><span class="hljs-comment">// startå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºDoControlStart</span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; function = it-&gt;second;<br><br>    <span class="hljs-comment">// è°ƒç”¨DoControlStartæ‰§è¡Œè¿™ä¸ªæœåŠ¡</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">function</span>(service); !result.<span class="hljs-built_in">ok</span>()) &#123;<br>        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Control message: Could not ctl.&quot;</span> &lt;&lt; message &lt;&lt; <span class="hljs-string">&quot; for &#x27;&quot;</span> &lt;&lt; name<br>                   &lt;&lt; <span class="hljs-string">&quot;&#x27; from pid: &quot;</span> &lt;&lt; from_pid &lt;&lt; <span class="hljs-string">&quot; (&quot;</span> &lt;&lt; process_cmdline<br>                   &lt;&lt; <span class="hljs-string">&quot;): &quot;</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;Control message: Processed ctl.&quot;</span> &lt;&lt; message &lt;&lt; <span class="hljs-string">&quot; for &#x27;&quot;</span> &lt;&lt; name<br>              &lt;&lt; <span class="hljs-string">&quot;&#x27; from pid: &quot;</span> &lt;&lt; from_pid &lt;&lt; <span class="hljs-string">&quot; (&quot;</span> &lt;&lt; process_cmdline &lt;&lt; <span class="hljs-string">&quot;)&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">const</span> std::map&lt;std::string, ControlMessageFunction, std::less&lt;&gt;&gt;&amp; <span class="hljs-built_in">GetControlMessageMap</span>() &#123;<br>    <span class="hljs-comment">// clang-format off</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> std::map&lt;std::string, ControlMessageFunction, std::less&lt;&gt;&gt; control_message_functions = &#123;<br>        &#123;<span class="hljs-string">&quot;sigstop_on&quot;</span>,        [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_sigstop</span>(<span class="hljs-literal">true</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;sigstop_off&quot;</span>,       [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_sigstop</span>(<span class="hljs-literal">false</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;oneshot_on&quot;</span>,        [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_oneshot</span>(<span class="hljs-literal">true</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;oneshot_off&quot;</span>,       [](<span class="hljs-keyword">auto</span>* service) &#123; service-&gt;<span class="hljs-built_in">set_oneshot</span>(<span class="hljs-literal">false</span>); <span class="hljs-keyword">return</span> Result&lt;<span class="hljs-type">void</span>&gt;&#123;&#125;; &#125;&#125;,<br>        &#123;<span class="hljs-string">&quot;start&quot;</span>,             DoControlStart&#125;,<br>        &#123;<span class="hljs-string">&quot;stop&quot;</span>,              DoControlStop&#125;,<br>        &#123;<span class="hljs-string">&quot;restart&quot;</span>,           DoControlRestart&#125;,<br>    &#125;;<br>    <span class="hljs-comment">// clang-format on</span><br><br>    <span class="hljs-keyword">return</span> control_message_functions;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€å¯ç”¨çš„ HAL</title>
    <link href="/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/"/>
    <url>/2023/03/24/%E5%8A%A8%E6%80%81%E5%8F%AF%E7%94%A8%E7%9A%84-HAL/</url>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æ€å¯ç”¨çš„-HAL"><a href="#åŠ¨æ€å¯ç”¨çš„-HAL" class="headerlink" title="åŠ¨æ€å¯ç”¨çš„ HAL"></a>åŠ¨æ€å¯ç”¨çš„ HAL</h1><blockquote><p>ğŸ¤– å…¨éƒ¨æ¥è‡ª<a href="https://source.android.com/docs/core/architecture/hal/dynamic-lifecycle?hl=zh-cn">å®‰å“å®˜ç½‘</a></p></blockquote><p>Android 9 æ”¯æŒåœ¨ä¸ä½¿ç”¨æˆ–ä¸éœ€è¦ Android ç¡¬ä»¶å­ç³»ç»Ÿæ—¶åŠ¨æ€å…³åœè¿™äº›å­ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·æœªä½¿ç”¨ Wi-Fiï¼ŒWi-Fi å­ç³»ç»Ÿå°±ä¸åº”å ç”¨å†…å­˜ã€è€—ç”¨ç”µé‡æˆ–ä½¿ç”¨å…¶ä»–ç³»ç»Ÿèµ„æºã€‚æ—©æœŸç‰ˆæœ¬çš„ Android ä¸­ï¼Œåœ¨ Android æ‰‹æœºå¯åŠ¨çš„æ•´ä¸ªæœŸé—´ï¼ŒAndroid è®¾å¤‡ä¸Šçš„ HAL&#x2F;é©±åŠ¨ç¨‹åºéƒ½ä¼šä¿æŒå¼€å¯çŠ¶æ€ã€‚</p><p>å®ç°åŠ¨æ€å…³åœæ¶‰åŠè¿æ¥æ•°æ®æµä»¥åŠæ‰§è¡ŒåŠ¨æ€è¿›ç¨‹ï¼Œä¸‹æ–‡å¯¹æ­¤è¿›è¡Œäº†è¯¦ç»†ä»‹ç»ã€‚</p><h2 id="å¯¹-HAL-å®šä¹‰æ‰€åšçš„æ›´æ”¹"><a href="#å¯¹-HAL-å®šä¹‰æ‰€åšçš„æ›´æ”¹" class="headerlink" title="å¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹"></a>å¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹</h2><p>è¦å®ç°åŠ¨æ€å…³åœï¼Œä¸ä»…éœ€è¦æœ‰å…³äºå“ªäº›è¿›ç¨‹ä¸ºå“ªäº› HAL æ¥å£æä¾›æœåŠ¡çš„ä¿¡æ¯ï¼ˆæ­¤ç±»ä¿¡æ¯ä¹‹ååœ¨å…¶ä»–æƒ…å†µä¸­ä¹Ÿå¯èƒ½å¾ˆæœ‰ç”¨ï¼‰ï¼Œè¿˜éœ€è¦ç¡®ä¿è®¾å¤‡å¯åŠ¨æ—¶ä¸å¯åŠ¨è¿›ç¨‹ï¼Œè€Œä¸”åœ¨è¿›ç¨‹é€€å‡ºåï¼Œç›´åˆ°ç³»ç»Ÿå†æ¬¡è¯·æ±‚å¯åŠ¨å®ƒä»¬ä¹‹å‰ï¼Œéƒ½ä¸é‡æ–°å¯åŠ¨å®ƒä»¬ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># some init.rc script associated with the HAL</span><br>service vendor.some-service-name /vendor/bin/hw/some-binary-service<br>    <span class="hljs-comment"># init language extension, provides information of what service is served</span><br>    <span class="hljs-comment"># if multiple interfaces are served, they can be specified one on each line</span><br>    interface android.hardware.light@2.0::ILight default<br>    <span class="hljs-comment"># restarted if hwservicemanager dies</span><br>    <span class="hljs-comment"># would also cause the hal to start early during boot if disabled wasn&#x27;t set</span><br>    class hal<br>    <span class="hljs-comment"># will not be restarted if it exits until it is requested to be restarted</span><br>    oneshot<br>    <span class="hljs-comment"># will only be started when requested</span><br>    disabled<br>    <span class="hljs-comment"># ... other properties</span><br></code></pre></td></tr></table></figure><h2 id="å¯¹-init-å’Œ-hwservicemanager-æ‰€åšçš„æ›´æ”¹"><a href="#å¯¹-init-å’Œ-hwservicemanager-æ‰€åšçš„æ›´æ”¹" class="headerlink" title="å¯¹ init å’Œ hwservicemanager æ‰€åšçš„æ›´æ”¹"></a>å¯¹ init å’Œ hwservicemanager æ‰€åšçš„æ›´æ”¹</h2><p>ä¸ºäº†å®ç°åŠ¨æ€å…³åœï¼Œè¿˜éœ€è¦è®© <code>hwservicemanager</code> å‘ŠçŸ¥ <code>init</code> å¯åŠ¨æ‰€è¯·æ±‚çš„æœåŠ¡ã€‚åœ¨ Android 9 ä¸­ï¼Œ<code>init</code> åŒ…å«ä¸‰ä¸ªé¢å¤–çš„æ§åˆ¶æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼Œ<code>ctl.start</code>ï¼‰ï¼š<code>ctl.interface_start</code>ã€<code>ctl.interface_stop</code> å’Œ <code>ctl.interface_restart</code>ã€‚è¿™äº›æ¶ˆæ¯å¯ç”¨äºæŒ‡ç¤º <code>init</code> æ‰“å¼€æˆ–å…³é—­ç‰¹å®šç¡¬ä»¶æ¥å£ã€‚å¦‚æœç³»ç»Ÿè¯·æ±‚ä½¿ç”¨æŸä¸ªæœåŠ¡ä½†è¯¥æœåŠ¡æœªæ³¨å†Œï¼Œ<code>hwservicemanager</code> ä¼šè¯·æ±‚å¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸è¿‡ï¼ŒåŠ¨æ€ HAL ä¸éœ€è¦ä½¿ç”¨ä»¥ä¸Šä»»ä½•æ¶ˆæ¯ã€‚</p><h2 id="ç¡®å®š-HAL-é€€å‡º"><a href="#ç¡®å®š-HAL-é€€å‡º" class="headerlink" title="ç¡®å®š HAL é€€å‡º"></a>ç¡®å®š HAL é€€å‡º</h2><p>åœ¨ Android 9 ä¸­ï¼Œå¿…é¡»æ‰‹åŠ¨ç¡®å®š HAL é€€å‡ºã€‚å¯¹äº Android 10 åŠæ›´é«˜ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç¡®å®š HAL é€€å‡ºã€‚</p><p>ä¸ºäº†å®ç°åŠ¨æ€å…³åœï¼Œéœ€è¦å¤šä¸ªç­–ç•¥æ¥å†³å®šä½•æ—¶å¯åŠ¨å’Œå…³åœ HALã€‚å¦‚æœ HAL å‡ºäºä»»ä½•åŸå› å†³å®šé€€å‡ºï¼Œå½“ç³»ç»Ÿå†æ¬¡éœ€è¦ç”¨åˆ°å®ƒæ—¶ï¼Œå®ƒå°†ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯å’ŒåŸºç¡€æ¶æ„è‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼šHAL å®šä¹‰ä¸­æä¾›çš„ä¿¡æ¯ï¼Œä»¥åŠæ›´æ”¹åçš„ <code>init</code> å’Œ <code>hwservicemanager</code> æä¾›çš„åŸºç¡€æ¶æ„ã€‚è¿™å¯èƒ½ä¼šæ¶‰åŠå¤šä¸ªä¸åŒçš„ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¦‚æœæœ‰äººå¯¹ HAL è°ƒç”¨å…³é—­å‘½ä»¤æˆ–ç±»ä¼¼çš„ APIï¼Œåˆ™ HAL å¯èƒ½ä¼šé€‰æ‹©è‡ªè¡Œè°ƒç”¨é€€å‡ºå‘½ä»¤ã€‚æ­¤è¡Œä¸ºå¿…é¡»åœ¨ç›¸åº”çš„ HAL æ¥å£ä¸­æŒ‡å®šã€‚</li><li>HAL å¯åœ¨ä»»åŠ¡å®Œæˆåå…³åœï¼ˆè®°å½•åœ¨ HAL æ–‡ä»¶ä¸­ï¼‰ã€‚</li></ul><h2 id="è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ"><a href="#è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ"></a>è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ</h2><p>Android 10 ä¸ºå†…æ ¸å’Œ hwservicemanager æ·»åŠ äº†æ›´å¤šæ”¯æŒï¼Œå¯è®© HAL åœ¨æ²¡æœ‰ä»»ä½•å®¢æˆ·ç«¯æ—¶è‡ªåŠ¨å…³åœã€‚å¦‚éœ€ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·æ ¹æ®â€œå¯¹ HAL å®šä¹‰æ‰€åšçš„æ›´æ”¹â€è¿™ä¸€éƒ¨åˆ†å®Œæˆå…¶ä¸­æ‰€æœ‰æ­¥éª¤ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ <code>LazyServiceRegistrar</code> è€Œä¸æ˜¯æˆå‘˜å‡½æ•° <code>registerAsService</code> é€šè¿‡ C++ æ³¨å†ŒæœåŠ¡ï¼Œä¾‹å¦‚ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// only one instance of LazyServiceRegistrar per process</span><br>LazyServiceRegistrar registrar;<br>registrar.<span class="hljs-built_in">registerAsService</span>(myHidlService <span class="hljs-comment">/* , &quot;default&quot; */</span>);<br></code></pre></td></tr></table></figure><ul><li>éªŒè¯ HAL å®¢æˆ·ç«¯æ˜¯å¦ä»…åœ¨ä½¿ç”¨æ—¶ä¿ç•™å¯¹é¡¶çº§ HALï¼ˆé€šè¿‡ <code>hwservicemanager</code> æ³¨å†Œçš„æ¥å£ï¼‰çš„å¼•ç”¨ã€‚ä¸ºäº†é¿å…å‡ºç°å»¶è¿Ÿï¼Œå¦‚æœè¯¥å¼•ç”¨åœ¨ç»§ç»­æ‰§è¡Œçš„ hwbinder çº¿ç¨‹ä¸Šè¢«ä¸¢å¼ƒï¼Œå®¢æˆ·ç«¯è¿˜åº”è¯¥åœ¨ä¸¢å¼ƒå¼•ç”¨åè°ƒç”¨ <code>IPCThreadState::self()-&gt;flushCommands()</code>ï¼Œä»¥ç¡®ä¿ binder é©±åŠ¨ç¨‹åºåœ¨ç›¸å…³å¼•ç”¨è®¡æ•°å‘ç”Ÿå˜åŒ–æ—¶æ”¶åˆ°é€šçŸ¥ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gitå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="gitå­¦ä¹ ç¬”è®°"><a href="#gitå­¦ä¹ ç¬”è®°" class="headerlink" title="gitå­¦ä¹ ç¬”è®°"></a>gitå­¦ä¹ ç¬”è®°</h1><h2 id="gitä¸‹è½½å®‰è£…"><a href="#gitä¸‹è½½å®‰è£…" class="headerlink" title="gitä¸‹è½½å®‰è£…"></a>gitä¸‹è½½å®‰è£…</h2><p>ä¸‹è½½åœ°å€ï¼š<a href="https://git-scm.com/download">Git - Downloads</a></p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1679585116661-4.png" alt="img"><p>ä»¥å¾—åˆ°å¦‚ä¸‹å®‰è£…æ–‡ä»¶ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1679585140689-7.png" alt="img"><p>åŒå‡»ä¸‹è½½çš„å®‰è£…æ–‡ä»¶æ¥å®‰è£…Gitã€‚å®‰è£…å®Œæˆååœ¨ç”µè„‘æ¡Œé¢ï¼ˆä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç›®å½•ï¼‰ç‚¹å‡»å³é”®ï¼Œå¦‚æœèƒ½å¤Ÿçœ‹</p><p>åˆ°å¦‚ä¸‹ä¸¤ä¸ªèœå•åˆ™è¯´æ˜Gitå®‰è£…æˆåŠŸ</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230323232638131.png" alt="image-20230323232638131" style="zoom: 70%;"><p>å¤‡æ³¨ï¼š</p><ul><li>Git GUIï¼šGitæä¾›çš„å›¾å½¢ç•Œé¢å·¥å…·</li><li>Git Bashï¼šGitæä¾›çš„å‘½ä»¤è¡Œå·¥å…·</li></ul><p>å½“å®‰è£…Gitåé¦–å…ˆè¦åšçš„äº‹æƒ…æ˜¯è®¾ç½®ç”¨æˆ·åç§°å’Œemailåœ°å€ã€‚è¿™æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºæ¯æ¬¡Gitæäº¤éƒ½ä¼šä½¿ç”¨è¯¥ç”¨æˆ·ä¿¡æ¯</p><h2 id="gitä¸‰ä¸ªåŒº"><a href="#gitä¸‰ä¸ªåŒº" class="headerlink" title="gitä¸‰ä¸ªåŒº"></a>gitä¸‰ä¸ªåŒº</h2><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/e38fd405-7e6a-4cc7-b576-a991af1d9cd5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><ul><li><code>Workspace</code>ï¼šå·¥ä½œåŒºï¼Œå°±æ˜¯ä½ å¹³æ—¶å­˜æ”¾é¡¹ç›®ä»£ç çš„åœ°æ–¹</li><li><code>Index / Stage</code>ï¼šæš‚å­˜åŒºï¼Œç”¨äºä¸´æ—¶å­˜æ”¾ä½ çš„æ”¹åŠ¨ï¼Œäº‹å®ä¸Šå®ƒåªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜å³å°†æäº¤åˆ°æ–‡ä»¶åˆ—è¡¨ä¿¡æ¯,ä¸€èˆ¬å­˜æ”¾åœ¨ .git ç›®å½•ä¸‹çš„ index æ–‡ä»¶ï¼ˆ.git&#x2F;indexï¼‰ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæš‚å­˜åŒºæœ‰æ—¶ä¹Ÿå«ä½œç´¢å¼•ï¼ˆindexï¼‰</li><li><code>Repository</code>ï¼šä»“åº“åŒºï¼ˆæˆ–æœ¬åœ°ä»“åº“ï¼‰ï¼Œå°±æ˜¯å®‰å…¨å­˜æ”¾æ•°æ®çš„ä½ç½®ï¼Œè¿™é‡Œé¢æœ‰ä½ æäº¤åˆ°æ‰€æœ‰ç‰ˆæœ¬çš„æ•°æ®ã€‚å…¶ä¸­HEADæŒ‡å‘æœ€æ–°æ”¾å…¥ä»“åº“çš„ç‰ˆæœ¬</li><li><code>Remote</code>ï¼šè¿œç¨‹ä»“åº“ï¼Œæ‰˜ç®¡ä»£ç çš„æœåŠ¡å™¨ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºæ˜¯ä½ é¡¹ç›®ç»„ä¸­çš„ä¸€å°ç”µè„‘ç”¨äºè¿œç¨‹æ•°æ®äº¤æ¢</li></ul><hr><p><strong>å‘½ä»¤å¦‚ä¸‹ï¼š</strong></p><ol><li>cloneï¼ˆå…‹éš†ï¼‰: ä»è¿œç¨‹ä»“åº“ä¸­å…‹éš†ä»£ç åˆ°æœ¬åœ°ä»“åº“</li><li>checkout ï¼ˆæ£€å‡ºï¼‰:ä»æœ¬åœ°ä»“åº“ä¸­æ£€å‡ºä¸€ä¸ªä»“åº“åˆ†æ”¯ç„¶åè¿›è¡Œä¿®è®¢</li><li>addï¼ˆæ·»åŠ ï¼‰: åœ¨æäº¤å‰å…ˆå°†ä»£ç æäº¤åˆ°æš‚å­˜åŒº</li><li>commitï¼ˆæäº¤ï¼‰: æäº¤åˆ°æœ¬åœ°ä»“åº“ã€‚æœ¬åœ°ä»“åº“ä¸­ä¿å­˜ä¿®æ”¹çš„å„ä¸ªå†å²ç‰ˆæœ¬</li><li>fetch (æŠ“å–) ï¼š ä»è¿œç¨‹åº“ï¼ŒæŠ“å–åˆ°æœ¬åœ°ä»“åº“ï¼Œä¸è¿›è¡Œä»»ä½•çš„åˆå¹¶åŠ¨ä½œï¼Œä¸€èˆ¬æ“ä½œæ¯”è¾ƒå°‘ã€‚</li><li>pull (æ‹‰å–) ï¼š ä»è¿œç¨‹åº“æ‹‰åˆ°æœ¬åœ°åº“ï¼Œè‡ªåŠ¨è¿›è¡Œåˆå¹¶(merge)ï¼Œç„¶åæ”¾åˆ°åˆ°å·¥ä½œåŒºï¼Œç›¸å½“äºfetch+merge</li><li>pushï¼ˆæ¨é€ï¼‰ : ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦å’Œå›¢é˜Ÿæˆå‘˜å…±äº«ä»£ç æ—¶ï¼Œå°†ä»£ç æ¨é€åˆ°è¿œç¨‹ä»“åº“</li></ol><h2 id="git-configé…ç½®ä½œè€…ä¿¡æ¯"><a href="#git-configé…ç½®ä½œè€…ä¿¡æ¯" class="headerlink" title="git configé…ç½®ä½œè€…ä¿¡æ¯"></a>git configé…ç½®ä½œè€…ä¿¡æ¯</h2><blockquote><p>åç›¾äººï¼š<a href="https://www.bilibili.com/video/BV1WW4y1b78T">https://www.bilibili.com/video/BV1WW4y1b78T</a></p></blockquote><p>é…ç½®æ–‡ä»¶ä¸º<code>~/.gitconfig</code>ï¼Œæ‰§è¡Œä»»ä½•Gité…ç½®å‘½ä»¤åæ–‡ä»¶å°†è‡ªåŠ¨åˆ›å»ºã€‚</p><p>ç¬¬ä¸€ä¸ªè¦é…ç½®çš„æ˜¯ä½ ä¸ªäººçš„ç”¨æˆ·åç§°å’Œç”µå­é‚®ä»¶åœ°å€ï¼Œè¿™ä¸¤æ¡é…ç½®å¾ˆé‡è¦ï¼Œæ¯æ¬¡Gitæäº¤æ—¶éƒ½ä¼šå¼•ç”¨è¿™ä¸¤æ¡ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯è°æäº¤äº†æ›´æ–°ï¼Œæ‰€ä»¥ä¼šéšæ›´æ–°å†…å®¹ä¸€èµ·è¢«æ°¸ä¹…çº³å…¥å†å²è®°å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">git config --global user.name â€œOneAmxixixiâ€<br>git config --global user.email â€œ842629356@qq.com&quot;<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœæˆ‘ä»¬è¦åœ¨ç‰¹å®šçš„é¡¹ç›®ä»“ä¸­ä¿®æ”¹æäº¤äººä¿¡æ¯ï¼š</li></ul><p>å½“æˆ‘ä»¬git initåˆå§‹åŒ–æœ¬åœ°ä»“åº“åï¼Œä¼šå‡ºç°.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬è¿›å…¥é‡Œé¢çš„é…ç½®æ–‡ä»¶<code>config</code>ã€‚</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325224813424.png" alt="image-20230325224813424" style="zoom:70%;"><p>æ­¤æ—¶configæ–‡ä»¶å¦‚ä¸‹ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325224941049.png" alt="image-20230325224941049" style="zoom: 67%;"><p>ä¿®æ”¹å½“å‰ä»“åº“æäº¤äººä¿¡æ¯ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Administrator@WBX-20220621BRZ MINGW64 /g/gitå¼ºåŒ–å­¦ä¹ /android12 (master)<br>$ git config user.name <span class="hljs-string">&quot;baitaowulong&quot;</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å½“å‰ä»“åº“çš„<code>.git/config</code>å°±å‡ºç°äº†æ–°çš„æäº¤äºº</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325225038843.png" alt="image-20230325225038843" style="zoom:67%;"><h2 id="gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨"><a href="#gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨" class="headerlink" title=".gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨"></a>.gitignoreæ·»åŠ æ–‡ä»¶è‡³å¿½ç•¥åˆ—è¡¨</h2><p>ä¸€èˆ¬æˆ‘ä»¬æ€»ä¼šæœ‰äº›æ–‡ä»¶æ— éœ€çº³å…¥Git çš„ç®¡ç†ï¼Œä¹Ÿä¸å¸Œæœ›å®ƒä»¬æ€»å‡ºç°åœ¨æœªè·Ÿè¸ªæ–‡ä»¶åˆ—è¡¨ã€‚ é€šå¸¸éƒ½æ˜¯äº›è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…ç¼–è¯‘è¿‡ç¨‹ä¸­åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶ç­‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>.gitignore</code> çš„æ–‡ä»¶ï¼ˆæ–‡ä»¶åç§°å›ºå®šï¼‰ï¼Œåˆ—å‡ºè¦å¿½ç•¥çš„æ–‡ä»¶æ¨¡å¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥æ‰€æœ‰ä»¥.aç»“å°¾çš„æ–‡ä»¶</span><br>*.a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥æ‰€æœ‰ä»¥.aç»“å°¾çš„æ–‡ä»¶ï¼Œé™¤äº†lib.a</span><br>!lib.a<br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä»…ä»…å¿½ç•¥å½“å‰ç›®å½•ä¸‹çš„TODOæ–‡ä»¶å¤¹ï¼Œä½†ä¸å¿½ç•¥å½“å‰è·¯å¾„å­æ–‡ä»¶çš„TODOæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚./subdir/TODO</span><br>/TODO<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥build/ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶</span><br>build/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥docç›®å½•ä¸‹ä»¥.txtç»“å°¾çš„æ–‡ä»¶ï¼Œä½†ä¸å¿½ç•¥docå­ç›®å½•ä¸‹ä»¥txtæ–‡ä»¶çš„æ–‡ä»¶ï¼Œæ¯”å¦‚doc/server/arch.txtä¸ä¼šå¿½ç•¥</span><br>doc/*.txt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¿½ç•¥docæ–‡ä»¶ä¸‹æ‰€æœ‰ä»¥pdfç»“å°¾çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­ç›®å½•</span><br>doc/**/*.pdf<br></code></pre></td></tr></table></figure><ol><li>æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªä»¥<code>.java</code>ç»“å°¾ï¼Œä¸€ä¸ªä»¥<code>.c</code>ç»“å°¾</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231753957.png" alt="image-20230325231753957" style="zoom:80%;"><ol start="2"><li>åœ¨<code>.gitignore</code>ä¸­è®¾ç½®è¢«å¿½ç•¥çš„è§„åˆ™</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231903931.png" alt="image-20230325231903931" style="zoom:80%;"><ol start="3"><li>æ­¤æ—¶æœ¬åœ°ä»“åº“å°±ä¸ä¼šè·Ÿè¸ª<code>.gitignore</code>ä¸­çš„å†…å®¹</li></ol><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230325231922326.png" alt="image-20230325231922326" style="zoom: 80%;"><h2 id="git-rmåˆ é™¤æ–‡ä»¶"><a href="#git-rmåˆ é™¤æ–‡ä»¶" class="headerlink" title="git rmåˆ é™¤æ–‡ä»¶"></a>git rmåˆ é™¤æ–‡ä»¶</h2><h3 id="git-rmåŸºæœ¬ç”¨æ³•"><a href="#git-rmåŸºæœ¬ç”¨æ³•" class="headerlink" title="git rmåŸºæœ¬ç”¨æ³•"></a>git rmåŸºæœ¬ç”¨æ³•</h3><p><strong>ä½œç”¨ï¼š</strong>  <strong>åŒæ—¶ä»å·¥ä½œåŒºå’Œç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶</strong>ã€‚å³æœ¬åœ°çš„æ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†ã€‚</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326104602205.png" alt="image-20230326104602205" style="zoom:80%;"><h3 id="git-rm-â€“cacheåæ‚”è¯"><a href="#git-rm-â€“cacheåæ‚”è¯" class="headerlink" title="git rm â€“cacheåæ‚”è¯"></a>git rm â€“cacheåæ‚”è¯</h3><blockquote><p>åœºæ™¯ï¼šå‡è®¾æˆ‘ä»¬æ‰‹å¿«äº†ï¼Œå°†ä¸€äº›æ–‡ä»¶æ·»åŠ åˆ°äº†æœ¬åœ°ç‰ˆæœ¬åº“é‡Œé¢ï¼Œç°åœ¨æƒ³åˆ é™¤å®ƒï¼Œä½†æ˜¯åˆä¸å¸Œæœ›æœ¬åœ°çš„æ–‡ä»¶ä¸¢å¤±ã€‚</p></blockquote><p><strong>ä½œç”¨ï¼š</strong> <strong>ä»ç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶ã€‚ä½†æ˜¯æœ¬åœ°æ–‡ä»¶è¿˜å­˜åœ¨</strong>ï¼Œ åªæ˜¯ä¸å¸Œæœ›è¿™ä¸ªæ–‡ä»¶è¢«ç‰ˆæœ¬æ§åˆ¶</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326105155871.png" alt="image-20230326105155871" style="zoom:80%;"><h2 id="git-mvä¿®æ”¹æ–‡ä»¶å"><a href="#git-mvä¿®æ”¹æ–‡ä»¶å" class="headerlink" title="git mvä¿®æ”¹æ–‡ä»¶å"></a>git mvä¿®æ”¹æ–‡ä»¶å</h2><blockquote><p>åœºæ™¯ï¼šå‘ç°ç‰ˆæœ¬åº“é‡Œé¢çš„æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦å°†ç‰ˆæœ¬åº“é‡Œé¢çš„binder.cæ”¹æˆbind.c</p></blockquote><p><strong>ä½œç”¨ï¼š</strong></p><ul><li><p>git mv å‘½ä»¤ç”¨äºç§»åŠ¨æˆ–é‡å‘½åä¸€ä¸ªæ–‡ä»¶ã€ç›®å½•æˆ–è½¯è¿æ¥ã€‚</p></li><li><p>å®ƒä¼šå°†å†…å®¹ä»å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­é‡å‘½åï¼Œæ‰‹åŠ¨é‡å‘½åéœ€è¦æ‰§è¡Œä¸¤æ­¥æ“ä½œï¼Œgit mv ä¸€æ­¥å³å¯</p></li></ul><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326110457377.png" alt="image-20230326110457377" style="zoom:80%;"><p>å¦‚æœä¸é‡‡å–git mvï¼Œéœ€è¦ä¸¤æ­¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv led_t286.c led_q385.c<br>git add led_t286.c led_t286<br></code></pre></td></tr></table></figure><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326111013402.png" alt="image-20230326111013402" style="zoom:80%;"><h2 id="git-logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯"><a href="#git-logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯" class="headerlink" title="git logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯"></a>git logæŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯</h2><p><strong>ä½œç”¨ï¼š</strong>æŸ¥çœ‹ç‰ˆæœ¬å˜åŠ¨ä¿¡æ¯</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112521485.png" alt="image-20230326112521485" style="zoom:80%;"><p>å¦‚æœæƒ³çœ‹æŸ¥çœ‹æ›´åŠ è¯¦ç»†ä¸€ç‚¹çš„ä¿¡æ¯å¯ä»¥ä½¿ç”¨<code>git log -p</code></p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112631990.png" alt="image-20230326112631990" style="zoom:80%;"><p>å¦‚æœæƒ³è¦æ—¥å¿—ä»¥æŸç§æ ¼å¼è¾“å‡ºå¯ä»¥ä½¿ç”¨<code>git log --pretty=format</code></p><blockquote><p>è¯¦ç»†å¯å‚è€ƒï¼š<a href="https://blog.csdn.net/u011106915/article/details/105836289/">https://blog.csdn.net/u011106915/article/details/105836289/</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git log --pretty=format:&quot;SHA-1:%h - åˆ›å»ºäºº:%an æ—¶é—´:%ad æäº¤ä¿¡æ¯:%s&quot; --date=format:&quot;%y-%m-%d %H:%M:%S&quot; --shortstat --since=2.weeks &gt; log.txt<br></code></pre></td></tr></table></figure><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326112833997.png" alt="image-20230326112833997" style="zoom:67%;"><h2 id="git-amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤"><a href="#git-amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤" class="headerlink" title="git amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤"></a>git amendä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤</h2><blockquote><p>åœºæ™¯ï¼šå‡å¦‚åˆšåˆšæœ‰ä¸€ç¬”æäº¤ï¼Œéœ€è¦é‡æ–°ä¿®æ”¹åæäº¤ï¼Œä½†æ˜¯æˆ‘ä»¬åˆä¸æƒ³ç”Ÿæˆæ–°çš„commitIdé‡æ–°æäº¤</p></blockquote><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326113641189.png" alt="image-20230326113641189" style="zoom:80%;"><h2 id="gitå‘½ä»¤åˆ›å»ºåˆ«å"><a href="#gitå‘½ä»¤åˆ›å»ºåˆ«å" class="headerlink" title="gitå‘½ä»¤åˆ›å»ºåˆ«å"></a>gitå‘½ä»¤åˆ›å»ºåˆ«å</h2><p>Linuxï¼šåœ¨homeç›®å½•ä¸‹ï¼Œç¼–è¾‘<code>.gitconfig</code>æ–‡ä»¶</p><p>WIndowï¼šåœ¨ <code>$HOME</code> ç›®å½•ä¸‹ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ <code>C:\Users\$USER</code> ï¼‰çš„ <code>.gitconfig</code> æ–‡ä»¶</p><p>æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326210601688.png" alt="image-20230326210601688" style="zoom:80%;"><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç®€çŸ­çš„å‘½ä»¤è¡¨ç¤ºä»¥å‰ç¹ççš„å‘½ä»¤</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230326210430079.png" alt="image-20230326210430079" style="zoom: 80%;"><p>å¦‚æœæˆ‘ä»¬æƒ³æ›´ç®€çŸ­ä¸€ç‚¹ï¼Œåœ¨Linuxä¸‹ï¼Œç¼–è¾‘<code>~/.bashrc</code>ã€Windowç¼–è¾‘<code>C:\Users\$USER\.bash_profile</code>ã€‘ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">alias gs=&#x27;git status&#x27;<br>alias gss=&#x27;git status |grep modified&#x27;<br>alias gd=&#x27;git diff &#x27;<br>alias gds=&#x27;git diff --staged&#x27;<br>alias gsh=&#x27;git show &#x27;<br>alias ga=&#x27;git add .&#x27;<br>alias gcm=&#x27;git commit .&#x27;<br>alias gc=&#x27;git checkout -- &#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">alias</span> gl=<span class="hljs-string">&#x27;git log --pretty=oneline  --abbrev-commit&#x27;</span></span><br>alias gl=&#x27;git lg&#x27;<br>alias glh=&#x27;git lg --graph&#x27;<br>alias gls=&#x27;git lg --author=panfei&#x27;<br>alias gb=&#x27;git branch -v&#x27;<br></code></pre></td></tr></table></figure><p>å°±å¯ä»¥ä½¿ç”¨<code>gs</code>è¡¨ç¤º<code>git status</code>â€¦</p><h2 id="git-cherry-pick"><a href="#git-cherry-pick" class="headerlink" title="git cherry-pick"></a>git cherry-pick</h2><blockquote><p>ğŸŒ <strong>å‚è€ƒ</strong>ï¼š<a href="https://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html">é˜®ä¸€å³°åšå®¢</a></p></blockquote><p>å¯¹äºå¤šåˆ†æ”¯çš„ä»£ç åº“ï¼Œå°†ä»£ç ä»ä¸€ä¸ªåˆ†æ”¯è½¬ç§»åˆ°å¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å¸¸è§éœ€æ±‚ã€‚</p><p>è¿™æ—¶åˆ†ä¸¤ç§æƒ…å†µã€‚ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ éœ€è¦å¦ä¸€ä¸ªåˆ†æ”¯çš„æ‰€æœ‰ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨åˆå¹¶ï¼ˆ<code>git merge</code>ï¼‰ã€‚å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œä½ åªéœ€è¦éƒ¨åˆ†ä»£ç å˜åŠ¨ï¼ˆæŸå‡ ä¸ªæäº¤ï¼‰ï¼Œè¿™æ—¶å¯ä»¥é‡‡ç”¨ Cherry pickã€‚</p><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p><code>git cherry-pick</code>å‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°†æŒ‡å®šçš„æäº¤ï¼ˆcommitï¼‰åº”ç”¨äºå…¶ä»–åˆ†æ”¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤å°±ä¼šå°†æŒ‡å®šçš„æäº¤<code>commitHash</code>ï¼Œåº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æäº¤ï¼Œå½“ç„¶å®ƒä»¬çš„å“ˆå¸Œå€¼ä¼šä¸ä¸€æ ·ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œä»£ç ä»“åº“æœ‰<code>master</code>å’Œ<code>feature</code>ä¸¤ä¸ªåˆ†æ”¯ã€‚</p><blockquote><p>a - b - c - d   Master<br>     <br>       e - f - g Feature</p></blockquote><p>ç°åœ¨å°†æäº¤<code>f</code>åº”ç”¨åˆ°<code>master</code>åˆ†æ”¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ‡æ¢åˆ° master åˆ†æ”¯</span><br>$ git checkout master<br><br><span class="hljs-comment"># Cherry pick æ“ä½œ</span><br>$ git cherry-pick f<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ“ä½œå®Œæˆä»¥åï¼Œä»£ç åº“å°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">a - b - c - d - f   Master<br>     \<br>       e - f - g Feature<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œ<code>master</code>åˆ†æ”¯çš„æœ«å°¾å¢åŠ äº†ä¸€ä¸ªæäº¤<code>f</code>ã€‚</p><p><code>git cherry-pick</code>å‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">$ git cherry-pick feature<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¡¨ç¤ºå°†<code>feature</code>åˆ†æ”¯çš„æœ€è¿‘ä¸€æ¬¡æäº¤ï¼Œè½¬ç§»åˆ°å½“å‰åˆ†æ”¯ã€‚</p><h3 id="è½¬ç§»å¤šä¸ªæäº¤"><a href="#è½¬ç§»å¤šä¸ªæäº¤" class="headerlink" title="è½¬ç§»å¤šä¸ªæäº¤"></a>è½¬ç§»å¤šä¸ªæäº¤</h3><p>Cherry pick æ”¯æŒä¸€æ¬¡è½¬ç§»å¤šä¸ªæäº¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;HashA&gt; &lt;HashB&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤å°† A å’Œ B ä¸¤ä¸ªæäº¤åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯ç”Ÿæˆä¸¤ä¸ªå¯¹åº”çš„æ–°æäº¤ã€‚</p><p>å¦‚æœæƒ³è¦è½¬ç§»ä¸€ç³»åˆ—çš„è¿ç»­æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç®€ä¾¿è¯­æ³•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick A..B <br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤å¯ä»¥è½¬ç§»ä» A åˆ° B çš„æ‰€æœ‰æäº¤ã€‚å®ƒä»¬å¿…é¡»æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ”¾ç½®ï¼šæäº¤ A å¿…é¡»æ—©äºæäº¤ Bï¼Œå¦åˆ™å‘½ä»¤å°†å¤±è´¥ï¼Œä½†ä¸ä¼šæŠ¥é”™ã€‚</p><p>æ³¨æ„ï¼Œä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæäº¤ A å°†ä¸ä¼šåŒ…å«åœ¨ Cherry pick ä¸­ã€‚å¦‚æœè¦åŒ…å«æäº¤ Aï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick A^..B <br></code></pre></td></tr></table></figure><h3 id="é…ç½®é¡¹"><a href="#é…ç½®é¡¹" class="headerlink" title="é…ç½®é¡¹"></a>é…ç½®é¡¹</h3><p><code>git cherry-pick</code>å‘½ä»¤çš„å¸¸ç”¨é…ç½®é¡¹å¦‚ä¸‹ã€‚</p><p><strong>ï¼ˆ1ï¼‰<code>-e</code>ï¼Œ<code>--edit</code></strong></p><p>æ‰“å¼€å¤–éƒ¨ç¼–è¾‘å™¨ï¼Œç¼–è¾‘æäº¤ä¿¡æ¯ã€‚</p><p><strong>ï¼ˆ2ï¼‰<code>-n</code>ï¼Œ<code>--no-commit</code></strong></p><p>åªæ›´æ–°å·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼Œä¸äº§ç”Ÿæ–°çš„æäº¤ã€‚</p><p><strong>ï¼ˆ3ï¼‰<code>-x</code></strong></p><p>åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œ<code>(cherry picked from commit ...)</code>ï¼Œæ–¹ä¾¿ä»¥åæŸ¥åˆ°è¿™ä¸ªæäº¤æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p><p><strong>ï¼ˆ4ï¼‰<code>-s</code>ï¼Œ<code>--signoff</code></strong></p><p>åœ¨æäº¤ä¿¡æ¯çš„æœ«å°¾è¿½åŠ ä¸€è¡Œæ“ä½œè€…çš„ç­¾åï¼Œè¡¨ç¤ºæ˜¯è°è¿›è¡Œäº†è¿™ä¸ªæ“ä½œã€‚</p><p><strong>ï¼ˆ5ï¼‰<code>-m parent-number</code>ï¼Œ<code>--mainline parent-number</code></strong></p><p>å¦‚æœåŸå§‹æäº¤æ˜¯ä¸€ä¸ªåˆå¹¶èŠ‚ç‚¹ï¼Œæ¥è‡ªäºä¸¤ä¸ªåˆ†æ”¯çš„åˆå¹¶ï¼Œé‚£ä¹ˆ Cherry pick é»˜è®¤å°†å¤±è´¥ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“åº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„ä»£ç å˜åŠ¨ã€‚</p><p><code>-m</code>é…ç½®é¡¹å‘Šè¯‰ Gitï¼Œåº”è¯¥é‡‡ç”¨å“ªä¸ªåˆ†æ”¯çš„å˜åŠ¨ã€‚å®ƒçš„å‚æ•°<code>parent-number</code>æ˜¯ä¸€ä¸ªä»<code>1</code>å¼€å§‹çš„æ•´æ•°ï¼Œä»£è¡¨åŸå§‹æäº¤çš„çˆ¶åˆ†æ”¯ç¼–å·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick -m 1 &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤è¡¨ç¤ºï¼ŒCherry pick é‡‡ç”¨æäº¤<code>commitHash</code>æ¥è‡ªç¼–å·1çš„çˆ¶åˆ†æ”¯çš„å˜åŠ¨ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œ1å·çˆ¶åˆ†æ”¯æ˜¯æ¥å—å˜åŠ¨çš„åˆ†æ”¯ï¼ˆthe branch being merged intoï¼‰ï¼Œ2å·çˆ¶åˆ†æ”¯æ˜¯ä½œä¸ºå˜åŠ¨æ¥æºçš„åˆ†æ”¯ï¼ˆthe branch being merged fromï¼‰ã€‚</p><h3 id="ä»£ç å†²çª"><a href="#ä»£ç å†²çª" class="headerlink" title="ä»£ç å†²çª"></a>ä»£ç å†²çª</h3><p>å¦‚æœæ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿä»£ç å†²çªï¼ŒCherry pick ä¼šåœä¸‹æ¥ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•ç»§ç»­æ“ä½œã€‚</p><p><strong>ï¼ˆ1ï¼‰<code>--continue</code></strong></p><p>ç”¨æˆ·è§£å†³ä»£ç å†²çªåï¼Œç¬¬ä¸€æ­¥å°†ä¿®æ”¹çš„æ–‡ä»¶é‡æ–°åŠ å…¥æš‚å­˜åŒºï¼ˆ<code>git add .</code>ï¼‰ï¼Œç¬¬äºŒæ­¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œè®© Cherry pick è¿‡ç¨‹ç»§ç»­æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick --<span class="hljs-built_in">continue</span><br></code></pre></td></tr></table></figure><p><strong>ï¼ˆ2ï¼‰<code>--abort</code></strong></p><p>å‘ç”Ÿä»£ç å†²çªåï¼Œæ”¾å¼ƒåˆå¹¶ï¼Œå›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚</p><p><strong>ï¼ˆ3ï¼‰<code>--quit</code></strong></p><p>å‘ç”Ÿä»£ç å†²çªåï¼Œé€€å‡º Cherry pickï¼Œä½†æ˜¯ä¸å›åˆ°æ“ä½œå‰çš„æ ·å­ã€‚</p><h3 id="è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“"><a href="#è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“" class="headerlink" title="è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“"></a>è½¬ç§»åˆ°å¦ä¸€ä¸ªä»£ç åº“</h3><p>Cherry pick ä¹Ÿæ”¯æŒè½¬ç§»å¦ä¸€ä¸ªä»£ç åº“çš„æäº¤ï¼Œæ–¹æ³•æ˜¯å…ˆå°†è¯¥åº“åŠ ä¸ºè¿œç¨‹ä»“åº“ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git remote add target git://gitUrl<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤æ·»åŠ äº†ä¸€ä¸ªè¿œç¨‹ä»“åº“<code>target</code>ã€‚</p><p>ç„¶åï¼Œå°†è¿œç¨‹ä»£ç æŠ“å–åˆ°æœ¬åœ°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">$ git fetch target<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤å°†è¿œç¨‹ä»£ç ä»“åº“æŠ“å–åˆ°æœ¬åœ°ã€‚</p><p>æ¥ç€ï¼Œæ£€æŸ¥ä¸€ä¸‹è¦ä»è¿œç¨‹ä»“åº“è½¬ç§»çš„æäº¤ï¼Œè·å–å®ƒçš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">log</span> target/master<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œä½¿ç”¨<code>git cherry-pick</code>å‘½ä»¤è½¬ç§»æäº¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git cherry-pick &lt;commitHash&gt;<br></code></pre></td></tr></table></figure><h2 id="Git-ä¸­-HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«"><a href="#Git-ä¸­-HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="Git ä¸­ HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«"></a>Git ä¸­ HEADã€å·¥ä½œæ ‘å’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«</h2><blockquote><p>å‚è€ƒï¼š<a href="http://fanyouf.gitee.io/interview/git/02.html#%E7%AE%80%E7%89%88">http://fanyouf.gitee.io/interview/git/02.html#%E7%AE%80%E7%89%88</a></p></blockquote><h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h3><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2de056a0-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>åœ¨<code>git</code>ä¸­ï¼Œå¯ä»¥å­˜åœ¨å¾ˆå¤šåˆ†æ”¯ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘<code>commit</code>å¯¹è±¡çš„å¯å˜æŒ‡é’ˆï¼Œè€Œ<code>Head</code>æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘ä½ æ­£åœ¨å·¥ä½œä¸­çš„æœ¬åœ°åˆ†æ”¯çš„æŒ‡é’ˆ</p><p>ç®€å•æ¥è®²ï¼Œå°±æ˜¯ä½ ç°åœ¨åœ¨å“ªå„¿ï¼ŒHEAD å°±æŒ‡å‘å“ªå„¿</p><p>ä¾‹å¦‚å½“å‰æˆ‘ä»¬å¤„äº<code>master</code>åˆ†æ”¯ï¼Œæ‰€ä»¥<code>HEAD</code>è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘äº†<code>master</code>åˆ†æ”¯æŒ‡é’ˆ</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/36cb0da0-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>ç„¶åé€šè¿‡è°ƒç”¨<code>git checkout test</code>åˆ‡æ¢åˆ°<code>test</code>åˆ†æ”¯ï¼Œé‚£ä¹ˆ<code>HEAD</code>åˆ™æŒ‡å‘<code>test</code>åˆ†æ”¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3e86ba80-fa40-11eb-991d-334fd31f0201.png" alt="img" style="zoom:80%;"><p>ä½†æˆ‘ä»¬åœ¨<code>test</code>åˆ†æ”¯å†ä¸€æ¬¡<code>commit</code>ä¿¡æ¯çš„æ—¶å€™ï¼Œ<code>HEAD</code>æŒ‡é’ˆä»ç„¶æŒ‡å‘äº†<code>test</code>åˆ†æ”¯æŒ‡é’ˆï¼Œè€Œ<code>test</code>åˆ†æ”¯æŒ‡é’ˆå·²ç»æŒ‡å‘äº†æœ€æ–°åˆ›å»ºçš„æäº¤ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/23/git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/439839b0-fa66-11eb-991d-334fd31f0201.png" alt="img" style="zoom: 50%;"><p>è¿™ä¸ª<code>HEAD</code>å­˜å‚¨çš„ä½ç½®å°±åœ¨<code>.git/HEAD</code>ç›®å½•ä¸­ï¼ŒæŸ¥çœ‹ä¿¡æ¯å¯ä»¥çœ‹åˆ°<code>HEAD</code>æŒ‡å‘äº†å¦ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> .git/HEAD</span><br>ref: refs/heads/master<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> .git/refs/heads/master</span><br>7406a10efcc169bbab17827aeda189aa20376f7f<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹æ˜¯ä¸€ä¸²å“ˆå¸Œç ï¼Œè€Œè¿™ä¸ªå“ˆå¸Œç æ­£æ˜¯<code>master</code>åˆ†æ”¯ä¸Šæœ€æ–°çš„æäº¤æ‰€å¯¹åº”çš„å“ˆå¸Œç </p><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åˆ‡æ¢åˆ†æ”¯çš„æ—¶å€™ï¼Œ<code>HEAD</code>æŒ‡é’ˆé€šå¸¸æŒ‡å‘æˆ‘ä»¬æ‰€åœ¨çš„åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸ªåˆ†æ”¯ä¸Šåˆ›å»ºæ–°çš„æäº¤æ—¶ï¼Œåˆ†æ”¯æŒ‡é’ˆæ€»æ˜¯ä¼šæŒ‡å‘å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤</p><p>æ‰€ä»¥ï¼ŒHEAD æŒ‡é’ˆ â€”â€”â€“&gt; åˆ†æ”¯æŒ‡é’ˆ â€”â€”â€“&gt; æœ€æ–°æäº¤</p><h3 id="å·¥ä½œæ ‘å’Œç´¢å¼•"><a href="#å·¥ä½œæ ‘å’Œç´¢å¼•" class="headerlink" title="å·¥ä½œæ ‘å’Œç´¢å¼•"></a>å·¥ä½œæ ‘å’Œç´¢å¼•</h3><p>åœ¨<code>Git</code>ç®¡ç†ä¸‹ï¼Œå¤§å®¶å®é™…æ“ä½œçš„ç›®å½•è¢«ç§°ä¸º<strong>å·¥ä½œæ ‘</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å·¥ä½œåŒºåŸŸ</strong></p><p>åœ¨æ•°æ®åº“å’Œå·¥ä½œæ ‘ä¹‹é—´æœ‰ç´¢å¼•ï¼Œç´¢å¼•æ˜¯ä¸ºäº†å‘æ•°æ®åº“æäº¤ä½œå‡†å¤‡çš„åŒºåŸŸï¼Œä¹Ÿè¢«ç§°ä¸ºæš‚å­˜åŒºåŸŸ</p><p><code>Git</code>åœ¨æ‰§è¡Œæäº¤çš„æ—¶å€™ï¼Œä¸æ˜¯ç›´æ¥å°†å·¥ä½œæ ‘çš„çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè€Œæ˜¯å°†è®¾ç½®åœ¨ä¸­é—´ç´¢å¼•åŒºåŸŸçš„çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“</p><p>å› æ­¤ï¼Œè¦æäº¤æ–‡ä»¶ï¼Œé¦–å…ˆéœ€è¦æŠŠæ–‡ä»¶åŠ å…¥åˆ°ç´¢å¼•åŒºåŸŸä¸­ã€‚</p><p>æ‰€ä»¥ï¼Œå‡­å€Ÿä¸­é—´çš„ç´¢å¼•ï¼Œå¯ä»¥é¿å…å·¥ä½œæ ‘ä¸­ä¸å¿…è¦çš„æ–‡ä»¶æäº¤ï¼Œè¿˜å¯ä»¥å°†æ–‡ä»¶ä¿®æ”¹å†…å®¹çš„ä¸€éƒ¨åˆ†åŠ å…¥ç´¢å¼•åŒºåŸŸå¹¶æäº¤</p><blockquote><p>å·¥ä½œæ ‘å°±æ˜¯å·¥ä½œåŒºï¼Œç´¢å¼•å°±æ˜¯æš‚å­˜åŒºï¼Œæ•°æ®åº“å°±æ˜¯æœ¬åœ°ä»“åº“</p></blockquote><h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p>ä»æ‰€åœ¨çš„ä½ç½®æ¥çœ‹ï¼š</p><ul><li>HEAD æŒ‡é’ˆé€šå¸¸æŒ‡å‘æˆ‘ä»¬æ‰€åœ¨çš„åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨æŸä¸ªåˆ†æ”¯ä¸Šåˆ›å»ºæ–°çš„æäº¤æ—¶ï¼Œåˆ†æ”¯æŒ‡é’ˆæ€»æ˜¯ä¼šæŒ‡å‘å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤</li><li>å·¥ä½œæ ‘æ˜¯æŸ¥çœ‹å’Œç¼–è¾‘çš„ï¼ˆæºï¼‰æ–‡ä»¶çš„å®é™…å†…å®¹</li><li>ç´¢å¼•æ˜¯æ”¾ç½®ä½ æƒ³è¦æäº¤ç»™ git ä»“åº“æ–‡ä»¶çš„åœ°æ–¹ï¼Œå¦‚å·¥ä½œæ ‘çš„ä»£ç é€šè¿‡ git add åˆ™æ·»åŠ åˆ° git ç´¢å¼•ä¸­ï¼Œé€šè¿‡ git commit åˆ™å°†ç´¢å¼•åŒºåŸŸçš„æ–‡ä»¶æäº¤åˆ° git ä»“åº“ä¸­</li></ul><h2 id="å¦‚ä½•ç†è§£git-checkout-â€“-fileå’Œgit-reset-HEAD-â€“-file"><a href="#å¦‚ä½•ç†è§£git-checkout-â€“-fileå’Œgit-reset-HEAD-â€“-file" class="headerlink" title="å¦‚ä½•ç†è§£git checkout â€“ fileå’Œgit reset HEAD â€“ file"></a>å¦‚ä½•ç†è§£git checkout â€“ fileå’Œgit reset HEAD â€“ file</h2><blockquote><p>å‚è€ƒï¼š<a href="https://www.liaoxuefeng.com/wiki/896043488029600/897889638509536">https://www.liaoxuefeng.com/wiki/896043488029600/897889638509536</a></p></blockquote><p>git checkout â€“ fileï¼šæ’¤é”€å¯¹å·¥ä½œåŒºä¿®æ”¹ï¼›è¿™ä¸ªå‘½ä»¤æ˜¯ä»¥æœ€æ–°çš„å­˜å‚¨æ—¶é—´èŠ‚ç‚¹ï¼ˆaddå’Œcommitï¼‰ä¸ºå‚ç…§ï¼Œè¦†ç›–å·¥ä½œåŒºå¯¹åº”æ–‡ä»¶fileï¼›è¿™ä¸ªå‘½ä»¤æ”¹å˜çš„æ˜¯<strong>å·¥ä½œåŒº</strong>ã€ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦æ’¤å›å·¥ä½œåŒºçš„å†…å®¹åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œ<strong>ä½†æ˜¯è¿˜æ²¡æœ‰</strong>git addæ·»åŠ åˆ°æš‚å­˜åŒºã€‘</p><p>git reset HEAD â€“ fileï¼šæ¸…ç©ºaddå‘½ä»¤å‘æš‚å­˜åŒºæäº¤çš„å…³äºfileæ–‡ä»¶çš„ä¿®æ”¹ï¼ˆUstageï¼‰ï¼›è¿™ä¸ªå‘½ä»¤ä»…æ”¹å˜<strong>æš‚å­˜åŒº</strong>ï¼Œå¹¶ä¸æ”¹å˜å·¥ä½œåŒºï¼Œè¿™æ„å‘³ç€åœ¨æ— ä»»ä½•å…¶ä»–æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå·¥ä½œåŒºä¸­çš„å®é™…æ–‡ä»¶åŒè¯¥å‘½ä»¤è¿è¡Œä¹‹å‰æ— ä»»ä½•æ”¹å˜ã€ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦æ’¤å›å·¥ä½œåŒºçš„å†…å®¹åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œ<strong>ä½†æ˜¯å·²ç»</strong>git addæ·»åŠ åˆ°æš‚å­˜åŒºã€‘</p><p>ğŸ­ <strong>æ€»ç»“ï¼š</strong></p><blockquote><p>åœºæ™¯1ï¼šå½“ä½ æ”¹ä¹±äº†å·¥ä½œåŒºæŸä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæƒ³ç›´æ¥ä¸¢å¼ƒå·¥ä½œåŒºçš„ä¿®æ”¹æ—¶ï¼Œç”¨å‘½ä»¤<code>git checkout -- file</code>ã€‚</p><p>åœºæ™¯2ï¼šå½“ä½ ä¸ä½†æ”¹ä¹±äº†å·¥ä½œåŒºæŸä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œè¿˜æ·»åŠ åˆ°äº†æš‚å­˜åŒºæ—¶ï¼Œæƒ³ä¸¢å¼ƒä¿®æ”¹ï¼Œåˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ç”¨å‘½ä»¤<code>git reset HEAD &lt;file&gt;</code>ï¼Œå°±å›åˆ°äº†åœºæ™¯1ï¼Œç¬¬äºŒæ­¥æŒ‰åœºæ™¯1æ“ä½œã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Gitå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxå†…æ ¸ç¼–è¯‘</title>
    <link href="/2023/03/22/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/"/>
    <url>/2023/03/22/Linux%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸ç¼–è¯‘"><a href="#Linuxå†…æ ¸ç¼–è¯‘" class="headerlink" title="Linuxå†…æ ¸ç¼–è¯‘"></a>Linuxå†…æ ¸ç¼–è¯‘</h1><h2 id="1-linuxå†…æ ¸ä¸­Makefileã€Kconfigã€-configçš„å…³ç³»"><a href="#1-linuxå†…æ ¸ä¸­Makefileã€Kconfigã€-configçš„å…³ç³»" class="headerlink" title="1.linuxå†…æ ¸ä¸­Makefileã€Kconfigã€.configçš„å…³ç³»"></a>1.linuxå†…æ ¸ä¸­Makefileã€Kconfigã€.configçš„å…³ç³»</h2><p><strong>ä¸‰è€…çš„ä½œç”¨ï¼š</strong></p><ul><li>Makefileï¼šä¸€ä¸ªæ–‡æœ¬å½¢å¼çš„æ–‡ä»¶ï¼Œç¼–è¯‘æºæ–‡ä»¶çš„æ–¹æ³•ã€‚</li><li>Kconfigï¼šä¸€ä¸ªæ–‡æœ¬å½¢å¼çš„æ–‡ä»¶ï¼Œå†…æ ¸çš„é…ç½®èœå•ã€‚</li><li>.configï¼šç¼–è¯‘æ‰€ä¾æ®çš„é…ç½®</li></ul><p><strong>ä¸‰è€…çš„å…³ç³»ï¼š</strong></p><p>ç®€å•æ¥è¯´å°±æ˜¯å»é¥­åº—ç‚¹èœï¼šKconfigæ˜¯èœå•ï¼ŒMakefileæ˜¯åšæ³•ï¼Œ.configå°±æ˜¯ä½ ç‚¹çš„èœã€‚åœ¨è¿è¡Œmake menuconfigååœ¨é…ç½®ç•Œé¢ä¸­å‡ºç°çš„å°±æ˜¯Kconfigä¸­çš„é€‰é¡¹ï¼Œåœ¨ç•Œé¢ä¸­çœ‹åˆ°çš„å·²ç»é…ç½®å¥½çš„é€‰é¡¹å°±æ˜¯ä».configä¸­è¯»å–å‡ºæ¥çš„ï¼Œå½“é…ç½®å®Œæˆåå°±ä¼šå°†é…ç½®é‡æ–°ä¿å­˜åˆ°.configä¸­ï¼Œç¼–è¯‘æ—¶makefileä¼šè¯»å–.configä¸­é…ç½®æ¥å¯¹å†…æ ¸è¿›è¡Œç¼–è¯‘ã€‚</p><blockquote><ol><li>å¦‚æœ.configä¸å­˜åœ¨ï¼Œè¿è¡Œmake config&#x2F;menuconfigæ—¶çš„ç¼ºçœè®¾ç½®ç”±å›ºåŒ–åœ¨å„ä¸ªKconfigæ–‡ä»¶ä¸­å„é¡¹ç›®çš„ç¼ºçœå€¼å†³å®šã€‚</li><li>å¦‚æœ.configå­˜åœ¨ï¼Œè¿è¡Œmake config&#x2F;menuconfigæ—¶çš„ç¼ºçœè®¾ç½®å³æ˜¯å½“å‰.configçš„è®¾ç½®ï¼Œè‹¥å¯¹è®¾ç½®è¿›è¡Œäº†ä¿®æ”¹ï¼Œ<code>.config</code>å°†è¢«æ›´æ–°ã€‚</li><li>arch&#x2F;arm&#x2F;defconfigæ˜¯ä¸€ä¸ªç¼ºçœçš„é…ç½®æ–‡ä»¶ï¼Œmake defconfigæ—¶ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶ç”Ÿæˆå½“å‰çš„.configã€‚</li><li>arch&#x2F;arm&#x2F;configsæ–‡ä»¶å¤¹ä¸­æœ‰è®¸å¤šå‘½åä¸ºxxx_defconfigçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœè¿è¡Œmake xxx_defconfigï¼Œå½“å‰.configæ–‡ä»¶ä¼šç”±xxx_defconfigæ–‡ä»¶ç”Ÿæˆã€‚</li></ol></blockquote><p>ğŸ¼ <strong>æ€»ç»“ä¸€ä¸‹</strong></p><p>æ‰§è¡Œ<code>make xxx_defconfig</code>ç”Ÿæˆ.configæ–‡ä»¶</p><p>æ‰§è¡Œ<code>make menuconfig</code>å¯ä»¥ä¿®æ”¹.configæ–‡ä»¶ã€‚</p><h2 id="2-æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«"><a href="#2-æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«" class="headerlink" title="2.æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«"></a>2.æ¨¡å—ç¼–è¯‘æ—¶obj-yå’Œobj-mçš„åŒºåˆ«</h2><p>åœ¨è¿›è¡Œæ¨¡å—ç¼–è¯‘æ—¶ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œobj-må’Œobj-yï¼Œè€Œä¸å†…æ ¸å¯†åˆ‡ç›¸å…³çš„æ˜¯obj-yé€‰é¡¹ï¼Œä¸‹é¢å¯¹ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚</p><p>ä»¥test.cæ–‡ä»¶ä¸ºä¾‹ï¼š</p><p>obj-m +&#x3D; test.o</p><p>obj-y  +&#x3D; test.o</p><p>å…¶ä¸­:</p><ul><li><p>obj-mè¡¨ç¤ºæŠŠæ–‡ä»¶test.oä½œä¸ºâ€æ¨¡å—â€è¿›è¡Œç¼–è¯‘ï¼Œä¸ä¼šç¼–è¯‘åˆ°å†…æ ¸ï¼Œä½†æ˜¯ä¼šç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ â€œtest.koâ€ æ–‡ä»¶ã€‚</p></li><li><p>obj-yè¡¨ç¤ºæŠŠtest.oæ–‡ä»¶ç¼–è¯‘è¿›å†…æ ¸</p></li></ul><h2 id="3-Kernelä¸­Makefileçš„è¯­æ³•"><a href="#3-Kernelä¸­Makefileçš„è¯­æ³•" class="headerlink" title="3.Kernelä¸­Makefileçš„è¯­æ³•"></a>3.Kernelä¸­Makefileçš„è¯­æ³•</h2><p>1ï¼‰ç›´æ¥ç¼–è¯‘</p><p>obj-y &#x3D; led.o</p><p>2ï¼‰æ¡ä»¶ç¼–è¯‘</p><p>obj-$(CONFIG_RAPIDIO) +&#x3D; rapidio.o</p><p>3ï¼‰ç¼–è¯‘ç›®å½•ï¼š</p><p>obj-$(CONFIG_ISCSI_TARGET)  +&#x3D; iscsi&#x2F;</p><h2 id="4-Kernelä¸­Kconfigçš„è¯­æ³•"><a href="#4-Kernelä¸­Kconfigçš„è¯­æ³•" class="headerlink" title="4.Kernelä¸­Kconfigçš„è¯­æ³•"></a>4.Kernelä¸­Kconfigçš„è¯­æ³•</h2><blockquote><p> å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/crXt-6EvKtWg9QX7SM90Sw">https://mp.weixin.qq.com/s/crXt-6EvKtWg9QX7SM90Sw</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android Såˆ›å»ºé€»è¾‘åˆ†åŒº</title>
    <link href="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/"/>
    <url>/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-Såˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#Android-Såˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="Android Såˆ›å»ºé€»è¾‘åˆ†åŒº"></a>Android Såˆ›å»ºé€»è¾‘åˆ†åŒº</h1><p>ä»å®‰å“æ¨¡æ‹Ÿå™¨çœ‹æ¥ï¼Œsuperè®¾å¤‡å¯¹åº”çš„çœŸå®å—è®¾å¤‡ä¸º<code>/dev/block/vda2</code></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230318233940020.png" alt="image-20230318233940020" style="zoom:80%;"><p>ä»çœŸå®æ¨¡æ‹Ÿå™¨è¿è¡Œç¯å¢ƒæ¥çœ‹ï¼Œsuperæ€»å…±åˆ†ä¸ºäº†å››ä¸ªåˆ†åŒºsystemã€vendorã€productã€system_extã€å…¶ä¸­<strong>system</strong>åˆ†åŒºç”±äº<strong>system as root</strong>æœºåˆ¶ä½œä¸ºäº†rootfsè¿›è¡ŒæŒ‚è½½ã€‘</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230318234134317.png" alt="image-20230318234134317" style="zoom: 80%;"><p>å¦å¤–ä»ç½‘ä¸Šæ‰¾åˆ°ä¸€ä»½çœŸå®Android Så¯åŠ¨æ—¥å¿—ï¼š</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230322203850415.png" alt="image-20230322203850415" style="zoom:80%;"><p>ğŸ¤–ä»çœŸå®å¯åŠ¨æ—¥å¿—æ¥çœ‹ï¼Œé‚£ä¹ˆ<strong>ä¸ºä»€ä¹ˆè¿™ä¸ªdmè®¾å¤‡æ€ä¹ˆæ¥çš„ï¼Ÿä¸ºä»€ä¹ˆdm-0æ˜¯system_aè€Œä¸æ˜¯vendor_aå‘¢ï¼Ÿ</strong></p><p>æˆ‘ä»¬è¦å¸¦ç€è¿™äº›é—®é¢˜å»æ€è€ƒï¼Œä¸€æ­¥æ­¥é˜…è¯»æºç ï¼Œè§£å†³è‡ªå·±çš„ç–‘æƒ‘â€¦â€¦</p><h2 id="1-æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata"><a href="#1-æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata" class="headerlink" title="1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata"></a>1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadata</h2><blockquote><p>è¿™é‡Œå¼•ç”¨<strong>æ´›å¥‡çœ‹ä¸–ç•Œ</strong>å¤§å“¥ç”»çš„ç²¾ç¾ç¤ºæ„å›¾ï¼š<a href="https://blog.csdn.net/guyongqiangx/article/details/123899602">https://blog.csdn.net/guyongqiangx/article/details/123899602</a></p></blockquote><ul><li>superæ•´ä½“åˆ†åŒºå¸ƒå±€ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</li></ul><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/086bef9593e0494a90d27eef2e071bae.png" alt="image-20230318234134317" style="zoom: 80%;"><ul><li>superåˆ†åŒºä¸­çš„metadataå¦‚ä¸‹ï¼š</li></ul><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/4ff675e237df41ed9c7d4809bed4d758.png" alt="image-20230318234134317" style="zoom: 67%;"><p>metadataå¯¹åº”çš„æ•°æ®ç»“æ„ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\liblp.h</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadata</span> &#123;<br>    LpMetadataGeometry geometry;<br>    LpMetadataHeader header;<br>    std::vector&lt;LpMetadataPartition&gt; partitions;<br>    std::vector&lt;LpMetadataExtent&gt; extents;<br>    std::vector&lt;LpMetadataPartitionGroup&gt; groups;<br>    std::vector&lt;LpMetadataBlockDevice&gt; block_devices;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢é…åˆå…·ä½“ä»superåˆ†åŒºä¸­æŠ“å–çš„æ•°æ®è§£æã€‚</p><p>å‘½ä»¤ï¼š<code>dd if=/dev/block/platform/soc/7824900.sdhci/by-name/super bs=4096 count=1048576 of=/data/super.data</code></p><blockquote><p>ä¸‹é¢å¼•ç”¨ï¼š<a href="https://blog.csdn.net/weixin_43899302/article/details/119343835?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_43899302/article/details/119343835?spm=1001.2014.3001.5506</a></p></blockquote><h3 id="1-1-LpMetadataGeometry"><a href="#1-1-LpMetadataGeometry" class="headerlink" title="1.1 LpMetadataGeometry"></a>1.1 LpMetadataGeometry</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataGeometry</span> &#123;<br>    <span class="hljs-type">uint32_t</span> magic;<br>    <span class="hljs-type">uint32_t</span> struct_size;<br>    <span class="hljs-type">uint8_t</span> checksum[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">uint32_t</span> metadata_max_size;<br>    <span class="hljs-type">uint32_t</span> metadata_slot_count;<br>    <span class="hljs-type">uint32_t</span> logical_block_size;<br>&#125; __attribute__((packed)) LpMetadataGeometry;<br></code></pre></td></tr></table></figure><p>å› ä¸ºmetadata.imgå‰é¢é¢„ç•™äº†4KBï¼ˆ4096Byteï¼‰ï¼Œæ‰€ä»¥åç§»ä½ç½®ä¸º<strong>0x1000h</strong></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/28872ef9b62844a5b49c0caa07658ff6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><blockquote><p>å‰32ä½ï¼ˆ4å­—èŠ‚ï¼‰ä¸ºMetadataGeometryçš„Magicï¼Œåœ¨ä»£ç ä¸­ä¼šè¿›è¡Œæ ¡éªŒé­”æœ¯å­—LP_METADATA_GEOMETRY_MAGIC</p><p>â˜ƒï¸<strong>ä¸€å®šæ³¨æ„ï¼šçœ‹é•œåƒçš„16è¿›åˆ¶éƒ½æ˜¯å°ç«¯æ¨¡å¼</strong></p><p>ä¾æ¬¡ç±»æ¨ï¼Œåé¢0x0000034è¡¨ç¤º32ä½çš„å˜é‡struct_size</p><p>æ‰€ä»¥æœ€ç»ˆè¿™äº›<strong>metadata.img</strong>ä¸­çš„æ•°æ®éƒ½ä¼šä¸€ä¸€æŒ‰ä½è¯»å–åˆ°ç»“æ„ä½“LpMetadataGeometry</p></blockquote><p>åœ¨åˆ›å»ºsuperåˆ†åŒºçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<strong>ParseGeometry</strong>å»è¿›è¡Œè§£æ<strong>LpMetadataGeometry</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LP_METADATA_GEOMETRY_MAGIC 0x616c4467</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ParseGeometry</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* buffer, LpMetadataGeometry* geometry)</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(*geometry) &lt;= LP_METADATA_GEOMETRY_SIZE);<br>    <span class="hljs-built_in">memcpy</span>(geometry, buffer, <span class="hljs-built_in">sizeof</span>(*geometry));<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;magic != LP_METADATA_GEOMETRY_MAGIC) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid geometry magic signature.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;struct_size &gt; <span class="hljs-built_in">sizeof</span>(LpMetadataGeometry)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has unrecognized fields.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    &#123;<br>        LpMetadataGeometry temp = *geometry;<br>        <span class="hljs-built_in">memset</span>(&amp;temp.checksum, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(temp.checksum));<br>        <span class="hljs-built_in">SHA256</span>(&amp;temp, temp.struct_size, temp.checksum);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(temp.checksum, geometry-&gt;checksum, <span class="hljs-built_in">sizeof</span>(temp.checksum)) != <span class="hljs-number">0</span>) &#123;<br>            LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid geometry checksum.&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (geometry-&gt;struct_size != <span class="hljs-built_in">sizeof</span>(LpMetadataGeometry)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid struct size.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (geometry-&gt;metadata_slot_count == <span class="hljs-number">0</span>) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Logical partition metadata has invalid slot count.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (geometry-&gt;metadata_max_size % LP_SECTOR_SIZE != <span class="hljs-number">0</span>) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Metadata max size is not sector-aligned.&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-LpMetadataHeader"><a href="#1-2-LpMetadataHeader" class="headerlink" title="1.2 LpMetadataHeader"></a>1.2 LpMetadataHeader</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\liblp\include\liblp\metadata_format.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataHeader</span> &#123;<br>    <span class="hljs-type">uint32_t</span> magic;<br>    <span class="hljs-type">uint16_t</span> major_version;<br>    <span class="hljs-type">uint16_t</span> minor_version;<br>    <span class="hljs-type">uint32_t</span> header_size;<br>    <span class="hljs-type">uint8_t</span> header_checksum[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">uint32_t</span> tables_size;<br>    <span class="hljs-type">uint8_t</span> tables_checksum[<span class="hljs-number">32</span>];<br>    LpMetadataTableDescriptor partitions;<br>    LpMetadataTableDescriptor extents;<br>    LpMetadataTableDescriptor groups;<br>    LpMetadataTableDescriptor block_devices;<br>&#125; __attribute__((packed)) LpMetadataHeader;<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataTableDescriptor</span> &#123;<br>    <span class="hljs-type">uint32_t</span> offset;<br>    <span class="hljs-type">uint32_t</span> num_entries;<br>    <span class="hljs-type">uint32_t</span> entry_size;<br>&#125; __attribute__((packed)) LpMetadataTableDescriptor;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/fc1dd4f8828e4e279906e52bd4417f7a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h3 id="1-3-LpMetadataPartition"><a href="#1-3-LpMetadataPartition" class="headerlink" title="1.3 LpMetadataPartition"></a>1.3 LpMetadataPartition</h3><p>è¿™ä¸ªå°±æ˜¯è¡¨ç¤ºsuperä¸­çš„ä¸€ä¸ªä¸ªé€»è¾‘åˆ†åŒºæ‰€æœ‰çš„å­—æ®µï¼Œæ¯”å¦‚è¯´nameè¡¨ç¤ºé€»è¾‘åˆ†åŒºåï¼Œattributesè¡¨ç¤ºé€»è¾‘åˆ†åŒºå±æ€§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataPartition</span> &#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">36</span>];                 <span class="hljs-comment">// åˆ†åŒºåå­—</span><br>    <span class="hljs-type">uint32_t</span> attributes;   <span class="hljs-comment">// åˆ†åŒºè¡¨å±æ€§</span><br>    <span class="hljs-type">uint32_t</span> first_extent_index;   <span class="hljs-comment">// åœ¨1.4èŠ‚ä¸­extentsçš„ç¬¬ä¸€ä¸ªå…ƒç´ å€¼ç´¢å¼•ã€ä¸€èˆ¬ä¸€ä¸ªåˆ†åŒºåªä¼šå ç”¨ä¸€ä¸ªextentsæ•°ç»„ä¸­çš„å…ƒç´ ã€‘</span><br>    <span class="hljs-type">uint32_t</span> num_extents;          <span class="hljs-comment">// åœ¨1.4èŠ‚ä¸­extentsæ•°ç»„ä¸­å ç”¨äº†å‡ ä¸ªå…ƒç´ ã€ä¸€èˆ¬åªä¼šå ç”¨ä¸€ä¸ªï¼Œæ‰€ä»¥num_extentsä¸€èˆ¬ä¸º0x01ã€‘</span><br>    <span class="hljs-type">uint32_t</span> group_index;          <span class="hljs-comment">// åœ¨1.5èŠ‚ä¸­çš„åˆ†ç»„ç´¢å¼•</span><br>&#125; __attribute__((packed)) LpMetadataPartition;<br><br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/e3b51aa1d6f94b66a78618b135853e75.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‰é¢çš„36å­—èŠ‚è¡¨ç¤ºçš„é€»è¾‘åˆ†åŒºåï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè¡¨ç¤ºçš„æ˜¯<strong>system</strong></p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230320234029590.png" alt="image-20230320234029590" style="zoom:80%;"><h3 id="1-4-LpMetadataExtent"><a href="#1-4-LpMetadataExtent" class="headerlink" title="1.4 LpMetadataExtent"></a>1.4 LpMetadataExtent</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataExtent</span> &#123;<br>    <span class="hljs-type">uint64_t</span> num_sectors;       <span class="hljs-comment">// å½“å‰åˆ†åŒºå ç”¨æ‰‡åŒºæ•°é‡ï¼Œä¸€ä¸ªæ‰‡åŒºå¤§å°ä¸º512Byte</span><br>    <span class="hljs-type">uint32_t</span> target_type;       <span class="hljs-comment">// æƒ³è¦æ˜ å°„çš„ç±»å‹ï¼Œ0è¡¨ç¤ºçº¿æ€§Linear</span><br>    <span class="hljs-type">uint64_t</span> target_data;       <span class="hljs-comment">// ç›¸å¯¹äºsuperå®é™…åœ°å€çš„åç§»åœ°å€</span><br>    <span class="hljs-type">uint32_t</span> target_source;     <span class="hljs-comment">// åœ¨1.6èŠ‚ä¸­è¡¨ç¤ºå“ªä¸€ä¸ªsourceï¼Œåœ¨å®‰å“æ˜ å°„é€»è¾‘åˆ†åŒºå°±æ˜¯superï¼Œæ‰€ä»¥target_sourceä¸€èˆ¬ä¸º0x0ã€superåœ¨blockdeviceä½ç½®ã€‘</span><br>&#125; __attribute__((packed)) LpMetadataExtent;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/02bdee1d427e444ab4e2d8b2416591fe.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><p>é€šè¿‡<code>lpdump super.img.raw</code>ï¼ˆæœªå‹ç¼©çš„super.imgï¼‰å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼Œ</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230427230005157.png" alt="image-20230427230005157" style="zoom:80%;"><h3 id="1-5-LpMetadataPartitionGroup"><a href="#1-5-LpMetadataPartitionGroup" class="headerlink" title="1.5 LpMetadataPartitionGroup"></a>1.5 LpMetadataPartitionGroup</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataPartitionGroup</span> &#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">36</span>];<br>    <span class="hljs-type">uint32_t</span> flags;<br>    <span class="hljs-type">uint64_t</span> maximum_size;<br>&#125; __attribute__((packed)) LpMetadataPartitionGroup;<br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/0ea2cc17e450475396458ff4843f7a78.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:100%;"><h3 id="1-6-LpMetadataBlockDevice"><a href="#1-6-LpMetadataBlockDevice" class="headerlink" title="1.6 LpMetadataBlockDevice"></a>1.6 LpMetadataBlockDevice</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LpMetadataBlockDevice</span> &#123;<br>    <span class="hljs-type">uint64_t</span> first_logical_sector;<br>    <span class="hljs-type">uint32_t</span> alignment;<br>    <span class="hljs-type">uint32_t</span> alignment_offset;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">char</span> partition_name[<span class="hljs-number">36</span>];<br>    <span class="hljs-type">uint32_t</span> flags;<br>&#125; __attribute__((packed)) LpMetadataBlockDevice;<br><br></code></pre></td></tr></table></figure><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/9d54d69d1fe943458fe819d4edfa5bb8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom100%;"><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230426231255747.png" alt="image-20230426231255747" style="zoom:60%;"><h2 id="2-Device-Mapperæœºåˆ¶ç®€ä»‹"><a href="#2-Device-Mapperæœºåˆ¶ç®€ä»‹" class="headerlink" title="2.Device Mapperæœºåˆ¶ç®€ä»‹"></a>2.Device Mapperæœºåˆ¶ç®€ä»‹</h2><blockquote><p>å‚è€ƒ<strong>å†…æ ¸å·¥åŒ </strong>çš„<a href="https://blog.csdn.net/feelabclihu/article/details/106581248?spm=1001.2014.3001.5506">DeviceMapperæ¶æ„åŠåœ¨androidä¸Šçš„åº”ç”¨</a></p></blockquote><p>Device Mapperæ˜¯Linux2.6 å†…æ ¸ä¸­æ”¯æŒé€»è¾‘å·ç®¡ç†çš„é€šç”¨è®¾å¤‡æ˜ å°„æœºåˆ¶ï¼Œå®ƒä¸ºå®ç°ç”¨äºå­˜å‚¨èµ„æºç®¡ç†çš„å—è®¾å¤‡é©±åŠ¨æä¾›äº†ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–çš„å†…æ ¸æ¶æ„ã€‚</p><p>Device Mapperå°†æ‰€æœ‰ä¸ç­–ç•¥ç›¸å…³çš„å·¥ä½œæ”¾åˆ°ç”¨æˆ·ç©ºé—´å®Œæˆï¼Œå†…æ ¸ä¸­ä¸»è¦æä¾›å®Œæˆè¿™äº›ç­–ç•¥æ‰€éœ€è¦çš„æœºåˆ¶ã€‚ç”¨æˆ·ç©ºé—´éƒ¨åˆ†è´£é…ç½®å…·ä½“çš„ç­–ç•¥å’Œæ§åˆ¶é€»è¾‘ï¼Œæ¯”å¦‚é€»è¾‘è®¾å¤‡å’Œå“ªäº›ç‰©ç†è®¾å¤‡å»ºç«‹æ˜ å°„ï¼Œæ€ä¹ˆå»ºç«‹è¿™äº›æ˜ å°„å…³ç³»ç­‰ï¼Œè€Œå…·ä½“é‡å®šå‘ IO è¯·æ±‚çš„å·¥ä½œç”±å†…æ ¸ä¸­ç›¸å…³ä»£ç å®Œæˆã€‚</p><p>å†…æ ¸ä¸­ç›¸å…³ä»£ç åœ¨å†…æ ¸æºç çš„ kernel&#x2F;driver&#x2F;md&#x2F; ç›®å½•ä¸­ï¼Œå…¶ä»£ç æ–‡ä»¶å¯ä»¥åˆ’åˆ†ä¸ºå®ç°device mapper å†…æ ¸ä¸­åŸºæœ¬æ¶æ„çš„æ–‡ä»¶(ä¾‹å¦‚ï¼šdm.c dm_table.cç­‰)å’Œå®ç°å…·ä½“æ˜ å°„å·¥ä½œçš„ target driver æ’ä»¶æ–‡ä»¶(ä¾‹å¦‚ï¼šdm-bow.c dm-crypt.c dm-linear.cç­‰)ä¸¤éƒ¨åˆ†ã€‚</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/format.png" style="zoom:80%;"><p>å®ƒåŒ…å«ä¸‰ä¸ªé‡è¦çš„å¯¹è±¡æ¦‚å¿µï¼ŒMapped Deviceã€Mapping Tableã€Target deviceã€‚</p><ul><li><strong>Mapped Device</strong>ï¼šæ˜¯ä¸€ä¸ªæŠ½è±¡çš„é€»è¾‘è®¾å¤‡ï¼Œé€šè¿‡MappingTableæè¿°çš„æ˜ å°„å…³ç³»ï¼ˆMapped Device é€»è¾‘çš„èµ·å§‹åœ°å€ã€èŒƒå›´ã€å’Œè¡¨ç¤ºåœ¨ Target Device æ‰€åœ¨ç‰©ç†è®¾å¤‡çš„åœ°å€åç§»é‡ä»¥åŠTarget ç±»å‹ç­‰ä¿¡æ¯ï¼‰å’ŒTarget Deviceå»ºç«‹æ˜ å°„å…³ç³»ã€‚</li><li><strong>Target Device</strong>ï¼šæ˜¯Mapped Deviceæ‰€æ˜ å°„çš„ç‰©ç†ç©ºé—´æ®µã€‚</li><li><strong>Mapping Table</strong>ï¼šDeviceMapperåœ¨å†…æ ¸ä¸­é€šè¿‡ä¸€ä¸ªä¸€ä¸ªæ¨¡å—åŒ–çš„ Target Driver æ’ä»¶å®ç°å¯¹ IO è¯·æ±‚çš„è¿‡æ»¤æˆ–è€…é‡æ–°å®šå‘ç­‰å·¥ä½œï¼Œå½“å‰å·²ç»å®ç°çš„æ’ä»¶åŒ…æ‹¬ï¼šdm-cryptã€dm-linearã€dm-verityã€dm-bowã€dm-raidç­‰ã€‚</li></ul><p>Device mapper ä¸­è¿™ä¸‰ä¸ªå¯¹è±¡å’Œ target driver æ’ä»¶ä¸€èµ·æ„æˆäº†ä¸€ä¸ªå¯è¿­ä»£çš„è®¾å¤‡æ ‘ã€‚è¯¥å±‚æ¬¡åœ¨ç†è®ºä¸Šå¯ä»¥åœ¨ device mapper æ¶æ„ä¸‹æ— é™è¿­ä»£ä¸‹å»ã€‚</p><h3 id="2-1-æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#2-1-æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="2.1 æ ¸å¿ƒæ•°æ®ç»“æ„"></a>2.1 æ ¸å¿ƒæ•°æ®ç»“æ„</h3><ul><li><strong>mapped_device</strong> ï¼šåœ¨dm.c æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥ç»“æ„ç”¨äºè¡¨ç¤º mapped deviceï¼Œå®ƒä¸»è¦åŒ…æ‹¬è¯¥ mapped device ç›¸å…³çš„é”ï¼Œæ³¨å†Œçš„è¯·æ±‚é˜Ÿåˆ—å’Œä¸€äº›å†…å­˜æ± ä»¥åŠæŒ‡å‘å®ƒæ‰€å¯¹åº”æ˜ å°„è¡¨çš„æŒ‡é’ˆç­‰åŸŸã€‚</li><li><strong>dm_table</strong>ï¼šåœ¨æ–‡ä»¶dm_table.c æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¯¥ç»“æ„ä¸­åŒ…å«ä¸€ä¸ª dm_targetç»“æ„æ•°ç»„ï¼Œdm_target ç»“æ„å…·ä½“æè¿°äº† mapped_device åˆ°å®ƒæŸä¸ª target device çš„æ˜ å°„å…³ç³»ã€‚è€Œåœ¨ dm_table ç»“æ„ä¸­å°†è¿™äº› dm_target æŒ‰ç…§ B æ ‘çš„æ–¹å¼ç»„ç»‡èµ·æ¥æ–¹ä¾¿ IO è¯·æ±‚æ˜ å°„æ—¶çš„æŸ¥æ‰¾æ“ä½œã€‚dm_target ç»“æ„å…·ä½“è®°å½•è¯¥ç»“æ„å¯¹åº” target device æ‰€æ˜ å°„çš„ mapped device é€»è¾‘åŒºåŸŸçš„å¼€å§‹åœ°å€å’ŒèŒƒå›´ï¼ŒåŒæ—¶è¿˜åŒ…å«æŒ‡å‘å…·ä½“ target device ç›¸å…³æ“ä½œçš„ target_type ç»“æ„çš„æŒ‡é’ˆã€‚</li><li><strong>target_type</strong>ï¼šè¯¥ç»“æ„ä¸»è¦åŒ…å«äº† target device å¯¹åº”çš„ target driver æ’ä»¶çš„åå­—ã€å®šä¹‰çš„æ„å»ºå’Œåˆ é™¤è¯¥ç±»å‹target deviceçš„æ–¹æ³•ã€è¯¥ç±»target deviceå¯¹åº”çš„IOè¯·æ±‚é‡æ˜ å°„å’Œç»“æŸIOçš„æ–¹æ³•ç­‰ã€‚è€Œè¡¨ç¤ºå…·ä½“çš„target deviceçš„åŸŸæ˜¯dm_targetä¸­çš„privateåŸŸï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘mapped deviceæ‰€æ˜ å°„çš„å…·ä½“target deviceå¯¹åº”çš„ç»“æ„ã€‚è¡¨ç¤ºtarget deviceçš„å…·ä½“ç»“æ„ç”±äºä¸åŒçš„target ç±»å‹è€Œä¸åŒã€‚</li></ul><p>å¼€å‘è€…å¯ä»¥å®šåˆ¶device targetéƒ¨åˆ†ï¼Œä»¥å®ç°è‡ªå·±æ‰€éœ€è¦çš„éœ€æ±‚åŠŸèƒ½ã€‚</p><h3 id="2-2-ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹"><a href="#2-2-ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹" class="headerlink" title="2.2 ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹"></a>2.2 <strong>ä¸‰æ­¥å»ºç«‹dmè®¾å¤‡çš„è¿‡ç¨‹</strong></h3><p>é€šè¿‡ä¸‹è¿°çš„ä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼Œdevice mapperåœ¨å†…æ ¸ä¸­å°±å»ºç«‹ä¸€ä¸ªå¯ä»¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„mapped deviceé€»è¾‘å—è®¾å¤‡ã€‚</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/device-mapper.png"><h2 id="3-æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#3-æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="3.æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº"></a>3.æŒ‚è½½é˜¶æ®µåˆ›å»ºé€»è¾‘åˆ†åŒº</h2><h3 id="3-1-å¼€å§‹æŒ‚è½½"><a href="#3-1-å¼€å§‹æŒ‚è½½" class="headerlink" title="3.1 å¼€å§‹æŒ‚è½½"></a>3.1 å¼€å§‹æŒ‚è½½</h3><p>ğŸ¼ å…³äºç¬¬ä¸€é˜¶æ®µæŒ‚è½½çš„æµç¨‹å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„<a href="https://blog.csdn.net/stephen_curry300/article/details/126110983?spm=1001.2014.3001.5501">CSDNåšå®¢</a></p><p>æŒ‚è½½çš„å…¥å£å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// è·¯å¾„: /system/core/init/first_stage_mount.cpp</span><br><span class="hljs-comment">// åœ¨è®¾å¤‡æ ‘ä¸­æŒ‚è½½ç”±fstabæ–‡ä»¶æŒ‡å®šçš„åˆ†åŒº</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DoFirstStageMount</span><span class="hljs-params">(<span class="hljs-type">bool</span> create_devices)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> fsm = FirstStageMount::<span class="hljs-built_in">Create</span>();<br>    <span class="hljs-keyword">return</span> (*fsm)-&gt;<span class="hljs-built_in">DoFirstStageMount</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FirstStageMount::DoFirstStageMount</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">MountPartitions</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆä¸åˆ›å»ºé€»è¾‘åˆ†åŒºçš„ä»£ç èµ°åˆ° <strong>FirstStageMount::CreateLogicalPartitions</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\first_stage_mount.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FirstStageMount::CreateLogicalPartitions</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// éå†è¯»å–åˆ°çš„fstabä¸­flagä¸­æ˜¯å¦å«æœ‰logical</span><br>    <span class="hljs-comment">// å¦‚æœæœ‰ï¼Œåˆ™æ”¯æŒDmLinear</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsDmLinearEnabled</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å¯¹åº”3.2 è¯»å–å…ƒæ•°æ®</span><br>    <span class="hljs-keyword">auto</span> metadata = android::fs_mgr::<span class="hljs-built_in">ReadCurrentMetadata</span>(super_path_);<br><br>    <span class="hljs-comment">// å¯¹åº”3.3 åˆ›å»ºé€»è¾‘åˆ†åŒº</span><br>    <span class="hljs-keyword">return</span> android::fs_mgr::<span class="hljs-built_in">CreateLogicalPartitions</span>(*metadata.<span class="hljs-built_in">get</span>(), super_path_);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-è¯»å–å…ƒæ•°æ®"><a href="#3-2-è¯»å–å…ƒæ•°æ®" class="headerlink" title="3.2 è¯»å–å…ƒæ•°æ®"></a>3.2 è¯»å–å…ƒæ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\fs_mgr_dm_linear.cpp</span><br><span class="hljs-comment">// ä¼ è¿›æ¥çš„block_deviceæ˜¯superåˆ†åŒºå¯¹åº”çš„çœŸå®çš„å—è®¾å¤‡ï¼ˆå‡è®¾ä¸º/dev/block/vda2ï¼‰</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadCurrentMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; block_device)</span> </span>&#123;<br>    <span class="hljs-comment">// fs_mgr_get_slot_suffixè·å–ç¯å¢ƒå˜é‡ro.boot.slot_suffix</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰å¯åŠ¨åˆ†åŒºä¸º_aï¼Œåˆ™slot=0</span><br>    <span class="hljs-comment">// å¦‚æœå½“å‰å¯åŠ¨åˆ†åŒºä¸º_bï¼Œåˆ™slot=1</span><br>    <span class="hljs-type">uint32_t</span> slot = <span class="hljs-built_in">SlotNumberForSlotSuffix</span>(<span class="hljs-built_in">fs_mgr_get_slot_suffix</span>());<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReadMetadata</span>(block_device.<span class="hljs-built_in">c_str</span>(), slot);<br>&#125;<br><br><span class="hljs-comment">// ä¼ è¿›æ¥çš„super_partitionæ˜¯/dev/block/vda2</span><br><span class="hljs-comment">// å‡è®¾å¯åŠ¨åˆ†åŒºä¸º_aï¼Œslot_numberä¸º0</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; super_partition, <span class="hljs-type">uint32_t</span> slot_number)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ReadMetadata</span>(<span class="hljs-built_in">PartitionOpener</span>(), super_partition, slot_number);<br>&#125;<br><br><span class="hljs-comment">// --------------------------------------------------------------</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function">std::unique_ptr&lt;LpMetadata&gt; <span class="hljs-title">ReadMetadata</span><span class="hljs-params">(<span class="hljs-type">const</span> IPartitionOpener&amp; opener,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         <span class="hljs-type">const</span> std::string&amp; super_partition, <span class="hljs-type">uint32_t</span> slot_number)</span> </span>&#123;<br>    android::base::unique_fd fd = opener.<span class="hljs-built_in">Open</span>(super_partition, O_RDONLY);<br><br>    LpMetadataGeometry geometry;<br>    <span class="hljs-comment">// è¯»å–/dev/block/vda2ä¸­çš„å…ƒæ•°æ®</span><br>    <span class="hljs-comment">// è¯»çš„æ˜¯1.1èŠ‚ä¸­çš„LpMetadataGeometryæ•°æ®ç»“æ„ï¼Œå°†å…¶ä¿å­˜åˆ°geometry</span><br>    <span class="hljs-comment">// ç›®çš„æ˜¯ç›´æ¥èµ‹å€¼ç»™ä¸‹é¢å³å°†åˆ›å»ºçš„å˜é‡metaçš„æˆå‘˜å˜é‡geometry</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadLogicalPartitionGeometry</span>(fd, &amp;geometry)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    std::unique_ptr&lt;LpMetadata&gt; metadata;<br><br>    <span class="hljs-comment">// è¯»å–/dev/block/mmcblk0p5ä¸­çš„æ‰€æœ‰çš„å…ƒæ•°æ®</span><br>    <span class="hljs-comment">// å°†å…¶ä¿å­˜åˆ°metadataå˜é‡ä¸­ï¼Œæœ€åè¿”å›3.1ä¸­æœ€åˆè°ƒç”¨ReadCurrentMetadataçš„åœ°æ–¹</span><br>    <span class="hljs-comment">// æ‰€æœ‰çš„metadataç»“æ„éƒ½æ˜¯æŒ‰ç…§1.æ•´ä½“è®¤çŸ¥â€”â€”LpMetadataåˆ†å¸ƒçš„</span><br>    metadata = <span class="hljs-built_in">ParseMetadata</span>(geometry, fd)<br>    <br>    <span class="hljs-keyword">return</span> metadata;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="3-3-åˆ›å»ºé€»è¾‘åˆ†åŒº"><a href="#3-3-åˆ›å»ºé€»è¾‘åˆ†åŒº" class="headerlink" title="3.3 åˆ›å»ºé€»è¾‘åˆ†åŒº"></a>3.3 åˆ›å»ºé€»è¾‘åˆ†åŒº</h3><p><strong>3.2èŠ‚å’Œ3.3èŠ‚æ˜¯ç‹¬ç«‹çš„ï¼Œä¸¤èŠ‚éƒ½æ˜¯3.1çš„å­ç¯‡ï¼Œä¸è¦çº¿æ€§é˜…è¯»</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartitions</span><span class="hljs-params">(<span class="hljs-type">const</span> LpMetadata&amp; metadata, <span class="hljs-type">const</span> std::string&amp; super_device)</span> </span>&#123;<br>    CreateLogicalPartitionParams params = &#123;<br>            .block_device = super_device,<br>            .metadata = &amp;metadata,<br>    &#125;;<br>    <span class="hljs-comment">// è¿™é‡Œçš„metadata.partitionsæ˜¯1.3èŠ‚çš„LpMetadataPartition</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; partition : metadata.partitions) &#123;<br>        params.partition = &amp;partition;<br><br>        std::string ignore_path;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateLogicalPartition</span>(params, &amp;ignore_path)) &#123;<br>            LERROR &lt;&lt; <span class="hljs-string">&quot;Could not create logical partition: &quot;</span> &lt;&lt; <span class="hljs-built_in">GetPartitionName</span>(partition);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šéå†metadataä¸­å­˜å‚¨çš„partitionsæˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯metadata.imgä¸­å­˜æ”¾çš„ä¸€ä¸ªä¸ªé€»è¾‘åˆ†åŒºä¿¡æ¯ï¼Œä¾‹å¦‚å¦‚æœæˆ‘ä»¬ç¬¬ä¸€ä¸ªå­˜å‚¨çš„LpMetadataPartitionæ˜¯systemçš„ä¿¡æ¯ï¼Œé‚£ä¹ˆé¦–å…ˆè°ƒç”¨CreateLogicalPartitionå»åˆ›å»ºé€»è¾‘åˆ†åŒºï¼Œç¬¬äºŒä¸ªå­˜å‚¨çš„LpMetadataPartitionæ˜¯vendorçš„ä¿¡æ¯ï¼Œç›¸åº”çš„è°ƒç”¨CreateLogicalPartitionå»åˆ›å»ºé€»è¾‘åˆ†ã€‚</p><p>ğŸˆ<strong>åˆ°è¿™é‡Œè§£é‡Šäº†å¼€å¤´æˆ‘ä»¬æåˆ°çš„ä¸ºä»€ä¹ˆdm-1ã€dm-2åˆ›å»ºçš„å…ˆåé¡ºåºï¼Œå…¶ä¸metadata.imgä¸­çš„åˆ†åŒºé¡ºåºæœ‰å…³ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯ä¸ç”Ÿæˆsuper.imgæ—¶æŒ‡æ˜çš„é¡ºåºæœ‰å…³ã€‚</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartition</span><span class="hljs-params">(CreateLogicalPartitionParams params, std::string* path)</span> </span>&#123;<br>    CreateLogicalPartitionParams::OwnedData owned_data;<br>    <span class="hljs-comment">// 3.3.1ï¼šä¸»è¦åˆå§‹åŒ–paramsä¸­çš„partition_nameå’Œdevice_name</span><br>    <span class="hljs-keyword">if</span> (!params.<span class="hljs-built_in">InitDefaults</span>(&amp;owned_data)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    DmTable table;<br>    <span class="hljs-comment">// 3.3.2ï¼šä¸»è¦åˆ›å»ºdmtable</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateDmTableInternal</span>(params, &amp;table)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    DeviceMapper&amp; dm = DeviceMapper::<span class="hljs-built_in">Instance</span>();<br>    <span class="hljs-comment">// 3.3.2ï¼šå®Œæˆç¬¬2.2ä¸­æ‰€è¯´çš„ä¸‰æ­¥èµ°</span><br>    <span class="hljs-keyword">if</span> (!dm.<span class="hljs-built_in">CreateDevice</span>(params.device_name, table, path, params.timeout_ms)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// æ–‡ç« å¼€å¤´çš„å¯åŠ¨æ—¥å¿—æ‰“å°å°±æ˜¯åœ¨è¿™é‡Œ</span><br>    LINFO &lt;&lt; <span class="hljs-string">&quot;Created logical partition &quot;</span> &lt;&lt; params.device_name &lt;&lt; <span class="hljs-string">&quot; on device &quot;</span> &lt;&lt; *path;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-1-InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams"><a href="#3-3-1-InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams" class="headerlink" title="3.3.1 InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams"></a>3.3.1 InitDefaultsåˆå§‹åŒ–CreateLogicalPartitionParams</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateLogicalPartitionParams::InitDefaults</span><span class="hljs-params">(CreateLogicalPartitionParams::OwnedData* owned)</span> </span>&#123;<br>    <span class="hljs-comment">// 3.3èŠ‚å¼€å¤´çš„CreateLogicalPartitionParams paramsçš„å‚æ•°ä¸­è¿˜æ²¡æœ‰åˆå§‹åŒ–partition_name</span><br>    <span class="hljs-keyword">if</span> (partition_name.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-comment">// partition_nameä¸ºsystem_a</span><br>        partition_name = android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (partition_name != android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Inconsistent partition_name &quot;</span> &lt;&lt; partition_name &lt;&lt; <span class="hljs-string">&quot; with partition &quot;</span><br>               &lt;&lt; android::fs_mgr::<span class="hljs-built_in">GetPartitionName</span>(*partition);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (device_name.<span class="hljs-built_in">empty</span>()) &#123;<br>        device_name = partition_name;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// --------------------------------------------------------------</span><br><br><span class="hljs-comment">// system\core\fs_mgr\liblp\reader.cpp</span><br><span class="hljs-function">std::string <span class="hljs-title">GetPartitionName</span><span class="hljs-params">(<span class="hljs-type">const</span> LpMetadataPartition&amp; partition)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">NameFromFixedArray</span>(partition.name, <span class="hljs-built_in">sizeof</span>(partition.name));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">NameFromFixedArray</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">size_t</span> buffer_size)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (name[buffer_size - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(name);<br>    &#125;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(name, buffer_size);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table"><a href="#3-3-2-CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table" class="headerlink" title="3.3.2 CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table"></a>3.3.2 CreateDmTableInternalåˆ›å»ºdm-linearè®¾å¤‡table</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateDmTableInternal</span><span class="hljs-params">(<span class="hljs-type">const</span> CreateLogicalPartitionParams&amp; params, DmTable* table)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; super_device = params.block_device;<br><br>    <span class="hljs-type">uint64_t</span> sector = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; params.partition-&gt;num_extents; i++) &#123;<br>        <span class="hljs-comment">// æ‰¾åˆ°å„ä¸ªåˆ†åŒºè‡ªå·±çš„extentså†…å®¹ï¼Œä¹Ÿå°±æ˜¯1.4èŠ‚</span><br>        <span class="hljs-comment">// åœ¨partitionä¸­çš„first_extent_indexå­—æ®µä¼šæŒ‡æ˜å½“å‰åˆ†åŒºåœ¨extentså“ªä¸ªä½ç½®</span><br>        <span class="hljs-comment">// 99%çš„æƒ…å†µåªä¼šå ç”¨ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥ params.partition-&gt;num_extentsä¸€èˆ¬éƒ½æ˜¯1</span><br>        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; extent = params.metadata-&gt;extents[params.partition-&gt;first_extent_index + i];<br>        std::unique_ptr&lt;DmTarget&gt; target;<br>        <span class="hljs-comment">// ä»1.4å±•ç¤ºçš„typeæ¥çœ‹æ˜¯æ•°å­—0ï¼Œæ­£å¥½å¯¹åº”äº†è¿™é‡Œçš„LP_TARGET_TYPE_LINEARï¼Œçº¿æ€§æ’å¸ƒçš„DMè®¾å¤‡</span><br>        <span class="hljs-keyword">switch</span> (extent.target_type) &#123;<br>            <span class="hljs-keyword">case</span> LP_TARGET_TYPE_ZERO:<br><span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">case</span> LP_TARGET_TYPE_LINEAR: &#123;<br>                <span class="hljs-comment">// ä»1.4å±•ç¤ºçš„target_sourceæ˜¯0ï¼Œä¹Ÿå°±æ˜¯system_aå¯¹åº”çš„target_sourceæ˜¯0ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘äº†1.6èŠ‚ä¸­superæ‰€åœ¨çš„ä½ç½®ã€superçš„ç´¢å¼•ä¸º0ã€‘</span><br>                <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; block_device = params.metadata-&gt;block_devices[extent.target_source];<br>                std::string dev_string;<br>                <span class="hljs-comment">// è·å–superçœŸå®çš„ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥dev_stringä¸º/dev/block/vda2</span><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">GetPhysicalPartitionDevicePath</span>(params, block_device, super_device,<br>                                                    &amp;dev_string)) &#123;<br>                    <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Unable to complete device-mapper table, unknown block device&quot;</span>;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªDmTargetLinearç±»å‹çš„æŒ‡é’ˆï¼Œç”±targetç‹¬å ç®¡ç†</span><br>                target = std::<span class="hljs-built_in">make_unique</span>&lt;DmTargetLinear&gt;(sector, extent.num_sectors, dev_string,<br>                                                          extent.target_data);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">&quot;Unknown target type in metadata: &quot;</span> &lt;&lt; extent.target_type;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// å°†targetæ·»åŠ åˆ°tableé‡Œé¢å»ï¼ŒDmTableç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨_target</span><br>        <span class="hljs-comment">// DmTable::AddTargetä¹Ÿå°±æ˜¯æŠŠtargetæ·»åŠ pushåˆ°_targetä¸­</span><br>        <span class="hljs-keyword">if</span> (!table-&gt;<span class="hljs-built_in">AddTarget</span>(std::<span class="hljs-built_in">move</span>(target))) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        sector += extent.num_sectors;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœ1.3èŠ‚ä¸­Attributeå«æœ‰READ_ONLYå±æ€§ï¼ŒTABLEè®¾ç½®æˆåªè¯»çš„</span><br>    <span class="hljs-keyword">if</span> (params.partition-&gt;attributes &amp; LP_PARTITION_ATTR_READONLY) &#123;<br>        table-&gt;<span class="hljs-built_in">set_readonly</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœparamsè®¾ç½®äº†å¼ºåˆ¶å¯å†™ï¼ŒTABLEè®¾ç½®æˆå¯è¯»å¯å†™</span><br>    <span class="hljs-keyword">if</span> (params.force_writable) &#123;<br>        table-&gt;<span class="hljs-built_in">set_readonly</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-3-2-1-æ•°æ®ç»“æ„æ¢³ç†"><a href="#3-3-2-1-æ•°æ®ç»“æ„æ¢³ç†" class="headerlink" title="3.3.2.1 æ•°æ®ç»“æ„æ¢³ç†"></a>3.3.2.1 æ•°æ®ç»“æ„æ¢³ç†</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DmTarget</span> &#123;<br>  <span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DmTarget</span>(<span class="hljs-type">uint64_t</span> start, <span class="hljs-type">uint64_t</span> length) : <span class="hljs-built_in">start_</span>(start), <span class="hljs-built_in">length_</span>(length) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DmTargetLinear</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> DmTarget &#123;<br>  <span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DmTargetLinear</span>(<span class="hljs-type">uint64_t</span> start, <span class="hljs-type">uint64_t</span> length, <span class="hljs-type">const</span> std::string&amp; block_device,<br>                   <span class="hljs-type">uint64_t</span> physical_sector)<br>        : <span class="hljs-built_in">DmTarget</span>(start, length), <span class="hljs-built_in">block_device_</span>(block_device), <span class="hljs-built_in">physical_sector_</span>(physical_sector) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-3-CreateDevice"><a href="#3-3-3-CreateDevice" class="headerlink" title="3.3.3 CreateDevice"></a>3.3.3 CreateDevice</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\libdm\dm.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DeviceMapper::CreateDevice</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> DmTable&amp; table, std::string* path,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">const</span> std::chrono::milliseconds&amp; timeout_ms)</span> </span>&#123;<br>    <span class="hljs-comment">// é€šè¿‡/dev/urandomç”ŸæˆéšæœºUUID</span><br>    std::string uuid = <span class="hljs-built_in">GenerateUuid</span>();<br>    <span class="hljs-comment">// 3.3.3.1 è°ƒç”¨ioctlåˆ›å»ºè®¾å¤‡</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateDevice</span>(name, uuid)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    std::string unique_path;<br>    <span class="hljs-comment">// 3.3.3.2 LoadTableAndActivateåˆ›å»ºDMè®¾å¤‡ä¸‰æ­¥æ³•</span><br>    <span class="hljs-comment">// 3.3.3.3 GetDeviceUniquePathè·å–è·å–dmè®¾å¤‡çš„uuidï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸäº†</span><br>    <span class="hljs-comment">// 3.3.3.4 GetDmDevicePathByNameè·å–dmè®¾å¤‡ï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">LoadTableAndActivate</span>(name, table) || !<span class="hljs-built_in">GetDeviceUniquePath</span>(name, &amp;unique_path) ||<br>        !<span class="hljs-built_in">GetDmDevicePathByName</span>(name, path)) &#123;<br>        <span class="hljs-comment">// å¦‚æœè®¾å¤‡æ²¡æœ‰åˆ›å»ºæˆåŠŸï¼ŒDeleteDeviceä¼šè°ƒç”¨ioctl[DM_DEV_REMOVE]åˆ é™¤åˆ›å»ºçš„dmè®¾å¤‡</span><br>        <span class="hljs-built_in">DeleteDevice</span>(name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-3-3-1-CreateDeviceè°ƒç”¨ioctlåˆ›å»ºè®¾å¤‡"><a href="#3-3-3-1-CreateDeviceè°ƒç”¨ioctlåˆ›å»ºè®¾å¤‡" class="headerlink" title="3.3.3.1 CreateDeviceè°ƒç”¨ioctlåˆ›å»ºè®¾å¤‡"></a>3.3.3.1 CreateDeviceè°ƒç”¨ioctlåˆ›å»ºè®¾å¤‡</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">DeviceMapper::CreateDevice</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; uuid)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_ioctl</span> <span class="hljs-title">io</span>;</span><br>    InitIo(&amp;io, name);<br>    <span class="hljs-comment">// ä¸Šé¢ç”Ÿæˆäº†éšæœºçš„UUIDï¼Œæ‰€ä»¥è¿™é‡Œè‚¯å®šä¸ä¸ºç©º</span><br>    <span class="hljs-keyword">if</span> (!uuid.empty()) &#123;<br>        <span class="hljs-built_in">snprintf</span>(io.uuid, <span class="hljs-keyword">sizeof</span>(io.uuid), <span class="hljs-string">&quot;%s&quot;</span>, uuid.c_str());<br>    &#125;<br><br>    <span class="hljs-comment">// å‘DeviceMapperé©±åŠ¨å‘é€DM_DEV_CRETEåˆ›å»ºè®¾å¤‡</span><br>    <span class="hljs-keyword">if</span> (ioctl(fd_, DM_DEV_CREATE, &amp;io)) &#123;<br>        PLOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;DM_DEV_CREATE failed for [&quot;</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">&quot;]&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-3-3-2-LoadTableAndActivateä¼ tableæ•°æ®ä¸‹å»"><a href="#3-3-3-2-LoadTableAndActivateä¼ tableæ•°æ®ä¸‹å»" class="headerlink" title="3.3.3.2 LoadTableAndActivateä¼ tableæ•°æ®ä¸‹å»"></a>3.3.3.2 LoadTableAndActivateä¼ tableæ•°æ®ä¸‹å»</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// è¿™è¾¹ä¼ è¿›æ¥çš„tableæ˜¯3.3.2åˆ›å»ºçš„dm-linearè®¾å¤‡table</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">DeviceMapper::LoadTableAndActivate</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-type">const</span> DmTable&amp; table)</span> &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">ioctl_buffer</span><span class="hljs-params">(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dm_ioctl), <span class="hljs-number">0</span>)</span>;<br>    ioctl_buffer += table.Serialize();<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_ioctl</span>* <span class="hljs-title">io</span> =</span> reinterpret_cast&lt;<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_ioctl</span>*&gt;</span>(&amp;ioctl_buffer[<span class="hljs-number">0</span>]);<br>    InitIo(io, name);<br>    io-&gt;data_size = ioctl_buffer.size();<br>    io-&gt;data_start = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dm_ioctl);<br>    io-&gt;target_count = static_cast&lt;<span class="hljs-type">uint32_t</span>&gt;(table.num_targets());<br>    <span class="hljs-keyword">if</span> (table.readonly()) &#123;<br>        io-&gt;flags |= DM_READONLY_FLAG;<br>    &#125;<br>    <span class="hljs-comment">// å‘DeviceMapperé©±åŠ¨å‘é€DM_TABLE_LOADä¸‹å‘MappingTable</span><br>    <span class="hljs-keyword">if</span> (ioctl(fd_, DM_TABLE_LOAD, io)) &#123;<br>        PLOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;DM_TABLE_LOAD failed&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    InitIo(io, name);<br>    <span class="hljs-comment">// å‘DeviceMapperé©±åŠ¨å‘é€DM_DEV_SUSPENDä½¿èƒ½MappedDevice</span><br>    <span class="hljs-keyword">if</span> (ioctl(fd_, DM_DEV_SUSPEND, io)) &#123;<br>        PLOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;DM_TABLE_SUSPEND resume failed&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-3-3-3-GetDeviceUniquePathè·å–è·å–dmè®¾å¤‡çš„uuidï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸäº†"><a href="#3-3-3-3-GetDeviceUniquePathè·å–è·å–dmè®¾å¤‡çš„uuidï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸäº†" class="headerlink" title="3.3.3.3 GetDeviceUniquePathè·å–è·å–dmè®¾å¤‡çš„uuidï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸäº†"></a>3.3.3.3 GetDeviceUniquePathè·å–è·å–dmè®¾å¤‡çš„uuidï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸäº†</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">DeviceMapper::GetDeviceUniquePath</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>* path)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_ioctl</span> <span class="hljs-title">io</span>;</span><br>    InitIo(&amp;io, name);<br>    <span class="hljs-comment">// å‘DeviceMapperé©±åŠ¨å‘é€DM_DEV_STATUSæŸ¥è¯¢MappedDevice(system_a)çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (ioctl(fd_, DM_DEV_STATUS, &amp;io) &lt; <span class="hljs-number">0</span>) &#123;<br>        PLOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;Failed to get device path: &quot;</span> &lt;&lt; name;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå†…æ ¸æ²¡æœ‰å¯¹å‚æ•°uuidè¿›è¡Œèµ‹å€¼ï¼Œè¯´æ˜æ²¡æœ‰åˆ›å»ºæˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> (io.uuid[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        LOG(ERROR) &lt;&lt; <span class="hljs-string">&quot;Device does not have a unique path: &quot;</span> &lt;&lt; name;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    *path = <span class="hljs-string">&quot;/dev/block/mapper/by-uuid/&quot;</span>s + io.uuid;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-3-3-4-GetDmDevicePathByNameè·å–dmè®¾å¤‡ï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸ"><a href="#3-3-3-4-GetDmDevicePathByNameè·å–dmè®¾å¤‡ï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸ" class="headerlink" title="3.3.3.4 GetDmDevicePathByNameè·å–dmè®¾å¤‡ï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸ"></a>3.3.3.4 GetDmDevicePathByNameè·å–dmè®¾å¤‡ï¼Œçœ‹dmè®¾å¤‡æ˜¯å¦åˆ›å»ºæˆåŠŸ</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">DeviceMapper::GetDmDevicePathByName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>* path)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dm_ioctl</span> <span class="hljs-title">io</span>;</span><br>    InitIo(&amp;io, name);<br>    <span class="hljs-comment">// å‘DeviceMapperé©±åŠ¨å‘é€DM_DEV_STATUSæŸ¥è¯¢MappedDevice(system_a)çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (ioctl(fd_, DM_DEV_STATUS, &amp;io) &lt; <span class="hljs-number">0</span>) &#123;<br>        PLOG(WARNING) &lt;&lt; <span class="hljs-string">&quot;DM_DEV_STATUS failed for &quot;</span> &lt;&lt; name;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><span class="hljs-comment">// ä¸Šé¢è°ƒç”¨ioctlåä¼šå¯¹io.devè¿›è¡Œèµ‹å€¼</span><br>    <span class="hljs-comment">// minor(io.dev)æ‹¿åˆ°mapped deivecå¯¹åº”çš„è®¾å¤‡</span><br>    <span class="hljs-comment">// ä¾‹å¦‚system_açš„dev_numä¸º0</span><br>    <span class="hljs-type">uint32_t</span> dev_num = minor(io.dev);<br>    *path = <span class="hljs-string">&quot;/dev/block/dm-&quot;</span> + <span class="hljs-built_in">std</span>::to_string(dev_num);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h2><p>æœ€åç”»äº†ä¸€å¼ å›¾ï¼Œå®Œç¾é—­å…³</p><img src="/2023/03/18/Android-S%E5%88%9B%E5%BB%BA%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA/image-20230427231954102.png" alt="image-20230427231954102" style="zoom:1000%;"><h2 id="5-æ„Ÿè°¢"><a href="#5-æ„Ÿè°¢" class="headerlink" title="5.æ„Ÿè°¢"></a>5.æ„Ÿè°¢</h2><p>æ„Ÿè°¢ <a href="https://www.cnblogs.com/pyjetson/p/14872499.html%EF%BC%8C%E4%BB%8E%E5%AE%83%E7%9A%84%E5%8D%9A%E5%AE%A2%E9%87%8C%E9%9D%A2%E5%AD%A6%E5%88%B0%E4%BA%86%E5%BE%88%E5%A4%9A%F0%9F%8E%97%EF%B8%8F">https://www.cnblogs.com/pyjetson/p/14872499.htmlï¼Œä»å®ƒçš„åšå®¢é‡Œé¢å­¦åˆ°äº†å¾ˆå¤šğŸ—ï¸</a></p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜</title>
    <link href="/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/"/>
    <url>/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="å±•è®¯Android-P-System-as-rootè§„èŒƒè¯´æ˜"><a href="#å±•è®¯Android-P-System-as-rootè§„èŒƒè¯´æ˜" class="headerlink" title="å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜"></a>å±•è®¯Android P System_as_rootè§„èŒƒè¯´æ˜</h1><blockquote><p>ä½œä¸ºä¸ªäººå­¦ä¹ ç¬”è®°ä½¿ç”¨ï¼Œ<a href="https://bbs.16rd.com/thread-584995-1-1.html">https://bbs.16rd.com/thread-584995-1-1.html</a></p></blockquote><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h2><p>Android ä» 8.0 å¼€å§‹å¼•å…¥äº† Treble æ¶æ„ï¼Œç›®çš„æ˜¯è®© Android è®¾å¤‡åˆ¶é€ å•†èƒ½å¤Ÿæ›´å¿«ï¼Œæ›´å®¹æ˜“ï¼Œæ›´ä½æˆæœ¬çš„å»å‡çº§ Android ç‰ˆæœ¬ã€‚ä¸ºå®ç°è¿™ä¸€ç›®çš„ï¼ŒGoogle è®¾å®šäº†å¾ˆå¤šè§„åˆ™ï¼Œè®¾å¤‡å•†åªæœ‰å®ç°äº†è¿™äº›è§„ åˆ™ï¼Œæ‰èƒ½æ»¡è¶³ Treble æ¶æ„çš„è¦æ±‚ã€‚æœ¬æ–‡ä»‹ç»çš„ system as root å°±æ˜¯ Google åœ¨ AndroidP ä¸Šæå‡ºçš„ä¸€ é¡¹æ”¹åŠ¨è§„åˆ™ã€‚</p><p>æ‰€è°“ system as rootï¼ŒæŒ‡çš„æ˜¯ system åˆ†åŒºè¢«æŒ‚è½½ä¸º rootfsï¼Œandroid å¯ä»¥é€šè¿‡ OTA ç›´æ¥å‡çº§ rootfsï¼Œé¿å…å‡ºç° system å‡çº§ä¹‹åï¼Œå­˜å‚¨åœ¨ ramdiskï¼ˆrootfsï¼‰ä¸­çš„ init&#x2F;init.rc ä¸æ–°çš„ android ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´ç³»ç»Ÿå‡ºé—®é¢˜ã€‚ åœ¨ A&#x2F;B ç³»ç»Ÿçš„ device ä¸Šï¼Œramdisk å·²ç»æ‰“åŒ…åˆ° system.img äº†ï¼Œæ‰€ä»¥æ— éœ€åšä»€ä¹ˆé€‚é…ã€‚æ­è½½Android 9.x çš„æ‰€æœ‰æ–°è®¾å¤‡éƒ½å¿…é¡»ä½¿ç”¨ system-as-rootï¼ˆBOARD_BUILD_SYSTEM_ROOT_IMAGEå¿…é¡»ä¸º trueï¼‰ï¼Œå®ƒå¯ä»¥å°† ramdisk.img åˆå¹¶åˆ° system.imgï¼Œè€Œåè€…ä¼šåè¿‡æ¥å†ä½œä¸º rootfs è¿›è¡Œè£…è½½ã€‚å¯¹äºè¦å‡çº§åˆ° Android 9 çš„è®¾å¤‡ï¼Œä½¿ç”¨ system-as-root å¹¶éå¼ºåˆ¶è¦æ±‚ã€‚</p><p>System as root çš„æ”¹åŠ¨éƒ¨åˆ†å¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/16/%E5%B1%95%E8%AE%AFAndroid-P-System-as-root%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E/173632rimzt33h8mi4ntif.jpg" alt="173632rimzt33h8mi4ntif" style="zoom:80%;"><h2 id="2-System-as-root-è§„èŒƒ"><a href="#2-System-as-root-è§„èŒƒ" class="headerlink" title="2.System as root è§„èŒƒ"></a>2.System as root è§„èŒƒ</h2><p>System as root çš„æ ¸å¿ƒåœ¨äº ramdisk ä¼šè¢«æ‰“åŒ…åˆ° system.imgï¼ŒåŸºäºè¿™ç§çŠ¶å†µï¼Œè®¾å¤‡å‚å•†è‡ªè¡Œæ·»åŠ åˆ° ramdisk ä¸­çš„æ”¹åŠ¨ï¼Œå¿…é¡»è½¬ç§»åˆ°å…¶å®ƒä½ç½®ï¼Œå¦åˆ™ system.img ä¸€æ›´æ¢ï¼ˆä¾‹å¦‚ GSI ç‰ˆæœ¬ï¼‰ï¼Œramdiskä¸­æ·»åŠ çš„å†…å®¹å°±ä¸¢å¤±äº†ï¼Œå¯¼è‡´ç³»ç»Ÿå¯åŠ¨å¯èƒ½å‡ºç°é—®é¢˜ã€‚æ ¹æ® Google å‘å¸ƒçš„ system as root æ–‡æ¡£çš„è¦æ±‚ï¼Œæ€»ç»“äº†ä¸‹é¢è¿™äº›éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ï¼š</p><table><thead><tr><th>ID</th><th>ä¿®æ”¹å†…å®¹</th><th>è§„èŒƒ</th></tr></thead><tbody><tr><td>1</td><td>rcæ–‡ä»¶çš„è°ƒæ•´</td><td>åŸæ¥æ”¾ç½®åœ¨device&#x2F;{board}&#x2F;è·¯å¾„ä¸­çš„rcæ–‡ä»¶ï¼Œéœ€è¦ç¼–è¯‘ åˆ°vendor&#x2F;etc&#x2F;init;å¦ä¸€æ–¹é¢å¦‚æœä¿®æ”¹äº† &#x2F;system&#x2F;core&#x2F;rootdir&#x2F;T init.*.rc ,æœ€å¥½å°†ä¿®æ”¹ç§»åŠ¨åˆ°è®¾å¤‡å‚ å•†è‡ªè¡Œæ·»åŠ çš„rcæ–‡ä»¶ä¸­ï¼›rcæ–‡ä»¶ä¸­importçš„è·¯å¾„éœ€è¦ä¿®æ”¹ï¼Œ é¿å…importè·¯å¾„é”™è¯¯å¯¼è‡´rcæ–‡ä»¶æ²¡æœ‰è¢«è§£æã€‚</td></tr><tr><td>2</td><td>å†…æ ¸æ¨¡å—ç§»å²€ramdisk</td><td>å†…æ ¸æ¨¡å—é©±åŠ¨å·²ç»ç§»åˆ°vendoråˆ†åŒºã€‚</td></tr><tr><td>3</td><td>fstabæ–‡ä»¶è·¯å¾„è°ƒæ•´</td><td>fstabæ–‡ä»¶éœ€è¦ä»ramdiskç§»åŠ¨åˆ°vendor&#x2F;etc</td></tr><tr><td>4</td><td>ramdiskæ‰“åŒ…è°ƒæ•´</td><td>ramdisk.img éœ€è¦æ‰“åŒ…åˆ° system.img ä¸­</td></tr><tr><td>5</td><td>dm-verifyå®ç°æ–¹æ¡ˆè°ƒæ•´</td><td>AndroidP Â± dm-verifyå¿…é¡»å¼€å¯,UNISOCç‰ˆæœ¬å·²é»˜è®¤ å¼€å¯ dm-verify</td></tr></tbody></table><h3 id="2-1-rcæ–‡ä»¶çš„è°ƒæ•´"><a href="#2-1-rcæ–‡ä»¶çš„è°ƒæ•´" class="headerlink" title="2.1 rcæ–‡ä»¶çš„è°ƒæ•´"></a>2.1 rcæ–‡ä»¶çš„è°ƒæ•´</h3><p>åœ¨ device&#x2F;{board}ä»“åº“ä¸­å­˜åœ¨å¾ˆå¤šè®¾å¤‡ç›¸å…³çš„ rc æ–‡ä»¶ï¼Œåœ¨ AndroidP ä¹‹å‰ï¼Œè¿™äº› rc æ–‡ä»¶æ˜¯è¢«ç¼–è¯‘åˆ° ramdisk çš„æ ¹è·¯å¾„çš„ï¼Œä½†æ˜¯æŒ‰ç…§ system as root çš„è¦æ±‚ï¼Œè¿™äº›æ–‡ä»¶å¿…é¡»è°ƒæ•´åˆ°å…¶å®ƒè·¯å¾„ï¼Œä¸”æ–‡ä»¶ ä¸­ import rc ç­‰è¯­å¥æ‰€å¯¹åº”çš„è·¯å¾„éœ€è¦åšè°ƒæ•´ã€‚å…·ä½“æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ul><li>device&#x2F;{board} è·¯å¾„çš„ rc æ–‡ä»¶ copy åˆ° vendor åˆ†åŒºï¼Œä¾‹å¦‚ï¼š device&#x2F;{board}&#x2F;common&#x2F;DeviceCommon.mk</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">product_COPY_FILES += \<br><span class="hljs-variable">$(LOCAL_PATH)</span>/rootdir/root/init.common.rc:<span class="hljs-variable">$(TARGET_COPY_OUT_VENDOR)</span>/etc/init/hw/init.common .rc \<br><span class="hljs-variable">$(LOCAL_PATH)</span>/rootdir/root/init.ram.rc:<span class="hljs-variable">$(TARGET_COPY_OUT_VENDOR)</span>/etc/init/hw/init.ram.rc \<br></code></pre></td></tr></table></figure><ul><li>device&#x2F;{board} è·¯å¾„çš„ rc æ–‡ä»¶ import è·¯å¾„éœ€è¦åšç›¸åº”è°ƒæ•´ï¼šä¾‹å¦‚ device&#x2F;{board}&#x2F;common&#x2F;rootdir&#x2F;root&#x2F;init.common.rc æ–‡ä»¶åŸæœ¬ import çš„éƒ½æ˜¯æ ¹è·¯å¾„çš„ rc æ–‡ä»¶ï¼Œç°åœ¨éœ€è¦æ ¹æ®å®é™…å½’æ¡£è·¯å¾„æ¥è°ƒæ•´ã€‚</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">import /vendor/etc/init/hw/init.$&#123;ro.hardware&#125;.usb.rc<br>import /vendor/etc/init/hw/init.ram.rc<br>import /vendor/etc/init/hw/init.storage.rc<br></code></pre></td></tr></table></figure><h3 id="2-2-å†…æ ¸æ¨¡å—ç§»å‡ºramdisk"><a href="#2-2-å†…æ ¸æ¨¡å—ç§»å‡ºramdisk" class="headerlink" title="2.2  å†…æ ¸æ¨¡å—ç§»å‡ºramdisk"></a>2.2  å†…æ ¸æ¨¡å—ç§»å‡ºramdisk</h3><p>åœ¨ UNISOC å¹³å°ï¼Œéƒ¨åˆ† kernel modules æ”¾åˆ° ramdisk çš„ lib è·¯å¾„ä¸‹ï¼Œåœ¨å¼€å¯äº† <strong>system as root</strong>ä¹‹åï¼Œéµå¾ª Google çš„å»ºè®®ï¼Œéœ€è¦ç»Ÿä¸€è°ƒæ•´åˆ°&#x2F;vendor&#x2F;lib&#x2F;modules ä¸­ï¼š</p><ul><li>åœ¨æ¨¡å—çš„ Android.mk(bp)ä¸­ï¼Œå°†æ¨¡å— bin æ–‡ä»¶å½’æ¡£è·¯å¾„è®¾å®šä¸º&#x2F;vendor&#x2F;lib&#x2F;modulesï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs make\">vendor/sprd/modules/wcn/fm/driver/Android.mk<br>1. LOCAL_MODULE := sprd_fm.ko<br>2. LOCAL_MODULE_CLASS := SHARED_LIBRARIES<br>3. LOCAL_MODULE_PATH := $(TARGET_OUT_VENDOR)/etc/modules<br></code></pre></td></tr></table></figure><h3 id="2-3-fstab-æ–‡ä»¶è·¯å¾„è°ƒæ•´"><a href="#2-3-fstab-æ–‡ä»¶è·¯å¾„è°ƒæ•´" class="headerlink" title="2.3 fstab æ–‡ä»¶è·¯å¾„è°ƒæ•´"></a>2.3 fstab æ–‡ä»¶è·¯å¾„è°ƒæ•´</h3><p>fstab æ˜¯ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿ mount ä¿¡æ¯çš„ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸è®¾å¤‡çš„å­˜å‚¨å¼ºç›¸å…³ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ä» ramdiskç§»å‡ºï¼Œå°† fstab æ”¾åœ¨ vendor&#x2F;etc&#x2F;è·¯å¾„ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrecovery æ¨¡å¼æ‰€ç”¨çš„ ramdisk ä¸æ­£å¸¸å¼€æœºçš„ä¸æ˜¯ä¸€ä¸ªï¼Œ æ‰€ä»¥ recovery æ¨¡å¼æ‰€ç”¨çš„ fstab æ–‡ä»¶ï¼Œè·¯å¾„ä¸ç”¨ä¿®æ”¹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>User Data Checkpointæœºåˆ¶</title>
    <link href="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="User-Data-Checkpointæœºåˆ¶-UDC"><a href="#User-Data-Checkpointæœºåˆ¶-UDC" class="headerlink" title="User Data Checkpointæœºåˆ¶(UDC)"></a>User Data Checkpointæœºåˆ¶(UDC)</h1><h2 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1.èƒŒæ™¯"></a>1.èƒŒæ™¯</h2><p>ç”±äºABå‡çº§çš„å›æ»šæœºåˆ¶åªæ”¯æŒåˆ°early_booté˜¶æ®µï¼Œå¦‚æœOTAå‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œdataåˆ†åŒºè¢«ä¿®æ”¹äº†ï¼Œå¹¶ä¸”OTAå‡çº§å¤±è´¥äº†ï¼Œåˆ™dataåˆ†åŒºæ˜¯æ— æ³•å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€çš„ã€‚UDCåŠŸèƒ½æ˜¯ä¸ºäº†è§£å†³OTAå‡çº§å¤±è´¥åï¼Œå½“dataåˆ†åŒºè¢«ä¿®æ”¹åï¼Œä¸æ”¯æŒå›æ»šdataåˆ†åŒºçš„é—®é¢˜ã€‚UDCåŒæ—¶æ”¯æŒç»‘å®škeyç‰ˆæœ¬ä»¥åŠé˜²æ­¢keyå›æ»šçš„åŠŸèƒ½ã€‚</p><h2 id="2-å®ç°UDC"><a href="#2-å®ç°UDC" class="headerlink" title="2.å®ç°UDC"></a>2.å®ç°UDC</h2><blockquote><p>ä¸€å®šè¦å‚è€ƒå®‰å“å®˜ç½‘ï¼š<a href="https://source.android.com/docs/core/ota/user-data-checkpoint?hl=zh-cn">https://source.android.com/docs/core/ota/user-data-checkpoint?hl=zh-cn</a></p></blockquote><h3 id="2-1-è®¾ç½®"><a href="#2-1-è®¾ç½®" class="headerlink" title="2.1 è®¾ç½®"></a>2.1 è®¾ç½®</h3><p>åœ¨ <code>init.hardware.rc</code> æ–‡ä»¶çš„ <code>on fs</code> ä¸­ï¼Œç¡®ä¿æ‚¨å…·æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.$&#123;ro.boot.hardware.platform&#125; --early<br></code></pre></td></tr></table></figure><p>åœ¨ <code>init.hardware.rc</code> æ–‡ä»¶çš„ <code>on late-fs</code> ä¸­ï¼Œç¡®ä¿æ‚¨å…·æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.$&#123;ro.boot.hardware.platform&#125; --late<br></code></pre></td></tr></table></figure><p>åœ¨ <code>fstab.hardware</code> æ–‡ä»¶ä¸­ï¼Œç¡®ä¿å°† <code>/data</code> æ ‡è®°ä¸º <code>latemount</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/bootdevice/by-name/userdata              /data              f2fs<br>noatime,nosuid,nodev,discard,reserve_root=32768,resgid=1065,fsync_mode=nobarrier<br>latemount,wait,check,fileencryption=ice,keydirectory=/metadata/vold/metadata_encryption,quota,formattable,sysfs_path=/sys/devices/platform/soc/1d84000.ufshc,reservedsize=128M,checkpoint=fs<br></code></pre></td></tr></table></figure><h3 id="2-2-æ·»åŠ metadataåˆ†åŒº"><a href="#2-2-æ·»åŠ metadataåˆ†åŒº" class="headerlink" title="2.2 æ·»åŠ metadataåˆ†åŒº"></a>2.2 æ·»åŠ metadataåˆ†åŒº</h3><p>UDC éœ€è¦ä½¿ç”¨ metadata åˆ†åŒºæ¥å­˜å‚¨éå¼•å¯¼åŠ è½½ç¨‹åºé‡è¯•è®¡æ•°å’Œå¯†é’¥ã€‚è®¾ç½® metadata åˆ†åŒºå¹¶æå‰å°†å…¶è£…è½½åœ¨ <code>/metadata</code> ä¸­ã€‚</p><p>åœ¨ <code>fstab.hardware</code> æ–‡ä»¶ä¸­ï¼Œç¡®ä¿å°† <code>/metadata</code> æ ‡è®°ä¸º <code>earlymount</code> æˆ– <code>first_stage_mount</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/by-name/metadata           /metadata           ext4<br>noatime,nosuid,nodev,discard,sync<br>wait,formattable,first_stage_mount<br></code></pre></td></tr></table></figure><p>å°†åˆ†åŒºåˆå§‹åŒ–ä¸ºå…¨é›¶ã€‚</p><p>å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ° <code>BoardConfig.mk</code>ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">BOARD_USES_METADATA_PARTITION := true<br>BOARD_ROOT_EXTRA_FOLDERS := existing_folders metadata<br></code></pre></td></tr></table></figure><h3 id="2-3-æ›´æ–°ç³»ç»Ÿ"><a href="#2-3-æ›´æ–°ç³»ç»Ÿ" class="headerlink" title="2.3 æ›´æ–°ç³»ç»Ÿ"></a>2.3 æ›´æ–°ç³»ç»Ÿ</h3><p><strong>F2FS ç³»ç»Ÿ</strong></p><ul><li><p>å¯¹äºä½¿ç”¨ F2FS æ¥æ ¼å¼åŒ–æ•°æ®çš„ç³»ç»Ÿï¼Œè¯·ç¡®ä¿æ‚¨çš„ F2FS ç‰ˆæœ¬æ”¯æŒæ£€æŸ¥ç‚¹ã€‚</p></li><li><p>å¯¹äºåœ¨ <code>/data</code> è£…è½½çš„è®¾å¤‡ï¼Œè¯·å°† <code>checkpoint=fs</code> æ ‡å¿—æ·»åŠ åˆ° fstab çš„ <code>&lt;fs_mgr_flags&gt;</code> éƒ¨åˆ†ã€‚</p></li></ul><p><strong>é F2FS ç³»ç»Ÿ</strong></p><ul><li>å¯¹äºé F2FS ç³»ç»Ÿï¼Œå¿…é¡»åœ¨å†…æ ¸é…ç½®ä¸­å¯ç”¨ <code>dm-bow</code>ã€‚</li><li>å¯¹äºåœ¨ <code>/data</code> è£…è½½çš„è®¾å¤‡ï¼Œè¯·å°† <code>checkpoint=block</code> æ ‡å¿—æ·»åŠ åˆ° fstab çš„ <code>&lt;fs_mgr_flags&gt;</code> éƒ¨åˆ†ã€‚</li></ul><h2 id="3-f2fsæŒ‚è½½æµç¨‹"><a href="#3-f2fsæŒ‚è½½æµç¨‹" class="headerlink" title="3.f2fsæŒ‚è½½æµç¨‹"></a>3.f2fsæŒ‚è½½æµç¨‹</h2><p>æ—¢ç„¶ä¸Šé¢æåˆ°äº†f2fså¤©ç„¶æ”¯æŒcheckpointï¼Œé‚£æˆ‘ä»¬åˆ†æä¸€ä¸‹å®ƒçš„æŒ‚è½½æµç¨‹</p><h3 id="3-1å¼€å§‹æŒ‚è½½æ‰€æœ‰"><a href="#3-1å¼€å§‹æŒ‚è½½æ‰€æœ‰" class="headerlink" title="3.1å¼€å§‹æŒ‚è½½æ‰€æœ‰"></a>3.1å¼€å§‹æŒ‚è½½æ‰€æœ‰</h3><p>åœ¨rcä¸­ä¼šè°ƒç”¨mount_allæ¥æŒ‚è½½æ‰€æœ‰fstabä¸­çš„entry</p><p>åœ¨<code>device/softwinner/ceres-common/init.sun50iw10p1.rc</code>æ–‡ä»¶çš„on fsä¸­æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mount_all /vendor/etc/fstab.sun50iw10p1 --early<br></code></pre></td></tr></table></figure><p>åœ¨<code>device/softwinner/ceres-b3/fstab.sun50iw10p1.rc</code>æ–‡ä»¶çš„<code>data</code>åˆ†åŒºä¸­æ·»åŠ <code>latemount</code>å’Œ<code>checkpoint=fs</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/dev/block/by-name/UDISK      /data        f2fs     noatime,nosuid,nodev,discard wait,check,formattable,quota,reservedsize=33554432,fileencryption=aes-256-xts:aes-256-cts,latemount,checkpoint=fs<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ä¼šå»è§£æmount_allå¯¹åº”çš„åŠ¨ä½œï¼Œç„¶åå°†<code>/vendor/etc/fstab.sun50iw10p1</code>ä½œä¸ºarg[0]ï¼Œ<code>--early</code>ä½œä¸ºarg[1]ä¼ ç»™mount_allå¯¹åº”çš„å¤„ç†å‡½æ•°<code>do_mount_all</code></p><img src="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/image-20230315202320251.png" alt="image-20230315202320251"><p>åœ¨<code>do_mount_all</code>ä¸­ä¼šè°ƒç”¨fs_mgr_mount_allæŒ‚è½½æ‰€æœ‰<code>/vendor/etc/fstab.sun50iw10p1</code>ä¸­çš„é¡¹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\init\builtins.cpp</span><br><span class="hljs-function"><span class="hljs-type">static</span> Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">do_mount_all</span><span class="hljs-params">(<span class="hljs-type">const</span> BuiltinArguments&amp; args)</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    Fstab fstab;<br>    <span class="hljs-keyword">if</span> (mount_all-&gt;fstab_path.<span class="hljs-built_in">empty</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadDefaultFstab</span>(&amp;fstab)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">&quot;Could not read default fstab&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ä¼šå°†/vendor/etc/fstab.sun50iw10p1ä¸­çš„æ¯ä¸€é¡¹è§£æå¥½æ”¾åœ¨fstabæ•°ç»„ä¸­</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadFstabFromFile</span>(mount_all-&gt;fstab_path, &amp;fstab)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">&quot;Could not read fstab&quot;</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è°ƒç”¨fs_mgr_mount_allæŒ‚è½½æ‰€æœ‰è§£æå‡ºæ¥çš„entry</span><br>    <span class="hljs-keyword">auto</span> mount_fstab_result = <span class="hljs-built_in">fs_mgr_mount_all</span>(&amp;fstab, mount_all-&gt;mode);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-fs-mgr-mount-allåšå¥½å‡†å¤‡å·¥ä½œ"><a href="#3-2-fs-mgr-mount-allåšå¥½å‡†å¤‡å·¥ä½œ" class="headerlink" title="3.2 fs_mgr_mount_allåšå¥½å‡†å¤‡å·¥ä½œ"></a>3.2 fs_mgr_mount_allåšå¥½å‡†å¤‡å·¥ä½œ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">MountAllResult <span class="hljs-title">fs_mgr_mount_all</span><span class="hljs-params">(Fstab* fstab, <span class="hljs-type">int</span> mount_mode)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(fstab-&gt;<span class="hljs-built_in">size</span>()); i++) &#123;<br>        <span class="hljs-keyword">auto</span>&amp; current_entry = (*fstab)[i];<br>        <span class="hljs-comment">// è°ƒç”¨checkpoint_managerçš„Updateæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (!checkpoint_manager.<span class="hljs-built_in">Update</span>(&amp;current_entry)) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// system\core\fs_mgr\fs_mgr.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Update</span><span class="hljs-params">(FstabEntry* entry, <span class="hljs-type">const</span> std::string&amp; block_device = std::string())</span> </span>&#123;<br>    <span class="hljs-comment">// fs_mgr_flagsæ˜¯å¦åŒ…å«checkpoint=fsæˆ–checkpoint=blk</span><br>    <span class="hljs-comment">// æ˜¾ç„¶åŒ…å«</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SupportsCheckpoint</span>(entry)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ***********************è¿™é‡Œæ˜¯æœ€é‡è¦çš„***********************</span><br>    <span class="hljs-comment">// ***********************è¿™é‡Œæ˜¯æœ€é‡è¦çš„***********************</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">NeedsCheckpoint</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">UpdateCheckpointPartition</span>(entry, block_device)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Could not set up checkpoint partition, skipping!&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-1-NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint"><a href="#3-2-1-NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint" class="headerlink" title="3.2.1 NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint"></a>3.2.1 NeedsCheckpointåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥Checkpoint</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\core\fs_mgr\fs_mgr.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">NeedsCheckpoint</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// è°ƒç”¨vdcäºŒè¿›åˆ¶ï¼Œä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°checkpoint,ç¬¬äºŒä¸ªå‚æ•°needsCheckpointï¼Œæœ€ç»ˆå›è°ƒçš„ç»“æœæ˜¯needs_checkpoint_</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">call_vdc</span>(&#123;<span class="hljs-string">&quot;checkpoint&quot;</span>, <span class="hljs-string">&quot;needsCheckpoint&quot;</span>&#125;, &amp;needs_checkpoint_)) &#123;<br>        LERROR &lt;&lt; <span class="hljs-string">&quot;Failed to find if checkpointing is needed. Assuming no.&quot;</span>;<br>        needs_checkpoint_ = NO;<br>    &#125;<br>    <span class="hljs-keyword">return</span> needs_checkpoint_ == YES;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>vdc</strong>äºŒè¿›åˆ¶ç¼–è¯‘å®Œä»¥åä½äº<code>out/target/product/[productName]</code>ä¸­</p><img src="/2023/03/15/User-Data-Checkpoint%E6%9C%BA%E5%88%B6/image-20230315204223717.png" alt="image-20230315204223717" style="zoom:50%;"><p>ä¸‹é¢çœ‹ä¸€ä¸‹å®ƒçš„mainå…¥å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// system\vold\vdc.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (xxx) &#123;<br>        <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;checkpoint&quot;</span> &amp;&amp; args[<span class="hljs-number">1</span>] == <span class="hljs-string">&quot;needsCheckpoint&quot;</span> &amp;&amp; args.<span class="hljs-built_in">size</span>() == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">bool</span> enabled = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// è°ƒç”¨needsCheckpointæ–¹æ³•</span><br>        <span class="hljs-built_in">checkStatus</span>(args, vold-&gt;<span class="hljs-built_in">needsCheckpoint</span>(&amp;enabled));<br>        <span class="hljs-keyword">return</span> enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::needsCheckpoint</span><span class="hljs-params">(<span class="hljs-type">bool</span>* _aidl_return)</span> </span>&#123;<br>    *_aidl_return = <span class="hljs-built_in">cp_needsCheckpoint</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Ok</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cp_needsCheckpoint</span><span class="hljs-params">()</span> </span>&#123;<br><br>    sp&lt;IBootControl&gt; <span class="hljs-keyword">module</span> = IBootControl::<span class="hljs-built_in">getService</span>();<br><br>    <span class="hljs-keyword">if</span> (isCheckpointing) <span class="hljs-keyword">return</span> isCheckpointing;<br><br>    <span class="hljs-comment">// è°ƒç”¨bootctlçš„isSlotMarkedSuccessfulæ–¹æ³•</span><br>    <span class="hljs-comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œé‚£å¿…ç„¶bootåˆ†åŒºæ²¡æœ‰succæ ‡è®°</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> &amp;&amp; <span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">isSlotMarkedSuccessful</span>(<span class="hljs-keyword">module</span>-&gt;<span class="hljs-built_in">getCurrentSlot</span>()) == BoolResult::FALSE) &#123;<br>        isCheckpointing = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>å¦‚æœæ˜¯OTAå‡çº§é˜¶æ®µæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åˆ·å›ºä»¶çš„æ—¶å€™ï¼ˆè°ƒç”¨boot_ctrlåˆ¤æ–­å½“å‰slotæ˜¯å¦å·²ç»Marked Successfuläº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¡¨æ˜æ­¤æ—¶å¤„äºOTAå‡çº§é˜¶æ®µæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡åˆ·å›ºä»¶çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œcheckpointï¼‰ï¼Œåˆ™è¿”å›trueï¼›æ­£å¸¸æƒ…å†µå°±æ˜¯falseï¼›</strong></p><h4 id="3-2-2-UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹"><a href="#3-2-2-UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹" class="headerlink" title="3.2.2 UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹"></a>3.2.2 UpdateCheckpointPartitionæ›´æ–°æŒ‚è½½opté€‰é¡¹</h4><p>å¦‚æœNeedsCheckpointä¸ºTrueï¼Œè°ƒç”¨UpdateCheckpointPartition</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">UpdateCheckpointPartition</span><span class="hljs-params">(FstabEntry* entry, <span class="hljs-type">const</span> std::string&amp; block_device)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (entry-&gt;fs_mgr_flags.checkpoint_fs) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_f2fs</span>(entry-&gt;fs_type)) &#123;<br>            <span class="hljs-comment">// ä¼šåœ¨è¿™é‡Œæ·»åŠ checkpoint=disable</span><br>            entry-&gt;fs_checkpoint_opts = <span class="hljs-string">&quot;,checkpoint=disable&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-mount-with-alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½"><a href="#3-3-mount-with-alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½" class="headerlink" title="3.3 mount_with_alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½"></a>3.3 mount_with_alternativesæ‰§è¡ŒçœŸæ­£çš„æŒ‚è½½</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">mount_with_alternatives</span><span class="hljs-params">(<span class="hljs-type">const</span> Fstab&amp; fstab, <span class="hljs-type">int</span> start_idx, <span class="hljs-type">int</span>* end_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                                    <span class="hljs-type">int</span>* attempted_idx)</span> </span>&#123;<br>    <span class="hljs-comment">// æ€»å…±å°è¯•2æ¬¡</span><br> <span class="hljs-type">int</span> retry_count = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">while</span> (retry_count-- &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨__mountå¼€å§‹çœŸæ­£çš„æŒ‚è½½</span><br>        <span class="hljs-keyword">if</span> (!__mount(fstab[i].blk_device, fstab[i].mount_point, fstab[i])) &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4.å‚è€ƒ"></a>4.å‚è€ƒ</h2><blockquote><p> ğŸ­ å‚è€ƒå¤§ç¥pyjestonï¼š<a href="https://www.cnblogs.com/pyjetson/p/14682457.html">https://www.cnblogs.com/pyjetson/p/14682457.html</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ"></a>åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿ</h1><blockquote><p>ğŸ‰ <strong>å‚è€ƒåšå®¢</strong>ï¼š<a href="https://www.jianshu.com/p/8966d121263b">https://www.jianshu.com/p/8966d121263b</a></p><p>ğŸ’ <strong>é¡¹ç›®åœ°å€</strong>ï¼š<a href="https://github.com/ZhangShurong/HUST_OS_fs_experiment">https://github.com/ZhangShurong/HUST_OS_fs_experiment</a></p><p>ğŸ <strong>æ–‡ä»¶ç³»ç»Ÿå‰ç½®çŸ¥è¯†ï¼š</strong><a href="https://blog.csdn.net/u012489236/article/details/123834123?spm=1001.2014.3001.5506">https://blog.csdn.net/u012489236/article/details/123834123?spm=1001.2014.3001.5506</a></p></blockquote><h2 id="0-ä¸‹è½½è¿è¡Œ"><a href="#0-ä¸‹è½½è¿è¡Œ" class="headerlink" title="0.ä¸‹è½½è¿è¡Œ"></a>0.ä¸‹è½½è¿è¡Œ</h2><p>æŒ‰ç…§<code>Readme.md</code>æ‰§è¡Œä»¥åï¼Œå¯ä»¥çœ‹åˆ°å…·æœ‰äº†ä¸€ä¸ªåŸºç¡€æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ï¼š</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311221220446.png" alt="image-20230311221220446" style="zoom: 67%;"><p>å¦‚æœæœ‰ç¼–è¯‘æŠ¥é”™ï¼Œæœ‰å…³äºtimepescç±»å‹è½¬æ¢çš„ï¼›è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311224039035.png" alt="image-20230311224039035" style="zoom: 55%;"><h2 id="1-æ€»ä½“è®¾è®¡"><a href="#1-æ€»ä½“è®¾è®¡" class="headerlink" title="1.æ€»ä½“è®¾è®¡"></a>1.æ€»ä½“è®¾è®¡</h2><p>æœ¬æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ç»“æ„å‚è€ƒminixçš„æ–‡ä»¶ç³»ç»Ÿå®ç°ã€‚ä½†æ˜¯è‡ªä¸¾å—ï¼ˆæˆ–ç§°å¼•å¯¼å—ï¼‰ä¸­æ²¡æœ‰æ•°æ®ã€‚ä¸”ä¸é‡‡ç”¨äºŒçº§æˆ–è€…å¤šçº§ç´¢å¼•ï¼Œå…¶ç»“æ„å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">|Dummy Block|Super Block|IMap|BMap|Inode Table|Data blocks|<br></code></pre></td></tr></table></figure><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230312230337246.png" alt="image-20230312230337246" style="zoom:67%;"><p>å…¶ä¸­æ¯ä¸ªå—çš„å¤§å°å®šä¹‰ä¸º4096bytesï¼Œæ¯ä¸ªInodeå«æœ‰10ä¸ªå—æ‰€ä»¥å•ä¸ªæ–‡ä»¶æœ€å¤§ä¸º40KBï¼Œæ”¯æŒçš„æœ€å°ç£ç›˜å¤§å°ä¸º24Kã€‚ä»¥ä¸‹è¯¦ç»†é˜è¿°æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€éœ€è¦çš„ä¸‰ä¸ªåŸºæœ¬æ•°æ®ç»“æ„ã€‚</p><h3 id="1-1-è¶…çº§å—ç»“æ„"><a href="#1-1-è¶…çº§å—ç»“æ„" class="headerlink" title="1.1 è¶…çº§å—ç»“æ„"></a>1.1 è¶…çº§å—ç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_fs_super_block</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> version;<br>    <span class="hljs-type">uint64_t</span> magic;<br>    <span class="hljs-type">uint64_t</span> block_size;<br>    <span class="hljs-type">uint64_t</span> inodes_count;<br>    <span class="hljs-type">uint64_t</span> free_blocks;<br>    <span class="hljs-type">uint64_t</span> blocks_count;<br>    <span class="hljs-type">uint64_t</span> bmap_block;<br>    <span class="hljs-type">uint64_t</span> imap_block;<br>    <span class="hljs-type">uint64_t</span> inode_table_block;<br>    <span class="hljs-type">uint64_t</span> data_block_number;<br>    <span class="hljs-type">char</span> padding[<span class="hljs-number">4016</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¶…çº§å—ä¸­çš„paddingæ•°ç»„ï¼Œæ˜¯ä¸ºäº†ä½¿è¶…çº§å—çš„å¤§å°ä¸º4096bytesï¼Œä»¥ç®€åŒ–åæœŸçš„å·¥ä½œï¼›â€œMagicâ€ä¸º1314522ï¼›indoe_countè®°å½•æ–‡ä»¶ç³»ç»Ÿæ‰€æ”¯æŒçš„inodeä¸ªæ•°ï¼Œè¿™ä¸ªå€¼åœ¨æ ¼å¼åŒ–æ—¶å°±å·²ç»è®¡ç®—å¹¶å†™å…¥è¶…çº§å—äº†ã€‚Bmap_blockè®°å½•ç€bmapå¼€å§‹çš„æ•°æ®å—ç´¢å¼•,imap_blockï¼Œinode_table_blockå’Œdata_block_numberåŒç†ï¼Œè®°å½•ç´¢å¼•æ˜¯ä¸ºäº†ç®€åŒ–æ–‡ä»¶å—çš„å®šä½æ“ä½œã€‚</p><h3 id="1-2-HUST-inodeç»“æ„"><a href="#1-2-HUST-inodeç»“æ„" class="headerlink" title="1.2 HUST_inodeç»“æ„"></a>1.2 HUST_inodeç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> &#123;</span>  <br>    <span class="hljs-type">mode_t</span> mode; <span class="hljs-comment">//sizeof(mode_t) is 4  </span><br>    <span class="hljs-type">uint64_t</span> inode_no;  <br>    <span class="hljs-type">uint64_t</span> blocks;  <br>    <span class="hljs-type">uint64_t</span> block[HUST_N_BLOCKS];  <br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>  <br>        <span class="hljs-type">uint64_t</span> file_size;  <br>        <span class="hljs-type">uint64_t</span> dir_children_count;  <br>    &#125;;  <br>    <span class="hljs-type">int32_t</span> i_uid;   <br>    <span class="hljs-type">int32_t</span> i_gid;  <br>    <span class="hljs-type">int32_t</span> i_nlink;  <br>    <span class="hljs-type">int64_t</span> i_atime;  <br>    <span class="hljs-type">int64_t</span> i_mtime;  <br>    <span class="hljs-type">int64_t</span> i_ctime;  <br>    <span class="hljs-type">char</span> padding[<span class="hljs-number">112</span>];  <br>&#125;;  <br></code></pre></td></tr></table></figure><p>HUST_inodeå¯¹åº”ç€ç£ç›˜ä¸Šçš„inodeç»“æ„ï¼Œåœ¨åæ–‡ä¼šæè¿°å®ƒæ˜¯å¦‚ä½•è½¬æ¢ä¸ºVFSä¸­çš„inodeçš„ã€‚åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­ï¼Œmodeä»£è¡¨è¯¥inodeæ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼Œblocksä»£è¡¨è¯¥inodeçš„å¤§å°ï¼ˆæ‰€å å—çš„æ•°ç›®ï¼‰ï¼Œi_uidå’Œi_gidç”¨äºåé¢çš„å¤šç”¨æˆ·ç®¡ç†ã€‚Paddingæ•°ç»„æ˜¯ä¸ºäº†è®©HUST_inodeç»“æ„ä½“èƒ½å¤Ÿè¢«4096æ•´é™¤ï¼›å®HUST_N_BLOCKè¢«å®šä¹‰ä¸º10ï¼Œæ„å‘³ç€æ¯ä¸ªæ–‡ä»¶ï¼ˆç›®å½•ï¼‰æœ€å¤§çš„å¤§å°ä¸º10ä¸ªå—ï¼›blockæ•°ç»„å­˜å‚¨ç€æ¯ä¸ªå—çš„ç´¢å¼•ï¼Œç”¨äºå®šä½æ–‡ä»¶ã€‚</p><h3 id="1-3-æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„"><a href="#1-3-æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„" class="headerlink" title="1.3 æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„"></a>1.3 æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_dir_record</span> &#123;</span>  <br>    <span class="hljs-type">char</span> filename[HUST_FILENAME_MAX_LEN];  <br>    <span class="hljs-type">uint64_t</span> inode_no;  <br>&#125;;<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶è®°å½•æ˜¯ä¸ºäº†å‚¨å­˜ç›®å½•é¡¹ï¼Œå…¶ä¸­HUST_FILENAME_MAX_LENå®šä¹‰ä¸º256ä¹Ÿå°±æ˜¯è¯´ï¼Œæ–‡ä»¶åæœ€å¤§é•¿åº¦256ã€‚<br> ç¼–å†™æ–‡ä»¶ç³»ç»Ÿé™¤äº†è®¾è®¡æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ç»“æ„ï¼Œå®šä¹‰æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„æ“ä½œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ï¼Œè¿™ä¸ªç›´æ¥å½±å“äº†æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ã€‚æœ¬æ–‡ä»¶ç³»ç»Ÿæ”¯æŒåŸºæœ¬çš„æ–‡ä»¶çš„å¢åˆ æ”¹æŸ¥ï¼Œå¤šç”¨æˆ·ç­‰åŠŸèƒ½ï¼Œä½†æ˜¯ä¸æ”¯æŒæ–‡ä»¶çš„ç§»åŠ¨ï¼Œè½¯ç¡¬é“¾æ¥ç­‰æ“ä½œã€‚</p><h2 id="2-mkfsçš„å®ç°"><a href="#2-mkfsçš„å®ç°" class="headerlink" title="2.mkfsçš„å®ç°"></a>2.mkfsçš„å®ç°</h2><p>è¦ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ªç¬¦åˆç£ç›˜å¸ƒå±€çš„æ˜ åƒæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ ¼å¼åŒ–ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºæŒ‰ç…§æƒ¯ä¾‹å«åšmkfsã€‚æœ¬èŠ‚è¯¦ç»†æè¿°mkfsçš„å®ç°ã€‚</p><p>mkfsçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æ”¹å†™æˆå¯¹åº”äºæˆ‘ä»¬æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ï¼Œå…¶ä¸»è¦åŠŸèƒ½ç‚¹ä¸º<strong>å†™å…¥è¶…çº§å—ï¼Œå†™å…¥imap,bmapï¼Œå†™å…¥inode table</strong>ï¼Œä»¥åŠåˆ›å»ºä¸€ä¸ªæ ¹ç›®å½•å’Œæµ‹è¯•æ–‡ä»¶ã€‚</p><p>è¶…çº§å—åŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬ä¿¡æ¯ï¼Œå…¶ä¿¡æ¯åœ¨ä¸Šæ–‡ä¸­æœ‰è¯¦ç»†æè¿°ã€‚å†™å…¥è¶…çº§å—ä¿¡æ¯ï¼Œéœ€è¦è®¡ç®—æ•´ä¸ªç£ç›˜çš„å¤§å°ï¼Œç„¶åè®¡ç®—imapï¼Œbmapä»¥åŠinode tableçš„å¤§å°ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šå„ä¸ªåŒºåŸŸåœ¨ç£ç›˜ä¸­çš„ä½ç½®ã€‚è¿™äº›å·¥ä½œéƒ½æ˜¯åœ¨init_diskè¿™ä¸ªå‡½æ•°ä¸­å®Œæˆçš„ã€‚åŸºæœ¬é€»è¾‘ä¸ºè¯»å–éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶å¤§å°ï¼Œè®¡ç®—å‡ºæ•´ä¸ªç£ç›˜ä¸­çš„å—çš„ä¸ªæ•°ï¼Œç®€å•çš„å°†å—çš„ä¸ªæ•°ä¸inodeçš„ä¸ªæ•°ç­‰åŒèµ·æ¥ï¼›ç„¶åé€šè¿‡å—æ•°ä»¥åŠinodeä¸ªæ•°è®¡ç®—imapå’Œbmapçš„å¤§å°ã€‚å…¶ä¸­bmapçš„å¤§å°å¦‚ä¸‹ï¼ˆimapå¤§å°è®¡ç®—å…¬å¼ä¸bmapä¸€è‡´ï¼‰ï¼š<br>$$<br>bmapsize &#x3D; blockcount&#x2F; HUST_BLOCKSIZE * 8<br>$$<br>å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_disk</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span>  <br>&#123;  <br>    <span class="hljs-comment">//è·å–åŸºæœ¬ä¿¡æ¯  </span><br>    <span class="hljs-comment">//... ...  </span><br>    <span class="hljs-comment">//è®¡ç®—bmap  </span><br>    bmap_size = super_block.blocks_count/(<span class="hljs-number">8</span>*HUST_BLOCKSIZE);  <br>    super_block.bmap_block = RESERVE_BLOCKS;  <br>  <br>    <span class="hljs-keyword">if</span> (super_block.blocks_count%(<span class="hljs-number">8</span>*HUST_BLOCKSIZE) != <span class="hljs-number">0</span>) &#123;  <br>        bmap_size += <span class="hljs-number">1</span>;  <br>    &#125;  <br>    bmap = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(bmap_size*HUST_BLOCKSIZE);  <span class="hljs-comment">// å•ä½æ˜¯å—</span><br>    <span class="hljs-built_in">memset</span>(bmap,<span class="hljs-number">0</span>,bmap_size*HUST_BLOCKSIZE);  <br>  <br>    <span class="hljs-comment">//è®¡ç®—imap  </span><br>    imap_size = super_block.inodes_count/(<span class="hljs-number">8</span>*HUST_BLOCKSIZE);  <span class="hljs-comment">// å•ä½æ˜¯å—</span><br>    super_block.imap_block = super_block.bmap_block + bmap_size;  <br> <br>    <span class="hljs-keyword">if</span>(super_block.inodes_count%(<span class="hljs-number">8</span>*HUST_BLOCKSIZE) != <span class="hljs-number">0</span>) &#123;  <br>        imap_size += <span class="hljs-number">1</span>;  <br>    &#125;  <br>    imap = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(imap_size*HUST_BLOCKSIZE);  <br>    <span class="hljs-built_in">memset</span>(imap,<span class="hljs-number">0</span>,imap_size*HUST_BLOCKSIZE);  <br>  <br>    <span class="hljs-comment">//è®¡ç®—inode_table  </span><br>    inode_table_size = super_block.inodes_count/(HUST_BLOCKSIZE/HUST_INODE_SIZE);  <br>    super_block.inode_table_block = super_block.imap_block + imap_size;  <br>    super_block.data_block_number = RESERVE_BLOCKS + bmap_size + imap_size + inode_table_size;  <br>    super_block.free_blocks = super_block.blocks_count - super_block.data_block_number - <span class="hljs-number">1</span>;  <br><br>    <span class="hljs-comment">// è®¾ç½®bmapä»¥åŠimap  </span><br>    <span class="hljs-comment">// ... ...  </span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œimapå’Œbmapä¸ºuint8_tçš„å…¨å±€æ•°ç»„ã€‚</p><p>è®¡ç®—å®ŒåŸºæœ¬ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å†™å…¥æ–‡ä»¶å¹¶åˆ›å»ºæ ¹ç›®å½•å’Œæµ‹è¯•æ–‡ä»¶ã€‚æ–‡ä»¶åˆ›å»ºçš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>æ£€æµ‹ï¼ˆè·å–ï¼‰ç£ç›˜ï¼ˆæ–‡ä»¶ï¼‰å¤§å°ï¼Œç¡®è®¤æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´</li><li>æ‰¾çš„ç©ºé—²çš„inodeå’Œblockï¼Œå¹¶æ ‡è®°imapå’Œbmapã€‚</li><li>ç”Ÿæˆç›¸åº”çš„æ•°æ®ï¼Œå¹¶å†™å…¥å¯¹åº”çš„å—ä¸­ã€‚å¯¹äºæ ¹ç›®å½•æ¥è®²ï¼Œå†™å…¥çš„æ•°æ®ä¸ºä¸‰ä¸ªç›®å½•é¡¹ï¼Œç›®å½•é¡¹çš„å†…å®¹ä¸ºæ–‡ä»¶ï¼ˆç›®å½•ï¼‰åä»¥åŠå¯¹åº”çš„inodeç¼–å·ã€‚ç¬¬ä¸€ä¸ªç›®å½•é¡¹ä¸ºå½“å‰ç›®å½•å’Œå¯¹åº”çš„inodeç¼–å·0ï¼Œç¬¬äºŒä¸ªç›®å½•é¡¹ä¸ºä¸Šä¸€çº§ç›®å½•å’Œå¯¹åº”çš„inodeç¼–å·0ï¼Œç¬¬ä¸‰ä¸ªç›®å½•é¡¹ä¸ºæ¬¢è¿æ–‡ä»¶ï¼Œå†…å®¹ä¸ºæ–‡ä»¶åâ€œfileâ€å’Œå¯¹åº”çš„inodeç¼–å·1ã€‚</li><li>è®¾ç½®å¯¹åº”çš„inodeä¿¡æ¯ï¼Œå¦‚æ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼ˆmodeä¿¡æ¯ï¼‰ï¼Œåˆ›å»ºæ—¶é—´ä¿®æ”¹æ—¶é—´(i_ctimeå’Œi_mtime)ï¼Œç”¨æˆ·idå’Œç»„idä¿¡æ¯ï¼ˆi_uidå’Œi_gidï¼‰ç­‰ã€‚</li><li>æ›´æ–°è¶…çº§å—ä¿¡æ¯ã€‚</li></ol><p>åœ¨æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿå†™å®Œä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ¥æµ‹è¯•æˆ‘ä»¬çš„mkfsæ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œï¼Œé€šè¿‡16è¿›åˆ¶ç¼–è¾‘å™¨æ¥æŸ¥çœ‹æ˜¯å¦åŠŸèƒ½æ­£å¸¸ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>è¿è¡Œä¸‹åˆ—å‘½ä»¤åˆ›å»ºæ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">dd bs=4096 count=100 if=/dev/zero of=image <br><br>- if=æ–‡ä»¶åï¼šè¾“å…¥æ–‡ä»¶åï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ã€‚å³æŒ‡å®šæºæ–‡ä»¶ã€‚<br>- of=æ–‡ä»¶åï¼šè¾“å‡ºæ–‡ä»¶åï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºã€‚å³æŒ‡å®šç›®çš„æ–‡ä»¶ã€‚<br>- bs=bytesï¼šåŒæ—¶è®¾ç½®è¯»å…¥/è¾“å‡ºçš„å—å¤§å°ä¸ºbytesä¸ªå­—èŠ‚ã€‚<br>- count=blocksï¼šä»…æ‹·è´blocksä¸ªå—ï¼Œå—å¤§å°ç­‰äºbsæŒ‡å®šçš„å­—èŠ‚æ•°ã€‚<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘mkfs.c</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc mkfs.c -o mkfs <br></code></pre></td></tr></table></figure><ul><li>æ ¼å¼åŒ–imageæ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./mkfs ./image<br></code></pre></td></tr></table></figure><ul><li>é€šè¿‡hexdumpæ¥æŸ¥çœ‹æ–‡ä»¶çš„ç»“æ„ï¼Œç»“æœå¦‚ä¸‹å›¾ã€‚é€šè¿‡æ£€æŸ¥ï¼Œæˆ‘ä»¬å‘ç°ï¼Œimageæ–‡ä»¶ç»“æ„å†™å…¥æ­£ç¡®æ— è¯¯ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">amx@amxxxx:~/Desktop/simple_fs$ hexdump ./image <br><span class="hljs-number">0000000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0001000</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0</span>eda <span class="hljs-number">0014</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>  <span class="hljs-comment">/* HUST_fsæ–‡ä»¶ç³»ç»Ÿçš„magicä¸º1314522 */</span><br><span class="hljs-number">0001010</span> <span class="hljs-number">1000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0064</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001020</span> <span class="hljs-number">0059</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0064</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001030</span> <span class="hljs-number">0002</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001040</span> <span class="hljs-number">0004</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0001050</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0002000</span> <span class="hljs-number">07f</span>f <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0002010</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0003000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0003010</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0004000</span> <span class="hljs-number">4000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004010</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004020</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br>*<br><span class="hljs-number">0004040</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">24</span>ed <span class="hljs-number">4</span>c27 <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004050</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">3760</span> <span class="hljs-number">4</span>c3b <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004060</span> <span class="hljs-number">0</span>d68 <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0003</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004070</span> <span class="hljs-number">03e8</span> <span class="hljs-number">0000</span> <span class="hljs-number">03e8</span> <span class="hljs-number">0000</span> <span class="hljs-number">0002</span> <span class="hljs-number">0000</span> <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br><span class="hljs-number">0004080</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">0004090</span> <span class="hljs-number">8f</span>e7 <span class="hljs-number">640</span>c <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">3848</span> <span class="hljs-number">4</span>c3b <span class="hljs-number">7f</span>f3 <span class="hljs-number">0000</span><br>...............................................<br>amx@amxxxx:~/Desktop/simple_fs$ <br></code></pre></td></tr></table></figure><h2 id="3-æ–‡ä»¶ç³»ç»Ÿçš„å®ç°"><a href="#3-æ–‡ä»¶ç³»ç»Ÿçš„å®ç°" class="headerlink" title="3.æ–‡ä»¶ç³»ç»Ÿçš„å®ç°"></a>3.æ–‡ä»¶ç³»ç»Ÿçš„å®ç°</h2><p>ä¸€ä¸ªé€šå¸¸æ„ä¹‰ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨å¯ä»¥å•ç‹¬è¢«ç¼–è¯‘æˆæ¨¡å—åŠ¨æ€åŠ è½½ï¼Œä¹Ÿå¯ä»¥è¢«ç›´æ¥ç¼–è¯‘åˆ°å†…æ ¸ä¸­ï¼Œä¸ºäº†è°ƒè¯•çš„æ–¹ä¾¿ï¼Œæœ¬æ–‡ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé‡‡ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼å®ç°ã€‚å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿…é¡»éµç…§å†…æ ¸çš„ä¸€äº›â€œè§„åˆ™â€ï¼Œä»¥ä¸‹æˆ‘å°†ä»¥é€’è¿›çš„é¡ºåºé˜è¿°æ–‡ä»¶ç³»ç»Ÿçš„å®ç°è¿‡ç¨‹ã€‚</p><h3 id="3-1-æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½"><a href="#3-1-æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½" class="headerlink" title="3.1 æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½"></a>3.1 æ–‡ä»¶ç³»ç»Ÿçš„åŠ è½½ä¸å¸è½½</h3><p>é¦–å…ˆä¸ºäº†èƒ½å¤ŸæˆåŠŸåŠ è½½æ–‡ä»¶ç³»ç»Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦æä¾›æ–‡ä»¶ç³»ç»Ÿçš„åå­—ï¼Œè¶…çº§å—çš„åŠ è½½å’Œåˆ é™¤æ–¹æ³•ã€‚è¿™äº›ä¸œè¥¿ååº”åœ¨<code>file_system_type</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">HUST_fs_type</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .name = <span class="hljs-string">&quot;HUST_fs&quot;</span>,  <br>    .mount = HUST_fs_mount,  <br>    .kill_sb = HUST_fs_kill_superblock, <span class="hljs-comment">/* unmount */</span>  <br>&#125;;  <br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ç³»ç»Ÿä½œä¸ºä¸€ç§å—è®¾å¤‡é©±åŠ¨ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦å®ç°module_initä»¥åŠmocule_exitã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called when the module is loaded. */</span>  <br><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> ret;  <br>    ret = register_filesystem(&amp;HUST_fs_type);  <br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)  <br>        printk(KERN_INFO <span class="hljs-string">&quot;Sucessfully registered HUST_fs\n&quot;</span>);  <br>    <span class="hljs-keyword">else</span>  <br>        printk(KERN_ERR <span class="hljs-string">&quot;Failed to register HUST_fs. Error: [%d]\n&quot;</span>, ret);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;  <br>  <br><span class="hljs-comment">/* Called when the module is unloaded. */</span>  <br><span class="hljs-type">void</span> <span class="hljs-title function_">HUST_fs_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>  <br><br>    <span class="hljs-type">int</span> ret;  <br>    ret = unregister_filesystem(&amp;HUST_fs_type);  <br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)  <br>        printk(KERN_INFO <span class="hljs-string">&quot;Sucessfully unregistered HUST_fs\n&quot;</span>);  <br>    <span class="hljs-keyword">else</span>  <br>        printk(KERN_ERR <span class="hljs-string">&quot;Failed to unregister HUST_fs. Error: [%d]\n&quot;</span>, ret);  <br>&#125;  <br>module_init(HUST_fs_init);  <br>module_exit(HUST_fs_exit);  <br>  <br>MODULE_LICENSE(<span class="hljs-string">&quot;MIT&quot;</span>);  <br>MODULE_AUTHOR(<span class="hljs-string">&quot;cv&quot;</span>); <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¾å¤‡é©±åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œé©±åŠ¨å‘å†…æ ¸æ³¨å†Œäº†æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œé©±åŠ¨å¸è½½çš„æ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ä¹Ÿè¢«åˆ é™¤ã€‚æ–‡ä»¶ç³»ç»ŸåŠ è½½æ—¶è°ƒç”¨çš„å‡½æ•°ä¸ºHUST_fs_mountï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªå‡½æ•°å‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_fill_super</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> silent)</span>  <br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ä¸VFSäº¤äº’ä»è€Œç”ŸæˆVFSè¶…çº§å—çš„ã€‚åœ¨HUST fsä¸­ï¼Œè¶…çº§å—åœ¨ç£ç›˜çš„ç¬¬äºŒä¸ª4096å­—èŠ‚ä¸Šï¼Œå³å—å·ä¸º1ã€‚è¿™ä¸ªå‡½æ•°æ‰§è¡Œæ—¶ä¼šä»ç£ç›˜ä¸­è¯»å–ä¿¡æ¯ï¼Œå¡«å……åˆ°VFSæä¾›çš„è¶…çº§å—ç»“æ„ä½“ä¸­ï¼Œä¸‹åˆ—ä¸ºéƒ¨åˆ†å…³é”®ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_fill_super</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block *sb, <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> silent)</span>  &#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_head</span> *<span class="hljs-title">bh</span>;</span>  <br>    bh = sb_bread(sb, <span class="hljs-number">1</span>);  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_fs_super_block</span> *<span class="hljs-title">sb_disk</span>;</span>  <br>    sb_disk = (<span class="hljs-keyword">struct</span> HUST_fs_super_block *)bh-&gt;b_data;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">root_inode</span>;</span>  <br>    <span class="hljs-keyword">if</span> (sb_disk-&gt;block_size != <span class="hljs-number">4096</span>) &#123;  <br>        printk(KERN_ERR <span class="hljs-string">&quot;HUST_fs expects a blocksize of %d\n&quot;</span>, <span class="hljs-number">4096</span>);  <br>        ret = -EFAULT;  <br>        <span class="hljs-keyword">goto</span> release;  <br>   &#125;  <br>   <span class="hljs-comment">//fill vfs super block  </span><br>    sb-&gt;s_magic = sb_disk-&gt;magic;  <br>    sb-&gt;s_fs_info = sb_disk;  <br>    sb-&gt;s_maxbytes = HUST_BLOCKSIZE * HUST_N_BLOCKS; <span class="hljs-comment">/* Max file size */</span>  <br>    sb-&gt;s_op = &amp;HUST_fs_super_ops;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ç”¨sb_readæ¥è¯»å–ç£ç›˜ä¸Šçš„å†…å®¹ï¼Œç„¶åå¡«å……super_blockç»“æ„ä½“ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæœ‰å…³è¶…çº§å—çš„æ“ä½œå‡½æ•°å³superblock_operationsä¹Ÿæ˜¯åœ¨æ­¤å¤„èµ‹å€¼çš„ã€‚ç”±äºsuper_block* sbåœ¨æ–‡ä»¶ç³»ç»Ÿå¸è½½ä¹‹å‰æ˜¯ä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨s_fs_infoæ¥å­˜å‚¨åŸå§‹çš„è¶…çº§å—ä¿¡æ¯ï¼Œé¿å…åæœŸäº¤äº’æ—¶ å†æ¬¡è¯»å–ç£ç›˜ã€‚</p><p>æ–‡ä»¶ç³»ç»Ÿå¸è½½çš„æ—¶å€™è¶…çº§å—ä¿¡æ¯éœ€è¦è¢«åˆ é™¤ï¼Œæ‰€ä»¥HUST_fs_kill_superblockçš„ä½œç”¨æ—¶é‡Šæ”¾è¯¥è¶…çº§å—ï¼Œé€šçŸ¥VFSè¯¥æŒ‚è½½ç‚¹å·²ç»å¸è½½ã€‚</p><p>å®ç°åŸºæœ¬å‡½æ•°åï¼Œå¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒ‚è½½æ“ä½œï¼ŒæŒ‚è½½æ“ä½œçš„è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">sudo umount ./test  <br>sudo rmmod HUST_fs  <br>dd bs=<span class="hljs-number">4096</span> count=<span class="hljs-number">100</span> <span class="hljs-keyword">if</span>=/dev/zero of=image  <br>./mkfs image  <br>insmod HUST_fs.ko  <br>mount -o loop -t HUST_fs image ./test  <br>dmesg<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»ç¬¬0èŠ‚å¯ä»¥çœ‹åˆ°æŒ‚è½½æˆåŠŸ</p><h3 id="3-2-lså‘½ä»¤çš„å®ç°"><a href="#3-2-lså‘½ä»¤çš„å®ç°" class="headerlink" title="3.2  lså‘½ä»¤çš„å®ç°"></a>3.2  lså‘½ä»¤çš„å®ç°</h3><p>åŠ è½½æ–‡ä»¶ç³»ç»Ÿä¹‹åç¬¬ä¸€ä¸ªè¦å®ç°çš„åŠŸèƒ½æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥é€‰æ‹©å®ç°æ–‡ä»¶å¤¹è¯»å–æ“ä½œï¼Œè¿™ä¸€æ“ä½œåœ¨2.xå†…æ ¸ä¸­æ˜¯<code>.readdir</code>å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­æ˜¯<code>.iterate</code>å‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªæŒ‡é’ˆåœ¨ä¿å­˜åœ¨file_operationä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">HUST_fs_dir_ops</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .iterate = HUST_fs_iterate,  <br>&#125;; <br></code></pre></td></tr></table></figure><p>HUST_fs_iterateå‡½æ•°ä¸»è¦åŠŸèƒ½é€»è¾‘æ˜¯è¯»å–inodeçš„å—æ•°æ®ï¼Œå¹¶ä¸”å°†å—æ•°æ®ä¸­çš„inodeå’Œæ–‡ä»¶åé€šè¿‡dir_emitå‡½æ•°ä¼ è¾“åˆ°VFSå±‚ã€‚ä»¥æ ¹ç›®å½•ä¸ºä¾‹ï¼Œæ ¹ç›®å½•çš„åŒ…å«ä¸‰ä¸ªæ•°æ®é¡¹ï¼Œåˆ†åˆ«æ˜¯çˆ¶ç›®å½•ï¼Œå½“å‰ç›®å½•å’Œæ¬¢è¿æ–‡ä»¶ï¼Œæ‰€ä»¥è¯¥å‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å‚æ•°åˆ†åˆ«è¡¨ç¤ºä¸Šä¸‹æ–‡ï¼Œæ–‡ä»¶/ç›®å½•åï¼Œæ–‡ä»¶/ç›®å½•åé•¿åº¦ï¼Œinodeå·ï¼Œæ–‡ä»¶ç±»å‹  </span><br>dir_emit(ctx, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">0</span>, DT_DIR);  <br>dir_emit(ctx, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">0</span>, DT_DIR);  <br>dir_emit(ctx, <span class="hljs-string">&quot;file&quot;</span>, <span class="hljs-number">4</span>,<span class="hljs-number">1</span>, DT_REG);<br></code></pre></td></tr></table></figure><p>å®Œæˆè¯¥å‡½æ•°åï¼Œåœ¨å¡«å……æ ¹ç›®å½•inodeæ—¶å°†HUST_fs_dir_opsæŒ‡é’ˆèµ‹å€¼ï¼Œå³å¯åœ¨æŒ‚åœ¨æ–‡ä»¶ç³»ç»Ÿåæ‰§è¡Œlså‘½ä»¤ã€‚</p><img src="/2023/03/11/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230311223941193.png" alt="image-20230311223941193" style="zoom: 80%;"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æˆåŠŸçœ‹åˆ°äº†æ¬¢è¿æ–‡ä»¶ã€‚ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬ä¸èƒ½å¯¹æ–‡ä»¶è¿›è¡Œä»»ä½•æ“ä½œï¼Œå› ä¸ºè¿˜æ²¡æœ‰å®ç°å…¶ä»–çš„æ¥å£ã€‚</p><h3 id="3-3-ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°"><a href="#3-3-ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°" class="headerlink" title="3.3 ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°"></a>3.3 ç£ç›˜ç®¡ç†ç›¸å…³é€»è¾‘çš„å®ç°</h3><p>è¿™ä¸ªç£ç›˜ç®¡ç†çš„å†…æ¶µåŒ…æ‹¬å‘ç£ç›˜å†™å…¥å’Œä»ç£ç›˜å–å‡ºè¯»å–inodeï¼Œæ›´æ–°inodeä¿¡æ¯ï¼Œç»´æŠ¤imapï¼Œbmapï¼Œinode tableç­‰æ“ä½œã€‚ä¸ºäº†ä½¿ç£ç›˜ä¸Šçš„å†…å®¹æœ‰åºçš„ç»„åˆèµ·æ¥ï¼Œç£ç›˜ç©ºé—´çš„ç®¡ç†ååˆ†çš„é‡è¦ï¼Œåç»­çš„æ–‡ä»¶è¯»å†™æ“ä½œéƒ½ä¸æ­¤ç›¸å…³ã€‚</p><p>å†™å…¥å’Œåˆ é™¤inodeçš„æ“ä½œå­˜æ”¾åœ¨super_operationsè¿™ä¸ªç»“æ„ä½“ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_operations</span> <span class="hljs-title">HUST_fs_super_ops</span> =</span> &#123;  <br>    .evict_inode = HUST_evict_inode,  <br>    .write_inode = HUST_write_inode,  <br>&#125;;<br></code></pre></td></tr></table></figure><p>HUST_fs_super_opséœ€è¦åœ¨å¡«å……è¶…çº§å—æ—¶èµ‹å€¼åˆ°super_blockçš„s_opså­—æ®µä¸­ã€‚HUST_write_inodeå‡½æ•°çš„åŠŸèƒ½æ˜¯å°†å†…å­˜ä¸­çš„inodeä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚å…³é”®ä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_write_inode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> writeback_control *wbc)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buffer_head</span> * <span class="hljs-title">bh</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> * <span class="hljs-title">raw_inode</span> =</span> <span class="hljs-literal">NULL</span>;  <br>    HUST_fs_get_inode(inode-&gt;i_sb, inode-&gt;i_ino, raw_inode);  <br>    <span class="hljs-keyword">if</span> (!raw_inode)  <br>        <span class="hljs-keyword">return</span> -EFAULT;  <br>    raw_inode-&gt;mode = inode-&gt;i_mode;  <br>    raw_inode-&gt;i_uid = fs_high2lowuid(i_uid_read(inode));  <br>    raw_inode-&gt;i_gid = fs_high2lowgid(i_gid_read(inode));  <br>    raw_inode-&gt;i_nlink = inode-&gt;i_nlink;  <br>    raw_inode-&gt;file_size = inode-&gt;i_size;      <br>    raw_inode-&gt;i_atime = (inode-&gt;i_atime.tv_sec);  <br>    raw_inode-&gt;i_mtime = (inode-&gt;i_mtime.tv_sec);  <br>    raw_inode-&gt;i_ctime = (inode-&gt;i_ctime.tv_sec);  <br>    mark_buffer_dirty(bh);  <br>    brelse(bh);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;  <br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°çš„å°†vfs inodeä¸­çš„ç›¸å…³ä¿¡æ¯å­˜å‚¨åˆ°HUST_inodeç»“æ„ä½“ä¸­ï¼Œç„¶åå†™å…¥ç£ç›˜ã€‚è¿™ä¸ªæ˜¯å•ç‹¬çš„å†™å…¥ç£ç›˜æ“ä½œï¼Œäº‹å®ä¸Šï¼Œå½“æˆ‘ä»¬ç”³è¯·inodeæ—¶ï¼Œimapä¹Ÿæ˜¯éœ€è¦æ£€æŸ¥åˆ·æ–°çš„ï¼Œéœ€è¦æŠŠç›¸åº”ä½ç½®æ ‡è®°ä¸º1ã€‚åŒç†ï¼Œevict_inodeå‡½æ•°çš„ä½œç”¨æ—¶åˆ é™¤inodeï¼Œåˆ é™¤æˆåŠŸåï¼Œæˆ‘ä»¬éœ€è¦åˆ·æ–°imapçš„å€¼ï¼ŒæŠŠç›¸åº”ä½ç½®æ ‡è®°ä¸º0ã€‚</p><p>è®¾ç½®å’Œå†™å…¥mapçš„æ“ä½œéƒ½åœ¨map.cä¸­ï¼Œä»¥ä¸‹ä»¥imapä¸ºä¾‹ã€‚å¯¹äºimapæ¥è®²ï¼Œç”³è¯·inodeçš„æ—¶å€™éœ€è¦æ£€æŸ¥ç¬¬ä¸€ä¸ªç©ºé—²çš„inodeç¼–å·ï¼Œå½“inodeè¢«é‡Šæ”¾çš„æ—¶å€™ä¹Ÿè¦åŠæ—¶æ¸…é›¶å¯¹åº”çš„imapã€‚ä¸æ­¤ç›¸å…³çš„å‡½æ•°å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ä»ç£ç›˜ä¸­è¯»å–æ•°æ®å¹¶å­˜åœ¨imapæ•°ç»„ä¸­  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_imap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block* sb, <span class="hljs-type">uint8_t</span>* imap, <span class="hljs-type">ssize_t</span> imap_size)</span>;  <br><span class="hljs-comment">//åœ¨vaddræ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º0çš„bitï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºå®šä½ç©ºinodeæˆ–è€…block  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_find_first_zero_bit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *vaddr, <span class="hljs-type">unsigned</span> size)</span>;  <br><span class="hljs-comment">//å°†imapçš„æŸä¸€ä½ç½®0æˆ–è€…1ï¼Œå¹¶ä¿å­˜åœ¨ç£ç›˜ä¸Š  </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">set_and_save_imap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> super_block* sb, <span class="hljs-type">uint64_t</span> inode_num, <span class="hljs-type">uint8_t</span> value)</span>;  <br><span class="hljs-comment">//å®šä¹‰çš„ä½æ“ä½œå®å¦‚ä¸‹  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> setbit(number,x) number |= 1UL &lt;&lt; x  </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clearbit(number, x) number &amp;= ~(1UL &lt;&lt; x)  </span><br></code></pre></td></tr></table></figure><p>ç”±äºæœ¬æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸æ˜¯ä¸ºäº†å®é™…ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šè¿°çš„æ“ä½œéƒ½æ²¡æœ‰è€ƒè™‘æ€§èƒ½ä»¥åŠå‡†ç¡®æ€§é—®é¢˜ã€‚äº‹å®ä¸Šï¼Œèƒ½å¤ŸåŠ ä¸Šæ ¡éªŒæˆ–è€…å†—ä½™å¤‡ä»½æ˜¯æœ€å¥½çš„ã€‚</p><h3 id="3-4-è¯»å†™æ–‡ä»¶å†…å®¹"><a href="#3-4-è¯»å†™æ–‡ä»¶å†…å®¹" class="headerlink" title="3.4 è¯»å†™æ–‡ä»¶å†…å®¹"></a>3.4 è¯»å†™æ–‡ä»¶å†…å®¹</h3><p>ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿçœ‹åˆ°æ–‡ä»¶ç³»ç»Ÿåœ¨æ­£å¸¸å·¥ä½œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦å®ç°æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚æ–‡ä»¶è¯»å†™æ“ä½œæŒ‰ç…§ä¸€èˆ¬å¤„ç†ï¼Œåº”è¯¥æ˜¯å®ç°åœ¨struct file_operationsè¿™ä¸ªç»“æ„ä½“ä¸­çš„ã€‚äº‹å®ä¸Šï¼Œæœ€å¼€å§‹æˆ‘æ˜¯å®ç°åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­çš„read_iterå‡½æ•°æŒ‡é’ˆä¸­çš„ã€‚ä½†æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å®ç°äº†struct address_space_operationsç»“æ„ä½“ä¸­çš„å‡½æ•°ï¼Œé‚£ä¹ˆstruct file_operationsç»“æ„ä½“ä¸­çš„å‡½æ•°åˆ™å¯ä»¥äº¤ç”±VFSå®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">HUST_fs_file_ops</span> =</span> &#123;  <br>    .owner = THIS_MODULE,  <br>    .llseek = generic_file_llseek,  <br>    .mmap = generic_file_mmap,  <br>    .fsync = generic_file_fsync,  <br>    .read_iter = generic_file_read_iter,  <br>    .write_iter = generic_file_write_iter,  <br>&#125;;  <br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>   <span class="hljs-title">address_space_operations</span> <span class="hljs-title">HUST_fs_aops</span> =</span> &#123;  <br>    .readpage = HUST_fs_readpage,  <br>    .writepage = HUST_fs_writepage,  <br>    .write_begin = HUST_fs_write_begin,  <br>    .write_end = generic_write_end,  <br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°çš„genericå¼€å¤´çš„å‡½æ•°æ˜¯ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®ç°çš„ã€‚ä¸Šè¿°çš„address_space_operationsæ“ä½œå…¶å®æ˜¯å®ç°äº†é¡µé«˜é€Ÿç¼“å­˜çš„ä¸€äº›æ“ä½œã€‚é¡µé«˜é€Ÿç¼“å­˜æ˜¯linuxå†…æ ¸å®ç°çš„ä¸€ç§ä¸»è¦ç£ç›˜ç¼“å­˜ï¼Œå®ƒä¸»è¦ç”¨æ¥å‡å°‘å¯¹ç£ç›˜çš„IOæ“ä½œï¼Œå…·ä½“åœ°è®²ï¼Œæ˜¯é€šè¿‡æŠŠç£ç›˜ä¸­çš„æ•°æ®ç¼“å­˜åˆ°ç‰©ç†å†…å­˜ä¸­ï¼ŒæŠŠå¯¹ç£ç›˜çš„è®¿é—®å˜ä¸ºå¯¹ç‰©ç†å†…å­˜çš„è®¿é—®ã€‚è¿™äº›æ¥å£ä¸€æ—¦å®ç°ï¼Œé‚£ä¹ˆå¯¹æ–‡ä»¶çš„æ“ä½œå°±å¯ä»¥è½¬ç§»åˆ°å†…å­˜ä¸­ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨genericå¼€å¤´çš„è¿™äº›å‡½æ•°æ¥ä»£æ›¿æ‰‹å†™ã€‚</p><p>HUST_fs_readpage, HUST_fs_writepageä»¥åŠHUST_fs_write_beginéƒ½è¢«æ³¨å†Œå›è°ƒåˆ°åŒä¸€ä¸ªå‡½æ•°HUST_fs_get_blockã€‚HUST_fs_get_blockä¸»è¦è¿”å›å†…æ ¸è¯·æ±‚é•¿åº¦çš„æ•°æ®ã€‚è‡³äºè¯»å†™æ“ä½œï¼Œå†…æ ¸è°ƒç”¨__bwriteå‡½æ•°æœ€ç»ˆè°ƒç”¨å—è®¾å¤‡é©±åŠ¨æ‰§è¡Œã€‚å› ä¸ºåœ¨æˆ‘æ²¡æœ‰é‡‡ç”¨äºŒçº§æˆ–è€…å¤šçº§ç´¢å¼•ï¼Œæ•…è€ŒHUST_fs_get_blockå‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">HUST_fs_get_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-type">sector_t</span> block,  </span><br><span class="hljs-params">              <span class="hljs-keyword">struct</span> buffer_head *bh, <span class="hljs-type">int</span> create)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> inode-&gt;i_sb;  <br>    <span class="hljs-keyword">if</span> (block &gt; HUST_N_BLOCKS) <br>        <span class="hljs-keyword">return</span> -ENOSPC;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_inode</span>;</span>  <br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == HUST_fs_get_inode(sb, inode-&gt;i_ino, &amp;H_inode))  <br>        <span class="hljs-keyword">return</span> -EFAULT;  <br>    <span class="hljs-keyword">if</span> (H_inode.blocks == <span class="hljs-number">0</span>)  <br>        <span class="hljs-keyword">if</span>(alloc_block_for_inode(sb, &amp;H_inode, <span class="hljs-number">1</span>)) <br>            <span class="hljs-keyword">return</span> -EFAULT;  <br>    map_bh(bh, sb, H_inode.block[block]);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè¯¥å‡½æ•°åˆ¤æ–­ä¼ å…¥çš„blockçš„å¤§å°ï¼Œå¹¶å°†ç£ç›˜å†…å®¹æ˜ å°„åˆ°bhä¸­ã€‚åç»­çš„è¯»å†™æ“ä½œå°†æœ‰VFSå¸®æˆ‘ä»¬å®Œæˆã€‚</p><h3 id="3-5-inodeæ“ä½œ"><a href="#3-5-inodeæ“ä½œ" class="headerlink" title="3.5 inodeæ“ä½œ"></a>3.5 inodeæ“ä½œ</h3><p>Inodeæ“ä½œæ¶‰åŠæ–‡ä»¶(å¤¹)çš„åˆ›å»ºåˆ é™¤ï¼Œå°†HUST_inodeæ˜ å°„åˆ°VFSä¸­çš„inodeç­‰æ“ä½œã€‚å…·ä½“å®ç°çš„å‡½æ•°å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_operations</span> <span class="hljs-title">HUST_fs_inode_ops</span> =</span> &#123;  <br>    .lookup = HUST_fs_lookup,  <br>    .mkdir = HUST_fs_mkdir,  <br>    .create = HUST_fs_create,  <br>    .unlink = HUST_fs_unlink,  <br>&#125;; <br></code></pre></td></tr></table></figure><p>HUST_fs_lookupæ˜¯å…¶ä¸­æ¯”è¾ƒå¤æ‚çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè´Ÿè´£å°†ä¸€ä¸ªç›®å½•ä¸‹çš„inodeä¿¡æ¯äº¤ç”±VFSç®¡ç†ã€‚é¦–å…ˆï¼ŒHUST_fs_lookupè¯»å–æ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œç„¶åéå†æ–‡ä»¶å¤¹ä¸‹é¢çš„HUST_inodeï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„HUST_inodeï¼Œæ ¹æ®ä¸åŒçš„æ–‡ä»¶å±æ€§ï¼Œç”³è¯·vfs_inodeï¼›å¹¶å¯¹ä¸åŒçš„vfs_inodeè®¾ç½®ä¸åŒçš„æ“ä½œã€‚å‡è®¾vfs_inodeå¯¹åº”çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±è®¾ç½®vfs_inode-&gt;mapping-&gt;a_opsï¼Œå¦‚æœvfs_inodeå¯¹åº”çš„æ˜¯æ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆå°±è®¾ç½®vfs_inode-&gt;f_ops &#x3D; &amp;HUST_fs_dir_ops;æœ€åå°†vfs_inodeæ³¨å†Œåˆ°VFSä¸­ã€‚è¿™éƒ¨åˆ†çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> dentry *<span class="hljs-title function_">HUST_fs_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *parent_inode,  </span><br><span class="hljs-params">                  <span class="hljs-keyword">struct</span> dentry *child_dentry, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>  <br>&#123;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">super_block</span> *<span class="hljs-title">sb</span> =</span> parent_inode-&gt;i_sb;  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_inode</span>;</span>  <br><span class="hljs-comment">//çœç•¥ä»£ç   </span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; H_inode.dir_children_count; i++) &#123;  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>  <br>            (child_dentry-&gt;d_name.name, dtptr[i].filename,  <br>             HUST_FILENAME_MAX_LEN) == <span class="hljs-number">0</span>)&#123;  <br>            inode = iget_locked(sb, dtptr[i].inode_no);  <br>            <span class="hljs-keyword">if</span> (inode-&gt;i_state &amp; I_NEW) &#123;  <br>                inode_init_owner(inode, parent_inode, <span class="hljs-number">0</span>);  <br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HUST_inode</span> <span class="hljs-title">H_child_inode</span>;</span>  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> == HUST_fs_get_inode(sb, dtptr[i].inode_no, &amp;H_child_inode))  <br>                    <span class="hljs-keyword">return</span> ERR_PTR(-EFAULT);  <br>                HUST_fs_convert_inode(&amp;H_child_inode, inode);  <br>                inode-&gt;i_op = &amp;HUST_fs_inode_ops;  <br>                <span class="hljs-keyword">if</span> (S_ISDIR(H_child_inode.mode)) &#123;  <br>                    inode-&gt;i_fop = &amp;HUST_fs_dir_ops;  <br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISREG(H_child_inode.mode)) &#123;  <br>                    inode-&gt;i_fop = &amp;HUST_fs_file_ops;;  <br>                    inode-&gt;i_mapping-&gt;a_ops = &amp;HUST_fs_aops;  <br>                &#125;  <br>                inode-&gt;i_mode = H_child_inode.mode;  <br>                inode-&gt;i_size = H_child_inode.file_size;  <br>                insert_inode_hash(inode);  <br>                unlock_new_inode(inode);  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br><span class="hljs-comment">//çœç•¥ä»£ç   </span><br>&#125; <br></code></pre></td></tr></table></figure><p>åªæœ‰åœ¨è¿™é‡Œæ³¨å†Œäº†ç›¸å…³å‡½æ•°ï¼Œç³»ç»Ÿè°ƒç”¨æ‰èƒ½æ­£å¸¸æ‰§è¡Œã€‚ä¸ç„¶å°±ä¼šå‡ºç°ä¸æ”¯æŒçš„æ“ä½œè¿™ç§æŠ¥é”™ä¿¡æ¯ã€‚</p><p>.createä¸.mkdiréƒ½æ˜¯å¯¹åº”äº†inodeçš„åˆ›å»ºï¼Œåªæ˜¯inodeçš„å±æ€§ä¸èƒ½è€Œå·²ã€‚.createåˆ›å»ºæ™®é€šæ–‡ä»¶è€Œ.mkdiråˆ›å»ºæ–‡ä»¶å¤¹ã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½è¢«å‡½æ•°HUST_fs_create_objæ‰€å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°æ¥å—æ–°å»ºæ–‡ä»¶ï¼ˆå¤¹ï¼‰çš„è¯·æ±‚ï¼Œæ£€æŸ¥ç£ç›˜çš„å¤§å°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç©ºä½™çš„indoeï¼Œå¹¶ä¸”åˆ†é…inodeå·ï¼Œç„¶åæ›´æ–°imapä¿¡æ¯ï¼Œæœ€åæ›´æ–°è¶…çº§å—ä¿¡æ¯ã€‚ç”±äºè¯¥å‡½æ•°é€»è¾‘ç®€å•ä½†æ˜¯ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæ•…è€Œä¸åœ¨æ­¤å±•ç¤ºå…¶å…·ä½“å®ç°ã€‚</p><p>åœ¨å®Œæˆä¸Šè¿°å·¥ä½œä¹‹åï¼Œæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»ŸåŸºæœ¬å·²ç»å®Œæˆäº†ï¼Œè¿™ä¸ªç³»ç»Ÿé‡‡ç”¨çº¿æ€§ï¼ˆåŒºåˆ«äºminixiäºŒçº§ç´¢å¼•ç”¨æ ‘æ¥ç®¡ç†ï¼‰çš„æ–¹å¼ç®¡ç†ç£ç›˜ç©ºé—´ï¼Œæ”¯æŒåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ–‡ä»¶æ“ä½œï¼Œæ”¯æŒæ–‡ä»¶æƒé™ï¼Œæ”¯æŒå¤šç”¨æˆ·ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android HIDLæœåŠ¡å®ç°</title>
    <link href="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-HIDLæœåŠ¡å®ç°"><a href="#Android-HIDLæœåŠ¡å®ç°" class="headerlink" title="Android HIDLæœåŠ¡å®ç°"></a>Android HIDLæœåŠ¡å®ç°</h1><blockquote><p><a href="https://www.jianshu.com/p/b75c4321ae0a">https://www.jianshu.com/p/b75c4321ae0a</a></p></blockquote><p><strong>Android O(8.0)</strong> ç‰ˆæœ¬ä¹‹åï¼Œåº•å±‚å®ç°æœ‰äº†æ¯”è¾ƒå¤§çš„å˜åŒ–ï¼Œæœ€æ˜¾è‘—çš„ä¸€ä¸ªæ–¹é¢å°±æ˜¯ <strong>HIDL</strong> æœºåˆ¶çš„å…¨é¢å®æ–½ã€‚æœ¬æ–‡å°†ä» <strong>HIDLçš„åŸºæœ¬æ¦‚å¿µ</strong>ã€<strong>HIDLæœåŠ¡æ¨¡æ‹Ÿ</strong>ã€<strong>frameworkå±‚aidlæœåŠ¡</strong>ã€<strong>åº”ç”¨å±‚ç¨‹åº</strong> è¿™å››ä¸ªæ–¹é¢æ¥å…¨é¢çš„é˜è¿° <strong>HIDL</strong> å·¥ä½œå…¨è¿‡ç¨‹ï¼Œè¿™å¯¹äºç†è§£ç³»ç»Ÿæºç ä¸­ <strong>Gnss</strong>ã€<strong>Usb</strong>ã€<strong>Camera</strong> ç­‰æ¨¡å—çš„å·¥ä½œåŸç†æœ‰æå¤§å¸®åŠ©ã€‚</p><h2 id="1-HIDLè®¾è®¡ç›®çš„"><a href="#1-HIDLè®¾è®¡ç›®çš„" class="headerlink" title="1. HIDLè®¾è®¡ç›®çš„"></a>1. HIDLè®¾è®¡ç›®çš„</h2><p>åœ¨ <strong>Android O(8.0)</strong> ä¹‹å‰ç³»ç»Ÿçš„å‡çº§ç‰µæ‰¯å¤šæ–¹åä½œï¼Œæä¸ºéº»çƒ¦ï¼Œ<strong>HIDL</strong>æœºåˆ¶çš„æ¨å‡ºå°±æ˜¯å°† <strong>framework</strong> ä¸ <strong>hal</strong> å±‚åˆ†å¼€ï¼Œä½¿å¾—æ¡†æ¶éƒ¨åˆ†å¯ä»¥ç›´æ¥è¢«è¦†ç›–ã€æ›´æ–°ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯¹ HAL è¿›è¡Œç¼–è¯‘ï¼Œè¿™æ ·åœ¨ç³»ç»Ÿå‡çº§æ—¶ï¼Œ<strong>OEM</strong> å‚å•† è·³è¿‡ <strong>SoC</strong> å‚å•†ï¼Œå…ˆå¯¹ <strong>framework</strong> è¿›è¡Œå‡çº§ã€‚</p><h3 id="1-1-Android-8-0ä¹‹å‰"><a href="#1-1-Android-8-0ä¹‹å‰" class="headerlink" title="1.1 Android 8.0ä¹‹å‰"></a>1.1 Android 8.0ä¹‹å‰</h3><p><strong>framework</strong> ä¸ <strong>hal</strong> ç´§ç´§è€¦åˆå­˜åœ¨äº <strong>system.img</strong> ä¸­ï¼Œå› æ­¤åœ¨ç‰ˆæœ¬å‡çº§æ—¶éœ€è¦: <strong>OEM</strong> å‚å•†é€‚é… <strong>framework</strong> ï¼Œ<strong>SoCå‚å•†</strong> é€‚é… <strong>hal</strong>ï¼Œ ä¹‹åå°†ä¿®æ”¹æ‰“åŒ…åˆ° <strong>system.img</strong>ï¼Œç”Ÿæˆ OTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡Œ OTA å‡çº§</p><h3 id="1-2-Android-8-0ä¹‹å"><a href="#1-2-Android-8-0ä¹‹å" class="headerlink" title="1.2 Android 8.0ä¹‹å"></a>1.2 Android 8.0ä¹‹å</h3><p><strong>framework</strong> ä¸ <strong>hal</strong> è¿›è¡Œäº†è§£è€¦ï¼Œ <strong>framework</strong> å­˜åœ¨äº <strong>system.img</strong>ï¼Œ<strong>hal</strong> å­˜åœ¨äº<strong>vendor.img</strong>ï¼Œè¿›è¡Œç‰ˆæœ¬å‡çº§æ—¶ï¼Œåˆ†ä¸ºä¸¤æ¬¡å‡çº§:</p><ul><li><strong>frameworkå‡çº§</strong> ï¼š OEM å‚å•†é€‚é… frameworkï¼Œå°†ä¿®æ”¹æ‰“åŒ…åˆ° system.imgï¼Œ ç”ŸæˆOTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡Œ OTA å‡çº§(framework å‘ç”Ÿæ”¹å˜ï¼Œhal å±‚æœªå˜)ã€‚</li><li><strong>halå‡çº§</strong> ï¼šSoC å‚å•†é€‚é… halï¼Œ å°†ä¿®æ”¹æ‰“åŒ…åˆ° vendor.img, ç”ŸæˆOTA å‡çº§åŒ…ï¼Œæ¨é€åˆ°æ‰‹æœºè¿›è¡ŒOTAå‡çº§(frameworkå‘ç”Ÿæ”¹å˜ï¼Œhal å±‚å‘ç”Ÿæ”¹å˜)ã€‚</li></ul><h2 id="2-HIDLæœºåˆ¶æ¼”è¿›"><a href="#2-HIDLæœºåˆ¶æ¼”è¿›" class="headerlink" title="2.HIDLæœºåˆ¶æ¼”è¿›"></a>2.HIDLæœºåˆ¶æ¼”è¿›</h2><h3 id="2-1-è€ç‰ˆæœ¬-Framework-ä¸-HAL-çš„é€šä¿¡æ¡†æ¶"><a href="#2-1-è€ç‰ˆæœ¬-Framework-ä¸-HAL-çš„é€šä¿¡æ¡†æ¶" class="headerlink" title="2.1 è€ç‰ˆæœ¬ Framework ä¸ HAL çš„é€šä¿¡æ¡†æ¶"></a>2.1 è€ç‰ˆæœ¬ Framework ä¸ HAL çš„é€šä¿¡æ¡†æ¶</h3><p>æ­£å¦‚ä¸Šè¿°æ‰€è¨€ï¼Œæ—§ç‰ˆçš„ç³»ç»Ÿæ¶æ„ä¸­ï¼Œ Android Framework å±‚ä¸ Hal å±‚æ˜¯æ‰“åŒ…æˆä¸€ä¸ª <strong>system.img</strong> çš„ï¼Œä¸” Framework ä¸ hal å±‚ä¹‹é—´æ˜¯ç´§å¯†è€¦åˆçš„ï¼Œé€šè¿‡é“¾æ¥çš„æ–¹å¼ä½¿ç”¨ç›¸åº”çš„ç¡¬ä»¶ <strong>so</strong> åº“ã€‚å®ƒä»¬ä¹‹é—´çš„æ¶æ„ä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-0fed2e7f185e551d.png" style="zoom:80%;"><h3 id="2-2-HIDL-ç±»å‹ä»‹ç»"><a href="#2-2-HIDL-ç±»å‹ä»‹ç»" class="headerlink" title="2.2  HIDL ç±»å‹ä»‹ç»"></a>2.2  HIDL ç±»å‹ä»‹ç»</h3><p>ä¸ºäº†è§£å†³ä¸¤è€…ä¹‹é—´è¿™ç§ç´§è€¦åˆæ‰€å¸¦æ¥çš„å¼Šç«¯ï¼Œgoogle å¼•å…¥ HIDL æ¥å®šä¹‰ Framework ä¸ HAL ä¹‹é—´çš„æ¥å£ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-ea297e84897f8686.webp" style="zoom:80%;"><p>äº‹å®ä¸Šè™½ç„¶ google æ¨å‡ºäº†è¿™ç§æœºåˆ¶ï¼Œä½†æ˜¯å¾ˆå¤šå‚å•†æ²¡æœ‰å¾ˆå¿«çš„è·Ÿä¸ŠèŠ‚å¥ï¼Œå› æ­¤ä¸ºäº†å‘å‰å…¼å®¹ï¼Œ google å®šä¹‰äº†ä¸‰ç§ç±»å‹ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-5b8123370101b01f.png" style="zoom: 67%;"><p>â‘  æ˜¯ Treble Project ä¹‹å‰ä½¿ç”¨çš„å®ç°æ¶æ„ï¼Œä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿ HAL å’Œæ—§ç‰ˆ HAL</p><p>â‘¡ ç›´é€šæ¨¡å¼ï¼Œpassthrough modeã€‚å¦‚å›¾æ‰€ç¤ºï¼ŒFramework å’Œ HAL å±‚å·¥ä½œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å½“ä¸­ï¼Œä¸‹é¢çš„ HAL æ˜¯ä½¿ç”¨ HIDL å°è£…åçš„åº“ï¼Œæ˜¯ç›´é€šå¼ HALã€‚è¿™äº›åº“æ–‡ä»¶ä¹Ÿå¯ç”¨äº â‘¢ ç»‘å®šæ¨¡å¼</p><p>â‘¢ ç»‘å®šæ¨¡å¼ï¼Œbinderized modeã€‚æ˜¯ç›´é€šå¼ HAL binder åŒ–ï¼Œå˜ä¸ºç»‘å®šå¼ HALã€‚Framework å’Œ HAL å±‚å·¥ä½œåœ¨ä¸åŒçš„è¿›ç¨‹ï¼Œä¹‹é—´é€šè¿‡ Binder è¿›è¡Œ IPC</p><p>â‘£ çº¯ç»‘å®šå¼ã€‚ç›¸å¯¹äº â‘¢ æ¥è¯´ï¼Œç»‘å®šå¼ HAL ä¸­å¹¶ä¸åŒ…å«ç›´é€šå¼ HALï¼Œå› æ­¤ç§°ä¸ºçº¯ç»‘å®šå¼</p><p><strong>ä¸Šè¿°å¯æ€»ç»“ä¸º</strong>ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-619180c0c7f8afc5.png" style="zoom: 67%;"><h2 id="3-Binderized-Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹"><a href="#3-Binderized-Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹" class="headerlink" title="3.Binderized Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹"></a>3.Binderized Modeï¼ˆç»‘å®šå¼ï¼‰ç®€ä»‹</h2><p>ä»¬çŸ¥é“ <strong>ç»‘å®šæ¨¡å¼</strong> æ˜¯ google ä¸ºäº†å‘å‰å…¼å®¹è€Œå®šä¹‰çš„ä¸€ç§ç±»å‹ï¼Œä¸” Android 8.0 åŠåç»­ç‰ˆæœ¬çš„è®¾å¤‡éƒ½å¿…é¡»åªæ”¯æŒè¿™ç§æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ä¸‹ Framework ä¸ Hal åˆ†åˆ«ä½äºä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå…¶å®ä»å…·ä½“å®ç°æ¥è®²è¿™ç§æ¨¡å¼ä¹Ÿæ›´åº”è¯¥è¢«ç§°ä¸º <strong>Binder åŒ–çš„ç›´é€šå¼</strong>ã€‚æœ¬æ–‡å°†é€šè¿‡è¿™ç§æ–¹å¼å®ç°ä¸€ä¸ª <strong>HIDL</strong> æœåŠ¡ã€‚</p><h2 id="4-ç¯å¢ƒ-x2F-å·¥å…·å‡†å¤‡"><a href="#4-ç¯å¢ƒ-x2F-å·¥å…·å‡†å¤‡" class="headerlink" title="4.ç¯å¢ƒ&#x2F;å·¥å…·å‡†å¤‡"></a>4.ç¯å¢ƒ&#x2F;å·¥å…·å‡†å¤‡</h2><ul><li>Ubuntu 20.04 TLS</li><li>Android æºç ï¼šAndroid 9.0ï¼Œç¼–è¯‘çƒ§å½•è¯¦è§ <a href="https://www.jianshu.com/p/848414148272">Androidæºç ç¼–è¯‘çƒ§å½•</a></li><li>hidl-gen å·¥å…·ï¼šAndroid ç³»ç»Ÿè‡ªå¸¦ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡</li></ul><h2 id="5-HIDLå®ç°"><a href="#5-HIDLå®ç°" class="headerlink" title="5.HIDLå®ç°"></a>5.HIDLå®ç°</h2><p>æœ¬æ–‡ç›®çš„æ˜¯å®ç°ä¸€ä¸ªå…·æœ‰ <strong>åŠ å‡ä¹˜é™¤</strong> è¿ç®—çš„ HIDL æœåŠ¡,å‘½åä¸º <strong>é“¶æ²³ä¸€å·(GalaxyOne)<strong>ã€‚HIDLç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œåœ¨ç³»ç»Ÿæºç ä¸­çš„ <strong>hardware&#x2F;interfaces</strong> ç›®å½•ä¸‹æœ‰å¾ˆå¤šçš„ HIDLï¼Œæˆ‘ä»¬ä»¿ç…§å…¶ä»– HIDL æ¥åˆ›å»ºè‡ªå·±çš„ç›®å½•ï¼š</strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong></p><h3 id="5-1-åˆ›å»ºIGalaxyOne-hal-æ–‡ä»¶"><a href="#5-1-åˆ›å»ºIGalaxyOne-hal-æ–‡ä»¶" class="headerlink" title="5.1 åˆ›å»ºIGalaxyOne.hal æ–‡ä»¶"></a>5.1 åˆ›å»ºIGalaxyOne.hal æ–‡ä»¶</h3><p><strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;IGalaxyOne.hal</strong></p><p>è¿™é‡Œå®šä¹‰äº†å››ç§åŸºæœ¬çš„è¿ç®—ï¼šåŠ ã€å‡ã€ä¹˜ã€é™¤ï¼Œè¿™æ˜¯ä¸Šå±‚è°ƒç”¨ HAL çš„å…¥å£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">package android.hardware.galaxy_one@<span class="hljs-number">1.0</span>;<br><br>interface IGalaxyOne&#123;<br><br>    <span class="hljs-comment">//åŠ æ³•</span><br>    add(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//å‡æ³•</span><br>    sub(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//ä¹˜æ³•</span><br>    mul(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <span class="hljs-comment">//é™¤æ³•</span><br>    div(<span class="hljs-type">uint32_t</span> a,<span class="hljs-type">uint32_t</span> b) generates (<span class="hljs-type">uint32_t</span> result);<br>    <br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="5-2-hidl-genç”ŸæˆHIDLæ¡†æ¶"><a href="#5-2-hidl-genç”ŸæˆHIDLæ¡†æ¶" class="headerlink" title="5.2 hidl-genç”ŸæˆHIDLæ¡†æ¶"></a>5.2 hidl-genç”ŸæˆHIDLæ¡†æ¶</h3><p>åœ¨ä½¿ç”¨ hidl-gen ä¹‹å‰éœ€è¦å…ˆåšä¸¤ä»¶äº‹ï¼š<br>1ã€hidl-gen ç”± Android æä¾›ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦å…ˆé…ç½®ä¸€ä¸‹ç³»ç»Ÿè·¯å¾„ï¼Œå¦‚æˆ‘è¿™é‡Œæ‰€åšçš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># vim ~/.bashrc</span><br>export PATH=/home/zsk/AOSP/out/soong/host/linux-x86/bin:$PATH<br></code></pre></td></tr></table></figure><p>2ã€Ubuntu æ–°çš„ç»ˆç«¯çª—å£å¿…é¡»å…ˆè®¾å®šä¸€äº› Android ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">source build/envsetup.sh<br>lunch aosp_sailfish-userdebug  <span class="hljs-comment">// lunch mode æ ¹æ®éœ€æ±‚ä¿®æ”¹</span><br>make hidl-gen<br></code></pre></td></tr></table></figure><p>é…ç½®å®Œæˆä¹‹ååœ¨ <strong>æºç æ ¹ç›®å½•</strong> ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">PACKAGE=android.hardware.galaxy_one@<span class="hljs-number">1.0</span><br>LOC=hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/<br>    <br>hidl-gen -o $LOC -Lc++-impl -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE<br><br>hidl-gen -o $LOC -Landroidbp-impl -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport $PACKAGE<br></code></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡ŒæˆåŠŸä¹‹åä¼šå‘ç°åœ¨ <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª <strong>default</strong> ç›®å½•ï¼Œè¿›å…¥ä¹‹åå‘ç°æœ‰å¦‚ä¸‹æ–‡ä»¶ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-0096f7494b4dbff9.png" style="zoom: 80%;"><p>ä¹‹åæ‰§è¡Œ <strong>update-makefiles.sh</strong> è„šæœ¬æ¥ä¸º HIDL ç”Ÿæˆå¯¹åº”çš„ <strong>Android.bp</strong> æ–‡ä»¶ï¼Œæ­¤è„šæœ¬ä½äº <strong>hardware&#x2F;interfaces</strong> ç›®å½•ä¸‹ï¼ŒåŒæ ·å¯åœ¨æºç æ ¹ç›®å½•ä¸‹æ‰§è¡Œ:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">./hardware/interfaces/update-makefiles.sh<br></code></pre></td></tr></table></figure><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-5ea845283e2c2d58.png" style="zoom: 80%;"><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸¤ä¸ªç©ºæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">touch hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/android.hardware.galaxy_one@<span class="hljs-number">1.0</span>-service.rc<br>touch hardware/interfaces/galaxy_one/<span class="hljs-number">1.0</span>/<span class="hljs-keyword">default</span>/service.cpp<br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹åï¼Œæ•´ä¸ªå·¥ç¨‹ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-118902147dc61749.png" style="zoom: 80%;"><h3 id="5-3-è°ƒç”¨æµç¨‹"><a href="#5-3-è°ƒç”¨æµç¨‹" class="headerlink" title="5.3 è°ƒç”¨æµç¨‹"></a>5.3 è°ƒç”¨æµç¨‹</h3><p>ä¸Šè¿°è¿‡ç¨‹å·²ç»å°† HIDL æœåŠ¡æ‰€éœ€è¦çš„å…¨æœ¬æ–‡ä»¶é…ç½®å®Œæˆï¼Œè™½ç„¶å…¶ä¸­å¾ˆå¤šæ–‡ä»¶æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ²¡æœ‰å…·ä½“å®ç°ï¼Œæˆ‘ä»¬ç°åœ¨å…ˆæ”¾åœ¨ä¸€è¾¹ï¼Œå…ˆæ¥å¯¹æ•´ä½“çš„è°ƒç”¨æµç¨‹åŠå„ä¸ªæ–‡ä»¶çš„åŠŸæ•ˆç•¥ä½œè¯´æ˜ã€‚</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-865d0cf346cee965.png" style="zoom: 80%;"><ul><li>Applicationï¼šæŒ‡ä¸Šå±‚åº”ç”¨</li><li>JNIï¼šæŒ‡ framework å±‚ï¼ŒgetService è·å– hal å±‚ service</li><li><a href="mailto:&#x61;&#x6e;&#100;&#114;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#x64;&#x77;&#x61;&#114;&#x65;&#x2e;&#x67;&#x61;&#108;&#x61;&#x78;&#121;&#x5f;&#x6f;&#110;&#x65;&#x40;&#49;&#46;&#x30;&#46;&#115;&#x6f;">&#x61;&#x6e;&#100;&#114;&#x6f;&#105;&#100;&#46;&#x68;&#97;&#x72;&#x64;&#x77;&#x61;&#114;&#x65;&#x2e;&#x67;&#x61;&#108;&#x61;&#x78;&#121;&#x5f;&#x6f;&#110;&#x65;&#x40;&#49;&#46;&#x30;&#46;&#115;&#x6f;</a>ï¼šç”± IGalaxyOne.hal ç”Ÿæˆçš„æ¥å£åº“ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;Android.bp</strong> é€šè¿‡ <strong>IGalaxyOne.hal</strong> ç”Ÿæˆï¼Œè¿™æ ·åªè¦è¿™ä¸ªæ¥å£åº“ä¸å˜ï¼Œé‚£ä¹ˆ framework çš„æ›´æ–°å’Œ hal å±‚å°±éš”ç»å¼€äº†</li><li><a href="mailto:&#97;&#110;&#x64;&#114;&#x6f;&#x69;&#x64;&#46;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#114;&#x65;&#46;&#x67;&#97;&#108;&#97;&#120;&#x79;&#95;&#x6f;&#110;&#101;&#64;&#x31;&#46;&#x30;&#x2d;&#115;&#x65;&#114;&#x76;&#x69;&#x63;&#101;&#46;&#114;&#x63;">&#97;&#110;&#x64;&#114;&#x6f;&#x69;&#x64;&#46;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#114;&#x65;&#46;&#x67;&#97;&#108;&#97;&#120;&#x79;&#95;&#x6f;&#110;&#101;&#64;&#x31;&#46;&#x30;&#x2d;&#115;&#x65;&#114;&#x76;&#x69;&#x63;&#101;&#46;&#114;&#x63;</a>ï¼šè®¾å¤‡å¼€æœºæ—¶é€šè¿‡ <strong>rc</strong> æ–‡ä»¶å¯åŠ¨æ­¤æœåŠ¡</li><li>galaxy_hal_serviceï¼šserviceçš„åï¼Œå¯é€šè¿‡ <strong>start galaxy_hal_service</strong> å¯åŠ¨æœåŠ¡ï¼Œç”±service.cppç¼–è¯‘ç”Ÿæˆ</li><li><a href="mailto:&#x61;&#x6e;&#100;&#x72;&#x6f;&#x69;&#100;&#46;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#114;&#x65;&#x2e;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#x40;&#x31;&#46;&#48;&#45;&#x69;&#109;&#x70;&#108;&#46;&#x73;&#x6f;">&#x61;&#x6e;&#100;&#x72;&#x6f;&#x69;&#100;&#46;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#114;&#x65;&#x2e;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#x40;&#x31;&#46;&#48;&#45;&#x69;&#109;&#x70;&#108;&#46;&#x73;&#x6f;</a>ï¼šå®ç°åº“ï¼Œä¸Šå±‚åº”ç”¨çš„æœ€ç»ˆè°ƒç”¨ï¼Œç”±GalaxyOne.cppç¼–è¯‘ç”Ÿæˆ</li></ul><p>å…³äº <strong>Applicationã€JNI</strong> è¿™ä¸¤å±‚å†…å®¹ä¼šåœ¨ç¨åç”¨ä¸¤ä¸ªç¯‡å¹…å»åˆ†æï¼Œæ­¤å¤„æš‚ä¸ç†ä¼šã€‚ç°åœ¨æˆ‘ä»¬å°±ç€è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹å°†éœ€è¦çš„å†…å®¹è¡¥å……å®Œæˆã€‚æ˜å‡ºå¤„ã€‚</p><h4 id="5-3-1-æ¥å£åº“ç”Ÿæˆ"><a href="#5-3-1-æ¥å£åº“ç”Ÿæˆ" class="headerlink" title="5.3.1 æ¥å£åº“ç”Ÿæˆ"></a>5.3.1 æ¥å£åº“ç”Ÿæˆ</h4><p><a href="mailto:&#x61;&#110;&#x64;&#114;&#x6f;&#105;&#x64;&#46;&#x68;&#97;&#114;&#100;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#120;&#x79;&#x5f;&#111;&#110;&#101;&#x40;&#49;&#46;&#48;&#46;&#115;&#111;">&#x61;&#110;&#x64;&#114;&#x6f;&#105;&#x64;&#46;&#x68;&#97;&#114;&#100;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#97;&#x6c;&#97;&#120;&#x79;&#x5f;&#111;&#110;&#101;&#x40;&#49;&#46;&#48;&#46;&#115;&#111;</a>ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;Android.bp</strong> é€šè¿‡ <strong>IGalaxyOne.hal</strong> ç”Ÿæˆï¼ŒAndroid.bp æ–‡ä»¶æ˜¯åœ¨ä¸Šé¢ä¸€äº›åˆ—å‘½ä»¤æ‰§è¡Œä¹‹åç”Ÿæˆï¼Œè€Œæ¥å£åº“æ˜¯å½“æˆ‘ä»¬æœ€ç»ˆæ‰§è¡Œç¼–è¯‘æ¨¡å—æ—¶ç”Ÿæˆï¼Œå¯ä»¥è¯´è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å‚ä¸ï¼ŒAndroid.bp å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile">// This file is autogenerated by hidl-gen -Landroidbp.<br><br>hidl_interface &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,   //æ­¤å¤„è®¾ç½®æ¥å£åº“çš„åå­—<br>    root: <span class="hljs-string">&quot;android.hardware&quot;</span>,<br>    vndk: &#123;<br>        enabled: true,<br>    &#125;,<br>    srcs: [<br>        <span class="hljs-string">&quot;IGalaxyOne.hal&quot;</span>,<br>    ],<br>    interfaces: [<br>        <span class="hljs-string">&quot;android.hidl.base@1.0&quot;</span>,<br>    ],<br>    gen_java: true,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-2-å®ç°åº“ç”Ÿæˆ"><a href="#5-3-2-å®ç°åº“ç”Ÿæˆ" class="headerlink" title="5.3.2 å®ç°åº“ç”Ÿæˆ"></a>5.3.2 å®ç°åº“ç”Ÿæˆ</h4><p><a href="mailto:&#97;&#x6e;&#100;&#114;&#111;&#105;&#x64;&#x2e;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#101;&#46;&#x67;&#97;&#108;&#97;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#x65;&#x40;&#x31;&#x2e;&#48;&#x2d;&#x69;&#109;&#x70;&#x6c;&#x2e;&#x73;&#111;">&#97;&#x6e;&#100;&#114;&#111;&#105;&#x64;&#x2e;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#101;&#46;&#x67;&#97;&#108;&#97;&#x78;&#x79;&#x5f;&#x6f;&#x6e;&#x65;&#x40;&#x31;&#x2e;&#48;&#x2d;&#x69;&#109;&#x70;&#x6c;&#x2e;&#x73;&#111;</a>ï¼Œç”± <strong>hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0&#x2F;default&#x2F;Android.bp</strong> é€šè¿‡ <strong>GalaxyOne.cpp</strong> ç”Ÿæˆï¼Œæ³¨æ„è¿™ä¸ª Android.bp æ–‡ä»¶æ˜¯ä½äº <strong>default</strong> ç›®å½•ä¸‹ï¼ŒåŒæ ·çš„åœ¨æœ€åæ¨¡å—ç¼–è¯‘æ—¶ç”Ÿæˆï¼ŒåŸå§‹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs makefile">cc_library_shared &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-impl&quot;</span>,<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br>    proprietary: true,<br>    srcs: [<br>        <span class="hljs-string">&quot;GalaxyOne.cpp&quot;</span>,<br>    ],<br>    shared_libs: [    //è¿™é‡Œå¯ä»¥æ·»åŠ æˆ‘ä»¬éœ€è¦çš„åº“<br>        <span class="hljs-string">&quot;liblog&quot;</span>,     <br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-3-GalaxyOne-cppå®ç°"><a href="#5-3-3-GalaxyOne-cppå®ç°" class="headerlink" title="5.3.3 GalaxyOne.cppå®ç°"></a>5.3.3 GalaxyOne.cppå®ç°</h4><p>åœ¨ <strong>5.3.2</strong> ä¸­ï¼Œå®ç°åº“æ˜¯ç”± <strong>GalaxyOne.cpp</strong> ç¼–è¯‘è€Œæˆï¼Œç°åœ¨æˆ‘ä»¬æ¥å°†æ­¤æ–‡ä»¶è¡¥å……å®Œæˆï¼š</p><p><strong>GalaxyOne.h:</strong><br> BinderåŒ–ç›´é€šå¼ï¼ŒåŒæ ·éœ€è¦å°† HIDL_FETCH_XXX æ‰“å¼€ï¼Œè‡³äºåŸå› æˆ‘ä»¬åœ¨åé¢ä¼šæåŠ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/MQDescriptor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;log/log.h&gt;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> galaxy_one &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><span class="hljs-keyword">namespace</span> implementation &#123;<br><br><span class="hljs-keyword">using</span> ::android::hardware::hidl_array;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_memory;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_string;<br><span class="hljs-keyword">using</span> ::android::hardware::hidl_vec;<br><span class="hljs-keyword">using</span> ::android::hardware::Return;<br><span class="hljs-keyword">using</span> ::android::hardware::Void;<br><span class="hljs-keyword">using</span> ::android::sp;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GalaxyOne</span> : <span class="hljs-keyword">public</span> IGalaxyOne &#123;<br>    <span class="hljs-comment">// Methods from ::android::hardware::galaxy_one::V1_0::IGalaxyOne follow.</span><br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">sub</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">mul</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">div</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> <span class="hljs-keyword">override</span></span>;<br><br>    <span class="hljs-comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span><br><br>&#125;;<br><br><span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> most likely delete, this is only for passthrough implementations</span><br> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function">IGalaxyOne* <span class="hljs-title">HIDL_FETCH_IGalaxyOne</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span></span>;<br><br>&#125;  <span class="hljs-comment">// namespace implementation</span><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace galaxy_one</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace android</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// ANDROID_HARDWARE_GALAXY_ONE_V1_0_GALAXYONE_H</span></span><br><br></code></pre></td></tr></table></figure><p><strong>GalaxyOne.cpp:</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;GalaxyOne.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> galaxy_one &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><span class="hljs-keyword">namespace</span> implementation &#123;<br><br><span class="hljs-comment">// Methods from ::android::hardware::galaxy_one::V1_0::IGalaxyOne follow.</span><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::add</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a + b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::add  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::sub</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a - b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::sub  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::mul</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a * b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::mul  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">Return&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">GalaxyOne::div</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> a, <span class="hljs-type">uint32_t</span> b)</span> </span>&#123;<br>    <span class="hljs-type">uint32_t</span> result = a / b;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;GalaxyOne::div  a = %d,b = %d,result = %d&quot;</span>,a,b,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// Methods from ::android::hidl::base::V1_0::IBase follow.</span><br><span class="hljs-function">IGalaxyOne* <span class="hljs-title">HIDL_FETCH_IGalaxyOne</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-comment">/* name */</span>)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOG</span>(<span class="hljs-string">&quot;galaxy_one service init success....&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">GalaxyOne</span>();<br>&#125;<br><br>&#125;  <span class="hljs-comment">// namespace implementation</span><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace galaxy_one</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace android</span><br></code></pre></td></tr></table></figure><h4 id="5-3-4-æ¨¡å—ç¼–è¯‘"><a href="#5-3-4-æ¨¡å—ç¼–è¯‘" class="headerlink" title="5.3.4 æ¨¡å—ç¼–è¯‘"></a>5.3.4 æ¨¡å—ç¼–è¯‘</h4><p>ç°åœ¨é™¤äº†éœ€è¦çš„ <strong>rc</strong> æ–‡ä»¶æ²¡æœ‰è¡¥å……ã€<strong>galaxy-hal-service</strong> æœåŠ¡æ²¡æœ‰ç”Ÿæˆå¤–å…¶ä½™å‡å·²é…ç½®å¥½äº†ï¼Œç°åœ¨è¿›è¡Œç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„åº“ã€‚è¿›å…¥æ ¹ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š(æ³¨æ„æ˜¯åœ¨åˆšåˆšæ‰§è¡Œè¿‡çš„ <strong>source build&#x2F;envsetup.sh</strong> å’Œ <strong>lunch</strong> çš„çª—å£ä¸‹ç¼–è¯‘ï¼Œè‹¥æ˜¯æ–°çª—å£åˆ™éœ€è¦é‡æ–°æ‰§è¡Œè¿™ä¸¤æ¡å‘½ä»¤)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mmm  hardware/interfaces/galaxy_one/1.0<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶åº”è¯¥å¯ä»¥åœ¨ <strong>out&#x2F;tartget&#x2F;product&#x2F;XXX&#x2F;vendor&#x2F;lib64&#x2F;hw</strong> å’Œ <strong>out&#x2F;tartget&#x2F;product&#x2F;XXX&#x2F;system&#x2F;lib64&#x2F;hw</strong> ç›®å½•ä¸‹æ‰¾åˆ° <strong><a href="mailto:&#97;&#110;&#100;&#114;&#x6f;&#105;&#100;&#46;&#104;&#x61;&#114;&#x64;&#119;&#97;&#114;&#x65;&#46;&#103;&#x61;&#x6c;&#97;&#x78;&#121;&#95;&#x6f;&#110;&#x65;&#x40;&#x31;&#x2e;&#x30;&#x2d;&#105;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;">&#97;&#110;&#100;&#114;&#x6f;&#105;&#100;&#46;&#104;&#x61;&#114;&#x64;&#119;&#97;&#114;&#x65;&#46;&#103;&#x61;&#x6c;&#97;&#x78;&#121;&#95;&#x6f;&#110;&#x65;&#x40;&#x31;&#x2e;&#x30;&#x2d;&#105;&#109;&#112;&#x6c;&#x2e;&#x73;&#x6f;</a></strong> å’Œ <strong><a href="mailto:&#97;&#x6e;&#100;&#114;&#x6f;&#x69;&#100;&#46;&#104;&#97;&#x72;&#x64;&#x77;&#97;&#114;&#x65;&#x2e;&#x67;&#x61;&#x6c;&#97;&#x78;&#x79;&#x5f;&#111;&#x6e;&#101;&#64;&#49;&#46;&#x30;&#x2e;&#x73;&#111;">&#97;&#x6e;&#100;&#114;&#x6f;&#x69;&#100;&#46;&#104;&#97;&#x72;&#x64;&#x77;&#97;&#114;&#x65;&#x2e;&#x67;&#x61;&#x6c;&#97;&#x78;&#x79;&#x5f;&#111;&#x6e;&#101;&#64;&#49;&#46;&#x30;&#x2e;&#x73;&#111;</a></strong> ä¸¤ä¸ªåŠ¨æ€åº“</p><h4 id="5-3-5-serviceç”Ÿæˆ"><a href="#5-3-5-serviceç”Ÿæˆ" class="headerlink" title="5.3.5 serviceç”Ÿæˆ"></a>5.3.5 serviceç”Ÿæˆ</h4><p>ä¸Šé¢è¿‡ç¨‹å°†éœ€è¦çš„åŠ¨æ€åº“ç”Ÿæˆå®Œæ¯•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç”Ÿæˆå¯¹åº”çš„ service å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸€å…±åˆ†ä¸ºä¸‰æ­¥ï¼š</p><p><strong>1ã€å‘&#x2F;defaultä¸‹çš„Android.bp æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹</strong></p><figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs make">cc_library &#123;<br>    name: <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service&quot;</span>,<br>    defaults: [<span class="hljs-string">&quot;hidl_defaults&quot;</span>],<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br>    vendor: true,<br>    srcs: [<br>        <span class="hljs-string">&quot;service.cpp&quot;</span><br>    ],<br>    init_rc: [<span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service.rc&quot;</span>],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2ã€è¡¥å…… service.cpp å†…å®¹</strong></p><p>å†…å®¹å¾ˆç®€å•ï¼Œ<strong>defaultPassthroughServiceImplementation</strong> å¸®æˆ‘ä»¬è‡ªåŠ¨æ³¨å†ŒæœåŠ¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0-service&quot;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/LegacySupport.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;GalaxyOne.h&quot;</span></span><br> <br><span class="hljs-comment">// Generated HIDL files</span><br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::IGalaxyOne;<br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::implementation::GalaxyOne;<br> <br><span class="hljs-keyword">using</span> android::hardware::defaultPassthroughServiceImplementation;<br><span class="hljs-keyword">using</span> android::hardware::configureRpcThreadpool;<br><span class="hljs-keyword">using</span> android::hardware::joinRpcThreadpool;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">defaultPassthroughServiceImplementation</span>&lt;IGalaxyOne&gt;();<br>&#125; <br></code></pre></td></tr></table></figure><p><strong>3ã€è¡¥å…… rc æ–‡ä»¶</strong></p><p>æ³¨æ„è¿™é‡Œçš„ <strong>galaxy-hal-service</strong> ç›¸å½“äºè¿™ä¸ªæœåŠ¡çš„åˆ«åï¼Œç³»ç»Ÿå°±æ˜¯æ ¹æ®è¿™ä¸ªæ–‡ä»¶åœ¨å¯åŠ¨çš„åŒæ—¶ä¹Ÿå°†è¿™ä¸ª service å¯åŠ¨ï¼Œå› æ­¤åœ¨ä¸‹é¢æˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•æ—¶æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œä¸è¿‡è¿™é‡Œå…ˆè¡¥å……å®Œæ•´ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">service galaxy-hal-service /vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br>    class hal<br>    user system<br>    group system<br></code></pre></td></tr></table></figure><p>åŒæ ·æ‰§è¡Œ <strong>mmm hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> å‘½ä»¤ï¼Œå®Œæˆä¹‹åå°±ä¼šå¾—åˆ°å¦‚ä¸‹äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ba">out/target/product/sailfish/vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br></code></pre></td></tr></table></figure><h3 id="5-4-clientç«¯"><a href="#5-4-clientç«¯" class="headerlink" title="5.4 clientç«¯"></a>5.4 clientç«¯</h3><p>ç»è¿‡ä¸€ç³»åˆ—è¿‡ç¨‹ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸‰ä¸ªäº§ç‰©<br>1ã€<strong><a href="mailto:&#97;&#x6e;&#100;&#114;&#x6f;&#105;&#100;&#46;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#101;&#46;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#95;&#x6f;&#x6e;&#x65;&#x40;&#49;&#46;&#48;&#x2e;&#x73;&#x6f;">&#97;&#x6e;&#100;&#114;&#x6f;&#105;&#100;&#46;&#104;&#x61;&#114;&#x64;&#x77;&#x61;&#x72;&#101;&#46;&#x67;&#x61;&#x6c;&#x61;&#x78;&#x79;&#95;&#x6f;&#x6e;&#x65;&#x40;&#49;&#46;&#48;&#x2e;&#x73;&#x6f;</a></strong><br>2ã€<strong><a href="mailto:&#x61;&#x6e;&#x64;&#114;&#x6f;&#105;&#x64;&#x2e;&#x68;&#x61;&#x72;&#100;&#119;&#x61;&#114;&#101;&#46;&#x67;&#x61;&#x6c;&#97;&#x78;&#121;&#x5f;&#111;&#110;&#x65;&#64;&#x31;&#x2e;&#48;&#x2d;&#105;&#x6d;&#112;&#108;&#x2e;&#x73;&#111;">&#x61;&#x6e;&#x64;&#114;&#x6f;&#105;&#x64;&#x2e;&#x68;&#x61;&#x72;&#100;&#119;&#x61;&#114;&#101;&#46;&#x67;&#x61;&#x6c;&#97;&#x78;&#121;&#x5f;&#111;&#110;&#x65;&#64;&#x31;&#x2e;&#48;&#x2d;&#105;&#x6d;&#112;&#108;&#x2e;&#x73;&#111;</a></strong><br>3ã€<strong><a href="mailto:&#x61;&#x6e;&#x64;&#x72;&#111;&#105;&#100;&#46;&#x68;&#x61;&#x72;&#100;&#119;&#97;&#114;&#x65;&#46;&#x67;&#x61;&#108;&#97;&#120;&#x79;&#x5f;&#x6f;&#x6e;&#101;&#64;&#x31;&#x2e;&#x30;&#x2d;&#x73;&#101;&#114;&#118;&#x69;&#99;&#101;">&#x61;&#x6e;&#x64;&#x72;&#111;&#105;&#100;&#46;&#x68;&#x61;&#x72;&#100;&#119;&#97;&#114;&#x65;&#46;&#x67;&#x61;&#108;&#97;&#120;&#x79;&#x5f;&#x6f;&#x6e;&#101;&#64;&#x31;&#x2e;&#x30;&#x2d;&#x73;&#101;&#114;&#118;&#x69;&#99;&#101;</a></strong></p><p>ç°åœ¨éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯æ¥æµ‹è¯•è°ƒç”¨ï¼Œå› æ­¤åœ¨ <strong>default</strong> ç›®å½•ä¸‹æ–°å»º <strong>test</strong> ç›®å½•ï¼Œå¹¶æ–°å»º <strong>client.cppã€Android.bp</strong> æ–‡ä»¶ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-cfccd9a1dea02880.png" style="zoom: 67%;"><p><strong>client.cpp å†…å®¹å¦‚ä¸‹ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hardware/galaxy_one/1.0/IGalaxyOne.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;log/log.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> android::sp;<br><span class="hljs-keyword">using</span> android::hardware::galaxy_one::V1_0::IGalaxyOne;<br><span class="hljs-keyword">using</span> android::hardware::Return;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    android::sp&lt;IGalaxyOne&gt; service = IGalaxyOne::<span class="hljs-built_in">getService</span>();<br>    <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;faile to get galaxy_one service......&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;success to get galaxy_one service.....&quot;</span>);<br><br>    <span class="hljs-type">uint32_t</span> addResult = service-&gt;<span class="hljs-built_in">add</span>(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service add: result = %d&quot;</span>,(<span class="hljs-type">int</span>)addResult);<br><br>    <span class="hljs-type">uint32_t</span> subResult = service-&gt;<span class="hljs-built_in">sub</span>(<span class="hljs-number">8</span>,<span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service sub: result = %d&quot;</span>,(<span class="hljs-type">int</span>)subResult);<br><br>    <span class="hljs-type">uint32_t</span> mulResult = service-&gt;<span class="hljs-built_in">mul</span>(<span class="hljs-number">3</span>,<span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service mul: result = %d&quot;</span>,(<span class="hljs-type">int</span>)mulResult);<br><br>    <span class="hljs-type">uint32_t</span> divResult = service-&gt;<span class="hljs-built_in">div</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;galaxy_one service div: result = %d&quot;</span>,(<span class="hljs-type">int</span>)divResult);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Android.bp å†…å®¹å¦‚ä¸‹ï¼š</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile">cc_binary &#123;<br>    name: <span class="hljs-string">&quot;galaxy_test&quot;</span>,    //è¡¨ç¤ºç”Ÿæˆçš„ client åç§°<br>    srcs: [<br>        <span class="hljs-string">&quot;client.cpp&quot;</span><br>    ],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;android.hardware.galaxy_one@1.0&quot;</span>,<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;libhwbinder&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>    ],<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mmm hardware&#x2F;interfaces&#x2F;galaxy_one&#x2F;1.0</strong> å‘½ä»¤ç¼–è¯‘ä¹‹åï¼Œå¯ä»¥åœ¨ <strong>out&#x2F;target&#x2F;product&#x2F;XXX&#x2F;system&#x2F;bin</strong> ç›®å½•ä¸‹æ‰¾åˆ° <strong>galaxy_test</strong> ã€‚</p><h3 id="5-5-å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«"><a href="#5-5-å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«" class="headerlink" title="5.5 å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«"></a>5.5 å£°æ˜ä½¿å¾—Frameworkå¯ä»¥è¯†åˆ«</h3><p><strong>HIDL</strong> æƒ³è¦è¢« <strong>framework</strong> è·å–ä½¿ç”¨è¿˜éœ€è¦åœ¨ <strong>manifest.xml</strong> ä¸­æ³¨å†Œï¼Œæ­¤æ–‡ä»¶ä½äº <code>device/[companyName]/[productName]/manifest.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">hal</span> <span class="hljs-attr">format</span>=<span class="hljs-string">&quot;hidl&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>android.hardware.galaxy_one<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">transport</span>&gt;</span>hwbinder<span class="hljs-tag">&lt;/<span class="hljs-name">transport</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>IGalaxyOne<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">instance</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">instance</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fqname</span>&gt;</span>@1.0::IGalaxyOne/default<span class="hljs-tag">&lt;/<span class="hljs-name">fqname</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">hal</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-6-æ·»åŠ sepolicyç­–ç•¥"><a href="#5-6-æ·»åŠ sepolicyç­–ç•¥" class="headerlink" title="5.6 æ·»åŠ sepolicyç­–ç•¥"></a>5.6 æ·»åŠ sepolicyç­–ç•¥</h3><p>æœ¬æ–‡æš‚æ—¶å…³é—­selinux</p><h2 id="6-éªŒè¯æœåŠ¡"><a href="#6-éªŒè¯æœåŠ¡" class="headerlink" title="6.éªŒè¯æœåŠ¡"></a>6.éªŒè¯æœåŠ¡</h2><h3 id="6-1-pushè®¾å¤‡"><a href="#6-1-pushè®¾å¤‡" class="headerlink" title="6.1 pushè®¾å¤‡"></a>6.1 pushè®¾å¤‡</h3><p>ç°åœ¨æˆ‘ä»¬ä¸€å…±å¾—åˆ° 4 ä¸ªäº§ç‰©ï¼Œä½¿ç”¨ <strong>adb</strong> å‘½ä»¤å°†å…¶ <strong>push</strong> åˆ°æ‰‹æœºå¯¹åº”ç›®å½•ä¸‹ï¼š</p><p>1ã€<a href="mailto:&#97;&#110;&#x64;&#114;&#x6f;&#x69;&#100;&#46;&#x68;&#x61;&#114;&#100;&#x77;&#97;&#114;&#101;&#46;&#x67;&#97;&#108;&#x61;&#120;&#x79;&#x5f;&#111;&#110;&#x65;&#64;&#49;&#x2e;&#x30;&#x2d;&#105;&#x6d;&#112;&#108;&#x2e;&#115;&#x6f;">&#97;&#110;&#x64;&#114;&#x6f;&#x69;&#100;&#46;&#x68;&#x61;&#114;&#100;&#x77;&#97;&#114;&#101;&#46;&#x67;&#97;&#108;&#x61;&#120;&#x79;&#x5f;&#111;&#110;&#x65;&#64;&#49;&#x2e;&#x30;&#x2d;&#105;&#x6d;&#112;&#108;&#x2e;&#115;&#x6f;</a> &#x3D;&#x3D;&#x3D;&gt; &#x2F;vendor&#x2F;lib64&#x2F;hw<br>2ã€<a href="mailto:&#x61;&#x6e;&#x64;&#x72;&#111;&#x69;&#100;&#46;&#x68;&#x61;&#114;&#100;&#119;&#x61;&#114;&#101;&#x2e;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#49;&#46;&#48;&#x2e;&#x73;&#x6f;">&#x61;&#x6e;&#x64;&#x72;&#111;&#x69;&#100;&#46;&#x68;&#x61;&#114;&#100;&#119;&#x61;&#114;&#101;&#x2e;&#103;&#97;&#108;&#97;&#x78;&#121;&#x5f;&#x6f;&#110;&#101;&#64;&#49;&#46;&#48;&#x2e;&#x73;&#x6f;</a> &#x3D;&#x3D;&#x3D;&gt; vendor&#x2F;lib64<br>3ã€<a href="mailto:&#x61;&#x6e;&#x64;&#x72;&#111;&#x69;&#100;&#x2e;&#x68;&#97;&#114;&#100;&#x77;&#97;&#x72;&#x65;&#46;&#x67;&#97;&#x6c;&#x61;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#x65;&#64;&#49;&#46;&#x30;&#x2d;&#x73;&#x65;&#114;&#x76;&#105;&#99;&#101;">&#x61;&#x6e;&#x64;&#x72;&#111;&#x69;&#100;&#x2e;&#x68;&#97;&#114;&#100;&#x77;&#97;&#x72;&#x65;&#46;&#x67;&#97;&#x6c;&#x61;&#x78;&#121;&#x5f;&#x6f;&#x6e;&#x65;&#64;&#49;&#46;&#x30;&#x2d;&#x73;&#x65;&#114;&#x76;&#105;&#99;&#101;</a> &#x3D;&#x3D;&#x3D;&gt; &#x2F;vendor&#x2F;bin&#x2F;hw<br>4ã€galaxy_test &#x3D;&#x3D;&#x3D;&gt; &#x2F;system&#x2F;bin</p><h3 id="6-2-è¿è¡Œservice"><a href="#6-2-è¿è¡Œservice" class="headerlink" title="6.2 è¿è¡Œservice"></a>6.2 è¿è¡Œservice</h3><p>è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨ï¼Œç”¨äºæµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./vendor/bin/hw/android.hardware.galaxy_one@1.0-service<br></code></pre></td></tr></table></figure><h3 id="6-3-è¿è¡Œclient"><a href="#6-3-è¿è¡Œclient" class="headerlink" title="6.3 è¿è¡Œclient"></a>6.3 è¿è¡Œclient</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./system/bin/galaxy_test<br></code></pre></td></tr></table></figure><p>è¿è¡ŒæˆåŠŸä¹‹åå¯æŸ¥çœ‹æ—¥å¿—ï¼Œæœ‰å¦‚ä¸‹å†…å®¹åˆ™è¡¨ç¤ºæœåŠ¡å»ºç«‹æˆåŠŸï¼š</p><img src="/2023/03/10/Android-HIDL%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0/11806352-a17a33c648493e73.png" style="zoom: 75%;">]]></content>
    
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹</title>
    <link href="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/"/>
    <url>/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹"><a href="#æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹"></a>æ–‡ä»¶ç³»ç»Ÿmountè¿‡ç¨‹</h1><blockquote><p>ğŸ’ <strong>ç¯å¢ƒ</strong>ï¼šå†…æ ¸ç‰ˆæœ¬4.5</p><p>ğŸ‰ <strong>è¯´æ˜</strong>ï¼šå‚è€ƒ<a href="https://blog.csdn.net/zr_lang/article/details/39963253%EF%BC%8C%E9%9D%9E%E5%B8%B8%E6%84%9F%E8%B0%A2%EF%BC%8C%E6%94%B6%E8%8E%B7%E9%A2%87%E4%B8%B0">https://blog.csdn.net/zr_lang/article/details/39963253ï¼Œéå¸¸æ„Ÿè°¢ï¼Œæ”¶è·é¢‡ä¸°</a></p></blockquote><p>ä»ç”¨æˆ·ä¸‹å‘mountæŒ‡ä»¤åˆ°å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒ‚è½½ï¼Œå¤§è‡´ç»å†äº†ä¸‹é¢çš„æ­¥éª¤ã€ä»¥<code>f2fs</code>æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ã€‘ã€‚</p><img src="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/image-20230309225903725.png" alt="image-20230309225903725" style="zoom: 67%;"><h2 id="1-æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file-system-type"><a href="#1-æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file-system-type" class="headerlink" title="1.æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file_system_type"></a>1.æ¯ä¸ªäººè¯¥æœ‰çš„æ ·å­file_system_type</h2><p>æ¯ä¸ªäººåœ¨å†²æµªçš„éƒ½æœ‰è‡ªå·±çš„æ˜µç§°ï¼Œè‡ªå·±çš„ä¸ªæ€§æ ‡ç­¾ï¼Œè¿™ä»¿ä½›æ˜¯æ¯ä¸ªäººå…±åŒçš„æ ·å­ï¼Œä¸å¦¨å°†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿä¹ŸæŠ½è±¡æˆåŒä¸€ä¸ªæ ·å­è¡¨ç¤º<code>file_system_type</code>ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè‚¯å®šæœ‰</p><ul><li>name: æ–‡ä»¶ç³»ç»Ÿçš„åå­—ï¼Œå¦‚xfs, ext2ç­‰</li><li>fs_flags: è¯´æ˜æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹</li><li>mount: ä»£æ›¿æ—©æœŸçš„get_sb()ï¼Œç”¨æˆ·æŒ‚è½½æ­¤æ–‡ä»¶ç³»ç»Ÿæ—¶ä½¿ç”¨çš„å›è°ƒå‡½æ•°ã€‚</li><li>kill_sb: åˆ é™¤å†…å­˜ä¸­çš„super blockï¼Œåœ¨å¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä½¿ç”¨ã€‚</li><li>owner: æŒ‡å‘å®ç°è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ¨¡å—ï¼Œé€šå¸¸ä¸ºTHIS_MODULEå®ã€‚</li><li>next: æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿç±»å‹é“¾è¡¨çš„ä¸‹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</li><li>fs_supers: å…·æœ‰åŒæ ·æ­¤æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„è¶…çº§å—ç»“æ„ï¼Œéƒ½ä¸²è¿åœ¨è¿™ä¸ªè¡¨å¤´ä¸‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\fs.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> &#123;</span><br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>        <span class="hljs-type">int</span> fs_flags;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_REQUIRES_DEV         1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_BINARY_MOUNTDATA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_HAS_SUBTYPE          4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_USERNS_MOUNT         8       <span class="hljs-comment">/* Can be mounted by userns root */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_USERNS_DEV_MOUNT     16 <span class="hljs-comment">/* A userns mount does not imply MNT_NODEV */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_RENAME_DOES_D_MOVE   32768   <span class="hljs-comment">/* FS will handle d_move() during rename() internally. */</span></span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *(*<span class="hljs-title">mount</span>) (<span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *, <span class="hljs-title">int</span>, <span class="hljs-title">const</span> <span class="hljs-title">char</span> *, <span class="hljs-title">void</span> *);</span><br>        <span class="hljs-type">void</span> (*kill_sb) (<span class="hljs-keyword">struct</span> super_block *);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">owner</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> * <span class="hljs-title">next</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span> <span class="hljs-title">fs_supers</span>;</span><br>       <span class="hljs-comment">// ....</span><br>        <span class="hljs-comment">//ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæ­¤å¤„çœç•¥è‹¥å¹²é”ç›¸å…³å˜é‡ã€‚</span><br>        <span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨kernelçš„<code>/fs</code>æœ‰å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼Œfile_system_typeç»“æ„ä¸€èˆ¬è¢«å®šä¹‰åœ¨super.cã€‚ä¸‹é¢ä»¥<strong>f2fs</strong>æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ä»‹ç»ä¸€ä¸‹ä»–çš„<code>file_system_type</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fs\f2fs\super.c</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">f2fs_fs_type</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.name= <span class="hljs-string">&quot;f2fs&quot;</span>,<br>.mount= f2fs_mount,<br>.kill_sb= kill_f2fs_super,<br>.fs_flags= FS_REQUIRES_DEV,<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>ownerè¯´æ˜f2fsæ¨¡å—æœ¬èº«æ‹¥æœ‰è¿™ä¸ªfile_system_typeã€‚</p></li><li><p>nameæ˜¯f2fsã€‚</p></li><li><p>fs_flagsæ˜¯FS_REQUIRES_DEVï¼Œè¡¨æ˜f2fsä¸€å®šè¦è¢«ä½¿ç”¨åœ¨ç‰©ç†è®¾å¤‡ä¸Šã€‚</p></li><li><p>mountæ˜¯f2fs_mountï¼Œè¯´æ˜ f2fs_mountè¿™ä¸ªå‡½æ•°å®ç°äº†f2fsçš„å…·ä½“mountæ“ä½œã€‚åœ¨ç¬¬3èŠ‚é˜è¿°</p></li></ul><h2 id="2-æ³¨å†Œè´¦å·register-filesystem"><a href="#2-æ³¨å†Œè´¦å·register-filesystem" class="headerlink" title="2.æ³¨å†Œè´¦å·register_filesystem"></a>2.æ³¨å†Œè´¦å·register_filesystem</h2><p>å½“ç„¶ï¼Œä½ è‡ªå·±æƒ³è±¡å¥½äº†è‡ªå·±çš„æ˜µç§°ï¼Œè‡ªå·±çš„ä¸ªæ€§è¡¨å‹ï¼Œè‡ªå·±çš„èƒ½åŠ›ï¼Œè¿˜æœ‰è‡ªå·±çš„ä¸€ä»½ç®€å†ã€superblockã€‘ï¼Œä¸æ³¨å†Œè´¦å·æ€ä¹ˆå†²æµªå˜›ğŸ„</p><p>åŒç†å½“åˆå§‹åŒ–å¥½äº†ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¹Ÿè¦å‘å†…æ ¸è¿›è¡Œæ³¨å†Œ<code>register_filesystem</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">register_filesystem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type * fs)</span><br>&#123;<br>        <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> ** <span class="hljs-title">p</span>;</span><br> <br>        BUG_ON(<span class="hljs-built_in">strchr</span>(fs-&gt;name, <span class="hljs-string">&#x27;.&#x27;</span>));<br>        <span class="hljs-keyword">if</span> (fs-&gt;next)<br>                <span class="hljs-keyword">return</span> -EBUSY;<br>        write_lock(&amp;file_systems_lock);<br>       <br>        <span class="hljs-comment">// éå†å…¨å±€file_systemsé“¾è¡¨ï¼Œå°è¯•æŸ¥æ‰¾æœ¬æ¬¡è¦æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿåã€‚</span><br>        p = find_filesystem(fs-&gt;name, <span class="hljs-built_in">strlen</span>(fs-&gt;name));<br>        <span class="hljs-keyword">if</span> (*p) <span class="hljs-comment">// å¦‚æœä¸ä¸ºNULLï¼Œåˆ™è¯´æ˜æ‰¾åˆ°äº†é‡åçš„æ–‡ä»¶ç³»ç»Ÿã€‚æ³¨å†Œå¤±è´¥ã€‚</span><br>                res = -EBUSY;<br>        <span class="hljs-keyword">else</span> <span class="hljs-comment">// å¦‚æœè¿”å›NULLï¼Œè¯´æ˜å·²ç»åˆ°é“¾è¡¨ç»“å°¾ï¼Œå¯ä»¥æ³¨å†Œæ­¤æ–‡ä»¶ç³»ç»Ÿã€‚</span><br>                *p = fs; <span class="hljs-comment">// å°†æ­¤æ–‡ä»¶ç³»ç»Ÿé“¾æ¥åˆ°é“¾è¡¨ç»“å°¾ã€‚</span><br>        write_unlock(&amp;file_systems_lock);<br>        <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>file_system_typeçš„åŸºæœ¬æ“ä½œéƒ½åœ¨fs&#x2F;filesystems.cæ–‡ä»¶é‡Œï¼Œæ–‡ä»¶ä¸é•¿ï¼Œå¯ä»¥ç®€çŸ­çš„æµè§ˆä¸€ä¸‹éƒ½æœ‰é‚£äº›æ“ä½œå‡½æ•°ã€‚æœ€ä¸»è¦çš„å˜é‡è«è¿‡äºæ­¤æ–‡ä»¶å†…çš„å…¨å±€å˜é‡ï¼š</p><p>&#x2F;&#x2F; æ­¤å˜é‡æ˜¯æ–‡ä»¶ç³»ç»Ÿç±»å‹å•é“¾è¡¨çš„å¤´æŒ‡é’ˆ<code>static struct file_system_type *file_systems</code></p></blockquote><p>é‚£ä¹ˆf2fsåœ¨å“ªé‡Œæ³¨å†Œçš„å‘¢ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">init_f2fs_fs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    err = register_filesystem(&amp;f2fs_fs_type);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-å¼€å§‹å±äºf2fsçš„mount"><a href="#3-å¼€å§‹å±äºf2fsçš„mount" class="headerlink" title="3.å¼€å§‹å±äºf2fsçš„mount"></a>3.å¼€å§‹å±äºf2fsçš„mount</h2><p>åœ¨æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œ<code>mount -t f2fs /dev/xxx /mntdir/xxx</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šå»è°ƒç”¨f2fsçš„mountå‡½æ•°ï¼Œåœ¨ç¬¬1èŠ‚çš„f2fs_fs_typeæŒ‡æ˜äº†f2fsæ–‡ä»¶ç³»ç»Ÿçš„mountå‡½æ•°ä¸º<code>f2fs_mount</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> dentry *<span class="hljs-title function_">f2fs_mount</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_name, <span class="hljs-type">void</span> *data)</span><br>&#123;<br><span class="hljs-keyword">return</span> mount_bdev(fs_type, flags, dev_name, data, f2fs_fill_super);<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ªmount_bdev()å‡½æ•°ï¼Œä½†æ˜¯çœ‹å‚æ•°å¯ä»¥çœ‹åˆ°ä¸€äº›é‡è¦çš„ä¸œè¥¿</p><ul><li>fs_typeä¸ç”¨å¤šè¯´ï¼Œæºå¸¦file_system_typeçš„ä¿¡æ¯ï¼Œè¿™é‡Œä¼ é€’å®ƒä¸»è¦æ˜¯å› ä¸ºå®ƒæºå¸¦äº†super blockçš„é“¾è¡¨å’Œå¾ˆå¤šé”å˜é‡ã€‚</li><li>flagsæ–‡ä»¶ç³»ç»Ÿçš„é€šç”¨æŒ‚è½½é€‰é¡¹ã€‚</li><li>dev_nameæ˜¯mountæ“ä½œæ—¶çš„è®¾å¤‡åï¼Œå¦‚&#x2F;dev&#x2F;sda1ã€‚åé¢ä¼šç”¨åˆ°è¿™ä¸ªè®¾å¤‡åæ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯ï¼Œä»è€Œä»ä¸­è·å¾—super blockã€‚</li><li>dataæ˜¯æŒ‚è½½æ—¶æŒ‡å®šçš„æŒ‚è½½é€‰é¡¹ä¿¡æ¯ã€‚</li><li>f2fs_fill_superæ˜¯ä¸€ä¸ªç”±f2fsç‰¹å®šå®ç°çš„fill_superæ–¹æ³•ï¼Œç”¨æ¥æ ¹æ®f2fsæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§è§£æmount dataå¹¶ç»§ç»­å¡«å……super blockçš„å­—æ®µï¼Œå¹¶ä¸”åˆå§‹åŒ–æŒ‚è½½ç‚¹çš„æ ¹ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡å’Œç›®å½•é¡¹å¯¹è±¡ã€‚</li></ul><h2 id="4-æŒ‚è½½é€‰é¡¹flagå’Œdata"><a href="#4-æŒ‚è½½é€‰é¡¹flagå’Œdata" class="headerlink" title="4.æŒ‚è½½é€‰é¡¹flagå’Œdata"></a>4.æŒ‚è½½é€‰é¡¹flagå’Œdata</h2><p>åœ¨ç¬¬3èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°f2fsæŒ‚è½½çš„æ—¶å€™æœ‰flagså’Œdataï¼Œä½†æ˜¯æˆ‘ä»¬å¹³å¸¸æŒ‚è½½çš„åªæœ‰ä¸€ä¸ª<code>- o</code>å‚æ•°å•Šï¼Œä¾‹å¦‚<code>mount -t f2fs -o ro /dev/xxx /mntdir/xxx</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åŒºåˆ†å…·ä½“çš„flagå’Œdataå‘¢ï¼Ÿ</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹flagséƒ½æœ‰å“ªäº›å¯é€‰å€¼(å–è‡ª<code>include/uapi/linux/fs.h</code>)ï¼Œæˆ‘ä»¬æ¥å°½é‡æŠŠå®ƒä»¬å’Œmountå‘½ä»¤é‡Œçš„é€‰é¡¹å¯¹åº”ä¸€ä¸‹(man 2 mount)ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * These are the fs-independent mount-flags: up to 32 flags are supported</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RDONLY        1         <span class="hljs-comment">/* å¯¹åº”-o ro/rw */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOSUID        2         <span class="hljs-comment">/* å¯¹åº”-o suid/nosuid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NODEV         4         <span class="hljs-comment">/*  å¯¹åº”-o suid/nosuid */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOEXEC        8         <span class="hljs-comment">/* å¯¹åº”-o exec/noexec */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SYNCHRONOUS  16         <span class="hljs-comment">/* å¯¹åº”-o sync/async */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_REMOUNT      32         <span class="hljs-comment">/* å¯¹åº”-o remountï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡remountæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MANDLOCK     64         <span class="hljs-comment">/* å¯¹åº”-o mand/nomand */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_DIRSYNC      128        <span class="hljs-comment">/* å¯¹åº”-o dirsync */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOATIME      1024       <span class="hljs-comment">/* å¯¹åº”-o atime/noatime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NODIRATIME   2048       <span class="hljs-comment">/* å¯¹åº”-o diratime/nodiratime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_BIND         4096       <span class="hljs-comment">/* å¯¹åº”-B/--bindé€‰é¡¹ï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡bindæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MOVE         8192       <span class="hljs-comment">/* å¯¹åº”-M/--moveï¼Œå‘Šè¯‰mountè¿™æ˜¯ä¸€æ¬¡moveæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_REC          16384      <span class="hljs-comment">/* recæ˜¯recursiveçš„æ„æ€ï¼Œè¿™ä¸ªflagä¸€èˆ¬ä¸å•ç‹¬å‡ºç°ï¼Œéƒ½æ˜¯ä¼´éšè¿™å…¶å®ƒflagï¼Œè¡¨ç¤ºé€’å½’çš„è¿›è¡Œæ“ä½œ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_VERBOSE      32768      <span class="hljs-comment">/* å¯¹åº”-v/--verbose */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SILENT       32768      <span class="hljs-comment">/* å¯¹åº”-o silent/loud */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_POSIXACL     (1&lt;&lt;16)    <span class="hljs-comment">/* è®©VFSä¸åº”ç”¨umaskï¼Œå¦‚NFS */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_UNBINDABLE   (1&lt;&lt;17)    <span class="hljs-comment">/* å¯¹åº”--make-unbindable */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_PRIVATE      (1&lt;&lt;18)    <span class="hljs-comment">/* å¯¹åº”--make-private */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SLAVE        (1&lt;&lt;19)    <span class="hljs-comment">/* å¯¹åº”--make-slave */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_SHARED       (1&lt;&lt;20)    <span class="hljs-comment">/* å¯¹åº”--make-shared */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RELATIME     (1&lt;&lt;21)    <span class="hljs-comment">/* å¯¹åº”-o relatime/norelatime */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_KERNMOUNT    (1&lt;&lt;22)    <span class="hljs-comment">/* è¿™ä¸ªä¸€èˆ¬ä¸åœ¨åº”ç”¨å±‚ä½¿ç”¨ï¼Œä¸€èˆ¬å†…æ ¸æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå¦‚sysfsä½¿ç”¨ï¼Œè¡¨ç¤ºä½¿ç”¨kern_mount()è¿›è¡ŒæŒ‚è½½ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_I_VERSION    (1&lt;&lt;23)    <span class="hljs-comment">/* å¯¹åº”-o iversion/noiversion */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_STRICTATIME  (1&lt;&lt;24)    <span class="hljs-comment">/* å¯¹åº”-o strictatime/nostrictatime */</span></span><br> <br><span class="hljs-comment">/* ä¸‹é¢è¿™å‡ ä¸ªflagséƒ½æ˜¯å†…æ ¸å†…éƒ¨ä½¿ç”¨çš„ï¼Œå®ƒä»¬çš„å«ä¹‰æˆ‘åªæ˜¯é€šè¿‡ç®€å•çš„æŸ¥çœ‹ä»£ç é€»è¾‘æš‚æ—¶çŒœæµ‹çš„ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOSEC        (1&lt;&lt;28)    <span class="hljs-comment">/* æœ‰äº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒsuidï¼Œsecurity xattrç­‰å®‰å…¨æ ‡è®° */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_BORN         (1&lt;&lt;29)    <span class="hljs-comment">/* è¡¨ç¤ºå†…å­˜superblockå·²ç»åˆ›å»ºå®Œæˆ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_ACTIVE       (1&lt;&lt;30)    <span class="hljs-comment">/* è¡¨ç¤ºå†…å­˜superblockæ­£å¤„äºæ´»åŠ¨çŠ¶æ€ */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_NOUSER       (1&lt;&lt;31)    <span class="hljs-comment">/* è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿä¸èƒ½è¢«åº”ç”¨å±‚æŒ‚è½½ä½¿ç”¨ï¼Œåªèƒ½è¢«å†…æ ¸ä½¿ç”¨ï¼Œå¦‚rootfs */</span></span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Superblock flags that can be altered by MS_REMOUNT</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_RMT_MASK     (MS_RDONLY|MS_SYNCHRONOUS|MS_MANDLOCK|MS_I_VERSION)  <span class="hljs-comment">// å¯ä»¥åœ¨remountæ˜¯æ”¹å˜çš„flags</span></span><br> <br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Old magic mount flag and mask</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MGC_VAL 0xC0ED0000      <span class="hljs-comment">/* è¿‡å»ä½¿ç”¨çš„magicï¼Œç°åœ¨åŸºæœ¬è¢«å¿½ç•¥äº† */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MS_MGC_MSK 0xffff0000      <span class="hljs-comment">/* è¿‡å»ä½¿ç”¨çš„flagçš„çš„mask */</span></span><br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒflagsåŸºæœ¬ä¸Šæ˜¯optionsä¸­é€šç”¨çš„é‚£äº›ï¼Œä¹Ÿå°±æ˜¯è¯´åŸºæœ¬æ˜¯<strong>é¢å‘æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿé€šç”¨çš„</strong>ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›æ˜¯å†…æ ¸ä½¿ç”¨çš„ã€‚è¿™äº›flagså¤§éƒ¨åˆ†éƒ½åœ¨VFSå±‚è¢«è§£æä½¿ç”¨ã€‚</p><p>è€Œdataå‘¢ï¼ŒæŠŠoptionsä¸­é€šç”¨çš„å»æ‰ï¼Œ<strong>å‰©ä¸‹çš„å°±æ˜¯æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿå„è‡ªæ”¯æŒçš„æŒ‚è½½é€‰é¡¹</strong>ã€‚</p><p>ğŸˆè®©æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼šæˆ‘ä»¬é€‰å–ä¸€ä¸ªä¸flagså¯¹åº”çš„optionï¼Œå¦‚nodevã€‚åœ¨ä»xfsã€ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ç³»ç»Ÿã€‘ä¸­é€‰å–ä¸€ä¸ªç‰¹å®šçš„optionï¼Œå¦‚noquotaã€‚ç„¶åç”¨straceè·Ÿè¸ªä¸€ä¸‹mountçš„è¿‡ç¨‹ï¼Œæ‰§è¡Œ</p><p><code>strace mount /dev/loop0 /mnt/test -o noquota,nodev</code></p><p>åœ¨æ¥è¿‘æœ€åçš„ä½ç½®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°mountç³»ç»Ÿè°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">mount(<span class="hljs-string">&quot;/dev/loop0&quot;</span>, <span class="hljs-string">&quot;/mnt/test&quot;</span>, <span class="hljs-string">&quot;xfs&quot;</span>, MS_MGC_VAL|MS_NODEV, <span class="hljs-string">&quot;noquota&quot;</span>) = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>æœç„¶ï¼Œnodevè¢«è§£é‡Šä¸ºflagï¼Œnoquotaè¢«å½“ä½œäº†mount dataã€‚</p><h2 id="5-mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys-mountï¼‰"><a href="#5-mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys-mountï¼‰" class="headerlink" title="5.mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys_mountï¼‰"></a>5.mountç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼ˆsys_mountï¼‰</h2><p>å¦‚æœè¦ç ”ç©¶mountçš„æ‰§è¡Œè¿‡ç¨‹å…ˆè¦æ‰¾åˆ°mountçš„å‘èµ·ä½ç½®ï¼Œæœ‰äº›mountæ˜¯å†…æ ¸å‘èµ·çš„ï¼Œç”±å†…æ ¸è‡ªä¸»æŒ‚è½½ã€‚è€Œç»å¤§éƒ¨åˆ†çš„mountéƒ½æ˜¯ç”¨æˆ·é€šè¿‡mountç³»ç»Ÿè°ƒç”¨å‘èµ·çš„ï¼Œæˆ‘ä»¬å°±ä»¥åè€…ä¸ºèµ·ç‚¹å¼€å§‹åˆ†æã€‚<strong>mountç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆsys_mountï¼‰å®šä¹‰åœ¨fs&#x2F;namespace.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fs\namespace.c</span><br><br>SYSCALL_DEFINE5(mount, <span class="hljs-type">char</span> __user *, dev_name, <span class="hljs-type">char</span> __user *, dir_name,<br>                <span class="hljs-type">char</span> __user *, type, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, flags, <span class="hljs-type">void</span> __user *, data)<br>&#123;<br>        <span class="hljs-type">int</span> ret;<br>        <span class="hljs-type">char</span> *kernel_type;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">filename</span> *<span class="hljs-title">kernel_dir</span>;</span><br>        <span class="hljs-type">char</span> *kernel_dev;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> data_page;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿç±»å‹å */</span><br>        ret = copy_mount_string(type, &amp;kernel_type);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_type;<br> <br>        <span class="hljs-comment">/* å¾—åˆ°æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹å */</span><br>        kernel_dir = getname(dir_name);<br>        <span class="hljs-keyword">if</span> (IS_ERR(kernel_dir)) &#123;<br>                ret = PTR_ERR(kernel_dir);<br>                <span class="hljs-keyword">goto</span> out_dir;<br>        &#125;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡å */</span><br>        ret = copy_mount_string(dev_name, &amp;kernel_dev);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_dev;<br> <br>        <span class="hljs-comment">/* æ‹·è´å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿå®šåˆ¶çš„mount data */</span><br>        ret = copy_mount_options(data, &amp;data_page);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">goto</span> out_data;<br> <br>        <span class="hljs-comment">/* åˆ°æ­¤mountæ‰€éœ€è¦çš„fstype, dev_name, mountpoint, flagså’Œdataè¿™å‡ ä¸ªå‚æ•°éƒ½æ‹·è´åˆ°å†…æ ¸ç©ºé—´äº† */</span><br>        <span class="hljs-comment">/* è°ƒç”¨do_mountå‡½æ•°ç»§ç»­ä¸‹é¢çš„æ“ä½œ */</span><br>        ret = do_mount(kernel_dev, kernel_dir-&gt;name, kernel_type, flags,<br>                (<span class="hljs-type">void</span> *) data_page);<br> <br>        free_page(data_page);<br>out_data:<br>        kfree(kernel_dev);<br>out_dev:<br>        putname(kernel_dir);<br>out_dir:<br>        kfree(kernel_type);<br>out_type:<br>        <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-do-mountè°ƒç”¨"><a href="#6-do-mountè°ƒç”¨" class="headerlink" title="6.do_mountè°ƒç”¨"></a>6.do_mountè°ƒç”¨</h2><p>ç³»ç»Ÿè°ƒç”¨sys_mountåï¼Œä¼šç»§ç»­æ‰§è¡Œdo_mountå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨VFSå±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">do_mount</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dir_name,</span><br><span class="hljs-params">                <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type_page, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags, <span class="hljs-type">void</span> *data_page)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span> <span class="hljs-title">path</span>;</span><br>        <span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> mnt_flags = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">/* Discard magic */</span><br>        <span class="hljs-keyword">if</span> ((flags &amp; MS_MGC_MSK) == MS_MGC_VAL)<br>                flags &amp;= ~MS_MGC_MSK;<br>        <span class="hljs-comment">/* Basic sanity checks */</span><br>        <span class="hljs-keyword">if</span> (!dir_name || !*dir_name || !<span class="hljs-built_in">memchr</span>(dir_name, <span class="hljs-number">0</span>, PAGE_SIZE))<br>                <span class="hljs-keyword">return</span> -EINVAL;<br>        <span class="hljs-keyword">if</span> (data_page)<br>                ((<span class="hljs-type">char</span> *)data_page)[PAGE_SIZE - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// æŠŠmountpointè§£é‡Šæˆpathå†…æ ¸ç»“æ„ï¼Œè¿™é‡Œæ˜¯è·¯å¾„åè§£æçš„è¿‡ç¨‹</span><br>        <span class="hljs-comment">// è°ƒç”¨do_path_lookupã€‚å…³äºè·¯å¾„åè§£ææˆ‘ä»¬åé¢å†è¯´</span><br>        <span class="hljs-comment">/* ... and get the mountpoint */</span><br>        retval = kern_path(dir_name, LOOKUP_FOLLOW, &amp;path);<br>        <span class="hljs-keyword">if</span> (retval)<br>                <span class="hljs-keyword">return</span> retval;<br>        retval = security_sb_mount(dev_name, &amp;path,<br>                                   type_page, flags, data_page);<br>        <span class="hljs-keyword">if</span> (!retval &amp;&amp; !may_mount())<br>                retval = -EPERM;<br>        <span class="hljs-keyword">if</span> (retval)<br>                <span class="hljs-keyword">goto</span> dput_out;<br>        <span class="hljs-comment">// ä»è¿™é‡Œå¼€å§‹å°±æ˜¯ä¸€ç³»åˆ—çš„å¯¹flagsçš„è§£æï¼ŒæŠŠé€šç”¨optionæå‡ºæ¥</span><br>        <span class="hljs-comment">// å¹¶ä¸”æ‰¾å‡ºæˆ‘ä»¬è¦mountåšå“ªç§æ“ä½œï¼Œå¦‚bind, remount, newmountç­‰</span><br>        <span class="hljs-comment">/* Default to relatime unless overriden */</span><br>        <span class="hljs-keyword">if</span> (!(flags &amp; MS_NOATIME))<br>                mnt_flags |= MNT_RELATIME;<br>        <span class="hljs-comment">/* Separate the per-mountpoint flags */</span><br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOSUID)<br>                mnt_flags |= MNT_NOSUID;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NODEV)<br>                mnt_flags |= MNT_NODEV;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOEXEC)<br>                mnt_flags |= MNT_NOEXEC;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NOATIME)<br>                mnt_flags |= MNT_NOATIME;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_NODIRATIME)<br>                mnt_flags |= MNT_NODIRATIME;<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_STRICTATIME)<br>                mnt_flags &amp;= ~(MNT_RELATIME | MNT_NOATIME);<br>        <span class="hljs-keyword">if</span> (flags &amp; MS_RDONLY)<br>                mnt_flags |= MNT_READONLY;<br>        <span class="hljs-comment">/* The default atime for remount is preservation */</span><br>        <span class="hljs-keyword">if</span> ((flags &amp; MS_REMOUNT) &amp;&amp;<br>            ((flags &amp; (MS_NOATIME | MS_NODIRATIME | MS_RELATIME |<br>                       MS_STRICTATIME)) == <span class="hljs-number">0</span>)) &#123;<br>                mnt_flags &amp;= ~MNT_ATIME_MASK;<br>                mnt_flags |= path.mnt-&gt;mnt_flags &amp; MNT_ATIME_MASK;<br>        &#125;<br>        flags &amp;= ~(MS_NOSUID | MS_NOEXEC | MS_NODEV | MS_ACTIVE | MS_BORN |<br>                   MS_NOATIME | MS_NODIRATIME | MS_RELATIME| MS_KERNMOUNT |<br>                   MS_STRICTATIME);<br>        <span class="hljs-comment">// æ ¹æ®flagsçš„æŒ‡ç¤ºï¼Œå†³å®šåšå“ªç§mountæ“ä½œ</span><br>        <span class="hljs-keyword">if</span> (flags &amp; MS_REMOUNT)<br>                retval = do_remount(&amp;path, flags &amp; ~MS_REMOUNT, mnt_flags,<br>                                    data_page);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; MS_BIND)<br>                retval = do_loopback(&amp;path, dev_name, flags &amp; MS_REC);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; (MS_SHARED | MS_PRIVATE | MS_SLAVE | MS_UNBINDABLE))<br>                retval = do_change_type(&amp;path, flags);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (flags &amp; MS_MOVE)<br>                retval = do_move_mount(&amp;path, dev_name);<br>        <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// æˆ‘ä»¬è¿™é‡Œä»¥new mountä¸ºå…¥æ‰‹ç‚¹ï¼Œç»§ç»­å‘ä¸‹åˆ†æ</span><br>                retval = do_new_mount(&amp;path, type_page, flags, mnt_flags,<br>                                      dev_name, data_page);<br>dput_out:<br>        path_put(&amp;path);<br>        <span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¾—å‡ºdo_mountä¸»è¦å¹²è¿™ä¹ˆå‡ ä¸ªäº‹ï¼š</p><ol><li><p>è§£æmountpointè·¯å¾„åï¼ŒæŠŠå­—ç¬¦ä¸²è·¯å¾„åå˜æˆå†…æ ¸dentryæˆ–è€…è¯´pathç»“æ„</p></li><li><p>è§£æflagsï¼ŒæŠŠé€šç”¨optionåˆ†å‡ºæ¥ã€‚</p></li><li><p>æ ¹æ®flagsä¸­æŒ‡æ˜mountæ“ä½œçš„æ ‡å¿—ï¼Œå†³å®šåšå“ªä¸€ç§mountæ“ä½œã€‚</p></li><li><p>æ‰§è¡Œremount&#x2F;bind&#x2F;shared&#x2F;move&#x2F;new mountæ“ä½œã€‚</p></li></ol><p>åˆ°æ­¤mountå°±å¯èƒ½åš5ç§mountæ“ä½œï¼ˆremount, bind, chang type, moveå’Œnew mountï¼‰ä¹‹ä¸€ã€‚æˆ‘ä»¬ä»¥do_new_mountä¸ºä¾‹ç»§ç»­åˆ†æï¼Œdo_new_mountå±äºæœ€å¸¸è§çš„æƒ…å†µï¼ŒæŒ‚è½½ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="7-do-new-mountè°ƒç”¨"><a href="#7-do-new-mountè°ƒç”¨" class="headerlink" title="7.do_new_mountè°ƒç”¨"></a>7.do_new_mountè°ƒç”¨</h2><p>do_new_mountå‡½æ•°ä¹Ÿåœ¨namespace.cé‡Œå¯ä»¥æ‰¾åˆ°ï¼Œå®ƒä¸»è¦åšä¸‰ä»¶äº‹ï¼š</p><ol><li>æ ¹æ®fstypeä»å…¨å±€æ–‡ä»¶ç³»ç»Ÿç±»å‹(file_system_type)é“¾è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ç»“æ„</li><li>ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹ç»“æ„ä¸­çš„mountå›è°ƒå‡½æ•°æ‰§è¡Œä¸‹é¢çš„æŒ‚è½½æ“ä½œï¼Œæœ€ç»ˆæ„å»ºä¸€ä¸ªmountç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«vfsmountä¿¡æ¯ã€‚</li><li>å°†å¾—åˆ°çš„mountç»“æ„ä½“åŠ å…¥å…¨å±€æ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_new_mount</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> path *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fstype, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">                        <span class="hljs-type">int</span> mnt_flags, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">type</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> *<span class="hljs-title">user_ns</span> =</span> current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfsmount</span> *<span class="hljs-title">mnt</span>;</span><br>        <span class="hljs-type">int</span> err;<br> <br>        <span class="hljs-keyword">if</span> (!fstype)<br>                <span class="hljs-keyword">return</span> -EINVAL;<br> <br>        <span class="hljs-comment">// æ ¹æ®fsç±»å‹åï¼ˆå¦‚xfsï¼‰åœ¨å…¨å±€æ–‡ä»¶ç³»ç»Ÿç±»å‹é“¾è¡¨ä¸Šæ‰¾åˆ°å…¶å¯¹åº”çš„file_system_typeç»“æ„</span><br>        type = get_fs_type(fstype);<br>        <span class="hljs-keyword">if</span> (!type)<br>                <span class="hljs-keyword">return</span> -ENODEV;<br> <br>        <span class="hljs-comment">// è°ƒç”¨æ­¤å‡½æ•°å‡†å¤‡è¿›å…¥æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¸ªåˆ«å¤„ç†å‡½æ•°ï¼Œæ„å»ºä¸€ä¸ªvfsmntç»“æ„</span><br>        <span class="hljs-comment">// æ³¨æ„è¿™é‡Œä»¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€æŒ‚è½½æ ‡è®°ã€è®¾å¤‡åå’ŒæŒ‚è½½é€‰é¡¹ä¿¡æ¯ä¸ºå‚æ•°ï¼Œå¹¶æ²¡æœ‰mountpointå‚æ•°ã€‚è¿™é‡Œåªæ˜¯æƒ³ç”¨typeä¸­çš„mountå›è°ƒå‡½æ•°è¯»å–è®¾å¤‡çš„superblockä¿¡æ¯ï¼Œå¡«å……mntç»“æ„ï¼Œç„¶åæŠŠflagå’Œdataè§£æåå¡«å……åˆ°mntç»“æ„ä¸­ã€‚</span><br>        mnt = vfs_kern_mount(type, flags, name, data);<br>        <span class="hljs-keyword">if</span> (!IS_ERR(mnt) &amp;&amp; (type-&gt;fs_flags &amp; FS_HAS_SUBTYPE) &amp;&amp;<br>            !mnt-&gt;mnt_sb-&gt;s_subtype)<br>                mnt = fs_set_subtype(mnt, fstype);<br> <br>        put_filesystem(type);<br>        <span class="hljs-keyword">if</span> (IS_ERR(mnt))<br>                <span class="hljs-keyword">return</span> PTR_ERR(mnt);<br> <br>        <span class="hljs-comment">// å‡†å¤‡å°†å¾—åˆ°çš„mntç»“æ„åŠ å…¥å…¨å±€æ–‡ä»¶ç³»ç»Ÿæ ‘</span><br>        <span class="hljs-comment">// æ³¨æ„pathå˜é‡ï¼Œä¹Ÿå°±æ˜¯mountpointåœ¨è¿™é‡Œ</span><br>        err = do_add_mount(real_mount(mnt), path, mnt_flags);<br>        <span class="hljs-keyword">if</span> (err)<br>                mntput(mnt);<br>        <span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="99-å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file-operations"><a href="#99-å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file-operations" class="headerlink" title="99.å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file_operations"></a>99.å‘é©±åŠ¨å¤§å“¥å­¦ä¹ ï¼Œèµ°è¿›file_operations</h2><p>æˆ‘ä»¬æŒ‰ç…§å­¦ä¹ é©±åŠ¨çš„æ–¹å¼ï¼Œå­¦ä¹ æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚åœ¨å­¦ä¹ é©±åŠ¨çš„æ—¶å€™ï¼Œæœ€å…³é”®çš„å°±æ˜¯å­—ç¬¦è®¾å¤‡æ“ä½œé›†<code>file_operations </code>ï¼Œæˆ‘ä»¬å†™é©±åŠ¨çš„æ—¶å€™ä¼šåˆå§‹åŒ–æ¯ä¸€ä¸ªé©±åŠ¨å¯¹åº”çš„æ“ä½œé›†ï¼Œä¾‹å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªledé©±åŠ¨ï¼Œæˆ‘ä»¬å¸¸å¸¸å†™æˆä¸‹é¢çš„æ ·å­ï¼Œæ¯ä¸€ä¸ªfile_operationçš„æ“ä½œï¼Œå¦‚openã€writeéƒ½åœ¨è‡ªå·±çš„é©±åŠ¨ä¸­æŒ‡æ˜å¯¹åº”çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">led_fops</span> =</span> &#123;<br>    .owner = THIS_MODULE,<br>    .open = led_open,<br>    .write = led_write,<br>    .release = led_release,<br>&#125;;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯é€šç”¨çš„é“ç†ï¼Œä¹Ÿæœ‰æ–‡ä»¶ç³»ç»Ÿè‡ªå·±çš„æ“ä½œé›†<code>file_operations</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// include\linux\fs.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">owner</span>;</span><br><span class="hljs-type">loff_t</span> (*llseek) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">int</span>);<br><span class="hljs-type">ssize_t</span> (*read) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">char</span> __user *, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *);<br><span class="hljs-type">ssize_t</span> (*write) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *);<br><span class="hljs-type">ssize_t</span> (*read_iter) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-keyword">struct</span> iov_iter *);<br><span class="hljs-type">ssize_t</span> (*write_iter) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-keyword">struct</span> iov_iter *);<br><span class="hljs-type">int</span> (*iterate) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> dir_context *);<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span> <span class="hljs-params">(*poll)</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> poll_table_struct *)</span>;<br><span class="hljs-type">long</span> (*unlocked_ioctl) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br><span class="hljs-type">long</span> (*compat_ioctl) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>);<br><span class="hljs-type">int</span> (*mmap) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> vm_area_struct *);<br><span class="hljs-type">int</span> (*mremap)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> vm_area_struct *);<br><span class="hljs-type">int</span> (*open) (<span class="hljs-keyword">struct</span> inode *, <span class="hljs-keyword">struct</span> file *);<br><span class="hljs-type">int</span> (*flush) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">fl_owner_t</span> id);<br><span class="hljs-type">int</span> (*release) (<span class="hljs-keyword">struct</span> inode *, <span class="hljs-keyword">struct</span> file *);<br><span class="hljs-type">int</span> (*fsync) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span>, <span class="hljs-type">loff_t</span>, <span class="hljs-type">int</span> datasync);<br><span class="hljs-type">int</span> (*aio_fsync) (<span class="hljs-keyword">struct</span> kiocb *, <span class="hljs-type">int</span> datasync);<br><span class="hljs-type">int</span> (*fasync) (<span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*lock) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file_lock *);<br><span class="hljs-type">ssize_t</span> (*sendpage) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-keyword">struct</span> page *, <span class="hljs-type">int</span>, <span class="hljs-type">size_t</span>, <span class="hljs-type">loff_t</span> *, <span class="hljs-type">int</span>);<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">long</span> <span class="hljs-params">(*get_unmapped_area)</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)</span>;<br><span class="hljs-type">int</span> (*check_flags)(<span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*flock) (<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">int</span>, <span class="hljs-keyword">struct</span> file_lock *);<br><span class="hljs-type">ssize_t</span> (*splice_write)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span> *, <span class="hljs-type">size_t</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>);<br><span class="hljs-type">ssize_t</span> (*splice_read)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">loff_t</span> *, <span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-type">size_t</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>);<br><span class="hljs-type">int</span> (*setlease)(<span class="hljs-keyword">struct</span> file *, <span class="hljs-type">long</span>, <span class="hljs-keyword">struct</span> file_lock **, <span class="hljs-type">void</span> **);<br><span class="hljs-type">long</span> (*fallocate)(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">int</span> mode, <span class="hljs-type">loff_t</span> offset,<br>  <span class="hljs-type">loff_t</span> len);<br><span class="hljs-type">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-keyword">struct</span> file *f);<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MMU</span><br><span class="hljs-type">unsigned</span> (*mmap_capabilities)(<span class="hljs-keyword">struct</span> file *);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿext4ã€f2fsç­‰ï¼Œéƒ½ä¼šæŒ‡æ˜è‡ªå·±çš„file_operationsï¼Œä»¥f2fsä¸ºä¾‹</p><img src="/2023/03/09/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fmount%E8%BF%87%E7%A8%8B/image-20230309230859994.png" alt="image-20230309230859994" style="zoom: 67%;"><p>åŠ å…¥æˆ‘ä»¬åœ¨ç”¨æˆ·æ€æ‰§è¡Œioctlæ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„<code>f2fs_ioct</code>lå°±ä¼šæ‰§è¡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‡‚å¾—äº†Android I/Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰</title>
    <link href="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/"/>
    <url>/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="æ‡‚å¾—äº†Android-I-x2F-Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰"><a href="#æ‡‚å¾—äº†Android-I-x2F-Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰" class="headerlink" title="æ‡‚å¾—äº†Android I&#x2F;Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰"></a>æ‡‚å¾—äº†Android I&#x2F;Oè°ƒä¼˜å¯¹ä½ çš„åº”ç”¨å¸®åŠ©å¾ˆå¤§ï¼ˆä¸Šç¯‡ï¼‰</h1><blockquote><p>ğŸ€è½¬è½½è‡ªï¼š<a href="https://www.cnblogs.com/mysweetAngleBaby/articles/16066846.html">https://www.cnblogs.com/mysweetAngleBaby/articles/16066846.html</a></p></blockquote><h2 id="1-I-x2F-Oçš„åŸºæœ¬çŸ¥è¯†"><a href="#1-I-x2F-Oçš„åŸºæœ¬çŸ¥è¯†" class="headerlink" title="1.I&#x2F;Oçš„åŸºæœ¬çŸ¥è¯†"></a>1.I&#x2F;Oçš„åŸºæœ¬çŸ¥è¯†</h2><p>åœ¨å·¥ä½œä¸­ï¼Œæˆ‘å‘ç°å¾ˆå¤šå·¥ç¨‹å¸ˆå¯¹I&#x2F;Oçš„è®¤è¯†å…¶å®æ¯”è¾ƒæ¨¡ç³Šï¼Œè®¤ä¸ºI&#x2F;Oå°±æ˜¯åº”ç”¨ç¨‹åºæ‰§è¡Œread()ã€write()è¿™æ ·çš„ä¸€äº›æ“ä½œï¼Œå¹¶ä¸æ¸…æ¥šè¿™äº›æ“ä½œèƒŒåçš„æ•´ä¸ªæµç¨‹æ˜¯æ€æ ·çš„ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-b807a907e68b8792.png" style="zoom: 67%;"><p>æˆ‘ç”»äº†ä¸€å¼ ç®€å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°æ•´ä¸ªæ–‡ä»¶I&#x2F;Oæ“ä½œç”±åº”ç”¨ç¨‹åºã€æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜å…±åŒå®Œæˆã€‚é¦–å…ˆåº”ç”¨ç¨‹åºå°†I&#x2F;Oå‘½ä»¤å‘é€ç»™æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åæ–‡ä»¶ç³»ç»Ÿä¼šåœ¨åˆé€‚çš„æ—¶æœºæŠŠI&#x2F;Oæ“ä½œå‘ç»™ç£ç›˜ã€‚<br>è¿™å°±å¥½æ¯”CPUã€å†…å­˜ã€ç£ç›˜ä¸‰ä¸ªå°ä¼™ä¼´ä¸€èµ·å®Œæˆæ¥åŠ›è·‘ï¼Œæœ€ç»ˆè·‘å®Œçš„æ—¶é—´å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæœ€æ…¢çš„å°ä¼™ä¼´ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒCPUå’Œå†…å­˜ç›¸æ¯”ç£ç›˜æ˜¯é«˜é€Ÿè®¾å¤‡ï¼Œæ•´ä¸ªæµç¨‹çš„ç“¶é¢ˆåœ¨äºç£ç›˜I&#x2F;Oçš„æ€§èƒ½ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æ¯”ç£ç›˜æ€§èƒ½æ›´åŠ é‡è¦ï¼Œä¸ºäº†é™ä½ç£ç›˜å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œæ–‡ä»¶ç³»ç»Ÿéœ€è¦é€šè¿‡å„ç§å„æ ·çš„æ‰‹æ®µè¿›è¡Œä¼˜åŒ–ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹æ–‡ä»¶ç³»ç»Ÿã€‚</p><h3 id="1-1-æ–‡ä»¶ç³»ç»Ÿ"><a href="#1-1-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.1 æ–‡ä»¶ç³»ç»Ÿ"></a>1.1 æ–‡ä»¶ç³»ç»Ÿ</h3><p>æ–‡ä»¶ç³»ç»Ÿï¼Œç®€å•æ¥è¯´å°±æ˜¯å­˜å‚¨å’Œç»„ç»‡æ•°æ®çš„æ–¹å¼ã€‚æ¯”å¦‚åœ¨iOS 10.3ç³»ç»Ÿä»¥åï¼Œè‹¹æœä½¿ç”¨APFSï¼ˆApple File Systemï¼‰æ›¿ä»£ä¹‹å‰æ—§çš„æ–‡ä»¶ç³»ç»ŸHFS+ã€‚å¯¹äºAndroidæ¥è¯´ï¼Œç°åœ¨æ™®éä½¿ç”¨çš„æ˜¯Linuxå¸¸ç”¨çš„ext4æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å…³äºæ–‡ä»¶ç³»ç»Ÿè¿˜éœ€è¦å¤šè¯´ä¸¤å¥ï¼Œåä¸ºåœ¨EMUI 5.0ä»¥åå°±ä½¿ç”¨F2FSå–ä»£ext4ï¼ŒGoogleä¹Ÿåœ¨æœ€æ–°çš„æ——èˆ°æ‰‹æœºPixel 3ä½¿ç”¨äº†F2FSæ–‡ä»¶ç³»ç»Ÿã€‚Flash-Friendly File Systemæ˜¯ä¸‰æ˜Ÿæ˜¯ä¸“é—¨ä¸ºNANDé—ªå­˜èŠ¯ç‰‡å¼€å‘çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿåšäº†å¤§é‡é’ˆå¯¹é—ªå­˜çš„ä¼˜åŒ–ã€‚æ ¹æ®åä¸ºçš„æµ‹è¯•æ•°æ®ï¼ŒF2FSæ–‡ä»¶ç³»ç»Ÿåœ¨å°æ–‡ä»¶çš„éšæœºè¯»å†™æ–¹é¢æ¯”ext4æ›´å¿«ï¼Œä¾‹å¦‚éšæœºå†™å¯ä»¥ä¼˜åŒ–60%ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºå¯é æ€§æ–¹é¢å‡ºç°è¿‡ä¸€äº›é—®é¢˜ã€‚æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œéšç€Googleã€åä¸ºçš„æŠ•å…¥å’Œè§„æ¨¡åŒ–ä½¿ç”¨ï¼ŒF2FSç³»ç»Ÿåº”è¯¥æ˜¯æœªæ¥Androidçš„ä¸»æµæ–‡ä»¶ç³»ç»Ÿã€‚</p><p>è¿˜æ˜¯å›åˆ°æ–‡ä»¶ç³»ç»Ÿçš„I&#x2F;Oã€‚åº”ç”¨ç¨‹åºè°ƒç”¨read()æ–¹æ³•ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸­æ–­ä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸å¤„ç†æµç¨‹ï¼Œç„¶åç»è¿‡VFSï¼ˆVirtual File Systemï¼Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ã€å…·ä½“æ–‡ä»¶ç³»ç»Ÿã€é¡µç¼“å­˜Page Cacheã€‚ä¸‹é¢æ˜¯Linuxä¸€ä¸ªé€šç”¨çš„I&#x2F;Oæ¶æ„æ¨¡å‹ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-a7586fb52f51be3a.png" style="zoom: 67%;"><ul><li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ã€‚å®ƒä¸»è¦ç”¨äºå®ç°å±è”½å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºåº”ç”¨ç¨‹åºçš„æ“ä½œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚è¿™æ ·ä¿è¯å°±ç®—å‚å•†æŠŠæ–‡ä»¶ç³»ç»Ÿä»ext4åˆ‡æ¢åˆ°F2FSï¼Œåº”ç”¨ç¨‹åºä¹Ÿä¸ç”¨åšä»»ä½•ä¿®æ”¹ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿï¼ˆFile Systemï¼‰ã€‚ext4ã€F2FSéƒ½æ˜¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ–‡ä»¶å…ƒæ•°æ®å¦‚ä½•ç»„ç»‡ã€ç›®å½•å’Œç´¢å¼•ç»“æ„å¦‚ä½•è®¾è®¡ã€æ€ä¹ˆåˆ†é…å’Œæ¸…ç†æ•°æ®ï¼Œè¿™äº›éƒ½æ˜¯è®¾è®¡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿…é¡»è¦è€ƒè™‘çš„ã€‚<strong>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰é€‚åˆè‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬ä¸èƒ½è¯´F2FSå°±ä¸€å®šæ¯”ext4è¦å¥½ã€‚</strong>F2FSåœ¨è¿ç»­è¯»å–å¤§æ–‡ä»¶ä¸Šå¹¶æ²¡æœ‰ä¼˜åŠ¿ï¼Œè€Œä¸”ä¼šå ç”¨æ›´å¤§çš„ç©ºé—´ã€‚åªæ˜¯å¯¹ä¸€èˆ¬åº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒéšæœºI&#x2F;Oä¼šæ›´åŠ é¢‘ç¹ï¼Œç‰¹åˆ«æ˜¯åœ¨å¯åŠ¨çš„åœºæ™¯ã€‚ä½ å¯ä»¥åœ¨&#x2F;proc&#x2F;filesystemsçœ‹åˆ°ç³»ç»Ÿå¯ä»¥è¯†åˆ«çš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿçš„åˆ—è¡¨ã€‚</li><li>é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ã€‚åœ¨å¯åŠ¨ä¼˜åŒ–ä¸­æˆ‘å·²ç»è®²è¿‡Page Cacheè¿™ä¸ªæ¦‚å¿µäº†ï¼Œåœ¨è¯»æ–‡ä»¶çš„æ—¶å€™ä¼šï¼Œå…ˆçœ‹å®ƒæ˜¯ä¸æ˜¯å·²ç»åœ¨Page Cacheä¸­ï¼Œå¦‚æœå‘½ä¸­å°±ä¸ä¼šå»è¯»å–ç£ç›˜ã€‚åœ¨Linux 2.4.10ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªå•ç‹¬çš„Buffer Cacheï¼Œåæ¥å®ƒä¹Ÿåˆå¹¶åˆ°Page Cacheä¸­çš„Buffer Pageäº†ã€‚</li></ul><p>å…·ä½“æ¥è¯´ï¼ŒPage Cacheå°±åƒæ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„æ•°æ®ç¼“å­˜ï¼Œæ˜¯æ–‡ä»¶ç³»ç»Ÿå¯¹æ•°æ®çš„ç¼“å­˜ï¼Œç›®çš„æ˜¯æå‡å†…å­˜å‘½ä¸­ç‡ã€‚Buffer Cacheå°±åƒæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„BufferInputStreamï¼Œæ˜¯ç£ç›˜å¯¹æ•°æ®çš„ç¼“å­˜ï¼Œç›®çš„æ˜¯åˆå¹¶éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿçš„I&#x2F;Oè¯·æ±‚ã€é™ä½ç£ç›˜I&#x2F;Oçš„æ¬¡æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒä»¬æ—¢ä¼šç”¨åœ¨è¯»è¯·æ±‚ä¸­ï¼Œä¹Ÿä¼šç”¨åˆ°å†™è¯·æ±‚ä¸­ã€‚<br>é€šè¿‡&#x2F;proc&#x2F;meminfoæ–‡ä»¶å¯ä»¥æŸ¥çœ‹ç¼“å­˜çš„å†…å­˜å ç”¨æƒ…å†µï¼Œå½“æ‰‹æœºå†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå›æ”¶å®ƒä»¬çš„å†…å­˜ï¼Œè¿™æ ·æ•´ä½“I&#x2F;Oçš„æ€§èƒ½å°±ä¼šæœ‰æ‰€é™ä½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">MemTotal:    2866492 kB<br>MemFree:      72192 kB<br>Buffers:      62708 kB      // Buffer Cache<br>Cached:      652904 kB      // Page Cache<br></code></pre></td></tr></table></figure><h3 id="1-2-ç£ç›˜"><a href="#1-2-ç£ç›˜" class="headerlink" title="1.2 ç£ç›˜"></a>1.2 ç£ç›˜</h3><p>ç£ç›˜æŒ‡çš„æ˜¯ç³»ç»Ÿçš„å­˜å‚¨è®¾å¤‡ï¼Œå°±åƒå°æ—¶å€™æˆ‘ä»¬å¸¸å¬çš„CDæˆ–è€…ç”µè„‘ä½¿ç”¨çš„æœºæ¢°ç¡¬ç›˜ï¼Œå½“ç„¶è¿˜æœ‰ç°åœ¨æ¯”è¾ƒæµè¡Œçš„SSDå›ºæ€ç¡¬ç›˜ã€‚<br>æ­£å¦‚æˆ‘ä¸Šé¢æ‰€è¯´ï¼Œå¦‚æœå‘ç°åº”ç”¨ç¨‹åºè¦read()çš„æ•°æ®æ²¡æœ‰åœ¨é¡µç¼“å­˜ä¸­ï¼Œè¿™æ—¶å€™å°±éœ€è¦çœŸæ­£å‘ç£ç›˜å‘èµ·I&#x2F;Oè¯·æ±‚ã€‚è¿™ä¸ªè¿‡ç¨‹è¦å…ˆç»è¿‡å†…æ ¸çš„é€šç”¨å—å±‚ã€I&#x2F;Oè°ƒåº¦å±‚ã€è®¾å¤‡é©±åŠ¨å±‚ï¼Œæœ€åæ‰ä¼šäº¤ç»™å…·ä½“çš„ç¡¬ä»¶è®¾å¤‡å¤„ç†ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-5a8d09f33aacf7fd.png" style="zoom: 67%;"><ul><li>é€šç”¨å—å±‚ã€‚ç³»ç»Ÿä¸­èƒ½å¤Ÿéšæœºè®¿é—®å›ºå®šå¤§å°æ•°æ®å—ï¼ˆblockï¼‰çš„è®¾å¤‡ç§°ä¸ºå—è®¾å¤‡ï¼ŒCDã€ç¡¬ç›˜å’ŒSSDè¿™äº›éƒ½å±äºå—è®¾å¤‡ã€‚é€šç”¨å—å±‚ä¸»è¦ä½œç”¨æ˜¯æ¥æ”¶ä¸Šå±‚å‘å‡ºçš„ç£ç›˜è¯·æ±‚ï¼Œå¹¶æœ€ç»ˆå‘å‡ºI&#x2F;Oè¯·æ±‚ã€‚å®ƒè·ŸVFSçš„ä½œç”¨ç±»ä¼¼ï¼Œè®©ä¸Šå±‚ä¸éœ€è¦å…³å¿ƒåº•å±‚ç¡¬ä»¶è®¾å¤‡çš„å…·ä½“å®ç°ã€‚</li><li>I&#x2F;Oè°ƒåº¦å±‚ã€‚ç£ç›˜I&#x2F;Oé‚£ä¹ˆæ…¢ï¼Œä¸ºäº†é™ä½çœŸæ­£çš„ç£ç›˜I&#x2F;Oï¼Œæˆ‘ä»¬ä¸èƒ½æ¥æ”¶åˆ°ç£ç›˜è¯·æ±‚å°±ç«‹åˆ»äº¤ç»™é©±åŠ¨å±‚å¤„ç†ã€‚æ‰€ä»¥æˆ‘ä»¬å¢åŠ äº†I&#x2F;Oè°ƒåº¦å±‚ï¼Œå®ƒä¼šæ ¹æ®è®¾ç½®çš„è°ƒåº¦ç®—æ³•å¯¹è¯·æ±‚åˆå¹¶å’Œæ’åºã€‚è¿™é‡Œæ¯”è¾ƒå…³é”®çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é˜Ÿåˆ—é•¿åº¦ï¼Œä¸€ä¸ªæ˜¯å…·ä½“çš„è°ƒåº¦ç®—æ³•ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–‡ä»¶å¯ä»¥æŸ¥çœ‹å¯¹åº”å—è®¾å¤‡çš„é˜Ÿåˆ—é•¿åº¦å’Œä½¿ç”¨çš„è°ƒåº¦ç®—æ³•ã€‚</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">/sys/block/[disk]/queue/nr_requests      // é˜Ÿåˆ—é•¿åº¦ï¼Œä¸€èˆ¬æ˜¯ 128ã€‚<br>/sys/block/[disk]/queue/scheduler        // è°ƒåº¦ç®—æ³•<br></code></pre></td></tr></table></figure><ul><li>å—è®¾å¤‡é©±åŠ¨å±‚ã€‚å—è®¾å¤‡é©±åŠ¨å±‚æ ¹æ®å…·ä½“çš„ç‰©ç†è®¾å¤‡ï¼Œé€‰æ‹©å¯¹åº”çš„é©±åŠ¨ç¨‹åºé€šè¿‡æ“æ§ç¡¬ä»¶è®¾å¤‡å®Œæˆæœ€ç»ˆçš„I&#x2F;Oè¯·æ±‚ã€‚ä¾‹å¦‚å…‰ç›˜æ˜¯é æ¿€å…‰åœ¨è¡¨é¢çƒ§å½•å­˜å‚¨ã€é—ªå­˜æ˜¯é ç”µå­æ“¦å†™å­˜å‚¨æ•°æ®</li></ul><h2 id="2-I-x2F-Oçš„æ€§èƒ½è¯„ä¼°"><a href="#2-I-x2F-Oçš„æ€§èƒ½è¯„ä¼°" class="headerlink" title="2.I&#x2F;Oçš„æ€§èƒ½è¯„ä¼°"></a>2.I&#x2F;Oçš„æ€§èƒ½è¯„ä¼°</h2><p>æ­£å¦‚ä¸‹å›¾ä½ æ‰€çœ‹åˆ°çš„ï¼Œæ•´ä¸ªI&#x2F;Oçš„æµç¨‹æ¶‰åŠçš„é“¾è·¯éå¸¸é•¿ã€‚æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­é€šè¿‡æ‰“ç‚¹ï¼Œå‘ç°ä¸€ä¸ªæ–‡ä»¶è¯»å–éœ€è¦300msã€‚ä½†æ˜¯ä¸‹é¢æ¯ä¸€å±‚å¯èƒ½éƒ½æœ‰è‡ªå·±çš„ç­–ç•¥å’Œè°ƒåº¦ç®—æ³•ï¼Œå› æ­¤å¾ˆéš¾çœŸæ­£çš„å¾—åˆ°æ¯ä¸€å±‚çš„è€—æ—¶ã€‚</p><img src="/2023/03/09/%E6%87%82%E5%BE%97%E4%BA%86Android-I-O%E8%B0%83%E4%BC%98%E5%AF%B9%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%BE%88%E5%A4%A7%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/26731569-ee5db940a613d188.png" style="zoom: 67%;"><p>åœ¨å‰é¢çš„å¯åŠ¨ä¼˜åŒ–å†…å®¹ä¸­ï¼Œæˆ‘è®²è¿‡Facebookå’Œæ”¯ä»˜å®é‡‡ç”¨ç¼–è¯‘å•ç‹¬ROMçš„æ–¹æ³•æ¥è¯„ä¼°I&#x2F;Oæ€§èƒ½ã€‚è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚ä½†æ˜¯æœ‰æ•ˆçš„åšæ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šåˆ¶æºç ï¼Œé€‰æ‹©æ‰“å¼€æ„Ÿå…´è¶£çš„æ—¥å¿—æ¥è¿½è¸ªI&#x2F;Oçš„æ€§èƒ½ã€‚</p><ol><li>I&#x2F;Oæ€§èƒ½æŒ‡æ ‡<br>I&#x2F;Oæ€§èƒ½è¯„ä¼°ä¸­æœ€ä¸ºæ ¸å¿ƒçš„æŒ‡æ ‡æ˜¯ååé‡å’ŒIOPSã€‚ä»Šå¤©æ–‡ç« å¼€å¤´æ‰€è¯´çš„ï¼Œâ€œè¿ç»­è¯»å–ä¸è¶…è¿‡550MB&#x2F;sï¼Œè¿ç»­å†™å…¥ä¸è¶…è¿‡520MB&#x2F;sâ€ï¼Œå°±æŒ‡çš„æ˜¯I&#x2F;Oååé‡ã€‚<br>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æŒ‡æ ‡æ˜¯IOPSï¼Œå®ƒæŒ‡çš„æ˜¯æ¯ç§’å¯ä»¥è¯»å†™çš„æ¬¡æ•°ã€‚å¯¹äºéšæœºè¯»å†™é¢‘ç¹çš„åº”ç”¨ï¼Œä¾‹å¦‚å¤§é‡çš„å°æ–‡ä»¶å­˜å‚¨ï¼ŒIOPSæ˜¯å…³é”®çš„è¡¡é‡æŒ‡æ ‡ã€‚</li><li>I&#x2F;Oæµ‹é‡<br>å¦‚æœä¸é‡‡ç”¨å®šåˆ¶æºç çš„æ–¹å¼ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•å¯ä»¥ç”¨æ¥æµ‹é‡I&#x2F;Oçš„æ€§èƒ½å‘¢ï¼Ÿ\</li></ol><p><strong>ç¬¬ä¸€ç§æ–¹æ³•ï¼šä½¿ç”¨procã€‚</strong><br>æ€»çš„æ¥è¯´ï¼ŒI&#x2F;Oæ€§èƒ½ä¼šè·Ÿå¾ˆå¤šå› ç´ æœ‰å…³ï¼Œæ˜¯è¯»è¿˜æ˜¯å†™ã€æ˜¯å¦æ˜¯è¿ç»­ã€I&#x2F;Oå¤§å°ç­‰ã€‚å¦å¤–ä¸€ä¸ªå¯¹I&#x2F;Oæ€§èƒ½å½±å“æ¯”è¾ƒå¤§çš„å› ç´ æ˜¯è´Ÿè½½ï¼ŒI&#x2F;Oæ€§èƒ½ä¼šéšç€è´Ÿè½½çš„å¢åŠ è€Œé™ä½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡I&#x2F;Oçš„ç­‰å¾…æ—¶é—´å’Œæ¬¡æ•°æ¥è¡¡é‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">proc/self/schedstat:<br>  se.statistics.iowait_countï¼šIO ç­‰å¾…çš„æ¬¡æ•°<br>  se.statistics.iowait_sumï¼š  IO ç­‰å¾…çš„æ—¶é—´<br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯rootçš„æœºå™¨ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯å†…æ ¸çš„I&#x2F;Oç›‘æ§ï¼Œå°†æ‰€æœ‰blockè¯»å†™dumpåˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡dmesgå‘½ä»¤æ¥æŸ¥çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">echo 1 &amp;gt; /proc/sys/vm/block_dump<br>dmesg -c grep pid<br>.sample.io.test(7540): READ block 29262592 on dm-1 (256 sectors)<br>.sample.io.test(7540): READ block 29262848 on dm-1 (256 sectors)<br></code></pre></td></tr></table></figure><p><strong>ç¬¬äºŒç§æ–¹æ³•ï¼šä½¿ç”¨straceã€‚</strong><br>Linuxæä¾›äº†iostatã€iotopç­‰ä¸€äº›ç›¸å…³çš„å‘½ä»¤ï¼Œä¸è¿‡å¤§éƒ¨åˆ†Anroidè®¾å¤‡éƒ½ä¸æ”¯æŒã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ straceæ¥è·Ÿè¸ªI&#x2F;Oç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°å’Œè€—æ—¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">strace -ttT -f -p [pid]<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000447&amp;gt;<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000084&amp;gt;<br>read(53, &amp;quot;*****************&amp;quot;\.\.\., 1024) = 1024       &amp;lt;0.000059&amp;gt;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ—¥å¿—ï¼Œä½ å¯ä»¥çœ‹åˆ°åº”ç”¨ç¨‹åºåœ¨è¯»å–æ–‡ä»¶æ“ä½œç¬¦ä¸º53çš„æ–‡ä»¶ï¼Œæ¯æ¬¡è¯»å–1024ä¸ªå­—èŠ‚ã€‚ç¬¬ä¸€æ¬¡è¯»å–èŠ±äº†447usï¼Œåé¢ä¸¤æ¬¡éƒ½ä½¿ç”¨äº†100usä¸åˆ°ã€‚è¿™è·Ÿå¯åŠ¨ä¼˜åŒ–æåˆ°çš„â€œæ•°æ®é‡æ’â€æ˜¯ä¸€ä¸ªåŸå› ï¼Œæ–‡ä»¶ç³»ç»Ÿæ¯æ¬¡è¯»å–ä»¥blockä¸ºå•ä½ï¼Œè€Œblockçš„å¤§å°ä¸€èˆ¬æ˜¯4KBï¼Œåé¢ä¸¤æ¬¡çš„è¯»å–æ˜¯ä»é¡µç¼“å­˜å¾—åˆ°ã€‚<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡straceç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„è€—æ—¶æ¦‚å†µã€‚ä¸è¿‡straceæœ¬èº«ä¹Ÿä¼šæ¶ˆè€—ä¸å°‘èµ„æºï¼Œå¯¹æ‰§è¡Œæ—¶é—´ä¹Ÿä¼šäº§ç”Ÿå½±å“ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">strace -c -f -p [pid]<br><span class="hljs-meta prompt_">% </span><span class="language-bash">time     seconds  usecs/call     calls    errors  syscall</span><br>------ ----------- ----------- --------- --------- â€”â€”â€”â€”â€”â€”â€”â€”<br> 97.56    0.041002          21      1987             read<br>  1.44    0.000605          55        11             write<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¿¡æ¯ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¯»å äº†97.56%çš„æ—¶é—´ï¼Œä¸€å…±è°ƒç”¨äº†1987æ¬¡ï¼Œè€—æ—¶0.04sï¼Œå¹³å‡æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨21usã€‚åŒæ ·çš„é“ç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¡ç®—åº”ç”¨ç¨‹åºæŸä¸ªä»»åŠ¡I&#x2F;Oè€—æ—¶çš„ç™¾åˆ†æ¯”ã€‚å‡è®¾ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œäº†10sï¼ŒI&#x2F;OèŠ±äº†9sï¼Œé‚£ä¹ˆI&#x2F;Oè€—æ—¶ç™¾åˆ†æ¯”å°±æ˜¯90%ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒI&#x2F;Oå°±æ˜¯æˆ‘ä»¬ä»»åŠ¡å¾ˆå¤§çš„ç“¶é¢ˆï¼Œéœ€è¦å»åšè¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚</p><p><strong>ç¬¬ä¸‰ç§æ–¹æ³•ï¼šä½¿ç”¨vmstatã€‚</strong><br>vmstatçš„å„ä¸ªå­—æ®µè¯´æ˜å¯ä»¥å‚è€ƒã€Švmstatç›‘è§†å†…å­˜ä½¿ç”¨æƒ…å†µã€‹ï¼Œå…¶ä¸­Memoryä¸­çš„buffå’Œcacheï¼ŒI&#x2F;Oä¸­çš„biå’Œboï¼ŒSystemä¸­çš„csï¼Œä»¥åŠCPUä¸­çš„syå’Œwaï¼Œè¿™äº›å­—æ®µçš„æ•°å€¼éƒ½ä¸I&#x2F;Oè¡Œä¸ºæœ‰å…³ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é…åˆddå‘½ä»¤æ¥é…åˆæµ‹è¯•ï¼Œè§‚å¯Ÿvmstatçš„è¾“å‡ºæ•°æ®å˜åŒ–ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯Androidé‡Œé¢çš„ddå‘½ä»¤ä¼¼ä¹å¹¶ä¸æ”¯æŒconvå’Œflagå‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">//æ¸…é™¤Bufferå’ŒCacheå†…å­˜ç¼“å­˜<br>echo 3 &amp;gt; /proc/sys/vm/drop_caches<br>//æ¯éš”1ç§’è¾“å‡º1ç»„vmstatæ•°æ®<br>vmstat 1<br>//æµ‹è¯•å†™å…¥é€Ÿåº¦ï¼Œå†™å…¥æ–‡ä»¶/data/data/testï¼Œbufferå¤§å°ä¸º4Kï¼Œæ¬¡æ•°ä¸º1000æ¬¡<br>dd if=/dev/zero of=/data/data/test bs=4k count=1000<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°</title>
    <link href="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/"/>
    <url>/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"><a href="#Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°" class="headerlink" title="Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"></a>Cè¯­è¨€å­—ç¬¦ä¸²å¤„ç†å‡½æ•°</h1><p>å†™ä»£ç æ—¶å¯¹å­—ç¬¦å’Œå­—ç¬¦ä¸²çš„å¤„ç†å¾ˆé¢‘ç¹ï¼Œä½†æ˜¯Cè¯­è¨€ä¸­æœ¬èº«æ²¡æœ‰å­—ç¬¦ä¸²ç±»å‹ï¼Œå­—ç¬¦ä¸²é€šå¸¸å­˜å‚¨åœ¨<strong>å¸¸é‡å­—ç¬¦ä¸²ï¼ˆconst char* strï¼‰</strong>ä¸­æˆ–è€…<strong>å­—ç¬¦æ•°ç»„ï¼ˆchar str[] &#x3D; â€œamxâ€ï¼‰</strong>ä¸­ã€‚<strong>å¸¸é‡å­—ç¬¦ä¸²</strong>é€‚ç”¨äºé‚£äº›å¯¹å®ƒä¸åšä¿®æ”¹çš„å­—ç¬¦ä¸²å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®å®šåœ¨Cè¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²éƒ½æ˜¯ä»¥\0ç»“å°¾çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬åˆ›å»ºçš„æ—¶å€™ä¸ç”¨è‡ªå·±æ·»åŠ ï¼Œæ˜¯ç¼–è¯‘çš„æ—¶å€™ç”±ç¼–è¯‘å™¨æ·»åŠ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-keyword">if</span> (str[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;æœ«å°¾æ˜¯\\0\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/æˆªå±2022-05-21 16.32.40.png"><h2 id="1-å­—ç¬¦ä¸²çš„é•¿åº¦"><a href="#1-å­—ç¬¦ä¸²çš„é•¿åº¦" class="headerlink" title="1.å­—ç¬¦ä¸²çš„é•¿åº¦"></a>1.å­—ç¬¦ä¸²çš„é•¿åº¦</h2><h3 id="1-1-strlen"><a href="#1-1-strlen" class="headerlink" title="1.1 strlen"></a>1.1 strlen</h3><p>ä½œç”¨ï¼šæ±‚å­—ç¬¦ä¸²çš„é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strlen</span>(str)); <span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#2-é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="2.é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"></a>2.é•¿åº¦ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°</h2><h3 id="2-1-strcpy"><a href="#2-1-strcpy" class="headerlink" title="2.1  strcpy"></a>2.1  strcpy</h3><p>ä½œç”¨ï¼šå¤åˆ¶å­—ç¬¦ä¸²</p><p>å°†<strong>æº</strong>æ‰€æŒ‡å‘çš„ C å­—ç¬¦ä¸²å¤åˆ¶åˆ°<strong>ç›®æ ‡</strong>æ‰€æŒ‡å‘çš„æ•°ç»„ä¸­ï¼ŒåŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼ˆå¹¶åœ¨è¯¥ç‚¹åœæ­¢ï¼‰ã€‚</p><blockquote><p>ä¸ºé¿å…æº¢å‡ºï¼Œç›®æ ‡æ‰€æŒ‡å‘çš„æ•°ç»„çš„å¤§å°åº”è¶³å¤Ÿé•¿ï¼Œä»¥åŒ…å«ä¸æºç›¸åŒçš„ C å­—ç¬¦ä¸²ï¼ˆåŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼‰ï¼Œå¹¶ä¸”ä¸åº”åœ¨å†…å­˜ä¸­ä¸ source é‡å ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[<span class="hljs-number">20</span>];<br>    <br>    <span class="hljs-built_in">strcpy</span>(str2,str);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// amx</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-strcat"><a href="#2-2-strcat" class="headerlink" title="2.2 strcat"></a>2.2 strcat</h3><p>ä½œç”¨ï¼šè¿æ¥å­—ç¬¦ä¸²</p><p>å°†â€â€<strong>æº</strong>â€â€å­—ç¬¦ä¸²çš„å‰¯æœ¬è¿½åŠ åˆ°â€â€<strong>ç›®æ ‡</strong>â€â€å­—ç¬¦ä¸²ã€‚â€<em>â€</em>ç›®æ ‡â€â€ä¸­çš„ç»ˆæ­¢ç©ºå­—ç¬¦è¢«â€<em>â€</em>æº<em>â€</em>â€çš„ç¬¬ä¸€ä¸ªå­—ç¬¦è¦†ç›–ï¼Œå¹¶ä¸”åœ¨â€<em>â€</em>ç›®æ ‡<em>â€</em>â€ä¸­ç”±ä¸¤è€…ä¸²è”å½¢æˆçš„æ–°å­—ç¬¦ä¸²çš„æœ«å°¾åŒ…å«ä¸€ä¸ªç©ºå­—ç¬¦ã€‚â€</p><blockquote><p>æ³¨ï¼šç›®çš„åœ°â€â€å’Œâ€â€æ¥æºâ€â€ä¸å¾—é‡å ã€‚<strong>è‡ªå·±ä¸èƒ½ç»™è‡ªå·±è¿½åŠ ã€‚</strong></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hello &quot;</span>;<br>    <br>    <span class="hljs-built_in">strcat</span>(str2,str1);  <span class="hljs-comment">// å°†str1æ·»åŠ åˆ°str2åé¢å»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// hello amx</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-strcmp"><a href="#2-3-strcmp" class="headerlink" title="2.3 strcmp"></a>2.3 strcmp</h3><p>ä½œç”¨ï¼šæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²</p><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/d04949f8-1e4a-482b-be1c-b1de518ec939.png"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hello &quot;</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strcmp</span>(str1,str2));  <span class="hljs-comment">// -7</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#3-é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="3.é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°"></a>3.é•¿åº¦å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°</h2><h3 id="3-1-strncpy"><a href="#3-1-strncpy" class="headerlink" title="3.1 strncpy"></a>3.1 strncpy</h3><p>ä½œç”¨ï¼š<strong>Copy characters from string</strong>ä»å­—ç¬¦ä¸²ä¸­å¤åˆ¶å­—ç¬¦</p><p>å°†<strong>æº</strong>çš„å‰<strong>num</strong>å­—ç¬¦å¤åˆ¶åˆ°<strong>ç›®æ ‡</strong>ã€‚å¦‚æœåœ¨å¤åˆ¶<strong>num</strong>ä¸ªå­—ç¬¦ä¹‹å‰æ‰¾åˆ°<strong>æº</strong>C å­—ç¬¦ä¸²ï¼ˆç”±ç©ºå­—ç¬¦æŒ‡ç¤ºï¼‰çš„æœ«å°¾ï¼Œåˆ™<strong>ç›®æ ‡</strong>å°†å¡«å……é›¶ï¼Œç›´åˆ°å‘å…¶å†™å…¥æ€»å…±<strong>num</strong>ä¸ªå­—ç¬¦ã€‚</p><blockquote><p>å¦‚æœæºçš„é•¿åº¦è¶…è¿‡ numï¼Œåˆ™ä¸ä¼šåœ¨ç›®æ ‡æœ«å°¾éšå¼è¿½åŠ ç©ºå­—ç¬¦ã€‚</p><p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>ç›®æ ‡</strong>ä¸åº”è¢«è§†ä¸ºä»¥ç©ºå€¼ç»“å°¾çš„ C å­—ç¬¦ä¸²ï¼ˆè¿™æ ·è¯»å–å®ƒä¼šæº¢å‡ºï¼‰ã€‚</p><p>ç›®çš„åœ°å’Œæ¥æºä¸å¾—é‡å ï¼ˆé‡å æ—¶ï¼Œè¯·å‚é˜… memmove ä»¥äº†è§£æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼‰ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[<span class="hljs-number">20</span>];<br>    <br>    <span class="hljs-built_in">strncpy</span>(str2,str1,<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// hello</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-strncat"><a href="#3-2-strncat" class="headerlink" title="3.2 strncat"></a>3.2 strncat</h3><p>ä½œç”¨ï¼šå°†<strong>æº</strong>çš„å‰<strong>num</strong>ä¸ªå­—ç¬¦è¿½åŠ åˆ°<strong>ç›®æ ‡</strong>ï¼ŒåŠ ä¸Šä¸€ä¸ªç»ˆæ­¢ç©ºå­—ç¬¦ã€‚</p><blockquote><p>å¦‚æœæºä¸­ C å­—ç¬¦ä¸²çš„é•¿åº¦å°äº<strong>num</strong>ï¼Œåˆ™ä»…å¤åˆ¶ç›´åˆ°ç»ˆæ­¢ç©ºå­—ç¬¦çš„å†…å®¹ã€‚</p><p>å¦‚æœsourceæ‹·è´è¿›å»ä¹‹ådesinationè¿˜æœ‰åŸæœ¬å­˜åœ¨çš„å­—ç¬¦ä¼šä¸»åŠ¨è¿½åŠ ä¸€ä¸ªâ€™\0â€™ã€‚</p><p>å¦‚æœè¿½åŠ é•¿åº¦numå¤§äºstrlen(source),åˆ™åªè¿½åŠ sourceåŸæœ¬çš„å­—ç¬¦ä¸²å’Œä¸€ä¸ªâ€™\0â€™</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;HI!&quot;</span>;<br>    <br>    <span class="hljs-built_in">strncat</span>(str2,str1,<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str2);  <span class="hljs-comment">// HI!hello</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-strncmp"><a href="#3-3-strncmp" class="headerlink" title="3.3 strncmp"></a>3.3 strncmp</h3><p>ä½œç”¨ï¼šå°† C å­—ç¬¦ä¸²<strong>str1</strong>çš„<strong>æœ€å¤š num</strong>ä¸ªå­—ç¬¦ä¸ C å­—ç¬¦ä¸²<strong>str2</strong>çš„å­—ç¬¦æ•°è¿›è¡Œæ¯”è¾ƒã€‚</p><blockquote><p>æ­¤å‡½æ•°å¼€å§‹æ¯”è¾ƒæ¯ä¸ªå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœå®ƒä»¬å½¼æ­¤ç›¸ç­‰ï¼Œåˆ™ç»§ç»­å‘åæ¯”è¾ƒï¼Œç›´åˆ°å­—ç¬¦ä¸åŒï¼Œç›´åˆ°è¾¾åˆ°ç»ˆæ­¢ç©ºå­—ç¬¦ï¼Œæˆ–è€…ç›´åˆ°ä¸¤ä¸ªå­—ç¬¦ä¸²ä¸­çš„<strong>num</strong>å­—ç¬¦åŒ¹é…ï¼Œä»¥å…ˆå‘ç”Ÿçš„æƒ…å†µä¸ºå‡†ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str1[] = <span class="hljs-string">&quot;hello amx&quot;</span>;<br>    <span class="hljs-type">char</span> str2[] = <span class="hljs-string">&quot;hellaaaa&quot;</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strncmp</span>(str1,str2,<span class="hljs-number">4</span>));  <span class="hljs-comment">// 0</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">strncmp</span>(str1,str2,<span class="hljs-number">5</span>));  <span class="hljs-comment">// 14</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°"><a href="#4-å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="4.å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°"></a>4.å®‰å…¨çš„å­—ç¬¦ä¸²å‡½æ•°</h2><blockquote><p>ä¸ºäº†å‡è½»ç¨‹åºå‘˜æ·»åŠ ç»“æŸç¬¦å’Œå¤„ç†å­—ç¬¦ä¸²æˆªæ–­çš„è´Ÿæ‹…ï¼Œå¯ä»¥ä½¿ç”¨strlcpyå’Œstrlcatå‡½æ•°ã€‚</p><p>ğŸ­æ–‡æ¡£ï¼š<a href="https://gratisoft.us/todd/papers/strlcpy.html">https://gratisoft.us/todd/papers/strlcpy.html</a></p></blockquote><h3 id="4-1-strlcpy"><a href="#4-1-strlcpy" class="headerlink" title="4.1 strlcpy"></a>4.1 strlcpy</h3><p>ä½œç”¨ï¼š</p><p><strong>strlcpyæºä»£ç ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">strlcpy</span><span class="hljs-params">(<span class="hljs-type">char</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src, <span class="hljs-type">size_t</span> dsize)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *osrc = src;<br>    <span class="hljs-type">size_t</span> nleft = dsize;<br>    <span class="hljs-comment">/* Copy as many bytes as will fit. */</span><br>    <span class="hljs-keyword">if</span> (nleft != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">while</span> (--nleft != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> ((*dst++ = *src++) == <span class="hljs-string">&#x27;\0&#x27;</span>)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/* Not enough room in dst, add NUL and traverse rest of src. */</span><br>    <span class="hljs-keyword">if</span> (nleft == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (dsize != <span class="hljs-number">0</span>)<br>            *dst = <span class="hljs-string">&#x27;\0&#x27;</span>;        <span class="hljs-comment">/* NUL-terminate dst */</span><br>        <span class="hljs-keyword">while</span> (*src++);<br>    &#125;<br>    <span class="hljs-keyword">return</span>(src - osrc - <span class="hljs-number">1</span>);    <span class="hljs-comment">/* count does not include NUL */</span><br>&#125;<br></code></pre></td></tr></table></figure><p> <code>strlcpy</code>å°† <code>src</code> æŒ‰å­—ç¬¦æ‹·è´åˆ° <code>dst</code>ä¸­ï¼Œæœ€å¤šæ‹·è´<code>dszie-1</code>ä¸ªå­—ç¬¦ï¼Œæ‹·è´ç»“æŸååœ¨ <code>dst</code> æœ«å°¾æ·»åŠ  <code>0x00</code>ç»“æŸç¬¦ï¼Œè¿”å›å€¼æ˜¯ <code>src</code>çš„é•¿åº¦ã€‚ä¸€èˆ¬å°† <code>dsize</code>ç½®ä¸º<code>dst</code>çš„å¤§å°ã€‚ç›¸è¾ƒäºstrncpyï¼Œ<strong>strlcpyæœ‰ä¸¤ä¸ªä¼˜ç‚¹</strong>ï¼š</p><ul><li>å½“<code>strlen(src)</code>å¤§äºç­‰äº<code>dsize</code>æ—¶è‡ªåŠ¨åœ¨<code>dst</code>æœ«å°¾æ·»åŠ ç»“æŸç¬¦ï¼›</li><li>è¿”å›å€¼å¤§äºç­‰äº<code>dsize</code>æ—¶ç¡®å®šå‘ç”Ÿå­—ç¬¦ä¸²æˆªæ–­ã€‚ä»¥ä¸Šä¸¤ç‚¹å¸®åŠ©ç¨‹åºå‘˜è¿›è¡Œåˆ¤æ–­ï¼Œæ–¹ä¾¿åç»­å¤„ç†ã€‚</li></ul><h3 id="4-2-strlcat"><a href="#4-2-strlcat" class="headerlink" title="4.2 strlcat"></a>4.2 strlcat</h3><p>ä½œç”¨ï¼š</p><p><strong>strlcatæºä»£ç ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">strlcat</span><span class="hljs-params">(<span class="hljs-type">char</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src, <span class="hljs-type">size_t</span> dsize)</span><br>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *odst = dst;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *osrc = src;<br>    <span class="hljs-type">size_t</span> n = dsize;<br>    <span class="hljs-type">size_t</span> dlen;<br>    <span class="hljs-comment">/* Find the end of dst and adjust bytes left but don&#x27;t go past end. */</span><br>    <span class="hljs-keyword">while</span> (n-- != <span class="hljs-number">0</span> &amp;&amp; *dst != <span class="hljs-string">&#x27;\0&#x27;</span>)<br>        dst++;<br>    dlen = dst - odst;<br>    n = dsize - dlen;<br><br>    <span class="hljs-keyword">if</span> (n-- == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>(dlen + <span class="hljs-built_in">strlen</span>(src));<br>    <span class="hljs-keyword">while</span> (*src != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-keyword">if</span> (n != <span class="hljs-number">0</span>) &#123;<br>            *dst++ = *src;<br>            n--;<br>        &#125;<br>        src++;<br>    &#125;<br>    *dst = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-keyword">return</span>(dlen + (src - osrc));    <span class="hljs-comment">/* count does not include NUL */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>dlen</code>æ˜¯ <code>dst</code>ä¸­åŸæœ‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸åŒ…å«<code>0x00</code>ç»“æŸç¬¦ï¼‰ï¼›<code>dsize</code>æ˜¯ <code>dst</code>ç¼“å†²åŒºçš„æ€»å¤§å°ï¼ˆåŒ…å«ç»“æŸç¬¦ï¼‰ã€‚ å®ƒé¦–å…ˆæ‰¾åˆ° <code>dst</code>ä¸­æºå­—ç¬¦ä¸²çš„ç»“æŸç¬¦ï¼Œç„¶åè®¡ç®—å‰©ä½™ç©ºé—´å¤§å°ï¼Œå¦‚æœä¸º0ï¼Œåˆ™è¿”å›ã€‚å¦‚æœæœ‰å‰©ä½™ç©ºé—´ï¼Œå°±ä¾æ¬¡å¾€å…¶ä¸­æ·»åŠ <code>src</code>å­—ç¬¦ä¸²ï¼Œç›´è‡³<code>dst</code>ç¼“å†²åŒºå¡«æ»¡ï¼Œè¿”å›å€¼æ˜¯<code>dst</code>åŸå­—ç¬¦ä¸²é•¿åº¦ä¸<code>src</code>é•¿åº¦ä¹‹å’Œã€‚ç›¸æ¯”è¾ƒstrncatï¼Œ<strong>strlcatçš„ä¼˜ç‚¹æ˜¯</strong>ï¼š</p><ul><li>ç¬¬ä¸‰ä¸ªå‚æ•°å¤§å°ç›´æ¥å¸¦å…¥<code>dst</code>çš„å¤§å°ï¼Œä¸éœ€è¦è®¡ç®—å‰©ä½™ç©ºé—´ï¼›</li><li>è¿”å›å€¼å¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿå­—ç¬¦ä¸²æˆªæ–­ã€‚</li></ul><h2 id="5-å­—ç¬¦ä¸²æŸ¥æ‰¾"><a href="#5-å­—ç¬¦ä¸²æŸ¥æ‰¾" class="headerlink" title="5.å­—ç¬¦ä¸²æŸ¥æ‰¾"></a>5.å­—ç¬¦ä¸²æŸ¥æ‰¾</h2><h3 id="5-1-strstr"><a href="#5-1-strstr" class="headerlink" title="5.1 strstr"></a>5.1 strstr</h3><p>ä½œç”¨ï¼šè¿”å›ä¸€ä¸ªæŒ‡å‘<strong>str1</strong>ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„<strong>str2</strong>çš„æŒ‡é’ˆï¼Œå¦‚æœ<strong>str2</strong> ä¸æ˜¯ <strong>str1</strong>çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™è¿”å›ç©ºæŒ‡é’ˆ</p><blockquote><p>åŒ¹é…è¿‡ç¨‹ä¸åŒ…æ‹¬ç»ˆæ­¢ç©ºå­—ç¬¦ï¼Œä½†ç¢°åˆ°å®ƒå°±æ­¤åœæ­¢ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] =<span class="hljs-string">&quot;This is a simple string&quot;</span>;  <br>    <span class="hljs-type">char</span>* pch;<br>    pch = <span class="hljs-built_in">strstr</span>(str,<span class="hljs-string">&quot;is&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p&quot;</span>,*pch);  <span class="hljs-comment">// 0X69</span><br>        <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-strtok"><a href="#5-2-strtok" class="headerlink" title="5.2 strtok"></a>5.2 strtok</h3><p>ä½œç”¨ï¼šå°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºæ ‡è®°</p><p>å¯¹è¯¥å‡½æ•°çš„ä¸€ç³»åˆ—è°ƒç”¨å°†stræ‹†åˆ†ä¸ºæ ‡è®°ï¼Œè¿™äº›æ ‡è®°æ˜¯ç”±åˆ†éš”ç¬¦ä¸­çš„ä»»ä½•å­—ç¬¦åˆ†éš”çš„è¿ç»­å­—ç¬¦åºåˆ—ã€‚</p><h2 id="6-é”™è¯¯ä¿¡æ¯æŠ¥å‘Š"><a href="#6-é”™è¯¯ä¿¡æ¯æŠ¥å‘Š" class="headerlink" title="6.é”™è¯¯ä¿¡æ¯æŠ¥å‘Š"></a>6.é”™è¯¯ä¿¡æ¯æŠ¥å‘Š</h2><h3 id="6-1-strerror"><a href="#6-1-strerror" class="headerlink" title="6.1 strerror"></a>6.1 strerror</h3><p>ä½œç”¨ï¼š<strong>string</strong>è·å–æŒ‡å‘é”™è¯¯æ¶ˆæ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</p><p>é”™è¯¯ç æ˜¯ç¨‹åºå‘˜çŸ¥é“çš„ï¼Œä½†æ˜¯è¦è½¬åŒ–ä¸ºç”¨æˆ·èƒ½çœ‹æ‡‚çš„é”™è¯¯ä¿¡æ¯ï¼Œå°±éœ€è¦ä½¿ç”¨å‡½æ•°å°†å…¶è½¬åŒ–ä¸ºé”™è¯¯ä¿¡æ¯ã€‚</p><p>è§£é‡Š<strong>errnum</strong>çš„å€¼ï¼Œç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ä¸€æ¡æè¿°é”™è¯¯æ¡ä»¶çš„æ¶ˆæ¯ï¼Œå°±å¥½åƒè¢«åº“çš„å‡½æ•°è®¾ç½®ä¸º<strong>errno</strong>ä¸€æ ·ã€‚</p><blockquote><p>errnoåœ¨å¤´æ–‡ä»¶&lt;errno.h&gt;ä¸­</p><p>errnoæ˜¯ä¸€ä¸ªå…¨å±€çš„é”™è¯¯ç å˜é‡</p><p>å½“Cè¯­è¨€çš„åº“å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šæŠŠå¯¹åº”çš„é”™è¯¯ç ï¼Œèµ‹å€¼åˆ°errnoä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    FILE * pFile;<br>    <span class="hljs-comment">//æ‰“å¼€æ–‡ä»¶</span><br>    pFile = fopen (<span class="hljs-string">&quot;unexist.ent&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (pFile == <span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error opening file unexist.ent: %s\n&quot;</span>,strerror(errno));<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Win opening file!&quot;</span>);<br>    &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/4b271827-30e6-493f-a1b7-59db778d01d7.png"><h2 id="7-å­—ç¬¦åˆ†ç±»å‡½æ•°"><a href="#7-å­—ç¬¦åˆ†ç±»å‡½æ•°" class="headerlink" title="7.å­—ç¬¦åˆ†ç±»å‡½æ•°"></a>7.å­—ç¬¦åˆ†ç±»å‡½æ•°</h2><p>å‡½æ•°ä½¿ç”¨éœ€è¦çš„å¤´æ–‡ä»¶<code>#include &lt;ctype.h&gt;</code></p><img src="/2023/03/07/C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0/df04e811-541d-4e15-9bfe-3525a4827235.png"><p><strong>å­—ç¬¦è½¬æ¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">tolower</span>(c);<span class="hljs-comment">//è½¬å°å†™å­—æ¯</span><br><span class="hljs-built_in">toupper</span>(c);<span class="hljs-comment">//è½¬å¤§å†™å­—æ¯</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> str[] = <span class="hljs-string">&quot;I Am A Good Student&quot;</span>;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(str[i])&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isupper</span>(str[i]))&#123;<br>            str[i] = <span class="hljs-built_in">tolower</span>(str[i]);<br>        &#125;<br>        i++;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,str);  <span class="hljs-comment">// i am a good student</span><br>   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°"><a href="#Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°" class="headerlink" title="Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°"></a>Binderç³»ç»Ÿå­¦ä¹ ç¬”è®°</h1><h2 id="1-Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ"><a href="#1-Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ" class="headerlink" title="1.Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ"></a>1.Binderç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒ</h2><h3 id="1-1-å‰è¨€"><a href="#1-1-å‰è¨€" class="headerlink" title="1.1 å‰è¨€"></a>1.1 å‰è¨€</h3><p>Aè¿›ç¨‹æƒ³è¦æŠŠæ•°æ®ä¼ é€’ç»™Bè¿›ç¨‹ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†<strong>IPC</strong>ï¼ˆInter Process Communication è·¨è¿›ç¨‹é€šä¿¡ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230305230100824.png" alt="image-20230305230100824" style="zoom:80%;"><p>ä¾‹å¦‚Aè¿›ç¨‹æƒ³è¦é€šè¿‡<code>led_open</code> æˆ–è€… <code>led_ctl</code> æ‰“å¼€ledï¼Œä½†æ˜¯å½“å‰Aè¿›ç¨‹æ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆä¼šé€šè¿‡RPCè¿›ç¨‹é€šä¿¡ï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230305230747468.png" alt="image-20230305230747468" style="zoom:80%;"><p>ä»è¿™ä¸ªå›¾æ¥çœ‹ï¼Œä»åº•ä¸‹æ¥çœ‹ä»¿ä½›æ˜¯Aè¿›ç¨‹è°ƒç”¨äº†ä¸€ä¸ªæœ¬åœ°çš„æ–¹æ³•led_open&#x2F;led_ctlï¼Œç„¶åæŠŠæ•°æ®å‘ç»™Bï¼Œç”±Bè¿›ç¨‹æ¥æ“ä½œç¡¬ä»¶ï¼ã€æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯RPCã€‘</p><blockquote><p><strong>RPC</strong>:(Reomote Procedure Call è¿œç¨‹è¿‡ç¨‹è°ƒç”¨) ï¼šå®¢æˆ·ç«¯å°†è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•åˆ™æ˜¯è´Ÿè´£é€æ˜çš„ä¸è¿œç¨‹æœåŠ¡ç«¯è¿›è¡Œè¿‡ç¨‹é—´é€šä¿¡ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•ä¼šå°†ç›¸å…³å‚æ•°é¡ºåºæ‰“åŒ…åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªæ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯æä¾›çš„æ–¹æ³•ï¼ŒæœåŠ¡ç«¯çš„æ–¹æ³•ä¼šä»æ¶ˆæ¯ä¸­è§£å‡ºåºåˆ—åŒ–å‘å‡ºæ¥çš„å‚æ•°ï¼Œç„¶åæ‰§è¡Œï¼Œæœ€åä»ä»¥åŒæ ·çš„æ–¹å¼å°†æ–¹æ³•çš„è¿”å›å€¼å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p></blockquote><h3 id="1-2-binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC"><a href="#1-2-binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC" class="headerlink" title="1.2 binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC"></a>1.2 binderç³»ç»Ÿä¸­çš„IPCå’ŒRPC</h3><p>binderç³»ç»Ÿä¸­IPCéœ€è¦å…·å¤‡ä¸‹é¢ä¸‰ä¸ªè¦ç´ ï¼š</p><ul><li><strong>æº</strong>ï¼šåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæºå°±æ˜¯è¿›ç¨‹A</li><li><strong>ç›®çš„</strong>ï¼š1ï¼‰B å‘ servicemanager æ³¨å†ŒledæœåŠ¡ï¼›2ï¼‰A å‘ servicemanager æŸ¥è¯¢ledæœåŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ªhandle</li><li><strong>æ•°æ®</strong>ï¼šå°±æ˜¯ä¸€ä¸ªchar bufï¼Œç”¨æ¥å­˜æ”¾é€šä¿¡çš„æ•°æ®</li></ul><p><strong>å®é™…çš„RPCè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦æ€è€ƒä¸‹é¢çš„é—®é¢˜</strong>ï¼š</p><ol><li>Aè¿›ç¨‹éœ€è¦è°ƒç”¨Bè¿›ç¨‹çš„ä»€ä¹ˆå‡½æ•°</li><li>Aè¿›ç¨‹éœ€è¦ä¼ é€’ä»€ä¹ˆå‚æ•°ç»™Bè¿›ç¨‹</li><li>Aè¿›ç¨‹ä¼šå¾—åˆ°Bè¿›ç¨‹çš„ä»€ä¹ˆè¿”å›å€¼</li></ol><blockquote><p>ç¬¬2æ­¥Aè¿›ç¨‹é€šè¿‡IPCå°†bufä¼ è¾“æ•°æ®ç»™Bï¼›</p><p>ç¬¬3æ­¥åŒæ ·Bè¿›ç¨‹å¤„ç†å®Œä»¥åé€šè¿‡IPCå°†æ•°æ®è¿”å›ç»™A</p></blockquote><h2 id="2-Binderæœºåˆ¶åˆ†æ"><a href="#2-Binderæœºåˆ¶åˆ†æ" class="headerlink" title="2 Binderæœºåˆ¶åˆ†æ"></a>2 Binderæœºåˆ¶åˆ†æ</h2><h3 id="2-1-servicemanagerçš„ä½œç”¨"><a href="#2-1-servicemanagerçš„ä½œç”¨" class="headerlink" title="2.1 servicemanagerçš„ä½œç”¨"></a>2.1 servicemanagerçš„ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/d12a5c80-9140-4483-bbf4-3ac05cd8a5f9.png" style="zoom: 67%;"><p>ä»£ç è·¯å¾„ï¼šframeworks&#x2F;native&#x2F;cmds&#x2F;servicemanager&#x2F;service_manager.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);  <span class="hljs-comment">// æ‰“å¼€binderé©±åŠ¨ã€bsæ˜¯æè¿°binderé©±åŠ¨çš„ç»“æ„ä½“ã€‘</span><br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        ALOGE(<span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å‘Šè¯‰binderé©±åŠ¨æˆ‘å°±æ˜¯servicemanager</span><br>    <span class="hljs-keyword">if</span> (binder_become_context_manager(bs)) &#123;<br>        ALOGE(<span class="hljs-string">&quot;cannot become context manager (%s)\n&quot;</span>, strerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    svcmgr_handle = BINDER_SERVICE_MANAGER;<br>    binder_loop(bs, svcmgr_handler);  <span class="hljs-comment">// å¾ªç¯ç›‘å¬binderé©±åŠ¨ï¼Œå®Œæˆç›¸åº”æœåŠ¡çš„å‡½æ•°è°ƒç”¨</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼šsvcmgr_handleæ˜¯ä»€ä¹ˆï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_transaction_data *txn,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *msg,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *reply)</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">switch</span>(txn-&gt;code) &#123;<br>    <span class="hljs-keyword">case</span> SVC_MGR_GET_SERVICE:<br>    <span class="hljs-keyword">case</span> SVC_MGR_CHECK_SERVICE:<br>        <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">case</span> SVC_MGR_ADD_SERVICE:<br>        <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">case</span> SVC_MGR_LIST_SERVICES: &#123;<br>       <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    bio_put_uint32(reply, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°svcmgr_handlerå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ã€è¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šæ ¹æ®ä¼ è¿›æ¥çš„txnç»“æ„ä½“ä¸­çš„codeæ¥å†³å®šï¼Œåˆ°åº•æ˜¯å»æ³¨å†ŒæœåŠ¡è¿˜æ˜¯è°ƒç”¨æœåŠ¡ã€‘</p><ul><li>å¦‚æœæ˜¯<code>SVC_MGR_ADD_SERVICE</code>ï¼Œå°±æ˜¯æ³¨å†ŒæœåŠ¡</li><li>å¦‚æœæ˜¯<code>SVC_MGR_CHECK_SERVICE</code>ï¼Œå°±æ˜¯æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨</li><li>å¦‚æœæ˜¯<code>SVC_MGR_GET_SERVICE</code>ï¼Œå°±æ˜¯è·å–æœåŠ¡</li></ul><blockquote><p>è¿™é‡Œæ­£å¥½å¯¹åº”ä¸Šäº†å¼€å¤´æ€ç»´å¯¼å›¾ä¸Šçš„æœ€åä¸€é¡¹servicemanagerçš„ä½œç”¨</p></blockquote><h3 id="1-3-2-serverç«¯ä½œç”¨"><a href="#1-3-2-serverç«¯ä½œç”¨" class="headerlink" title="1.3.2 serverç«¯ä½œç”¨"></a>1.3.2 serverç«¯ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1a4196fb-da3b-4125-99f4-a1a9516218fd.png" style="zoom: 50%;"><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ³¨å†ŒæœåŠ¡çš„æµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_publish</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br>    bio_put_obj(&amp;msg, ptr);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    status = bio_get_uint32(&amp;reply);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡æ—¶ä¼šè°ƒç”¨<code>svcmgr_publish</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢æœ€ä¸»è¦çš„æ˜¯å»è°ƒç”¨<code>binder_call</code>å‡½æ•°</p><p><strong>binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE)</strong></p><ul><li>bsï¼šæè¿°binderé©±åŠ¨çš„ç»“æ„ä½“</li><li>msgï¼šè¡¨ç¤ºè¦æ³¨å†ŒæœåŠ¡çš„ç›¸å…³ä¿¡æ¯çš„binder_ioç»“æ„ä½“</li><li>replyï¼šè¡¨ç¤ºservicemanagerå›å¤çš„æ•°æ®</li><li>targetï¼šæ³¨å†Œæ—¶targetä¼ çš„æ˜¯BINDER_SERVICE_MANAGERï¼Œè¯¥å€¼è¡¨ç¤ºçš„å°±æ˜¯servicemanager</li><li>SVC_MGR_ADD_SERVICEï¼šè¡¨ç¤ºè°ƒç”¨ç›®æ ‡çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„CODEå€¼ä¸ºSVC_MGR_ADD_SERVICEã€åœ¨æ³¨å†Œæ—¶ç›¸å½“äºè°ƒç”¨servicemanagerçš„addserviceæœåŠ¡ã€‘</li></ul><h3 id="1-3-3-clientç«¯ä½œç”¨"><a href="#1-3-3-clientç«¯ä½œç”¨" class="headerlink" title="1.3.3 clientç«¯ä½œç”¨"></a>1.3.3 clientç«¯ä½œç”¨</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/f955b7ac-25ac-4cd8-82b1-af135a447d3b.png" style="zoom: 50%;"><p>clientç«¯é¦–å…ˆä¼šå»è·å–æœåŠ¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">svcmgr_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_CHECK_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    handle = bio_get_ref(&amp;reply);<br><br>    <span class="hljs-keyword">if</span> (handle)<br>        binder_acquire(bs, handle);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> handle;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ ·ä¹Ÿä¼šå»è°ƒç”¨binder_callå‡½æ•°</p><p><strong>binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE)</strong></p><ul><li>bsï¼šæè¿°binderé©±åŠ¨çš„ç»“æ„ä½“</li><li>msgï¼šè¡¨ç¤ºå³å°†æŸ¥è¯¢æœåŠ¡çš„ç›¸å…³ä¿¡æ¯çš„binder_ioç»“æ„ä½“</li><li>replyï¼šè¡¨ç¤ºservicemanagerå›å¤çš„æ•°æ®ï¼Œæ•°æ®é‡Œé¢ä¼šåŒ…å«åˆšåˆšæƒ³è¦æŸ¥è¯¢æœåŠ¡çš„è¿›ç¨‹</li><li>targetï¼šæ³¨å†Œæ—¶targetä¼ çš„æ˜¯BINDER_SERVICE_MANAGERï¼Œè¯¥å€¼è¡¨ç¤ºçš„å°±æ˜¯servicemanager</li><li>SVC_MGR_CHECK_SERVICEï¼šè¡¨ç¤ºè°ƒç”¨ç›®æ ‡çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„CODEå€¼ä¸ºSVC_MGR_CHECK_SERVICEã€åœ¨æ³¨å†Œæ—¶ç›¸å½“äºè°ƒç”¨servicemanagerçš„getserviceæœåŠ¡ã€‘</li></ul><h3 id="1-3-4-ç†è§£binder-callå‡½æ•°"><a href="#1-3-4-ç†è§£binder-callå‡½æ•°" class="headerlink" title="1.3.4 ç†è§£binder_callå‡½æ•°"></a>1.3.4 ç†è§£binder_callå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">binder_call</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                <span class="hljs-keyword">struct</span> binder_io *msg, <span class="hljs-keyword">struct</span> binder_io *reply,</span><br><span class="hljs-params">                <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">uint32_t</span> code)</span><br>&#123;<br>    <span class="hljs-type">int</span> res;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_write_read</span> <span class="hljs-title">bwr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-type">uint32_t</span> cmd;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_transaction_data</span> <span class="hljs-title">txn</span>;</span><br>    &#125; __attribute__((packed)) writebuf;<br>    <span class="hljs-type">unsigned</span> readbuf[<span class="hljs-number">32</span>];<br><br>    <span class="hljs-keyword">if</span> (msg-&gt;flags &amp; BIO_F_OVERFLOW) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;binder: txn buffer overflow\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> fail;<br>    &#125;<br><br>    writebuf.cmd = BC_TRANSACTION;<br>    writebuf.txn.target.handle = target;<br>    writebuf.txn.code = code;<br>    writebuf.txn.flags = <span class="hljs-number">0</span>;<br>    writebuf.txn.data_size = msg-&gt;data - msg-&gt;data0;<br>    writebuf.txn.offsets_size = ((<span class="hljs-type">char</span>*) msg-&gt;offs) - ((<span class="hljs-type">char</span>*) msg-&gt;offs0);<br>    writebuf.txn.data.ptr.buffer = (<span class="hljs-type">uintptr_t</span>)msg-&gt;data0;<br>    writebuf.txn.data.ptr.offsets = (<span class="hljs-type">uintptr_t</span>)msg-&gt;offs0;<br><br>    bwr.write_size = <span class="hljs-keyword">sizeof</span>(writebuf);<br>    bwr.write_consumed = <span class="hljs-number">0</span>;<br>    bwr.write_buffer = (<span class="hljs-type">uintptr_t</span>) &amp;writebuf;<br><br>    hexdump(msg-&gt;data0, msg-&gt;data - msg-&gt;data0);<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        bwr.read_size = <span class="hljs-keyword">sizeof</span>(readbuf);<br>        bwr.read_consumed = <span class="hljs-number">0</span>;<br>        bwr.read_buffer = (<span class="hljs-type">uintptr_t</span>) readbuf;<br><br>        res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);<br><br>        <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;binder: ioctl failed (%s)\n&quot;</span>, strerror(errno));<br>            <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br><br>        res = binder_parse(bs, reply, (<span class="hljs-type">uintptr_t</span>) readbuf, bwr.read_consumed, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> fail;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>binder_callå°±æ˜¯rpcä¸­çš„è¿œç¨‹è°ƒç”¨å‡½æ•°</strong></p><p>åœ¨æ³¨å†ŒæœåŠ¡ï¼Œè·å–æœåŠ¡ï¼Œè°ƒç”¨æœåŠ¡ä¸­çš„æ¥å£å‡½æ•°éƒ½æ˜¯ä½¿ç”¨äº†binder_callå‡½æ•°ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹binder_callå‡½æ•°å…·ä½“åœ¨å¹²å˜›ï¼š</p><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3bdaac93-c274-45df-b04b-2a106eb4a42c.png" style="zoom: 67%;"><p><strong>binder_callå†…éƒ¨å®ç°ï¼š</strong></p><ol><li>æ„é€ å‚æ•°msgï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªbinder_ioç±»å‹çš„æ•°æ®</li><li>å°†binder_ioæ•°æ®è½¬åŒ–ä¸º<code>binder_write_read</code>ç±»å‹çš„æ•°æ®ï¼Œå› ä¸ºbinderé©±åŠ¨çš„ioctlä¸­ä¼ é€’çš„æ˜¯<code>binder_write_read</code>ç±»å‹çš„æ•°æ®</li></ol><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9b6e2287-0653-4646-8533-7cf9bdaf8b79.png" style="zoom: 67%;"><ol start="3"><li>å®¢æˆ·ç«¯ä¼šè°ƒç”¨ioctlå‘é€æ•°æ®</li></ol><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4f6deea3-edd7-44e5-9d8a-01d697da89d2.png" style="zoom: 67%;"><ol start="4"><li>æœåŠ¡ç«¯ä¼šè°ƒç”¨ioctlæ¥æ”¶æ•°æ®</li></ol><h2 id="3-Cç¨‹åºå®ç°HelloæœåŠ¡"><a href="#3-Cç¨‹åºå®ç°HelloæœåŠ¡" class="headerlink" title="3.Cç¨‹åºå®ç°HelloæœåŠ¡"></a>3.Cç¨‹åºå®ç°HelloæœåŠ¡</h2><h3 id="3-1-serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯"><a href="#3-1-serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯" class="headerlink" title="3.1 serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯"></a>3.1 serverç«¯å’Œclientç«¯ç¼–å†™æ€è·¯</h3><p><strong>clientç«¯ï¼š</strong></p><ul><li>æ‰“å¼€é©±åŠ¨ï¼Œbinder_open</li><li>è·å–æœåŠ¡çš„handleã€æœåŠ¡ä»¥è¿›ç¨‹çš„å½¢å¼å­˜åœ¨ï¼Œå°±æ˜¯è·å¾—æœåŠ¡å¯¹åº”è¿›ç¨‹çš„handleã€‘</li><li>æ„é€ å‚æ•°binder_io</li><li>è°ƒç”¨å‡½æ•°binder_callè¿›è¡Œè¿œç¨‹æœåŠ¡è®¿é—®</li><li>è¿”å›binder_ioï¼Œå–å‡ºè¿”å›å€¼</li><li>é‡Šæ”¾è·å¾—çš„handle</li></ul><p><strong>serverç«¯ï¼š</strong></p><ul><li>æ‰“å¼€é©±åŠ¨ï¼Œbinder_open</li><li>è°ƒç”¨svcmgr_publishæ³¨å†ŒæœåŠ¡</li><li>ioctlå»è¯»å–binderé©±åŠ¨çš„æ•°æ®</li><li>è§£ææ•°æ®ï¼Œå°†binder_write_readç±»å‹çš„æ•°æ®è½¬æ¢ä¸ºbinder_ioç±»å‹çš„æ•°æ®</li><li>æ ¹æ®è§£æå‡ºçš„æ•°æ®ä¸­çš„CODEå€¼ï¼Œå»è°ƒç”¨å½“å‰æœåŠ¡çš„å¯¹åº”å‡½æ•°</li><li>æŠŠè¿”å›å€¼è½¬æ¢ä¸ºbinder_io</li></ul><h3 id="3-2-helloæœåŠ¡çš„serverç«¯"><a href="#3-2-helloæœåŠ¡çš„serverç«¯" class="headerlink" title="3.2 helloæœåŠ¡çš„serverç«¯"></a>3.2 helloæœåŠ¡çš„serverç«¯</h3><ul><li>test_server.h</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å®šä¹‰helloæœåŠ¡çš„CODEç¼–ç ï¼Œæ¥è¡¨ç¤ºå½“å‰åº”è¯¥è°ƒç”¨æœåŠ¡çš„å“ªä¸€ä¸ªå‡½æ•°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _TEST_SERVER_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _TEST_SERVER_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HELLO_SVR_CMD_SAYHELLO     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HELLO_SVR_CMD_SAYHELLO_TO  2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GOODBYE_SVR_CMD_SAYGOODBYE     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GOODBYE_SVR_CMD_SAYGOODBYE_TO  2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// _TEST_SERVER_H</span></span><br></code></pre></td></tr></table></figure><ul><li>test_server.c</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">/* Copyright 2008 The Android Open Source Project</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;private/android_filesystem_config.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;binder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test_server.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">svcmgr_publish</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br>    bio_put_obj(&amp;msg, ptr);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_ADD_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    status = bio_get_uint32(&amp;reply);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sayhello</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;say hello : %d\n&quot;</span>, ++cnt);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sayhello_to</span><span class="hljs-params">(<span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;say hello to %s : %d\n&quot;</span>, name, ++cnt);<br>    <span class="hljs-keyword">return</span> cnt;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">hello_service_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_transaction_data *txn,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *msg,</span><br><span class="hljs-params">                   <span class="hljs-keyword">struct</span> binder_io *reply)</span><br>&#123;<br>    <span class="hljs-comment">/* æ ¹æ®txn-&gt;codeçŸ¥é“è¦è°ƒç”¨å“ªä¸€ä¸ªå‡½æ•°</span><br><span class="hljs-comment">     * å¦‚æœéœ€è¦å‚æ•°, å¯ä»¥ä»msgå–å‡º</span><br><span class="hljs-comment">     * å¦‚æœè¦è¿”å›ç»“æœ, å¯ä»¥æŠŠç»“æœæ”¾å…¥reply</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/* sayhello</span><br><span class="hljs-comment">     * sayhello_to</span><br><span class="hljs-comment">     */</span><br>    <br>    <span class="hljs-type">uint16_t</span> *s;<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">size_t</span> len;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">uint32_t</span> strict_policy;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span><br>    <span class="hljs-comment">// header with the strict mode policy mask and the interface name.</span><br>    <span class="hljs-comment">// Note that we ignore the strict_policy and don&#x27;t propagate it</span><br>    <span class="hljs-comment">// further (since we do no outbound RPCs anyway).</span><br>    strict_policy = bio_get_uint32(msg);<br><br>    <span class="hljs-keyword">switch</span>(txn-&gt;code) &#123;<br>    <span class="hljs-keyword">case</span> HELLO_SVR_CMD_SAYHELLO:<br>        sayhello();<br>        bio_put_uint32(reply, <span class="hljs-number">0</span>); <span class="hljs-comment">/* no exception */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">case</span> HELLO_SVR_CMD_SAYHELLO_TO:<br>        <span class="hljs-comment">/* ä»msgé‡Œå–å‡ºå­—ç¬¦ä¸² */</span><br>        s = bio_get_string16(msg, &amp;len);  <span class="hljs-comment">//&quot;IHelloService&quot;</span><br>        s = bio_get_string16(msg, &amp;len);  <span class="hljs-comment">// name</span><br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>            name[i] = s[i];<br>        name[i] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>        <span class="hljs-comment">/* å¤„ç† */</span><br>        i = sayhello_to(name);<br><br>        <span class="hljs-comment">/* æŠŠç»“æœæ”¾å…¥reply */</span><br>        bio_put_uint32(reply, <span class="hljs-number">0</span>); <span class="hljs-comment">/* no exception */</span><br>        bio_put_uint32(reply, i);<br>        <br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;unknown code %d\n&quot;</span>, txn-&gt;code);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br>    <span class="hljs-type">uint32_t</span> svcmgr = BINDER_SERVICE_MANAGER;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">int</span> ret;<br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* add service */</span><br>    ret = svcmgr_publish(bs, svcmgr, <span class="hljs-string">&quot;hello&quot;</span>, hello_service_handler);<br>    <span class="hljs-keyword">if</span> (ret) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to publish hello service\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">/* read data */</span><br>        <span class="hljs-comment">/* parse data, and process */</span><br>        <span class="hljs-comment">/* reply */</span><br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    binder_set_maxthreads(bs, <span class="hljs-number">10</span>);<br><br>    binder_loop(bs, hello_service_handler);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-helloæœåŠ¡çš„clientç«¯"><a href="#3-3-helloæœåŠ¡çš„clientç«¯" class="headerlink" title="3.3 helloæœåŠ¡çš„clientç«¯"></a>3.3 helloæœåŠ¡çš„clientç«¯</h3><ul><li>test_client.c</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs c">&lt;&gt;<span class="hljs-comment">/* Copyright 2008 The Android Open Source Project</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;private/android_filesystem_config.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;binder.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test_server.h&quot;</span></span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">svcmgr_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> binder_state *bs, <span class="hljs-type">uint32_t</span> target, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, SVC_MGR_NAME);<br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-keyword">if</span> (binder_call(bs, &amp;msg, &amp;reply, target, SVC_MGR_CHECK_SERVICE))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    handle = bio_get_ref(&amp;reply);<br><br>    <span class="hljs-keyword">if</span> (handle)<br>        binder_acquire(bs, handle);<br><br>    binder_done(bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> handle;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">g_bs</span>;</span><br><span class="hljs-type">uint32_t</span> g_hello_handle;<br><span class="hljs-type">uint32_t</span> g_goodbye_handle;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sayhello</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br><br>    <span class="hljs-comment">/* æ„é€ binder_io */</span><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, <span class="hljs-string">&quot;IHelloService&quot;</span>);<br><br>    <span class="hljs-comment">/* æ”¾å…¥å‚æ•° */</span><br><br>    <span class="hljs-comment">/* è°ƒç”¨binder_call */</span><br>    <span class="hljs-keyword">if</span> (binder_call(g_bs, &amp;msg, &amp;reply, g_hello_handle, HELLO_SVR_CMD_SAYHELLO))<br>        <span class="hljs-keyword">return</span> ;<br>    <br>    <span class="hljs-comment">/* ä»replyä¸­è§£æå‡ºè¿”å›å€¼ */</span><br><br>    binder_done(g_bs, &amp;msg, &amp;reply);<br>    <br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sayhello_to</span><span class="hljs-params">(<span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> iodata[<span class="hljs-number">512</span>/<span class="hljs-number">4</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_io</span> <span class="hljs-title">msg</span>, <span class="hljs-title">reply</span>;</span><br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">int</span> exception;<br><br>    <span class="hljs-comment">/* æ„é€ binder_io */</span><br>    bio_init(&amp;msg, iodata, <span class="hljs-keyword">sizeof</span>(iodata), <span class="hljs-number">4</span>);<br>    bio_put_uint32(&amp;msg, <span class="hljs-number">0</span>);  <span class="hljs-comment">// strict mode header</span><br>    bio_put_string16_x(&amp;msg, <span class="hljs-string">&quot;IHelloService&quot;</span>);<br><br>    <span class="hljs-comment">/* æ”¾å…¥å‚æ•° */</span><br>    bio_put_string16_x(&amp;msg, name);<br><br>    <span class="hljs-comment">/* è°ƒç”¨binder_call */</span><br>    <span class="hljs-keyword">if</span> (binder_call(g_bs, &amp;msg, &amp;reply, g_hello_handle, HELLO_SVR_CMD_SAYHELLO_TO))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">/* ä»replyä¸­è§£æå‡ºè¿”å›å€¼ */</span><br>    exception = bio_get_uint32(&amp;reply);<br>    <span class="hljs-keyword">if</span> (exception)<br>        ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">else</span><br>        ret = bio_get_uint32(&amp;reply);<br><br>    binder_done(g_bs, &amp;msg, &amp;reply);<br><br>    <span class="hljs-keyword">return</span> ret;<br>    <br>&#125;<br><br><br><span class="hljs-comment">/* ./test_client hello</span><br><span class="hljs-comment"> * ./test_client hello &lt;name&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_state</span> *<span class="hljs-title">bs</span>;</span><br>    <span class="hljs-type">uint32_t</span> svcmgr = BINDER_SERVICE_MANAGER;<br>    <span class="hljs-type">uint32_t</span> handle;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage:\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s &lt;hello&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s &lt;hello&gt; &lt;name&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    bs = binder_open(<span class="hljs-number">128</span>*<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!bs) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to open binder driver\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    g_bs = bs;<br><br>    <span class="hljs-comment">/* get service */</span><br>    handle = svcmgr_lookup(bs, svcmgr, <span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!handle) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;failed to get hello service\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    g_hello_handle = handle;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Handle for hello service = %d\n&quot;</span>, g_hello_handle);<br><br>    <span class="hljs-comment">/* send data to server */</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;hello&quot;</span>))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">2</span>) &#123;<br>            sayhello();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">3</span>) &#123;<br>            ret = sayhello_to(argv[<span class="hljs-number">2</span>]);<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;get ret of sayhello_to = %d\n&quot;</span>, ret);      <br>        &#125;<br>    &#125;<br><br>    binder_release(bs, handle);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3f3601eb-c63d-46bb-9692-1dfdc4d24690.png"><h3 id="3-4-æ€»ç»“"><a href="#3-4-æ€»ç»“" class="headerlink" title="3.4 æ€»ç»“"></a>3.4 æ€»ç»“</h3><img src="/2023/03/05/Binder%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/b20537c9-9aff-4da7-84ae-dd1dbcb30baf.png">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Android 8.1ä»é›¶å¼€å§‹å†™HAL</title>
    <link href="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/"/>
    <url>/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/</url>
    
    <content type="html"><![CDATA[<h1 id="Android-8-1ä»é›¶å¼€å§‹å†™HAL"><a href="#Android-8-1ä»é›¶å¼€å§‹å†™HAL" class="headerlink" title="Android 8.1ä»é›¶å¼€å§‹å†™HAL"></a>Android 8.1ä»é›¶å¼€å§‹å†™HAL</h1><blockquote><p>ğŸ›ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒQidi_Huangã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>ğŸœåŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/Qidi_Huang/article/details/107426961">https://blog.csdn.net/Qidi_Huang/article/details/107426961</a></p></blockquote><h2 id="1-å®šä¹‰æ¥å£"><a href="#1-å®šä¹‰æ¥å£" class="headerlink" title="1.å®šä¹‰æ¥å£"></a>1.å®šä¹‰æ¥å£</h2><p>ã€å‰è¨€ã€‘<br>æˆ‘ä»¬éƒ½çŸ¥é“ä» <code>Android 8.0</code> å¼€å§‹ï¼Œ Google å¯åŠ¨äº† <code>Treble é¡¹ç›®</code>ï¼Œè‡ªæ­¤å¼€å§‹æ¨è¡Œ Binder åŒ–çš„ HAL å®ç°ã€‚é™¤å°‘æ•°ç±»å‹ HAL å¤–ï¼Œåœ¨ Android 9.0 åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ï¼ŒGoogle ç”šè‡³è¦æ±‚å¤§éƒ¨åˆ†<strong>å¤–è®¾</strong>(peripherals) å¿…é¡»æ”¯æŒä½¿ç”¨ Binder åŒ–çš„ HALï¼Œå¦åˆ™éƒ½ä¸å†è§†ä¸ºåˆè§„ã€‚å› æ­¤ï¼Œæœ¬æ–‡ä¸­çš„ HAL æŒ‡çš„æ˜¯ç”¨ HIDL è¯­è¨€æè¿°ã€ä½¿ç”¨ Binder æ–¹å¼å®ç°çš„ HALã€‚</p><p>åœ¨é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« å‰ï¼Œå¦‚æœä½ å·²ç»å¤§è‡´äº†è§£ <code>Android SELinux</code> æ¦‚å¿µï¼ˆæ¯”å¦‚ <code>*.te</code> æ–‡ä»¶å’Œ <code>file_contexts</code>ï¼‰ï¼Œä»¥åŠ Binder çš„åŸºæœ¬è°ƒç”¨æ–¹æ³•ï¼ˆæ¯”å¦‚çŸ¥é“åºåˆ—åŒ–çš„æ¦‚å¿µã€ transact()&#x2F;onTransact()çš„è°ƒç”¨æ—¶æœºï¼‰ï¼Œå¯¹äºç†è§£æœ¬æ–‡çš„å†…å®¹ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p><p>æ ¹æ®é¡¹ç›®ä¸åŒï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè®¸å¸Œæœ›åœ¨è®¾å¤‡ä¸Šä½¿ç”¨ä¸€ç§æ–°çš„å¤–è®¾ï¼Œæ¯”å¦‚æŸç§ä¼ æ„Ÿå™¨ï¼›æˆ–è€…æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ Android native å±‚è¿è¡Œä¸€ä¸ªç‰¹å®šè¿›ç¨‹ï¼Œç”¨æ¥è¾…åŠ©å¤„ç†æ¥è‡ª Android Frameworks çš„æ•°æ®ï¼Œæˆ–è€…ç”¨äºå’Œå…¶å®ƒ native å±‚çš„è¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚å¯¹äºå‰ä¸€ç§åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå¤–è®¾ç¼–å†™å…¨æ–°çš„ HALï¼›å¯¹äºåä¸€ç§åœºæ™¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç¼–å†™ HALï¼Œä½†éœ€è¦å®ç°ä¸€ä¸ªå¾ˆç±»ä¼¼çš„ vendor serviceã€‚è¿™äºŒè€…çš„å®ç°æ–¹å¼æå…¶ç±»ä¼¼ï¼ŒåŒºåˆ«åªåœ¨äºä»–ä»¬ä½¿ç”¨çš„è®¾å¤‡èŠ‚ç‚¹ä¸åŒï¼ˆä¸€ä¸ªä½¿ç”¨<code>/dev/hwbinder</code>ï¼Œå¦ä¸€ä¸ªä½¿ç”¨ <code>/dev/vndbinder</code>ï¼‰ï¼Œè¿˜æœ‰å„è‡ªç”³è¯·çš„ sepolicy æƒé™æœ‰åˆ«ã€‚</p><p>ä»¥ä¸‹æ­£æ–‡ä»¥å®ç°ä¸€ä¸ªå…¨æ–°çš„ HAL ä¸ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œä½†å¹¶ä¸æ¶‰åŠå¯¹è®¾å¤‡èŠ‚ç‚¹çš„æ“ä½œã€‚</p><h3 id="1-1-æ˜ç¡®HALæ¥å£"><a href="#1-1-æ˜ç¡®HALæ¥å£" class="headerlink" title="1.1 æ˜ç¡®HALæ¥å£"></a>1.1 æ˜ç¡®HALæ¥å£</h3><p>Android å¤§é‡é‡‡ç”¨é¢å‘æ¥å£ç¼–ç¨‹çš„ç†å¿µï¼ŒHAL ä¹Ÿä¸ä¾‹å¤–ã€‚å¸¸ç”¨çš„ HAL æ¨¡å—æ¥å£å·²ç»ç”± Google å’Œä¸šç•Œå……åˆ†è®¨è®ºå¹¶é¢„å®šä¹‰ï¼Œæ¯”å¦‚ Audio å’Œ Cameraï¼Œè¿™äº›æ¨¡å—éœ€è¦æ”¯æŒçš„åŠŸèƒ½ä¹Ÿå·²ç»æ˜ç¡®ï¼Œå…¶æ¥å£æè¿°å¯ä»¥åœ¨ <code>/hardware/interfaces/</code> ç›®å½•ä¸‹æ‰¾åˆ°ã€‚</p><p>åŒç†ï¼Œæˆ‘ä»¬å®ç°è‡ªå·±çš„ HAL æ—¶ï¼Œä¹Ÿåº”è¯¥å…ˆæ˜ç¡®æ–° HAL è¦æ”¯æŒçš„åŠŸèƒ½ï¼Œå†æ ¹æ®éœ€æ±‚éœ€è¦è®¾è®¡è¦æš´éœ²ç»™ç»™å…¶å®ƒè¿›ç¨‹çš„æ¥å£ã€‚</p><p><strong>ä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸ä»¥çœŸå®çš„å¤–è®¾ HAL æ¥æè¿°ï¼Œè€Œæ˜¯åšä¸€ç³»åˆ—å‡è®¾ï¼Œè‡ªå·±ç»™è‡ªå·±è®¾è®¡éœ€æ±‚ã€‚è™½ç„¶è¿™æ ·çš„ HAL ä¸å¯¹åº”å…·ä½“çš„ä½¿ç”¨åœºæ™¯ï¼Œä½†é“ç†æ˜¯ç›¸é€šçš„ï¼Œå®Œå…¨å¯ä»¥ç…§çŒ«ç”»è™ã€ä¸¾ä¸€åä¸‰ã€‚</strong></p><p>æˆ‘ä»¬å‡è®¾æ–° HAL éœ€è¦æ”¯æŒ 3 ä¸ªåŠŸèƒ½ï¼š</p><ul><li>å…è®¸å…¶å®ƒè¿›ç¨‹ä¸»åŠ¨è®¾ç½®çŠ¶æ€</li><li>å…è®¸å…¶å®ƒè¿›ç¨‹æ³¨å†Œå›è°ƒå‡½æ•°</li><li>å…è®¸å…¶å®ƒè¿›ç¨‹æ³¨é”€å›è°ƒå‡½æ•°</li></ul><p>ç»™ <strong>æ–°å¤–è®¾</strong>å–åä¸º <code>demoComponent</code>ï¼Œç»™<strong>æ–° HAL çš„è¿›ç¨‹</strong>å–åä¸º <code>demoService</code>ã€‚ç»™æ”¯æŒä¸Šè¿° 3 é¡¹åŠŸèƒ½çš„æ¥å£åˆ†åˆ«å–åä¸º <code>setStatus() </code>ã€ <code>registerCallback()</code> å’Œ <code>unregisterCallback()</code>ã€‚å‡è®¾å…¶å®ƒè¿›ç¨‹æ‰€è®¾ç½®çš„â€œçŠ¶æ€â€æ˜¯ä¸€ä¸ª <code>DemoData</code> ç»“æ„ä½“ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-built_in">string</span>  name;<br>    <span class="hljs-type">int</span>     value;<br>&#125; DemoData;<br></code></pre></td></tr></table></figure><p>å‡è®¾å›è°ƒå‡½æ•°æ–¹æ³•ä¸º <code>onCallbackEvent()</code>ï¼Œ å‚æ•°åŒæ ·ä¸º <code>DemoData</code> ç»“æ„ã€‚</p><h3 id="1-2-ç¼–å†™æ¥å£æè¿°æ–‡ä»¶"><a href="#1-2-ç¼–å†™æ¥å£æè¿°æ–‡ä»¶" class="headerlink" title="1.2 ç¼–å†™æ¥å£æè¿°æ–‡ä»¶"></a>1.2 ç¼–å†™æ¥å£æè¿°æ–‡ä»¶</h3><p>é€šå¸¸ï¼Œç»è¿‡å‰è¿°æ­¥éª¤æ˜ç¡®æ¥å£ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºå®Œæ•´çš„å¤´æ–‡ä»¶æ¥äº†ï¼Œç»§è€Œå¯¹åº”å®ç°å„æ¥å£ã€‚ä½†æ˜¯åœ¨ HAL å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å†™çš„ä¸æ˜¯å¤´æ–‡ä»¶ï¼Œè€Œæ˜¯åˆ›ä½œå‡ºç”¨ HIDL è¯­è¨€ç¼–å†™çš„ <code>*.hal</code> æ¥å£æè¿°æ–‡ä»¶ã€‚ï¼ˆ<strong>ä¸è¿‡ï¼Œåœ¨ Android R ä¸Šå°†æ”¯æŒç”¨ AIDL è¯­è¨€æ¥ç¼–å†™æ¥å£æè¿°æ–‡ä»¶ï¼Œä»¥åå¯èƒ½é€æ­¥åºŸå¼ƒ HIDL è¯­è¨€</strong>ï¼‰</p><p>æŒ‰ç…§ç›®å‰çš„å¼€å‘è§„èŒƒï¼Œæˆ‘ä»¬çš„è‡ªå®šä¹‰æ¥å£æè¿°æ–‡ä»¶é€šå¸¸æ”¾åœ¨ <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/&lt;ComponentName&gt;/&lt;SubComponentName&gt;/&lt;VersionCode&gt;/</code> ç›®å½•ä¸‹ã€‚ æ ¹æ®æˆ‘ä»¬å‰æ–‡çš„å‡è®¾ï¼Œè¿™é‡Œçš„<code>&lt;ComponentName&gt;</code>å°±æ˜¯ demoComponentã€‚<code>&lt;SubComponentName&gt;</code> å¯æœ‰å¯æ— ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å¯¹åº”çš„æ˜¯ demoServiceã€‚VersionCode è¡¨ç¤º HAL æ¥å£çš„ç‰ˆæœ¬å·ï¼Œå› ä¸ºæˆ‘ä»¬ç¼–å†™çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„ HALï¼Œæ‰€ä»¥ç‰ˆæœ¬å·æ˜¯ 1.0ã€‚</p><p>å› ä¸ºæˆ‘ä»¬çš„å®ç°æ¶‰åŠ <strong>HAL è¿›ç¨‹ã€å›è°ƒå‡½æ•°ã€å‚æ•°æ•°æ®</strong> 3 ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥å¯¹åº”çš„ hal æ–‡ä»¶ä¹Ÿæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><strong>IDemoServiceDef.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br>import IDemoCallback;<br><br>interface IDemoServiceDef &#123;<br><br>    setStatus(DemoData data) generates (<span class="hljs-type">int32_t</span> status);<br>    registerCallback(IDemoCallback cb) generates (<span class="hljs-type">int32_t</span> status);<br>    unregisterCallback(IDemoCallback cb) generates (<span class="hljs-type">int32_t</span> status);<br>&#125;;<br><br></code></pre></td></tr></table></figure><ul><li><strong>IDemoCallback.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br>interface IDemoCallback &#123;<br><br>   onCallbackEvent(DemoData payload) generates (<span class="hljs-type">int32_t</span> status);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong>types.hal</strong>:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">package vendor.harman.hardware.demoComponent.demoService@<span class="hljs-number">1.0</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DemoData</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-built_in">string</span>  name;<br>    <span class="hljs-type">int32_t</span> value;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰å››ä¸ªåŸºæœ¬ç‚¹éœ€è¦æ³¨æ„ã€‚</p><ol><li><p><strong>æ•°æ®ç±»å‹æè¿°æ–‡ä»¶çš„æ–‡ä»¶åæ˜¯ä¸ªå›ºå®šåç§°</strong> <code>types.hal</code>ï¼›æ¥å£æè¿°æ–‡ä»¶çš„æ–‡ä»¶åè¦ä»¥<strong>å¤§å†™å­—æ¯ I</strong> å¼€å¤´å†™ä½œ <code>IXxxx.hal</code>ï¼Œå¹¶ä¸”ç›¸åº”åœ°ä»¥<code>interface IXxxx &#123;&#125; </code>è¿›è¡Œæè¿°ï¼›<strong>generates</strong> ååŠ æ•°æ®ç±»å‹è¡¨ç¤ºæ¥å£çš„è¿”å›å€¼ç±»å‹ã€‚</p></li><li><p>æ¯ä¸ª<code> *.hal</code> æ–‡ä»¶éƒ½éœ€è¦åœ¨æ–‡ä»¶å¤´å£°æ˜å®ƒæ‰€å±çš„åŒ…ã€‚è¿™é‡Œçš„åŒ…åä¸º<code> package vendor.harman.hardware.demoComponent.demoService@1.0;</code>ã€‚</p></li><li><p>HIDL è¯­è¨€æ‰€ä½¿ç”¨çš„æ•°æ®ç±»å‹å’Œ C&#x2F;C++&#x2F;Java çš„æ•°æ®ç±»å‹ç¨æœ‰åŒºåˆ«ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œå¯¹æ¯” DemoData ç»“æ„ä½“çš„åŸå§‹å†™æ³•ä¸ HIDL å†™æ³•ï¼Œå¯ä»¥çœ‹åˆ° int32 è¢«æ›¿æ¢æˆäº† int32_tã€‚ å†æ¯”å¦‚è¯´ï¼ŒHIDL æ•°æ®ç±»å‹ä¹Ÿä¸æ”¯æŒ C&#x2F;C++ çš„åŸå§‹æŒ‡é’ˆã€‚å…³äº HIDL æ•°æ®ç±»å‹çš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒã€ŠHIDL æ•°æ®ç±»å‹ã€‹ã€‚</p></li><li><p>å¦å¤–ï¼Œ<code>*.hal</code> æ–‡ä»¶ä¹‹é—´ç›¸äº’å¼•ç”¨æ—¶ï¼Œä½¿ç”¨ <code>import</code> å…³é”®å­—è¿›è¡Œå£°æ˜ã€‚</p></li></ol><p>è¿™äº›å›ºå®šå½¢å¼æ˜¯ç”± HIDL æ¡†æ¶å†³å®šçš„ï¼Œæˆ‘ä»¬å¿…é¡»éµä»ã€‚</p><p>ç¼–å†™å®Œæˆåç”¨ <code>ls</code> å‘½ä»¤æŸ¥çœ‹ï¼Œå°±æ˜¯ä¸‹å›¾ä¸­ 3 ä¸ªç»¿è‰²æ–‡ä»¶çš„æ ·å­ï¼ˆ<code>Android.*</code> æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œ1.3èŠ‚å°±è¦è®²åˆ°ã€‚<code>default/</code> çš„å«ä¹‰å’Œä½œç”¨ç•™å¾…ç¬¬2ç« è¿›è¡Œä»‹ç»ï¼‰ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200717231917282.png"><h3 id="1-3-ç”Ÿæˆ-Makefile"><a href="#1-3-ç”Ÿæˆ-Makefile" class="headerlink" title="1.3 ç”Ÿæˆ Makefile"></a>1.3 ç”Ÿæˆ Makefile</h3><p>ç¼–å†™å¥½æ¥å£æè¿°æ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œè„šæœ¬ <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/update-makefiles.sh</code> ä¸ºæ¥å£æè¿°æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ 2 ä¸ª Makefile â€”â€” <code>Android.bp</code> å’Œ <code>Android.mk</code>ã€‚</p><p>æœ‰äº†è¿™ 2 ä¸ª Makefileï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå°±å¯ä»¥è‡ªåŠ¨ä»æ¥å£æè¿°æ–‡ä»¶ç”Ÿæˆ Binder æ¡†æ¶çš„æºæ–‡ä»¶ã€å¤´æ–‡ä»¶ä»¥å’Œå¯¹åº”çš„åº“ï¼Œè€Œæ— éœ€æˆ‘ä»¬æ‰‹åŠ¨æ•²ä¸€éï¼Œååˆ†æ–¹ä¾¿ã€‚</p><h2 id="2-å®ç°-HAL-ä¸»ä½“"><a href="#2-å®ç°-HAL-ä¸»ä½“" class="headerlink" title="2.å®ç° HAL ä¸»ä½“"></a>2.å®ç° HAL ä¸»ä½“</h2><h3 id="2-1-é…ç½®HAL"><a href="#2-1-é…ç½®HAL" class="headerlink" title="2.1 é…ç½®HAL"></a>2.1 é…ç½®HAL</h3><p>å› ä¸ºä¸åŒçš„äº§å“å¯èƒ½ä½¿ç”¨ä¸åŒçš„å¤–è®¾ï¼Œæ‰€ä»¥æ¯ä¸ªäº§å“éƒ½æœ‰è‡ªå·±çš„èµ„æºæ¸…å• <code>manifest.xml</code>ï¼Œä½äºç›®å½• <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/</code> ä¸‹ã€‚æ¸…å•ä¸­ä¼šåˆ—å‡ºè¯¥æ¬¾äº§å“æ”¯æŒçš„æ‰€æœ‰å¤–è®¾ã€æœåŠ¡å’Œå®ƒä»¬çš„ HAL ç±»å‹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿåº”è¯¥æŠŠæ­£åœ¨åˆ›å»ºçš„ demoComponent HAL æ·»åŠ è¿›è¿™ä¸ªæ¸…å•é‡Œã€‚ä»¥æˆ‘ç”¨çš„ Intel å¹³å°ä¸ºä¾‹ï¼Œäº§å“ä»£å·å°±ä¸è¯´äº†ï¼Œ<code>manifest.xml</code> ä½äº <code>/device/harman/broxton/XXXX/</code> ç›®å½•ä¸‹ã€‚æ·»åŠ å®Œæˆåçœ‹èµ·æ¥ç±»ä¼¼ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;device&quot;</span>&gt;</span><br><br>    ......<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">hal</span> <span class="hljs-attr">format</span>=<span class="hljs-string">&quot;hidl&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>vendor.harman.hardware.demoComponent.demoService<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">transport</span>&gt;</span>hwbinder<span class="hljs-tag">&lt;/<span class="hljs-name">transport</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>IDemoServiceDef<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">instance</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">instance</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">hal</span>&gt;</span><br><br>    ......<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sepolicy</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>27.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sepolicy</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&lt;hal format=&quot;hidl&quot;&gt;</code> è¡¨ç¤º HAL ä½¿ç”¨ HIDL æè¿°ï¼› <code>&lt;name&gt;</code> çš„å€¼å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯æ¥å£æè¿°æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼Œä½†ä¸­é—´å°‘äº†ä¸ª <strong>â€œ.interfacesâ€</strong> ï¼›<code>&lt;transport&gt;</code> è¡¨ç¤º HAL å®ç°æ‰€ä¾èµ–çš„ binder ç±»å‹ï¼›<code>&lt;version&gt;</code> è¡¨ç¤º HAL ç‰ˆæœ¬ï¼Œå›å¿†ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™æ¥å£æè¿°æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶å­˜æ”¾è·¯å¾„é‡Œä¹Ÿæœ‰ä¸ª HAL ç‰ˆæœ¬å·ï¼Œè¿™ä¸¤ä¸ªç‰ˆæœ¬å·è¦ä¸€è‡´ï¼› <code>&lt;interface&gt;</code> èŠ‚ç‚¹ç”¨æ¥æ ‡æ˜ HAL æ¥å£ï¼Œä¸‹å±çš„<code> &lt;name&gt;</code> æŒ‡å®šäº† HAL çš„æ¥å£æè¿°æ–‡ä»¶ä¸º <code>IDemoServiceDef.hal</code>ï¼Œ <code>&lt;instance&gt;</code> æŒ‡å®šäº† HAL çš„å®ç°ä½äº <code>default/</code> ç›®å½•ä¸‹ã€‚</p><p>default&#x2F; <strong>ç›®å½•éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»ºï¼Œä½äº</strong> <code>/vendor/&lt;CompanyName&gt;/hardware/interfaces/&lt;ComponentName&gt;/&lt;SubComponentName&gt;/&lt;VersionCode&gt;/</code>ã€‚ è¿˜æ˜¯ä»¥æˆ‘ç”¨çš„å¹³å°ä¸ºä¾‹ï¼Œå®Œæ•´è·¯å¾„ä¸º <code>/vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/default</code>ã€‚</p><h3 id="2-2-å®ç°HALä¸»ä½“"><a href="#2-2-å®ç°HALä¸»ä½“" class="headerlink" title="2.2 å®ç°HALä¸»ä½“"></a>2.2 å®ç°HALä¸»ä½“</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç° demoComponent HAL çš„ä¸»ä½“ã€‚ å› ä¸º <strong>Binder åŒ–åçš„ HAL æ˜¯ä»¥æœåŠ¡è¿›ç¨‹çš„å½¢å¼è¿è¡Œåœ¨ Android native å±‚</strong>çš„ï¼Œæ‰€ä»¥æˆ‘ç»™è¿™ä¸ªä¸»ä½“å–åä¸º demoServiceã€‚åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»º <code>DemoServiceImpl.h</code> å’Œ<code>DemoServiceImpl.cpp</code>ã€‚</p><p>è¿™ä¹‹åè¦åšçš„äº‹å¤§å®¶å°±å¾ˆç†Ÿæ‚‰äº† â€”â€” åœ¨ <code>DemoServiceImpl.h</code> é‡Œå¼•ç”¨å¿…è¦çš„å¤´æ–‡ä»¶ã€å£°æ˜ç±»å’Œæ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hardware/hardware.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IServiceManager.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IPCThreadState.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoServiceDef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoServiceImpl</span> : <span class="hljs-keyword">public</span> IDemoServiceDef &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">DemoServiceImpl</span>();<br>    ~<span class="hljs-built_in">DemoServiceImpl</span>() &#123;&#125;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> <span class="hljs-keyword">override</span></span>;<br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> <span class="hljs-keyword">override</span></span>;<br><br><br><span class="hljs-keyword">private</span>:<br>    android::sp&lt;IDemoCallback&gt; callback = <span class="hljs-literal">nullptr</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong><code>DemoServiceImpl</code> ç±»ç»§æ‰¿è‡ª <code>IDemoServiceDef</code> ç±»ï¼Œå¹¶å¯¹æ¥å£è¿›è¡Œè¦†å†™ï¼ŒåŒæ—¶å£°æ˜äº†ä¸€ä¸ª <code>IDemoCallback</code> æŒ‡é’ˆç”¨æ¥ä¿å­˜å›è°ƒå‡½æ•°ã€‚</strong></p><p>å¤§å®¶å¯èƒ½ä¼šå›°æƒ‘<strong>IDemoServiceDef</strong> ç±»å’Œæ¥å£å£°æ˜æ˜¯å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡åå­—æ¨æµ‹å®ƒæ˜¯ç”± <strong>IDemoServiceDef.hal</strong> ç”Ÿæˆçš„ã€‚å®é™…ä¸Šå’Œæ¨æµ‹ä¸€æ ·ï¼Œç¼–è¯‘é˜¶æ®µè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ä¼šè¢«æ”¾åœ¨ <code>/out/soong/.intermediates/vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/</code> ç›®å½•ï¼Œå¤´æ–‡ä»¶å’Œæºæ–‡ä»¶å¯ä»¥åˆ†åˆ«åœ¨ <code>vendor.harman.hardware.demoComponent.demoService@1.0_genc++_headers</code> å’Œ <code>vendor.harman.hardware.demoComponent.demoService@1.0_genc++ </code>ä¸­æ‰¾åˆ°ã€‚ <strong>åœ¨ <code>DemoServiceImpl.h</code> é‡Œéœ€è¦ <code>#include</code> å¼•ç”¨è¿™äº›è‡ªåŠ¨ç”Ÿæˆçš„å¤´æ–‡ä»¶ã€‚</strong></p><p>ä¸‹æ–¹å±•ç¤ºçš„æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å¤´æ–‡ä»¶ <code>IDemoServiceDef.h</code> çš„éƒ¨åˆ†ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hidl/base/1.0/IBase.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/hidl/manager/1.0/IServiceNotification.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/HidlSupport.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/MQDescriptor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/Status.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/NativeHandle.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/misc.h&gt;</span></span><br><br><span class="hljs-keyword">namespace</span> vendor &#123;<br><span class="hljs-keyword">namespace</span> harman &#123;<br><span class="hljs-keyword">namespace</span> hardware &#123;<br><span class="hljs-keyword">namespace</span> demoComponent &#123;<br><span class="hljs-keyword">namespace</span> demoService &#123;<br><span class="hljs-keyword">namespace</span> V1_0 &#123;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IDemoServiceDef</span> : <span class="hljs-keyword">public</span> ::android::hidl::base::V1_0::IBase &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isRemote</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; &#125;<br><br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; data)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">virtual</span> ::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// ....çœç•¥</span><br>&#125;;<br><br><span class="hljs-function">std::string <span class="hljs-title">toString</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoServiceDef&gt;&amp;)</span></span>;<br><br>&#125;  <span class="hljs-comment">// namespace V1_0</span><br>&#125;  <span class="hljs-comment">// namespace demoService</span><br>&#125;  <span class="hljs-comment">// namespace demoComponent</span><br>&#125;  <span class="hljs-comment">// namespace hardware</span><br>&#125;  <span class="hljs-comment">// namespace harman</span><br>&#125;  <span class="hljs-comment">// namespace vendor</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>  <span class="hljs-comment">// HIDL_GENERATED_VENDOR_HARMAN_HARDWARE_DEMOCOMPONENT_DEMOSERVICE_V1_0_IDEMOSERVICEDEF_H</span></span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>DemoServiceImpl.cpp</code> ä¸­å®ç°å„æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceImpl.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br>DemoServiceImpl::<span class="hljs-built_in">DemoServiceImpl</span>() &#123;<br><br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl setStatus&quot;</span>);<br>    <span class="hljs-comment">// çœç•¥è®¾ç½®çŠ¶æ€çš„ä»£ç </span><br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService invokes callback&quot;</span>);<br>    <span class="hljs-comment">// åœ¨æœ€åæ‰§è¡Œå›è°ƒå‡½æ•°å‘é€é€šçŸ¥</span><br>    callback-&gt;<span class="hljs-built_in">onCallbackEvent</span>(sta);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl registerCallback&quot;</span>);<br>    <span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°</span><br>    callback = cb;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function saved&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>::android::<span class="hljs-function">hardware::Return&lt;<span class="hljs-type">int32_t</span>&gt; <span class="hljs-title">DemoServiceImpl::unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoServiceImpl unregisterCallback&quot;</span>);<br>    <span class="hljs-keyword">if</span> (callback == cb) &#123;<br>        <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function cleared.&quot;</span>);<br>        <span class="hljs-comment">// æ¸…ç©ºå›è°ƒå‡½æ•°</span><br>        callback = <span class="hljs-literal">nullptr</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService callback function mismatch, uncleared.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ 3 ä¸ªæ¥å£çš„å®ç°å†™å¾—å¾ˆç®€å•ï¼Œç›´æ¥çœ‹ä»£ç æ³¨é‡Šå°±å¯ä»¥ï¼Œæ— éœ€èµ˜è¨€ã€‚</p><h3 id="2-3-å°†-HAL-æ³¨å†Œä¸º-Binder-æœåŠ¡"><a href="#2-3-å°†-HAL-æ³¨å†Œä¸º-Binder-æœåŠ¡" class="headerlink" title="2.3 å°† HAL æ³¨å†Œä¸º Binder æœåŠ¡"></a>2.3 å°† HAL æ³¨å†Œä¸º Binder æœåŠ¡</h3><p><strong>å› ä¸º Binder åŒ–çš„ HAL ä»¥ç‹¬ç«‹æœ¬åœ°è¿›ç¨‹çš„å½¢å¼è¿è¡Œ</strong>ï¼Œ<strong>æ‰€ä»¥å¿…å®šéœ€è¦ main() å‡½æ•°ä½œä¸ºè¿›ç¨‹å¯åŠ¨å…¥å£</strong>ã€‚æˆ‘ä»¬å½“ç„¶å¯ä»¥æŠŠ main() å†™åœ¨ DemoServiceImpl.cpp ä¸­ï¼Œä½†ä¸ºäº†ä¸æ¥å£å®ç°è¿›è¡ŒåŒºåˆ†ï¼Œæˆ‘åœ¨<code>default/ </code>ç›®å½•ä¸‹æ–°å»ºæºæ–‡ä»¶ <code>DemoService.cpp</code>ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å®ç°ä¸”ä»…å®ç° main() å‡½æ•°ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;android/log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/ProcessState.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hidl/LegacySupport.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceImpl.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-comment">/* argc */</span>, <span class="hljs-type">char</span>* <span class="hljs-comment">/* argv */</span> [])</span> </span>&#123;<br>    android::ProcessState::<span class="hljs-built_in">initWithDriver</span>(<span class="hljs-string">&quot;/dev/hwbinder&quot;</span>);  <span class="hljs-comment">// åˆå§‹åŒ– Binder é©±åŠ¨</span><br>    <span class="hljs-keyword">auto</span> service = std::<span class="hljs-built_in">make_unique</span>&lt;DemoServiceImpl&gt;();      <span class="hljs-comment">// æ„é€  DemoServiceImpl å®ä¾‹</span><br>    android::hardware::<span class="hljs-built_in">configureRpcThreadpool</span>(<span class="hljs-number">4</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* callerWillJoin */</span>);<br>    <span class="hljs-built_in">ALOGI</span>(<span class="hljs-string">&quot;DemoService registerAsService&quot;</span>);<br>    android::<span class="hljs-type">status_t</span> status = service-&gt;<span class="hljs-built_in">registerAsService</span>();  <span class="hljs-comment">// æ³¨å†Œä¸º Binder æœåŠ¡</span><br>    <span class="hljs-keyword">if</span> (status != android::OK) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Unable to register DemoService (%d)&quot;</span>, status);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    android::hardware::<span class="hljs-built_in">joinRpcThreadpool</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åœ¨ <strong>main()</strong> å‡½æ•°ä¸­ä¸»è¦å¹²äº†äº›äº‹ï¼šä½¿ç”¨è®¾å¤‡èŠ‚ç‚¹ <code>/dev/hwbinder</code> åˆå§‹åŒ– Binder é©±åŠ¨ï¼Œå¹¶ä»¥å•ä¾‹ï¼ˆSingletonï¼‰çš„æ–¹å¼å°† <code>DemoServiceImpl</code> ç±»çš„ä¸€ä¸ªå®ä¾‹æ³¨å†Œä¸º Binder æœåŠ¡ã€‚</p><p><strong>å¦‚æœä½ å¸Œæœ› HAL è¿›ç¨‹ä¹Ÿèƒ½ä¸å…¶å®ƒæœ¬åœ°è¿›ç¨‹äº¤äº’ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ–é©±åŠ¨çš„æ—¶å€™åº”è¯¥ä½¿ç”¨</strong> <code>/dev/vndbinder</code>ã€‚</p><h2 id="3-å®ç°-Bpã€Bn-ç«¯"><a href="#3-å®ç°-Bpã€Bn-ç«¯" class="headerlink" title="3.å®ç° Bpã€Bn ç«¯"></a>3.å®ç° Bpã€Bn ç«¯</h2><p><strong>ã€å‰è¨€ã€‘</strong></p><p>æ—¢ç„¶ Binder åŒ–çš„ HAL ä¾èµ–äº Binder æœºåˆ¶è¿›è¡Œå®ç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å¿…é¡»æŒ‰ç…§ Binder æ¡†æ¶ï¼Œç›¸åº”ç¼–å†™ <strong>demoComponent HAL</strong> çš„ <strong>Bp</strong> ç«¯å’Œ <strong>Bn</strong> ç«¯ã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½æ‰“é€šå®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨åˆ°æœåŠ¡ç«¯è¿›ç¨‹ â€”â€” æˆ‘ä»¬çš„ demoService â€”â€” çš„é€šè·¯ã€‚</p><h3 id="3-1-å®šä¹‰demoServiceæ¥å£ç±»"><a href="#3-1-å®šä¹‰demoServiceæ¥å£ç±»" class="headerlink" title="3.1 å®šä¹‰demoServiceæ¥å£ç±»"></a>3.1 å®šä¹‰demoServiceæ¥å£ç±»</h3><p>è¦å°† demoService æ¥å…¥ Binderï¼Œå°±å¿…é¡»å®šä¹‰ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„æ¥å£ç±»ï¼Œç»§æ‰¿ Binder çš„æ¥å£åŸºç±» <code>IInterface</code>ï¼Œå¹¶å®ç°æ‰€æœ‰ Binder é€šä¿¡è¿‡ç¨‹ä¸­è¦ç”¨åˆ°çš„æ–¹æ³•ã€‚ä¸è¿‡æˆ‘ä»¬å¹¶ä¸éœ€è¦äº‹æ— å·¨ç»†åœ°å®Œæˆè¿™é¡¹ç¹æ‚çš„å·¥ä½œï¼Œå› ä¸º Binder æ¡†æ¶æä¾›äº†æ•°ä¸ªæ¨¡æ¿ç±»å’Œå®ï¼Œå¤§å¤§æ–¹ä¾¿äº†æˆ‘ä»¬å®ç°ã€‚</p><p>è¿˜è®°å¾—åœ¨ä¸Šä¸€èŠ‚ã€Šå®ç° HAL ä¸»ä½“ã€‹é‡Œæˆ‘ä»¬åˆ›å»ºäº† <code>default/</code> ç›®å½•ã€‚åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå¤´æ–‡ä»¶ <code>DemoServiceBinderInterface.h</code>ï¼Œå¹¶åœ¨è¿™ä¸ªå¤´æ–‡ä»¶é‡Œå®šä¹‰æ¥å£ç±» <code>IDemoService</code>ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IInterface.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vendor/harman/hardware/demoComponent/demoService/1.0/IDemoCallback.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEMOSERVICE_NAME <span class="hljs-string">&quot;com.qidi.demoService&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::IDemoCallback;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::DemoData;<br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-comment">// command codes for binder transactions</span><br>    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">eDemoServiceTransactionID</span><br>    &#123;<br>        SET_STATUS = android::IBinder::FIRST_CALL_TRANSACTION,<br>        REGISTER_CALLBACK,<br>        UNREGISTER_CALLBACK<br>    &#125;;<br><br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">IDemoService</span>: <span class="hljs-keyword">public</span> IInterface &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-built_in">DECLARE_META_INTERFACE</span>(DemoService);<br><br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>= <span class="hljs-number">0</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>= <span class="hljs-number">0</span>;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤äº†å®šä¹‰ç±» <code>IDemoService</code>ï¼Œæˆ‘ä»¬è¿˜åœ¨å¤´æ–‡ä»¶ <code>DemoServiceBinderInterface.h</code> é‡Œä»¥<strong>æšä¸¾æ•°æ®çš„å½¢å¼</strong>å®šä¹‰äº†å’Œ demoService Binder è°ƒç”¨ç›¸å…³çš„ Command codeã€‚ ä¸‰ä¸ª Command code <code>SET_STATUS</code>ã€<code>REGISTER_CALLBACK</code> å’Œ <code>UNREGISTER_CALLBACK</code> åˆ†åˆ«å¯¹åº” demoService çš„ä¸‰ä¸ªæ¥å£ã€‚<strong>ç¬¬ä¸€ä¸ª Command code å¿…é¡»èµ‹å€¼ä¸º</strong> <code>android::IBinder::FIRST_CALL_TRANSACTION</code>ã€‚</p><p>å® <code>DECLARE_META_INTERFACE()</code> ä¸»è¦ç”¨æ¥å£°æ˜ç”¨äº Binder é€šä¿¡çš„æˆå‘˜å˜é‡ <code>descriptor</code> å’Œé€šç”¨æ¥å£ <code>asInterface()</code> ã€ <code>getInterfaceDescriptor()</code>ã€‚ ç›¸å…³ä»£ç ä½äº <code>IInterface.h</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DECLARE_META_INTERFACE(INTERFACE)                               \</span><br><span class="hljs-meta">    static const ::android::String16 descriptor;                        \</span><br><span class="hljs-meta">    static ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> asInterface(                     \</span><br><span class="hljs-meta">            const ::android::sp<span class="hljs-string">&lt;::android::IBinder&gt;</span>&amp; obj);              \</span><br><span class="hljs-meta">    virtual const ::android::String16&amp; getInterfaceDescriptor() const;  \</span><br><span class="hljs-meta">    I##INTERFACE();                                                     \</span><br><span class="hljs-meta">    virtual ~I##INTERFACE();                                            \</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒdemoService çš„æ¥å£ç±»å°±å®šä¹‰å¥½äº†ã€‚</p><h3 id="3-2-å£°æ˜-Bpã€Bn-ç«¯"><a href="#3-2-å£°æ˜-Bpã€Bn-ç«¯" class="headerlink" title="3.2 å£°æ˜ Bpã€Bn ç«¯"></a>3.2 å£°æ˜ Bpã€Bn ç«¯</h3><p>æœ‰äº†æ¥å£ç±»ä¹‹åï¼Œå°±å¯ä»¥æ­£å¼ç€æ‰‹ Bpã€Bn ç«¯çš„å·¥ä½œäº†ã€‚ä¾ç…§å…ˆå£°æ˜åå®ç°çš„é¡ºåºï¼Œæˆ‘ä»¬ç»§ç»­åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºå¤´æ–‡ä»¶ <code>BpDemoService.h</code> å’Œ <code>BnDemoService.h</code>ã€‚<strong>Binder æ¡†æ¶æä¾›äº†æ¨¡æ¿ç±»<code>BpInterface&lt;&gt;</code>å’Œ <code>BnInterface&lt;&gt;</code> æ¥ç®€åŒ–è¿™ä¸€è¿‡ç¨‹</strong>ã€‚</p><ul><li><strong><code>BpDemoService.h</code> ä»£ç å¦‚ä¸‹ï¼š</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">BpDemoService</span>: <span class="hljs-keyword">public</span> BpInterface&lt;android::IDemoService&gt; &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-built_in">BpDemoService</span>(<span class="hljs-type">const</span> sp&lt;IBinder&gt;&amp; impl);<br><br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span></span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span></span>;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int32_t</span> <span class="hljs-title">unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span></span>;<br>    &#125;;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Bp ç«¯å¤´æ–‡ä»¶ä¸­å°† <code>IDemoService</code> ä½œä¸ºå‚æ•°ä¼ å…¥ <code>BpInterface&lt;&gt;</code> æ¨¡æ¿ï¼Œæ‰€ä»¥éœ€è¦å¼•ç”¨ <code>DemoServiceBinderInterface.h</code>ã€‚ç”±äºæ¨¡æ¿ç±»çš„è®¾è®¡ï¼Œæ–‡ä»¶ä¸­å£°æ˜çš„ demoService çš„ 3 ä¸ªæ¥å£å°†è¢«æ•´åˆåˆ° Binder æ¡†æ¶ä»£ç ä¸­ã€‚æˆ‘ä»¬å³ä¾¿ä¸å»å…³æ³¨å…¶ä¸­çš„ç»†èŠ‚ä¹Ÿæ²¡å…³ç³»ï¼Œåªè¦è´Ÿè´£å¡«å…¥æ¥å£ç±»å’Œæ¥å£å£°æ˜ï¼Œå‰©ä¸‹çš„äº¤ç»™ Binder æ¡†æ¶å°±å¥½ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å……æ»¡å¥½å¥‡ä¸”æ—¶é—´å……è£•ï¼Œä¹Ÿå¯ä»¥ä¸€å¤´æ‰è¿›å»ç†ä¸€ç†æ€è·¯ã€‚ <code>BpInterface&lt;&gt;</code> æ¨¡æ¿ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> INTERFACE&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BpInterface</span> : <span class="hljs-keyword">public</span> INTERFACE, <span class="hljs-keyword">public</span> BpRefBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span>                    <span class="hljs-title">BpInterface</span><span class="hljs-params">(<span class="hljs-type">const</span> sp&lt;IBinder&gt;&amp; remote)</span></span>;<br><br><span class="hljs-keyword">protected</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> IBinder*            <span class="hljs-title">onAsBinder</span><span class="hljs-params">()</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong><code>BnDemoService.h</code> ä»£ç å¦‚ä¸‹ï¼š</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-keyword">namespace</span> android &#123;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">BnDemoService</span>: <span class="hljs-keyword">public</span> BnInterface&lt;IDemoService&gt; &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">onTransact</span><span class="hljs-params">( <span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel&amp; data,</span></span><br><span class="hljs-params"><span class="hljs-function">                Parcel* reply, <span class="hljs-type">uint32_t</span> flags = <span class="hljs-number">0</span>)</span></span>;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Bn ç«¯å¤´æ–‡ä»¶çš„å†…å®¹ä¸ Bp ç«¯ç±»ä¼¼ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œç”±äº Binder æ¡†æ¶çš„è®¾è®¡åŸå› ï¼Œè¿™é‡Œçš„æ–¹æ³•å <code>onTransact()</code> åŠå‚æ•°éƒ½æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬ä¸èƒ½å†™æˆå…¶å®ƒå½¢å¼ã€‚</strong> <code>BnInterface&lt;&gt;</code> æ¨¡æ¿ç±»åœ¨ <code>IInterface.h</code> ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> INTERFACE&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BnInterface</span> : <span class="hljs-keyword">public</span> INTERFACE, <span class="hljs-keyword">public</span> BBinder<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> sp&lt;IInterface&gt;      <span class="hljs-title">queryLocalInterface</span><span class="hljs-params">(<span class="hljs-type">const</span> String16&amp; _descriptor)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">const</span> String16&amp;     <span class="hljs-title">getInterfaceDescriptor</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br><span class="hljs-keyword">protected</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> IBinder*            <span class="hljs-title">onAsBinder</span><span class="hljs-params">()</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3-3-å®ç°-Bpã€Bn-ç«¯"><a href="#3-3-å®ç°-Bpã€Bn-ç«¯" class="headerlink" title="3.3 å®ç° Bpã€Bn ç«¯"></a>3.3 å®ç° Bpã€Bn ç«¯</h3><p>å£°æ˜ä¹‹åï¼Œè¯¥è¿›è¡Œå®ç°äº†ã€‚ç»§ç»­åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºæºæ–‡ä»¶ <code>BpDemoService.cpp</code> å’Œ <code>BnDemoService.cpp</code>ã€‚</p><p>å®ç°è¿‡ç¨‹åªæ˜¯é¡ºæ°´æ¨èˆŸè€Œå·²ï¼Œç›´æ¥çœ‹ä»£ç å§ã€‚</p><ul><li><strong>BpDemoService.cpp:</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/IServiceManager.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/Parcel.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BpDemoService.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_D ALOGD</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_E ALOGE</span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::setStatus</span><span class="hljs-params">(<span class="hljs-type">const</span> DemoData&amp; sta)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;sta, <span class="hljs-built_in">sizeof</span>(DemoData));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(SET_STATUS, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status != NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::setStatus transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::registerCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;cb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(REGISTER_CALLBACK, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status != NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::registerCallback transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">BpDemoService::unregisterCallback</span><span class="hljs-params">(<span class="hljs-type">const</span> ::android::sp&lt;IDemoCallback&gt;&amp; cb)</span> </span>&#123;<br>    Parcel data, reply;<br><br>    data.<span class="hljs-built_in">writeInterfaceToken</span>(IDemoService::<span class="hljs-built_in">getInterfaceDescriptor</span>());<br>    data.<span class="hljs-built_in">write</span>(&amp;cb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br><br>    <span class="hljs-type">status_t</span> status = <span class="hljs-built_in">remote</span>()-&gt;<span class="hljs-built_in">transact</span>(UNREGISTER_CALLBACK, data, &amp;reply);<br>    <span class="hljs-keyword">if</span> (status == NO_ERROR) &#123;<br>        <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BpDemoService::unregisterCallback transact failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> reply.<span class="hljs-built_in">readInt32</span>();<br>&#125;<br><br>BpDemoService::<span class="hljs-built_in">BpDemoService</span>(<span class="hljs-type">const</span> sp&lt;IBinder&gt; &amp;impl) : <span class="hljs-built_in">BpInterface</span>&lt;IDemoService&gt;(impl) &#123;&#125;<br><span class="hljs-built_in">IMPLEMENT_META_INTERFACE</span>(DemoService, DEMOSERVICE_NAME);<br><br></code></pre></td></tr></table></figure><p>Bp ç«¯çš„æºæ–‡ä»¶é‡Œä½¿ç”¨äº†å® <code>IMPLEMENT_META_INTERFACE()</code>ï¼Œæ‰©å±•ä¹‹åå³æ˜¯å® <code>DECLARE_META_INTERFACE()</code> æ‰€å£°æ˜çš„æ¥å£çš„å®ç°ã€‚</p><p>è¿™ä¸ªå®åŒæ ·å®šä¹‰åœ¨ <code>IInterface.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span><br><span class="hljs-meta">    const ::android::String16 I##INTERFACE::descriptor(NAME);           \</span><br><span class="hljs-meta">    const ::android::String16&amp;                                          \</span><br><span class="hljs-meta">            I##INTERFACE::getInterfaceDescriptor() const &#123;              \</span><br><span class="hljs-meta">        return I##INTERFACE::descriptor;                                \</span><br><span class="hljs-meta">    &#125;                                                                   \</span><br><span class="hljs-meta">    ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> I##INTERFACE::asInterface(              \</span><br><span class="hljs-meta">            const ::android::sp<span class="hljs-string">&lt;::android::IBinder&gt;</span>&amp; obj)               \</span><br><span class="hljs-meta">    &#123;                                                                   \</span><br><span class="hljs-meta">        ::android::sp<span class="hljs-string">&lt;I##INTERFACE&gt;</span> intr;                               \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (obj != NULL) &#123;                                              \</span><br><span class="hljs-meta">            intr = static_cast<span class="hljs-string">&lt;I##INTERFACE*&gt;</span>(                          \</span><br><span class="hljs-meta">                obj-&gt;queryLocalInterface(                               \</span><br><span class="hljs-meta">                        I##INTERFACE::descriptor).get());               \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (intr == NULL) &#123;                                         \</span><br><span class="hljs-meta">                intr = new Bp##INTERFACE(obj);                          \</span><br><span class="hljs-meta">            &#125;                                                           \</span><br><span class="hljs-meta">        &#125;                                                               \</span><br><span class="hljs-meta">        return intr;                                                    \</span><br><span class="hljs-meta">    &#125;                                                                   \</span><br><span class="hljs-meta">    I##INTERFACE::I##INTERFACE() &#123; &#125;                                    \</span><br><span class="hljs-meta">    I##INTERFACE::~I##INTERFACE() &#123; &#125;                                   \</span><br></code></pre></td></tr></table></figure><ul><li><strong>BnDemoService.cpp:</strong></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/Errors.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;binder/Parcel.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;BnDemoService.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;DemoServiceBinderInterface.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_D ALOGD</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_E ALOGE</span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> android;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> vendor::harman::hardware::demoComponent::demoService::V1_0;<br><span class="hljs-keyword">using</span> ::vendor::harman::hardware::demoComponent::demoService::V1_0::DemoData;<br><br><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">BnDemoService::onTransact</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel &amp;data, Parcel *reply, <span class="hljs-type">uint32_t</span> flags)</span> </span>&#123;<br>    <span class="hljs-type">status_t</span> retCode = NO_ERROR;<br>    <span class="hljs-keyword">switch</span> (code) &#123;<br>        <span class="hljs-keyword">case</span> SET_STATUS:&#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService SET_STATUS()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            DemoData sta;<br>            data.<span class="hljs-built_in">read</span>(&amp;sta, <span class="hljs-built_in">sizeof</span>(DemoData));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">setStatus</span>(sta));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> REGISTER_CALLBACK:&#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService REGISTER_CALLBACK()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            ::android::sp&lt;IDemoCallback&gt; rcb;<br>            data.<span class="hljs-built_in">read</span>(&amp;rcb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">registerCallback</span>(rcb));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> UNREGISTER_CALLBACK: &#123;<br>            <span class="hljs-built_in">LOG_D</span>(<span class="hljs-string">&quot;BnDemoService UNREGISTER_CALLBACK()&quot;</span>);<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(IDemoService, data, reply);<br>            sp&lt;IDemoCallback&gt; urcb;<br>            data.<span class="hljs-built_in">read</span>(&amp;urcb, <span class="hljs-built_in">sizeof</span>(::android::sp&lt;IDemoCallback&gt;));<br>            reply-&gt;<span class="hljs-built_in">writeInt32</span>(<span class="hljs-built_in">unregisterCallback</span>(urcb));<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>: &#123;<br>            <span class="hljs-built_in">LOG_E</span>(<span class="hljs-string">&quot;BnDemoService::onTransact(0x%x,0x%x)&quot;</span>, code, flags);<br>            retCode = BBinder::<span class="hljs-built_in">onTransact</span>(code, data, reply, flags);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> retCode;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Bn ç«¯çš„æºæ–‡ä»¶é‡Œå¯¹ <code>onTransact()</code> è¿›è¡Œå®ç°ï¼Œä½¿ç”¨ <code>switch...case...</code> å¯¹ Command code è¿›è¡Œå¤„ç†ã€‚<strong>åœ¨æ¯ä¸ª case çš„æœ«å°¾å¯ä»¥çœ‹åˆ°å¯¹ demoService é‡Œå„ä¸ªæ–¹æ³•çš„è°ƒç”¨</strong>ï¼Œå¹¶å°†è°ƒç”¨çš„è¿”å›å€¼å†™å…¥ replyã€‚</p><h2 id="4-ç¼–è¯‘ä¸æ‰“åŒ…"><a href="#4-ç¼–è¯‘ä¸æ‰“åŒ…" class="headerlink" title="4.ç¼–è¯‘ä¸æ‰“åŒ…"></a>4.ç¼–è¯‘ä¸æ‰“åŒ…</h2><h3 id="4-1-ç¼–å†™Makefile"><a href="#4-1-ç¼–å†™Makefile" class="headerlink" title="4.1 ç¼–å†™Makefile"></a>4.1 ç¼–å†™Makefile</h3><p><strong>è¿™é‡Œè¯´çš„ Makefile æ˜¯æŒ‡ <code>Android.bp</code>ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>Android.mk</code>ï¼Œè¯­æ³•ç¨æœ‰åŒºåˆ«ï¼‰</strong>ã€‚</p><p>åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ <code>Android.bp</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp">cc_defaults &#123;<br>    name: <span class="hljs-string">&quot;demoSvc_v1_0_default&quot;</span>,<br>    shared_libs: [<br>        <span class="hljs-string">&quot;libhidlbase&quot;</span>,<br>        <span class="hljs-string">&quot;libhidltransport&quot;</span>,<br>        <span class="hljs-string">&quot;liblog&quot;</span>,<br>        <span class="hljs-string">&quot;libutils&quot;</span>,<br>        <span class="hljs-string">&quot;libhardware&quot;</span>,<br>        <span class="hljs-string">&quot;libbinder&quot;</span>,<br>        <span class="hljs-string">&quot;vendor.harman.hardware.demoComponent.demoService@1.0_vendor&quot;</span>,<br>    ],<br>    cflags: [<br>        <span class="hljs-string">&quot;-Wall&quot;</span>,<br>        <span class="hljs-string">&quot;-Wextra&quot;</span>,<br>        <span class="hljs-string">&quot;-Werror&quot;</span>,<br>    ],<br>&#125;<br><br>cc_binary &#123;<br>    name: <span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service&quot;</span>,<br>    defaults: [<span class="hljs-string">&quot;demoSvc_v1_0_default&quot;</span>],<br>    init_rc: [<span class="hljs-string">&quot;vendor.harman.demoComponent.demoService@1.0-service.rc&quot;</span>],<br>    vendor: <span class="hljs-literal">true</span>,<br>    relative_install_path: <span class="hljs-string">&quot;hw&quot;</span>,<br><br>    include_dirs:[<span class="hljs-string">&quot;vendor/harman/hardware/interfaces/demoComponent/demoService/1.0/default&quot;</span>],<br>    srcs: [<br>        <span class="hljs-string">&quot;DemoService.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;DemoServiceImpl.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;BpDemoService.cpp&quot;</span>,<br>        <span class="hljs-string">&quot;BnDemoService.cpp&quot;</span><br>    ],<br>    shared_libs: [<br>        <span class="hljs-string">&quot;libbase&quot;</span>,<br>        <span class="hljs-string">&quot;libprotobuf-cpp-lite&quot;</span>,<br>        <span class="hljs-string">&quot;vendor.harman.hardware.demoComponent.demoService@1.0_vendor&quot;</span><br>    ],<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>ç›®æ ‡ demoSvc_v1_0_default å¯ä»¥ç†è§£æˆæ˜¯å°†å’Œ Binder æ¡†æ¶ç›¸å…³çš„åº“æ‰“åŒ…è€Œæˆçš„ä¸€ä¸ªæ€»çš„åº“æ–‡ä»¶ï¼Œ<a href="mailto:&#118;&#101;&#110;&#x64;&#x6f;&#114;&#46;&#104;&#97;&#114;&#x6d;&#97;&#x6e;&#x2e;&#x68;&#97;&#114;&#x64;&#119;&#x61;&#x72;&#101;&#46;&#x64;&#x65;&#109;&#111;&#x43;&#x6f;&#x6d;&#112;&#x6f;&#110;&#x65;&#x6e;&#x74;&#x2e;&#x64;&#101;&#x6d;&#111;&#83;&#x65;&#114;&#x76;&#105;&#99;&#x65;&#64;&#49;&#46;&#x30;&#95;&#x76;&#101;&#110;&#x64;&#x6f;&#x72;">&#118;&#101;&#110;&#x64;&#x6f;&#114;&#46;&#104;&#97;&#114;&#x6d;&#97;&#x6e;&#x2e;&#x68;&#97;&#114;&#x64;&#119;&#x61;&#x72;&#101;&#46;&#x64;&#x65;&#109;&#111;&#x43;&#x6f;&#x6d;&#112;&#x6f;&#110;&#x65;&#x6e;&#x74;&#x2e;&#x64;&#101;&#x6d;&#111;&#83;&#x65;&#114;&#x76;&#105;&#99;&#x65;&#64;&#49;&#46;&#x30;&#95;&#x76;&#101;&#110;&#x64;&#x6f;&#x72;</a> æ˜¯é€šè¿‡æ¥å£æè¿°æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼ŒåŒæ ·å¯ä»¥åœ¨ &#x2F;out&#x2F;soong&#x2F;.intermediates&#x2F;â€¦ ç›®å½•ä¸‹æ‰¾åˆ°ï¼›</p></li><li><p>ç›®æ ‡ <a href="mailto:&#118;&#101;&#110;&#x64;&#111;&#x72;&#x2e;&#x68;&#x61;&#114;&#x6d;&#x61;&#110;&#46;&#100;&#101;&#x6d;&#x6f;&#x43;&#111;&#109;&#x70;&#x6f;&#x6e;&#x65;&#x6e;&#x74;&#x2e;&#100;&#x65;&#109;&#111;&#x53;&#101;&#x72;&#x76;&#105;&#99;&#x65;&#x40;&#49;&#x2e;&#48;&#45;&#x73;&#101;&#x72;&#118;&#105;&#99;&#x65;">&#118;&#101;&#110;&#x64;&#111;&#x72;&#x2e;&#x68;&#x61;&#114;&#x6d;&#x61;&#110;&#46;&#100;&#101;&#x6d;&#x6f;&#x43;&#111;&#109;&#x70;&#x6f;&#x6e;&#x65;&#x6e;&#x74;&#x2e;&#100;&#x65;&#109;&#111;&#x53;&#101;&#x72;&#x76;&#105;&#99;&#x65;&#x40;&#49;&#x2e;&#48;&#45;&#x73;&#101;&#x72;&#118;&#105;&#99;&#x65;</a> å°±æ˜¯æœ€ç»ˆè¦ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼›</p></li><li><p>å±æ€§ vendor: true è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ–‡ä»¶ï¼›</p></li><li><p>å±æ€§ relative_install_path: â€œhwâ€ å’Œå‰ä¸€ä¸ªå±æ€§å…±åŒä½œç”¨ï¼Œè¡¨ç¤ºç”Ÿæˆæ–‡ä»¶çš„ç›¸å¯¹å­˜æ”¾ä½ç½®åœ¨ <code>out/target/product/&lt;ProductName&gt;/vendor/bin/hw/ </code>ç›®å½•ï¼›</p></li><li><p>å±æ€§ srcs å±æ€§ä¸‹åŒ…å«äº†æˆ‘ä»¬åœ¨ä¹‹å‰å‡ ç¯‡æ–‡ç« é‡Œç¼–å†™çš„æ‰€æœ‰æºæ–‡ä»¶ â€”â€” DemoService.cppã€DemoServiceImpl.cppã€BpDemoService.cpp å’Œ BnDemoService.cppã€‚</p></li></ul><h3 id="4-2-ç¼–å†™HALå¯åŠ¨è„šæœ¬"><a href="#4-2-ç¼–å†™HALå¯åŠ¨è„šæœ¬" class="headerlink" title="4.2 ç¼–å†™HALå¯åŠ¨è„šæœ¬"></a>4.2 ç¼–å†™HALå¯åŠ¨è„šæœ¬</h3><p>åŸºäºä¸Šè¿°çš„ Makefile åœ¨ <code>default/</code> ç›®å½•ä¸‹<strong>æ‰‹åŠ¨ï¼ˆmm å‘½ä»¤ï¼‰</strong>è¿›è¡Œç¼–è¯‘ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°åä¸º <code>vendor.harman.demoComponent.demoService@1.0-service</code> çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¸ºäº†è®© demoComponent HAL éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ <code>*.rc</code> è„šæœ¬ï¼Œå¹¶åœ¨è„šæœ¬ä¸­æ ‡æ³¨è¿›ç¨‹åã€å¯æ‰§è¡Œæ–‡ä»¶ã€ç”¨æˆ·ç»„ç­‰ä¿¡æ¯ã€‚</p><p>ä¸€èˆ¬ä»¥å¯æ‰§è¡Œæ–‡ä»¶åä½œä¸ºè„šæœ¬åï¼Œä¹Ÿå°±æ˜¯ <code>vendor.harman.demoComponent.demoService@1.0-service.rc</code>ã€‚</p><p>åœ¨ <code>default/</code> ç›®å½•ä¸‹æ–°å»ºè„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">service MyDemoService /vendor/bin/hw/vendor.harman.demoComponent.demoService@1.0-service<br>    class main<br>    user system<br>    group system<br>    capabilities sys_nice net_bind_service net_admin net_raw<br></code></pre></td></tr></table></figure><ul><li><p>å…³é”®å­— service ç”¨æ¥å®šä¹‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆæˆ–ç§°ä¸ºæœ¬åœ°æœåŠ¡ï¼‰ï¼Œåé¢ç¬¬ä¸€ä¸ªå‚æ•° MyDemoService æ˜¯è¿›ç¨‹åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼›</p></li><li><p>class main è¡¨ç¤ºæŠŠ MyDemoService å½’å±åˆ° main ç±»ï¼›</p></li><li><p>user system å’Œ group system è¡¨ç¤º MyDemoService çš„ç”¨æˆ·å’Œç»„ç”¨æˆ·éƒ½æ˜¯ systemï¼›</p></li><li><p>capabilities æŒ‡å®šäº†ä¸€äº›æƒé™ç›¸å…³çš„å±æ€§ã€‚</p></li></ul><h3 id="4-3-æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ"><a href="#4-3-æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ" class="headerlink" title="4.3 æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ"></a>4.3 æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿé•œåƒ</h3><p>è¦å®ç° demoComponent HAL éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ï¼Œéœ€è¦å°†å®ƒçš„ <code>å¯æ‰§è¡Œæ–‡ä»¶</code> å’Œ <code>*.rc</code> æ–‡ä»¶éƒ½æ‰“åŒ…è¿›ç³»ç»Ÿé•œåƒã€‚é€šè¿‡ä¿®æ”¹äº§å“çš„ Makefile å¯ä»¥å®ç°è¿™ä¸€ç›®çš„ã€‚</p><p>å…ˆåœ¨ <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/common/</code> è·¯å¾„ä¸‹ä¸º demoComponent HAL æ–°å»ºä¸€ä¸ªåä¸º <code>demoComponent/</code> çš„ä¸“å±ç›®å½•ï¼Œå†åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºåä¸º <code>device_demoComponent.mk</code> çš„ Makefileã€‚ï¼ˆå…¶å®å«ä»€ä¹ˆåå­—éƒ½å¯ä»¥ï¼Œä½†æ˜¯ç”¨ demoComponent æ›´ç›´è§‚ï¼‰</p><p><strong>å¦‚æ­¤ä¸€æ¥æˆ‘ä»¬å°±æœ‰äº† <code>/device/harman/broxton/common/demoComponent/device_demoComponent.mk</code>ã€‚</strong> é™¤å»æ³¨é‡Šï¼ŒMakefile å†…å®¹åªæœ‰ä¸€å¥è¯ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">############################</span><br><span class="hljs-comment"># DemoService</span><br><span class="hljs-comment">############################</span><br><br>PRODUCT_PACKAGES += vendor.harman.demoComponent.demoService@1.0-service<br></code></pre></td></tr></table></figure><p>è¿™å¥è¯è¡¨ç¤ºè¦å°†å¯æ‰§è¡Œæ–‡ä»¶ <code>vendor.harman.demoComponent.demoService@1.0-service</code> æ‰“åŒ…è¿›ç³»ç»Ÿé•œåƒï¼Œç¡®åˆ‡åœ°è¯´æ˜¯æ‰“åŒ…è¿› <code>vendor.img</code>ã€‚</p><p>åˆ‡è®°ï¼Œä¸è¦å¿˜äº†æŠŠæˆ‘ä»¬æ–°å»ºçš„ Makefile æ·»åŠ åˆ°äº§å“çš„ Makefile ä¸­ã€‚ äº§å“ Makefile ä¸€èˆ¬ä½äº <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/device.mk</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>/device/harman/broxton/XXXX/device.mk</code> ä¸­å¢åŠ ä»¥ä¸‹è¯­å¥ï¼ˆä»¥ diff å½¢å¼å±•ç¤ºï¼‰ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">diff --git a/XXXX/device.mk b/XXXX/device.mk<br>index b0866f3d2..d7a7d8ef7 100755<br>--- a/XXXX/device.mk<br>+++ b/XXXX/device.mk<br>@@ -1,5 +1,6 @@<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/device_common.mk<br> <span class="hljs-keyword">include</span> <span class="hljs-variable">$(LOCAL_PATH)</span>/audio/device_audio.mk<br>+<span class="hljs-keyword">include</span> device/harman/broxton/common/demoComponent/device_demoComponent.mk<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/tuner/device_radioTuner.mk<br> <span class="hljs-keyword">include</span> device/harman/broxton/common/speech/vpa.mk<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢ä»¥ <code>+</code> å¼€å¤´çš„ <code>include</code> è¯­å¥ï¼Œå°±æ˜¯åœ¨å¼•ç”¨æˆ‘ä»¬çš„æ–°å»º Makefileã€‚</p><hr><p><strong>ã€ç»“è¯­ã€‘</strong></p><p>æ‰“åŒ…å·²ç»å®Œæˆï¼Œæˆ‘ä»¬çš„ demoComponent HAL æ­£è·ƒè·ƒæ¬²è¯•ã€‚ä½†å¦‚æœä½ å°†æ‰“åŒ…å¥½çš„ç³»ç»Ÿé•œåƒçƒ§å†™åˆ°è®¾å¤‡ä¸Šï¼Œä¼šå‘ç° demoComponent HAL ä¸èƒ½æŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œç”šè‡³è¿è‡ªå¯åŠ¨éƒ½åšä¸åˆ°ã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šåœ¨ logcat æˆ– dmesg é‡Œå‘ç°æœ‰å¾ˆå¤šæ—¥å¿—æç¤ºæˆ‘ä»¬æ²¡æœ‰æ“ä½œæƒé™ã€‚ ä¸‹ä¸€èŠ‚ã€Šæ·»åŠ æ‰§è¡Œæƒé™ã€‹å°†ä»‹ç»å¦‚ä½•ç»™ demoComponent HAL æ·»åŠ å¿…è¦çš„æƒé™ã€‚</p><p>å¦‚æœä½ æ€¥åˆ‡åœ°æƒ³çœ‹ä¸€çœ‹åˆšåˆšå†™å¥½çš„ HAL è¿›ç¨‹è¿è¡Œçš„æ ·å­ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ <code>setenforce 0</code> å°†è®¾å¤‡çš„ SELinux ç­–ç•¥æš‚æ—¶å…³é—­ã€‚ è¿™æ ·å°½ç®¡ç³»ç»Ÿä»ç„¶ä¼šæŠ¥å‘Šæƒé™é”™è¯¯ï¼Œä½†ä¸ä¼šç¦æ­¢è¿è¡Œã€‚</p><h2 id="5-æ·»åŠ æ‰§è¡Œæƒé™"><a href="#5-æ·»åŠ æ‰§è¡Œæƒé™" class="headerlink" title="5.æ·»åŠ æ‰§è¡Œæƒé™"></a>5.æ·»åŠ æ‰§è¡Œæƒé™</h2><p><strong>ã€å‰è¨€ã€‘</strong></p><p>demoComponent HAL å·²ç»æˆåŠŸç¼–è¯‘ä¸”æ‰“åŒ…åˆ°ç³»ç»Ÿé•œåƒä¸­ï¼Œä½†åˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰è¢«èµ‹äºˆè®¿é—® Binder çš„æƒé™ã€‚æ‰€ä»¥æˆ‘ä»¬è‡³å°‘ä¼šçœ‹åˆ°ï¼Œåœ¨å°† demoService æ³¨å†Œä¸º Binder æœåŠ¡æ—¶ï¼Œæ—¥å¿—ä¸­ä¼šæ‰“å°ç±»ä¼¼ä¸‹æ–¹çš„æç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">[   <span class="hljs-number">10.368517</span>] type=<span class="hljs-number">1400</span> <span class="hljs-built_in">audit</span>(<span class="hljs-number">1483292256.112</span>:<span class="hljs-number">14</span>): avc: denied &#123; add &#125; ...<br></code></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« å°±æ˜¯è¦è¯´æ˜å®Œå–„ demoComponent HAL æ‰€éœ€è¦çš„ SELinux æƒé™çš„æ–¹æ³•ã€‚</p><h3 id="5-1-ç¼–å†™ç­–ç•¥æ–‡ä»¶"><a href="#5-1-ç¼–å†™ç­–ç•¥æ–‡ä»¶" class="headerlink" title="5.1 ç¼–å†™ç­–ç•¥æ–‡ä»¶"></a>5.1 ç¼–å†™ç­–ç•¥æ–‡ä»¶</h3><p>ä¾å„å…¬å¸ä¹ æƒ¯ä¸åŒï¼Œç”¨äºé…ç½®äº§å“æƒé™çš„æ–‡ä»¶ä¸€èˆ¬æ”¾åœ¨ <code>/device/&lt;CompanyName&gt;/sepolicy/</code> æˆ– <code>/device/&lt;CompanyName&gt;/common/sepolicy/</code> ç›®å½•ä¸‹ï¼ˆä¹Ÿä¸æ’é™¤æ˜¯å…¶å®ƒè·¯å¾„çš„å¯èƒ½æ€§ï¼Œä½†è‚¯å®šæ˜¯åœ¨<code>device/</code> ç›®å½•ä¸‹çš„æŸä¸ª <code>sepolicy/ </code>å­ç›®å½•ï¼‰ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå†ä¸ºä¸åŒçš„éƒ¨ä»¶åˆ†åˆ«åˆ›å»ºç›¸åº”çš„å­ç›®å½•ï¼Œå¹¶åœ¨è¿™ä¸ªå­ç›®å½•ä¸­æ–°å»º <code>*.te</code> æ–‡ä»¶å’Œ <code>*_contexts</code> æ–‡ä»¶ï¼Œä»¥æ·»åŠ å¿…è¦çš„æƒé™ã€‚</p><p>è¿˜æ˜¯ä»¥æˆ‘æ­£åœ¨ä½¿ç”¨çš„å¹³å°ä¸ºä¾‹ï¼Œåˆ›å»ºæ–°ç›®å½• <code>/device/harman/sepolicy/demoComponent/</code>ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ–‡ä»¶ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200720203213989.png"><p>è¯´æ˜ä¸‹å„æ–‡ä»¶çš„å†…å®¹å’Œä½œç”¨ï¼š</p><ul><li><strong>file_contexts:</strong><ul><li>é¦–å…ˆç¼–å†™ <code>file_contexts</code> æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶åæ˜¯ç”± SELinux æ¡†æ¶å›ºå®šçš„ã€‚æˆ‘ä»¬åœ¨ <code>file_contexts</code> ä¸­å°† demoService çš„å¯æ‰§è¡Œæ–‡ä»¶å®šä¹‰ä¸ºå®‰å…¨å¯¹è±¡ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> demoService executable binary as a security object</span><br>/vendor/bin/hw/vendor.harman.demoComponent.demoService@<span class="hljs-number">1.0</span>-service   u:object_r:demoService_exec:s0<br></code></pre></td></tr></table></figure><ul><li><strong>hwservice_contexts:</strong><ul><li>ç„¶åï¼Œå› ä¸º demoComponent HAL ä¾èµ– hwbinder è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ <code>hwservice_contexts</code>ã€‚è¿™ä¸ªæ–‡ä»¶åä¹Ÿæ˜¯ç”± SELinux æ¡†æ¶å›ºå®šçš„ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å°†æ–°å¢çš„æ¥å£å®šä¹‰ä¸ºä¸€ä¸ªå®‰å…¨å¯¹è±¡ï¼Œä½œç”¨å’Œ file_contexts ç±»ä¼¼ã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ vndservice_contextsï¼‰</li><li>ä» Android 8.0 å¼€å§‹ï¼ŒSELinux ä¹Ÿä¸€åˆ†ä¸ºäºŒæˆä¸ºäº† system éƒ¨åˆ†å’Œ vendor éƒ¨åˆ†ã€‚å…¶ä¸­ vendor éƒ¨åˆ†åˆå› ä¸ºä¸åŒéƒ¨ä»¶ä½¿ç”¨çš„ binder èŠ‚ç‚¹ä¸åŒï¼Œä»åŸå…ˆå”¯ä¸€çš„çš„ <code>service_contexts</code> ä¸­å‰¥ç¦»å‡ºäº† <code>hwservice_contexts</code> å’Œ <code>vndservice_contexts</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å½“ä½¿ç”¨ &#x2F;dev&#x2F;hwbinder æ—¶æ‰‹åŠ¨åˆ›å»ºå‰è€…å¹¶åœ¨æ–‡ä»¶ä¸­æ·»åŠ å®šä¹‰ï¼Œå½“ä½¿ç”¨ &#x2F;dev&#x2F;vndbinder æ—¶åˆ›å»ºåè€…å¹¶åŒæ ·åœ¨æ–‡ä»¶ä¸­æ·»åŠ å®šä¹‰ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> HAL interface as a security object</span><br>vendor.harman.hardware.demoComponent.demoService::IDemoServiceDef  u:object_r:vendor_demoService_hwservice:s0<br></code></pre></td></tr></table></figure><ul><li><strong>hwservicemanager.te</strong>:<ul><li>ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ hwbinder èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜åº”è¯¥ç¼–å†™ hwservicemanager.teã€‚æ–‡ä»¶åä¹Ÿæ˜¯å›ºå®šçš„ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å£°æ˜ demoService éœ€è¦ä½¿ç”¨ hwbinderã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ vndservicemanager.teï¼‰</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># grant demoService permission of using hwbinder</span><br><span class="hljs-built_in">hwbinder_use</span>(demoService)<br></code></pre></td></tr></table></figure><ul><li><strong>hwservice.te:</strong><ul><li>åŒç†ï¼Œç¼–å†™ <code>hwservice.te</code>ã€‚æ–‡ä»¶åä¾ç„¶æ˜¯å›ºå®šçš„ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¸º demoService å®šä¹‰äº†ä¸“å±çš„ hwservice ç±»å‹ï¼Œåœ¨æ·»åŠ  â€œæ³¨å†ŒæœåŠ¡â€ æƒé™æ—¶ä¼šç”¨åˆ°ã€‚ï¼ˆå¦‚æœä½¿ç”¨ vndbinderï¼Œåˆ™åº”ç¼–å†™ <code>vndservice.te</code>ï¼‰</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> demoService as hwservice_manager, so it can be added as a hwservice</span><br>type vendor_demoService_hwservice, hwservice_manager_type;<br></code></pre></td></tr></table></figure><ul><li><strong>demoService.te:</strong><ul><li>æ¥ç€ç¼–å†™ demoService.te æ–‡ä»¶ã€‚ è¿™ä¸ªæ–‡ä»¶é€šå¸¸ä»¥éœ€è¦æ·»åŠ æƒé™çš„å¯¹è±¡ä¸ºåã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸º demoService å®šä¹‰äº†ä¸€ä¸ªä¸“å±çš„å®‰å…¨åŸŸï¼Œèµ‹äºˆå¯ demoService çš„æ‰§è¡Œæ–‡ä»¶ä»¥éœ€è¦çš„æ–‡ä»¶å±æ€§ï¼Œå¹¶ä¸”ä¸º demoService åŸŸæ·»åŠ å’Œ Binder æ“ä½œç›¸å…³çš„å¿…è¦æƒé™ï¼Œæ¯”å¦‚ â€œæ³¨å†Œä¸ºæœåŠ¡â€ã€â€œå…è®¸ hwbinder è°ƒç”¨â€ ç­‰ã€‚</li><li>ä¸åŒçš„ HAL è¿›ç¨‹æˆ–æœ¬åœ°æœåŠ¡è¦æ“ä½œçš„æ–‡ä»¶ä¸åŒï¼Œå…¶å®ç°çš„ä½œç”¨ä¹Ÿä¸åŒï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å·®å¼‚ä¹Ÿå¾ˆå¤§ã€‚ä¾ç…§æœ€å°æƒé™è§„åˆ™ï¼Œæ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦æ·»åŠ æƒé™å³å¯ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta"># <span class="hljs-keyword">define</span> a security domain for demo service</span><br>type demoService, domain;<br><br><span class="hljs-meta"># specify demo service attributes</span><br>type demoService_exec, exec_type, file_type, vendor_file_type;<br><br><span class="hljs-meta"># initialize demo service domain</span><br><span class="hljs-built_in">init_daemon_domain</span>(demoService)<br><br><span class="hljs-built_in">add_hwservice</span>(demoService, vendor_demoService_hwservice)<br><br><span class="hljs-built_in">binder_call</span>(demoService, vndservicemanager)<br><span class="hljs-built_in">binder_call</span>(demoService, hwservicemanager)<br><span class="hljs-built_in">binder_call</span>(demoService, system_app)<br><br>allow demoService vndbinder_device:chr_file rw_file_perms;<br>allow demoService hwservicemanager_prop:file r_file_perms;<br></code></pre></td></tr></table></figure><ul><li><strong>system_app.te:</strong><ul><li>æœ€åï¼Œè¿˜è¦ä¸ºç”¨æˆ·è¿›ç¨‹æ·»åŠ è°ƒç”¨æƒé™ã€‚æˆ‘ä»¬é€šå¸¸ä¼šä»¥ APP å¯¹ demoService çš„è°ƒç”¨ä¸ºä¾‹è¯´æ˜è°ƒç”¨è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ–°å»º <code>system_app.te</code>ã€‚ä¸º system_app æ·»åŠ é€šè¿‡ hwservice_manager æŸ¥æ‰¾æœåŠ¡ã€ä»¥åŠé€šè¿‡ binder è°ƒç”¨ demoService çš„æƒé™ã€‚</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"># <span class="hljs-function">APP access priviledges <span class="hljs-keyword">for</span> demoService</span><br><span class="hljs-function"><span class="hljs-title">binder_call</span><span class="hljs-params">(system_app, demoService)</span></span><br><span class="hljs-function">allow system_app vendor_demoService_hwservice:hwservice_manager find;</span><br></code></pre></td></tr></table></figure><h3 id="5-2-åº”ç”¨ç­–ç•¥æ–‡ä»¶"><a href="#5-2-åº”ç”¨ç­–ç•¥æ–‡ä»¶" class="headerlink" title="5.2 åº”ç”¨ç­–ç•¥æ–‡ä»¶"></a>5.2 åº”ç”¨ç­–ç•¥æ–‡ä»¶</h3><p>ä¸ºäº†ä½¿æ–°å¢çš„å®‰å…¨è§„åˆ™ç”Ÿæ•ˆï¼Œéœ€è¦å°†åˆšåˆšåˆ›å»ºçš„ç›®å½•æ·»åŠ åˆ° Makefile ä¸­ï¼Œè¿™æ ·ä¸€æ¥ç¼–è¯‘é•œåƒæ—¶å°±å¯ä»¥æ‰«æåˆ°äº†ã€‚æˆ‘ä»¬ä¸€èˆ¬æŠŠè¿™ä¸ªæ”¹åŠ¨æ·»åŠ åˆ° <code>/device/&lt;CompanyName&gt;/&lt;PlatformName&gt;/&lt;ProductName&gt;/BoardConfig.mk</code>ã€‚</p><p>è¿™é‡Œæˆ‘æ”¹åŠ¨çš„æ–‡ä»¶æ˜¯ <code>/device/harman/broxton/XXXX/BoardConfig.mk</code>ï¼Œä¿®æ”¹éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile">diff --git a/XXXX/BoardConfig.mk b/XXXX/BoardConfig.mk<br>index 4979507a7..8e700f22d 100755<br>--- a/XXXX/BoardConfig.mk<br>+++ b/XXXX/BoardConfig.mk<br>@@ -72,6 +72,12 @@ BOARD_SEPOLICY_DIRS += device/harman/sepolicy/vold<br> INTEL_AUDIO_HAL=imc<br> BOARD_SEPOLICY_DIRS += device/harman/sepolicy/audio<br>+<br>+<span class="hljs-comment">########################################################</span><br>+<span class="hljs-comment"># DemoService</span><br>+<span class="hljs-comment">########################################################</span><br>+BOARD_SEPOLICY_DIRS += device/harman/sepolicy/demoComponent<br>+<br></code></pre></td></tr></table></figure><hr><p><strong>ã€ç»“è¯­ã€‘</strong></p><p>å®Œå…¨ç¼–è¯‘åï¼Œçƒ§å†™é•œåƒåˆ°è®¾å¤‡ä¸Šã€‚å¾…è®¾å¤‡å¯åŠ¨åï¼Œæ‰§è¡Œå‘½ä»¤ <code>ps -A | grep -i demo</code> ï¼Œç»ˆäºå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ demoComponent HAL è¿›ç¨‹å·²ç»éšç³»ç»Ÿå¯åŠ¨æˆåŠŸã€‚</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/2020072020305469.png"><p>å¦‚æœåœ¨ç³»ç»Ÿåˆšå¯åŠ¨æ—¶æ‰§è¡Œå‘½ä»¤ <code>logcat | grep -i demo</code>ï¼Œè¿˜å¯ä»¥çœ‹åˆ° demoComponent HAL æ³¨å†Œä¸º Binder æœåŠ¡çš„æ—¥å¿—æ‰“å°ï¼š</p><img src="/2023/03/05/Android-8-1%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99HAL/20200720203133940.png"><h2 id="6-æ„Ÿè°¢"><a href="#6-æ„Ÿè°¢" class="headerlink" title="6.æ„Ÿè°¢"></a>6.æ„Ÿè°¢</h2><p>ğŸŠå†æ¬¡æ„Ÿè°¢å¤§ä½¬ã€Qidi_Huangã€‘çš„ç²¾å½©åšå®¢ï¼</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–è¯‘åŸç†å­¦ä¹ ç¬”è®°</title>
    <link href="/2023/03/02/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/03/02/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°"><a href="#ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°" class="headerlink" title="ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°"></a>ã€Šå“ˆå·¥å¤§ç¼–è¯‘åŸç†ã€‹å­¦ä¹ ç¬”è®°</h1><blockquote><p>æœ¬ç³»åˆ—åšå®¢ä¸»è¦è®°å½•è‡ªå·±å­¦ä¹ ç¼–è¯‘åŸç†çš„ç¬”è®°ï¼Œå¹¶æ‰‹å†™ä¸€ä¸ªCè¯­è¨€ç¼–è¯‘å™¨</p><ul><li>â˜ƒï¸<strong>ç¼–è¯‘åŸç†å­¦ä¹ èµ„æ–™</strong>ï¼šå“ˆå·¥å¤§é™ˆé„è€å¸ˆçš„ã€Šç¼–è¯‘åŸç†ã€‹</li></ul></blockquote><ul><li><p>âœï¸ç¬¬ä¸€ç« ï¼š<a href="https://anmuxixixi.github.io/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/">ç¼–è¯‘åŸç†ç»ªè®º</a></p></li><li><p>ğŸ–Šï¸ç¬¬äºŒç« ï¼š<a href="https://anmuxixixi.github.io/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/">è¯æ³•åŠæ–‡æ³•</a></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>äºŒã€è¯­è¨€åŠå…¶æ–‡æ³•</title>
    <link href="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/"/>
    <url>/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="äºŒã€è¯­è¨€åŠæ–‡æ³•"><a href="#äºŒã€è¯­è¨€åŠæ–‡æ³•" class="headerlink" title="äºŒã€è¯­è¨€åŠæ–‡æ³•"></a>äºŒã€è¯­è¨€åŠæ–‡æ³•</h1><h2 id="1-å­—æ¯è¡¨"><a href="#1-å­—æ¯è¡¨" class="headerlink" title="1.å­—æ¯è¡¨"></a>1.å­—æ¯è¡¨</h2><p>å­—æ¯è¡¨Î£æ˜¯ä¸€ä¸ªæœ‰ç©·ç¬¦å·é›†åˆï¼›è¿™é‡Œçš„ç¬¦å·å¯ä»¥æ˜¯å­—æ¯ã€æ•°å­—ã€æ ‡ç‚¹ç¬¦å·â€¦â€¦ä¸‹é¢çš„ä¾‹å­éƒ½æ˜¯å­—æ¯è¡¨</p><ul><li>äºŒè¿›åˆ¶å­—æ¯è¡¨ï¼š{0,1}</li><li>ASCIIå­—ç¬¦é›†</li><li>Unicodeå­—ç¬¦é›†</li></ul><p>å­—æ¯è¡¨æœ‰ä¸‹é¢å‡ ç§è¿ç®—ï¼š</p><ul><li>ä¹˜ç§¯</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235051480.png" alt="image-20230302235051480" style="zoom:50%;"><ul><li>næ¬¡å¹‚</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235116133.png" alt="image-20230302235116133" style="zoom:50%;"><ul><li>æ­£é—­åŒ…</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235140690.png" alt="image-20230302235140690" style="zoom:50%;"><ul><li>å…‹æ—é—­åŒ…</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235156202.png" alt="image-20230302235156202" style="zoom:50%;"><h2 id="2-ä¸²"><a href="#2-ä¸²" class="headerlink" title="2.ä¸²"></a>2.ä¸²</h2><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235218276.png" alt="image-20230302235218276" style="zoom: 50%;"><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ä¸²ä¸Šçš„è¿ç®—ï¼š</p><ul><li>è¿æ¥</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235351581.png" alt="image-20230302235351581" style="zoom: 50%;"><ul><li>å¹‚</li></ul><img src="/2023/03/02/%E4%BA%8C%E3%80%81%E8%AF%AD%E8%A8%80%E5%8F%8A%E5%85%B6%E6%96%87%E6%B3%95/image-20230302235405401.png" alt="image-20230302235405401" style="zoom:50%;"><h2 id="3-æ–‡æ³•çš„å®šä¹‰"><a href="#3-æ–‡æ³•çš„å®šä¹‰" class="headerlink" title="3.æ–‡æ³•çš„å®šä¹‰"></a>3.æ–‡æ³•çš„å®šä¹‰</h2>]]></content>
    
    
    <categories>
      
      <category>ç¼–è¯‘åŸç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘åŸç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º</title>
    <link href="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/"/>
    <url>/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º"><a href="#ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º" class="headerlink" title="ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º"></a>ä¸€ã€ç¼–è¯‘åŸç†ç»ªè®º</h1><h2 id="1-ä»€ä¹ˆæ˜¯ç¼–è¯‘"><a href="#1-ä»€ä¹ˆæ˜¯ç¼–è¯‘" class="headerlink" title="1.ä»€ä¹ˆæ˜¯ç¼–è¯‘"></a>1.ä»€ä¹ˆæ˜¯ç¼–è¯‘</h2><p>ğŸ«<strong>ç¼–è¯‘</strong>ï¼šå°†é«˜çº§è¯­è¨€ã€æºè¯­è¨€ã€‘ç¿»è¯‘æˆæ±‡ç¼–è¯­è¨€æˆ–æœºå™¨è¯­è¨€ã€ç›®æ ‡è¯­è¨€ã€‘çš„è¿‡ç¨‹</p><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302225554584.png" alt="image-20230302225554584" style="zoom:67%;"><p>æˆ‘ä»¬æŠŠCè¯­è¨€ä¸­çš„x &#x3D; 2ç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€<code>MOV X,2</code>ï¼Œæˆ–æ˜¯ç›´æ¥ç¼–è¯‘æˆæœºå™¨è¯­è¨€<code>C706 0000 0002</code></p><p><strong>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•´ä¸ªç¼–è¯‘çš„æµç¨‹ï¼š</strong></p><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302225855228.png" alt="image-20230302225855228" style="zoom: 67%;"><ul><li>é¢„å¤„ç†å™¨ï¼šæŠŠå­˜å‚¨åœ¨ä¸åŒæ–‡ä»¶ä¸­çš„æºç¨‹åºèšåˆåœ¨ä¸€èµ·ï¼›æŠŠè¢«ç§°ä¸ºå®çš„ç¼©å†™è¯­å¥è½¬æ¢ä¸ºåŸå§‹è¯­å¥</li><li>å¯é‡å®šä½çš„æœºå™¨ä»£ç ï¼šæ±‡ç¼–å™¨ç”Ÿæˆçš„å¯é‡å®šä½èµ·å§‹ä»£ç åœ¨å†…å­˜ä¸­å­˜æ”¾çš„èµ·å§‹ä½ç½®ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€æœ‰åœ°å€éƒ½æ˜¯ç›¸å¯¹äºèµ·å§‹ä½ç½®çš„ç›¸å¯¹åœ°å€</li><li>åŠ è½½å™¨ï¼šä¿®æ”¹å¯é‡å®šä½åœ°å€ï¼›å°†ä¿®æ”¹åçš„æŒ‡ä»¤å’Œæ•°æ®æ”¾åœ¨å†…å­˜ä¸­é€‚åˆçš„ä½ç½®</li><li>é“¾æ¥å™¨ï¼šå°†å¤šä¸ªå¯é‡å®šä½çš„æœºå™¨ä»£ç æ–‡ä»¶ï¼ˆåŒ…æ‹¬åº“æ–‡ä»¶ï¼‰è¿æ¥åˆ°ä¸€èµ·ï¼›è§£å†³å¤–éƒ¨å†…éƒ¨åœ°å€é—®é¢˜</li></ul><h2 id="2-ç¼–è¯‘å™¨çš„ç»“æ„"><a href="#2-ç¼–è¯‘å™¨çš„ç»“æ„" class="headerlink" title="2.ç¼–è¯‘å™¨çš„ç»“æ„"></a>2.ç¼–è¯‘å™¨çš„ç»“æ„</h2><img src="/2023/03/02/%E4%B8%80%E3%80%81%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%BB%AA%E8%AE%BA/image-20230302230959458.png" alt="image-20230302230959458" style="zoom:67%;"><p>ç¼–è¯‘å™¨å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>å‰ç«¯éƒ¨åˆ†ï¼Œä¸æºè¯­è¨€ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯ä¸æˆ‘ä»¬å†™çš„é«˜çº§è¯­è¨€C&#x2F;Javaç­‰æœ‰å…³</p></li><li><p>åç«¯éƒ¨åˆ†ï¼Œä¸ç›®æ ‡è¯­è¨€ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆçš„ç›®æ ‡æœºå™¨è¯­è¨€</p></li><li><p>ä¸­é—´éƒ¨åˆ†ï¼šæœºå™¨æ— å…³ä»£ç ä¼˜åŒ–å™¨</p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°</title>
    <link href="/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°"><a href="#kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°" class="headerlink" title="kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°"></a>kernelä¸‹è¾“å…¥è¾“å‡ºconsoleå¦‚ä½•å®ç°</h1><blockquote><p>ğŸ›<strong>å¤§éƒ¨åˆ†å†…å®¹è½¬è½½è‡ª</strong>ï¼š</p><ul><li><a href="https://www.cnblogs.com/lifexy/p/7993136.html">https://www.cnblogs.com/lifexy/p/7993136.html</a></li><li><a href="https://blog.csdn.net/skyflying2012/article/details/41078349?spm=1001.2014.3001.5506">https://blog.csdn.net/skyflying2012/article/details/41078349?spm=1001.2014.3001.5506</a></li></ul></blockquote><h2 id="1-åœ¨é©±åŠ¨è°ƒè¯•ä¸­-ä½¿ç”¨printk-æ˜¯æœ€ç®€å•-æœ€æ–¹ä¾¿çš„åŠæ³•"><a href="#1-åœ¨é©±åŠ¨è°ƒè¯•ä¸­-ä½¿ç”¨printk-æ˜¯æœ€ç®€å•-æœ€æ–¹ä¾¿çš„åŠæ³•" class="headerlink" title="1.åœ¨é©±åŠ¨è°ƒè¯•ä¸­,ä½¿ç”¨printk(),æ˜¯æœ€ç®€å•,æœ€æ–¹ä¾¿çš„åŠæ³•"></a>1.åœ¨é©±åŠ¨è°ƒè¯•ä¸­,ä½¿ç”¨printk(),æ˜¯æœ€ç®€å•,æœ€æ–¹ä¾¿çš„åŠæ³•</h2><p>âœ¨<strong>å…ˆè¯´ç»“è®ºï¼Œå½“ubootå‘½ä»¤è¡Œä¸­è®¾ç½®ä¸åŒçš„consoleå‚æ•°ï¼Œè¾“å‡ºåˆ°çš„è®¾å¤‡ä¸åŒï¼š</strong></p><ul><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;tty1â€</strong>æ—¶,è¡¨ç¤ºprintk()è¾“å‡ºåœ¨å¼€å‘æ¿çš„LCDå±ä¸Š</p></li><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;ttySA0,115200â€</strong>æ—¶,è¡¨ç¤ºprintk()è¾“å‡ºåœ¨ä¸²å£UART0ä¸Š,æ³¢ç‰¹ç‡&#x3D;115200</p></li><li><p>å½“ubootçš„å‘½ä»¤è¡Œé‡Œçš„<strong>â€œconsole&#x3D;tty1 console&#x3D;ttySA0,115200â€</strong>æ—¶,è¡¨ç¤ºprintk()åŒæ—¶è¾“å‡ºåœ¨ä¸²å£ä¸Š,ä»¥åŠå¼€å‘æ¿çš„LCDå±ä¸Š</p></li></ul><p>å†…æ ¸åˆæ˜¯æ€ä¹ˆæ ¹æ®ä¸Šé¢å‘½ä»¤è¡Œå‚æ•°æ¥ç¡®å®šprintk()çš„è¾“å‡ºè®¾å¤‡ï¼Ÿ</p><h2 id="2-ä»¥console-ttySA0-115200ä¸ºä¾‹åˆ†æprintk"><a href="#2-ä»¥console-ttySA0-115200ä¸ºä¾‹åˆ†æprintk" class="headerlink" title="2.ä»¥console=ttySA0,115200ä¸ºä¾‹åˆ†æprintk"></a>2.ä»¥<code>console=ttySA0,115200</code>ä¸ºä¾‹åˆ†æprintk</h2><h3 id="2-1-å‘½ä»¤è¡Œæ¿€æ´»-setup"><a href="#2-1-å‘½ä»¤è¡Œæ¿€æ´»-setup" class="headerlink" title="2.1 å‘½ä»¤è¡Œæ¿€æ´»__setup"></a>2.1 å‘½ä»¤è¡Œæ¿€æ´»__setup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel\printk\printk.c</span><br>__setup(<span class="hljs-string">&quot;console=&quot;</span>, console_setup);<br></code></pre></td></tr></table></figure><p>**__setup()**çš„ä½œç”¨å°±æ˜¯ï¼šè‹¥ubootä¼ é€’è¿›æ¥çš„å‘½ä»¤è¡Œå­—ç¬¦ä¸²é‡Œå«æœ‰â€œconsole&#x3D;â€,ä¾¿è°ƒç”¨console_setup()å‡½æ•°,å¹¶å¯¹â€œconsole&#x3D;â€åé¢å¸¦çš„å­—ç¬¦ä¸²â€ttySA0,115200â€è¿›è¡Œåˆ†æ</p><h3 id="2-2-è°ƒç”¨console-setupå‡½æ•°"><a href="#2-2-è°ƒç”¨console-setupå‡½æ•°" class="headerlink" title="2.2 è°ƒç”¨console_setupå‡½æ•°"></a>2.2 è°ƒç”¨console_setupå‡½æ•°</h3><p>æˆ‘ä»¬ä»¥ttySA0,115200ä¸ºä¾‹ï¼Œåˆ†æä¸€ä¸ª<code>console_setup</code>å‡½æ•°ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œç»“æ„ä½“å’Œæ•°ç»„åŒåï¼Œéƒ½æ˜¯<code>console_cmdline</code>ï¼ŒåŒºåˆ†ä¸€ä¸‹ğŸ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CMDLINECONSOLES 8</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">char</span>name[<span class="hljs-number">16</span>];<span class="hljs-comment">/* Name of the driver    */</span><br><span class="hljs-type">int</span>    index;<span class="hljs-comment">/* Minor dev. to use    */</span><br><span class="hljs-type">char</span>*options;<span class="hljs-comment">/* Options for the driver   */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span> <span class="hljs-title">console_cmdline</span>[<span class="hljs-title">MAX_CMDLINECONSOLES</span>];</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">console_setup</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span>                    <span class="hljs-comment">//*str=&quot;ttySA0,115200&quot;</span><br>&#123;<br>    <span class="hljs-type">char</span> name[<span class="hljs-keyword">sizeof</span>(console_cmdline[<span class="hljs-number">0</span>].name)];     <span class="hljs-comment">// char name[16]</span><br>    <span class="hljs-type">char</span> *s, *options;<br>    <span class="hljs-type">int</span> idx; <br><br>    <span class="hljs-keyword">if</span> (str[<span class="hljs-number">0</span>] &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; str[<span class="hljs-number">0</span>] &lt;= <span class="hljs-string">&#x27;9&#x27;</span>) &#123;                    <br>            <span class="hljs-built_in">strcpy</span>(name, <span class="hljs-string">&quot;ttyS&quot;</span>);<br>            <span class="hljs-built_in">strncpy</span>(name + <span class="hljs-number">4</span>, str, <span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">5</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">strncpy</span>(name, str, <span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">1</span>);   <span class="hljs-comment">//*name=&quot;ttySA0,115200&quot;</span><br>    &#125;<br><br>    name[<span class="hljs-keyword">sizeof</span>(name) - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;  <br>    <span class="hljs-keyword">if</span> ((options = <span class="hljs-built_in">strchr</span>(str, <span class="hljs-string">&#x27;,&#x27;</span>)) != <span class="hljs-literal">NULL</span>)   <span class="hljs-comment">// æ‰¾åˆ°&#x27;,&#x27;,è¿”å›ç»™options</span><br>            *(options++) = <span class="hljs-number">0</span>;                <span class="hljs-comment">//*options=&quot;115200&quot;</span><br><br><br>    <span class="hljs-keyword">for</span> (s = name; *s; s++)                                     <span class="hljs-comment">//*s=&quot;0&quot;</span><br>            <span class="hljs-keyword">if</span> ((*s &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; *s &lt;= <span class="hljs-string">&#x27;9&#x27;</span>) || *s == <span class="hljs-string">&#x27;,&#x27;</span>)<br>                    <span class="hljs-keyword">break</span>;<br><br>idx = simple_strtoul(s, <span class="hljs-literal">NULL</span>, <span class="hljs-number">10</span>);   <span class="hljs-comment">//å’Œstrtoul()ä¸€æ ·,å°†sä¸­çš„&quot;0&quot;æå‡ºæ¥,æ‰€ä»¥idx=0</span><br>    *s = <span class="hljs-number">0</span>;<br><br>add_preferred_console(name, idx, options);      <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å’Œæ³¨é‡Šå¾—åˆ°ï¼Œæœ€ç»ˆè°ƒç”¨add_preferred_console(â€œttySAâ€, 0, â€œ115200â€)å‡½æ•°æ¥æ·»åŠ æ§åˆ¶å°</p><h3 id="2-3-è°ƒç”¨add-preferred-consoleå‡½æ•°"><a href="#2-3-è°ƒç”¨add-preferred-consoleå‡½æ•°" class="headerlink" title="2.3 è°ƒç”¨add_preferred_consoleå‡½æ•°"></a>2.3 è°ƒç”¨add_preferred_consoleå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">add_preferred_console</span><span class="hljs-params">(<span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> idx, <span class="hljs-type">char</span> *options)</span><br>&#123;<br><span class="hljs-keyword">return</span> __add_preferred_console(name, idx, options, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __add_preferred_console(<span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> idx, <span class="hljs-type">char</span> *options, <span class="hljs-type">char</span> *brl_options)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console_cmdline</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">int</span> i;<br><br>    <span class="hljs-comment">// MAX_CMDLINECONSOLES=8,è¡¨ç¤ºæœ€å¤šæ·»åŠ 8ä¸ªæ§åˆ¶å°</span><br>    <span class="hljs-comment">// è¿™æ˜¯ç›´æ¥å°†cæŒ‡å‘äº†å…¨å±€å˜é‡console_cmdline</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, c = console_cmdline; i &lt; MAX_CMDLINECONSOLES &amp;&amp; c-&gt;name[<span class="hljs-number">0</span>]; i++, c++) &#123;<br>        <span class="hljs-comment">// è¯¥consoleåå­—å’Œä¸‹æ ‡å¥½å·²ç»å­˜åœ¨äº†ã€ç›®çš„æ˜¯ä¸ºäº†å»é‡ã€‘</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(c-&gt;name, name) == <span class="hljs-number">0</span> &amp;&amp; c-&gt;index == idx) &#123;<br><span class="hljs-keyword">if</span> (!brl_options)<br>selected_console = i;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br>    <br>    <span class="hljs-comment">// i == 8,è¡¨ç¤ºæ•°ç»„å­˜æ»¡äº†</span><br><span class="hljs-keyword">if</span> (i == MAX_CMDLINECONSOLES)<br><span class="hljs-keyword">return</span> -E2BIG;<br><span class="hljs-keyword">if</span> (!brl_options)<br>selected_console = i; <span class="hljs-comment">// å°†selected_consoleè®¾ç½®ä¸ºæœ€æ–°æ·»åŠ çš„console_cmdlineçš„ä¸‹æ ‡å·</span><br><br>strlcpy(c-&gt;name, name, <span class="hljs-keyword">sizeof</span>(c-&gt;name));<br>c-&gt;options = options;<br>braille_set_options(c, brl_options);<br><br>c-&gt;index = idx;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__add_preferred_console</code>å°†name idx optionsä¿å­˜åˆ°æ•°ç»„ä¸‹ä¸€ä¸ªæˆå‘˜console_cmdlineç»“æ„ä½“ä¸­ï¼Œå¦‚æœæ•°ç»„ä¸­å·²æœ‰é‡åï¼Œåˆ™ä¸æ·»åŠ ï¼Œå¹¶ç½®selected_consoleä¸ºæœ€æ–°æ·»åŠ çš„console_cmdlineçš„ä¸‹æ ‡å·ã€‚</p><p>æ¯”å¦‚cmdlineä¸­æœ‰â€œconsole&#x3D;ttyS0,115200 console&#x3D;ttyS1,9600â€</p><p>åˆ™åœ¨console_cmdline[8]æ•°ç»„ä¸­console_cmdline[0]ä»£è¡¨ttyS0ï¼Œconsole_cmdline[1]ä»£è¡¨ttyS1ï¼Œè€Œselected_console&#x3D;1.</p><h3 id="2-4-kernelä¸‹å¦‚ä½•é€‰æ‹©printk-console"><a href="#2-4-kernelä¸‹å¦‚ä½•é€‰æ‹©printk-console" class="headerlink" title="2.4 kernelä¸‹å¦‚ä½•é€‰æ‹©printk console"></a>2.4 kernelä¸‹å¦‚ä½•é€‰æ‹©printk console</h3><p>æ ¹æ®<a href="https://anmuxixixi.github.io/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/">printkçš„å®ç°åŸç†</a>ï¼Œprintkæœ€åè°ƒç”¨console_unlockå®ç°log_bufæ•°æ®åˆ·å‡ºåˆ°æŒ‡å®šè®¾å¤‡ã€‚</p><p>è¿™é‡Œå…ˆä¸å…³å¿ƒprintkå¦‚ä½•å¤„ç†log bufæ•°æ®(æ¯”å¦‚æ·»åŠ å†…å®¹çº§åˆ«)ï¼Œåªå…³å¿ƒprintkå¦‚ä½•ä¸€æ­¥æ­¥æ‰¾åˆ°æŒ‡å®šçš„è¾“å‡ºè®¾å¤‡ï¼Œæ ¹æ®printk.cä»£ç ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹çº¿ç´¢ã€‚</p><p><strong>printk-&gt;vprintk-&gt;console_unlock-&gt;call_console_drivers</strong></p><p>çœ‹çº¿ç´¢æœ€åº•å±‚çš„call_console_drivers</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">console_drivers</span>;</span> <span class="hljs-comment">// å…¨å±€</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> for_each_console(con) \</span><br><span class="hljs-meta">for (con = console_drivers; con != NULL; con = con-&gt;next)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">call_console_drivers</span><span class="hljs-params">(<span class="hljs-type">int</span> level, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *text, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">con</span>;</span><br><br>trace_console(text, len);<br><br><span class="hljs-keyword">if</span> (level &gt;= console_loglevel &amp;&amp; !ignore_loglevel)<br><span class="hljs-keyword">return</span>;<br><span class="hljs-keyword">if</span> (!console_drivers)<br><span class="hljs-keyword">return</span>;<br><br>for_each_console(con) &#123;<br><span class="hljs-keyword">if</span> (exclusive_console &amp;&amp; con != exclusive_console)  <span class="hljs-comment">// å¦‚æœæŒ‡æ˜äº†å”¯ä¸€çš„consoleï¼Œä¸”å½“å‰ä¸æ˜¯é‚£ä¸ªconsole</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!(con-&gt;flags &amp; CON_ENABLED))  <span class="hljs-comment">// å½“å‰çš„consoleä¸æ˜¯enabledçš„</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (!con-&gt;write)   <span class="hljs-comment">// å½“å‰consoleæ²¡æœ‰writeå‡½æ•°</span><br><span class="hljs-keyword">continue</span>;<br>con-&gt;write(con, text, len);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>éå†console_driversé“¾è¡¨æ‰€æœ‰console structï¼Œè°ƒç”¨æ‰€æœ‰<u><strong>ENABLE</strong></u>çš„consoleçš„writeæ–¹æ³•å°†log bufä¸­startåˆ°endçš„å†…å®¹å‘å‡ºã€‚</p><blockquote><p>åˆ°è¿™é‡Œå°±å¾ˆæ˜äº†äº†ï¼Œkernelä¸‹æ¯æ¬¡printkæ‰“å°ï¼Œé¦–å…ˆå­˜log_bufï¼Œç„¶åéå†console_driversï¼Œæ‰¾åˆ°åˆé€‚consoleï¼Œåˆ·å‡ºlogã€‚</p><p>console_driversé“¾è¡¨çš„æˆå‘˜æ˜¯å“ªé‡Œæ¥çš„ï¼Œæ¥ç€æ¥çœ‹ä¸‹ä¸€éƒ¨åˆ†ï¼Œkernelä¸‹consoleçš„æ³¨å†Œ</p></blockquote><h3 id="2-5-consoleé©±åŠ¨æ³¨å†Œ"><a href="#2-5-consoleé©±åŠ¨æ³¨å†Œ" class="headerlink" title="2.5 consoleé©±åŠ¨æ³¨å†Œ"></a>2.5 consoleé©±åŠ¨æ³¨å†Œ</h3><p>æ¥ä¸‹æ¥æ¥æœç´¢è¯¥æ•°ç»„ï¼Œçœ‹çœ‹printk()å¦‚ä½•è°ƒç”¨æ§åˆ¶å°çš„ç¡¬ä»¶å¤„ç†å‡½æ•°çš„ã€‚æœç´¢åˆ°åœ¨<code>Printk.c</code>é‡Œçš„<code>register_console(struct console *console)</code>å‡½æ•°,æœ‰ç”¨åˆ°console_cmdline[]</p><p>æ˜¾ç„¶,register_console()å‡½æ•°å°±ç”¨æ¥æ³¨å†Œæ§åˆ¶å°çš„,ç»§ç»­æœç´¢register_console</p><img src="/2023/02/25/kernel%E4%B8%8B%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BAconsole%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/image-20230225225234632.png" alt="image-20230225225234632" style="zoom:67%;"><p>æˆ‘ä»¬ä»¥<code>drivers\tty\serial\serial_ks8695.c</code>ä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ks8695_console_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>add_preferred_console(SERIAL_KS8695_DEVNAME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>register_console(&amp;ks8695_console);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>console_initcall(ks8695_console_init); <span class="hljs-comment">// å£°æ˜æ§åˆ¶å°åˆå§‹åŒ–å‡½æ•°</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢é€šè¿‡register_console()æ¥æ³¨å†Œ<code>ks8695_console</code>ç»“æ„ä½“,è¯¥ç»“æ„ä½“æˆå‘˜å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERIAL_KS8695_DEVNAME<span class="hljs-string">&quot;ttyAM&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> <span class="hljs-title">ks8695_console</span> =</span> &#123;<br>.name= SERIAL_KS8695_DEVNAME,  <span class="hljs-comment">// æ§åˆ¶å°åç§°</span><br>.write= ks8695_console_write,   <span class="hljs-comment">// æ‰“å°ä¸²å£æ•°æ®çš„ç¡¬ä»¶å¤„ç†å‡½æ•°</span><br>.device= uart_console_device,    <span class="hljs-comment">// ttyé©±åŠ¨</span><br>.setup= ks8695_console_setup,   <span class="hljs-comment">// ç”¨æ¥è®¾ç½®UARTçš„æ³¢ç‰¹ç‡ï¼Œå‘é€ï¼Œæ¥æ”¶ç­‰åŠŸèƒ½</span><br>.flags= CON_PRINTBUFFER,        <span class="hljs-comment">// æ ‡å¿—ä½</span><br>.index= <span class="hljs-number">-1</span>,                     <span class="hljs-comment">// ç´¢å¼•</span><br>.data= &amp;ks8695_reg,            <span class="hljs-comment">// å¯„å­˜å™¨</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨register_console()é‡Œï¼Œä¾¿ä¼šé€šè¿‡<code>ttyAM</code>æ¥åŒ¹é…console_cmdline[i]çš„åç§°,å½“åŒ¹é…æˆåŠŸï¼Œprintk()è°ƒç”¨çš„consoleç»“æ„ä½“ä¾¿æ˜¯ks8695_consoleäº†</p><p>â˜ƒï¸å½“é©±åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œä¼šèµ°åˆ°MODULE_INITï¼Œç„¶åèµ°åˆ°å¯¹åº”é©±åŠ¨æ³¨å†Œçš„initå‡½æ•°ä¸­ï¼Œåœ¨è¿™é‡Œå°±æ˜¯<code>ks8695_console_init</code>ï¼Œç´§æ¥ç€ä¼šè°ƒç”¨<code>register_console</code>ï¼Œè¿™é‡Œçš„register_consoleå°±æ˜¯<code>printk.c</code>ä¸­çš„register_consoleã€‚</p><hr><p>å› æ­¤æˆ‘ä»¬æ¥çœ‹ä¸‹printk.cä¸­çš„register_console</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_console</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> console *newcon)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">console</span> *<span class="hljs-title">bcon</span> =</span> <span class="hljs-literal">NULL</span>;<br> <br>    <span class="hljs-comment">//å¦‚æœæ³¨å†Œçš„æ˜¯bootconsoleï¼ˆkernelæ—©æœŸå¯åŠ¨æ‰“å°ï¼‰ï¼Œéœ€è¦æ£€æŸ¥console_driversä¸­</span><br>    <span class="hljs-comment">//æ²¡æœ‰â€œreal consoleâ€ä¹Ÿå°±æ˜¯è¯´bootconsoleå¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªæ³¨å†Œçš„consoleã€‚</span><br>    <span class="hljs-keyword">if</span> (console_drivers &amp;&amp; newcon-&gt;flags &amp; CON_BOOT) &#123;<br>        <span class="hljs-comment">/* find the last or real console */</span><br>        for_each_console(bcon) &#123;<br>            <span class="hljs-keyword">if</span> (!(bcon-&gt;flags &amp; CON_BOOT)) &#123;<br>                printk(KERN_INFO <span class="hljs-string">&quot;Too late to register bootconsole %s%d\n&quot;</span>,<br>                    newcon-&gt;name, newcon-&gt;index);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">if</span> (console_drivers &amp;&amp; console_drivers-&gt;flags &amp; CON_BOOT)<br>        bcon = console_drivers;<br> <br>    <span class="hljs-comment">//preferred consoleä¸ºconsole_cmdlineä¸­æœ€åä¸€ä¸ªconsole</span><br>    <span class="hljs-keyword">if</span> (preferred_console &lt; <span class="hljs-number">0</span> || bcon || !console_drivers)<br>        preferred_console = selected_console;<br> <br>    <span class="hljs-keyword">if</span> (newcon-&gt;early_setup)<br>        newcon-&gt;early_setup();<br> <br>    <span class="hljs-keyword">if</span> (preferred_console &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &lt; <span class="hljs-number">0</span>)<br>            newcon-&gt;index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;setup == <span class="hljs-literal">NULL</span> ||<br>            newcon-&gt;setup(newcon, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">0</span>) &#123;<br>            newcon-&gt;flags |= CON_ENABLED;<br>            <span class="hljs-keyword">if</span> (newcon-&gt;device) &#123;<br>                newcon-&gt;flags |= CON_CONSDEV;<br>                preferred_console = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-comment">//æ£€æŸ¥newconæ˜¯å¦æ˜¯cmdlineæŒ‡å®šçš„consoleï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä½¿èƒ½(CON_ENABLE)å¹¶åˆå§‹åŒ–è¯¥console</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_CMDLINECONSOLES &amp;&amp; console_cmdline[i].name[<span class="hljs-number">0</span>];<br>            i++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(console_cmdline[i].name, newcon-&gt;name) != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &gt;= <span class="hljs-number">0</span> &amp;&amp;<br>            newcon-&gt;index != console_cmdline[i].index)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;index &lt; <span class="hljs-number">0</span>)<br>            newcon-&gt;index = console_cmdline[i].index;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;setup &amp;&amp;<br>            newcon-&gt;setup(newcon, console_cmdline[i].options) != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">break</span>;<br>        newcon-&gt;flags |= CON_ENABLED;<br>        newcon-&gt;index = console_cmdline[i].index;<br>        <span class="hljs-keyword">if</span> (i == selected_console) &#123;<br>            <span class="hljs-comment">//å¦‚æœnewconæ˜¯cmdlineæŒ‡å®šçš„æœ€æ–°çš„consoleï¼Œåˆ™ç½®ä½CONSDEV</span><br>            newcon-&gt;flags |= CON_CONSDEV;<br>            preferred_console = selected_console;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">//è¯¥consoleæ²¡æœ‰ä½¿èƒ½ï¼Œé€€å‡º</span><br>    <span class="hljs-keyword">if</span> (!(newcon-&gt;flags &amp; CON_ENABLED))<br>        <span class="hljs-keyword">return</span>;<br> <br>    <span class="hljs-comment">//å¦‚æœæœ‰bootconsoleï¼Œåˆ™newconä¸éœ€è¦è¾“å‡ºregisterä¹‹å‰çš„logï¼Œå› ä¸ºå¦‚æœbootconsoleå’Œnewconæ˜¯åŒä¸€ä¸ªè®¾å¤‡</span><br>    <span class="hljs-comment">//åˆ™ä¹‹å‰çš„logå°±è¾“å‡º2æ¬¡</span><br>    <span class="hljs-keyword">if</span> (bcon &amp;&amp; ((newcon-&gt;flags &amp; (CON_CONSDEV | CON_BOOT)) == CON_CONSDEV))<br>        newcon-&gt;flags &amp;= ~CON_PRINTBUFFER;<br> <br>    <span class="hljs-comment">//æŠŠnewconåŠ å…¥console_driversé“¾è¡¨ï¼Œå¯¹äºç½®ä½CON_CONSDEVçš„conï¼Œæ”¾åœ¨é“¾è¡¨é¦–</span><br>    console_lock();<br>    <span class="hljs-keyword">if</span> ((newcon-&gt;flags &amp; CON_CONSDEV) || console_drivers == <span class="hljs-literal">NULL</span>) &#123;<br>        newcon-&gt;next = console_drivers;<br>        console_drivers = newcon;<br>        <span class="hljs-keyword">if</span> (newcon-&gt;next)<br>            newcon-&gt;next-&gt;flags &amp;= ~CON_CONSDEV;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        newcon-&gt;next = console_drivers-&gt;next;<br>        console_drivers-&gt;next = newcon;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (newcon-&gt;flags &amp; CON_PRINTBUFFER) &#123;<br>        <span class="hljs-comment">//å¦‚æœnewconç½®ä½PRINTBUFFER,åˆ™å°†logå…¨éƒ¨åˆ·å‡º</span><br>        raw_spin_lock_irqsave(&amp;logbuf_lock, flags);<br>        con_start = log_start;<br>        raw_spin_unlock_irqrestore(&amp;logbuf_lock, flags);<br>        <span class="hljs-comment">//ä¿®æ”¹printkè¾“å‡ºçš„æŒ‡å®šå”¯ä¸€exclusive_consoleä¸ºnewcon</span><br>        <span class="hljs-comment">//ä¿è¯å°†ä¹‹å‰çš„logåªè¾“å‡ºåˆ°newcon</span><br>        exclusive_console = newcon;<br>    &#125;<br>    <span class="hljs-comment">//è§£é”consoleï¼Œåˆ·å‡ºlogåˆ°newcon</span><br>    console_unlock();<br>    console_sysfs_notify();<br> <br>    <span class="hljs-comment">//å¦‚æœæœ‰bootconsoleï¼Œåˆ™unregister bootconsoleï¼ˆä»console_driversä¸­åˆ æ‰ï¼‰</span><br>    <span class="hljs-comment">//å¹¶å‘Šè¯‰ä½¿ç”¨è€…ç°åœ¨consoleåˆ‡æ¢</span><br>    <span class="hljs-keyword">if</span> (bcon &amp;&amp;<br>        ((newcon-&gt;flags &amp; (CON_CONSDEV | CON_BOOT)) == CON_CONSDEV) &amp;&amp;<br>        !keep_bootcon) &#123;<br>        printk(KERN_INFO <span class="hljs-string">&quot;console [%s%d] enabled, bootconsole disabled\n&quot;</span>,<br>            newcon-&gt;name, newcon-&gt;index);<br>        for_each_console(bcon)<br>            <span class="hljs-keyword">if</span> (bcon-&gt;flags &amp; CON_BOOT)<br>                unregister_console(bcon);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        printk(KERN_INFO <span class="hljs-string">&quot;%sconsole [%s%d] enabled\n&quot;</span>,<br>            (newcon-&gt;flags &amp; CON_BOOT) ? <span class="hljs-string">&quot;boot&quot;</span> : <span class="hljs-string">&quot;&quot;</span> ,<br>            newcon-&gt;name, newcon-&gt;index);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¹‹å‰æ³¨å†Œäº†bootconsoleï¼Œåˆ™ä¸ä¼šå°†è¯¥æ¬¡registerä¹‹å‰çš„logåˆ·å‡ºï¼Œé˜²æ­¢bootconsoleå’Œè¯¥æ¬¡æ³¨å†Œçš„newconæ˜¯åŒä¸€ä¸ªç‰©ç†è®¾å¤‡æ—¶ï¼Œlogæ‰“å°2æ¬¡ã€‚</p><p>å¦‚æœæ²¡æœ‰bootconsoleï¼Œåˆ™ä¼šæŒ‡å®šexclusive_console&#x3D;newconï¼Œconsole_unlockæ—¶ï¼Œåˆ·æ–°å…¨éƒ¨logåˆ°è¯¥æŒ‡å®šexclusive consoleã€‚</p><p>console_unlockç»“æŸæ—¶ä¼šå°†exclusive_consoleç½®NULLï¼Œæ‰€ä»¥exclusive consoleé»˜è®¤æƒ…å†µä¸‹å°±æ˜¯NULLã€‚</p><p>æœ€åä¼šunregister bootconsoleï¼Œæ˜¯å°†bootconsoleä»console_driversä¸­åˆ é™¤ï¼Œè¿™æ ·ä¹‹åçš„printkå°±ä¸ä¼šå‘bootconsoleè¾“å‡ºäº†ã€‚</p><p>æœ‰æ„æ€çš„ä¸€ä¸ªåœ°æ–¹æ˜¯ï¼Œåœ¨unregister bootconsoleä¹‹å‰çš„printkï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">printk(KERN_INFO <span class="hljs-string">&quot;console [%s%d] enabled, bootconsole disabled\n&quot;</span>,<br>            newcon-&gt;name, newcon-&gt;index);<br></code></pre></td></tr></table></figure><p><u>å› ä¸ºæ­¤æ—¶bootconsoleè¿˜æ²¡åˆ æ‰ï¼Œè€Œnewconsoleå·²ç»åŠ å…¥console_driversï¼Œå¦‚æœbootconsoleå’Œnewconsoleæ˜¯åŒä¸€ä¸ªç‰©ç†è®¾å¤‡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™å¥printkä¼šå‡ºç°2æ¬¡å“¦ï¼</u></p><p>å¦‚æœåœ¨cmdlineæŒ‡å®š2ä¸ªI&#x2F;Oè®¾å¤‡ï¼Œå¦‚<code>&quot;console==ttyS0,115200 console=ttyS1,115200&quot;</code>ï¼Œå› ttySè®¾å¤‡éƒ½æ˜¯serial driverä¸­æ³¨å†Œçš„real consoleï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°kernelçš„æ‰“å°åˆ†åˆ«å‡ºç°åœ¨2ä¸ªä¸²å£ä¸Šï¼</p><p><u><strong>boot console</strong>å’Œ<strong>real console</strong>å·®åˆ«åœ¨äºbootconsoleæ³¨å†Œäºkernelå¯åŠ¨æ—©æœŸï¼Œæ–¹ä¾¿å¯¹äºkernelæ—©æœŸå¯åŠ¨è¿›è¡Œè°ƒè¯•æ‰“å°ã€‚</u></p><p>é‚£è¿™äº›consoleæ˜¯åœ¨å“ªé‡Œè°ƒç”¨register_consoleè¿›è¡Œæ³¨å†Œçš„ï¼Ÿ</p><ul><li><p>bootconsoleçš„æ³¨å†Œï¼Œå¦‚arch&#x2F;arm&#x2F;kernel&#x2F;early_printk.cï¼Œæ˜¯åœ¨parse_argså‚æ•°è§£æé˜¶æ®µæ³¨å†Œbootconsoleã€‚</p><ul><li>åœ¨start_kernelä¸­console_initå‡½æ•°ä¹Ÿä¼šéå†.con_initcall.initæ®µä¸­æ‰€æœ‰æ³¨å†Œå‡½æ•°ï¼Œè€Œè¿™äº›æ³¨å†Œå‡½æ•°ä¹Ÿå¯ä»¥æ¥æ³¨å†Œbootconsoleã€‚</li><li>.con_initcall.initæ®µä¸­å‡½æ•°çš„æ³¨å†Œå¯ä»¥ä½¿ç”¨å®å®šä¹‰console_initcallã€‚è¿™äº›å‡½æ•°ä¸­è°ƒç”¨register_consoleï¼Œæ–¹ä¾¿åœ¨kernelåˆæœŸå®ç°printkæ‰“å°ã€‚</li></ul></li><li><p>realconsoleçš„æ³¨å†Œï¼Œæ˜¯åœ¨å„ä¸ªdriverï¼Œå¦‚serialåŠ è½½æ—¶å®Œæˆã€‚</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€è½¬è½½ã€‘linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†</title>
    <link href="/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/"/>
    <url>/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/</url>
    
    <content type="html"><![CDATA[<h1 id="linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†"><a href="#linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†" class="headerlink" title="linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†"></a>linuxå†…æ ¸è¾“å‡ºçš„æ—¥å¿—å»å“ªé‡Œäº†</h1><blockquote><p>ğŸ•è½¬è½½è‡ªï¼š<a href="https://mp.weixin.qq.com/s/mdDLw6AIp9ws9LTaHg64pg">https://mp.weixin.qq.com/s/mdDLw6AIp9ws9LTaHg64pg</a></p><p>ğŸ¥¯æ„Ÿè°¢å¤§ä½¬ç²¾å½©çš„æ–‡ç« ï¼ï¼ï¼</p></blockquote><p><img src="/2023/02/21/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91linux%E5%86%85%E6%A0%B8%E8%BE%93%E5%87%BA%E7%9A%84%E6%97%A5%E5%BF%97%E5%8E%BB%E5%93%AA%E9%87%8C%E4%BA%86/image-20230221230542976.png" alt="image-20230221230542976">æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™å¼ å›¾ï¼Œæ¥ç†è§£printkçš„æ•´ä½“æ¶æ„ã€‚</p><h2 id="1-printkå®ç°ç®€è¿°"><a href="#1-printkå®ç°ç®€è¿°" class="headerlink" title="1.printkå®ç°ç®€è¿°"></a>1.printkå®ç°ç®€è¿°</h2><h3 id="1-1-å†…æ ¸æ€printk"><a href="#1-1-å†…æ ¸æ€printk" class="headerlink" title="1.1 å†…æ ¸æ€printk"></a>1.1 å†…æ ¸æ€printk</h3><p>åœ¨å†…æ ¸ç¼–ç æ—¶ï¼Œå¦‚æœæƒ³è¦è¾“å‡ºä¸€äº›ä¿¡æ¯ï¼Œé€šå¸¸å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨printkï¼Œè€Œæ˜¯ä¼šä½¿ç”¨å…¶è¡ç”Ÿå‡½æ•°ï¼Œæ¯”å¦‚ pr_err &#x2F; pr_info &#x2F; pr_debug ç­‰ï¼Œè¿™äº›è¡ç”Ÿå‡½æ•°é™„å¸¦äº†æ—¥å¿—çº§åˆ«ã€æ‰€å±æ¨¡å—ç­‰å…¶ä»–ä¿¡æ¯ï¼Œæ¯”è¾ƒå‹å¥½ï¼Œä½†å…¶æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†printkã€‚</p><p>printkå‡½æ•°ä¼šå°†æ¯æ¬¡è¾“å‡ºçš„æ—¥å¿—ï¼Œæ”¾åˆ°å†…æ ¸ä¸ºå…¶ä¸“é—¨åˆ†é…çš„åä¸º<strong>ring buffer</strong>çš„ä¸€ä¸ªæ§½ä½é‡Œã€‚</p><ul><li><p>ring bufferå…¶å®å°±æ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œä¸è¿‡æ—¢ç„¶æ˜¯ç¯å½¢é˜Ÿåˆ—ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå³å½“ring bufferæ»¡äº†çš„æ—¶å€™ï¼Œä¸‹ä¸€æ¡æ–°çš„æ—¥å¿—ï¼Œä¼šè¦†ç›–æœ€å¼€å§‹çš„æ—§çš„æ—¥å¿—ã€‚</p></li><li><p>ring bufferçš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸å‚æ•°æ¥ä¿®æ”¹ã€‚</p></li><li><p>printkåœ¨å°†æ—¥å¿—æ”¾åˆ°ring bufferåï¼Œä¼šå†è°ƒç”¨ç³»ç»Ÿconsoleçš„ç›¸å…³æ–¹æ³•ï¼Œå°†è¿˜æœªè¾“å‡ºåˆ°ç³»ç»Ÿæ§åˆ¶å°çš„æ¶ˆæ¯ï¼Œç»§ç»­è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¿™ä¸ªåé¢ä¼šè¯¦ç»†è¯´ï¼Œè¿™é‡Œå°±æš‚ä¸èµ˜è¿°ã€‚</p></li></ul><p>ä»¥ä¸Šå°±æ˜¯printkåœ¨å†…æ ¸æ€çš„å®ç°ã€‚</p><h3 id="1-2-ç”¨æˆ·æ€printk"><a href="#1-2-ç”¨æˆ·æ€printk" class="headerlink" title="1.2 ç”¨æˆ·æ€printk"></a>1.2 ç”¨æˆ·æ€printk</h3><p>åœ¨ç”¨æˆ·æ€ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªæ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹printkè¾“å‡ºçš„å†…æ ¸æ—¥å¿—ï¼Œæ¯”å¦‚ä½¿ç”¨dmesgå‘½ä»¤ï¼Œcat &#x2F;proc&#x2F;kmsgæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨klogctlå‡½æ•°ç­‰ï¼Œè¿™äº›æ–¹å¼åˆ†åˆ«å¯¹åº”äºå…¨æ™¯å›¾ä¸­ç”¨æˆ·æ€çš„æ©™è‰²ã€ç»¿è‰²ã€å’Œè“è‰²çš„éƒ¨åˆ†ã€‚</p><p><strong>ï¼ˆ1ï¼‰dmesgå‘½ä»¤</strong></p><p><strong>dmesgå‘½ä»¤ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯é€šè¿‡è¯»å–&#x2F;dev&#x2F;kmsgæ–‡ä»¶</strong>ï¼Œæ¥å®ç°æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„ã€‚</p><p>å½“è¯¥å‘½ä»¤è¿è¡Œæ—¶ï¼Œdmesgä¼šå…ˆè°ƒç”¨openå‡½æ•°ï¼Œæ‰“å¼€&#x2F;dev&#x2F;kmsgæ–‡ä»¶ï¼Œè¯¥æ‰“å¼€æ“ä½œåœ¨å†…æ ¸ä¸­çš„é€»è¾‘ï¼Œä¼šä¸ºdmesgåˆ†é…ä¸€ä¸ªfileå®ä¾‹ï¼Œåœ¨è¿™ä¸ªfileå®ä¾‹é‡Œï¼Œä¼šæœ‰ä¸€ä¸ªseqå˜é‡ï¼Œè¯¥å˜é‡è®°å½•ç€ä¸‹ä¸€æ¡è¦è¯»å–çš„å†…æ ¸æ—¥å¿—åœ¨ring bufferä¸­çš„ä½ç½®ã€‚</p><p>åˆšæ‰“å¼€&#x2F;dev&#x2F;kmsgæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªseqæŒ‡å‘çš„å°±æ˜¯ring bufferä¸­æœ€å¼€å§‹çš„é‚£æ¡æ—¥å¿—ã€‚</p><p>ä¹‹åï¼Œdmesgä¼šä»¥æ‰“å¼€çš„&#x2F;dev&#x2F;kmsgæ–‡ä»¶ä¸ºåª’ä»‹ï¼Œä¸æ–­çš„è°ƒç”¨readå‡½æ•°ï¼Œä»å†…æ ¸ä¸­è¯»å–æ—¥å¿—æ¶ˆæ¯ï¼Œæ¯è¯»å–å‡ºä¸€æ¡ï¼Œseqçš„å€¼éƒ½ä¼šåŠ ä¸€ï¼Œå³æŒ‡å‘ä¸‹ä¸€æ¡æ—¥å¿—çš„ä½ç½®ï¼Œä¾æ¬¡å¾€å¤ï¼Œç›´åˆ°æ‰€æœ‰çš„å†…æ ¸æ—¥å¿—è¯»å–å®Œæ¯•ï¼Œdmesgé€€å‡ºã€‚</p><p>ä»¥ä¸Šå°±æ˜¯dmesgçš„ä¸»ä½“å®ç°ã€‚</p><p><strong>ï¼ˆ2ï¼‰cat &#x2F;proc&#x2F;kmsg å‘½ä»¤</strong></p><p>ç¬¬äºŒç§æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡ cat &#x2F;proc&#x2F;kmsg å‘½ä»¤ã€‚</p><p>è¯¥å‘½ä»¤å’Œdmesgå‘½ä»¤çš„å®ç°æœºåˆ¶åŸºæœ¬ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡è¯»æ–‡ä»¶ï¼Œåªä¸è¿‡catè¯»å–çš„æ˜¯&#x2F;proc&#x2F;kmsgæ–‡ä»¶ï¼Œè€Œdmesgè¯»å–çš„æ˜¯&#x2F;dev&#x2F;kmsgæ–‡ä»¶ã€‚</p><p>è¯»å–è¿™ä¸¤ä¸ªæ–‡ä»¶æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œ&#x2F;dev&#x2F;kmsgæ–‡ä»¶æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œå†…æ ¸éƒ½ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå•ç‹¬çš„seqå˜é‡ï¼Œè€Œ&#x2F;proc&#x2F;kmsgæ–‡ä»¶æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå…¨å±€çš„é™æ€seqå˜é‡ï¼Œå«åšsyslog_seqã€‚</p><p>syslog_seqæŒ‡å‘çš„ä¹Ÿæ˜¯ä¸‹ä¸€æ¡è¦è¯»å–çš„å†…æ ¸æ—¥å¿—åœ¨ring bufferä¸­çš„ä½ç½®ï¼Œä½†å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¨å±€çš„é™æ€å˜é‡ï¼Œå½“æœ‰å¤šä¸ªè¿›ç¨‹è¦è¯»å–&#x2F;proc&#x2F;kmsgæ–‡ä»¶æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œå³å†…æ ¸æ—¥å¿—ä¼šè¢«è¿™å‡ ä¸ªè¿›ç¨‹éšæœºæŠ¢å è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªè¿›ç¨‹è¯»åˆ°çš„éƒ½æ˜¯æ•´ä¸ªå†…æ ¸æ—¥å¿—çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ä¸å®Œæ•´çš„ï¼Œè¿™ä¹Ÿæ˜¯dmesgå‘½ä»¤é»˜è®¤ä¸ä½¿ç”¨&#x2F;proc&#x2F;kmsgæ–‡ä»¶çš„åŸå› ã€‚</p><p><strong>ï¼ˆ3ï¼‰klogctlå‡½æ•°</strong></p><p>ç¬¬ä¸‰ç§æŸ¥çœ‹å†…æ ¸æ—¥å¿—çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡klogctlå‡½æ•°ã€‚</p><p>è¯¥å‡½æ•°æ˜¯glibcå¯¹syslogç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªç®€å•å°è£…ï¼Œå…¶å…·ä½“ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒå…¨æ™¯å›¾ä¸­ç”¨æˆ·æ€çš„è“è‰²éƒ¨åˆ†ã€‚</p><p>klogctlå‡½æ•°å¯ä»¥æŒ‡å®šå¾ˆå¤šå‘½ä»¤ï¼Œåœ¨ä¸Šå›¾çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯SYSLOG_ACTION_READå‘½ä»¤ï¼Œä»¥æ­¤æ¥æ¨¡æ‹Ÿ cat &#x2F;proc&#x2F;kmsg è¡Œä¸ºã€‚</p><p>å…¶å®åœ¨å†…æ ¸å±‚é¢ï¼Œcat &#x2F;proc&#x2F;kmsgå‘½ä»¤ï¼Œä½¿ç”¨çš„å°±æ˜¯klogctlå¯¹åº”çš„syslogç³»ç»Ÿè°ƒç”¨çš„SYSLOG_ACTION_READå‘½ä»¤çš„å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥ç¤ºä¾‹ä¸­çš„klogctlå‡½æ•°ç›¸å…³ä»£ç ï¼Œå’Œ cat &#x2F;proc&#x2F;kmsg å‘½ä»¤å…¶å®æ˜¯ç­‰ä»·çš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œklogctlå‡½æ•°åœ¨å†…æ ¸é‡Œä½¿ç”¨çš„ä¹Ÿæ˜¯syslog_seqå˜é‡ï¼Œå®ƒä¹Ÿæœ‰å’Œ&#x2F;proc&#x2F;kmsgæ–‡ä»¶åŒæ ·çš„é—®é¢˜ã€‚</p><p><strong>ï¼ˆ4ï¼‰ç³»ç»Ÿæ§åˆ¶å°</strong></p><p>å…¶å®è¿˜æœ‰ä¸€ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼Œå°±æ˜¯é€šè¿‡ç³»ç»Ÿæ§åˆ¶å°ã€‚</p><p>ä½†è¿™ç§æ–¹å¼å’Œå‰é¢è®²çš„ä¸‰ç§æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯å®Œå…¨è¢«åŠ¨çš„ï¼Œæ˜¯å†…æ ¸åœ¨è°ƒç”¨printkå‡½æ•°ï¼Œå°†æ—¥å¿—ä¿¡æ¯æ”¾åˆ°ring bufferåï¼Œå†å»é€šçŸ¥ç³»ç»Ÿæ§åˆ¶å°ï¼Œå‘ŠçŸ¥å…¶å¯ä»¥è¾“å‡ºè¿™äº›æ—¥å¿—ã€‚</p><p>ç³»ç»Ÿæ§åˆ¶å°ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªconsole_seqå˜é‡ï¼Œè®°å½•ä¸‹ä¸€æ¡è¦è¾“å‡ºå†…æ ¸æ—¥å¿—çš„æ‰€åœ¨ä½ç½®ã€‚</p><p>ç³»ç»Ÿæ§åˆ¶å°è¾“å‡ºçš„å†…å®¹ï¼Œæ˜¯è¢«æ—¥å¿—çº§åˆ«è¿‡æ»¤è¿‡çš„ï¼Œå†…æ ¸é»˜è®¤çš„æ—¥å¿—è¿‡æ»¤çº§åˆ«æ˜¯7ï¼Œå³debugçº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—ï¼Œæ¯”å¦‚info &#x2F; err ç­‰ï¼Œè¿™äº›éƒ½ä¼šè¾“å‡ºï¼Œä½†debugçº§åˆ«ä¸ä¼šè¾“å‡ºã€‚</p><p>è¯¥æ—¥å¿—è¿‡æ»¤çº§åˆ«ï¼Œå¯ä»¥é€šè¿‡å¾ˆå¤šæ–¹å¼æ”¹å˜ï¼Œæ¯”å¦‚è¯´ï¼Œå¯ä»¥é€šè¿‡å†…æ ¸å‚æ•° loglevelï¼Œæ‰€ä»¥ï¼Œå¦‚æœå‘ç°ç³»ç»Ÿæ§åˆ¶å°æ²¡æœ‰è¾“å‡ºæƒ³è¦çš„æ—¥å¿—ä¿¡æ¯ï¼Œå…ˆçœ‹ä¸‹å…¶æ˜¯å¦è¢«è¿‡æ»¤æ‰äº†ã€‚</p><h2 id="2-kernelæ—¥å¿—è°ƒè¯•è®¾ç½®"><a href="#2-kernelæ—¥å¿—è°ƒè¯•è®¾ç½®" class="headerlink" title="2.kernelæ—¥å¿—è°ƒè¯•è®¾ç½®"></a>2.kernelæ—¥å¿—è°ƒè¯•è®¾ç½®</h2><h3 id="2-1-æŸ¥çœ‹æ—¥å¿—çº§åˆ«"><a href="#2-1-æŸ¥çœ‹æ—¥å¿—çº§åˆ«" class="headerlink" title="2.1 æŸ¥çœ‹æ—¥å¿—çº§åˆ«"></a>2.1 æŸ¥çœ‹æ—¥å¿—çº§åˆ«</h3><p>è¾“å…¥<code>cat proc/sys/kernel/printk</code></p><p>è¿™å››ä¸ªæ•°å­—ä¾æ¬¡å¯¹åº” console_loglevelï¼Œdefault_message_loglevelï¼Œminimum_console_loglevelï¼Œdefault_console_loglevelã€‚</p><ul><li><p><strong>console_loglevelï¼š</strong>æ§åˆ¶å°ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ï¼›</p></li><li><p><strong>default_message_loglevelï¼š</strong>è°ƒç”¨ printk() æœªæŒ‡å®šæ—¥å¿—çº§åˆ«æ—¶ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ï¼›</p></li><li><p><strong>minimum_console_loglevelï¼š</strong>å…è®¸è®¾ç½®çš„æ§åˆ¶å°æ—¥å¿—çº§åˆ«ï¼ˆconsole_loglevelï¼‰æœ€å°å€¼ï¼›</p></li><li><p><strong>default_console_loglevelï¼š</strong>ç³»ç»Ÿå¯åŠ¨æ—¶ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ã€‚</p></li></ul><h3 id="2-2-ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«"><a href="#2-2-ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«" class="headerlink" title="2.2 ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«"></a>2.2 ä¿®æ”¹kernelæ—¥å¿—çº§åˆ«</h3><p>ï¼ˆ1ï¼‰æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯ï¼š<code>echo xxx &gt; proc/sys/kernel/printk</code>ï¼Œå…¶ä½™æ–¹å¼å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_34597963/article/details/128669281">https://blog.csdn.net/qq_34597963/article/details/128669281</a></p><p>æ—¥å¿—çº§åˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_EMERG      KERN_SOH <span class="hljs-string">&quot;0&quot;</span>    /* system is unusable */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_ALERT      KERN_SOH <span class="hljs-string">&quot;1&quot;</span>    /* action must be taken immediately */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_CRIT       KERN_SOH <span class="hljs-string">&quot;2&quot;</span>    /* critical conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_ERR        KERN_SOH <span class="hljs-string">&quot;3&quot;</span>    /* error conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_WARNING    KERN_SOH <span class="hljs-string">&quot;4&quot;</span>    /* warning conditions */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_NOTICE     KERN_SOH <span class="hljs-string">&quot;5&quot;</span>    /* normal but significant condition */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_INFO       KERN_SOH <span class="hljs-string">&quot;6&quot;</span>    /* informational */</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define KERN_DEBUG      KERN_SOH <span class="hljs-string">&quot;7&quot;</span>    /* debug-level messages */</span><br><br>-----------------<br><br>è‡´å‘½çº§(KERN_EMESG),<br>è­¦æˆ’çº§(KERN_ALERT),<br>ä¸´ç•Œçº§(KERN_CRIT),<br>é”™è¯¯çº§(KERN_ERR),<br>å‘Šè­¦çº§(KERN_WARN)<br>æ³¨æ„çº§(KERN_NOTICE),<br>é€šçŸ¥çº§(KERN_INFO),<br>è°ƒè¯•çº§(KERN_DEBUG).<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åœ¨kernelä¸­ä¿®æ”¹logé»˜è®¤ç­‰çº§</p><p>æ‰¾åˆ°<code>/include/linux/printk.h</code>ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">console_verbose</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">console_loglevel = CONSOLE_LOGLEVEL_MIN; <span class="hljs-comment">//CONSOLE_LOGLEVEL_MOTORMOUTH;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-Android-Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨"><a href="#2-3-Android-Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨" class="headerlink" title="2.3 Android Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨"></a>2.3 Android Initè¿›ç¨‹æ—¥å¿—æ‰“å°ä¸å…¨</h3><blockquote><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/superlee1125/article/details/114099144?spm=1001.2014.3001.5506">https://blog.csdn.net/superlee1125/article/details/114099144?spm=1001.2014.3001.5506</a></p></blockquote><p>åœ¨æŠ“Androidå†…æ ¸çš„logæ—¶ï¼Œinitè¿›ç¨‹çš„logå¾€å¾€æ‰“å°ä¸å…¨ï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸é™åˆ¶äº†logçš„è¾“å‡ºï¼Œåœ¨å†…æ ¸ä»£ç ä¸­æ‰¾åˆ°ä¸‹é¢çš„æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§ä¸‹é¢çš„æç¤ºæŠŠä»£ç æ³¨é‡Šæ‰ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œå†åˆ·åˆ°è®¾å¤‡ä¸­ï¼Œinitè¿›ç¨‹çš„æ‰“å°å°±å®Œæ•´äº†ã€‚</p><p>å†…æ ¸ä»£ç ä¸­æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ <code>kernel/printk/printk.c</code>ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">devkmsg_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br></code></pre></td></tr></table></figure><p>æ³¨é‡Šæ‰ä¸‹é¢è¿™ä¸¤å¥è¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* Ratelimit when not explicitly enabled. */</span><br>    <span class="hljs-keyword">if</span> (!(devkmsg_log &amp; DEVKMSG_LOG_MASK_ON)) &#123;<br>-       <span class="hljs-keyword">if</span> (!___ratelimit(&amp;user-&gt;rs, current-&gt;comm))<br>-           <span class="hljs-keyword">return</span> ret;<br>+       <span class="hljs-comment">//if (!___ratelimit(&amp;user-&gt;rs, current-&gt;comm))</span><br>+           <span class="hljs-comment">//return ret;</span><br>    &#125;<br>    buf = kmalloc(len+<span class="hljs-number">1</span>, GFP_KERNEL);<br></code></pre></td></tr></table></figure><h3 id="2-4-Androidä¿®æ”¹æ—¥å¿—çº§åˆ«"><a href="#2-4-Androidä¿®æ”¹æ—¥å¿—çº§åˆ«" class="headerlink" title="2.4 Androidä¿®æ”¹æ—¥å¿—çº§åˆ«"></a>2.4 Androidä¿®æ”¹æ—¥å¿—çº§åˆ«</h3><p>ä»¥Android 10.0 qcomå¹³å°ä¸ºä¾‹ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š<code>device/qcom/common/rootdir/etc/init.qcom.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">case &quot;$buildvariant&quot; in<br>    &quot;userdebug&quot; | &quot;eng&quot;)<br>        #set default loglevel to KERN_INFO<br>        echo &quot;6 6 1 7&quot; &gt; /proc/sys/kernel/printk  ##### æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹<br><br>        ;;<br>    *)<br>        #set default loglevel to KERN_WARNING<br>        echo &quot;4 4 1 4&quot; &gt; /proc/sys/kernel/printk<br>        ;;<br>esac<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Androidé€šç”¨å†…æ ¸GKI</title>
    <link href="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/"/>
    <url>/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/</url>
    
    <content type="html"><![CDATA[<h1 id="Androidé€šç”¨å†…æ ¸GKI"><a href="#Androidé€šç”¨å†…æ ¸GKI" class="headerlink" title="Androidé€šç”¨å†…æ ¸GKI"></a>Androidé€šç”¨å†…æ ¸GKI</h1><h2 id="1-GKIæ¦‚è¿°"><a href="#1-GKIæ¦‚è¿°" class="headerlink" title="1.GKIæ¦‚è¿°"></a>1.GKIæ¦‚è¿°</h2><p><strong>å¿«é€Ÿäº†è§£</strong>ï¼š GKIå…¨ç§°ä¸ºGeneric kernel Imageã€‚è‡ª2019å¹´å¼€å§‹ï¼Œæ¥è‡ªGoogle Androidçš„Kernel teamç»è¿‡å¤šå¹´å‡†å¤‡ï¼Œå¼€å§‹åœ¨Android 11.0çš„ç ”å‘ç‰ˆæœ¬ä¸Šæ¨è¡ŒGKIè®¾è®¡ã€‚GKIçš„ç›®æ ‡åœ¨äºæ¶ˆé™¤Androidé˜µè¥Linux Kernelçš„ç¢ç‰‡åŒ–çŠ¶æ€ã€‚ <strong>GKIçš„ç»ˆæç›®æ ‡æ˜¯ç”±Googleç»Ÿä¸€å‘å¸ƒboot.imageé•œåƒç»™å…¨çƒç”¨æˆ·ä½¿ç”¨</strong>ã€‚GKIæ˜¯Google Trebleé¡¹ç›®çš„é‡è¦ä¸¾æªä¹‹ä¸€ã€‚</p><h3 id="1-1-è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI"><a href="#1-1-è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI" class="headerlink" title="1.1 è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI"></a>1.1 è°·æ­Œä¸ºä»€ä¹ˆè¦æå‡ºGKI</h3><p>ç›´æ¥æ¬è¿å®˜ç½‘ï¼Œè®²çš„å¤ªè¯¦ç»†äº†ã€‚</p><p><u><strong>Android é€šç”¨å†…æ ¸ (ACK)</strong></u> æ˜¯æ‰€æœ‰ Android äº§å“å†…æ ¸çš„åŸºç¡€ã€‚ä¾›åº”å•†å†…æ ¸å’Œè®¾å¤‡å†…æ ¸ä½äº ACK çš„ä¸‹æ¸¸ã€‚ä¾›åº”å•†é€šè¿‡ä¿®æ”¹å†…æ ¸æºä»£ç å¹¶æ·»åŠ è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œæ·»åŠ äº†å¯¹ SoC å’Œå¤–å›´è®¾å¤‡çš„æ”¯æŒã€‚è¿™äº›ä¿®æ”¹å†…å®¹å¯èƒ½å¾ˆå¤šï¼Œä»¥è‡³äºè®¾å¤‡ä¸Šè¿è¡Œçš„ä»£ç ä¸­æœ‰å¤šè¾¾ 50% æ˜¯æ ‘å¤–ä»£ç ï¼ˆå¹¶éæ¥è‡ªä¸Šæ¸¸ Linux å’Œ AOSP é€šç”¨å†…æ ¸ï¼‰ã€‚</p><p>å› æ­¤ï¼Œè®¾å¤‡å†…æ ¸ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ä¸Šæ¸¸ï¼šæ¥è‡ª kernel.org çš„ Linux å†…æ ¸</li><li>AOSPï¼šAOSP é€šç”¨å†…æ ¸çš„å…¶ä»– Android ä¸“ç”¨è¡¥ä¸ç¨‹åº</li><li>ä¾›åº”å•†ï¼šä¾›åº”å•†æä¾›çš„ SoC å’Œå¤–å›´è®¾å¤‡æ”¯æŒä»¥åŠä¼˜åŒ–è¡¥ä¸ç¨‹åº</li><li>åŸå§‹è®¾å¤‡åˆ¶é€ å•† (OEM)&#x2F;è®¾å¤‡ï¼šå…¶ä»–è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œè‡ªå®šä¹‰é¡¹</li></ul><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230217234034047.png" alt="image-20230217234034047" style="zoom: 67%;"><p>Kernelä»Linuxåˆ†æ”¯ä¸€è·¯åˆ°OEMå‚å•†ï¼Œä¸æ–­è¿›è¡Œä¿®æ”¹ï¼Œå…¨çƒè¿™ä¹ˆå¤švendorå‚å•†ï¼Œè¿™ä¹ˆå¤šoemå‚å•†ï¼Œæ¯å®¶éƒ½æ¥è¿™ä¹ˆä¸€å¥—è‡ªå·±çš„kernelï¼Œç¢ç‰‡åŒ–å¤ªå¤ªå¤ªä¸¥é‡äº†ï¼Œè°·æ­ŒçœŸçš„å¾ˆéš¾ç»´æŠ¤ã€‚ç”¨å®˜ç½‘çš„è¯ï¼Œ<strong>å†…æ ¸ç¢ç‰‡åŒ–ä¼šå¯¹ Android ç¤¾åŒºäº§ç”Ÿè‹¥å¹²è´Ÿé¢å½±å“</strong>ã€‚</p><ul><li>å®‰å…¨æ›´æ–°éœ€è¦è€—è´¹å¤§é‡äººåŠ›<ul><li>Android å®‰å…¨å…¬å‘Š (ASB) ä¸­å¼•ç”¨çš„å®‰å…¨è¡¥ä¸ç¨‹åºå¿…é¡»å‘åç§»æ¤åˆ°æ¯ä¸ªè®¾å¤‡å†…æ ¸ä¸­ã€‚ä½†æ˜¯ï¼Œç”±äºå­˜åœ¨å†…æ ¸ç¢ç‰‡åŒ–é—®é¢˜ï¼Œå‘æ­£å¸¸ä½¿ç”¨çš„ Android è®¾å¤‡ä¼ æ’­å®‰å…¨ä¿®å¤çš„ä»£ä»·éå¸¸ä¹‹é«˜ã€‚</li></ul></li><li>å¾ˆéš¾åˆå¹¶é•¿æœŸæ”¯æŒçš„æ›´æ–°<ul><li>é•¿æœŸæ”¯æŒ (LTS) ç‰ˆæœ¬åŒ…å«å®‰å…¨ä¿®å¤å’Œå…¶ä»–é‡å¤§é—®é¢˜ä¿®å¤ã€‚äº‹å®è¯æ˜ï¼Œä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬æ˜¯æä¾›å®‰å…¨ä¿®å¤çš„æœ€æœ‰æ•ˆæ–¹å¼ã€‚æˆ‘ä»¬å‘ç°ï¼ŒASB æŠ¥å‘Šçš„å†…æ ¸å®‰å…¨é—®é¢˜ä¸­æœ‰ 90% éƒ½å·²åœ¨ä¿æŒæœ€æ–°çŠ¶æ€çš„ Pixel è®¾å¤‡ä¸Šå¾—åˆ°ä¿®å¤ã€‚</li></ul></li><li>å¦¨ç¢ Android å¹³å°è¿›è¡Œç‰ˆæœ¬å‡çº§<ul><li>ç”±äºç¢ç‰‡åŒ–é—®é¢˜ï¼Œå¾ˆéš¾å‘æ­£å¸¸ä½¿ç”¨çš„è®¾å¤‡æ·»åŠ éœ€è¦æ›´æ”¹å†…æ ¸çš„ Android æ–°åŠŸèƒ½ã€‚Android æ¡†æ¶ä»£ç å¿…é¡»å‡è®¾æ”¯æŒçš„å†…æ ¸ç‰ˆæœ¬å¤šè¾¾ 5 ä¸ªï¼Œå¹¶ä¸”æ²¡æœ‰é’ˆå¯¹æ–°çš„å¹³å°ç‰ˆæœ¬è¿›è¡Œä»»ä½•å†…æ ¸æ›´æ”¹ï¼ˆAndroid 10 æ”¯æŒå†…æ ¸ç‰ˆæœ¬ 3.18ã€4.4ã€4.9ã€4.14 å’Œ 4.19ï¼›åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™äº›ç‰ˆæœ¬è‡ª 2017 å¹´ Android 8 å‘å¸ƒä»¥æ¥è¿˜æœªæ·»åŠ æ–°åŠŸèƒ½ï¼‰ã€‚</li></ul></li><li>å¾ˆéš¾å°†å†…æ ¸æ›´æ”¹è´¡çŒ®å›ä¸Šæ¸¸ Linux<ul><li>å¯¹å†…æ ¸è¿›è¡Œå®Œæ‰€æœ‰æ›´æ”¹åï¼Œå¤§å¤šæ•°æ——èˆ°è®¾å¤‡é™„å¸¦çš„å†…æ ¸ç‰ˆæœ¬å·²ç»è‡³å°‘å­˜åœ¨ 18 ä¸ªæœˆäº†ã€‚ä¾‹å¦‚ï¼Œ<code>kernel.org</code> äº 2017 å¹´ 11 æœˆå‘å¸ƒäº† 4.14 ç‰ˆå†…æ ¸ï¼Œè€Œé¦–æ‰¹ä½¿ç”¨ 4.14 ç‰ˆå†…æ ¸çš„ Android æ‰‹æœºäº 2019 å¹´æ˜¥å­£æ‰å‘å¸ƒã€‚</li><li>ä¸Šæ¸¸å†…æ ¸å‘å¸ƒä¸äº§å“å‘å¸ƒä¹‹é—´çš„è¿™ç§é•¿æ—¶é—´å»¶è¿Ÿå¯¼è‡´ Android ç¤¾åŒºå¾ˆéš¾å°†æ‰€éœ€çš„åŠŸèƒ½å’Œé©±åŠ¨ç¨‹åºé¦ˆé€åˆ°ä¸Šæ¸¸å†…æ ¸ä¸­ï¼Œå› æ­¤è§£å†³ç¢ç‰‡åŒ–é—®é¢˜å¹¶éæ˜“äº‹ã€‚</li></ul></li></ul><h3 id="1-2-è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–"><a href="#1-2-è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–" class="headerlink" title="1.2 è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–"></a>1.2 è°·æ­Œå¦‚ä½•è§£å†³ç¢ç‰‡åŒ–</h3><p>é€šç”¨å†…æ ¸æ˜ åƒ (GKI) é¡¹ç›®é€šè¿‡ç»Ÿä¸€æ ¸å¿ƒå†…æ ¸å¹¶å°† SoC å’Œæ¿çº§æ”¯æŒä»æ ¸å¿ƒå†…æ ¸ç§»è‡³å¯åŠ è½½æ¨¡å—ä¸­ï¼Œè§£å†³äº†å†…æ ¸ç¢ç‰‡åŒ–é—®é¢˜ã€‚GKI å†…æ ¸ä¸ºå†…æ ¸æ¨¡å—æä¾›äº†ç¨³å®šçš„å†…æ ¸æ¨¡å—æ¥å£ (KMI)ï¼Œå› æ­¤æ¨¡å—å’Œå†…æ ¸å¯ä»¥ç‹¬ç«‹è¿›è¡Œæ›´æ–°ã€‚</p> <img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230217234449847.png" style="zoom: 80%;"><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒGoogle ä¼šæä¾› KMI æ¥å£ï¼Œç”¨äº vendor modules å’Œ GKI çš„é€šè®¯ã€‚</p><blockquote><p>ç›´ç™½ç‚¹è¯´ï¼Œå°±æ˜¯è°·æ­ŒæŠŠæ‰€æœ‰é€šç”¨çš„Kernelæ”¾åœ¨äº†<code>Generic Kernel</code>é‡Œé¢ï¼ŒæŠŠé€šç”¨çš„Moudulesæ”¾åœ¨äº†<code>GKI Modules</code>é‡Œé¢ã€‚è€Œä¸ç¡¬ä»¶å¼ºç›¸å…³çš„ï¼Œä¸å„å‚å•†ç´§å¯†è”ç³»çš„æ¨¡å—æ”¾åœ¨äº†<code>Vendor Modules</code>é‡Œé¢ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Œæˆ‘ç”¨æˆ·å¯ä»¥å¿«é€Ÿå‡çº§ï¼Œåªè¦åˆ°è°·æ­Œå®˜ç½‘æ‰¾åˆ°æœ€æ–°çš„GKIï¼Œå°±å¯ä»¥ç”¨ä¸Šæœ€æ–°ï¼Œæœ€å®‰å…¨çš„Kernelï¼è€Œä¸ç¡¬ä»¶å¼ºç›¸å…³çš„ï¼Œæ™šç‚¹å‡çº§ä¹Ÿæ²¡äº‹ï¼Œæ—¢ç„¶æ‰‹æœºèƒ½ç”¨ï¼Œè¯´æ˜å„å¤§å‚å•†å¯¹äºé©±åŠ¨ç­‰æ—©å°±é€‚é…å¥½äº†ã€‚</p></blockquote><h3 id="1-3-GKIå‘å±•å†ç¨‹"><a href="#1-3-GKIå‘å±•å†ç¨‹" class="headerlink" title="1.3 GKIå‘å±•å†ç¨‹"></a>1.3 GKIå‘å±•å†ç¨‹</h3><p>Gogole GKI åˆ†ä¸ºä¸‹é¢ä¸¤ä¸ªé˜¶æ®µæ¨è¿›ï¼š</p><blockquote><p><em>â€¢</em> I. GKI å…¼å®¹æ€§ï¼šAndroid 11(R) + linux-5.4 require GKI compatibility test.</p><p><em>â€¢</em> II. GKI äº§å“åŒ–ï¼šAndroid 12(S) + linux-5.x åŠä¹‹å require GKI kernel</p></blockquote><p><strong>GKI 1.0 - GKI å…¼å®¹æ€§è¦æ±‚</strong></p><p>å¯¹äº Android 11 å¹³å°ç‰ˆæœ¬ï¼Œä¸ºäº†ä¿è¯ä¸ Treble å…¼å®¹ï¼Œå¿…é¡»å¯¹è¿è¡Œ v5.4 å†…æ ¸çš„è®¾å¤‡è¿›è¡Œ GKI æµ‹è¯•ã€‚</p><p>å…·å¤‡ GKI å…¼å®¹æ€§æ˜¯æŒ‡è®¾å¤‡é€šè¿‡å°† GKI å¯åŠ¨æ˜ åƒåˆ·å†™åˆ° <code>boot</code> åˆ†åŒºå¹¶å°† GSI ç³»ç»Ÿæ˜ åƒåˆ·å†™åˆ° <code>system</code> åˆ†åŒºæ¥å®‰è£…é€šç”¨ç³»ç»Ÿæ˜ åƒ (GSI) å’Œ GKI å†…æ ¸ï¼Œå› æ­¤é€šè¿‡äº† VTS å’Œ CTS-on-GSI+GKI æµ‹è¯•ã€‚è®¾å¤‡å¯ä»¥é™„å¸¦ä¸åŒçš„äº§å“å†…æ ¸ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ GKI æœªæä¾›çš„å¯åŠ è½½æ¨¡å—ã€‚ä¸è¿‡ï¼Œäº§å“å†…æ ¸å’Œ GKI å†…æ ¸éƒ½å¿…é¡»ä»ç›¸åŒçš„ <code>vendor_boot</code> å’Œ <code>vendor</code> åˆ†åŒºåŠ è½½æ¨¡å—ã€‚å› æ­¤ï¼Œæ‰€æœ‰äº§å“å†…æ ¸éƒ½å¿…é¡»å…·æœ‰ç›¸åŒçš„äºŒè¿›åˆ¶å†…æ ¸æ¨¡å—æ¥å£ (KMI)ã€‚ä¾›åº”å•†å¯ä»¥æ‰©å±•äº§å“å†…æ ¸çš„ KMIï¼Œå‰ææ˜¯å®ƒä¸ GKI KMI å…¼å®¹ã€‚GKI 1.0 ä¸è¦æ±‚ä¾›åº”å•†æ¨¡å—å¯å¸è½½ã€‚</p><p><strong>GKI 2.0 - GKI äº§å“</strong></p><p>æ­è½½ Android S (2021) å¹³å°ç‰ˆæœ¬ä¸”ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬ v5.xï¼ˆ5.x æ˜¯ 2020 å¹´å¹´åº•è¢«é€‰ä¸º LTS çš„å†…æ ¸ç‰ˆæœ¬ï¼‰æˆ–æ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡å¿…é¡»é™„å¸¦ GKI å†…æ ¸ã€‚å°†æä¾›å·²ç­¾åçš„å¯åŠ¨æ˜ åƒï¼Œå¹¶é€šè¿‡ LTS å’Œé‡å¤§é—®é¢˜ä¿®å¤å®šæœŸå¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚ç”±äº KMI å°†ä¿æŒäºŒè¿›åˆ¶ç¨³å®šæ€§ï¼Œå› æ­¤æ— éœ€å¯¹ä¾›åº”å•†æ˜ åƒè¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå³å¯å®‰è£…è¿™äº›å¯åŠ¨æ˜ åƒã€‚</p><h2 id="2-GKIåå„é•œåƒçš„å˜åŒ–"><a href="#2-GKIåå„é•œåƒçš„å˜åŒ–" class="headerlink" title="2.GKIåå„é•œåƒçš„å˜åŒ–"></a>2.GKIåå„é•œåƒçš„å˜åŒ–</h2><h3 id="2-1-bootåˆ†åŒºå˜åŒ–"><a href="#2-1-bootåˆ†åŒºå˜åŒ–" class="headerlink" title="2.1 bootåˆ†åŒºå˜åŒ–"></a>2.1 bootåˆ†åŒºå˜åŒ–</h3><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230219232030518.png" style="zoom:67%;"><p><code>boot</code> åˆ†åŒºåŒ…æ‹¬å¤´æ–‡ä»¶ã€å†…æ ¸ä»¥åŠå†…å«å¯åŠ¨ ramdisk é€šç”¨éƒ¨åˆ†çš„ CPIO å½’æ¡£ã€‚</p><p><code>boot</code> åˆ†åŒºä½¿ç”¨ v3 ç‰ˆå¯åŠ¨å¤´æ–‡ä»¶åï¼Œå…ˆå‰çš„ <code>boot</code> åˆ†åŒºçš„ä»¥ä¸‹éƒ¨åˆ†å°†ä¸å¤å­˜åœ¨ï¼š</p><ul><li>ç¬¬äºŒé˜¶æ®µå¼•å¯¼åŠ è½½ç¨‹åºï¼šå¦‚æœè®¾å¤‡å…·æœ‰ç¬¬äºŒé˜¶æ®µå¼•å¯¼åŠ è½½ç¨‹åºï¼Œåˆ™å¿…é¡»å°†ç›¸åº”å¼•å¯¼åŠ è½½ç¨‹åºå­˜å‚¨åœ¨è‡ªå·±çš„åˆ†åŒºä¸­ã€‚</li><li>DTBï¼šDTB å­˜å‚¨åœ¨ä¾›åº”å•†å¯åŠ¨åˆ†åŒºä¸­ã€‚</li></ul><p><code>boot</code> åˆ†åŒºåŒ…å«ä¸€ä¸ª CPIOå‹ç¼©åŒ…ï¼Œå†…å«ä»¥ä¸‹ GKI ç»„ä»¶ï¼š</p><ul><li>ä½äº <code>/lib/modules/</code> çš„ GKI å†…æ ¸æ¨¡å—</li><li><code>first_stage_init</code> åŠå…¶ä¾èµ–çš„åº“</li><li><code>fastbootd</code> å’Œ <code>recovery</code>ï¼ˆç”¨äº A&#x2F;B å’Œè™šæ‹Ÿ A&#x2F;B è®¾å¤‡ï¼‰</li></ul><h3 id="2-2-å‡ºç°vendor-bootåˆ†åŒº"><a href="#2-2-å‡ºç°vendor-bootåˆ†åŒº" class="headerlink" title="2.2 å‡ºç°vendor_bootåˆ†åŒº"></a>2.2 å‡ºç°vendor_bootåˆ†åŒº</h3><p><code>vendor_boot</code> åˆ†åŒºéš GKI å¼•å…¥ã€‚è¯¥åˆ†åŒºæ˜¯é‡‡ç”¨A&#x2F;B åˆ†åŒºï¼ŒåŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶ã€ä¾›åº”å•† ramdisk å’Œè®¾å¤‡æ ‘ Blobã€‚vendor ramdisk æ˜¯ä¸€ä¸ª CPIO å‹ç¼©åŒ…ï¼Œå…¶ä¸­åŒ…å«è®¾å¤‡å¯åŠ¨æ‰€éœ€çš„ä¾›åº”å•†æ¨¡å—ã€‚è¿™åŒ…æ‹¬ç”¨äºå¯ç”¨å…³é”® SoC åŠŸèƒ½çš„æ¨¡å—ï¼Œä»¥åŠå¯åŠ¨è®¾å¤‡å’Œæ˜¾ç¤ºå¯åŠ¨ç”»é¢æ‰€éœ€çš„å­˜å‚¨å’Œæ˜¾ç¤ºé©±åŠ¨ç¨‹åºã€‚</p><p>è¯¥ CPIO å‹ç¼©åŒ…åŒ…å«ï¼š</p><ul><li>ç¬¬ä¸€é˜¶æ®µ <code>init</code> ä¾›åº”å•†å†…æ ¸æ¨¡å—ï¼Œä½äº <code>/lib/modules/</code></li><li><code>modprobe</code> é…ç½®æ–‡ä»¶ï¼Œä½äº <code>/lib/modules</code></li><li><code>modules.load</code> æ–‡ä»¶ï¼Œç”¨äºæŒ‡ç¤ºè¦åœ¨ç¬¬ä¸€é˜¶æ®µ <code>init</code> æœŸé—´åŠ è½½çš„æ¨¡å—</li></ul><h3 id="2-3-æ€»ç»“"><a href="#2-3-æ€»ç»“" class="headerlink" title="2.3 æ€»ç»“"></a>2.3 æ€»ç»“</h3><blockquote><p>å…¨å¿—çš„æ–‡æ¡£å†™çš„å¤ªå¥½ï¼Œéå¸¸æ„Ÿè°¢ğŸ˜¸</p></blockquote><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230219232422846.png"><p>ä¸Šå›¾æ˜¯ boot åˆ†åŒºæ”¯æŒ GKI çš„å˜åŒ–æƒ…å†µï¼Œè¿™å¼ å›¾å¾ˆæœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œå…¶ä¸­å…³é”®ç‚¹æœ‰ï¼š</p><ul><li>boot.img å˜ä¸º boot.img + vendor-boot.imgï¼Œå…¶ä¸­ boot.img ä¸­æ”¾çš„æ˜¯ GKI é•œåƒ + ramdiskï¼Œ<u>vendor-boot.img ä¸­æ”¾çš„æ˜¯éœ€è¦å¯åŠ¨åŠ è½½çš„ vendor æ¨¡å— ko</u>ï¼›</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ bootloader åŠ è½½å¹¶æ•´åˆ boot.img å’Œ vendor-boot.imgä¸­çš„ä¸¤ä¸ªramdisk</li><li>ä¸ GKI å¯¹åº”çš„ï¼ŒGoogle è¿˜æ¨å‡º GSIï¼Œä¹Ÿå°±æ˜¯é€šç”¨ system é•œåƒï¼›</li><li>vendor.img å¯ä»¥å­˜æ”¾ä¸éœ€è¦è¦å¯åŠ¨åŠ è½½çš„ koï¼Œè¿™ä¸ªè·Ÿä»¥å‰æ˜¯ä¸€æ ·çš„ã€‚</li></ul><p>bootloader å¼€å‘éœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ï¼š</p><ul><li>boot header V3.0</li><li>DTB çš„å­˜æ”¾ä½ç½®ä» boot.img æ”¹åˆ°äº† vendor-boot</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­ boot éœ€è¦åŠ è½½ boot.img å’Œ vendor-boot.img ä¸­çš„ ramdisk å¹¶åšæ•´åˆï¼Œè€Œä¸” boot.img çš„ ramdisk ä¼˜å…ˆçº§é«˜</li></ul><h3 id="2-4-ramdiskæ‹¼æ¥"><a href="#2-4-ramdiskæ‹¼æ¥" class="headerlink" title="2.4 ramdiskæ‹¼æ¥"></a>2.4 ramdiskæ‹¼æ¥</h3><ul><li>Android 11ä¸­ï¼Œramdisk åˆ†ä¸ºä¸¤ä»½ï¼Œä¸€ä»½ä¸º<strong>boot_ramdisk</strong>ï¼Œå­˜æ”¾åœ¨ <strong>boot.img</strong>ä¸­ã€‚ä¸€ä»½ä¸º<strong>vendor_boot_ramdisk</strong> å­˜æ”¾åœ¨ <strong>vendor_boot.img</strong> ä¸­ã€‚</li><li>åœ¨ bootloader å¯åŠ¨æ—¶éœ€è¦å…ˆååŠ è½½ boot_ramdiskï¼Œvendor_boot_ramdisk å¹¶è¿›è¡Œå‰åæ‹¼æ¥ã€‚</li><li>ramdisk ç”¨çš„æ˜¯ cpio.lz4 æ ¼å¼ï¼Œå¯ä»¥è¿›è¡Œç®€å•çš„é¦–å°¾æ‹¼æ¥ï¼Œ<u><strong>ä½†æ˜¯ bootloader éœ€è¦æ³¨æ„ä¸¤ä¸ªramdisk ä¸­é—´å¿…é¡»ç´§å¯†æ‹¼æ¥ï¼Œä¸èƒ½å¯¹é½å†æ‹¼æ¥ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…æ ¸è§£å‹æ—¶å¤±è´¥</strong></u>ï¼ŒåŒæ—¶æ‹¼æ¥åæ”¹å˜ramdisk çš„å¤§å°ã€‚</li></ul><h2 id="3-å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI"><a href="#3-å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI" class="headerlink" title="3.å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI"></a>3.å¦‚ä½•ä¸‹è½½æœ€æ–°çš„GKI</h2><h3 id="3-1-å®‰å“å®˜ç½‘æè¿°"><a href="#3-1-å®‰å“å®˜ç½‘æè¿°" class="headerlink" title="3.1 å®‰å“å®˜ç½‘æè¿°"></a>3.1 å®‰å“å®˜ç½‘æè¿°</h3><p>Androidå®˜ç½‘ï¼š<a href="https://source.android.com/docs/core/architecture/kernel/gki-android12-5_10-release-builds?hl=zh-cn">https://source.android.com/docs/core/architecture/kernel/gki-android12-5_10-release-builds?hl=zh-cn</a></p><p>å¦‚æœè¦ä½¿ç”¨<code>boot.img</code>ï¼Œé€‰æ‹©boot-xxx.img</p><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230221223931378.png" alt="image-20230221223931378" style="zoom:67%;"><p>å¦‚æœä½¿ç”¨GKIï¼Œåˆ™ç‚¹å‡»kernelï¼Œé€‰æ‹©image</p><img src="/2023/02/19/Android%E9%80%9A%E7%94%A8%E5%86%85%E6%A0%B8GKI/image-20230221224045860.png" alt="image-20230221224045860" style="zoom:67%;"><blockquote><p>boot-xxx.imgä¸­çš„kernelå’Œè¿™ä¸ªimageæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ ·çš„ï¼ï¼ï¼</p></blockquote><h3 id="3-2-å…¨å¿—æ–‡æ¡£"><a href="#3-2-å…¨å¿—æ–‡æ¡£" class="headerlink" title="3.2 å…¨å¿—æ–‡æ¡£"></a>3.2 å…¨å¿—æ–‡æ¡£</h3><p>æ ¹æ®å…¨å¿—æ–‡æ¡£ï¼ŒAndroid 12ä¸‹è½½ç¼–è¯‘æµç¨‹å¦‚ä¸‹ï¼š</p><p><strong>1ï¼‰ä¸‹è½½</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir android-kernel<br>cd android-kernel/<br>repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.4<br>repo sync<br>repo start --all android12-5.4<br></code></pre></td></tr></table></figure><p><strong>2ï¼‰ ä½¿ç”¨ Google æºç ç¼–è¯‘ GKI é•œåƒ</strong></p><p>åœ¨ google æºç ç›®å½•ä¸‹è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">BUILD_BOOT_IMG=1 SKIP_VENDOR_BOOT=1 KERNEL_BINARY=Image GKI_RAMDISK_PREBUILT_BINARY=gki-<br>ramdisk.img BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è¿‡ç¨‹ä¸­åœ¨ LTO vmlinux.o é˜¶æ®µå¯èƒ½ä¼šå¡ä¸»ä¸€æ®µæ—¶é—´ï¼ˆå¤§æ¦‚ååˆ†é’Ÿï¼‰ï¼Œå±äºæ­£å¸¸ç°åœºï¼Œç¬¬ä¸€æ¬¡ç¼–è¯‘ä¼šæ¯”è¾ƒè€—æ—¶ã€‚</p><p>ç¼–è¯‘å®Œæˆä»¥åï¼Œboot.imgå­˜æ”¾åœ¨<code>android-kernel/out/android12-5.4/dist/boot.img</code></p><h2 id="4-GKIå¯åŠ¨æµç¨‹"><a href="#4-GKIå¯åŠ¨æµç¨‹" class="headerlink" title="4. GKIå¯åŠ¨æµç¨‹"></a>4. GKIå¯åŠ¨æµç¨‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">boot0<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">uboot: åŠ è½½boot.imgä¸­çš„GKIå’Œramdisk_1ï¼ŒåŠ è½½vendor-boot.imgçš„ramdisk_2ï¼Œæ•´åˆramdisk_1å’Œ</span><br>ramdisk_2,jump to GKI<br><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">GKI: core kernel init</span><br>--&gt; kernel initï¼š load modules ko<br>--&gt; android bringup<br></code></pre></td></tr></table></figure><h2 id="5-å‚è€ƒ"><a href="#5-å‚è€ƒ" class="headerlink" title="5.å‚è€ƒ"></a>5.å‚è€ƒ</h2><ul><li><a href="https://bbs.16rd.com/thread-583693-1-1.html">https://bbs.16rd.com/thread-583693-1-1.html</a></li><li><a href="https://zhuanlan.zhihu.com/p/240117889">https://zhuanlan.zhihu.com/p/240117889</a></li><li><a href="https://source.android.com/docs/core/architecture/kernel/generic-kernel-image?hl=zh-cn">https://source.android.com/docs/core/architecture/kernel/generic-kernel-image?hl=zh-cn</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>udevè®¾å¤‡ç®¡ç†</title>
    <link href="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/"/>
    <url>/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="udevè®¾å¤‡ç®¡ç†å™¨"><a href="#udevè®¾å¤‡ç®¡ç†å™¨" class="headerlink" title="udevè®¾å¤‡ç®¡ç†å™¨"></a>udevè®¾å¤‡ç®¡ç†å™¨</h1><p>ğŸ‹ğŸ‹ğŸ‹<strong>ååˆ†æ¨èé˜…è¯»</strong>ï¼š<a href="http://www.kroah.com/linux/talks/ols_2003_udev_paper/Reprint-Kroah-Hartman-OLS2003.pdf">http://www.kroah.com/linux/talks/ols_2003_udev_paper/Reprint-Kroah-Hartman-OLS2003.pdf</a></p><h2 id="1-ä¸ºä»€ä¹ˆä¼šå‡ºç°udev"><a href="#1-ä¸ºä»€ä¹ˆä¼šå‡ºç°udev" class="headerlink" title="1.ä¸ºä»€ä¹ˆä¼šå‡ºç°udev"></a>1.ä¸ºä»€ä¹ˆä¼šå‡ºç°udev</h2><p><strong>devfs</strong>(è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿ)æ˜¯ç”±Linux2.4å†…æ ¸å¼•å…¥çš„ï¼Œå½“æ—¶è¢«è®¸å¤šå·¥ç¨‹å¸ˆåŸºäºäº†é«˜åº¦çš„è¯„ä»·ï¼Œdevfsçš„å‡ºç°ä½¿å¾—è®¾å¤‡é©±åŠ¨ç¨‹åºèƒ½å¤Ÿè‡ªä¸»çš„ç®¡ç†è‡ªå·±çš„è®¾å¤‡æ–‡ä»¶ã€‚æ¯”å¦‚ï¼Œå¯ä»¥é€šè¿‡ç¨‹åºåœ¨è®¾å¤‡åˆå§‹åŒ–çš„æ—¶å€™åœ¨ &#x2F;dev ç›®å½•ä¸‹åˆ›å»ºè®¾å¤‡æ–‡ä»¶ï¼Œå¸è½½æ—¶å°†ä»–åˆ é™¤ï¼Œè€Œä¸”è®¾å¤‡é©±åŠ¨ç¨‹åºå¯ä»¥æŒ‡å®šè®¾å¤‡åï¼Œæ‰€æœ‰è€…å’Œæƒé™ä½ï¼Œè€Œä¸”ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ä¿®æ”¹æ‰€æœ‰è€…å’Œæƒé™ä½ï¼Œå¹¶ä¸”ä¸å†éœ€è¦ä¸ºè®¾å¤‡é©±åŠ¨ç¨‹åºåˆ†é…ä¸»è®¾å¤‡å·ä»¥åŠæ¬¡è®¾å¤‡å·ï¼Œåœ¨ç¨‹åºä¸­å¯ä»¥ç›´æ¥ç»™ register_chrdev()ä¼ é€’0ä¸»è®¾å¤‡å·ç”¨æ¥è·å–å¯ç”¨çš„ä¸»è®¾å¤‡å·ã€‚å¹¶ä¸”å¯ä»¥åœ¨ devfs_register() ä¸­æŒ‡å®šæ¬¡è®¾å¤‡å·ã€‚</p><p>ğŸ¦‹å°½ç®¡devfsæœ‰è¿™æ ·å’Œé‚£æ ·çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯ï¼Œåœ¨Linux 2.6å†…æ ¸ä¸­ï¼Œdevfsè¢«è®¤ä¸ºæ˜¯è¿‡æ—¶çš„æ–¹æ³•ï¼Œå¹¶æœ€ç»ˆè¢«æŠ›å¼ƒäº†ï¼Œ<strong>udevå–ä»£äº†å®ƒ</strong>ã€‚</p><p>ğŸ¬<strong>Linux VFSå†…æ ¸ç»´æŠ¤è€…Al ViroæŒ‡å‡ºäº†å‡ ç‚¹udevå–ä»£devfsçš„åŸå› ï¼š</strong></p><ul><li>devfsæ‰€åšçš„å·¥ä½œè¢«ç¡®ä¿¡å¯ä»¥åœ¨ç”¨æˆ·æ€æ¥å®Œæˆã€‚</li><li>devfsè¢«åŠ å…¥å†…æ ¸ä¹‹æ—¶ï¼Œå¤§å®¶æœŸæœ›å®ƒçš„è´¨é‡å¯ä»¥è¿å¤´èµ¶ä¸Š</li><li>å‘ç°devfsæœ‰ä¸€äº›å¯ä¿®å¤å’Œæ— æ³•ä¿®å¤çš„bugã€‚</li><li>å¯¹äºå¯ä¿®å¤çš„bugï¼Œå‡ ä¸ªæœˆå‰å°±å·²ç»è¢«ä¿®å¤äº†ï¼Œå…¶ç»´æŠ¤è€…è®¤ä¸ºä¸€åˆ‡è‰¯å¥½</li><li>å¯¹äºåè€…ï¼Œåœ¨ç›¸å½“é•¿çš„ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¹è§‚</li><li>devfsçš„ç»´æŠ¤è€…å’Œä½œè€…å¯¹å®ƒæ„Ÿåˆ°å¤±æœ›å¹¶ä¸”å·²ç»åœæ­¢äº†å¯¹ä»£ç çš„ç»´æŠ¤å·¥ä½œ</li></ul><h2 id="2-udevç®€ä»‹"><a href="#2-udevç®€ä»‹" class="headerlink" title="2.udevç®€ä»‹"></a>2.udevç®€ä»‹</h2><p>udevæ˜¯ä¸€ä¸ªè®¾å¤‡ç®¡ç†å·¥å…·ï¼Œ**<u>udevä»¥å®ˆæŠ¤è¿›ç¨‹çš„å½¢å¼è¿è¡Œ</u>**ï¼Œé€šè¿‡ä¾¦å¬å†…æ ¸å‘å‡ºæ¥çš„ueventæ¥ç®¡ç†&#x2F;devç›®å½•ä¸‹çš„è®¾å¤‡æ–‡ä»¶ã€‚udevåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œè€Œä¸åœ¨å†…æ ¸ç©ºé—´ è¿è¡Œã€‚å®ƒèƒ½å¤Ÿæ ¹æ®ç³»ç»Ÿä¸­çš„ç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€åŠ¨æ€æ›´æ–°è®¾å¤‡æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºï¼Œåˆ é™¤ç­‰ã€‚è®¾å¤‡æ–‡ä»¶é€šå¸¸æ”¾åœ¨&#x2F;devç›®å½•ä¸‹ã€‚ä½¿ç”¨udevåï¼Œåœ¨&#x2F;devç›®å½•ä¸‹å°±åªåŒ…å«ç³»ç»Ÿä¸­çœŸæ­£å­˜åœ¨çš„è®¾å¤‡ã€‚</p><blockquote><p><strong>DEVFSä¸UDEVçš„ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«ï¼š</strong></p><ul><li>é‡‡ç”¨devfsï¼Œå½“ä¸€ä¸ª<strong>å¹¶ä¸å­˜åœ¨çš„&#x2F;devèŠ‚ç‚¹</strong>è¢«æ‰“å¼€çš„æ—¶å€™ï¼Œdevfsèƒ½<strong>è‡ªåŠ¨åŠ è½½å¯¹åº”çš„é©±åŠ¨</strong>ï¼Œè€Œ<strong>udevåˆ™ä¸è¿™ä¹ˆåš</strong></li><li>è¿™æ˜¯å› ä¸ºudevçš„è®¾è®¡è€…è®¤ä¸ºLinuxåº”è¯¥åœ¨è®¾å¤‡è¢«å‘ç°çš„æ—¶å€™åŠ è½½é©±åŠ¨æ¨¡å—ï¼Œè€Œä¸æ˜¯å½“å®ƒè¢«è®¿é—®çš„æ—¶å€™ã€‚udevçš„è®¾è®¡è€…è®¤ä¸ºdevfsæ‰€æä¾›çš„æ‰“å¼€&#x2F;devèŠ‚ç‚¹æ—¶è‡ªåŠ¨åŠ è½½é©±åŠ¨çš„åŠŸèƒ½<strong>å¯¹ä¸€ä¸ªé…ç½®æ­£ç¡®çš„è®¡ç®—æœºæ¥è¯´æ˜¯å¤šä½™çš„</strong>ã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„è®¾å¤‡éƒ½åº”è¯¥äº§ç”Ÿçƒ­æ’æ‹”äº‹ä»¶å¹¶åŠ è½½æ°å½“çš„é©±åŠ¨ï¼Œ è€Œudevèƒ½æ³¨æ„åˆ°è¿™ç‚¹å¹¶ä¸”ä¸ºå®ƒåˆ›å»ºå¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹</li></ul></blockquote><h2 id="3-udevçš„é…ç½®æ–‡ä»¶"><a href="#3-udevçš„é…ç½®æ–‡ä»¶" class="headerlink" title="3.udevçš„é…ç½®æ–‡ä»¶"></a>3.udevçš„é…ç½®æ–‡ä»¶</h2><p>ä¸»è¦çš„udevé…ç½®æ–‡ä»¶æ˜¯&#x2F;etc&#x2F;udev&#x2F;udev.confæ–‡ä»¶ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">udev_root=<span class="hljs-string">&quot;/dev/&quot;</span><br><br>udev_rules=<span class="hljs-string">&quot;/etc/udev/rules.d/&quot;</span><br><br>udev_log=<span class="hljs-string">&quot;err&quot;</span><br></code></pre></td></tr></table></figure><ul><li>udev_rootï¼šä»£è¡¨ç€è®¾å¤‡æ–‡ä»¶æ·»åŠ åˆ°å“ªã€‚</li><li>udev_rulesï¼šä»£è¡¨ç€udevçš„è§„åˆ™å­˜å‚¨çš„ç›®å½•ã€‚è¿™ä¸ªç›®å½•å­˜å‚¨çš„æ˜¯ä»¥.rulesç»“æŸçš„æ–‡ä»¶ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶å¤„ç†ä¸€ç³»åˆ—è§„åˆ™æ¥å¸®åŠ©udevåˆ†é…åå­—ç»™è®¾å¤‡æ–‡ä»¶ä»¥ä¿è¯èƒ½è¢«å†…æ ¸è¯†åˆ«ã€‚ä½ çš„&#x2F;etc&#x2F;udev&#x2F;rules.dä¸‹é¢å¯èƒ½æœ‰å¥½å‡ ä¸ªudevè§„åˆ™æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸€éƒ¨åˆ†æ˜¯udevåŒ…å®‰è£…çš„ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ™æ˜¯å¯èƒ½æ˜¯åˆ«çš„ç¡¬ä»¶æˆ–è€…è½¯ä»¶åŒ…ç”Ÿæˆçš„ã€‚è¯¥ç›®å½•ä¸‹æœ‰å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œudevè¯»å–æ–‡ä»¶æ˜¯æŒ‰ç…§æ–‡ä»¶åçš„ASCIIå­—æ¯é¡ºåºæ¥è¯»å–çš„ï¼Œå¦‚æœudevä¸€æ—¦æ‰¾åˆ°äº†ä¸æ–°åŠ å…¥çš„è®¾å¤‡åŒ¹é…çš„è§„åˆ™ï¼Œudev å°±ä¼šæ ¹æ®è§„åˆ™å®šä¹‰çš„æªæ–½å¯¹æ–°è®¾å¤‡è¿›è¡Œé…ç½®ã€‚åŒæ—¶ä¸å†è¯»åç»­çš„è§„åˆ™æ–‡ä»¶ã€‚</li><li>udev_logï¼šä»£è¡¨ç€udevçš„æ—¥å¿—çº§åˆ«ï¼Œç”¨syslogè®°å½•é”™è¯¯ä¿¡æ¯ã€‚</li></ul><h2 id="4-udevçš„å·¥ä½œæµç¨‹å›¾"><a href="#4-udevçš„å·¥ä½œæµç¨‹å›¾" class="headerlink" title="4.udevçš„å·¥ä½œæµç¨‹å›¾"></a>4.udevçš„å·¥ä½œæµç¨‹å›¾</h2><img src="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/image-20230215234615127.png" style="zoom:80%;"><h2 id="5-udevçš„åŒ¹é…è§„åˆ™"><a href="#5-udevçš„åŒ¹é…è§„åˆ™" class="headerlink" title="5.udevçš„åŒ¹é…è§„åˆ™"></a>5.udevçš„åŒ¹é…è§„åˆ™</h2><p>åœ¨&#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ç³»åˆ—çš„.rulesæ–‡ä»¶ï¼Œåœ¨è¿™äº›æ–‡ä»¶ä¸­æœ‰ä¸€äº›åŒ¹é…è§„åˆ™ï¼š</p><h3 id="5-1-udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦"><a href="#5-1-udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦" class="headerlink" title="5.1 udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦"></a>5.1 udevè§„åˆ™çš„æ‰€æœ‰æ“ä½œç¬¦</h3><ul><li><p>&#x3D;&#x3D; ï¼šæ¯”è¾ƒé”®ã€å€¼ï¼Œè‹¥ç­‰äºï¼Œåˆ™è¯¥æ¡ä»¶æ»¡è¶³ï¼›</p></li><li><p>!&#x3D;  ï¼šæ¯”è¾ƒé”®ã€å€¼ï¼Œè‹¥ä¸ç­‰äºï¼Œåˆ™è¯¥æ¡ä»¶æ»¡è¶³ï¼›</p></li><li><p>&#x3D;   ï¼šå¯¹ä¸€ä¸ªé”®èµ‹å€¼ï¼›</p></li><li><p>+&#x3D; ï¼šä¸ºä¸€ä¸ªè¡¨ç¤ºå¤šä¸ªæ¡ç›®çš„é”®èµ‹å€¼ã€‚</p></li><li><p>:&#x3D;  ï¼šå¯¹ä¸€ä¸ªé”®èµ‹å€¼ï¼Œå¹¶æ‹’ç»ä¹‹åæ‰€æœ‰å¯¹è¯¥é”®çš„æ”¹åŠ¨ã€‚ç›®çš„æ˜¯é˜²æ­¢åé¢çš„è§„åˆ™æ–‡ä»¶å¯¹è¯¥é”®èµ‹å€¼ã€‚</p></li></ul><h3 id="5-2-udevè§„åˆ™çš„åŒ¹é…é”®"><a href="#5-2-udevè§„åˆ™çš„åŒ¹é…é”®" class="headerlink" title="5.2 udevè§„åˆ™çš„åŒ¹é…é”®"></a>5.2 <strong>udevè§„åˆ™çš„åŒ¹é…é”®</strong></h3><ul><li>ACTIONï¼šäº‹ä»¶(uevent)çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼šadd(æ·»åŠ è®¾å¤‡)ã€remove(åˆ é™¤è®¾å¤‡)ã€‚</li><li>KERNELï¼šå†…æ ¸è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ï¼šsda,cdromã€‚</li><li>DEVPATHï¼šè®¾å¤‡çš„devpathè·¯å¾„ã€‚</li><li>SUBSYSTEMï¼šè®¾å¤‡çš„å­ç³»ç»Ÿåç§°ï¼Œä¾‹å¦‚ï¼šsdaçš„å­ç³»ç»Ÿä¸ºblockã€‚</li><li>BUSï¼šè®¾å¤‡åœ¨devpath é‡Œçš„æ€»çº¿åç§°ï¼Œä¾‹å¦‚ï¼šusbã€‚</li><li>DRIVERï¼šè®¾å¤‡åœ¨devpath é‡Œçš„è®¾å¤‡é©±åŠ¨åç§°ï¼Œä¾‹å¦‚ï¼šide-cdromã€‚</li><li>IDï¼šè®¾å¤‡åœ¨devpath é‡Œçš„è¯†åˆ«å·ã€‚</li><li>SYSFS{filename}ï¼šè®¾å¤‡çš„devpath è·¯å¾„ä¸‹ï¼Œè®¾å¤‡çš„å±æ€§æ–‡ä»¶â€œfilenameâ€é‡Œçš„å†…å®¹ã€‚</li></ul><blockquote><p>ä¾‹å¦‚ï¼šSYSFS{model}&#x3D;&#x3D;â€œST936701SSâ€è¡¨ç¤ºï¼šå¦‚æœè®¾å¤‡çš„å‹å·ä¸ºST936701SSï¼Œåˆ™è¯¥è®¾å¤‡åŒ¹é…è¯¥åŒ¹é…é”®ã€‚</p><p>åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡SYSFSçš„åŒ¹é…é”®ã€‚</p></blockquote><ul><li>ENV{key}ï¼šç¯å¢ƒå˜é‡ã€‚åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡ç¯å¢ƒå˜é‡çš„åŒ¹é…é”®ã€‚</li><li>PROGRAMï¼šè°ƒç”¨å¤–éƒ¨å‘½ä»¤ã€‚</li><li>RESULTï¼šå¤–éƒ¨å‘½ä»¤PROGRAM çš„è¿”å›ç»“æœã€‚ä¾‹å¦‚ï¼š</li></ul><blockquote><p>PROGRAM&#x3D;&#x3D;â€&#x2F;lib&#x2F;udev&#x2F;scsi_id-g -s $devpathâ€, RESULT&#x3D;&#x3D;â€œ35000c50000a7ef67â€</p><p>è°ƒç”¨å¤–éƒ¨å‘½ä»¤&#x2F;lib&#x2F;udev&#x2F;scsi_idæŸ¥è¯¢è®¾å¤‡çš„SCSIIDï¼Œå¦‚æœè¿”å›ç»“æœä¸º35000c50000a7ef67ï¼Œåˆ™è¯¥è®¾å¤‡åŒ¹é…è¯¥åŒ¹é…é”®ã€‚</p></blockquote><h3 id="5-3-udev-çš„é‡è¦èµ‹å€¼é”®"><a href="#5-3-udev-çš„é‡è¦èµ‹å€¼é”®" class="headerlink" title="5.3 udev çš„é‡è¦èµ‹å€¼é”®"></a>5.3 udev çš„é‡è¦èµ‹å€¼é”®</h3><ul><li>NAMEï¼šåœ¨&#x2F;devä¸‹äº§ç”Ÿçš„è®¾å¤‡æ–‡ä»¶åã€‚åªæœ‰ç¬¬ä¸€æ¬¡å¯¹æŸä¸ªè®¾å¤‡çš„NAMEçš„èµ‹å€¼è¡Œä¸ºç”Ÿæ•ˆï¼Œä¹‹ååŒ¹é…çš„è§„åˆ™å†å¯¹è¯¥è®¾å¤‡çš„NAMEèµ‹å€¼è¡Œä¸ºå°†è¢«å¿½ç•¥ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•è§„åˆ™å¯¹è®¾å¤‡çš„NAMEèµ‹å€¼ï¼Œudevå°†ä½¿ç”¨å†…æ ¸è®¾å¤‡åç§°æ¥äº§ç”Ÿè®¾å¤‡æ–‡ä»¶ã€‚</li><li>SYMLINKï¼šä¸º&#x2F;dev&#x2F;ä¸‹çš„è®¾å¤‡æ–‡ä»¶äº§ç”Ÿç¬¦å·é“¾æ¥ã€‚ç”±äºudevåªèƒ½ä¸ºæŸä¸ªè®¾å¤‡äº§ç”Ÿä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†ä¸è¦†ç›–ç³»ç»Ÿé»˜è®¤çš„udevè§„åˆ™æ‰€äº§ç”Ÿçš„æ–‡ä»¶ï¼Œæ¨èä½¿ç”¨ç¬¦å·é“¾æ¥ã€‚</li><li>OWNER, GROUP, MODEï¼šä¸ºè®¾å¤‡è®¾å®šæƒé™ã€‚</li><li>ENV{key}ï¼šå¯¼å…¥ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚</li><li>RUN:è¿è¡Œåé¢çš„ç¨‹åºã€‚</li></ul><h3 id="5-4-udev-çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦"><a href="#5-4-udev-çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦" class="headerlink" title="5.4 udev çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦"></a>5.4 udev çš„å€¼å’Œå¯è°ƒç”¨çš„æ›¿æ¢æ“ä½œç¬¦</h3><p>åœ¨é”®å€¼å¯¹ä¸­çš„é”®å’Œæ“ä½œç¬¦éƒ½ä»‹ç»å®Œäº†ï¼Œæœ€åæ˜¯å€¼(value)ã€‚Linuxç”¨æˆ·å¯ä»¥éšæ„åœ°å®šåˆ¶udevè§„åˆ™æ–‡ä»¶çš„å€¼ã€‚ä¾‹å¦‚ï¼šmy_root_disk,my_printerã€‚åŒæ—¶ä¹Ÿå¯ä»¥å¼•ç”¨ä¸‹é¢çš„æ›¿æ¢æ“ä½œç¬¦ï¼š</p><ul><li>$kernel, %kï¼šè®¾å¤‡çš„å†…æ ¸è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ï¼šsdaã€cdromã€‚</li><li>$number, %nï¼šè®¾å¤‡çš„å†…æ ¸å·ç ï¼Œä¾‹å¦‚ï¼šsda3çš„å†…æ ¸å·ç æ˜¯3ã€‚</li><li>$devpath, %pï¼šè®¾å¤‡çš„devpathè·¯å¾„ã€‚</li><li>$id, %bï¼šè®¾å¤‡åœ¨devpathé‡Œçš„IDå·ã€‚</li><li>$sysfs{file}ï¼Œ%s{file}ï¼šè®¾å¤‡çš„sysfsé‡Œfileçš„å†…å®¹ã€‚å…¶å®å°±æ˜¯è®¾å¤‡çš„å±æ€§å€¼ã€‚ä¾‹å¦‚ï¼šsysfs{size}è¡¨ç¤ºè¯¥è®¾å¤‡(ç£ç›˜) çš„å¤§å°ã€‚</li><li>$env{key}, %E{key}ï¼šä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼ã€‚</li><li>$major, %Mï¼šè®¾å¤‡çš„majorå·ã€‚</li><li>$minor %mï¼šè®¾å¤‡çš„minorå·ã€‚</li><li>$result, %cï¼šPROGRAMè¿”å›çš„ç»“æœã€‚</li><li>$parent, %Pï¼šçˆ¶è®¾å¤‡çš„è®¾å¤‡æ–‡ä»¶åã€‚</li><li>$root, %rï¼šudev_rootçš„å€¼ï¼Œé»˜è®¤æ˜¯&#x2F;dev&#x2F;ã€‚</li><li>$tempnode, %Nï¼šä¸´æ—¶è®¾å¤‡åã€‚</li><li>%%ï¼šç¬¦å·%æœ¬èº«ã€‚</li><li>$$ï¼š ç¬¦ å· ï¼šç¬¦å·ï¼šç¬¦å·æœ¬èº«ã€‚</li></ul><p>æ³¨æ„ï¼šåœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ï¼Œè¦åŒ¹é…æ‰€æœ‰çš„æ¯”è¾ƒé”®éƒ½æ»¡è¶³æ—¶ï¼Œæ‰ç®—åŒ¹é…æˆåŠŸã€‚</p><h2 id="6-udevçš„ä½¿ç”¨æ–¹æ³•"><a href="#6-udevçš„ä½¿ç”¨æ–¹æ³•" class="headerlink" title="6.udevçš„ä½¿ç”¨æ–¹æ³•"></a>6.udevçš„ä½¿ç”¨æ–¹æ³•</h2><ol><li>ä½¿ç”¨udevadm å‘½ä»¤æ¥æŸ¥çœ‹è®¾å¤‡çš„ä¿¡æ¯ï¼šåœ¨ä½¿ç”¨udevæ—¶éœ€è¦è·å¾—è¯¥è®¾å¤‡çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¥ç”¨äºåŒ¹é…è§„åˆ™ã€‚</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">udevadm info -a -p $(udevadm info -q path -n /dev/sdb)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­&#x2F;dev&#x2F;sdbæ˜¯æ’å…¥è®¾å¤‡åè®¾å¤‡åœ¨&#x2F;devä¸‹çš„åå­—ã€‚</p><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs shell">Udevadm info starts with the device specified by the devpath and then<br>walks up the chain of parent devices. It prints for every device<br>found, all possible attributes in the udev rules key format.<br>A rule to match, can be composed by the attributes of the device<br>and the attributes from one single parent device.<br><br>  looking at device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1/20:0:1:0/block/sdb&#x27;:<br>    KERNEL==&quot;sdb&quot;<br>    SUBSYSTEM==&quot;block&quot;<br>    DRIVER==&quot;&quot;<br>    ATTR&#123;alignment_offset&#125;==&quot;0&quot;<br>    ATTR&#123;capability&#125;==&quot;50&quot;<br>    ATTR&#123;discard_alignment&#125;==&quot;0&quot;<br>    ATTR&#123;events&#125;==&quot;&quot;<br>    ATTR&#123;events_async&#125;==&quot;&quot;<br>    ATTR&#123;events_poll_msecs&#125;==&quot;-1&quot;<br>    ATTR&#123;ext_range&#125;==&quot;256&quot;<br>    ATTR&#123;hidden&#125;==&quot;0&quot;<br>    ATTR&#123;inflight&#125;==&quot;       0        0&quot;<br>    ATTR&#123;range&#125;==&quot;16&quot;<br>    ATTR&#123;removable&#125;==&quot;0&quot;<br>    ATTR&#123;ro&#125;==&quot;0&quot;<br>    ATTR&#123;size&#125;==&quot;41943040&quot;<br>    ATTR&#123;stat&#125;==&quot;      85        0     4184       20        0        0        0        0        0        8       20&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1/20:0:1:0&#x27;:<br>    KERNELS==&quot;20:0:1:0&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;sd&quot;<br>    ATTRS&#123;blacklist&#125;==&quot;&quot;<br>    ATTRS&#123;device_blocked&#125;==&quot;0&quot;<br>    ATTRS&#123;device_busy&#125;==&quot;0&quot;<br>    ATTRS&#123;dh_state&#125;==&quot;detached&quot;<br>    ATTRS&#123;eh_timeout&#125;==&quot;10&quot;<br>    ATTRS&#123;evt_capacity_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_inquiry_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_lun_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_media_change&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_mode_parameter_change_reported&#125;==&quot;0&quot;<br>    ATTRS&#123;evt_soft_threshold_reached&#125;==&quot;0&quot;<br>    ATTRS&#123;inquiry&#125;==&quot;&quot;<br>    ATTRS&#123;iocounterbits&#125;==&quot;32&quot;<br>    ATTRS&#123;iodone_cnt&#125;==&quot;0x7a&quot;<br>    ATTRS&#123;ioerr_cnt&#125;==&quot;0x3&quot;<br>    ATTRS&#123;iorequest_cnt&#125;==&quot;0x7a&quot;<br>    ATTRS&#123;model&#125;==&quot;VMware Virtual S&quot;<br>    ATTRS&#123;queue_depth&#125;==&quot;32&quot;<br>    ATTRS&#123;queue_ramp_up_period&#125;==&quot;120000&quot;<br>    ATTRS&#123;queue_type&#125;==&quot;simple&quot;<br>    ATTRS&#123;rev&#125;==&quot;1.0 &quot;<br>    ATTRS&#123;scsi_level&#125;==&quot;3&quot;<br>    ATTRS&#123;state&#125;==&quot;running&quot;<br>    ATTRS&#123;timeout&#125;==&quot;180&quot;<br>    ATTRS&#123;type&#125;==&quot;0&quot;<br>    ATTRS&#123;vendor&#125;==&quot;VMware, &quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20/target20:0:1&#x27;:<br>    KERNELS==&quot;target20:0:1&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0/host20&#x27;:<br>    KERNELS==&quot;host20&quot;<br>    SUBSYSTEMS==&quot;scsi&quot;<br>    DRIVERS==&quot;&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00/0000:00:10.0&#x27;:<br>    KERNELS==&quot;0000:00:10.0&quot;<br>    SUBSYSTEMS==&quot;pci&quot;<br>    DRIVERS==&quot;mptspi&quot;<br>    ATTRS&#123;broken_parity_status&#125;==&quot;0&quot;<br>    ATTRS&#123;class&#125;==&quot;0x010000&quot;<br>    ATTRS&#123;config&#125;==&quot;&quot;<br>    ATTRS&#123;consistent_dma_mask_bits&#125;==&quot;32&quot;<br>    ATTRS&#123;d3cold_allowed&#125;==&quot;0&quot;<br>    ATTRS&#123;device&#125;==&quot;0x0030&quot;<br>    ATTRS&#123;dma_mask_bits&#125;==&quot;32&quot;<br>    ATTRS&#123;driver_override&#125;==&quot;(null)&quot;<br>    ATTRS&#123;enable&#125;==&quot;1&quot;<br>    ATTRS&#123;irq&#125;==&quot;17&quot;<br>    ATTRS&#123;local_cpulist&#125;==&quot;0-3&quot;<br>    ATTRS&#123;local_cpus&#125;==&quot;00000000,00000000,00000000,0000000f&quot;<br>    ATTRS&#123;msi_bus&#125;==&quot;1&quot;<br>    ATTRS&#123;numa_node&#125;==&quot;-1&quot;<br>    ATTRS&#123;revision&#125;==&quot;0x01&quot;<br>    ATTRS&#123;subsystem_device&#125;==&quot;0x1976&quot;<br>    ATTRS&#123;subsystem_vendor&#125;==&quot;0x15ad&quot;<br>    ATTRS&#123;vendor&#125;==&quot;0x1000&quot;<br><br>  looking at parent device &#x27;/devices/pci0000:00&#x27;:<br>    KERNELS==&quot;pci0000:00&quot;<br>    SUBSYSTEMS==&quot;&quot;<br>    DRIVERS==&quot;&quot;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç¼–å†™.rulesæ–‡ä»¶çš„è§„åˆ™ï¼šè¿›å…¥&#x2F;etc&#x2F;udev&#x2F;rules.dæ–‡ä»¶å¤¹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /etc/udev/rules.d<br></code></pre></td></tr></table></figure><p>æ–°å»ºæ–‡ä»¶10-usb.rulesï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vi 10-usb.rules<br></code></pre></td></tr></table></figure><p>åœ¨10-usb.rulesæ–‡ä»¶ä¸­è¾“å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">KERNEL==&quot;sdb&quot;,SUBSYSTEM==&quot;block&quot;,ACTION==&quot;add&quot;,SYMLINK+=&quot;USB_link&quot;<br></code></pre></td></tr></table></figure><p>ç„¶åä¿å­˜ï¼Œé€€å‡ºã€‚</p><ol start="3"><li>ä½¿å¾—udevæ–‡ä»¶ç”Ÿæ•ˆçš„æ–¹æ³•ï¼šé€šå¸¸ï¼Œä½¿å¾—é…ç½®åçš„æ–‡ä»¶ç”Ÿæ•ˆï¼Œéœ€è¦é‡‡ç”¨çƒ­æ’æ‹”çš„æ–¹æ³•æ›´æ–°udevè§„åˆ™ï¼Œä¸è¿‡æœ‰æ›´ç®€å•çš„æ–¹æ³•å¦‚ä¸‹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">udevadm test /sys/class/block/sdb<br></code></pre></td></tr></table></figure><p>4.ç»“æœå¦‚ä¸‹ï¼šåœ¨&#x2F;devæ–‡ä»¶å¤¹ä¸‹</p><img src="/2023/02/16/udev%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/20201228214401604.png"><h2 id="7-çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ"><a href="#7-çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="7.çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ"></a>7.çƒ­æ’æ‹”èƒ½è‡ªåŠ¨è®¾å¤‡ï¼Œå†·æ’æ‹”æ€ä¹ˆåŠï¼Ÿ</h2><p>ç”±äºå†·æ’æ‹”çš„è®¾å¤‡å¼€æœºæ—¶å°±å·²ç»å­˜åœ¨ï¼Œåœ¨udevå¯åŠ¨å‰å·²ç»è¢«æ’å…¥ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œsysfsä¸‹çš„è®¾å¤‡éƒ½å­˜åœ¨ueventæ–‡ä»¶ï¼Œå‘è¯¥æ–‡ä»¶å†™ä¸€ä¸ªâ€œaddâ€,å†…æ ¸ä¼šé‡æ–°å‘é€netlinkï¼Œä¹‹åudevå°±å¯ä»¥æ”¶åˆ°è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯äº†ï¼Œä»è€Œåˆ›å»º&#x2F;devä¸‹å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p><h2 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h2><ul><li><a href="https://blog.csdn.net/chengziwang/article/details/111873757">https://blog.csdn.net/chengziwang/article/details/111873757</a></li><li><a href="https://gitee.com/low-level-of-logic/RaspberryPi/blob/master/docs/">https://gitee.com/low-level-of-logic/RaspberryPi/blob/master/docs/</a></li><li><a href="https://blog.csdn.net/woyimibayi/article/details/78320915">https://blog.csdn.net/woyimibayi/article/details/78320915</a></li><li><a href="http://m.wfuyu.com/server/23483.html">http://m.wfuyu.com/server/23483.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€å®éªŒã€‘/devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘-x2F-devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ"><a href="#ã€å®éªŒã€‘-x2F-devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ã€å®éªŒã€‘&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ"></a>ã€å®éªŒã€‘&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ</h1><p>å…ˆä»‹ç»ä¸€ä¸‹æˆ‘çš„å¼€å‘æ¿ï¼ŒNXPçš„IMX6ULLï¼Œé‡Œé¢æ˜¯åŸç”Ÿçš„Linuxå†…æ ¸ï¼Œç‰ˆæœ¬ä¸º<code>4.1.5</code>ã€‚</p><p>ä¸‹é¢å¼€å§‹åšå®éªŒï¼Œè¯æ˜&#x2F;devç›®å½•æ— æ³•åŒæ—¶æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h2><p><strong>1.å¼€æœºåæŸ¥çœ‹å½“å‰çš„æŒ‚è½½çš„è®¾å¤‡</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220652226.png" alt="image-20230215220652226" style="zoom:67%;"><blockquote><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶devtmpfså¤§å°ä¸º88.3M</p></blockquote><p><strong>2.å°è¯•æ‰‹åŠ¨æŒ‚è½½&#x2F;dev</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220610703.png" alt="image-20230215220610703" style="zoom:67%;"><p>æˆ‘ä»¬çŸ¥é“tmpfsæŒ‚è½½åé»˜è®¤æ˜¯RAMçš„ä¸€åŠ</p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220830308.png" alt="image-20230215220830308" style="zoom:67%;"><blockquote><p>å¯ä»¥å‘ç°devtmpfsè·Ÿéštmpfsä¸€èµ·åŠæˆäº†RAMçš„ä¸€åŠå¤§å°</p></blockquote><p><strong>3.å†æ¬¡ç¡®è®¤æŒ‚è½½æƒ…å†µ</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215220510027.png"><p><strong>4.æŸ¥çœ‹æ­¤æ—¶&#x2F;devç›®å½•æ˜¯å¦æ­£å¸¸</strong></p><img src="/2023/02/15/%E3%80%90%E5%AE%9E%E9%AA%8C%E3%80%91-dev%E7%9B%AE%E5%BD%95%E6%97%A0%E6%B3%95%E5%90%8C%E6%97%B6%E6%8C%82%E8%BD%BD%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20230215221013735.png"><blockquote><p>æ­¤æ—¶&#x2F;devç›®å½•ä¸‹ä¸ºç©ºï¼Œè®¿é—®ä¸åˆ°ä»»ä½•ç›®å½•</p></blockquote><h2 id="å®éªŒç»“è®º"><a href="#å®éªŒç»“è®º" class="headerlink" title="å®éªŒç»“è®º"></a>å®éªŒç»“è®º</h2><p>é€šè¿‡å®éªŒæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š</p><ul><li>å¯ä»¥åŒæ—¶ç»™<code>/dev</code>æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰é—®é¢˜</li><li>å½“ç³»ç»Ÿä»¥<code>devtmpfs</code>æŒ‚è½½åï¼Œå†æ¬¡ä»¥<code>tmpfs</code>æŒ‚è½½åï¼Œ<code>devtmpfs</code>ä¼šéš<code>tmpfs</code>å¤§å°ä¸€èµ·å˜åŒ–ï¼Œå¦‚æœ<code>tmpfs</code>æŒ‚è½½æ—¶ä¸æŒ‡æ˜å¤§å°ï¼Œé»˜è®¤ä¸ºå†…å­˜çš„ä¸€åŠ</li><li>ç»™<code>/dev</code>æŒ‚è½½ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿåï¼Œ<code>/dev</code>ç›®å½•æ— æ³•æ­£å¸¸è®¿é—®</li></ul><p><strong>è¯´æ˜ï¼šæœ¬æ–‡æ°´å¹³æœ‰é™ï¼Œå¯èƒ½å­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œè¯·æŒ‡æ­£ï¼</strong></p>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“</title>
    <link href="/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/"/>
    <url>/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/</url>
    
    <content type="html"><![CDATA[<h1 id="tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“"><a href="#tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“" class="headerlink" title="tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“"></a>tmpfsæ–‡ä»¶ç³»ç»Ÿä¸å®‰å“</h1><h2 id="1-ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ"></a>1.ä»€ä¹ˆæ˜¯tmpfsæ–‡ä»¶ç³»ç»Ÿ</h2><p>å…ˆæ¥çœ‹ä¸€ä¸‹Kernelæ–‡æ¡£å¯¹äºtmpfsæ–‡ä»¶ç³»ç»Ÿçš„æè¿°ï¼š<a href="https://www.kernel.org/doc/Documentation/filesystems/tmpfs.txt">https://www.kernel.org/doc/Documentation/filesystems/tmpfs.txt</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">Tmpfs is a file system <span class="hljs-built_in">which</span> keeps all files <span class="hljs-keyword">in</span> virtual memory.<br><br>Everything <span class="hljs-keyword">in</span> tmpfs is temporary <span class="hljs-keyword">in</span> the sense that no files will be created on your hard drive. If you unmount a tmpfs instance, everything stored there <span class="hljs-keyword">in</span> is lost.<br><br>tmpfs puts everything into the kernel internal caches and grows andshrinks to accommodate the files it contains and is able to swap unneeded pages out to swap space. It has maximum size limits <span class="hljs-built_in">which</span> can be adjusted on the fly via <span class="hljs-string">&#x27;mount -o remount ...&#x27;</span><br><br>If you compare it to ramfs (<span class="hljs-built_in">which</span> was the template to create tmpfs) you gain swapping and <span class="hljs-built_in">limit</span> checking. Another similar thing is the RAMdisk (/dev/ram*), <span class="hljs-built_in">which</span> simulates a fixed size hard disk <span class="hljs-keyword">in</span> physical RAM, <span class="hljs-built_in">where</span> you have to create an ordinary filesystem on top. Ramdisks cannot swap and you <span class="hljs-keyword">do</span> not have the possibility to resize them. <br></code></pre></td></tr></table></figure><ul><li><p>tmpfsæ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æ–‡ä»¶ä¿å­˜åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p></li><li><p>tmpfsä¸­çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸´æ—¶çš„ï¼Œå› ä¸ºä¸ä¼šåœ¨ç¡¬ç›˜ä¸Šåˆ›å»ºä»»ä½•æ–‡ä»¶ã€‚å¦‚æœå¸è½½tmpfså®ä¾‹ï¼Œå­˜å‚¨åœ¨å…¶ä¸­çš„æ‰€æœ‰ä¸œè¥¿éƒ½ä¸¢å¤±äº†</p></li><li><p>tmpfså°†æ‰€æœ‰å†…å®¹æ”¾å…¥å†…æ ¸å†…éƒ¨ç¼“å­˜ï¼Œå¹¶è¿›è¡Œå¢é•¿å’Œæ”¶ç¼©ä»¥å®¹çº³å…¶ä¸­åŒ…å«çš„æ–‡ä»¶ï¼Œå¹¶èƒ½å¤Ÿå°†ä¸éœ€è¦çš„é¡µé¢äº¤æ¢å‡ºæ¥ä»¥äº¤æ¢ç©ºé—´ã€‚å®ƒå…·æœ‰sizeé™åˆ¶ï¼Œå¯ä»¥é€šè¿‡â€œmount-o remountâ€¦â€è¿›è¡ŒåŠ¨æ€è°ƒæ•´</p></li><li><p>å¦‚æœå°†å…¶ä¸ramfsï¼ˆåˆ›å»ºtmpfsçš„æ¨¡æ¿ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™ä¼šè·å¾—äº¤æ¢å’Œé™åˆ¶æ£€æŸ¥ã€‚å¦ä¸€ä¸ªç±»ä¼¼çš„ä¸œè¥¿æ˜¯RAMdiskï¼ˆ&#x2F;dev&#x2F;ram*ï¼‰ï¼Œå®ƒåœ¨ç‰©ç†ramä¸­æ¨¡æ‹Ÿå›ºå®šå¤§å°çš„ç¡¬ç›˜ï¼Œæ‚¨å¿…é¡»åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ç³»ç»Ÿã€‚Ramdisksæ— æ³•äº’æ¢ï¼Œæ‚¨æ— æ³•è°ƒæ•´å…¶å¤§å°ã€‚</p></li></ul><p><strong>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹tmpfsçš„ç‰¹ç‚¹ï¼š</strong></p><ol><li>ç”±äºæ˜¯æ„å»ºåœ¨å†…å­˜ä¸­ï¼Œå­˜æ”¾åœ¨tmpfsä¸­çš„æ‰€æœ‰æ•°æ®åœ¨å¸è½½æˆ–è€…æ–­åä¸¢å¤±ã€‚ã€ä¸´æ—¶æ€§ã€‘</li><li>å†…å­˜çš„è®¿é—®é€Ÿåº¦è¿œè¿œå¤§äºç£ç›˜IOæ“ä½œï¼Œå³ä½¿ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜ï¼Œæ€§èƒ½ä»ç„¶ä¼˜äºç£ç›˜ã€‚ã€å¿«é€Ÿè¯»å†™ã€‘</li><li>tmpfsä¸€å¼€å§‹ä½¿ç”¨å¾ˆå°çš„ç©ºé—´ï¼Œä½†æ˜¯éšç€æ–‡ä»¶çš„å¤åˆ¶å’Œåˆ›å»ºï¼Œtmpfsæ–‡ä»¶ç³»ç»Ÿä¼šåˆ†é…æ›´å¤šçš„å†…å­˜ï¼Œå¹¶æŒ‰ç…§éœ€æ±‚åŠ¨æ€å¢åŠ æ–‡ä»¶ç³»ç»Ÿçš„ç©ºé—´ï¼Œè€Œä¸”tmpfsæ–‡ä»¶ç³»ç»Ÿä¼šåŠ¨æ€ç¼©å°æ–‡ä»¶å¹¶é‡Šæ”¾å†…å­˜èµ„æº</li><li>åƒæ™®é€šå—è®¾å¤‡éœ€è¦mkfsæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿåæ‰å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯tmpfsæ˜¯ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåªè¦æŒ‚è½½å°±å¯ä»¥ä½¿ç”¨ã€‚</li></ol><h2 id="2-Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ"><a href="#2-Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ"></a>2.Androidä¸­çš„tmpfsæ–‡ä»¶ç³»ç»Ÿ</h2><p>Androidä¸­æŒ‚è½½tmpfsæ–‡ä»¶ç³»ç»Ÿçš„æ—¶æœºä¸»è¦åœ¨å®‰å“initè¿›ç¨‹ä¸­çš„ç¬¬ä¸€é˜¶æ®µæŒ‚è½½å’Œç¬¬äºŒé˜¶æ®µæŒ‚è½½ã€åŸºäºAndroid Sã€‘</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FirstStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/dev&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="hljs-string">&quot;mode=0755&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/mnt&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=1000&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/debug_ramdisk&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br>    <br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, kSecondStageRes, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br># --------------------------------------------------------------------------------------<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-built_in">MountExtraFilesystems</span>();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">MountExtraFilesystems</span><span class="hljs-params">()</span> </span>&#123;<br><br>    <span class="hljs-comment">// /apex is used to mount APEXes</span><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/apex&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br><br>    <span class="hljs-comment">// /linkerconfig is used to keep generated linker configuration</span><br>    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/linkerconfig&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOEXEC | MS_NOSUID | MS_NODEV,<br>                    <span class="hljs-string">&quot;mode=0755,uid=0,gid=0&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®‰å“çœŸå®è¿è¡Œç¯å¢ƒä¸­çš„æŒ‚è½½æƒ…å†µ</p><img src="/2023/02/14/tmpfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%89%E5%8D%93/image-20230214223605505.png" style="zoom:80%;"><p>ğŸ–ã€ä¸ªäººçŒœæƒ³ã€‘ä¸ºä»€ä¹ˆç±»ä¼¼&#x2F;devï¼Œ&#x2F;apexè¿™ç§éœ€è¦ä½¿ç”¨tmpfsæ–‡ä»¶ç³»ç»Ÿï¼š</p><ul><li>åƒå®‰å“çš„è®¾å¤‡åˆ›å»ºåéƒ½åœ¨&#x2F;devç›®å½•ä¸‹ï¼Œé©±åŠ¨ä¼šä»¥&#x2F;dev&#x2F;xxxçš„æ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šå‘ç”Ÿå¤§é‡çš„IOæ“ä½œï¼Œæ˜¾ç„¶ä½¿ç”¨tmpfsæ›´å¿«</li><li>åƒARTï¼ŒVNDKç­‰éƒ½å­˜åœ¨äº&#x2F;apexä¸­ï¼Œå®‰å“å¯åŠ¨çš„æ—¶å€™è™šæ‹ŸæœºARTåˆ›å»ºéƒ½åœ¨&#x2F;apexä¸­</li></ul><h2 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h2><ul><li><a href="https://www.bilibili.com/video/BV1HG4y1K76E/">https://www.bilibili.com/video/BV1HG4y1K76E/</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linuxå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹åŠ¨æŒ‚è½½apexåŒ…åˆ°loopè®¾å¤‡</title>
    <link href="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/"/>
    <url>/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h1 id="ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ"><a href="#ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ" class="headerlink" title="ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ"></a>ã€å®éªŒã€‘æ‰‹åŠ¨æŒ‚è½½apexé•œåƒ</h1><h2 id="1-loopè®¾å¤‡"><a href="#1-loopè®¾å¤‡" class="headerlink" title="1.loopè®¾å¤‡"></a>1.loopè®¾å¤‡</h2><p>åœ¨ç±» UNIX ç³»ç»Ÿé‡Œï¼Œloop è®¾å¤‡æ˜¯ä¸€ç§ä¼ªè®¾å¤‡(pseudo-device)ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ˜¯ä»¿çœŸè®¾å¤‡ã€‚å®ƒèƒ½ä½¿æˆ‘ä»¬åƒå—è®¾å¤‡ä¸€æ ·è®¿é—®ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>è¿™è¦å…ˆä»mountçš„æµç¨‹æ¥ç†è§£ï¼ŒæŒ‚è½½æ“ä½œï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠè®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ&#x2F;ç›®å½•æ–‡ä»¶è¿æ¥åˆ°æŒ‡å®šçš„ç›®å½•ï¼ˆdirectoryï¼‰ä¸‹ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢å°±æ˜¯æŠŠæŒ‚è½½è®¾å¤‡å’ŒæŒ‚è½½ç›®å½•çš„å¯¹åº”å…³ç³»åŠ åˆ°å†…æ ¸ä¸­çš„Vfsmounté‡Œçš„å¯¹åº”è¡¨å•é‡Œï¼ˆå†…æ ¸å¯åŠ¨åä¼šä»ç¡¬ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜é‡Œï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—®ç›®å½•è·¯å¾„æ¥è®¿é—®è®¾å¤‡ä¸Šçš„æ•°æ®äº†ã€‚</p><p>loop mountæ˜¯å¦ä¸€ç§mountæ–¹å¼ï¼Œå¦‚æœè¯´æ™®é€šmountè§£å†³äº†å®é™…ç¡¬ä»¶å­˜å‚¨è®¾å¤‡çš„æŒ‚è½½ï¼Œbind mountè§£å†³äº†ç›®å½•åˆ°ç›®å½•çš„æŒ‚è½½ï¼Œé‚£ä¹ˆloop mountåˆ™è§£å†³äº†å°†<strong>æ¡£æ¡ˆæ–‡ä»¶</strong>åˆ°ç›®å½•çš„æŒ‚è½½</p><p>æ¡£æ¡ˆï¼Œè‹±æ–‡Archiveï¼Œä¸æ–‡ä»¶ï¼ˆfileï¼‰ä¸åŒï¼Œæ˜¯ä¸€ä¸ªæ‰“åŒ…å¥½çš„æ–‡ä»¶é›†ï¼Œé‡Œé¢ä¸€èˆ¬åŒ…å«è®¸å¤šæ–‡ä»¶, æ¯”å¦‚ tarï¼Œjarï¼Œiso ï¼Œimgå°±æ˜¯å¸¸è§çš„æ¡£æ¡ˆæ ¼å¼</p><p>é‚£åˆæ˜¯æ€ä¹ˆå®ç°å°†æ¡£æ¡ˆæ–‡ä»¶æŒ‚è½½åˆ°ç›®å½•ä¸‹å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs she">å®é™…ä¸Šï¼Œç³»ç»Ÿå…ˆæŠŠæ¡£æ¡ˆæ–‡ä»¶ï¼ˆæ¯”å¦‚æŸä¸ª.isoæ–‡ä»¶ï¼‰æ˜ å°„åˆ°loopè®¾å¤‡ä¸Š<br>#losetup  /dev/loop0   xxxx.iso        ä½¿ç³»ç»Ÿè¯¯è®¤ä¸ºxxxx.isoä¸ºå­˜å‚¨è®¾å¤‡/dev/loop0<br><br>å†æ¬ºéª—mountå‘½ä»¤ï¼Œä½¿ä»–è®¤ä¸º  /dev/loop0çœŸçš„æ˜¯ä¸ªè®¾å¤‡åœ¨è¿è¡Œï¼ŒæŒ‚è½½åˆ°æŒ‡å®šç›®å½•<br>#mount   -t   xxxx.iso   /dev/loop0    /loopè®¾å¤‡è·¯å¾„    <br><br></code></pre></td></tr></table></figure><p>ä½†å‰ææ˜¯ï¼Œè¢«è®¿é—®çš„loopè®¾å¤‡é‡Œçš„æ¡£æ¡ˆæ–‡ä»¶å…·æœ‰linuxè¯†åˆ«çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåƒtar, jar, zip è¿™æ ·çš„æ¡£æ¡ˆï¼Œåªæ˜¯ä¸€ç§å‹ç¼©æ ¼å¼ï¼Œæœ¬èº«ä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå³ä½¿é€šè¿‡loop mountæŒ‚è½½ä¸Šå»äº†ï¼Œç›´æ¥è®¿é—®ä»–ä¹Ÿè¯»ä¸å‡ºä»€ä¹ˆæ•°æ®ï¼Œè¿™å¾ˆå¥½ç†è§£ï¼Œå°±åƒåœ¨windowsä¸‹ä¸è£…ä»»ä½•è§£å‹è½¯ä»¶ï¼Œå°±æ— æ³•æ‰“å¼€å‹ç¼©æ–‡ä»¶ä¸€æ ·ã€‚<u><strong>æ‰€æœ‰ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯æ‹¿imgã€isoæ˜ å°„åˆ°loopè®¾å¤‡ã€‚</strong></u></p><h2 id="2-apexåŒ…ç»“æ„"><a href="#2-apexåŒ…ç»“æ„" class="headerlink" title="2.apexåŒ…ç»“æ„"></a>2.apexåŒ…ç»“æ„</h2><p>APEXæ–‡ä»¶æ ¼å¼å¦‚ä¸‹</p><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/20200601191934566.png"><p>ä»é¡¶å±‚çœ‹ï¼ŒAPEXæ–‡ä»¶æ˜¯ä¸€ä¸ªZipæ–‡ä»¶ï¼Œå…¶ä¸­çš„æ–‡ä»¶å‡æ˜¯æœªå‹ç¼©çš„ã€‚</p><p>å…¶ä¸­çš„å››ä¸ªæ–‡ä»¶æœ‰<code>apex_manifest.json</code>ï¼Œ<code>AndroidManifest.xml</code>ï¼Œ<code>apex_pubkey</code>ï¼Œ<code>apex_payload.img</code></p><ul><li><p>apex_manifest.jsonæ–‡ä»¶åŒ…æ‹¬package nameå’Œç‰ˆæœ¬ï¼Œç”¨æ¥æ ‡è¯†è¯¥APEXæ–‡ä»¶</p></li><li><p>AndroidManifest.xmlå¯ä»¥å…è®¸APEXæ–‡ä»¶ä½¿ç”¨ä¸€äº›apkçš„å·¥å…·ï¼Œåƒadbã€package managerã€ app install appç­‰ã€‚ä¸¾ä¸ªä¾‹å­APEXæ–‡ä»¶å¯ä»¥ä½¿ç”¨aaptæ£€æŸ¥æ–‡ä»¶çš„metadataã€‚è¯¥æ–‡ä»¶è¿˜åŒ…æ‹¬packcage nameå’Œç‰ˆæœ¬å·ï¼Œè¿™äº›å†…å®¹é€šå¸¸ä¹Ÿä¼šå†apex_manifest.jsonæ–‡ä»¶ä¸­ã€‚</p></li><li><p>apex_payload.imgæ˜¯ä¾èµ–dm-verityçš„EXT4æ–‡ä»¶ç³»ç»Ÿé•œåƒã€‚è¯¥é•œåƒåœ¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå›ç¯è®¾å¤‡åŠ è½½ã€‚å…·ä½“åœ°è¯´ï¼Œmetadataå’Œhash treeæ˜¯é€šè¿‡libavbåˆ›å»ºçš„ã€‚apex_payload.imgè¿˜æ²¡æœ‰è¢«è§£æï¼Œå› ä¸ºè¦æ±‚è¯¥æ–‡ä»¶æ˜¯å¯æŒ‚è½½çš„ã€‚ä¸€äº›å¸¸è§„æ–‡ä»¶åŒ…å«åœ¨è¯¥é•œåƒä¸­ã€‚</p></li><li><p>apex_pubkeyæ˜¯ç”¨æ¥ç»™æ–‡ä»¶ç³»ç»Ÿç­¾åçš„å…¬é’¥ã€‚è¯¥å…¬é’¥ç¡®ä¿ä¸‹è½½çš„apexæ–‡ä»¶æ˜¯ä»¥ç¼–è¯‘é˜¶æ®µç›¸åŒçš„æ–¹å¼ç­¾åã€‚</p></li></ul><h2 id="3-å¼€å§‹å®éªŒ"><a href="#3-å¼€å§‹å®éªŒ" class="headerlink" title="3.å¼€å§‹å®éªŒ"></a>3.å¼€å§‹å®éªŒ</h2><ol><li><p><strong>å°†apexè§£å‹ç¼©ï¼Œä¸Šä¼ åˆ°Linuxä¸­</strong></p><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/image-20230204111723539.png"></li></ol><p>å…¶å®apexåŒ…å°±æ˜¯ä¸ªå‹ç¼©åŒ…ï¼Œå°†åç¼€åæ”¹æˆ<code>.zip</code>ï¼Œè‡ªè¡Œä½¿ç”¨Windowsè§£å‹å·¥å…·è¿›è¡Œè§£å‹</p><p><strong>ä¸Šä¼ åæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„æ–‡ä»¶ç»“æ„å’Œå®ƒçš„æ–‡ä»¶ç³»ç»Ÿå±æ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ file apex_payload.img <br>apex_payload.img: Linux rev 1.0 ext2 filesystem data, UUID=7d1522e1-9dfa-5edb-a43e-98e3a4d20250 (extents) (large files) (huge files)<br><br>amx@amxxxx:~/Android/system$ tune2fs -l apex_payload.img <br>tune2fs 1.44.5 (15-Dec-2018)<br>Filesystem volume name:   &lt;none&gt;<br>Last mounted on:          &lt;not available&gt;<br>Filesystem UUID:          7d1522e1-9dfa-5edb-a43e-98e3a4d20250<br>Filesystem magic number:  0xEF53<br>Filesystem revision <span class="hljs-comment">#:    1 (dynamic)</span><br>Filesystem features:      ext_attr dir_index filetype extent sparse_super large_file huge_file uninit_bg dir_nlink extra_isize shared_blocks<br>Filesystem flags:         signed_directory_hash <br>Default mount options:    user_xattr acl<br>Filesystem state:         clean<br>Errors behavior:          Continue<br>Filesystem OS <span class="hljs-built_in">type</span>:       Linux<br>Inode count:              32<br>Block count:              8213<br>Reserved block count:     0<br>Free blocks:              8<br>Free inodes:              5<br>First block:              0<br>Block size:               4096<br>Fragment size:            4096<br>Blocks per group:         32768<br>Fragments per group:      32768<br>Inodes per group:         32<br>Inode blocks per group:   2<br>Filesystem created:       Thu Jan  1 08:00:01 1970<br>Last mount time:          n/a<br>Last write time:          Thu Jan  1 08:00:01 1970<br>Mount count:              0<br>Maximum mount count:      -1<br>Last checked:             Thu Jan  1 08:00:01 1970<br>Check interval:           0 (&lt;none&gt;)<br>Lifetime writes:          32 MB<br>Reserved blocks uid:      0 (user root)<br>Reserved blocks gid:      0 (group root)<br>First inode:              11<br>Inode size:               256<br>Required extra isize:     32<br>Desired extra isize:      32<br>Default directory <span class="hljs-built_in">hash</span>:   half_md4<br>Directory Hash Seed:      7d1522e1-9dfa-5edb-a43e-98e3a4d20250<br></code></pre></td></tr></table></figure><ol start="2"><li><strong>æŸ¥çœ‹å½“å‰ç©ºé—²çš„loopè®¾å¤‡</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo losetup -f<br>/dev/loop0<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“å‰ç©ºé—²çš„loopè®¾å¤‡ä¸º<code>/dev/loop0</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“ç®—å°†apexä¸&#x2F;dev&#x2F;loop0è¿›è¡Œå…³è”</p><ol start="3"><li><strong>å°†apexé•œåƒä¸loopè®¾å¤‡å…³è”</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo losetup /dev/loop0 apex_payload.img<br></code></pre></td></tr></table></figure><ol start="4"><li><strong>å°†loopè®¾å¤‡æŒ‚è½½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Š</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">amx@amxxxx:~/Android/system$ sudo mount -o ro /dev/loop0 /home/amx/Android/apex/com.android.i18n<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æ¨¡ä»¿äº†å®‰å“å°†å®ƒæŒ‚è½½åˆ°äº†<code>/home/amx/Android/apex/com.android.i18n</code></p><blockquote><p>è¿™é‡Œåªèƒ½ä½¿ç”¨roåªè¯»å½¢å¼æŒ‚è½½ï¼Œå› ä¸ºapex_playload.imgé‡‡ç”¨äº†ext4æ–‡ä»¶ç³»ç»Ÿï¼Œä¸”åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ äº†<code>shared_block</code>å±æ€§ï¼Œè¯¥å±æ€§ä¸å…è®¸éšæ„ä¿®æ”¹é•œåƒæ–‡ä»¶ï¼Œä¹Ÿæ˜¯ä¸ºäº†å°†é•œåƒæ–‡ä»¶å°½é‡å‹ç¼©åˆ°æœ€å°ï¼ˆä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥å…±äº«å—ï¼‰ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡æ”¹å˜inodeç»“æ„æ”¹å˜è¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯æœ‰ç‚¹éš¾åº¦ï¼Œéœ€è¦äº†è§£extæ–‡ä»¶ç³»ç»Ÿæ‰è¡Œã€‚</p></blockquote><ol start="5"><li><strong>æŸ¥çœ‹æ˜¯å¦æŒ‚è½½æˆåŠŸ</strong></li></ol><img src="/2023/02/04/%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BDapex%E5%8C%85%E5%88%B0loop%E8%AE%BE%E5%A4%87/image-20230204111215939.png"><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥åƒè®¿é—®å—è®¾å¤‡ä¸€æ ·è®¿é—®apexåŒ…å•¦</p><ol start="6"><li><strong>è¯´æ˜</strong></li></ol><p>çœŸå®çš„å®‰å“ç¯å¢ƒä¸­æ˜¯å…ˆsystem&#x2F;apexä¸‹é¢çš„apexåŒ…æŒ‚è½½åˆ°å¯¹åº”çš„ç‰ˆæœ¬ç›®å½•ä¸‹ï¼Œä¾‹å¦‚adbä¼šå…ˆæŒ‚è½½åˆ°<code>/apex/com.android.adb@300009</code>ï¼Œç„¶åå†å°†<code>/apex/com.android.adb@300009</code>ä»¥bindæ–¹å¼æŒ‚è½½åˆ°<code>/apex/com.android.adb</code></p><h2 id="4-å‚è€ƒ"><a href="#4-å‚è€ƒ" class="headerlink" title="4.å‚è€ƒ"></a>4.å‚è€ƒ</h2><ul><li><a href="https://blog.csdn.net/shengxia1999/article/details/52081286?spm=1001.2014.3001.5506">https://blog.csdn.net/shengxia1999/article/details/52081286?spm=1001.2014.3001.5506</a></li><li><a href="https://blog.csdn.net/qq_28351465/article/details/106458089?spm=1001.2014.3001.5506">https://blog.csdn.net/qq_28351465/article/details/106458089?spm=1001.2014.3001.5506</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å“å¼€æœºåŠ¨ç”»</title>
    <link href="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/"/>
    <url>/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹"><a href="#å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹" class="headerlink" title="å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹"></a>å®‰å“Så¼€æœºåŠ¨ç”»æµç¨‹</h1><p>å¼€æœºåŠ¨ç”»æ˜¯<strong>åœ¨SurfaceFlingerå®ä¾‹é€šè¿‡è°ƒç”¨startBootAnim()å¯åŠ¨çš„</strong>ï¼ŒBootAnimæ˜¯å¦‚ä½•å¯åŠ¨å’Œç»“æŸçš„ï¼Œæ€»ä½“æ¡†æ¶å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/æ•´ä½“æ¶æ„2.png"><h2 id="1-SurfaceFlingerè¿›ç¨‹å¯åŠ¨"><a href="#1-SurfaceFlingerè¿›ç¨‹å¯åŠ¨" class="headerlink" title="1.SurfaceFlingerè¿›ç¨‹å¯åŠ¨"></a>1.SurfaceFlingerè¿›ç¨‹å¯åŠ¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/frameworks/native/services/surfaceflinger/surfaceflinger.rc</span><br>service surfaceflinger /system/bin/surfaceflinger<br>    class core animation<br>    user system<br>    group graphics drmrpc readproc<br>    capabilities SYS_NICE<br>    onrestart restart zygote<br>    task_profiles HighPerformance<br>    socket pdx/system/vr/display/client     stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0<br>    socket pdx/system/vr/display/manager    stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0<br>    socket pdx/system/vr/display/vsync      stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0<br><br></code></pre></td></tr></table></figure><p>initè¿›ç¨‹ä¼šæ ¹æ®surfaceflinger.rcé…ç½®å¯åŠ¨surfaceflingerè¿›ç¨‹ï¼Œsurfaceflingerè¿›ç¨‹(&#x2F;system&#x2F;bin&#x2F;surfaceflinger)å¯åŠ¨ï¼Œä¼šèµ°åˆ°mainå‡½æ•°é‡Œé¢ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">/frameworks/native/services/surfaceflinger/Android.bp</span><br>filegroup &#123;<br>    name: &quot;surfaceflinger_binary_sources&quot;,<br>    srcs: [<br>        &quot;:libsurfaceflinger_sources&quot;,<br>        &quot;main_surfaceflinger.cpp&quot;,<br>    ],<br>&#125;<br><br>cc_binary &#123;<br>    name: &quot;surfaceflinger&quot;,<br>    defaults: [&quot;libsurfaceflinger_binary&quot;],<br>    init_rc: [&quot;surfaceflinger.rc&quot;],<br>    srcs: [<br>        &quot;:surfaceflinger_binary_sources&quot;,<br>        // Note: SurfaceFlingerFactory is not in the filegroup so that it<br>        // can be easily replaced.<br>        &quot;SurfaceFlingerFactory.cpp&quot;,<br>    ],<br>    shared_libs: [<br>        &quot;libSurfaceFlingerProp&quot;,<br>    ],<br><br>     logtags: [&quot;EventLog/EventLogTags.logtags&quot;],<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘surfaceflingeräºŒè¿›åˆ¶è¿›ç¨‹çš„æºæ–‡ä»¶ä¸º<code>surfaceflinger_binary_sources</code>å’Œ<code>SurfaceFlingerFactory.cpp</code>ï¼Œå…¶ä¸­surfaceflinger_binary_sourcesæ¥æºäº<code>main_surfaceflinger.cpp</code></p><h2 id="2-æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡"><a href="#2-æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡" class="headerlink" title="2.æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡"></a>2.æ³¨å†Œå¯åŠ¨surfaceflingeræœåŠ¡</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span>**)</span> </span>&#123;<br><span class="hljs-comment">// ...</span><br><br>    sp&lt;SurfaceFlinger&gt; flinger = surfaceflinger::<span class="hljs-built_in">createSurfaceFlinger</span>(); <span class="hljs-comment">//åˆ›å»ºsurfaceflingeræœåŠ¡å®ä¾‹</span><br><br><span class="hljs-comment">// ...</span><br>    flinger-&gt;<span class="hljs-built_in">init</span>();  <span class="hljs-comment">// åˆå§‹åŒ–flingerå®ä¾‹</span><br><br>    <span class="hljs-comment">// å‘ServiceManageræ³¨å†ŒsurfaceflingeræœåŠ¡</span><br>    <span class="hljs-function">sp&lt;IServiceManager&gt; <span class="hljs-title">sm</span><span class="hljs-params">(defaultServiceManager())</span></span>;<br>    sm-&gt;<span class="hljs-built_in">addService</span>(<span class="hljs-built_in">String16</span>(SurfaceFlinger::<span class="hljs-built_in">getServiceName</span>()), flinger, <span class="hljs-literal">false</span>,<br>                   IServiceManager::DUMP_FLAG_PRIORITY_CRITICAL | IServiceManager::DUMP_FLAG_PROTO);<br><br><span class="hljs-comment">// ...</span><br><br>    flinger-&gt;<span class="hljs-built_in">run</span>();   <span class="hljs-comment">// å¯åŠ¨surfaceflingeræœåŠ¡</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨SurfaceFlingerå¯¹è±¡çš„initæ–¹æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SurfaceFlinger::init</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    mStartPropertySetThread = <span class="hljs-built_in">getFactory</span>().<span class="hljs-built_in">createStartPropertySetThread</span>(presentFenceReliable);<br><br>    <span class="hljs-keyword">if</span> (mStartPropertySetThread-&gt;<span class="hljs-built_in">Start</span>() != NO_ERROR) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Run StartPropertySetThread failed!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">ALOGV</span>(<span class="hljs-string">&quot;Done initializing&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>SurfaceFlingerè°ƒç”¨initæ–¹æ³•æ—¶ä¼šè·å–mStartPropertySetThreadï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„Startæ–¹æ³•ï¼Œå…¶å®æ˜¯å‡†å¤‡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»å¯åŠ¨BootAnimation</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// /frameworks/native/services/surfaceflinger/StartPropertySetThread.cpp</span><br><span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">StartPropertySetThread::Start</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">run</span>(<span class="hljs-string">&quot;SurfaceFlinger::StartPropertySetThread&quot;</span>, PRIORITY_NORMAL);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">StartPropertySetThread::threadLoop</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Set property service.sf.present_timestamp, consumer need check its readiness</span><br>    <span class="hljs-built_in">property_set</span>(kTimestampProperty, mTimestampPropertyValue ? <span class="hljs-string">&quot;1&quot;</span> : <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// æ¸…é™¤BootAnimationé€€å‡ºæ ‡å¿—ä½service.bootanim.exit</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.exit&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// è®¾ç½®bootanimçš„è¿›åº¦ä¸º0</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.progress&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-comment">// é€šè¿‡service.bootanim.exit</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ctl.start&quot;</span>, <span class="hljs-string">&quot;bootanim&quot;</span>);<br>    <span class="hljs-comment">// ç«‹å³é€€å‡º</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¿™é‡Œä¸€å¼€å§‹çœ‹èµ·æ¥æ¯”è¾ƒç–‘æƒ‘ï¼Œé¦–å…ˆæ˜¯StartPropertySetThread::Startå‡½æ•°ï¼Œåœ¨<code>StartPropertySetThread.h</code>è¡¨æ˜StartPropertySetThreadç»§æ‰¿è‡ªçˆ¶ç±»Threadï¼Œè€Œçˆ¶ç±»Threadæ˜¯ç”±&lt;utils&#x2F;Thread.h&gt; å¼•å…¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å­ç±»å¼•ç”¨çˆ¶ç±»æ–¹æ³•ï¼Œè¿™é‡Œçš„runå‡½æ•°å°±æ˜¯å°±æ˜¯threadçš„runæ–¹æ³•ã€‚è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»è¿è¡Œï¼Œçº¿ç¨‹åä¸ºâ€StartPropertySetThreadâ€ï¼Œçº¿ç¨‹ä¼˜å…ˆçº§ä¸ºPRIORITY_NORMALã€‚çº¿ç¨‹å¯åŠ¨ä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>_threadLoop</code> å‡½æ•°ï¼Œå®ƒä¼šå»è°ƒç”¨threadLoopå‡½æ•°ã€‚è¿™é‡Œæ•´ä¸ªå‡½æ•°è°ƒç”¨æ ˆå°±æ¸…æ¥šäº†ï¼š</li></ul><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/çº¿ç¨‹å‡½æ•°è°ƒç”¨.png"><ul><li>å½“ç³»ç»Ÿå±æ€§å‘ç”Ÿæ”¹å˜æ—¶ï¼Œinitè¿›ç¨‹å°±ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿå±æ€§å˜åŒ–é€šçŸ¥ï¼Œè¿™ä¸ªé€šçŸ¥æœ€ç»ˆæ˜¯ç”±åœ¨initè¿›ç¨‹ä¸­çš„å‡½æ•°handle_property_set_fdæ¥å¤„ç†</li></ul><h2 id="3-bootanimè¿›ç¨‹å¯åŠ¨"><a href="#3-bootanimè¿›ç¨‹å¯åŠ¨" class="headerlink" title="3.bootanimè¿›ç¨‹å¯åŠ¨"></a>3.bootanimè¿›ç¨‹å¯åŠ¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// /frameworks/base/cmds/bootanimation/bootanimation_main.cpp</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    setpriority(PRIO_PROCESS, <span class="hljs-number">0</span>, ANDROID_PRIORITY_DISPLAY);<br><br>    <span class="hljs-type">bool</span> noBootAnimation = bootAnimationDisabled();<br>    ALOGI_IF(noBootAnimation,  <span class="hljs-string">&quot;boot animation disabled&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!noBootAnimation) &#123;<br>        <span class="hljs-comment">// å¯åŠ¨Binderçº¿ç¨‹æ± </span><br>        sp&lt;ProcessState&gt; <span class="hljs-title function_">proc</span><span class="hljs-params">(ProcessState::self())</span>;<br>        ProcessState::self()-&gt;startThreadPool();<br>        <br>        sp&lt;BootAnimation&gt; boot = new BootAnimation(audioplay::createAnimationCallbacks());<br><br>        waitForSurfaceFlinger();<br>        <br>        boot-&gt;run(<span class="hljs-string">&quot;BootAnimation&quot;</span>, PRIORITY_DISPLAY);<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">bootAnimationDisabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">char</span> value[PROPERTY_VALUE_MAX];<br>    <span class="hljs-comment">// å¦‚æœdebug.sf.nobootanimation=1ï¼Œåˆ™ä¸ä¼šæ˜¾ç¤ºåŠ¨ç”»</span><br>    property_get(<span class="hljs-string">&quot;debug.sf.nobootanimation&quot;</span>, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-keyword">if</span> (atoi(value) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><span class="hljs-comment">// å¦‚æœro.boot.quiescent=1ï¼Œåˆ™ä¸æ˜¾ç¤ºå¼€æœºåŠ¨ç”»</span><br>    property_get(<span class="hljs-string">&quot;ro.boot.quiescent&quot;</span>, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-keyword">if</span> (atoi(value) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// Only show the bootanimation for quiescent boots if this system property is set to enabled</span><br>        <span class="hljs-keyword">if</span> (!property_get_bool(<span class="hljs-string">&quot;ro.bootanim.quiescent.enabled&quot;</span>, <span class="hljs-literal">false</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ¤æ–­å®ŒBootAnimationæ˜¯ä¸æ˜¯disabledä¹‹åï¼Œå¦‚æœnoBootAnimationä¸ºfalseï¼Œåˆ™åˆ›å»ºä¸€ä¸ªBootAnimationå¯¹è±¡ã€‚åˆ›å»ºå®Œäº†BootAnimationå¯¹è±¡åï¼Œè°ƒç”¨å…¶runæ–¹æ³•ï¼Œç”±äºBootAnimationä¹Ÿç»§æ‰¿äº†Threadï¼Œæ‰€ä»¥æœ€ç»ˆä¹Ÿä¼šèµ°åˆ°å¯¹åº”çš„threadLoopæ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BootAnimation::threadLoop</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> r;<br><br>    <span class="hljs-keyword">if</span> (mZipFileName == <span class="hljs-literal">NULL</span>) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        r = <span class="hljs-built_in">movie</span>();  <span class="hljs-comment">// è°ƒç”¨movieæ–¹æ³•</span><br>    &#125;<br>    <span class="hljs-comment">// é”€æ¯ opengl å’Œ egl</span><br>    <span class="hljs-built_in">eglMakeCurrent</span>(mDisplay, EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);<br>    <span class="hljs-built_in">eglDestroyContext</span>(mDisplay, mContext);<br>    <span class="hljs-built_in">eglDestroySurface</span>(mDisplay, mSurface);<br>    mFlingerSurface.<span class="hljs-built_in">clear</span>();<br>    mFlingerSurfaceControl.<span class="hljs-built_in">clear</span>();<br>    <span class="hljs-built_in">eglTerminate</span>(mDisplay);<br>    IPCThreadState::<span class="hljs-built_in">self</span>()-&gt;<span class="hljs-built_in">stopProcess</span>();<br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">BootAnimation::movie</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    String8 desString;<br>    <span class="hljs-comment">// è¯»å– desc.txt é…ç½®æ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">readFile</span>(<span class="hljs-string">&quot;desc.txt&quot;</span>, desString)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-type">char</span> <span class="hljs-type">const</span>* s = desString.<span class="hljs-built_in">string</span>();<br><br>    <span class="hljs-comment">// è§£ææè¿°æ–‡ä»¶</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i=<span class="hljs-number">0</span> ; i&lt;pcount ; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> r=<span class="hljs-number">0</span> ; !part.count || r&lt;part.count ; r++) &#123;<br>            <span class="hljs-comment">// opengl ç»˜åˆ¶æ“ä½œ</span><br>            <span class="hljs-built_in">glClearColor</span>(<br>                    part.backgroundColor[<span class="hljs-number">0</span>],<br>                    part.backgroundColor[<span class="hljs-number">1</span>],<br>                    part.backgroundColor[<span class="hljs-number">2</span>],<br>                    <span class="hljs-number">1.0f</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j=<span class="hljs-number">0</span> ; j&lt;fcount &amp;&amp; (!<span class="hljs-built_in">exitPending</span>() || part.playUntilComplete) ; j++) &#123;<br>                <span class="hljs-function"><span class="hljs-type">const</span> Animation::Frame&amp; <span class="hljs-title">frame</span><span class="hljs-params">(part.frames[j])</span></span>;<br>                <span class="hljs-type">nsecs_t</span> lastFrame = <span class="hljs-built_in">systemTime</span>();<br>                ...<br>                <span class="hljs-keyword">if</span> (r &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, frame.tid);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    ...<br>                    <span class="hljs-built_in">initTexture</span>(frame);<br>                &#125;<br>                <br>                <span class="hljs-comment">// specify the y center as ceiling((mHeight - animation.height) / 2)</span><br>                <span class="hljs-comment">// which is equivalent to mHeight - (yc + animation.height)</span><br>                <span class="hljs-built_in">glDrawTexiOES</span>(xc, mHeight - (yc + animation.height),<br>                              <span class="hljs-number">0</span>, animation.width, animation.height);<br>                <span class="hljs-built_in">eglSwapBuffers</span>(mDisplay, mSurface);<br><br>                <span class="hljs-comment">// ä¸æ–­ç»˜åˆ¶æ—¶æ£€æµ‹æ˜¯å¦éœ€è¦é€€å‡º</span><br>                <span class="hljs-built_in">checkExit</span>();<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœé€€å‡ºäº†å°±è·³å‡ºç»“æŸç»˜åˆ¶</span><br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exitPending</span>() &amp;&amp; !part.count)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// free the textures for this part</span><br>        <span class="hljs-keyword">if</span> (part.count != <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j=<span class="hljs-number">0</span> ; j&lt;fcount ; j++) &#123;<br>                <span class="hljs-function"><span class="hljs-type">const</span> Animation::Frame&amp; <span class="hljs-title">frame</span><span class="hljs-params">(part.frames[j])</span></span>;<br>                <span class="hljs-built_in">glDeleteTextures</span>(<span class="hljs-number">1</span>, &amp;frame.tid);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">// è¯»å– service.bootanim.exit å€¼æ˜¯å¦æ˜¯ 1 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXIT_PROP_NAME <span class="hljs-string">&quot;service.bootanim.exit&quot;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BootAnimation::checkExit</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Allow surface flinger to gracefully request shutdown</span><br>    <span class="hljs-type">char</span> value[PROPERTY_VALUE_MAX];<br>    <span class="hljs-built_in">property_get</span>(EXIT_PROP_NAME, value, <span class="hljs-string">&quot;0&quot;</span>);<br>    <span class="hljs-type">int</span> exitnow = <span class="hljs-built_in">atoi</span>(value);<br>    <span class="hljs-keyword">if</span> (exitnow) &#123;<br>        <span class="hljs-built_in">requestExit</span>();<br>        <span class="hljs-keyword">if</span> (mAudioPlayer != <span class="hljs-literal">NULL</span>) &#123;<br>            mAudioPlayer-&gt;<span class="hljs-built_in">requestExit</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨åŠ¨ç”»åº•å±‚é‡‡ç”¨çš„æ˜¯ opengles çš„æ–¹å¼æ¥æ¸²æŸ“ç»˜åˆ¶çš„ï¼Œç»˜åˆ¶çš„å†…å®¹æ˜¯æœ¬åœ°çš„ä¸€ä¸ªå¯åŠ¨åŠ¨ç”»èµ„æºåŒ…ï¼Œåœ¨ç»˜åˆ¶çš„è¿‡ç¨‹ä¸­ä¼šä¸æ–­çš„åˆ¤æ–­æ˜¯å¦éœ€è¦é€€å‡ºï¼Œè¯»å–çš„å­—æ®µæ˜¯ service.bootanim.exit ï¼Œä¸º 1 ä»£è¡¨éœ€è¦ break é€€å‡ºå¾ªç¯ç»˜åˆ¶ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ° service.bootanim.exit åœ¨å“ªé‡Œè®¾ç½®ä¸º 1 çš„ï¼Œä¾¿å¯æ‰¾åˆ°é€€å‡ºå¯åŠ¨åŠ¨ç”»çš„å…¥å£ã€‚å…³é—­åŠ¨ç”»çš„å…¥å£è¿˜æ˜¯åœ¨ SurfaceFlinger ä¸­åªæ˜¯è¿™ä¸ªè°ƒç”¨æµç¨‹æ¯”è¾ƒå¤æ‚è€Œå·²ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-type">void</span> <span class="hljs-title">handleResumeActivity</span><span class="hljs-params">(IBinder token,</span></span><br><span class="hljs-params"><span class="hljs-function">                                boolean clearHide, boolean isForward, boolean reallyResume)</span> </span>&#123;<br>    ActivityClientRecord r = <span class="hljs-built_in">performResumeActivity</span>(token, clearHide);<br>    <span class="hljs-keyword">if</span> (r != null) &#123;<br>        <span class="hljs-keyword">if</span> (!r.onlyLocalRequest) &#123;<br>            r.nextIdle = mNewActivities;<br>            mNewActivities = r;<br>            <span class="hljs-comment">// æ·»åŠ äº†ä¸€ä¸ª IdleHandler æ¶ˆæ¯</span><br>            Looper.<span class="hljs-built_in">myQueue</span>().<span class="hljs-built_in">addIdleHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Idler</span>());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ...<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> Idler implements MessageQueue.IdleHandler &#123;<br>    @Override<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> boolean <span class="hljs-built_in">queueIdle</span>() &#123;<br>        ActivityClientRecord a = mNewActivities;<br>        <span class="hljs-keyword">if</span> (a != null) &#123;<br>            mNewActivities = null;<br>            IActivityManager am = ActivityManagerNative.<span class="hljs-built_in">getDefault</span>();<br>            ActivityClientRecord prev;<br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-keyword">if</span> (a.activity != null &amp;&amp; !a.activity.mFinished) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// è°ƒç”¨ AMS çš„ activityIdle</span><br>                        am.<span class="hljs-built_in">activityIdle</span>(a.token, a.createdConfig, stopProfiling);<br>                    &#125; <span class="hljs-built_in">catch</span> (RemoteException ex) &#123;<br>                        <span class="hljs-comment">// Ignore</span><br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">while</span> (a != null);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><br>@<span class="hljs-function">Override</span><br><span class="hljs-function">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">void</span> <span class="hljs-title">activityIdle</span><span class="hljs-params">(IBinder token, Configuration config, boolean stopProfiling)</span> </span>&#123;<br>    <span class="hljs-built_in">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>        ActivityStack stack = ActivityRecord.<span class="hljs-built_in">getStackLocked</span>(token);<br>        <span class="hljs-keyword">if</span> (stack != null) &#123;<br>            ActivityRecord r = mStackSupervisor.<span class="hljs-built_in">activityIdleInternalLocked</span>(token, <span class="hljs-literal">false</span>, config);<br>        &#125;<br>    &#125;<br>    Binder.<span class="hljs-built_in">restoreCallingIdentity</span>(origId);<br>&#125;<br><br><span class="hljs-comment">// Checked.</span><br><span class="hljs-function"><span class="hljs-keyword">final</span> ActivityRecord <span class="hljs-title">activityIdleInternalLocked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> IBinder token, boolean fromTimeout,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                Configuration config)</span> </span>&#123;<br>    ActivityRecord r = ActivityRecord.forTokenLocked(token);<br>    <span class="hljs-keyword">if</span> (r != null) &#123;<br>        ...<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isFrontStack</span>(r.task.stack) || fromTimeout) &#123;<br>                booting = <span class="hljs-built_in">checkFinishBootingLocked</span>();<br>            &#125;<br>    &#125;<br>    ...<br>        <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> boolean <span class="hljs-title">checkFinishBootingLocked</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> boolean booting = mService.mBooting;<br>    boolean enableScreen = <span class="hljs-literal">false</span>;<br>    mService.mBooting = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!mService.mBooted) &#123;<br>        mService.mBooted = <span class="hljs-literal">true</span>;<br>        enableScreen = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (booting || enableScreen) &#123;<br>        mService.<span class="hljs-built_in">postFinishBooting</span>(booting, enableScreen);<br>    &#125;<br>    <span class="hljs-keyword">return</span> booting;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">enableScreenAfterBoot</span><span class="hljs-params">()</span> </span>&#123;<br>    mWindowManager.<span class="hljs-built_in">enableScreenAfterBoot</span>();<br>    <span class="hljs-built_in">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>        <span class="hljs-built_in">updateEventDispatchingLocked</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">performEnableScreen</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">synchronized</span>(mWindowMap) &#123;<br>        <span class="hljs-keyword">if</span> (!mBootAnimationStopped) &#123;<br>            <span class="hljs-comment">// å‘SurfaceFlinger è¿›ç¨‹å‘èµ·å…³é—­å¼€æœºç•Œé¢çš„æ¶ˆæ¯</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                IBinder surfaceFlinger = ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">&quot;SurfaceFlinger&quot;</span>);<br>                <span class="hljs-keyword">if</span> (surfaceFlinger != null) &#123;<br>                    Parcel data = Parcel.<span class="hljs-built_in">obtain</span>();<br>                    data.<span class="hljs-built_in">writeInterfaceToken</span>(<span class="hljs-string">&quot;android.ui.ISurfaceComposer&quot;</span>);<br>                    <span class="hljs-comment">// å‘SurfaceComposerå‘é€</span><br>                    surfaceFlinger.<span class="hljs-built_in">transact</span>(IBinder.FIRST_CALL_TRANSACTION, <span class="hljs-comment">// BOOT_FINISHED</span><br>                                            data, null, <span class="hljs-number">0</span>);<br>                    data.<span class="hljs-built_in">recycle</span>();<br>                &#125;<br>            &#125; <span class="hljs-built_in">catch</span> (RemoteException ex) &#123;<br>                ...<br>            &#125;<br>            mBootAnimationStopped = <span class="hljs-literal">true</span>;<br>        &#125;<br>        ...<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ----------------------------------------------------------------------</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">ISurfaceComposerTag</span> &#123;<br>    BOOT_FINISHED = IBinder::FIRST_CALL_TRANSACTION,<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// /frameworks/native/libs/gui/ISurfaceComposer.cpp</span><br><span class="hljs-type">status_t</span> BnSurfaceComposer::<span class="hljs-built_in">onTransact</span>(<br>    <span class="hljs-type">uint32_t</span> code, <span class="hljs-type">const</span> Parcel&amp; data, Parcel* reply, <span class="hljs-type">uint32_t</span> flags)&#123;<br>    <span class="hljs-keyword">switch</span>(code) &#123;<br>            <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">case</span> BOOT_FINISHED: &#123;<br>            <span class="hljs-built_in">CHECK_INTERFACE</span>(ISurfaceComposer, data, reply);<br>            <span class="hljs-built_in">bootFinished</span>();<br>            <span class="hljs-keyword">return</span> NO_ERROR;<br>        &#125;<br>            <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">// ----------------------------------------------------------------------</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SurfaceFlinger::bootFinished</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// æŠŠ service.bootanim.exit å±æ€§è®¾ç½®ä¸º 1 ï¼Œbootanim è¿›ç¨‹è¯»åˆ° 1 æ—¶å°±ä¼šé€€å‡ºå¼€æœºå¯åŠ¨åŠ¨ç”»</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;service.bootanim.exit&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é—­å¼€æœºå¯åŠ¨åŠ¨ç”»çš„æµç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæˆ‘ä»¬æ¥ç¼•ä¸€ç¼•æ•´ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬çš„ Launcher è¿›ç¨‹å¯åŠ¨åä¼šå¯åŠ¨æˆ‘ä»¬ Launcher Activity ç•Œé¢ï¼Œè€Œ Activity çš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨éƒ½æ˜¯ç”± ActivityThread æ¥æ‰§è¡Œçš„ï¼Œå…¶ä¸­å°±ä¼šæ‰§è¡Œåˆ° handleResumeActivity æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šæ·»åŠ ä¸€ä¸ª IdleHandler æ¶ˆæ¯ï¼Œä¼šè°ƒç”¨åˆ° AMS çš„ activityIdle æ–¹æ³•ï¼ŒAMS ä¼šè°ƒç”¨ WMS çš„ enableScreenAfterBoot æ–¹æ³•ï¼ŒWMS ä¼šè·¨è¿›ç¨‹é€šçŸ¥ SurfaceFlinger å»å…³é—­æˆ‘ä»¬çš„å¼€æœºå¯åŠ¨åŠ¨ç”»ã€‚</p><h2 id="4-å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ"><a href="#4-å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ" class="headerlink" title="4.å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ"></a>4.å¼€æœºåŠ¨ç”»åŒ…é‡Œæœ‰ä»€ä¹ˆ</h2><p>è¿™é‡Œå»ºè®®å…ˆçœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š&#x2F;frameworks&#x2F;base&#x2F;cmds&#x2F;bootanimation&#x2F;FORMAT.md</p><p>å¼€æœºåŠ¨ç”»æŒ‡çš„æ˜¯ä»¥bootanimation.zipæ–¹å¼å­˜åœ¨ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šä¾æ¬¡é€‰æ‹©ä¸€ä¸ªbootanimation.zipåŠ è½½</p><ol><li>&#x2F;system&#x2F;media&#x2F;bootanimation-encrypted.zip (if getprop(â€œvold.decryptâ€) &#x3D; â€˜1â€™)</li><li>&#x2F;system&#x2F;media&#x2F;bootanimation.zip</li><li>&#x2F;oem&#x2F;media&#x2F;bootanimation.zip</li></ol><p><code>bootanimation.zip</code> æ–‡ä»¶ä¸­åŒ…å«ï¼š</p><img src="/2023/01/25/%E5%AE%89%E5%8D%93%E5%BC%80%E6%9C%BA%E5%8A%A8%E7%94%BB/å‹ç¼©æ–‡ä»¶.png"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">desc.txt - a text file<br>part0  \<br>part1   \  directories full of PNG frames<br>...     /<br>partN  /<br></code></pre></td></tr></table></figure><p><strong>â€œdesc.txtâ€</strong>ï¼š<strong>ç”¨æ¥æè¿°ç”¨æˆ·è‡ªå®šä¹‰çš„å¼€æœºåŠ¨ç”»æ˜¯å¦‚ä½•æ˜¾ç¤ºçš„</strong>ã€‚</p><p>ä»¥ä¸‹é¢çš„ä¾‹å­ä¸ºä¾‹ï¼š</p><blockquote><p>1280 720 1</p><p>p 1 1 part0</p><p>p 0 1 part1</p></blockquote><p>ç¬¬ä¸€è¡Œçš„ä¸‰ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºå¼€æœºåŠ¨ç”»åœ¨å±å¹•ä¸­çš„æ˜¾ç¤ºå®½åº¦ã€é«˜åº¦ä»¥åŠå¸§é€Ÿ(fps)ã€‚å‰©ä½™çš„æ¯ä¸€è¡Œéƒ½ç”¨æ¥æè¿°ä¸€ä¸ªåŠ¨ç”»ç‰‡æ–­ï¼Œè¿™äº›è¡Œå¿…é¡»è¦ä»¥å­—ç¬¦â€œpâ€æ¥å¼€å¤´ï¼Œåé¢ç´§è·Ÿç€ä¸¤ä¸ªæ•°å­—ä»¥åŠä¸€ä¸ªæ–‡ä»¶ç›®å½•è·¯å¾„åç§°ã€‚</p><p>ç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤ºä¸€ä¸ªç‰‡æ–­çš„å¾ªç¯æ˜¾ç¤ºæ¬¡æ•°ï¼Œå¦‚æœå®ƒçš„å€¼ç­‰äº0ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºæ— é™å¾ªç¯åœ°æ˜¾ç¤ºè¯¥åŠ¨ç”»ç‰‡æ–­ã€‚</p><p>ç¬¬äºŒä¸ªæ•°å­—è¡¨ç¤ºæ¯ä¸€ä¸ªç‰‡æ–­åœ¨ä¸¤æ¬¡å¾ªç¯æ˜¾ç¤ºä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚è¿™ä¸ªæ—¶é—´é—´éš”æ˜¯ä»¥ä¸€ä¸ªå¸§çš„æ—¶é—´ä¸ºå•ä½çš„ã€‚</p><p>æ–‡ä»¶ç›®å½•ä¸‹é¢ä¿å­˜çš„æ˜¯ä¸€ç³»åˆ—pngæ–‡ä»¶ï¼Œè¿™äº›pngæ–‡ä»¶ä¼šè¢«ä¾æ¬¡æ˜¾ç¤ºåœ¨å±å¹•ä¸­ã€‚</p><h2 id="å‚è€ƒèµ„æ–™ï¼š"><a href="#å‚è€ƒèµ„æ–™ï¼š" class="headerlink" title="å‚è€ƒèµ„æ–™ï¼š"></a>å‚è€ƒèµ„æ–™ï¼š</h2><ul><li><a href="https://blog.51cto.com/u_11176305/3796348">https://blog.51cto.com/u_11176305/3796348</a></li><li><a href="https://www.cnblogs.com/lufeibin/p/13529981.html">https://www.cnblogs.com/lufeibin/p/13529981.html</a></li><li><a href="https://blog.csdn.net/weixin_36044720/article/details/117277602?spm=1001.2014.3001.5506">https://blog.csdn.net/weixin_36044720/article/details/117277602?spm=1001.2014.3001.5506</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android-Trebleè®¡åˆ’</title>
    <link href="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/"/>
    <url>/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/</url>
    
    <content type="html"><![CDATA[<ul><li>ğŸ•Šï¸æœ¬æ–‡æ¥è‡ªè§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=zbebx1Kvqho">https://www.youtube.com/watch?v=zbebx1Kvqho</a></li><li>å¼•ç”¨éƒ¨åˆ†åšå®¢ï¼š<a href="https://new.qq.com/rain/a/20191016A070PF00">https://new.qq.com/rain/a/20191016A070PF00</a></li><li><a href="https://www.freesion.com/article/69471423144/">https://www.freesion.com/article/69471423144/</a></li></ul><h2 id="1-Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜"><a href="#1-Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜" class="headerlink" title="1.Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜"></a>1.Andriodè¿›å…¥Trebleä¹‹å‰å­˜åœ¨ä»€ä¹ˆé—®é¢˜</h2><p>åœ¨Android 8.0ï¼ˆAndroid Oreoï¼‰ä¹‹å‰é‚£ä¸ªæ—¶ä»£ï¼Œè‹¹æœæ‰‹æœºä¸€æ—¦æœ‰äº†æ–°çš„ç³»ç»Ÿæ›´æ–°ï¼Œç”¨æˆ·éƒ½èƒ½åœ¨çŸ­æ—¶é—´å†…æ›´æ–°ç³»ç»Ÿï¼Œå¯¹ç”¨æˆ·æ¥è¯´å®åœ¨å¤ªç®€å•äº†ï¼Œç”¨æˆ·åªéœ€è¦ç‚¹å‡»æ›´æ–°ä¸‹è½½æ–°ç³»ç»Ÿå°±å¯ä»¥å®Œç¾çš„æ‹¥æœ‰æœ€æ–°çš„ç³»ç»ŸåŠŸèƒ½ã€‚è€Œå¯¹äºå®‰å“ç”¨æˆ·è€Œè¨€ï¼Œå½“å®‰å“å‘å¸ƒæ–°çš„æºç ä»¥åï¼Œä¼šç»è¿‡ä¸‹é¢ä¸€ç³»åˆ—çš„æ“ä½œï¼Œç”¨æˆ·æ‰èƒ½ç”¨ä¸ŠçœŸæ­£çš„å…¨æ–°å®‰å“ç³»ç»Ÿã€‚</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/ç”Ÿæˆè¿‡ç¨‹.png" style="zoom: 80%;"><ol><li>å‘å¸ƒæºç ï¼šGoogleå°†æ–°ç³»ç»Ÿæºç å‘å¸ƒè‡³AOSP</li><li>å¯åŠ¨ç¡¬ä»¶é€‚é…ï¼šèŠ¯ç‰‡åˆ¶é€ å•†å¦‚<strong>ä¸‰æ˜Ÿ</strong>ã€<strong>é«˜é€š</strong>ã€<strong>è”å‘ç§‘</strong>ã€<strong>åä¸º</strong>ç­‰å¯¹æºç è¿›è¡Œä¿®æ”¹ï¼Œç¡®ä¿è‡ªå®¶çš„èŠ¯ç‰‡åœ¨æ–°ç‰ˆAndroidèƒ½æ­£å¸¸è¿è¡Œå’Œå‘æŒ¥æ€§èƒ½</li><li>OEMé€‚é…ï¼šOEM å‚å•†è¿›ä¸€æ­¥ä¿®æ”¹æ–°ç³»ç»Ÿ</li><li>OEMæµ‹è¯•ï¼šOEM å‚å•†å¯¹ç³»ç»Ÿè¿›è¡Œå†…éƒ¨æµ‹è¯•</li><li>æ¨é€ç»™ç”¨æˆ·ï¼šè¯•æ— è¯¯åçš„æ–°ç‰ˆç³»ç»Ÿé€šè¿‡ OTA æ¨é€ç»™ç”¨æˆ·</li></ol><p>è¿™æ ·å¸¦æ¥çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Œç”¨è°·æ­Œå¼€å‘å›¢é˜Ÿçš„è¯æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šèŠ±è´¹5-12ä¸ªæœˆçš„æ—¶é—´â€¦â€¦å¯„ğŸ“</p><p>è™½ç„¶Googleåœ¨æäº¤AOSPæºç ä¸Šéå¸¸è¿…é€Ÿï¼Œä½†æ˜¯èŠ¯ç‰‡åˆ¶é€ å•†å’ŒOEMå‚å•†å¾€å¾€å› ä¸ºæŠ€æœ¯é—®é¢˜ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®šåˆ¶åŸå› ç­‰å¯¼è‡´æ•´ä½“çš„è¿›ç¨‹åæ…¢ï¼Œæœ€ç»ˆå½¢æˆäº†ç”¨æˆ·èŒ«èŒ«ç„¶çš„ç­‰å¾…ï¼Œä»ä»¥å¾€çš„æ•°æ®ç»Ÿè®¡æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒAndroidæ‰‹æœºä¸­æ–°ç³»ç»Ÿçš„è¦†ç›–ç‡å¯¥å¯¥æ— å‡ ã€‚</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/licheng.png" style="zoom: 50%;"><blockquote><p>å¯ä»¥çœ‹åˆ°è‡ªä»å®‰å“8.0é€€å‡ºTrebleä»¥æ¥ï¼Œå®‰å“9.0å¼€å§‹çªé£çŒ›è¿›ï¼Œæ›´æ–°çš„ç”¨æˆ·å‡ ä¹æ˜¯8.0çš„ä¸€å€</p></blockquote><h2 id="2-Trebleè®¡åˆ’"><a href="#2-Trebleè®¡åˆ’" class="headerlink" title="2.Trebleè®¡åˆ’"></a>2.Trebleè®¡åˆ’</h2><h3 id="2-1-Trebleç®€ä»‹"><a href="#2-1-Trebleç®€ä»‹" class="headerlink" title="2.1 Trebleç®€ä»‹"></a>2.1 Trebleç®€ä»‹</h3><p>Android 8.0 ç‰ˆæœ¬çš„ä¸€é¡¹æ–°å…ƒç´ æ˜¯ Project Trebleã€‚è¿™æ˜¯ Androidæ¶æ„æ–¹é¢çš„ä¸€é¡¹é‡å¤§æ”¹å˜ï¼Œä¸»è¦è§£å†³Android ç‰ˆæœ¬ç¢ç‰‡åŒ–é—®é¢˜ï¼Œæ›´æ–¹ä¾¿å¿«æ·çš„å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚å…¶ä¸­æœ€æ ¸å¿ƒçš„ä¸€ç‚¹æ˜¯å°†AOSPä»£ç å’Œä¾›åº”å•†ï¼ˆVendorï¼‰ä»£ç åšå¥½è§£è€¦ã€‚è´´ä¸€å¼ å¼ æ¶æ„å‰åçš„å¯¹æ¯”å›¾ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¶æ„å˜åŒ–.png"><ul><li>å‡çº§å‰ï¼šFrameworkä»£ç å’ŒVendorçš„ä»£ç è€¦åˆï¼Œå³ä½¿è°·æ­Œå‘å¸ƒä¼šå®Œæœ€æ–°AOSPä»£ç ï¼Œè®¾å¤‡å‚å•†ä¹Ÿéœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´å¤„ç†å’ŒVendorä»£ç é€‚é…é—®é¢˜ã€Reworkedã€‘ï¼Œæ‰€ä»¥å‡çº§ä¼šèŠ±è´¹å¾ˆå¤§é‡çš„æ—¶é—´</li></ul><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ–°æ¶æ„.png"><ul><li>æ–°çš„æ¶æ„ï¼šTrebleåœ¨Frameworkå’ŒVendorå®ç°ä»£ç ä¸­é—´å®šä¹‰ä¸€ä¸ªç¨³å®šçš„æ¥å£ï¼Œè¿™æ ·Frameworkä»£ç å’ŒVendorçš„ä»£ç å®ç°è§£è€¦ï¼Œè¿™æ ·è®¾å¤‡å‚å•†èƒ½å¤Ÿå¿«é€Ÿçš„å‡çº§AOSPï¼Œåªè¦æ¥å£ä¸å˜ï¼Œç³»ç»Ÿè¿˜èƒ½æ­£å¸¸èµ·æ¥ã€‚</li></ul><p>ä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹ä»¥å‰çš„Frameworkå±‚å’ŒHALå±‚æ˜¯æ€ä¹ˆäº¤äº’çš„ï¼Ÿ</p><p><strong>Android Oä¹‹å‰ç‰ˆæœ¬çš„æ¡†æ¶ï¼š</strong></p><p>åœ¨æ­¤ä¹‹å‰çš„Android ç³»ç»Ÿæ¶æ„å½“ä¸­ï¼ŒAndroid Framework ä¸Android HALæ˜¯æ‰“åŒ…æˆä¸€ä¸ªsystem.imgçš„ï¼Œè€Œä¸”Framework ä¸HALä¹‹é—´æ˜¯ç´§è€¦åˆçš„ï¼Œé€šè¿‡é“¾æ¥çš„æ–¹å¼ä½¿ç”¨ç›¸åº”çš„ç¡¬ä»¶ç›¸å…³soåº“ã€‚è€ç‰ˆæœ¬çš„android çš„ç³»ç»Ÿæ¡†æ¶å½“ä¸­frameworkä¸HALä¹‹é—´çš„ä¸€èˆ¬æ¶æ„æ¡†æ¶æ˜¯ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¡†æ¶.png"><p>æ‰€ä»¥æ¯æ¬¡Android frameworkçš„å‡çº§éœ€è¦å¯¹åº”çš„Android HALå‡çº§ã€‚æ‰€ä»¥è¿™æ ·æ¯æ¬¡Android å‡çº§éƒ½éœ€è¦Android è®¾å¤‡åˆ¶é€ å•†æŠ•å…¥å¤§é‡çš„äººåŠ›ç‰©ç†å»å‡çº§ç›¸åº”çš„Vendor HAL Implemetation.</p><p><strong>Android OåŠä¹‹åçš„ç‰ˆæœ¬çš„æ¡†æ¶ï¼š</strong></p><p>åœ¨Android Oä»¥åŠä»¥åçš„ç‰ˆæœ¬å½“ä¸­ï¼ŒAndroid æ›´æ–°äº†æ–°çš„æ¡†æ¶è®¾è®¡åœ¨æ–°çš„æ¡†æ¶è®¾è®¡å½“ä¸­ï¼Œå¼•å…¥äº†ä¸€å¥—å«HIDLçš„è¯­è¨€æ¥å®šä¹‰Freameworkä¸HALä¹‹é—´çš„æ¥å£ï¼Œæ–°çš„æ¶æ„å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/HIDL.png"><p>è·Ÿä»¥å¾€çš„Android ç‰ˆæœ¬ç›¸æ¯”è¾ƒï¼ŒAndroid Oé‡Œä½¿ç”¨HIDLæ¥è§£è€¦System Framework ä¸Vendor HAL Implemetationä¹‹é—´çš„å…³ç³»ã€ï¼Œä»è€Œç®€åŒ–é™ä½Androidç³»ç»Ÿå‡çº§çš„å½±å“ä¸éš¾åº¦ã€‚å¹¶ä¸”ç›®å‰çœ‹èµ·æ¥ï¼ŒAndroid Frameworkä¸Vendor HAL Implemetationä¼šå­˜æ”¾åœ¨ä¸åŒçš„åˆ†åŒºå½“ä¸­ï¼ŒAndroid Frameworkä¼šåœ¨systemåˆ†åŒºå½“ä¸­ï¼Œè€ŒVendor HAL Implemetationä¼šåœ¨ä¸€ä¸ªæ–°å®šä¹‰çš„åˆ†åŒº(Vendor.img)å½“ä¸­ï¼Œè¿™æ ·åˆ·æ–°çš„system.img æ‰ä¸ä¼šå½±å“åˆ°Vendor HAL Implemetationã€‚</p><p><strong>æ›´æ¸…æ™°çš„è°ƒç”¨å…³ç³»</strong></p><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/Oä¹‹å‰.png" style="zoom:70%;"><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/Oä¹‹å.png" style="zoom:70%;"><h3 id="2-2-Trebleæ–°æŠ€æœ¯"><a href="#2-2-Trebleæ–°æŠ€æœ¯" class="headerlink" title="2.2 Trebleæ–°æŠ€æœ¯"></a>2.2 Trebleæ–°æŠ€æœ¯</h3><img src="/2023/01/14/Android-Treble%E8%AE%A1%E5%88%92/æ¶æ„å¯¹æ¯”.png"><p><strong>Trebleæ¶æ„ä¸­ä¸ºäº†å®ç°ç³»ç»Ÿå’Œä¾›åº”å•†çš„åˆ†ç¦»ï¼Œå¼•å…¥äº†è®¸å¤šæ–°æŠ€æœ¯ã€‚å…³é”®æŠ€æœ¯åŒ…æ‹¬ï¼š</strong></p><ul><li>HIDLï¼šHALæ¥å£å®šä¹‰è¯­è¨€ï¼Œç”¨äºæŒ‡å®šHALå’Œå…¶ä»–ç”¨æˆ·ä¹‹é—´çš„æ¥å£çš„ä¸€ç›´æ¥å£æè¿°è¯­è¨€(IDL)</li><li>HALï¼šè¿è¡ŒAndroid8.0æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡å¿…é¡»æ”¯æŒä½¿ç”¨HIDLè¯­è¨€ç¼–å†™çš„HALï¼Œåˆ†ä¸ºbinderized HALï¼ˆç»‘å®šå¼ï¼‰å’Œpassthrough HALï¼ˆç›´é€šå¼ï¼‰ã€‚</li><li>è®¾å¤‡æ ‘å åŠ å±‚(DTO)ï¼šå°†è®¾å¤‡æ•°(DT)åˆ†å‰²ä¸ºä¸»DTå’Œå åŠ DTã€‚å åŠ DTç”±ODMå‚å•†æä¾›ï¼Œå­˜æ”¾åœ¨ODMåˆ†åŒºã€‚é€šè¿‡å¯¹å åŠ DTçš„ä¿®æ”¹å‡çº§ï¼Œå¯ä»¥å®ç°åœ¨DTä¸­å¢åŠ è®¾å¤‡èŠ‚ç‚¹å’Œä¿®æ”¹è®¾å¤‡å±æ€§ã€‚</li><li>ä¾›åº”å•†åŸç”Ÿå¼€å‘å¥—ä»¶(VNDK)ï¼šæä¾›äº†ä¸€ç»„è®©ä¾›åº”å•†å®ç°å…¶HALçš„ä¸“ç”¨åº“ã€‚</li><li>ä¾›åº”å•†æ¥å£å¯¹è±¡(VINTF)ï¼šç”¨äºæ±‡æ€»è®¾å¤‡çš„ç›¸å…³ä¿¡æ¯å¹¶é€šè¿‡å¯æŸ¥è¯¢çš„APIæä¾›è¯¥ä¿¡æ¯ã€‚</li><li>SELinuxï¼šAndroid8.0å®ç°SELinuxç­–ç•¥çš„æ¨¡å—åŒ–å’Œå…¼å®¹æ€§ï¼Œç›®æ ‡æ˜¯ä½¿SOCä¾›åº”å•†å’ŒODMç”Ÿäº§å•†èƒ½å¤Ÿä»¥éš”ç¦»æ–¹å¼è‡ªå®šä¹‰SELinuxé…ç½®ï¼Œè€Œæ— éœ€è·¨åˆ†åŒºä¿®æ”¹ã€‚</li></ul><h2 id="ä¿®æ”¹å†å²"><a href="#ä¿®æ”¹å†å²" class="headerlink" title="ä¿®æ”¹å†å²"></a>ä¿®æ”¹å†å²</h2><ul><li>2023&#x2F;01&#x2F;14ï¼šé¦–æ¬¡ç¼–å†™ã€ŠAndroid-Trebleè®¡åˆ’ã€‹</li></ul>]]></content>
    
    
    <categories>
      
      <category>Androidå­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Androidå­¦ä¹ ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•æ­å»ºhexoéƒ¨ç½²åˆ°github</title>
    <link href="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/"/>
    <url>/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/</url>
    
    <content type="html"><![CDATA[<blockquote><p>ğŸ“æœ¬æ–‡çš„å†…å®¹æ˜¯è®°å½•æ­å»ºhexoåšå®¢ï¼Œå¹¶ä¸”éƒ¨ç½²åˆ°githubä¸Š<br>ğŸ–å“ˆå“ˆå“ˆï¼Œæˆ‘å°±æ˜¯è¯¾ä»£è¡¨<br>ğŸ”æ‰€æœ‰å†…å®¹å‡æ¥è‡ªäºï¼š<strong>Bç«™CodeSheep</strong></p></blockquote><h2 id="1-å®‰è£…Nodejs"><a href="#1-å®‰è£…Nodejs" class="headerlink" title="1.å®‰è£…Nodejs"></a>1.å®‰è£…Nodejs</h2><h3 id="1-1-å®‰è£…Nodejs"><a href="#1-1-å®‰è£…Nodejs" class="headerlink" title="1.1 å®‰è£…Nodejs"></a>1.1 å®‰è£…Nodejs</h3><p>Nodejså®˜ç½‘ï¼š<a href="https://nodejs.org/en/">https://nodejs.org/en/</a></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/nodejså®‰è£….png" alt="image-20230114121402814" style="zoom: 67%;"><p>ç›´æ¥æ— è„‘ä¸‹ä¸€æ­¥å®‰è£…ï¼Œå®‰è£…å®Œæˆå<code>node -v</code>æŸ¥çœ‹ç‰ˆæœ¬ç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸ</p><h3 id="1-2-æ›´æ¢é•œåƒ"><a href="#1-2-æ›´æ¢é•œåƒ" class="headerlink" title="1.2 æ›´æ¢é•œåƒ"></a>1.2 æ›´æ¢é•œåƒ</h3><p>ç”±äºnpmåŒ…ç®¡ç†å·¥å…·å®åœ¨å¤ªæ…¢äº†ï¼Œæ‰€ä»¥æ‰“ç®—ä½¿ç”¨æ·˜å®é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install -g cnpm --registry=https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure><p>æœ€åå¯ä»¥é€šè¿‡<code>cnpm -v</code>æŸ¥çœ‹ä¸€ä¸‹cnpmæ˜¯å¦å®‰è£…æˆåŠŸ</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/å®‰è£…npm.png" alt="image-20230114121402814" style="zoom: 67%;"><h2 id="2-å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®"><a href="#2-å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®" class="headerlink" title="2.å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®"></a>2.å®‰è£…Hexoå¹¶åˆå§‹åŒ–hexoé¡¹ç›®</h2><h3 id="2-1-å®‰è£…hexo"><a href="#2-1-å®‰è£…hexo" class="headerlink" title="2.1 å®‰è£…hexo"></a>2.1 å®‰è£…hexo</h3><p>å…ˆé€šè¿‡npmå®‰è£…hexo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cnpm install -g hexo-cli<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆä»¥åï¼Œå¯ä»¥é€šè¿‡<code>hexo -v</code> æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p><h3 id="2-2-åˆå§‹åŒ–hexoé¡¹ç›®"><a href="#2-2-åˆå§‹åŒ–hexoé¡¹ç›®" class="headerlink" title="2.2 åˆå§‹åŒ–hexoé¡¹ç›®"></a>2.2 åˆå§‹åŒ–hexoé¡¹ç›®</h3><ol><li>æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾hexoçš„æ‰€æœ‰å†…å®¹</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir hexo-blog<br></code></pre></td></tr></table></figure><ol start="2"><li>è¿›å…¥è¯¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œè¿›è¡Œåˆå§‹åŒ–</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo init<br></code></pre></td></tr></table></figure><ol start="3"><li>æœ¬åœ°æ‰“å¼€è¯¥é¡¹ç›®</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo s<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>localhost:4000</code>è¿›è¡Œè®¿é—®</p><h3 id="2-3-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"><a href="#2-3-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®" class="headerlink" title="2.3 åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"></a>2.3 åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®</h3><p>åˆ›å»ºè‡ªå·±çš„æ–°åšå®¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo new &quot;å¦‚ä½•æ­å»ºhexoéƒ¨ç½²åˆ°github&quot;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆé™æ€æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo g<br></code></pre></td></tr></table></figure><p>å¯åŠ¨é¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo s<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>localhost:4000</code>è¿›è¡Œè®¿é—®</p><h2 id="3-å°†hexoéƒ¨ç½²åˆ°github"><a href="#3-å°†hexoéƒ¨ç½²åˆ°github" class="headerlink" title="3.å°†hexoéƒ¨ç½²åˆ°github"></a>3.å°†hexoéƒ¨ç½²åˆ°github</h2><h3 id="3-1-æ–°å»ºä¸€ä¸ªgithubä»“åº“"><a href="#3-1-æ–°å»ºä¸€ä¸ªgithubä»“åº“" class="headerlink" title="3.1 æ–°å»ºä¸€ä¸ªgithubä»“åº“"></a>3.1 æ–°å»ºä¸€ä¸ªgithubä»“åº“</h3><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåˆ›å»ºçš„ä»“åº“åå¿…é¡»ä¸ä½ çš„usernameæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚æˆ‘çš„usrnameæ˜¯anmuxixixiï¼Œåˆ™åˆ›å»ºçš„ä»“åº“åä¸ºanmuxixixi.github.ioï¼›è¯¦æƒ…è§GitHubå¦‚ä½•åˆ›å»ºä¸€ä¸ªPage</p></blockquote><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/åˆ›å»ºgithub.jpg" alt="image-20230114121402814" style="zoom: 60%;"><h3 id="3-2-å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶"><a href="#3-2-å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶" class="headerlink" title="3.2 å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶"></a>3.2 å®‰å“hexoé’ˆå¯¹gitçš„deployç»„ä»¶</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cnpm install --save hexo-deployer-git<br></code></pre></td></tr></table></figure><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/å®‰è£…æ’ä»¶.png" alt="image-20230114121402814" style="zoom: 80%;"><h3 id="3-2-éƒ¨ç½²åˆ°github"><a href="#3-2-éƒ¨ç½²åˆ°github" class="headerlink" title="3.2 éƒ¨ç½²åˆ°github"></a>3.2 éƒ¨ç½²åˆ°github</h3><p>æ‰“å¼€é¡¹ç›®çš„<code>_config.xml</code>ï¼Œè®¾ç½®<code>deploy</code>å±æ€§</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/è®¾ç½®deploy.png" alt="image-20230114121402814" style="zoom: 80%;"><blockquote><p> è¿™ä¸ªrepoå¯¹åº”çš„ä»“åº“åå°±æ˜¯æˆ‘ä»¬çš„<strong>githubä»“åº“åœ°å€</strong></p></blockquote><p>å°†å…¶éƒ¨ç½²åˆ°githubä¸Š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo cl</span><br><span class="hljs-attribute">hexo g</span><br><span class="hljs-attribute">hexo d</span><br></code></pre></td></tr></table></figure><p>æµè§ˆå™¨è¾“å…¥<code>https://anmuxixixi.github.io/</code></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ‰“å¼€ä»“åº“.png" alt="image-20230114121402814" style="zoom: 50%;"><h2 id="4-è®¾ç½®ä¸»é¢˜"><a href="#4-è®¾ç½®ä¸»é¢˜" class="headerlink" title="4.è®¾ç½®ä¸»é¢˜"></a>4.è®¾ç½®ä¸»é¢˜</h2><h3 id="4-1-å®‰è£…ä¸»é¢˜"><a href="#4-1-å®‰è£…ä¸»é¢˜" class="headerlink" title="4.1 å®‰è£…ä¸»é¢˜"></a>4.1 å®‰è£…ä¸»é¢˜</h3><ul><li>Hexoå®˜æ–¹è®¾ç½®ä¸»é¢˜çš„ç½‘ç«™ï¼š<a href="https://hexo.io/themes/">https://hexo.io/themes/</a></li><li>Fluidä¸»é¢˜ï¼š<a href="https://github.com/fluid-dev/hexo-theme-fluid">https://github.com/fluid-dev/hexo-theme-fluid</a></li><li>Fluidä¸»é¢˜æ–‡æ¡£ï¼š<a href="https://hexo.fluid-dev.com/docs/guide/">https://hexo.fluid-dev.com/docs/guide/</a></li></ul><p>æ‰“å¼€githubï¼Œä¸‹è½½å¥½Fluidä¸»é¢˜ï¼Œå°†å…¶è§£å‹æ”¾åœ¨themesæ–‡ä»¶å¤¹ä¸‹</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/ä¸‹è½½ä¸»é¢˜.png" alt="image-20230114121402814" style="zoom: 80%;"><p>æ‰“å¼€<code>_config.xml</code>ï¼Œè®¾ç½®<code>theme</code>ä¸º<code>fluid</code>ï¼Œè®¾ç½®<code>language</code>ä¸º<code>zh-CN</code></p><p>å¯åŠ¨åçœ‹ä¸‹æ•´ä½“çš„æ•ˆæœ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hexo cl &amp;&amp; hexo g &amp;&amp; hexo s<br></code></pre></td></tr></table></figure><h3 id="4-2-ç®€å•çš„é¡µé¢è®¾ç½®"><a href="#4-2-ç®€å•çš„é¡µé¢è®¾ç½®" class="headerlink" title="4.2 ç®€å•çš„é¡µé¢è®¾ç½®"></a>4.2 ç®€å•çš„é¡µé¢è®¾ç½®</h3><ol><li>ä¿®æ”¹ç½‘é¡µå¯¼èˆªæ æ ‡é¢˜</li></ol><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/ä¿®æ”¹ç½‘é¡µæ ‡é¢˜.png" alt="image-20230114203236266" style="zoom:67%;"><p>å…¶å¯¹åº”çš„æ•ˆæœå¦‚ä¸‹</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ ‡é¢˜æ .png"><ol start="2"><li>ä¿®æ”¹èƒŒæ™¯å›¾ç‰‡</li></ol><p>è‡ªå·±å¤åˆ¶ä¸€å¼ å›¾ç‰‡ï¼Œå°†åå­—ä¿®æ”¹ä¸º<code>default.png</code></p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/èƒŒæ™¯.png"><ol start="3"><li>ä¿®æ”¹ä¸­é—´æ‰“å­—æœºæ–‡å­—</li></ol><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/æ‰“å­—æœº.png" alt="image-20230114203653973" style="zoom:79%;"><ol start="4"><li>æ•´ä½“æ•ˆæœå¦‚ä¸‹</li></ol><p><a href="https://anmuxixixi.github.io/">https://anmuxixixi.github.io/</a></p><p>æ¬¢è¿å“å°ğŸŒ­</p><img src="/2023/01/14/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E9%83%A8%E7%BD%B2%E5%88%B0github/zhengti.png">]]></content>
    
    
    <categories>
      
      <category>è½¯ä»¶å®‰è£…</category>
      
    </categories>
    
    
    <tags>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
